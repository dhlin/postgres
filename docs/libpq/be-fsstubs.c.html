<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>libpq/be-fsstubs.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>libpq/be-fsstubs.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L71">cookies</a></li>
<li><a href="#L72">cookies_size</a></li>
<li><a href="#L75">fscxt</a></li>
<li><a href="#L74">lo_cleanup_needed</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L648">AtEOSubXact_LargeObject</a></li>
<li><a href="#L602">AtEOXact_LargeObject</a></li>
<li><a href="#L126">be_lo_close</a></li>
<li><a href="#L249">be_lo_creat</a></li>
<li><a href="#L262">be_lo_create</a></li>
<li><a href="#L481">be_lo_export</a></li>
<li><a href="#L827">be_lo_from_bytea</a></li>
<li><a href="#L792">be_lo_get</a></li>
<li><a href="#L806">be_lo_get_fragment</a></li>
<li><a href="#L398">be_lo_import</a></li>
<li><a href="#L410">be_lo_import_with_oid</a></li>
<li><a href="#L206">be_lo_lseek</a></li>
<li><a href="#L231">be_lo_lseek64</a></li>
<li><a href="#L87">be_lo_open</a></li>
<li><a href="#L850">be_lo_put</a></li>
<li><a href="#L275">be_lo_tell</a></li>
<li><a href="#L298">be_lo_tell64</a></li>
<li><a href="#L574">be_lo_truncate</a></li>
<li><a href="#L586">be_lo_truncate64</a></li>
<li><a href="#L314">be_lo_unlink</a></li>
<li><a href="#L357">be_loread</a></li>
<li><a href="#L375">be_lowrite</a></li>
<li><a href="#L716">closeLOfd</a></li>
<li><a href="#L741">lo_get_fragment_internal</a></li>
<li><a href="#L419">lo_import_internal</a></li>
<li><a href="#L154">lo_read</a></li>
<li><a href="#L553">lo_truncate_internal</a></li>
<li><a href="#L182">lo_write</a></li>
<li><a href="#L675">newLOfd</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L61">BUFSIZE</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * be-fsstubs.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Builtin <a href="../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> for open/close/read/write operations on large objects<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/libpq/be-fsstubs.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTES<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; This should be moved to a more appropriate place.&nbsp; It is here<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; for lack of a better place.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; These <a href="../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> store LargeObjectDesc structs in a private MemoryContext,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; which means that large object descriptors hang around until we destroy<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; the context at transaction end.&nbsp; It'd be possible to prolong the lifetime<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; of the context so that LO FDs are good across transactions (for example,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; we could release the context only if we see that no FDs remain open).<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; But we'd need additional state in order to do the right thing at the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; end of an aborted transaction.&nbsp; FDs opened during an aborted xact would<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; still need to be closed, since they might not be pointing at valid<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; relations at all.&nbsp; Locking semantics are also an interesting problem<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; if LOs stay open across transactions.&nbsp; For <a href="../utils/adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>, we'll stick with the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; existing documented semantics of LO FDs: they're only good within a<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; transaction.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; As of PostgreSQL 8.0, much of the angst expressed above is no longer<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; relevant, and in fact it'd be pretty easy to allow LO FDs to stay<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; open across transactions.&nbsp; (Snapshot relevancy would still be an issue.)<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; However backwards compatibility suggests that we should stick to the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; status quo.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;fcntl.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/stat.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/xact.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_largeobject.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;libpq/be-fsstubs.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;libpq/libpq-fs.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/large_object.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/acl.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/snapmgr.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;varatt.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* define this to enable debug logging */<br/></li>
<li></span><span class="Comment">/* #define FSDB 1 */<br/></li>
<li></span><span class="Comment">/* chunk size for lo_import/lo_export transfers */<br/></li>
<li><a id="L61">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">BUFSIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">8192<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * LO &quot;FD&quot;s are indexes into the <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a> array.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * A non-null entry is a pointer to a LargeObjectDesc allocated in the<br/></li>
<li></span><span class="Comment"> * LO private memory context &quot;<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a>&quot;.&nbsp; The <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a> array itself is also<br/></li>
<li></span><span class="Comment"> * dynamically allocated in that context.&nbsp; Its current allocated size is<br/></li>
<li></span><span class="Comment"> * <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> entries, of which <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> unused entries will be NULL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L71">&#x200c;</a></span><span class="Type">static</span> LargeObjectDesc **<span class="linkable">cookies</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L72">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">cookies_size</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L74">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <span class="linkable">lo_cleanup_needed</span> = <span class="Constant">false</span>;<br/></li>
<li><a id="L75">&#x200c;</a><span class="Type">static</span> MemoryContext <span class="linkable">fscxt</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <a href="#L675" title="libpq/be-fsstubs.c:675">newLOfd</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L716" title="libpq/be-fsstubs.c:716">closeLOfd</a>(<span class="Type">int</span> fd);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L419" title="libpq/be-fsstubs.c:419">lo_import_internal</a>(text *filename, Oid lobjOid);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; File Interfaces for Large Objects<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li>Datum<br/></li>
<li><a id="L87">&#x200c;</a><span class="linkable">be_lo_open</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lobjId = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; mode = PG_GETARG_INT32(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobjDesc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef FSDB<br/></li>
<li></span>&nbsp; &nbsp; elog(DEBUG4, <span class="Constant">&quot;lo_open(</span><span class="Special">%u</span><span class="Constant">,</span><span class="Special">%d</span><span class="Constant">)&quot;</span>, lobjId, mode);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mode &amp; INV_WRITE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_open(INV_WRITE)&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Allocate a large object descriptor first.&nbsp; This will also create<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * '<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a>' if this is the first LO opened in this transaction.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; fd = <a href="#L675" title="libpq/be-fsstubs.c:675">newLOfd</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lobjDesc = <a href="../storage/large_object/inv_api.c.html#L253" title="storage/large_object/inv_api.c:253">inv_open</a>(lobjId, mode, <a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a>);<br/></li>
<li>&nbsp; &nbsp; lobjDesc-&gt;subid = <a href="../access/transam/xact.c.html#L788" title="access/transam/xact.c:788">GetCurrentSubTransactionId</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We must register the snapshot in TopTransaction's resowner so that it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * stays alive until the LO is closed rather than until the current portal<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * shuts down.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (lobjDesc-&gt;snapshot)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lobjDesc-&gt;snapshot = <a href="../utils/time/snapmgr.c.html#L807" title="utils/time/snapmgr.c:807">RegisterSnapshotOnOwner</a>(lobjDesc-&gt;snapshot,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/resowner/resowner.c.html#L167" title="utils/resowner/resowner.c:167">TopTransactionResourceOwner</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] = lobjDesc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(fd);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L126">&#x200c;</a><span class="linkable">be_lo_close</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef FSDB<br/></li>
<li></span>&nbsp; &nbsp; elog(DEBUG4, <span class="Constant">&quot;lo_close(</span><span class="Special">%d</span><span class="Constant">)&quot;</span>, fd);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L716" title="libpq/be-fsstubs.c:716">closeLOfd</a>(fd);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Bare Read/Write operations --- these are not fmgr-callable!<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; We assume the large object supports byte oriented reads and seeks so<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; that our work is easier.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L154">&#x200c;</a></span><span class="linkable">lo_read</span>(<span class="Type">int</span> fd, <span class="Type">char</span> *buf, <span class="Type">int</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status;<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobj;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li>&nbsp; &nbsp; lobj = <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check state.&nbsp; <a href="../storage/large_object/inv_api.c.html#L488" title="storage/large_object/inv_api.c:488">inv_read</a>() would throw an error anyway, but we want the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * error to be about the FD's state not the underlying privilege; it might<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * be that the privilege exists but user forgot to ask for read mode.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((lobj-&gt;flags &amp; IFS_RDLOCK) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;large object descriptor </span><span class="Special">%d</span><span class="Constant"> was not opened for reading&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = <a href="../storage/large_object/inv_api.c.html#L488" title="storage/large_object/inv_api.c:488">inv_read</a>(lobj, buf, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L182">&#x200c;</a></span><span class="linkable">lo_write</span>(<span class="Type">int</span> fd, <span class="Type">const</span> <span class="Type">char</span> *buf, <span class="Type">int</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status;<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobj;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li>&nbsp; &nbsp; lobj = <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* see comment in <a href="#L154" title="libpq/be-fsstubs.c:154">lo_read</a>() */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((lobj-&gt;flags &amp; IFS_WRLOCK) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;large object descriptor </span><span class="Special">%d</span><span class="Constant"> was not opened for writing&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = <a href="../storage/large_object/inv_api.c.html#L581" title="storage/large_object/inv_api.c:581">inv_write</a>(lobj, buf, len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> status;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L206">&#x200c;</a><span class="linkable">be_lo_lseek</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; offset = PG_GETARG_INT32(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; whence = PG_GETARG_INT32(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = <a href="../storage/large_object/inv_api.c.html#L426" title="storage/large_object/inv_api.c:426">inv_seek</a>(<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd], offset, whence);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* guard against result overflow */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (status != (int32) status)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;lo_lseek result out of <a href="../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> for large-object descriptor </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32((int32) status);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L231">&#x200c;</a><span class="linkable">be_lo_lseek64</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; offset = PG_GETARG_INT64(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; whence = PG_GETARG_INT32(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; status = <a href="../storage/large_object/inv_api.c.html#L426" title="storage/large_object/inv_api.c:426">inv_seek</a>(<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd], offset, whence);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(status);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L249">&#x200c;</a><span class="linkable">be_lo_creat</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lobjId;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_creat()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; lobjId = <a href="../storage/large_object/inv_api.c.html#L211" title="storage/large_object/inv_api.c:211">inv_create</a>(InvalidOid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_OID(lobjId);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L262">&#x200c;</a><span class="linkable">be_lo_create</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lobjId = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_create()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; lobjId = <a href="../storage/large_object/inv_api.c.html#L211" title="storage/large_object/inv_api.c:211">inv_create</a>(lobjId);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_OID(lobjId);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L275">&#x200c;</a><span class="linkable">be_lo_tell</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; offset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; offset = <a href="../storage/large_object/inv_api.c.html#L475" title="storage/large_object/inv_api.c:475">inv_tell</a>(<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* guard against result overflow */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (offset != (int32) offset)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;lo_tell result out of <a href="../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> for large-object descriptor </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32((int32) offset);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L298">&#x200c;</a><span class="linkable">be_lo_tell64</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; offset;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; offset = <a href="../storage/large_object/inv_api.c.html#L475" title="storage/large_object/inv_api.c:475">inv_tell</a>(<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(offset);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L314">&#x200c;</a><span class="linkable">be_lo_unlink</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lobjId = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_unlink()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Must be owner of the large object.&nbsp; It would be cleaner to check this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * in <a href="../storage/large_object/inv_api.c.html#L349" title="storage/large_object/inv_api.c:349">inv_drop</a>(), but we want to throw the error <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> not after closing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * relevant FDs.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../storage/large_object/inv_api.c.html#L57" title="storage/large_object/inv_api.c:57">lo_compat_privileges</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="../catalog/aclchk.c.html#L4130" title="catalog/aclchk.c:4130">object_ownercheck</a>(LargeObjectRelationId, lobjId, <a href="../utils/init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>()))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INSUFFICIENT_PRIVILEGE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;must be owner of large object </span><span class="Special">%u</span><span class="Constant">&quot;</span>, lobjId)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If there are <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> open LO FDs referencing that ID, close 'em.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a> != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[i] != <span class="Constant">NULL</span> &amp;&amp; <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[i]-&gt;id == lobjId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L716" title="libpq/be-fsstubs.c:716">closeLOfd</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../storage/large_object/inv_api.c.html#L349" title="storage/large_object/inv_api.c:349">inv_drop</a> does not create a need for end-of-transaction <a href="../regex/regc_nfa.c.html#L2929" title="regex/regc_nfa.c:2929">cleanup</a> and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * hence we don't need to set <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PG_RETURN_INT32(<a href="../storage/large_object/inv_api.c.html#L349" title="storage/large_object/inv_api.c:349">inv_drop</a>(lobjId));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Read/Write using bytea<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li>Datum<br/></li>
<li><a id="L357">&#x200c;</a><span class="linkable">be_loread</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; len = PG_GETARG_INT32(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *retval;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalread;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; retval = (bytea *) <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(VARHDRSZ + len);<br/></li>
<li>&nbsp; &nbsp; totalread = <a href="#L154" title="libpq/be-fsstubs.c:154">lo_read</a>(fd, VARDATA(retval), len);<br/></li>
<li>&nbsp; &nbsp; SET_VARSIZE(retval, totalread + VARHDRSZ);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BYTEA_P(retval);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L375">&#x200c;</a><span class="linkable">be_lowrite</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *wbuf = PG_GETARG_BYTEA_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bytestowrite;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalwritten;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lowrite()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; bytestowrite = VARSIZE_ANY_EXHDR(wbuf);<br/></li>
<li>&nbsp; &nbsp; totalwritten = <a href="#L182" title="libpq/be-fsstubs.c:182">lo_write</a>(fd, VARDATA_ANY(wbuf), bytestowrite);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(totalwritten);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp;&nbsp; Import/Export of Large Object<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lo_import -<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; imports a file as an (inversion) large object.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L398">&#x200c;</a><span class="linkable">be_lo_import</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *filename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_OID(<a href="#L419" title="libpq/be-fsstubs.c:419">lo_import_internal</a>(filename, InvalidOid));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lo_import_with_oid -<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; imports a file as an (inversion) large object specifying oid.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L410">&#x200c;</a><span class="linkable">be_lo_import_with_oid</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *filename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_OID(<a href="#L419" title="libpq/be-fsstubs.c:419">lo_import_internal</a>(filename, oid));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Oid<br/></li>
<li><a id="L419">&#x200c;</a><span class="linkable">lo_import_internal</span>(text *filename, Oid lobjOid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbytes,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp <a href="../storage/lmgr/lock.c.html#L185" title="storage/lmgr/lock.c:185">PG_USED_FOR_ASSERTS_ONLY</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; buf[<a href="#L61" title="libpq/be-fsstubs.c:61">BUFSIZE</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; fnamebuf[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobj;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_import()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * open the file to be read in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/adt/varlena.c.html#L248" title="utils/adt/varlena.c:248">text_to_cstring_buffer</a>(filename, fnamebuf, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(fnamebuf));<br/></li>
<li>&nbsp; &nbsp; fd = <a href="../storage/file/fd.c.html#L2633" title="storage/file/fd.c:2633">OpenTransientFile</a>(fnamebuf, O_RDONLY | PG_BINARY);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not open server file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fnamebuf)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * create an inversion object<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; oid = <a href="../storage/large_object/inv_api.c.html#L211" title="storage/large_object/inv_api.c:211">inv_create</a>(lobjOid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * read in from the filesystem and write to the inversion object<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; lobj = <a href="../storage/large_object/inv_api.c.html#L253" title="storage/large_object/inv_api.c:253">inv_open</a>(oid, INV_WRITE, <a href="../utils/mmgr/mcxt.c.html#L143" title="utils/mmgr/mcxt.c:143">CurrentMemoryContext</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((nbytes = read(fd, buf, <a href="#L61" title="libpq/be-fsstubs.c:61">BUFSIZE</a>)) &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp = <a href="../storage/large_object/inv_api.c.html#L581" title="storage/large_object/inv_api.c:581">inv_write</a>(lobj, buf, nbytes);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(tmp == nbytes);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nbytes &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not read server file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fnamebuf)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L337" title="storage/large_object/inv_api.c:337">inv_close</a>(lobj);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../storage/file/fd.c.html#L2809" title="storage/file/fd.c:2809">CloseTransientFile</a>(fd) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not close file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fnamebuf)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> oid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lo_export -<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; exports an (inversion) large object.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L481">&#x200c;</a><span class="linkable">be_lo_export</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lobjId = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *filename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbytes,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; buf[<a href="#L61" title="libpq/be-fsstubs.c:61">BUFSIZE</a>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; fnamebuf[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobj;<br/></li>
<li>&nbsp; &nbsp; mode_t&nbsp; &nbsp; &nbsp; &nbsp; oumask;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * open the inversion object (no need to test for failure)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; lobj = <a href="../storage/large_object/inv_api.c.html#L253" title="storage/large_object/inv_api.c:253">inv_open</a>(lobjId, INV_READ, <a href="../utils/mmgr/mcxt.c.html#L143" title="utils/mmgr/mcxt.c:143">CurrentMemoryContext</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * open the file to be written to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note: we reduce backend's normal 077 umask to the slightly friendlier<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 022. This code used to drop it all the way to 0, but creating<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * world-writable export files doesn't seem wise.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/adt/varlena.c.html#L248" title="utils/adt/varlena.c:248">text_to_cstring_buffer</a>(filename, fnamebuf, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(fnamebuf));<br/></li>
<li>&nbsp; &nbsp; oumask = umask(S_IWGRP | S_IWOTH);<br/></li>
<li>&nbsp; &nbsp; PG_TRY();<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fd = <a href="../storage/file/fd.c.html#L2642" title="storage/file/fd.c:2642">OpenTransientFilePerm</a>(fnamebuf, O_CREAT | O_WRONLY | O_TRUNC | PG_BINARY,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; PG_FINALLY();<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; umask(oumask);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; PG_END_TRY();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not create server file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fnamebuf)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * read in from the inversion file and write to the filesystem<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> ((nbytes = <a href="../storage/large_object/inv_api.c.html#L488" title="storage/large_object/inv_api.c:488">inv_read</a>(lobj, buf, <a href="#L61" title="libpq/be-fsstubs.c:61">BUFSIZE</a>)) &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp = write(fd, buf, nbytes);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tmp != nbytes)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not write server file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fnamebuf)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../storage/file/fd.c.html#L2809" title="storage/file/fd.c:2809">CloseTransientFile</a>(fd) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not close file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fnamebuf)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L337" title="storage/large_object/inv_api.c:337">inv_close</a>(lobj);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(<span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lo_truncate -<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; truncate a large object to a specified length<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L553">&#x200c;</a></span><span class="linkable">lo_truncate_internal</span>(int32 fd, int64 len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobj;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fd &lt; <span class="Constant">0</span> || fd &gt;= <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> || <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid large-object descriptor: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, fd)));<br/></li>
<li>&nbsp; &nbsp; lobj = <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* see comment in <a href="#L154" title="libpq/be-fsstubs.c:154">lo_read</a>() */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((lobj-&gt;flags &amp; IFS_WRLOCK) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;large object descriptor </span><span class="Special">%d</span><span class="Constant"> was not opened for writing&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L778" title="storage/large_object/inv_api.c:778">inv_truncate</a>(lobj, len);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L574">&#x200c;</a><span class="linkable">be_lo_truncate</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; len = PG_GETARG_INT32(<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_truncate()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L553" title="libpq/be-fsstubs.c:553">lo_truncate_internal</a>(fd, len);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L586">&#x200c;</a><span class="linkable">be_lo_truncate64</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; fd = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; len = PG_GETARG_INT64(<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_truncate64()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L553" title="libpq/be-fsstubs.c:553">lo_truncate_internal</a>(fd, len);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L602" title="libpq/be-fsstubs.c:602">AtEOXact_LargeObject</a> -<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; prepares large objects for transaction commit<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L602">&#x200c;</a></span><span class="linkable">AtEOXact_LargeObject</span>(<span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isCommit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no LO operations in this xact */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Close LO fds and clear <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a> array so that LO fds are no longer good.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The memory context and resource owner holding them are going away at<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the end-of-transaction anyway, but on commit, we need to close them to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * avoid warnings about leaked resources at commit.&nbsp; On abort we can <a href="../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * this step.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (isCommit)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[i] != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L716" title="libpq/be-fsstubs.c:716">closeLOfd</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Needn't actually <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a> since we're about to zap context */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release the LO memory context to prevent permanent memory leaks. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L454" title="utils/mmgr/mcxt.c:454">MemoryContextDelete</a>(<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Give inv_api.c a chance to clean up, too */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L98" title="storage/large_object/inv_api.c:98">close_lo_relation</a>(isCommit);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L648" title="libpq/be-fsstubs.c:648">AtEOSubXact_LargeObject</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Take care of large objects at subtransaction commit/abort<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Reassign LOs created/opened during a committing subtransaction<br/></li>
<li></span><span class="Comment"> * to the parent subtransaction.&nbsp; On abort, just close them.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L648">&#x200c;</a></span><span class="linkable">AtEOSubXact_LargeObject</span>(<span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isCommit, SubTransactionId mySubid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SubTransactionId parentSubid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a> == <span class="Constant">NULL</span>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no LO operations in this xact */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a>; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; LargeObjectDesc *lo = <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (lo != <span class="Constant">NULL</span> &amp;&amp; lo-&gt;subid == mySubid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isCommit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lo-&gt;subid = parentSubid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L716" title="libpq/be-fsstubs.c:716">closeLOfd</a>(i);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Support routines for this file<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L675">&#x200c;</a></span><span class="linkable">newLOfd</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a> = AllocSetContextCreate(<a href="../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Filesystem&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ALLOCSET_DEFAULT_SIZES);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Try to <a href="../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> a free slot */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a>; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[i] == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* No free slot, so make the array bigger */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* First time through, arbitrarily make 64-<a href="../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> array */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; newsize = <span class="Constant">64</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a> = (LargeObjectDesc **)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1214" title="utils/mmgr/mcxt.c:1214">MemoryContextAllocZero</a>(<a href="#L75" title="libpq/be-fsstubs.c:75">fscxt</a>, newsize * <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(LargeObjectDesc *));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Double size of array */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; i = <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; newsize = <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> * <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; repalloc0_array(<a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>, LargeObjectDesc *, <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a>, newsize);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="#L72" title="libpq/be-fsstubs.c:72">cookies_size</a> = newsize;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> i;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L716">&#x200c;</a></span><span class="linkable">closeLOfd</span>(<span class="Type">int</span> fd)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *lobj;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Make sure we do not try to free twice if this errors out for some<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * reason.&nbsp; Better a leak than a crash.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; lobj = <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd];<br/></li>
<li>&nbsp; &nbsp; <a href="#L71" title="libpq/be-fsstubs.c:71">cookies</a>[fd] = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (lobj-&gt;snapshot)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/time/snapmgr.c.html#L849" title="utils/time/snapmgr.c:849">UnregisterSnapshotFromOwner</a>(lobj-&gt;snapshot,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/resowner/resowner.c.html#L167" title="utils/resowner/resowner.c:167">TopTransactionResourceOwner</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L337" title="storage/large_object/inv_api.c:337">inv_close</a>(lobj);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Wrappers oriented toward SQL callers<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Read [offset, offset+nbytes) within LO; when nbytes is -1, read to end.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> bytea *<br/></li>
<li><a id="L741">&#x200c;</a><span class="linkable">lo_get_fragment_internal</span>(Oid loOid, int64 offset, int32 nbytes)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *loDesc;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; loSize;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; result_length;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; total_read <a href="../storage/lmgr/lock.c.html#L185" title="storage/lmgr/lock.c:185">PG_USED_FOR_ASSERTS_ONLY</a>;<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *result = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; loDesc = <a href="../storage/large_object/inv_api.c.html#L253" title="storage/large_object/inv_api.c:253">inv_open</a>(loOid, INV_READ, <a href="../utils/mmgr/mcxt.c.html#L143" title="utils/mmgr/mcxt.c:143">CurrentMemoryContext</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Compute number of bytes we'll actually read, accommodating nbytes == -1<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and reads beyond the end of the LO.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; loSize = <a href="../storage/large_object/inv_api.c.html#L426" title="storage/large_object/inv_api.c:426">inv_seek</a>(loDesc, <span class="Constant">0</span>, <span class="Constant">SEEK_END</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (loSize &gt; offset)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nbytes &gt;= <span class="Constant">0</span> &amp;&amp; nbytes &lt;= loSize - offset)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result_length = nbytes; <span class="Comment">/* request is wholly inside LO */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result_length = loSize - offset;&nbsp; &nbsp; <span class="Comment">/* adjust to end of LO */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; result_length = <span class="Constant">0</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* request is wholly outside LO */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * A result_length calculated from loSize may not fit in a size_t.&nbsp; Check<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * that the size will satisfy this and subsequently-enforced size limits.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (result_length &gt; MaxAllocSize - VARHDRSZ)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_PROGRAM_LIMIT_EXCEEDED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;large object read request is too large&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = (bytea *) <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(VARHDRSZ + result_length);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L426" title="storage/large_object/inv_api.c:426">inv_seek</a>(loDesc, offset, <span class="Constant">SEEK_SET</span>);<br/></li>
<li>&nbsp; &nbsp; total_read = <a href="../storage/large_object/inv_api.c.html#L488" title="storage/large_object/inv_api.c:488">inv_read</a>(loDesc, VARDATA(result), result_length);<br/></li>
<li>&nbsp; &nbsp; Assert(total_read == result_length);<br/></li>
<li>&nbsp; &nbsp; SET_VARSIZE(result, result_length + VARHDRSZ);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L337" title="storage/large_object/inv_api.c:337">inv_close</a>(loDesc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Read entire LO<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L792">&#x200c;</a><span class="linkable">be_lo_get</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="#L741" title="libpq/be-fsstubs.c:741">lo_get_fragment_internal</a>(loOid, <span class="Constant">0</span>, -<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BYTEA_P(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Read <a href="../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> within LO<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L806">&#x200c;</a><span class="linkable">be_lo_get_fragment</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; offset = PG_GETARG_INT64(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; nbytes = PG_GETARG_INT32(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nbytes &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;requested length cannot be negative&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="#L741" title="libpq/be-fsstubs.c:741">lo_get_fragment_internal</a>(loOid, offset, nbytes);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BYTEA_P(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Create LO with initial contents given by a bytea argument<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L827">&#x200c;</a><span class="linkable">be_lo_from_bytea</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *str = PG_GETARG_BYTEA_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *loDesc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; written <a href="../storage/lmgr/lock.c.html#L185" title="storage/lmgr/lock.c:185">PG_USED_FOR_ASSERTS_ONLY</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_from_bytea()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; loOid = <a href="../storage/large_object/inv_api.c.html#L211" title="storage/large_object/inv_api.c:211">inv_create</a>(loOid);<br/></li>
<li>&nbsp; &nbsp; loDesc = <a href="../storage/large_object/inv_api.c.html#L253" title="storage/large_object/inv_api.c:253">inv_open</a>(loOid, INV_WRITE, <a href="../utils/mmgr/mcxt.c.html#L143" title="utils/mmgr/mcxt.c:143">CurrentMemoryContext</a>);<br/></li>
<li>&nbsp; &nbsp; written = <a href="../storage/large_object/inv_api.c.html#L581" title="storage/large_object/inv_api.c:581">inv_write</a>(loDesc, VARDATA_ANY(str), VARSIZE_ANY_EXHDR(str));<br/></li>
<li>&nbsp; &nbsp; Assert(written == VARSIZE_ANY_EXHDR(str));<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L337" title="storage/large_object/inv_api.c:337">inv_close</a>(loDesc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_OID(loOid);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Update <a href="../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> within LO<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L850">&#x200c;</a><span class="linkable">be_lo_put</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; offset = PG_GETARG_INT64(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; bytea&nbsp; &nbsp; &nbsp;&nbsp; *str = PG_GETARG_BYTEA_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; LargeObjectDesc *loDesc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; written <a href="../storage/lmgr/lock.c.html#L185" title="storage/lmgr/lock.c:185">PG_USED_FOR_ASSERTS_ONLY</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/utility.c.html#L404" title="tcop/utility.c:404">PreventCommandIfReadOnly</a>(<span class="Constant">&quot;lo_put()&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="libpq/be-fsstubs.c:74">lo_cleanup_needed</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; loDesc = <a href="../storage/large_object/inv_api.c.html#L253" title="storage/large_object/inv_api.c:253">inv_open</a>(loOid, INV_WRITE, <a href="../utils/mmgr/mcxt.c.html#L143" title="utils/mmgr/mcxt.c:143">CurrentMemoryContext</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L426" title="storage/large_object/inv_api.c:426">inv_seek</a>(loDesc, offset, <span class="Constant">SEEK_SET</span>);<br/></li>
<li>&nbsp; &nbsp; written = <a href="../storage/large_object/inv_api.c.html#L581" title="storage/large_object/inv_api.c:581">inv_write</a>(loDesc, VARDATA_ANY(str), VARSIZE_ANY_EXHDR(str));<br/></li>
<li>&nbsp; &nbsp; Assert(written == VARSIZE_ANY_EXHDR(str));<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/large_object/inv_api.c.html#L337" title="storage/large_object/inv_api.c:337">inv_close</a>(loDesc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
