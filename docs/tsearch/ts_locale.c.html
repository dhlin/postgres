<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>tsearch/ts_locale.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>tsearch/ts_locale.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L253">lowerstr</a></li>
<li><a href="#L266">lowerstr_with_len</a></li>
<li><a href="#L80">t_isalnum</a></li>
<li><a href="#L65">t_isalpha</a></li>
<li><a href="#L35">t_isdigit</a></li>
<li><a href="#L95">t_isprint</a></li>
<li><a href="#L50">t_isspace</a></li>
<li><a href="#L157">tsearch_readline</a></li>
<li><a href="#L134">tsearch_readline_begin</a></li>
<li><a href="#L225">tsearch_readline_callback</a></li>
<li><a href="#L202">tsearch_readline_end</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L32">WC_BUF_LEN</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * ts_locale.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; locale compatibility layer for tsearch<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/tsearch/ts_locale.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;common/string.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;tsearch/ts_locale.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L225" title="tsearch/ts_locale.c:225">tsearch_readline_callback</a>(<span class="Type">void</span> *arg);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The reason these <a href="../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> use a 3-wchar_t output buffer, not 2 as you<br/></li>
<li></span><span class="Comment"> * might expect, is that on Windows &quot;wchar_t&quot; is 16 bits and what we'll be<br/></li>
<li></span><span class="Comment"> * getting from <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>() is UTF16 not UTF32.&nbsp; A single input character<br/></li>
<li></span><span class="Comment"> * may therefore produce a surrogate pair rather than just one wchar_t;<br/></li>
<li></span><span class="Comment"> * we also need room for a trailing null.&nbsp; When we do get a surrogate pair,<br/></li>
<li></span><span class="Comment"> * we pass just the first code to iswdigit() etc, so that these <a href="../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> will<br/></li>
<li></span><span class="Comment"> * always return false for characters outside the Basic Multilingual Plane.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">WC_BUF_LEN</span>&nbsp; </span><span class="Constant">3<br/></li>
<li></span><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="linkable">t_isdigit</span>(<span class="Type">const</span> <span class="Type">char</span> *ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clen = <a href="../utils/mb/mbutils.c.html#L1023" title="utils/mb/mbutils.c:1023">pg_mblen</a>(ptr);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">wchar_t</span>&nbsp; &nbsp; &nbsp; &nbsp; character[<a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; pg_locale_t mylocale = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clen == <span class="Constant">1</span> || <a href="../utils/adt/pg_locale.c.html#L117" title="utils/adt/pg_locale.c:117">database_ctype_is_c</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> isdigit(TOUCHAR(ptr));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>(character, <a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>, ptr, clen, mylocale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> iswdigit((<span class="Type">wint_t</span>) character[<span class="Constant">0</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L50">&#x200c;</a></span><span class="linkable">t_isspace</span>(<span class="Type">const</span> <span class="Type">char</span> *ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clen = <a href="../utils/mb/mbutils.c.html#L1023" title="utils/mb/mbutils.c:1023">pg_mblen</a>(ptr);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">wchar_t</span>&nbsp; &nbsp; &nbsp; &nbsp; character[<a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; pg_locale_t mylocale = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clen == <span class="Constant">1</span> || <a href="../utils/adt/pg_locale.c.html#L117" title="utils/adt/pg_locale.c:117">database_ctype_is_c</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> isspace(TOUCHAR(ptr));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>(character, <a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>, ptr, clen, mylocale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> iswspace((<span class="Type">wint_t</span>) character[<span class="Constant">0</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L65">&#x200c;</a></span><span class="linkable">t_isalpha</span>(<span class="Type">const</span> <span class="Type">char</span> *ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clen = <a href="../utils/mb/mbutils.c.html#L1023" title="utils/mb/mbutils.c:1023">pg_mblen</a>(ptr);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">wchar_t</span>&nbsp; &nbsp; &nbsp; &nbsp; character[<a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; pg_locale_t mylocale = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clen == <span class="Constant">1</span> || <a href="../utils/adt/pg_locale.c.html#L117" title="utils/adt/pg_locale.c:117">database_ctype_is_c</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> isalpha(TOUCHAR(ptr));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>(character, <a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>, ptr, clen, mylocale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> iswalpha((<span class="Type">wint_t</span>) character[<span class="Constant">0</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L80">&#x200c;</a></span><span class="linkable">t_isalnum</span>(<span class="Type">const</span> <span class="Type">char</span> *ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clen = <a href="../utils/mb/mbutils.c.html#L1023" title="utils/mb/mbutils.c:1023">pg_mblen</a>(ptr);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">wchar_t</span>&nbsp; &nbsp; &nbsp; &nbsp; character[<a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; pg_locale_t mylocale = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clen == <span class="Constant">1</span> || <a href="../utils/adt/pg_locale.c.html#L117" title="utils/adt/pg_locale.c:117">database_ctype_is_c</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> isalnum(TOUCHAR(ptr));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>(character, <a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>, ptr, clen, mylocale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> iswalnum((<span class="Type">wint_t</span>) character[<span class="Constant">0</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">int<br/></li>
<li><a id="L95">&#x200c;</a></span><span class="linkable">t_isprint</span>(<span class="Type">const</span> <span class="Type">char</span> *ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clen = <a href="../utils/mb/mbutils.c.html#L1023" title="utils/mb/mbutils.c:1023">pg_mblen</a>(ptr);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">wchar_t</span>&nbsp; &nbsp; &nbsp; &nbsp; character[<a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>];<br/></li>
<li>&nbsp; &nbsp; pg_locale_t mylocale = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (clen == <span class="Constant">1</span> || <a href="../utils/adt/pg_locale.c.html#L117" title="utils/adt/pg_locale.c:117">database_ctype_is_c</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> isprint(TOUCHAR(ptr));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>(character, <a href="#L32" title="tsearch/ts_locale.c:32">WC_BUF_LEN</a>, ptr, clen, mylocale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> iswprint((<span class="Type">wint_t</span>) character[<span class="Constant">0</span>]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Set up to read a file using <a href="#L157" title="tsearch/ts_locale.c:157">tsearch_readline</a>().&nbsp; This facility is<br/></li>
<li></span><span class="Comment"> * better than just reading the file directly because it provides error<br/></li>
<li></span><span class="Comment"> * context pointing to the specific line where a problem is detected.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Expected usage is:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; tsearch_readline_state trst;<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; if (!<a href="#L134" title="tsearch/ts_locale.c:134">tsearch_readline_begin</a>(&amp;trst, filename))<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_CONFIG_FILE_ERROR),<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(&quot;could not open stop-<a href="../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a> file \&quot;%s\&quot;: %m&quot;,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; filename)));<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; while ((line = <a href="#L157" title="tsearch/ts_locale.c:157">tsearch_readline</a>(&amp;trst)) != NULL)<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; process line;<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L202" title="tsearch/ts_locale.c:202">tsearch_readline_end</a>(&amp;trst);<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that the caller supplies the ereport() for file open failure;<br/></li>
<li></span><span class="Comment"> * this is so that a custom message can be provided.&nbsp; The filename string<br/></li>
<li></span><span class="Comment"> * passed to <a href="#L134" title="tsearch/ts_locale.c:134">tsearch_readline_begin</a>() must remain valid through<br/></li>
<li></span><span class="Comment"> * <a href="#L202" title="tsearch/ts_locale.c:202">tsearch_readline_end</a>().<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L134">&#x200c;</a></span><span class="linkable">tsearch_readline_begin</span>(tsearch_readline_state *stp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *filename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((stp-&gt;fp = <a href="../storage/file/fd.c.html#L2583" title="storage/file/fd.c:2583">AllocateFile</a>(filename, <span class="Constant">&quot;r&quot;</span>)) == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; stp-&gt;filename = filename;<br/></li>
<li>&nbsp; &nbsp; stp-&gt;lineno = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; initStringInfo(&amp;stp-&gt;buf);<br/></li>
<li>&nbsp; &nbsp; stp-&gt;curline = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Setup error traceback support for ereport() */<br/></li>
<li></span>&nbsp; &nbsp; stp-&gt;cb.callback = <a href="#L225" title="tsearch/ts_locale.c:225">tsearch_readline_callback</a>;<br/></li>
<li>&nbsp; &nbsp; stp-&gt;cb.arg = (<span class="Type">void</span> *) stp;<br/></li>
<li>&nbsp; &nbsp; stp-&gt;cb.previous = <a href="../utils/error/elog.c.html#L94" title="utils/error/elog.c:94">error_context_stack</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/error/elog.c.html#L94" title="utils/error/elog.c:94">error_context_stack</a> = &amp;stp-&gt;cb;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Read the <a href="../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> line from a tsearch data file (expected to be in UTF-8), and<br/></li>
<li></span><span class="Comment"> * convert it to database encoding if needed. The returned string is <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d.<br/></li>
<li></span><span class="Comment"> * NULL return means EOF.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L157">&#x200c;</a><span class="linkable">tsearch_readline</span>(tsearch_readline_state *stp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *recoded;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Advance line number to use in error reports */<br/></li>
<li></span>&nbsp; &nbsp; stp-&gt;lineno++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Clear curline, it's no longer relevant */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (stp-&gt;curline)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stp-&gt;curline != stp-&gt;buf.data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(stp-&gt;curline);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stp-&gt;curline = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Collect <a href="../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> line, if there is one */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!pg_get_line_buf(stp-&gt;fp, &amp;stp-&gt;buf))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Validate the input as UTF-8, then convert to DB encoding if needed */<br/></li>
<li></span>&nbsp; &nbsp; recoded = <a href="../utils/mb/mbutils.c.html#L676" title="utils/mb/mbutils.c:676">pg_any_to_server</a>(stp-&gt;buf.data, stp-&gt;buf.len, PG_UTF8);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Save the correctly-encoded string for possible error reports */<br/></li>
<li></span>&nbsp; &nbsp; stp-&gt;curline = recoded;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* might be <a href="../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to buf.data */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We always return a freshly <a href="../utils/mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>'d string.&nbsp; This is clearly necessary<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * if <a href="../utils/mb/mbutils.c.html#L676" title="utils/mb/mbutils.c:676">pg_any_to_server</a>() returned buf.data, and we need a second copy even<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * if encoding conversion did occur.&nbsp; The caller is entitled to <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a> the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * returned string at <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> time, which would leave curline pointing to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * recycled storage, causing problems if an error occurs after that point.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (It's preferable to return the result of <a href="../utils/mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a> instead of the output<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of <a href="../utils/mb/mbutils.c.html#L676" title="utils/mb/mbutils.c:676">pg_any_to_server</a>, because the conversion result tends to be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * over-allocated.&nbsp; Since callers might save the result string directly<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * into a long-lived dictionary structure, we don't want it to be a larger<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a> chunk than necessary.&nbsp; We'll reclaim the conversion result on<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the <a href="../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> call.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../utils/mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(recoded);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Close down after reading a file with <a href="#L157" title="tsearch/ts_locale.c:157">tsearch_readline</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L202">&#x200c;</a></span><span class="linkable">tsearch_readline_end</span>(tsearch_readline_state *stp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Suppress use of curline in <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> error reported below */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (stp-&gt;curline)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stp-&gt;curline != stp-&gt;buf.data)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(stp-&gt;curline);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stp-&gt;curline = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release other resources */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(stp-&gt;buf.data);<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(stp-&gt;fp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Pop the error context stack */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/error/elog.c.html#L94" title="utils/error/elog.c:94">error_context_stack</a> = stp-&gt;cb.previous;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Error context callback for errors occurring while reading a tsearch<br/></li>
<li></span><span class="Comment"> * configuration file.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L225">&#x200c;</a></span><span class="linkable">tsearch_readline_callback</span>(<span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; tsearch_readline_state *stp = (tsearch_readline_state *) arg;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We can't include the text of the config line for errors that occur<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * during <a href="#L157" title="tsearch/ts_locale.c:157">tsearch_readline</a>() itself.&nbsp; The major cause of such errors is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * encoding violations, and we daren't try to <a href="../nodes/print.c.html#L36" title="nodes/print.c:36">print</a> error messages<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * containing badly-encoded data.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (stp-&gt;curline)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; errcontext(<span class="Constant">&quot;line </span><span class="Special">%d</span><span class="Constant"> of configuration file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stp-&gt;lineno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stp-&gt;filename,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stp-&gt;curline);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; errcontext(<span class="Constant">&quot;line </span><span class="Special">%d</span><span class="Constant"> of configuration file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stp-&gt;lineno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; stp-&gt;filename);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L253" title="tsearch/ts_locale.c:253">lowerstr</a> --- fold null-terminated string to <a href="../utils/adt/oracle_compat.c.html#L49" title="utils/adt/oracle_compat.c:49">lower</a> case<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Returned string is <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L253">&#x200c;</a><span class="linkable">lowerstr</span>(<span class="Type">const</span> <span class="Type">char</span> *str)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L266" title="tsearch/ts_locale.c:266">lowerstr_with_len</a>(str, strlen(str));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L266" title="tsearch/ts_locale.c:266">lowerstr_with_len</a> --- fold string to <a href="../utils/adt/oracle_compat.c.html#L49" title="utils/adt/oracle_compat.c:49">lower</a> case<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Input string need not be null-terminated.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Returned string is <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L266">&#x200c;</a><span class="linkable">lowerstr_with_len</span>(<span class="Type">const</span> <span class="Type">char</span> *str, <span class="Type">int</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *out;<br/></li>
<li>&nbsp; &nbsp; pg_locale_t mylocale = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../utils/mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(<span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Use wide char code only when max encoding length &gt; 1 and ctype != C.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Some operating systems fail with multi-byte encodings and a C locale.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Also, for a C locale there is no need to process as multibyte. From<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * backend/utils/adt/oracle_compat.c Teodor<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../utils/mb/mbutils.c.html#L1546" title="utils/mb/mbutils.c:1546">pg_database_encoding_max_length</a>() &gt; <span class="Constant">1</span> &amp;&amp; !<a href="../utils/adt/pg_locale.c.html#L117" title="utils/adt/pg_locale.c:117">database_ctype_is_c</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">wchar_t</span>&nbsp; &nbsp; *wstr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * alloc number of wchar_t for worst case, len contains number of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * bytes &gt;= number of characters and alloc 1 wchar_t for 0, because<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../utils/adt/pg_locale.c.html#L3065" title="utils/adt/pg_locale.c:3065">wchar2char</a> wants zero-terminated string<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; wptr = wstr = (<span class="Type">wchar_t</span> *) <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">wchar_t</span>) * (len + <span class="Constant">1</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wlen = <a href="../utils/adt/pg_locale.c.html#L3121" title="utils/adt/pg_locale.c:3121">char2wchar</a>(wstr, len + <span class="Constant">1</span>, str, len, mylocale);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(wlen &lt;= len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (*wptr)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *wptr = towlower((<span class="Type">wint_t</span>) *wptr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Alloc result string for worst case + '\0'<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="../utils/mb/mbutils.c.html#L1546" title="utils/mb/mbutils.c:1546">pg_database_encoding_max_length</a>() * wlen + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = (<span class="Type">char</span> *) <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wlen = <a href="../utils/adt/pg_locale.c.html#L3065" title="utils/adt/pg_locale.c:3065">wchar2char</a>(out, wstr, len, mylocale);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(wstr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (wlen &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_CHARACTER_NOT_IN_REPERTOIRE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;conversion from wchar_t to server encoding failed: %m&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(wlen &lt; len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *ptr = str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *outptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; outptr = out = (<span class="Type">char</span> *) <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">char</span>) * (len + <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ((ptr - str) &lt; len &amp;&amp; *ptr)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *outptr++ = tolower(TOUCHAR(ptr));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *outptr = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> out;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
