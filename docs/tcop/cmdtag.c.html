<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>tcop/cmdtag.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>tcop/cmdtag.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L33">tag_behavior</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L20">CommandTagBehavior</a></li>
<li><a href="#L28">CommandTagBehavior</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L121">BuildQueryCompletionString</a></li>
<li><a href="#L83">GetCommandTagEnum</a></li>
<li><a href="#L47">GetCommandTagName</a></li>
<li><a href="#L53">GetCommandTagNameAndLen</a></li>
<li><a href="#L40">InitializeQueryCompletion</a></li>
<li><a href="#L60">command_tag_display_rowcount</a></li>
<li><a href="#L66">command_tag_event_trigger_ok</a></li>
<li><a href="#L72">command_tag_table_rewrite_ok</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L30">PG_CMDTAG</a></li>
<li><a href="#L37">PG_CMDTAG</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * cmdtag.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Data and routines for commandtag names and enumeration.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/tcop/cmdtag.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;tcop/cmdtag.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L20">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">CommandTagBehavior</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* tag name, e.g. &quot;SELECT&quot; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> uint8 namelen;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* set to strlen(name) */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; event_trigger_ok;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; table_rewrite_ok;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; display_rowcount;&nbsp; &nbsp; <span class="Comment">/* should the number of rows affected be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * shown in the command completion string */<br/></li>
<li><a id="L28">&#x200c;</a></span>} <span class="linkable">CommandTagBehavior</span>;<br/></li>
<li><br/></li>
<li><a id="L30">&#x200c;</a><span class="PreProc">#define <span class="linkable">PG_CMDTAG</span>(tag, name, evtrgok, rwrok, rowcnt) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; { name, (uint8) (</span><span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span><span class="PreProc">(name) - </span><span class="Constant">1</span><span class="PreProc">), evtrgok, rwrok, rowcnt },<br/></li>
<li></span><br/></li>
<li><a id="L33">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <a href="#L20" title="tcop/cmdtag.c:20">CommandTagBehavior</a> <span class="linkable">tag_behavior</span>[COMMAND_TAG_NEXTTAG] = {<br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;tcop/cmdtaglist.h&quot;<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><a id="L37">&#x200c;</a><span class="PreProc">#undef <span class="linkable">PG_CMDTAG</span><br/></li>
<li></span><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L40">&#x200c;</a></span><span class="linkable">InitializeQueryCompletion</span>(QueryCompletion *qc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; qc-&gt;commandTag = CMDTAG_UNKNOWN;<br/></li>
<li>&nbsp; &nbsp; qc-&gt;nprocessed = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L47">&#x200c;</a><span class="linkable">GetCommandTagName</span>(CommandTag commandTag)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>[commandTag].name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L53">&#x200c;</a><span class="linkable">GetCommandTagNameAndLen</span>(CommandTag commandTag, Size *len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; *len = (Size) <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>[commandTag].namelen;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>[commandTag].name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L60">&#x200c;</a></span><span class="linkable">command_tag_display_rowcount</span>(CommandTag commandTag)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>[commandTag].display_rowcount;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L66">&#x200c;</a></span><span class="linkable">command_tag_event_trigger_ok</span>(CommandTag commandTag)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>[commandTag].event_trigger_ok;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L72">&#x200c;</a></span><span class="linkable">command_tag_table_rewrite_ok</span>(CommandTag commandTag)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>[commandTag].table_rewrite_ok;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Search CommandTag by name<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Returns CommandTag, or CMDTAG_UNKNOWN if not recognized<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>CommandTag<br/></li>
<li><a id="L83">&#x200c;</a><span class="linkable">GetCommandTagEnum</span>(<span class="Type">const</span> <span class="Type">char</span> *commandname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L20" title="tcop/cmdtag.c:20">CommandTagBehavior</a> *base,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *last,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *position;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (commandname == <span class="Constant">NULL</span> || *commandname == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> CMDTAG_UNKNOWN;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; base = <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>;<br/></li>
<li>&nbsp; &nbsp; last = <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a> + lengthof(<a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (last &gt;= base)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; position = base + ((last - base) &gt;&gt; <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = pg_strcasecmp(commandname, position-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (result == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (CommandTag) (position - <a href="#L33" title="tcop/cmdtag.c:33">tag_behavior</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (result &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; last = position - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; base = position + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> CMDTAG_UNKNOWN;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L121" title="tcop/cmdtag.c:121">BuildQueryCompletionString</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Build a string containing the command tag name with the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; QueryCompletion's nprocessed for command tags with display_rowcount<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; set.&nbsp; Returns the strlen of the constructed string.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The caller must ensure that buff is at least COMPLETION_TAG_BUFSIZE bytes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If nameonly is true, then the constructed string will contain only the tag<br/></li>
<li></span><span class="Comment"> * name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L121">&#x200c;</a><span class="linkable">BuildQueryCompletionString</span>(<span class="Type">char</span> *buff, <span class="Type">const</span> QueryCompletion *qc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> nameonly)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; CommandTag&nbsp; &nbsp; tag = qc-&gt;commandTag;<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; taglen;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *tagname = <a href="#L53" title="tcop/cmdtag.c:53">GetCommandTagNameAndLen</a>(tag, &amp;taglen);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *bufp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We assume the tagname is plain ASCII and therefore requires no encoding<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * conversion.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; memcpy(buff, tagname, taglen);<br/></li>
<li>&nbsp; &nbsp; bufp = buff + taglen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* ensure that the tagname isn't long enough to overrun the buffer */<br/></li>
<li></span>&nbsp; &nbsp; Assert(taglen &lt;= COMPLETION_TAG_BUFSIZE - MAXINT8LEN - <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * In PostgreSQL versions 11 and earlier, it was possible to create a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * table WITH OIDS.&nbsp; When inserting into such a table, INSERT used to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * include the Oid of the inserted record in the completion tag.&nbsp; To<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * maintain compatibility in the wire protocol, we <a href="../utils/adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> write a &quot;0&quot; (for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * InvalidOid) in the location where we once wrote the new record's Oid.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L60" title="tcop/cmdtag.c:60">command_tag_display_rowcount</a>(tag) &amp;&amp; !nameonly)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tag == CMDTAG_INSERT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *bufp++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *bufp++ = <span class="Constant">'0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *bufp++ = <span class="Constant">' '</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bufp += <a href="../utils/adt/numutils.c.html#L1142" title="utils/adt/numutils.c:1142">pg_ulltoa_n</a>(qc-&gt;nprocessed, bufp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* and finally, NUL terminate the string */<br/></li>
<li></span>&nbsp; &nbsp; *bufp = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert((bufp - buff) == strlen(buff));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> bufp - buff;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
