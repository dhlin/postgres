<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>access/transam/commit_ts.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>access/transam/commit_ts.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L83">CommitTsCtlData</a></li>
<li><a href="#L105">commitTsShared</a></li>
<li><a href="#L109">track_commit_timestamp</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L54">CommitTimestampEntry</a></li>
<li><a href="#L58">CommitTimestampEntry</a></li>
<li><a href="#L98">CommitTimestampShared</a></li>
<li><a href="#L103">CommitTimestampShared</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L705">ActivateCommitTs</a></li>
<li><a href="#L936">AdvanceOldestCommitTsXid</a></li>
<li><a href="#L596">BootStrapCommitTs</a></li>
<li><a href="#L820">CheckPointCommitTs</a></li>
<li><a href="#L970">CommitTsPagePrecedes</a></li>
<li><a href="#L664">CommitTsParameterChange</a></li>
<li><a href="#L506">CommitTsShmemBuffers</a></li>
<li><a href="#L530">CommitTsShmemInit</a></li>
<li><a href="#L519">CommitTsShmemSize</a></li>
<li><a href="#L642">CompleteCommitTsInitialization</a></li>
<li><a href="#L778">DeactivateCommitTs</a></li>
<li><a href="#L842">ExtendCommitTs</a></li>
<li><a href="#L360">GetLatestCommitTsData</a></li>
<li><a href="#L909">SetCommitTsLimit</a></li>
<li><a href="#L222">SetXidCommitTsInPage</a></li>
<li><a href="#L632">StartupCommitTs</a></li>
<li><a href="#L274">TransactionIdGetCommitTsData</a></li>
<li><a href="#L249">TransactionIdSetCommitTs</a></li>
<li><a href="#L72">TransactionIdToCTsPage</a></li>
<li><a href="#L141">TransactionTreeSetCommitTsData</a></li>
<li><a href="#L883">TruncateCommitTs</a></li>
<li><a href="#L1000">WriteTruncateXlogRec</a></li>
<li><a href="#L989">WriteZeroPageXlogRec</a></li>
<li><a href="#L615">ZeroCommitTsPage</a></li>
<li><a href="#L584">check_commit_ts_buffers</a></li>
<li><a href="#L1016">commit_ts_redo</a></li>
<li><a href="#L1063">committssyncfiletag</a></li>
<li><a href="#L381">error_commit_ts_disabled</a></li>
<li><a href="#L420">pg_last_committed_xact</a></li>
<li><a href="#L397">pg_xact_commit_timestamp</a></li>
<li><a href="#L464">pg_xact_commit_timestamp_origin</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L63">COMMIT_TS_XACTS_PER_PAGE</a></li>
<li><a href="#L85">CommitTsCtl</a></li>
<li><a href="#L60">SizeOfCommitTimestampEntry</a></li>
<li><a href="#L77">TransactionIdToCTsEntry</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * commit_ts.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; PostgreSQL commit timestamp manager<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This module is a pg_xact-like system that stores the commit timestamp<br/></li>
<li></span><span class="Comment"> * for each transaction.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * XLOG interactions: this module generates an XLOG record whenever a new<br/></li>
<li></span><span class="Comment"> * CommitTs page is initialized to zeroes.&nbsp; Other writes of CommitTS come<br/></li>
<li></span><span class="Comment"> * from recording of transaction commit in xact.c, which generates its own<br/></li>
<li></span><span class="Comment"> * XLOG <a href="twophase.c.html#L1025" title="access/transam/twophase.c:1025">records</a> for these events and will re-perform the status update on<br/></li>
<li></span><span class="Comment"> * redo; so we need make no additional XLOG entry here.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * src/backend/access/transam/commit_ts.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/commit_ts.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/htup_details.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/slru.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/transam.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/xloginsert.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/xlogutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;funcapi.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/shmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/fmgrprotos.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/guc_hooks.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/timestamp.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Defines for CommitTs page sizes.&nbsp; A page is the same BLCKSZ as is used<br/></li>
<li></span><span class="Comment"> * everywhere else in Postgres.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: because TransactionIds are 32 bits and wrap around at 0xFFFFFFFF,<br/></li>
<li></span><span class="Comment"> * CommitTs page numbering also wraps around at<br/></li>
<li></span><span class="Comment"> * 0xFFFFFFFF/<a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>, and CommitTs segment numbering at<br/></li>
<li></span><span class="Comment"> * 0xFFFFFFFF/<a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>/SLRU_PAGES_PER_SEGMENT.&nbsp; We need take no<br/></li>
<li></span><span class="Comment"> * explicit notice of that fact in this module, except when comparing segment<br/></li>
<li></span><span class="Comment"> * and page numbers in <a href="#L883" title="access/transam/commit_ts.c:883">TruncateCommitTs</a> (see <a href="#L970" title="access/transam/commit_ts.c:970">CommitTsPagePrecedes</a>).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * We need 8+2 bytes per xact.&nbsp; Note that enlarging this struct might mean<br/></li>
<li></span><span class="Comment"> * the largest possible file name is more than 5 chars long; see<br/></li>
<li></span><span class="Comment"> * <a href="slru.c.html#L1774" title="access/transam/slru.c:1774">SlruScanDirectory</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L54">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">CommitTimestampEntry</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TimestampTz time;<br/></li>
<li>&nbsp; &nbsp; RepOriginId nodeid;<br/></li>
<li><a id="L58">&#x200c;</a>} <span class="linkable">CommitTimestampEntry</span>;<br/></li>
<li><br/></li>
<li><a id="L60">&#x200c;</a><span class="PreProc">#define <span class="linkable">SizeOfCommitTimestampEntry</span> (offsetof(<a href="#L54" title="access/transam/commit_ts.c:54">CommitTimestampEntry</a>, nodeid) + \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span><span class="PreProc">(RepOriginId))<br/></li>
<li></span><br/></li>
<li><a id="L63">&#x200c;</a><span class="PreProc">#define <span class="linkable">COMMIT_TS_XACTS_PER_PAGE</span> \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; (BLCKSZ / <a href="#L60" title="access/transam/commit_ts.c:60">SizeOfCommitTimestampEntry</a>)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Although we return an int64 the actual value can't currently exceed<br/></li>
<li></span><span class="Comment"> * 0xFFFFFFFF/<a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">inline</span> int64<br/></li>
<li><a id="L72">&#x200c;</a><span class="linkable">TransactionIdToCTsPage</span>(TransactionId xid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> xid / (int64) <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L77">&#x200c;</a><span class="PreProc">#define <span class="linkable">TransactionIdToCTsEntry</span>(xid)&nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ((xid) % (TransactionId) <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Link to shared-memory data structures for CommitTs control<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L83">&#x200c;</a></span><span class="Type">static</span> SlruCtlData <span class="linkable">CommitTsCtlData</span>;<br/></li>
<li><br/></li>
<li><a id="L85">&#x200c;</a><span class="PreProc">#define <span class="linkable">CommitTsCtl</span> (&amp;<a href="#L83" title="access/transam/commit_ts.c:83">CommitTsCtlData</a>)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * We keep a cache of the last value set in shared memory.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is also good place to keep the activation status.&nbsp; We keep this<br/></li>
<li></span><span class="Comment"> * separate from the GUC so that the standby can activate the module if the<br/></li>
<li></span><span class="Comment"> * primary has it active independently of the value of the GUC.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is protected by CommitTsLock.&nbsp; In some places, we use commitTsActive<br/></li>
<li></span><span class="Comment"> * without acquiring the lock; where this happens, a comment explains the<br/></li>
<li></span><span class="Comment"> * rationale for it.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L98">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">CommitTimestampShared</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xidLastCommit;<br/></li>
<li>&nbsp; &nbsp; <a href="#L54" title="access/transam/commit_ts.c:54">CommitTimestampEntry</a> dataLastCommit;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; commitTsActive;<br/></li>
<li><a id="L103">&#x200c;</a>} <span class="linkable">CommitTimestampShared</span>;<br/></li>
<li><br/></li>
<li><a id="L105">&#x200c;</a><span class="Type">static</span> <a href="#L98" title="access/transam/commit_ts.c:98">CommitTimestampShared</a> *<span class="linkable">commitTsShared</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* GUC variable */<br/></li>
<li><a id="L109">&#x200c;</a></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">track_commit_timestamp</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L222" title="access/transam/commit_ts.c:222">SetXidCommitTsInPage</a>(TransactionId xid, <span class="Type">int</span> nsubxids,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TransactionId *subxids, TimestampTz ts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RepOriginId nodeid, int64 pageno);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L249" title="access/transam/commit_ts.c:249">TransactionIdSetCommitTs</a>(TransactionId xid, TimestampTz ts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RepOriginId nodeid, <span class="Type">int</span> slotno);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L381" title="access/transam/commit_ts.c:381">error_commit_ts_disabled</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <a href="#L615" title="access/transam/commit_ts.c:615">ZeroCommitTsPage</a>(int64 pageno, <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> writeXlog);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L970" title="access/transam/commit_ts.c:970">CommitTsPagePrecedes</a>(int64 page1, int64 page2);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L705" title="access/transam/commit_ts.c:705">ActivateCommitTs</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L778" title="access/transam/commit_ts.c:778">DeactivateCommitTs</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L989" title="access/transam/commit_ts.c:989">WriteZeroPageXlogRec</a>(int64 pageno);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1000" title="access/transam/commit_ts.c:1000">WriteTruncateXlogRec</a>(int64 pageno, TransactionId oldestXid);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L141" title="access/transam/commit_ts.c:141">TransactionTreeSetCommitTsData</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Record the final commit timestamp of transaction entries in the commit log<br/></li>
<li></span><span class="Comment"> * for a transaction and its subtransaction tree, as efficiently as possible.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * xid is the top level transaction id.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * subxids is an array of xids of length nsubxids, representing subtransactions<br/></li>
<li></span><span class="Comment"> * in the tree of xid. In various cases nsubxids may be zero.<br/></li>
<li></span><span class="Comment"> * The reason why tracking just the parent xid commit timestamp is not enough<br/></li>
<li></span><span class="Comment"> * is that the subtrans SLRU does not stay valid across crashes (it's not<br/></li>
<li></span><span class="Comment"> * permanent) so we need to keep the information about them here. If the<br/></li>
<li></span><span class="Comment"> * subtrans implementation changes in the future, we might want to revisit the<br/></li>
<li></span><span class="Comment"> * decision of storing timestamp info for each subxid.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L141">&#x200c;</a></span><span class="linkable">TransactionTreeSetCommitTsData</span>(TransactionId xid, <span class="Type">int</span> nsubxids,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TransactionId *subxids, TimestampTz timestamp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RepOriginId nodeid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; TransactionId headxid;<br/></li>
<li>&nbsp; &nbsp; TransactionId newestXact;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * No-op if the module is not active.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * An unlocked read here is fine, because in a standby (the only place<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * where the flag can change in flight) this routine is only called by the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * recovery process, which is also the only process which can change the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * flag.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Figure out the latest Xid in this batch: either the last subxid if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * there's <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>, otherwise the parent xid.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (nsubxids &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; newestXact = subxids[nsubxids - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; newestXact = xid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We split the xids to set the timestamp to in groups belonging to the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * same SLRU page; the first <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> in each such set is its head.&nbsp; The<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * first group has the <a href="../../storage/lmgr/s_lock.c.html#L257" title="storage/lmgr/s_lock.c:257">main</a> XID as the head; subsequent sets use the first<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * subxid not on the previous page as head.&nbsp; This way, we only have to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * lock/modify each SLRU page once.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; headxid = xid;<br/></li>
<li>&nbsp; &nbsp; i = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; pageno = <a href="#L72" title="access/transam/commit_ts.c:72">TransactionIdToCTsPage</a>(headxid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = i; j &lt; nsubxids; j++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L72" title="access/transam/commit_ts.c:72">TransactionIdToCTsPage</a>(subxids[j]) != pageno)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* subxids[i..j] are on the same page as the head */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L222" title="access/transam/commit_ts.c:222">SetXidCommitTsInPage</a>(headxid, j - i, subxids + i, timestamp, nodeid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pageno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* if we wrote out all subxids, we're done. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (j &gt;= nsubxids)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Set the new head and <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> over it, as well as over the subxids we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * just wrote.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; headxid = subxids[j];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; i = j + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* update the cached value in shared memory */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;xidLastCommit = xid;<br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.time = timestamp;<br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.nodeid = nodeid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* and move forwards our endpoint, if needed */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid, newestXact))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid = newestXact;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Record the commit timestamp of transaction entries in the commit log for all<br/></li>
<li></span><span class="Comment"> * entries on a single page.&nbsp; Atomic only on this page.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L222">&#x200c;</a></span><span class="linkable">SetXidCommitTsInPage</span>(TransactionId xid, <span class="Type">int</span> nsubxids,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TransactionId *subxids, TimestampTz ts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RepOriginId nodeid, int64 pageno)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LWLock&nbsp; &nbsp; &nbsp;&nbsp; *lock = SimpleLruGetBankLock(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slotno;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(lock, LW_EXCLUSIVE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; slotno = <a href="slru.c.html#L488" title="access/transam/slru.c:488">SimpleLruReadPage</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno, <span class="Constant">true</span>, xid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L249" title="access/transam/commit_ts.c:249">TransactionIdSetCommitTs</a>(xid, ts, nodeid, slotno);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nsubxids; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L249" title="access/transam/commit_ts.c:249">TransactionIdSetCommitTs</a>(subxids[i], ts, nodeid, slotno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;page_dirty[slotno] = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(lock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Sets the commit timestamp of a single transaction.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Caller must hold the correct SLRU bank lock, will be held at exit<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L249">&#x200c;</a></span><span class="linkable">TransactionIdSetCommitTs</span>(TransactionId xid, TimestampTz ts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RepOriginId nodeid, <span class="Type">int</span> slotno)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entryno = <a href="#L77" title="access/transam/commit_ts.c:77">TransactionIdToCTsEntry</a>(xid);<br/></li>
<li>&nbsp; &nbsp; <a href="#L54" title="access/transam/commit_ts.c:54">CommitTimestampEntry</a> entry;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(TransactionIdIsNormal(xid));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry.time = ts;<br/></li>
<li>&nbsp; &nbsp; entry.nodeid = nodeid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;page_buffer[slotno] +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L60" title="access/transam/commit_ts.c:60">SizeOfCommitTimestampEntry</a> * entryno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;entry, <a href="#L60" title="access/transam/commit_ts.c:60">SizeOfCommitTimestampEntry</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Interrogate the commit timestamp of a transaction.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The return value indicates whether a commit timestamp record was found for<br/></li>
<li></span><span class="Comment"> * the given xid.&nbsp; The timestamp value is returned in *ts (which may not be<br/></li>
<li></span><span class="Comment"> * null), and the origin node for the Xid is returned in *nodeid, if it's not<br/></li>
<li></span><span class="Comment"> * null.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L274">&#x200c;</a></span><span class="linkable">TransactionIdGetCommitTsData</span>(TransactionId xid, TimestampTz *ts,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RepOriginId *nodeid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; pageno = <a href="#L72" title="access/transam/commit_ts.c:72">TransactionIdToCTsPage</a>(xid);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entryno = <a href="#L77" title="access/transam/commit_ts.c:77">TransactionIdToCTsEntry</a>(xid);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slotno;<br/></li>
<li>&nbsp; &nbsp; <a href="#L54" title="access/transam/commit_ts.c:54">CommitTimestampEntry</a> entry;<br/></li>
<li>&nbsp; &nbsp; TransactionId oldestCommitTsXid;<br/></li>
<li>&nbsp; &nbsp; TransactionId newestCommitTsXid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!TransactionIdIsValid(xid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;cannot retrieve commit timestamp for transaction </span><span class="Special">%u</span><span class="Constant">&quot;</span>, xid)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (!TransactionIdIsNormal(xid))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* frozen and bootstrap xids are always committed far in the past */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *ts = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nodeid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *nodeid = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_SHARED);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Error if module not enabled */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L381" title="access/transam/commit_ts.c:381">error_commit_ts_disabled</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If we're asked for the cached value, return that.&nbsp; Otherwise, fall<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * through to read from SLRU.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;xidLastCommit == xid)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ts = <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.time;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nodeid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *nodeid = <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.nodeid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> *ts != <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; oldestCommitTsXid = <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid;<br/></li>
<li>&nbsp; &nbsp; newestCommitTsXid = <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* neither is invalid, or both are */<br/></li>
<li></span>&nbsp; &nbsp; Assert(TransactionIdIsValid(oldestCommitTsXid) == TransactionIdIsValid(newestCommitTsXid));<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Return empty if the requested value is outside our valid <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!TransactionIdIsValid(oldestCommitTsXid) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(xid, oldestCommitTsXid) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(newestCommitTsXid, xid))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ts = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nodeid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *nodeid = InvalidRepOriginId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* lock is acquired by <a href="slru.c.html#L591" title="access/transam/slru.c:591">SimpleLruReadPage_ReadOnly</a> */<br/></li>
<li></span>&nbsp; &nbsp; slotno = <a href="slru.c.html#L591" title="access/transam/slru.c:591">SimpleLruReadPage_ReadOnly</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno, xid);<br/></li>
<li>&nbsp; &nbsp; memcpy(&amp;entry,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;page_buffer[slotno] +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L60" title="access/transam/commit_ts.c:60">SizeOfCommitTimestampEntry</a> * entryno,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L60" title="access/transam/commit_ts.c:60">SizeOfCommitTimestampEntry</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ts = entry.time;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nodeid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nodeid = entry.nodeid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(SimpleLruGetBankLock(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> *ts != <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Return the Xid of the latest committed transaction.&nbsp; (As far as this module<br/></li>
<li></span><span class="Comment"> * is concerned, anyway; it's up to the caller to ensure the value is useful<br/></li>
<li></span><span class="Comment"> * for its purposes.)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * ts and nodeid are filled with the corresponding data; they can be passed<br/></li>
<li></span><span class="Comment"> * as NULL if not wanted.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>TransactionId<br/></li>
<li><a id="L360">&#x200c;</a><span class="linkable">GetLatestCommitTsData</span>(TimestampTz *ts, RepOriginId *nodeid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_SHARED);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Error if module not enabled */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L381" title="access/transam/commit_ts.c:381">error_commit_ts_disabled</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; xid = <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;xidLastCommit;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ts)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ts = <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.time;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nodeid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nodeid = <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.nodeid;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> xid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L381">&#x200c;</a></span><span class="linkable">error_commit_ts_disabled</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not get commit timestamp data&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="xlog.c.html#L6290" title="access/transam/xlog.c:6290">RecoveryInProgress</a>() ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../utils/error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;Make sure the configuration parameter </span><span class="Special">%s</span><span class="Constant"> is set on the primary server.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L109" title="access/transam/commit_ts.c:109">track_commit_timestamp</a>&quot;</span>) :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../utils/error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;Make sure the configuration parameter </span><span class="Special">%s</span><span class="Constant"> is set.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L109" title="access/transam/commit_ts.c:109">track_commit_timestamp</a>&quot;</span>)));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL-callable wrapper to obtain commit time of a transaction<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L397">&#x200c;</a><span class="linkable">pg_xact_commit_timestamp</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xid = PG_GETARG_TRANSACTIONID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; found = <a href="#L274" title="access/transam/commit_ts.c:274">TransactionIdGetCommitTsData</a>(xid, &amp;ts, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_TIMESTAMPTZ(ts);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L420" title="access/transam/commit_ts.c:420">pg_last_committed_xact</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * SQL-callable wrapper to obtain some information about the latest<br/></li>
<li></span><span class="Comment"> * committed transaction: transaction ID, timestamp and replication<br/></li>
<li></span><span class="Comment"> * origin.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L420">&#x200c;</a><span class="linkable">pg_last_committed_xact</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xid;<br/></li>
<li>&nbsp; &nbsp; RepOriginId nodeid;<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">3</span>];<br/></li>
<li>&nbsp; &nbsp; TupleDesc&nbsp; &nbsp; tupdesc;<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; htup;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* and construct a tuple with our data */<br/></li>
<li></span>&nbsp; &nbsp; xid = <a href="#L360" title="access/transam/commit_ts.c:360">GetLatestCommitTsData</a>(&amp;ts, &amp;nodeid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../utils/fmgr/funcapi.c.html#L276" title="utils/fmgr/funcapi.c:276">get_call_result_type</a>(fcinfo, <span class="Constant">NULL</span>, &amp;tupdesc) != TYPEFUNC_COMPOSITE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;return type must be a row type&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!TransactionIdIsNormal(xid))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memset(nulls, <span class="Constant">true</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(nulls));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">0</span>] = TransactionIdGetDatum(xid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">0</span>] = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">1</span>] = TimestampTzGetDatum(ts);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">1</span>] = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">2</span>] = ObjectIdGetDatum((Oid) nodeid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">2</span>] = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; htup = <a href="../common/heaptuple.c.html#L1116" title="access/common/heaptuple.c:1116">heap_form_tuple</a>(tupdesc, <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, nulls);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(HeapTupleGetDatum(htup));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L464" title="access/transam/commit_ts.c:464">pg_xact_commit_timestamp_origin</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * SQL-callable wrapper to obtain commit timestamp and replication origin<br/></li>
<li></span><span class="Comment"> * of a given transaction.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L464">&#x200c;</a><span class="linkable">pg_xact_commit_timestamp_origin</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xid = PG_GETARG_TRANSACTIONID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; RepOriginId nodeid;<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; TupleDesc&nbsp; &nbsp; tupdesc;<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; htup;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; found = <a href="#L274" title="access/transam/commit_ts.c:274">TransactionIdGetCommitTsData</a>(xid, &amp;ts, &amp;nodeid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../utils/fmgr/funcapi.c.html#L276" title="utils/fmgr/funcapi.c:276">get_call_result_type</a>(fcinfo, <span class="Constant">NULL</span>, &amp;tupdesc) != TYPEFUNC_COMPOSITE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;return type must be a row type&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memset(nulls, <span class="Constant">true</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(nulls));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">0</span>] = TimestampTzGetDatum(ts);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">0</span>] = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">1</span>] = ObjectIdGetDatum((Oid) nodeid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">1</span>] = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; htup = <a href="../common/heaptuple.c.html#L1116" title="access/common/heaptuple.c:1116">heap_form_tuple</a>(tupdesc, <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, nulls);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(HeapTupleGetDatum(htup));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Number of shared CommitTS buffers.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If asked to autotune, use 2MB for every 1GB of shared buffers, up to 8MB.<br/></li>
<li></span><span class="Comment"> * Otherwise just cap the configured amount to be between 16 and the maximum<br/></li>
<li></span><span class="Comment"> * allowed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L506">&#x200c;</a></span><span class="linkable">CommitTsShmemBuffers</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* auto-tune based on shared buffers */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a> == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="slru.c.html#L217" title="access/transam/slru.c:217">SimpleLruAutotuneBuffers</a>(<span class="Constant">512</span>, <span class="Constant">1024</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../jit/llvm/llvmjit_inline.cpp.html#L46" title="jit/llvm/llvmjit_inline.cpp:46">Min</a>(Max(<span class="Constant">16</span>, <a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a>), SLRU_MAX_ALLOWED_BUFFERS);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Shared memory sizing for CommitTs<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L519">&#x200c;</a><span class="linkable">CommitTsShmemSize</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="slru.c.html#L184" title="access/transam/slru.c:184">SimpleLruShmemSize</a>(<a href="#L506" title="access/transam/commit_ts.c:506">CommitTsShmemBuffers</a>(), <span class="Constant">0</span>) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L98" title="access/transam/commit_ts.c:98">CommitTimestampShared</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize CommitTs at system startup (postmaster start or standalone<br/></li>
<li></span><span class="Comment"> * backend)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L530">&#x200c;</a></span><span class="linkable">CommitTsShmemInit</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If auto-tuning is requested, <a href="../../utils/adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> is the time to do it */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a> == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; buf[<span class="Constant">32</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(buf), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>, <a href="#L506" title="access/transam/commit_ts.c:506">CommitTsShmemBuffers</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../utils/misc/guc.c.html#L4285" title="utils/misc/guc.c:4285">SetConfigOption</a>(<span class="Constant">&quot;<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a>&quot;</span>, buf, PGC_POSTMASTER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGC_S_DYNAMIC_DEFAULT);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We prefer to report this value's source as PGC_S_DYNAMIC_DEFAULT.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * However, if the DBA explicitly set <a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a> = 0 in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the config file, then PGC_S_DYNAMIC_DEFAULT will fail to override<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * that and we must force the matter with PGC_S_OVERRIDE.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a> == <span class="Constant">0</span>)&nbsp; &nbsp; <span class="Comment">/* failed to apply it? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../utils/misc/guc.c.html#L4285" title="utils/misc/guc.c:4285">SetConfigOption</a>(<span class="Constant">&quot;<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a>&quot;</span>, buf, PGC_POSTMASTER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGC_S_OVERRIDE);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a> != <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;PagePrecedes = <a href="#L970" title="access/transam/commit_ts.c:970">CommitTsPagePrecedes</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="slru.c.html#L238" title="access/transam/slru.c:238">SimpleLruInit</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, <span class="Constant">&quot;commit_timestamp&quot;</span>, <a href="#L506" title="access/transam/commit_ts.c:506">CommitTsShmemBuffers</a>(), <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;pg_commit_ts&quot;</span>, LWTRANCHE_COMMITTS_BUFFER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LWTRANCHE_COMMITTS_SLRU,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SYNC_HANDLER_COMMIT_TS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="slru.c.html#L1680" title="access/transam/slru.c:1680">SlruPagePrecedesUnitTests</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a> = <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;CommitTs shared&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L98" title="access/transam/commit_ts.c:98">CommitTimestampShared</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../utils/init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;xidLastCommit = InvalidTransactionId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; TIMESTAMP_NOBEGIN(<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.time);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.nodeid = InvalidRepOriginId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(found);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * GUC check_hook for <a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a><br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L584">&#x200c;</a></span><span class="linkable">check_commit_ts_buffers</span>(<span class="Type">int</span> *<a href="../../utils/misc/guc.c.html#L3703" title="utils/misc/guc.c:3703">newval</a>, <span class="Type">void</span> **extra, GucSource source)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="slru.c.html#L341" title="access/transam/slru.c:341">check_slru_buffers</a>(<span class="Constant">&quot;<a href="../../utils/init/globals.c.html#L162" title="utils/init/globals.c:162">commit_timestamp_buffers</a>&quot;</span>, <a href="../../utils/misc/guc.c.html#L3703" title="utils/misc/guc.c:3703">newval</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This function must be called ONCE on system install.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * (The CommitTs directory is assumed to have been created by initdb, and<br/></li>
<li></span><span class="Comment"> * <a href="#L530" title="access/transam/commit_ts.c:530">CommitTsShmemInit</a> must have been called already.)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L596">&#x200c;</a></span><span class="linkable">BootStrapCommitTs</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Nothing to do here at present, unlike most other SLRU modules; segments<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * are created when the server is started with this module enabled. See<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L705" title="access/transam/commit_ts.c:705">ActivateCommitTs</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize (or reinitialize) a page of CommitTs to zeroes.<br/></li>
<li></span><span class="Comment"> * If writeXlog is true, also emit an XLOG record saying we did this.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The page is not actually written, just set up in shared memory.<br/></li>
<li></span><span class="Comment"> * The slot number of the new page is returned.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Control lock must be held at entry, and will be held at exit.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L615">&#x200c;</a></span><span class="linkable">ZeroCommitTsPage</span>(int64 pageno, <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> writeXlog)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slotno;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; slotno = <a href="slru.c.html#L361" title="access/transam/slru.c:361">SimpleLruZeroPage</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (writeXlog)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L989" title="access/transam/commit_ts.c:989">WriteZeroPageXlogRec</a>(pageno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> slotno;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This must be called ONCE during postmaster or standalone-backend startup,<br/></li>
<li></span><span class="Comment"> * after <a href="xlog.c.html#L5388" title="access/transam/xlog.c:5388">StartupXLOG</a> has initialized <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;nextXid.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L632">&#x200c;</a></span><span class="linkable">StartupCommitTs</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L705" title="access/transam/commit_ts.c:705">ActivateCommitTs</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This must be called ONCE during postmaster or standalone-backend startup,<br/></li>
<li></span><span class="Comment"> * after recovery has finished.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L642">&#x200c;</a></span><span class="linkable">CompleteCommitTsInitialization</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the feature is not enabled, turn it off for good.&nbsp; This also removes<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> leftover data.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Conversely, we activate the module if the feature is enabled.&nbsp; This is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * necessary for primary and standby as the activation depends on the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * control file contents at the beginning of recovery or when a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * XLOG_PARAMETER_CHANGE is replayed.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L109" title="access/transam/commit_ts.c:109">track_commit_timestamp</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L778" title="access/transam/commit_ts.c:778">DeactivateCommitTs</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L705" title="access/transam/commit_ts.c:705">ActivateCommitTs</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Activate or deactivate CommitTs' upon reception of a XLOG_PARAMETER_CHANGE<br/></li>
<li></span><span class="Comment"> * XLog record during recovery.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L664">&#x200c;</a></span><span class="linkable">CommitTsParameterChange</span>(<span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> newvalue, <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> oldvalue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the commit_ts module is disabled in this server and we get <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a> from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the primary server that it is enabled there, activate it so that we can<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * replay future WAL <a href="twophase.c.html#L1025" title="access/transam/twophase.c:1025">records</a> involving it; also mark it as active on<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pg_control.&nbsp; If the old value was already set, we already did this, so<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * don't do anything.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the module is disabled in the primary, disable it here too, unless<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the module is enabled locally.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note this only runs in the recovery process, so an unlocked read is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * fine.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (newvalue)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L705" title="access/transam/commit_ts.c:705">ActivateCommitTs</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L778" title="access/transam/commit_ts.c:778">DeactivateCommitTs</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Activate this module whenever necessary.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; This must happen during postmaster or standalone-backend startup,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; or during WAL replay anytime the <a href="#L109" title="access/transam/commit_ts.c:109">track_commit_timestamp</a> setting is<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; changed in the primary.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The reason why this SLRU needs separate activation/deactivation <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> is<br/></li>
<li></span><span class="Comment"> * that it can be enabled/disabled during start and the activation/deactivation<br/></li>
<li></span><span class="Comment"> * on the primary is propagated to the standby via replay. Other SLRUs don't<br/></li>
<li></span><span class="Comment"> * have this property and they can be just initialized during normal startup.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is in <a href="../../utils/adt/char.c.html#L172" title="utils/adt/char.c:172">charge</a> of creating the currently active segment, if it's not<br/></li>
<li></span><span class="Comment"> * already there.&nbsp; The reason for this is that the server might have been<br/></li>
<li></span><span class="Comment"> * running with this module disabled for a while and thus might have skipped<br/></li>
<li></span><span class="Comment"> * the normal creation point.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L705">&#x200c;</a></span><span class="linkable">ActivateCommitTs</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xid;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; pageno;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If we've done this already, there's nothing to do */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; xid = XidFromFullTransactionId(<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;nextXid);<br/></li>
<li>&nbsp; &nbsp; pageno = <a href="#L72" title="access/transam/commit_ts.c:72">TransactionIdToCTsPage</a>(xid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Re-Initialize our idea of the latest page number.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; pg_atomic_write_u64(&amp;<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;latest_page_number, pageno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If CommitTs is enabled, but it wasn't in the previous server run, we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * need to set the oldest and newest <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> to the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> Xid; that way, we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * will not try to read data that might not have been set.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * </span><span class="Todo">XXX</span><span class="Comment"> does this have a problem if a server is started with commitTs<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * enabled, then started with commitTs disabled, then restarted with it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * enabled again?&nbsp; It doesn't look like it does, because there should be a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * checkpoint that sets the value to InvalidTransactionId at end of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * recovery; and so <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> chance of injecting new transactions without<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * CommitTs <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> would occur after the oldestCommitTsXid has been set to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Invalid temporarily.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid == InvalidTransactionId)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid = ReadNextTransactionId();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create the current segment file, if necessary */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="slru.c.html#L729" title="access/transam/slru.c:729">SimpleLruDoesPhysicalPageExist</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; LWLock&nbsp; &nbsp; &nbsp;&nbsp; *lock = SimpleLruGetBankLock(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slotno;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(lock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slotno = <a href="#L615" title="access/transam/commit_ts.c:615">ZeroCommitTsPage</a>(pageno, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="slru.c.html#L715" title="access/transam/slru.c:715">SimpleLruWritePage</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, slotno);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;page_dirty[slotno]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(lock);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Change the activation status in shared memory. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Deactivate this module.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This must be called when the <a href="#L109" title="access/transam/commit_ts.c:109">track_commit_timestamp</a> parameter is turned off.<br/></li>
<li></span><span class="Comment"> * This happens during postmaster or standalone-backend startup, or during WAL<br/></li>
<li></span><span class="Comment"> * replay.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Resets CommitTs into invalid state to make sure we don't hand back<br/></li>
<li></span><span class="Comment"> * possibly-invalid data; also removes segments of old data.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L778">&#x200c;</a></span><span class="linkable">DeactivateCommitTs</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Cleanup the status in the shared memory.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We reset everything in the <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a> record to prevent user from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * getting confusing data about last committed transaction on the standby<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * when the module was activated repeatedly on the primary.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;xidLastCommit = InvalidTransactionId;<br/></li>
<li>&nbsp; &nbsp; TIMESTAMP_NOBEGIN(<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.time);<br/></li>
<li>&nbsp; &nbsp; <a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;dataLastCommit.nodeid = InvalidRepOriginId;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid = InvalidTransactionId;<br/></li>
<li>&nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid = InvalidTransactionId;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Remove *all* files.&nbsp; This is necessary so that there are no leftover<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * files; in the case where this feature is later enabled after running<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * with it disabled for some time there may be a gap in the file sequence.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (We can probably tolerate out-of-sequence files, as they are going to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * be overwritten anyway when we wrap around, but it seems better to be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * tidy.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note that we do this with CommitTsLock acquired in exclusive mode. This<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * is very heavy-handed, but since this routine can only be called in the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * replica and should happen very rarely, we don't worry too much about<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * it.&nbsp; Note also that no process should be consulting this SLRU if we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * have just deactivated it.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="slru.c.html#L1774" title="access/transam/slru.c:1774">SlruScanDirectory</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, <a href="slru.c.html#L1727" title="access/transam/slru.c:1727">SlruScanDirCbDeleteAll</a>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Perform a checkpoint --- either during shutdown, or on-the-fly<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L820">&#x200c;</a></span><span class="linkable">CheckPointCommitTs</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write dirty CommitTs pages to disk.&nbsp; This may result in sync requests<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * queued for later handling by <a href="../../storage/sync/sync.c.html#L286" title="storage/sync/sync.c:286">ProcessSyncRequests</a>(), as part of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * checkpoint.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="slru.c.html#L1305" title="access/transam/slru.c:1305">SimpleLruWriteAll</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Make sure that CommitTs has room for a newly-allocated XID.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: this is called while holding XidGenLock.&nbsp; We want it to be very fast<br/></li>
<li></span><span class="Comment"> * most of the time; even when it's not so fast, no actual I/O need happen<br/></li>
<li></span><span class="Comment"> * unless we're forced to write out a dirty CommitTs or xlog page to make room<br/></li>
<li></span><span class="Comment"> * in shared memory.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: the current implementation relies on <a href="#L109" title="access/transam/commit_ts.c:109">track_commit_timestamp</a> being<br/></li>
<li></span><span class="Comment"> * PGC_POSTMASTER.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L842">&#x200c;</a></span><span class="linkable">ExtendCommitTs</span>(TransactionId newestXact)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; pageno;<br/></li>
<li>&nbsp; &nbsp; LWLock&nbsp; &nbsp; &nbsp;&nbsp; *lock;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Nothing to do if module not enabled.&nbsp; Note we do an unlocked read of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the flag here, which is okay because this routine is only called from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="varsup.c.html#L77" title="access/transam/varsup.c:77">GetNewTransactionId</a>, which is never called in a standby.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!<a href="xlogutils.c.html#L50" title="access/transam/xlogutils.c:50">InRecovery</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L105" title="access/transam/commit_ts.c:105">commitTsShared</a>-&gt;commitTsActive)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * No work except at first XID of a page.&nbsp; But beware: just after<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * wraparound, the first XID of page zero is FirstNormalTransactionId.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L77" title="access/transam/commit_ts.c:77">TransactionIdToCTsEntry</a>(newestXact) != <span class="Constant">0</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !TransactionIdEquals(newestXact, FirstNormalTransactionId))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pageno = <a href="#L72" title="access/transam/commit_ts.c:72">TransactionIdToCTsPage</a>(newestXact);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; lock = SimpleLruGetBankLock(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(lock, LW_EXCLUSIVE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Zero the page and make an XLOG entry about it */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L615" title="access/transam/commit_ts.c:615">ZeroCommitTsPage</a>(pageno, !<a href="xlogutils.c.html#L50" title="access/transam/xlogutils.c:50">InRecovery</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(lock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Remove all CommitTs segments <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the one holding the passed<br/></li>
<li></span><span class="Comment"> * transaction ID.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that we don't need to flush XLOG here.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L883">&#x200c;</a></span><span class="linkable">TruncateCommitTs</span>(TransactionId oldestXact)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; cutoffPage;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The cutoff point is the start of the segment containing oldestXact. We<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pass the *page* containing oldestXact to <a href="slru.c.html#L1391" title="access/transam/slru.c:1391">SimpleLruTruncate</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; cutoffPage = <a href="#L72" title="access/transam/commit_ts.c:72">TransactionIdToCTsPage</a>(oldestXact);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check to see if there's <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> files that could be removed */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="slru.c.html#L1774" title="access/transam/slru.c:1774">SlruScanDirectory</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, <a href="slru.c.html#L1695" title="access/transam/slru.c:1695">SlruScanDirCbReportPresence</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;cutoffPage))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* nothing to remove */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Write XLOG record */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1000" title="access/transam/commit_ts.c:1000">WriteTruncateXlogRec</a>(cutoffPage, oldestXact);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Now we can remove the old CommitTs segment(s) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="slru.c.html#L1391" title="access/transam/slru.c:1391">SimpleLruTruncate</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, cutoffPage);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Set the limit <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> between which commit TS can be consulted.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L909">&#x200c;</a></span><span class="linkable">SetCommitTsLimit</span>(TransactionId oldestXact, TransactionId newestXact)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Be careful not to overwrite <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> that are either further into the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * &quot;future&quot; or signal a disabled committs.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid != InvalidTransactionId)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid, oldestXact))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid = oldestXact;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(newestXact, <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid = newestXact;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid == InvalidTransactionId);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid = oldestXact;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;newestCommitTsXid = newestXact;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Move forwards the oldest commitTS value that can be consulted<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L936">&#x200c;</a></span><span class="linkable">AdvanceOldestCommitTsXid</span>(TransactionId oldestXact)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(CommitTsLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid != InvalidTransactionId &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(<a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid, oldestXact))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="varsup.c.html#L34" title="access/transam/varsup.c:34">TransamVariables</a>-&gt;oldestCommitTsXid = oldestXact;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(CommitTsLock);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Decide whether a commitTS page number is &quot;older&quot; for truncation purposes.<br/></li>
<li></span><span class="Comment"> * Analogous to <a href="clog.c.html#L1055" title="access/transam/clog.c:1055">CLOGPagePrecedes</a>().<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * At default BLCKSZ, (1 &lt;&lt; 31) % <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a> == 128.&nbsp; This<br/></li>
<li></span><span class="Comment"> * introduces differences compared to CLOG and the other SLRUs having (1 &lt;&lt;<br/></li>
<li></span><span class="Comment"> * 31) % per_page == 0.&nbsp; This function never tests exactly<br/></li>
<li></span><span class="Comment"> * <a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(x-2^31, x).&nbsp; When the system reaches xidStopLimit,<br/></li>
<li></span><span class="Comment"> * there are two possible counts of page boundaries between oldestXact and the<br/></li>
<li></span><span class="Comment"> * latest XID assigned, depending on whether oldestXact is within the first<br/></li>
<li></span><span class="Comment"> * 128 entries of its page.&nbsp; Since this function doesn't know the location of<br/></li>
<li></span><span class="Comment"> * oldestXact within page2, it returns false for one page that actually is<br/></li>
<li></span><span class="Comment"> * expendable.&nbsp; This is a wider (yet still negligible) version of the<br/></li>
<li></span><span class="Comment"> * truncation opportunity that <a href="clog.c.html#L1055" title="access/transam/clog.c:1055">CLOGPagePrecedes</a>() cannot recognize.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * For the sake of a worked example, number entries with decimal <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> such<br/></li>
<li></span><span class="Comment"> * that page1==1 entries <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> from 1.0 to 1.999.&nbsp; Let N+0.15 be the number of<br/></li>
<li></span><span class="Comment"> * pages that 2^31 entries will span (N is an integer).&nbsp; If oldestXact=N+2.1,<br/></li>
<li></span><span class="Comment"> * then the final safe XID assignment leaves newestXact=1.95.&nbsp; We keep page 2,<br/></li>
<li></span><span class="Comment"> * because entry=2.85 is the border that toggles whether entries precede the<br/></li>
<li></span><span class="Comment"> * last entry of the oldestXact page.&nbsp; While page 2 is expendable at<br/></li>
<li></span><span class="Comment"> * oldestXact=N+2.1, it would be precious at oldestXact=N+2.9.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L970">&#x200c;</a></span><span class="linkable">CommitTsPagePrecedes</span>(int64 page1, int64 page2)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TransactionId xid1;<br/></li>
<li>&nbsp; &nbsp; TransactionId xid2;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; xid1 = ((TransactionId) page1) * <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>;<br/></li>
<li>&nbsp; &nbsp; xid1 += FirstNormalTransactionId + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; xid2 = ((TransactionId) page2) * <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a>;<br/></li>
<li>&nbsp; &nbsp; xid2 += FirstNormalTransactionId + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (<a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(xid1, xid2) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="transam.c.html#L280" title="access/transam/transam.c:280">TransactionIdPrecedes</a>(xid1, xid2 + <a href="#L63" title="access/transam/commit_ts.c:63">COMMIT_TS_XACTS_PER_PAGE</a> - <span class="Constant">1</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Write a ZEROPAGE xlog record<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L989">&#x200c;</a></span><span class="linkable">WriteZeroPageXlogRec</span>(int64 pageno)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="xloginsert.c.html#L149" title="access/transam/xloginsert.c:149">XLogBeginInsert</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="xloginsert.c.html#L364" title="access/transam/xloginsert.c:364">XLogRegisterData</a>((<span class="Type">char</span> *) (&amp;pageno), <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pageno));<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="xloginsert.c.html#L474" title="access/transam/xloginsert.c:474">XLogInsert</a>(RM_COMMIT_TS_ID, COMMIT_TS_ZEROPAGE);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Write a TRUNCATE xlog record<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1000">&#x200c;</a></span><span class="linkable">WriteTruncateXlogRec</span>(int64 pageno, TransactionId oldestXid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; xl_commit_ts_truncate xlrec;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; xlrec.pageno = pageno;<br/></li>
<li>&nbsp; &nbsp; xlrec.oldestXid = oldestXid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="xloginsert.c.html#L149" title="access/transam/xloginsert.c:149">XLogBeginInsert</a>();<br/></li>
<li>&nbsp; &nbsp; <a href="xloginsert.c.html#L364" title="access/transam/xloginsert.c:364">XLogRegisterData</a>((<span class="Type">char</span> *) (&amp;xlrec), SizeOfCommitTsTruncate);<br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="xloginsert.c.html#L474" title="access/transam/xloginsert.c:474">XLogInsert</a>(RM_COMMIT_TS_ID, COMMIT_TS_TRUNCATE);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * CommitTS resource manager's routines<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L1016">&#x200c;</a></span><span class="linkable">commit_ts_redo</span>(XLogReaderState *record)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; info = XLogRecGetInfo(record) &amp; ~XLR_INFO_MASK;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Backup blocks are not used in commit_ts <a href="twophase.c.html#L1025" title="access/transam/twophase.c:1025">records</a> */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!XLogRecHasAnyBlockRefs(record));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (info == COMMIT_TS_ZEROPAGE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; pageno;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slotno;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; LWLock&nbsp; &nbsp; &nbsp;&nbsp; *lock;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(&amp;pageno, XLogRecGetData(record), <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pageno));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lock = SimpleLruGetBankLock(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, pageno);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(lock, LW_EXCLUSIVE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; slotno = <a href="#L615" title="access/transam/commit_ts.c:615">ZeroCommitTsPage</a>(pageno, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="slru.c.html#L715" title="access/transam/slru.c:715">SimpleLruWritePage</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, slotno);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;page_dirty[slotno]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(lock);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (info == COMMIT_TS_TRUNCATE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; xl_commit_ts_truncate *trunc = (xl_commit_ts_truncate *) XLogRecGetData(record);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L936" title="access/transam/commit_ts.c:936">AdvanceOldestCommitTsXid</a>(trunc-&gt;oldestXid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * During XLOG replay, latest_page_number isn't set up yet; insert a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * suitable value to bypass the sanity test in <a href="slru.c.html#L1391" title="access/transam/slru.c:1391">SimpleLruTruncate</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; pg_atomic_write_u64(&amp;<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>-&gt;shared-&gt;latest_page_number,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trunc-&gt;pageno);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="slru.c.html#L1391" title="access/transam/slru.c:1391">SimpleLruTruncate</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, trunc-&gt;pageno);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; elog(PANIC, <span class="Constant">&quot;<a href="#L1016" title="access/transam/commit_ts.c:1016">commit_ts_redo</a>: unknown op code </span><span class="Special">%u</span><span class="Constant">&quot;</span>, info);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Entrypoint for sync.c to sync commit_ts files.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">int<br/></li>
<li><a id="L1063">&#x200c;</a></span><span class="linkable">committssyncfiletag</span>(<span class="Type">const</span> FileTag *ftag, <span class="Type">char</span> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="slru.c.html#L1814" title="access/transam/slru.c:1814">SlruSyncFileTag</a>(<a href="#L85" title="access/transam/commit_ts.c:85">CommitTsCtl</a>, ftag, path);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
