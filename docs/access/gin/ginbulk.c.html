<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>access/gin/ginbulk.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>access/gin/ginbulk.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L72">cmpEntryAccumulator</a></li>
<li><a href="#L128">getDatumCopy</a></li>
<li><a href="#L85">ginAllocEntryAccumulator</a></li>
<li><a href="#L257">ginBeginBAScan</a></li>
<li><a href="#L30">ginCombineData</a></li>
<li><a href="#L268">ginGetBAEntry</a></li>
<li><a href="#L109">ginInitBA</a></li>
<li><a href="#L210">ginInsertBAEntries</a></li>
<li><a href="#L148">ginInsertBAEntry</a></li>
<li><a href="#L246">qsortCompareItemPointers</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L24">DEF_NENTRY</a></li>
<li><a href="#L25">DEF_NPTR</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * ginbulk.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; routines for fast build of inverted index<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src/backend/access/gin/ginbulk.c<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;limits.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/gin_private.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/datum.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><a id="L24">&#x200c;</a><span class="PreProc">#define <span class="linkable">DEF_NENTRY</span>&nbsp; &nbsp; </span><span class="Constant">2048</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* GinEntryAccumulator allocation quantum */<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">DEF_NPTR</span>&nbsp; &nbsp; </span><span class="Constant">5</span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* ItemPointer initial allocation quantum */<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* Combiner function for rbtree.c */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="linkable">ginCombineData</span>(RBTNode *existing, <span class="Type">const</span> RBTNode *newdata, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; GinEntryAccumulator *eo = (GinEntryAccumulator *) existing;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> GinEntryAccumulator *en = (<span class="Type">const</span> GinEntryAccumulator *) newdata;<br/></li>
<li>&nbsp; &nbsp; BuildAccumulator *accum = (BuildAccumulator *) arg;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note this code assumes that newdata contains only one itempointer.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (eo-&gt;count &gt;= eo-&gt;maxcount)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (eo-&gt;maxcount &gt; <span class="Constant">INT_MAX</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../../utils/error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_PROGRAM_LIMIT_EXCEEDED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;posting list is too long&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../utils/error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;Reduce <a href="../../utils/init/globals.c.html#L130" title="utils/init/globals.c:130">maintenance_work_mem</a>.&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;allocatedMemory -= <a href="../../utils/mmgr/mcxt.c.html#L721" title="utils/mmgr/mcxt.c:721">GetMemoryChunkSpace</a>(eo-&gt;list);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; eo-&gt;maxcount *= <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; eo-&gt;list = (ItemPointerData *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../utils/mmgr/mcxt.c.html#L1671" title="utils/mmgr/mcxt.c:1671">repalloc_huge</a>(eo-&gt;list, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData) * eo-&gt;maxcount);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;allocatedMemory += <a href="../../utils/mmgr/mcxt.c.html#L721" title="utils/mmgr/mcxt.c:721">GetMemoryChunkSpace</a>(eo-&gt;list);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If item pointers are not ordered, they will need to be sorted later */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (eo-&gt;shouldSort == <span class="Constant">false</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res = ginCompareItemPointers(eo-&gt;list + eo-&gt;count - <span class="Constant">1</span>, en-&gt;list);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(res != <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (res &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eo-&gt;shouldSort = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; eo-&gt;list[eo-&gt;count] = en-&gt;list[<span class="Constant">0</span>];<br/></li>
<li>&nbsp; &nbsp; eo-&gt;count++;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Comparator function for rbtree.c */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L72">&#x200c;</a></span><span class="linkable">cmpEntryAccumulator</span>(<span class="Type">const</span> RBTNode *a, <span class="Type">const</span> RBTNode *b, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> GinEntryAccumulator *ea = (<span class="Type">const</span> GinEntryAccumulator *) a;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> GinEntryAccumulator *eb = (<span class="Type">const</span> GinEntryAccumulator *) b;<br/></li>
<li>&nbsp; &nbsp; BuildAccumulator *accum = (BuildAccumulator *) arg;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="ginutil.c.html#L410" title="access/gin/ginutil.c:410">ginCompareAttEntries</a>(accum-&gt;ginstate,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;attnum, ea-&gt;key, ea-&gt;category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eb-&gt;attnum, eb-&gt;key, eb-&gt;category);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Allocator function for rbtree.c */<br/></li>
<li></span><span class="Type">static</span> RBTNode *<br/></li>
<li><a id="L85">&#x200c;</a><span class="linkable">ginAllocEntryAccumulator</span>(<span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; BuildAccumulator *accum = (BuildAccumulator *) arg;<br/></li>
<li>&nbsp; &nbsp; GinEntryAccumulator *ea;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Allocate memory by rather big chunks to decrease overhead.&nbsp; We have no<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * need to reclaim RBTNodes individually, so this costs nothing.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (accum-&gt;entryallocator == <span class="Constant">NULL</span> || accum-&gt;eas_used &gt;= <a href="#L24" title="access/gin/ginbulk.c:24">DEF_NENTRY</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;entryallocator = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(GinEntryAccumulator) * <a href="#L24" title="access/gin/ginbulk.c:24">DEF_NENTRY</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;allocatedMemory += <a href="../../utils/mmgr/mcxt.c.html#L721" title="utils/mmgr/mcxt.c:721">GetMemoryChunkSpace</a>(accum-&gt;entryallocator);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;eas_used = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Allocate new RBTNode from current chunk */<br/></li>
<li></span>&nbsp; &nbsp; ea = accum-&gt;entryallocator + accum-&gt;eas_used;<br/></li>
<li>&nbsp; &nbsp; accum-&gt;eas_used++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (RBTNode *) ea;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L109">&#x200c;</a></span><span class="linkable">ginInitBA</span>(BuildAccumulator *accum)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* accum-&gt;ginstate is intentionally not set here */<br/></li>
<li></span>&nbsp; &nbsp; accum-&gt;allocatedMemory = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; accum-&gt;entryallocator = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; accum-&gt;eas_used = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; accum-&gt;tree = <a href="../../lib/rbtree.c.html#L102" title="lib/rbtree.c:102">rbt_create</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(GinEntryAccumulator),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L72" title="access/gin/ginbulk.c:72">cmpEntryAccumulator</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L30" title="access/gin/ginbulk.c:30">ginCombineData</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L85" title="access/gin/ginbulk.c:85">ginAllocEntryAccumulator</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>,&nbsp; &nbsp; <span class="Comment">/* no freefunc needed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (<span class="Type">void</span> *) accum);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This is basically the same as <a href="../../utils/adt/datum.c.html#L132" title="utils/adt/datum.c:132">datumCopy</a>(), but extended to count<br/></li>
<li></span><span class="Comment"> * <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d space in accum-&gt;allocatedMemory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Datum<br/></li>
<li><a id="L128">&#x200c;</a><span class="linkable">getDatumCopy</span>(BuildAccumulator *accum, OffsetNumber attnum, Datum value)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Form_pg_attribute att;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; att = TupleDescAttr(accum-&gt;ginstate-&gt;origTupdesc, attnum - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (att-&gt;attbyval)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res = value;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res = <a href="../../utils/adt/datum.c.html#L132" title="utils/adt/datum.c:132">datumCopy</a>(value, <span class="Constant">false</span>, att-&gt;attlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;allocatedMemory += <a href="../../utils/mmgr/mcxt.c.html#L721" title="utils/mmgr/mcxt.c:721">GetMemoryChunkSpace</a>(DatumGetPointer(res));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Find/store one entry from indexed value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L148">&#x200c;</a></span><span class="linkable">ginInsertBAEntry</span>(BuildAccumulator *accum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ItemPointer heapptr, OffsetNumber attnum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Datum key, GinNullCategory category)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; GinEntryAccumulator eatmp;<br/></li>
<li>&nbsp; &nbsp; GinEntryAccumulator *ea;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isNew;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * For the moment, fill only the fields of eatmp that will be looked at by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L72" title="access/gin/ginbulk.c:72">cmpEntryAccumulator</a> or <a href="#L30" title="access/gin/ginbulk.c:30">ginCombineData</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; eatmp.attnum = attnum;<br/></li>
<li>&nbsp; &nbsp; eatmp.key = key;<br/></li>
<li>&nbsp; &nbsp; eatmp.category = category;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* temporarily set up single-entry itempointer list */<br/></li>
<li></span>&nbsp; &nbsp; eatmp.list = heapptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ea = (GinEntryAccumulator *) <a href="../../lib/rbtree.c.html#L453" title="lib/rbtree.c:453">rbt_insert</a>(accum-&gt;tree, (RBTNode *) &amp;eatmp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;isNew);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isNew)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Finish initializing new tree entry, including making permanent<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * copies of the datum (if it's not null) and itempointer.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (category == GIN_CAT_NORM_KEY)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;key = <a href="#L128" title="access/gin/ginbulk.c:128">getDatumCopy</a>(accum, attnum, key);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;maxcount = <a href="#L25" title="access/gin/ginbulk.c:25">DEF_NPTR</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;count = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;shouldSort = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;list =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (ItemPointerData *) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData) * <a href="#L25" title="access/gin/ginbulk.c:25">DEF_NPTR</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ea-&gt;list[<span class="Constant">0</span>] = *heapptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; accum-&gt;allocatedMemory += <a href="../../utils/mmgr/mcxt.c.html#L721" title="utils/mmgr/mcxt.c:721">GetMemoryChunkSpace</a>(ea-&gt;list);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="#L30" title="access/gin/ginbulk.c:30">ginCombineData</a> did everything needed.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="../../storage/file/fd.c.html#L1313" title="storage/file/fd.c:1313">Insert</a> the entries for one heap pointer.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Since the entries are being inserted into a balanced binary tree, you<br/></li>
<li></span><span class="Comment"> * might think that the order of insertion wouldn't be critical, but it turns<br/></li>
<li></span><span class="Comment"> * out that inserting the entries in sorted order results in a lot of<br/></li>
<li></span><span class="Comment"> * rebalancing operations and is slow.&nbsp; To prevent this, we attempt to insert<br/></li>
<li></span><span class="Comment"> * the nodes in an order that will produce a nearly-balanced tree if the input<br/></li>
<li></span><span class="Comment"> * is in fact sorted.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We do this as follows.&nbsp; First, we imagine that we have an array whose size<br/></li>
<li></span><span class="Comment"> * is the smallest power of two greater than or <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to the actual array<br/></li>
<li></span><span class="Comment"> * size.&nbsp; Second, we insert the middle entry of our virtual array into the<br/></li>
<li></span><span class="Comment"> * tree; then, we insert the middles of each half of our virtual array, then<br/></li>
<li></span><span class="Comment"> * middles of quarters, etc.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L210">&#x200c;</a></span><span class="linkable">ginInsertBAEntries</span>(BuildAccumulator *accum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ItemPointer heapptr, OffsetNumber attnum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Datum *entries, GinNullCategory *categories,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; int32 nentries)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; step = nentries;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nentries &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(ItemPointerIsValid(heapptr) &amp;&amp; attnum &gt;= FirstOffsetNumber);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * step will contain largest power of 2 and &lt;= nentries<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; step |= (step &gt;&gt; <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; step |= (step &gt;&gt; <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; step |= (step &gt;&gt; <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; step |= (step &gt;&gt; <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; step |= (step &gt;&gt; <span class="Constant">16</span>);<br/></li>
<li>&nbsp; &nbsp; step &gt;&gt;= <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; step++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (step &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = step - <span class="Constant">1</span>; i &lt; nentries &amp;&amp; i &gt;= <span class="Constant">0</span>; i += step &lt;&lt; <span class="Constant">1</span> <span class="Comment">/* *2 */</span> )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L148" title="access/gin/ginbulk.c:148">ginInsertBAEntry</a>(accum, heapptr, attnum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entries[i], categories[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; step &gt;&gt;= <span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* /2 */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L246">&#x200c;</a></span><span class="linkable">qsortCompareItemPointers</span>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = ginCompareItemPointers((ItemPointer) a, (ItemPointer) b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Assert that there are no <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> item pointers being sorted */<br/></li>
<li></span>&nbsp; &nbsp; Assert(res != <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Prepare to read out the rbtree contents using <a href="#L268" title="access/gin/ginbulk.c:268">ginGetBAEntry</a> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L257">&#x200c;</a></span><span class="linkable">ginBeginBAScan</span>(BuildAccumulator *accum)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../lib/rbtree.c.html#L802" title="lib/rbtree.c:802">rbt_begin_iterate</a>(accum-&gt;tree, LeftRightWalk, &amp;accum-&gt;tree_walk);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> entry in sequence from the BuildAccumulator's rbtree.<br/></li>
<li></span><span class="Comment"> * This consists of a single key datum and a list (array) of one or more<br/></li>
<li></span><span class="Comment"> * heap TIDs in which that key is found.&nbsp; The list is guaranteed sorted.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>ItemPointerData *<br/></li>
<li><a id="L268">&#x200c;</a><span class="linkable">ginGetBAEntry</span>(BuildAccumulator *accum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OffsetNumber *attnum, Datum *key, GinNullCategory *category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uint32 *n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; GinEntryAccumulator *entry;<br/></li>
<li>&nbsp; &nbsp; ItemPointerData *list;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry = (GinEntryAccumulator *) <a href="../../lib/rbtree.c.html#L826" title="lib/rbtree.c:826">rbt_iterate</a>(&amp;accum-&gt;tree_walk);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entry == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no more entries */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; *attnum = entry-&gt;attnum;<br/></li>
<li>&nbsp; &nbsp; *key = entry-&gt;key;<br/></li>
<li>&nbsp; &nbsp; *category = entry-&gt;category;<br/></li>
<li>&nbsp; &nbsp; list = entry-&gt;list;<br/></li>
<li>&nbsp; &nbsp; *n = entry-&gt;count;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(list != <span class="Constant">NULL</span> &amp;&amp; entry-&gt;count &gt; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entry-&gt;shouldSort &amp;&amp; entry-&gt;count &gt; <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qsort(list, entry-&gt;count, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L246" title="access/gin/ginbulk.c:246">qsortCompareItemPointers</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> list;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
