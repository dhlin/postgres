<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>access/gin/ginpostinglist.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>access/gin/ginpostinglist.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L133">decode_varbyte</a></li>
<li><a href="#L115">encode_varbyte</a></li>
<li><a href="#L197">ginCompressPostingList</a></li>
<li><a href="#L378">ginMergeItemPointers</a></li>
<li><a href="#L284">ginPostingListDecode</a></li>
<li><a href="#L297">ginPostingListDecodeAllSegments</a></li>
<li><a href="#L358">ginPostingListDecodeAllSegmentsToTbm</a></li>
<li><a href="#L87">itemptr_to_uint64</a></li>
<li><a href="#L102">uint64_to_itemptr</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L20">CHECK_ENCODING_ROUNDTRIP</a></li>
<li><a href="#L84">MaxBytesPerInteger</a></li>
<li><a href="#L81">MaxHeapTuplesPerPageBits</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * ginpostinglist.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; routines for dealing with posting lists.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src/backend/access/gin/ginpostinglist.c<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/gin_private.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef USE_ASSERT_CHECKING<br/></li>
<li><a id="L20">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">CHECK_ENCODING_ROUNDTRIP</span><br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * For encoding purposes, item pointers are represented as 64-<a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> unsigned<br/></li>
<li></span><span class="Comment"> * integers. The lowest 11 bits represent the offset number, and the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a><br/></li>
<li></span><span class="Comment"> * lowest 32 bits are the block number. That leaves 21 bits unused, i.e.<br/></li>
<li></span><span class="Comment"> * only 43 low bits are used.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * 11 bits is enough for the offset number, because MaxHeapTuplesPerPage &lt;<br/></li>
<li></span><span class="Comment"> * 2^11 on all supported block sizes. We are frugal with the bits, because<br/></li>
<li></span><span class="Comment"> * smaller integers use fewer bytes in the varbyte encoding, saving disk<br/></li>
<li></span><span class="Comment"> * space. (If we get a new table AM in the future that wants to use the full<br/></li>
<li></span><span class="Comment"> * <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> of possible offset numbers, we'll need to change this.)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * These 43-<a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> integers are encoded using varbyte encoding. In each byte,<br/></li>
<li></span><span class="Comment"> * the 7 low bits contain data, while the highest <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> is a continuation <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a>.<br/></li>
<li></span><span class="Comment"> * When the continuation <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> is set, the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> byte is part of the same<br/></li>
<li></span><span class="Comment"> * integer, otherwise this is the last byte of this integer. 43 bits need<br/></li>
<li></span><span class="Comment"> * at most 7 bytes in this encoding:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * 0XXXXXXX<br/></li>
<li></span><span class="Comment"> * 1XXXXXXX 0XXXXYYY<br/></li>
<li></span><span class="Comment"> * 1XXXXXXX 1XXXXYYY 0YYYYYYY<br/></li>
<li></span><span class="Comment"> * 1XXXXXXX 1XXXXYYY 1YYYYYYY 0YYYYYYY<br/></li>
<li></span><span class="Comment"> * 1XXXXXXX 1XXXXYYY 1YYYYYYY 1YYYYYYY 0YYYYYYY<br/></li>
<li></span><span class="Comment"> * 1XXXXXXX 1XXXXYYY 1YYYYYYY 1YYYYYYY 1YYYYYYY 0YYYYYYY<br/></li>
<li></span><span class="Comment"> * 1XXXXXXX 1XXXXYYY 1YYYYYYY 1YYYYYYY 1YYYYYYY 1YYYYYYY 0uuuuuuY<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * X = bits used for offset number<br/></li>
<li></span><span class="Comment"> * Y = bits used for block number<br/></li>
<li></span><span class="Comment"> * u = unused <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The bytes are in stored in little-endian order.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * An important property of this encoding is that removing an item from list<br/></li>
<li></span><span class="Comment"> * never increases the size of the resulting compressed posting list. Proof:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Removing number is actually replacement of two numbers with their sum. We<br/></li>
<li></span><span class="Comment"> * have to prove that varbyte encoding of a sum can't be longer than varbyte<br/></li>
<li></span><span class="Comment"> * encoding of its summands. Sum of two numbers is at most one <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> wider than<br/></li>
<li></span><span class="Comment"> * the larger of the summands. Widening a number by one <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> enlarges its length<br/></li>
<li></span><span class="Comment"> * in varbyte encoding by at most one byte. Therefore, varbyte encoding of sum<br/></li>
<li></span><span class="Comment"> * is at most one byte longer than varbyte encoding of larger summand. Lesser<br/></li>
<li></span><span class="Comment"> * summand is at least one byte, so the sum cannot take more space than the<br/></li>
<li></span><span class="Comment"> * summands, Q.E.D.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This property greatly simplifies VACUUM, which can assume that posting<br/></li>
<li></span><span class="Comment"> * lists always fit on the same page after vacuuming. Note that even though<br/></li>
<li></span><span class="Comment"> * that holds for removing items from a posting list, you must also be<br/></li>
<li></span><span class="Comment"> * careful to not cause expansion e.g. when merging uncompressed items on the<br/></li>
<li></span><span class="Comment"> * page into the compressed lists, when vacuuming.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * How many bits do you need to encode offset number? OffsetNumber is a 16-<a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a><br/></li>
<li></span><span class="Comment"> * integer, but you can't fit that many items on a page. 11 ought to be more<br/></li>
<li></span><span class="Comment"> * than enough. It's tempting to derive this from MaxHeapTuplesPerPage, and<br/></li>
<li></span><span class="Comment"> * use the minimum number of bits, but that would require changing the on-disk<br/></li>
<li></span><span class="Comment"> * format if MaxHeapTuplesPerPage changes. Better to leave some slack.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L81">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MaxHeapTuplesPerPageBits</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">11<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Max. number of bytes needed to encode the largest supported integer. */<br/></li>
<li><a id="L84">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MaxBytesPerInteger</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">7<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">inline</span> uint64<br/></li>
<li><a id="L87">&#x200c;</a><span class="linkable">itemptr_to_uint64</span>(<span class="Type">const</span> ItemPointer iptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; val;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(ItemPointerIsValid(iptr));<br/></li>
<li>&nbsp; &nbsp; Assert(GinItemPointerGetOffsetNumber(iptr) &lt; (<span class="Constant">1</span> &lt;&lt; <a href="#L81" title="access/gin/ginpostinglist.c:81">MaxHeapTuplesPerPageBits</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = GinItemPointerGetBlockNumber(iptr);<br/></li>
<li>&nbsp; &nbsp; val &lt;&lt;= <a href="#L81" title="access/gin/ginpostinglist.c:81">MaxHeapTuplesPerPageBits</a>;<br/></li>
<li>&nbsp; &nbsp; val |= GinItemPointerGetOffsetNumber(iptr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> val;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">inline</span> <span class="Type">void<br/></li>
<li><a id="L102">&#x200c;</a></span><span class="linkable">uint64_to_itemptr</span>(uint64 val, ItemPointer iptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; GinItemPointerSetOffsetNumber(iptr, val &amp; ((<span class="Constant">1</span> &lt;&lt; <a href="#L81" title="access/gin/ginpostinglist.c:81">MaxHeapTuplesPerPageBits</a>) - <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; val = val &gt;&gt; <a href="#L81" title="access/gin/ginpostinglist.c:81">MaxHeapTuplesPerPageBits</a>;<br/></li>
<li>&nbsp; &nbsp; GinItemPointerSetBlockNumber(iptr, val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(ItemPointerIsValid(iptr));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Varbyte-encode 'val' into *ptr. *ptr is incremented to <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> integer.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L115">&#x200c;</a></span><span class="linkable">encode_varbyte</span>(uint64 val, <span class="Type">unsigned</span> <span class="Type">char</span> **ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *p = *ptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (val &gt; <span class="Constant">0x7F</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *(p++) = <span class="Constant">0x80</span> | (val &amp; <span class="Constant">0x7F</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; val &gt;&gt;= <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; *(p++) = (<span class="Type">unsigned</span> <span class="Type">char</span>) val;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ptr = p;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Decode varbyte-encoded integer at *ptr. *ptr is incremented to <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> integer.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> uint64<br/></li>
<li><a id="L133">&#x200c;</a><span class="linkable">decode_varbyte</span>(<span class="Type">unsigned</span> <span class="Type">char</span> **ptr)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *p = *ptr;<br/></li>
<li>&nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; c;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* 1st byte */<br/></li>
<li></span>&nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; val = c &amp; <span class="Constant">0x7F</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (c &amp; <span class="Constant">0x80</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 2nd byte */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; val |= (c &amp; <span class="Constant">0x7F</span>) &lt;&lt; <span class="Constant">7</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &amp; <span class="Constant">0x80</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 3rd byte */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val |= (c &amp; <span class="Constant">0x7F</span>) &lt;&lt; <span class="Constant">14</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &amp; <span class="Constant">0x80</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 4th byte */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val |= (c &amp; <span class="Constant">0x7F</span>) &lt;&lt; <span class="Constant">21</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &amp; <span class="Constant">0x80</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 5th byte */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val |= (c &amp; <span class="Constant">0x7F</span>) &lt;&lt; <span class="Constant">28</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &amp; <span class="Constant">0x80</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 6th byte */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val |= (c &amp; <span class="Constant">0x7F</span>) &lt;&lt; <span class="Constant">35</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (c &amp; <span class="Constant">0x80</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* 7th byte, should not have continuation <a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c = *(p++);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val |= c &lt;&lt; <span class="Constant">42</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert((c &amp; <span class="Constant">0x80</span>) == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *ptr = p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> val;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Encode a posting list.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The encoded list is returned in a <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d struct, which will be at most<br/></li>
<li></span><span class="Comment"> * 'maxsize' bytes in size.&nbsp; The number items in the returned segment is<br/></li>
<li></span><span class="Comment"> * returned in *nwritten. If it's not <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to nipd, not all the items fit<br/></li>
<li></span><span class="Comment"> * in 'maxsize', and only the first *nwritten were encoded.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The allocated size of the returned struct is short-aligned, and the padding<br/></li>
<li></span><span class="Comment"> * byte at the end, if <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>, is zero.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>GinPostingList *<br/></li>
<li><a id="L197">&#x200c;</a><span class="linkable">ginCompressPostingList</span>(<span class="Type">const</span> ItemPointer ipd, <span class="Type">int</span> nipd, <span class="Type">int</span> maxsize,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> *nwritten)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; prev;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalpacked = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxbytes;<br/></li>
<li>&nbsp; &nbsp; GinPostingList *result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *ptr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *endptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; maxsize = SHORTALIGN_DOWN(maxsize);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(maxsize);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; maxbytes = maxsize - offsetof(GinPostingList, bytes);<br/></li>
<li>&nbsp; &nbsp; Assert(maxbytes &gt; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Store the first special item */<br/></li>
<li></span>&nbsp; &nbsp; result-&gt;first = ipd[<span class="Constant">0</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; prev = <a href="#L87" title="access/gin/ginpostinglist.c:87">itemptr_to_uint64</a>(&amp;result-&gt;first);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ptr = result-&gt;bytes;<br/></li>
<li>&nbsp; &nbsp; endptr = result-&gt;bytes + maxbytes;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (totalpacked = <span class="Constant">1</span>; totalpacked &lt; nipd; totalpacked++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; val = <a href="#L87" title="access/gin/ginpostinglist.c:87">itemptr_to_uint64</a>(&amp;ipd[totalpacked]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; delta = val - prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(val &gt; prev);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (endptr - ptr &gt;= <a href="#L84" title="access/gin/ginpostinglist.c:84">MaxBytesPerInteger</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L115" title="access/gin/ginpostinglist.c:115">encode_varbyte</a>(delta, &amp;ptr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * There are less than 7 bytes left. Have to check if the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * item fits in that space <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> writing it out.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> buf[<a href="#L84" title="access/gin/ginpostinglist.c:84">MaxBytesPerInteger</a>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *p = buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L115" title="access/gin/ginpostinglist.c:115">encode_varbyte</a>(delta, &amp;p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p - buf &gt; (endptr - ptr))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* output is full */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(ptr, buf, p - buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr += (p - buf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; prev = val;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; result-&gt;nbytes = ptr - result-&gt;bytes;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If we wrote an odd number of bytes, zero out the padding byte at the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * end.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (result-&gt;nbytes != SHORTALIGN(result-&gt;nbytes))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;bytes[result-&gt;nbytes] = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nwritten)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nwritten = totalpacked;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(SizeOfGinPostingList(result) &lt;= maxsize);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check that the encoded segment decodes back to the original items.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="PreProc">#if defined (<a href="#L20" title="access/gin/ginpostinglist.c:20">CHECK_ENCODING_ROUNDTRIP</a>)<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndecoded;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ItemPointer tmp = <a href="#L284" title="access/gin/ginpostinglist.c:284">ginPostingListDecode</a>(result, &amp;ndecoded);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(ndecoded == totalpacked);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(memcmp(tmp, ipd, ndecoded * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData)) == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(tmp);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Decode a compressed posting list into an array of item pointers.<br/></li>
<li></span><span class="Comment"> * The number of items is returned in *ndecoded.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>ItemPointer<br/></li>
<li><a id="L284">&#x200c;</a><span class="linkable">ginPostingListDecode</span>(GinPostingList *plist, <span class="Type">int</span> *ndecoded_out)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L297" title="access/gin/ginpostinglist.c:297">ginPostingListDecodeAllSegments</a>(plist,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; SizeOfGinPostingList(plist),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ndecoded_out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Decode multiple posting list segments into an array of item pointers.<br/></li>
<li></span><span class="Comment"> * The number of items is returned in *ndecoded_out. The segments are stored<br/></li>
<li></span><span class="Comment"> * one after each other, with total size 'len' bytes.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>ItemPointer<br/></li>
<li><a id="L297">&#x200c;</a><span class="linkable">ginPostingListDecodeAllSegments</span>(GinPostingList *segment, <span class="Type">int</span> len, <span class="Type">int</span> *ndecoded_out)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ItemPointer result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nallocated;<br/></li>
<li>&nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *endseg = ((<span class="Type">char</span> *) segment) + len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndecoded;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *ptr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *endptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Guess an initial size of the array.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; nallocated = segment-&gt;nbytes * <span class="Constant">2</span> + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; result = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(nallocated * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ndecoded = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((<span class="Type">char</span> *) segment &lt; endseg)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* enlarge output array if needed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ndecoded &gt;= nallocated)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nallocated *= <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = <a href="../../utils/mmgr/mcxt.c.html#L1540" title="utils/mmgr/mcxt.c:1540">repalloc</a>(result, nallocated * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* copy the first item */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(OffsetNumberIsValid(ItemPointerGetOffsetNumber(&amp;segment-&gt;first)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(ndecoded == <span class="Constant">0</span> || ginCompareItemPointers(&amp;segment-&gt;first, &amp;result[ndecoded - <span class="Constant">1</span>]) &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result[ndecoded] = segment-&gt;first;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ndecoded++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; val = <a href="#L87" title="access/gin/ginpostinglist.c:87">itemptr_to_uint64</a>(&amp;segment-&gt;first);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ptr = segment-&gt;bytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; endptr = segment-&gt;bytes + segment-&gt;nbytes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (ptr &lt; endptr)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* enlarge output array if needed */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ndecoded &gt;= nallocated)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nallocated *= <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = <a href="../../utils/mmgr/mcxt.c.html#L1540" title="utils/mmgr/mcxt.c:1540">repalloc</a>(result, nallocated * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val += <a href="#L133" title="access/gin/ginpostinglist.c:133">decode_varbyte</a>(&amp;ptr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L102" title="access/gin/ginpostinglist.c:102">uint64_to_itemptr</a>(val, &amp;result[ndecoded]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndecoded++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; segment = GinNextPostingListSegment(segment);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ndecoded_out)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ndecoded_out = ndecoded;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Add all item pointers from a bunch of posting lists to a <a href="../../nodes/tidbitmap.c.html#L149" title="nodes/tidbitmap.c:149">TIDBitmap</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">int<br/></li>
<li><a id="L358">&#x200c;</a></span><span class="linkable">ginPostingListDecodeAllSegmentsToTbm</span>(GinPostingList *ptr, <span class="Type">int</span> len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../nodes/tidbitmap.c.html#L149" title="nodes/tidbitmap.c:149">TIDBitmap</a> *tbm)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndecoded;<br/></li>
<li>&nbsp; &nbsp; ItemPointer items;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; items = <a href="#L297" title="access/gin/ginpostinglist.c:297">ginPostingListDecodeAllSegments</a>(ptr, len, &amp;ndecoded);<br/></li>
<li>&nbsp; &nbsp; <a href="../../nodes/tidbitmap.c.html#L377" title="nodes/tidbitmap.c:377">tbm_add_tuples</a>(tbm, items, ndecoded, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(items);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ndecoded;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Merge two ordered arrays of itempointers, eliminating <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> duplicates.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Returns a <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d array, and *nmerged is set to the number of items in<br/></li>
<li></span><span class="Comment"> * the result, after eliminating duplicates.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>ItemPointer<br/></li>
<li><a id="L378">&#x200c;</a><span class="linkable">ginMergeItemPointers</span>(ItemPointerData *a, uint32 na,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ItemPointerData *b, uint32 nb,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> *nmerged)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ItemPointerData *dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dst = (ItemPointer) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>((na + nb) * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the argument arrays don't overlap, we can just append them to each<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * other.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (na == <span class="Constant">0</span> || nb == <span class="Constant">0</span> || ginCompareItemPointers(&amp;a[na - <span class="Constant">1</span>], &amp;b[<span class="Constant">0</span>]) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(dst, a, na * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(&amp;dst[na], b, nb * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nmerged = na + nb;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (ginCompareItemPointers(&amp;b[nb - <span class="Constant">1</span>], &amp;a[<span class="Constant">0</span>]) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(dst, b, nb * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(&amp;dst[nb], a, na * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ItemPointerData));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nmerged = na + nb;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ItemPointerData *dptr = dst;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ItemPointerData *aptr = a;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ItemPointerData *bptr = b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (aptr - a &lt; na &amp;&amp; bptr - b &lt; nb)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_locale.c.html#L743" title="regex/regc_locale.c:743">cmp</a> = ginCompareItemPointers(aptr, bptr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../regex/regc_locale.c.html#L743" title="regex/regc_locale.c:743">cmp</a> &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dptr++ = *bptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../regex/regc_locale.c.html#L743" title="regex/regc_locale.c:743">cmp</a> == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* only keep one copy of the identical items */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dptr++ = *bptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dptr++ = *aptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (aptr - a &lt; na)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dptr++ = *aptr++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (bptr - b &lt; nb)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *dptr++ = *bptr++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nmerged = dptr - dst;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dst;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
