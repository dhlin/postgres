<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>access/common/bufmask.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>access/common/bufmask.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L95">mask_lp_flags</a></li>
<li><a href="#L119">mask_page_content</a></li>
<li><a href="#L46">mask_page_hint_bits</a></li>
<li><a href="#L31">mask_page_lsn_and_checksum</a></li>
<li><a href="#L71">mask_unused_space</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * bufmask.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Routines for buffer masking. Used to mask certain bits<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; in a page which can be different when the WAL is generated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; and when the WAL is applied.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 2016-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Contains common routines required for masking a page.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/access/common/bufmask.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/bufmask.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L31" title="access/common/bufmask.c:31">mask_page_lsn_and_checksum</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In consistency checks, the LSN of the two pages compared will likely be<br/></li>
<li></span><span class="Comment"> * different because of concurrent operations when the WAL is generated and<br/></li>
<li></span><span class="Comment"> * the state of the page when WAL is applied. Also, mask out checksum as<br/></li>
<li></span><span class="Comment"> * masking anything else on page means checksum is not going to match as well.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="linkable">mask_page_lsn_and_checksum</span>(Page page)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PageHeader&nbsp; &nbsp; phdr = (PageHeader) page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PageXLogRecPtrSet(phdr-&gt;pd_lsn, (uint64) MASK_MARKER);<br/></li>
<li>&nbsp; &nbsp; phdr-&gt;pd_checksum = MASK_MARKER;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L46" title="access/common/bufmask.c:46">mask_page_hint_bits</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Mask hint bits in PageHeader. We want to ignore differences in hint bits,<br/></li>
<li></span><span class="Comment"> * since they can be set without emitting <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> WAL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L46">&#x200c;</a></span><span class="linkable">mask_page_hint_bits</span>(Page page)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PageHeader&nbsp; &nbsp; phdr = (PageHeader) page;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Ignore prune_xid (it's like a hint-<a href="../../utils/adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a>) */<br/></li>
<li></span>&nbsp; &nbsp; phdr-&gt;pd_prune_xid = MASK_MARKER;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Ignore PD_PAGE_FULL and PD_HAS_FREE_LINES flags, they are just hints. */<br/></li>
<li></span>&nbsp; &nbsp; PageClearFull(page);<br/></li>
<li>&nbsp; &nbsp; PageClearHasFreeLinePointers(page);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * During replay, if the page LSN has advanced past our XLOG record's LSN,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we don't mark the page all-visible. See <a href="../heap/heapam.c.html#L8895" title="access/heap/heapam.c:8895">heap_xlog_visible</a>() for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * details.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PageClearAllVisible(page);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L71" title="access/common/bufmask.c:71">mask_unused_space</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Mask the unused space of a page between pd_lower and pd_upper.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L71">&#x200c;</a></span><span class="linkable">mask_unused_space</span>(Page page)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pd_lower = ((PageHeader) page)-&gt;pd_lower;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pd_upper = ((PageHeader) page)-&gt;pd_upper;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pd_special = ((PageHeader) page)-&gt;pd_special;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Sanity check */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (pd_lower &gt; pd_upper || pd_special &lt; pd_upper ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pd_lower &lt; SizeOfPageHeaderData || pd_special &gt; BLCKSZ)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;invalid page pd_lower </span><span class="Special">%u</span><span class="Constant"> pd_upper </span><span class="Special">%u</span><span class="Constant"> pd_special </span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pd_lower, pd_upper, pd_special);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(page + pd_lower, MASK_MARKER, pd_upper - pd_lower);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L95" title="access/common/bufmask.c:95">mask_lp_flags</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In some index AMs, line pointer flags can be modified on the primary<br/></li>
<li></span><span class="Comment"> * without emitting <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> WAL record.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L95">&#x200c;</a></span><span class="linkable">mask_lp_flags</span>(Page page)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; OffsetNumber offnum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; maxoff;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; maxoff = PageGetMaxOffsetNumber(page);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (offnum = FirstOffsetNumber;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offnum &lt;= maxoff;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; offnum = OffsetNumberNext(offnum))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ItemId&nbsp; &nbsp; &nbsp; &nbsp; itemId = PageGetItemId(page, offnum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ItemIdIsUsed(itemId))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; itemId-&gt;lp_flags = LP_UNUSED;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L119" title="access/common/bufmask.c:119">mask_page_content</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In some index AMs, the contents of deleted pages need to be almost<br/></li>
<li></span><span class="Comment"> * completely ignored.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L119">&#x200c;</a></span><span class="linkable">mask_page_content</span>(Page page)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Mask Page Content */<br/></li>
<li></span>&nbsp; &nbsp; memset(page + SizeOfPageHeaderData, MASK_MARKER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; BLCKSZ - SizeOfPageHeaderData);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Mask pd_lower and pd_upper */<br/></li>
<li></span>&nbsp; &nbsp; memset(&amp;((PageHeader) page)-&gt;pd_lower, MASK_MARKER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(uint16));<br/></li>
<li>&nbsp; &nbsp; memset(&amp;((PageHeader) page)-&gt;pd_upper, MASK_MARKER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(uint16));<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
