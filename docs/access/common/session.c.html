<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>access/common/session.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>access/common/session.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L48">CurrentSession</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L155">AttachSession</a></li>
<li><a href="#L201">DetachSession</a></li>
<li><a href="#L70">GetSessionDsmHandle</a></li>
<li><a href="#L54">InitializeSession</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L39">SESSION_DSA_SIZE</a></li>
<li><a href="#L44">SESSION_KEY_DSA</a></li>
<li><a href="#L45">SESSION_KEY_RECORD_TYPMOD_REGISTRY</a></li>
<li><a href="#L30">SESSION_MAGIC</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * session.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Encapsulation of user session.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is intended to contain data that needs to be shared between backends<br/></li>
<li></span><span class="Comment"> * performing work for a client session.&nbsp; In particular such a session is<br/></li>
<li></span><span class="Comment"> * shared between the leader and worker processes for parallel queries.&nbsp; At<br/></li>
<li></span><span class="Comment"> * some later point it might also become useful infrastructure for separating<br/></li>
<li></span><span class="Comment"> * backends from client connections, e.g. for the purpose of pooling.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Currently this infrastructure is used to share:<br/></li>
<li></span><span class="Comment"> * - typemod registry for ephemeral row-types, i.e. <a href="../../executor/execTuples.c.html#L2158" title="executor/execTuples.c:2158">BlessTupleDesc</a> etc.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 2017-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * src/backend/access/common/session.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/session.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/lwlock.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/<a href="../../storage/ipc/shm_toc.c.html#L26" title="storage/ipc/shm_toc.c:26">shm_toc</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/typcache.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Magic number for per-session DSM TOC. */<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SESSION_MAGIC</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0xabb0fbc9<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * We want to create a DSA area to store shared state that has the same<br/></li>
<li></span><span class="Comment"> * lifetime as a session.&nbsp; So far, it's only used to hold the shared record<br/></li>
<li></span><span class="Comment"> * type registry.&nbsp; We don't want it to have to create <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> DSM segments just<br/></li>
<li></span><span class="Comment"> * yet in common cases, so we'll give it enough space to hold a very small<br/></li>
<li></span><span class="Comment"> * <a href="../../utils/cache/typcache.c.html#L166" title="utils/cache/typcache.c:166">SharedRecordTypmodRegistry</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SESSION_DSA_SIZE</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x30000<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Magic numbers for state sharing in the per-session DSM area.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SESSION_KEY_DSA</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UINT64CONST(</span><span class="Constant">0xFFFFFFFFFFFF0001</span><span class="PreProc">)<br/></li>
<li><a id="L45">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SESSION_KEY_RECORD_TYPMOD_REGISTRY</span>&nbsp; &nbsp; UINT64CONST(</span><span class="Constant">0xFFFFFFFFFFFF0002</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* This backend's current session. */<br/></li>
<li><a id="L48">&#x200c;</a></span>Session&nbsp; &nbsp; *<span class="linkable">CurrentSession</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Set up <a href="#L48" title="access/common/session.c:48">CurrentSession</a> to point to an empty Session object.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L54">&#x200c;</a></span><span class="linkable">InitializeSession</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a> = <a href="../../utils/mmgr/mcxt.c.html#L1214" title="utils/mmgr/mcxt.c:1214">MemoryContextAllocZero</a>(<a href="../../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Session));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize the per-session DSM segment if it isn't already initialized, and<br/></li>
<li></span><span class="Comment"> * return its handle so that worker processes can attach to it.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Unlike the per-context DSM segment, this segment and its contents are<br/></li>
<li></span><span class="Comment"> * reused for future parallel queries.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Return DSM_HANDLE_INVALID if a segment can't be allocated due to lack of<br/></li>
<li></span><span class="Comment"> * resources.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>dsm_handle<br/></li>
<li><a id="L70">&#x200c;</a><span class="linkable">GetSessionDsmHandle</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; shm_toc_estimator estimator;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/ipc/shm_toc.c.html#L26" title="storage/ipc/shm_toc.c:26">shm_toc</a>&nbsp; &nbsp; *toc;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/ipc/dsm.c.html#L66" title="storage/ipc/dsm.c:66">dsm_segment</a> *seg;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; typmod_registry_size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *dsa_space;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *typmod_registry_space;<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/mmgr/dsa.c.html#L347" title="utils/mmgr/dsa.c:347">dsa_area</a>&nbsp;&nbsp; *dsa;<br/></li>
<li>&nbsp; &nbsp; MemoryContext old_context;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If we have already created a session-scope DSM segment in this backend,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * return its handle.&nbsp; The same segment will be used for the rest of this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * backend's lifetime.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;segment != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../../storage/ipc/dsm.c.html#L1123" title="storage/ipc/dsm.c:1123">dsm_segment_handle</a>(<a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;segment);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Otherwise, prepare to set one up. */<br/></li>
<li></span>&nbsp; &nbsp; old_context = MemoryContextSwitchTo(<a href="../../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>);<br/></li>
<li>&nbsp; &nbsp; shm_toc_initialize_estimator(&amp;estimator);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Estimate space for the per-session DSA area. */<br/></li>
<li></span>&nbsp; &nbsp; shm_toc_estimate_keys(&amp;estimator, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; shm_toc_estimate_chunk(&amp;estimator, <a href="#L39" title="access/common/session.c:39">SESSION_DSA_SIZE</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Estimate space for the per-session record typmod registry. */<br/></li>
<li></span>&nbsp; &nbsp; typmod_registry_size = <a href="../../utils/cache/typcache.c.html#L2086" title="utils/cache/typcache.c:2086">SharedRecordTypmodRegistryEstimate</a>();<br/></li>
<li>&nbsp; &nbsp; shm_toc_estimate_keys(&amp;estimator, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; shm_toc_estimate_chunk(&amp;estimator, typmod_registry_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set up segment and TOC. */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shm_toc.c.html#L263" title="storage/ipc/shm_toc.c:263">shm_toc_estimate</a>(&amp;estimator);<br/></li>
<li>&nbsp; &nbsp; seg = <a href="../../storage/ipc/dsm.c.html#L516" title="storage/ipc/dsm.c:516">dsm_create</a>(size, DSM_CREATE_NULL_IF_MAXSEGMENTS);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (seg == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(old_context);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> DSM_HANDLE_INVALID;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; toc = <a href="../../storage/ipc/shm_toc.c.html#L40" title="storage/ipc/shm_toc.c:40">shm_toc_create</a>(<a href="#L30" title="access/common/session.c:30">SESSION_MAGIC</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../storage/ipc/dsm.c.html#L1095" title="storage/ipc/dsm.c:1095">dsm_segment_address</a>(seg),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create per-session DSA area. */<br/></li>
<li></span>&nbsp; &nbsp; dsa_space = <a href="../../storage/ipc/shm_toc.c.html#L88" title="storage/ipc/shm_toc.c:88">shm_toc_allocate</a>(toc, <a href="#L39" title="access/common/session.c:39">SESSION_DSA_SIZE</a>);<br/></li>
<li>&nbsp; &nbsp; dsa = dsa_create_in_place(dsa_space,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="access/common/session.c:39">SESSION_DSA_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LWTRANCHE_PER_SESSION_DSA,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; seg);<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/ipc/shm_toc.c.html#L171" title="storage/ipc/shm_toc.c:171">shm_toc_insert</a>(toc, <a href="#L44" title="access/common/session.c:44">SESSION_KEY_DSA</a>, dsa_space);<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create session-scoped shared record typmod registry. */<br/></li>
<li></span>&nbsp; &nbsp; typmod_registry_space = <a href="../../storage/ipc/shm_toc.c.html#L88" title="storage/ipc/shm_toc.c:88">shm_toc_allocate</a>(toc, typmod_registry_size);<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/cache/typcache.c.html#L2108" title="utils/cache/typcache.c:2108">SharedRecordTypmodRegistryInit</a>((<a href="../../utils/cache/typcache.c.html#L166" title="utils/cache/typcache.c:166">SharedRecordTypmodRegistry</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; typmod_registry_space, seg, dsa);<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/ipc/shm_toc.c.html#L171" title="storage/ipc/shm_toc.c:171">shm_toc_insert</a>(toc, <a href="#L45" title="access/common/session.c:45">SESSION_KEY_RECORD_TYPMOD_REGISTRY</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; typmod_registry_space);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If we got this far, we can pin the shared memory so it stays mapped for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the rest of this backend's life.&nbsp; If we don't make it this far, <a href="../../regex/regc_nfa.c.html#L2929" title="regex/regc_nfa.c:2929">cleanup</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * callbacks for anything we installed above (ie currently<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../utils/cache/typcache.c.html#L166" title="utils/cache/typcache.c:166">SharedRecordTypmodRegistry</a>) will run when the DSM segment is detached<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * by <a href="../../utils/resowner/resowner.c.html#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> so we aren't left with a broken <a href="#L48" title="access/common/session.c:48">CurrentSession</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/ipc/dsm.c.html#L915" title="storage/ipc/dsm.c:915">dsm_pin_mapping</a>(seg);<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/mmgr/dsa.c.html#L635" title="utils/mmgr/dsa.c:635">dsa_pin_mapping</a>(dsa);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Make segment and area available via <a href="#L48" title="access/common/session.c:48">CurrentSession</a>. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;segment = seg;<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;area = dsa;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; MemoryContextSwitchTo(old_context);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../storage/ipc/dsm.c.html#L1123" title="storage/ipc/dsm.c:1123">dsm_segment_handle</a>(seg);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Attach to a per-session DSM segment provided by a parallel leader.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L155">&#x200c;</a></span><span class="linkable">AttachSession</span>(dsm_handle handle)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/ipc/dsm.c.html#L66" title="storage/ipc/dsm.c:66">dsm_segment</a> *seg;<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/ipc/shm_toc.c.html#L26" title="storage/ipc/shm_toc.c:26">shm_toc</a>&nbsp; &nbsp; *toc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *dsa_space;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *typmod_registry_space;<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/mmgr/dsa.c.html#L347" title="utils/mmgr/dsa.c:347">dsa_area</a>&nbsp;&nbsp; *dsa;<br/></li>
<li>&nbsp; &nbsp; MemoryContext old_context;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; old_context = MemoryContextSwitchTo(<a href="../../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Attach to the DSM segment. */<br/></li>
<li></span>&nbsp; &nbsp; seg = <a href="../../storage/ipc/dsm.c.html#L665" title="storage/ipc/dsm.c:665">dsm_attach</a>(handle);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (seg == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not attach to per-session DSM segment&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; toc = <a href="../../storage/ipc/shm_toc.c.html#L64" title="storage/ipc/shm_toc.c:64">shm_toc_attach</a>(<a href="#L30" title="access/common/session.c:30">SESSION_MAGIC</a>, <a href="../../storage/ipc/dsm.c.html#L1095" title="storage/ipc/dsm.c:1095">dsm_segment_address</a>(seg));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Attach to the DSA area. */<br/></li>
<li></span>&nbsp; &nbsp; dsa_space = <a href="../../storage/ipc/shm_toc.c.html#L232" title="storage/ipc/shm_toc.c:232">shm_toc_lookup</a>(toc, <a href="#L44" title="access/common/session.c:44">SESSION_KEY_DSA</a>, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; dsa = <a href="../../utils/mmgr/dsa.c.html#L545" title="utils/mmgr/dsa.c:545">dsa_attach_in_place</a>(dsa_space, seg);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Make them available via the current session. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;segment = seg;<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;area = dsa;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Attach to the shared record typmod registry. */<br/></li>
<li></span>&nbsp; &nbsp; typmod_registry_space =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shm_toc.c.html#L232" title="storage/ipc/shm_toc.c:232">shm_toc_lookup</a>(toc, <a href="#L45" title="access/common/session.c:45">SESSION_KEY_RECORD_TYPMOD_REGISTRY</a>, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/cache/typcache.c.html#L2207" title="utils/cache/typcache.c:2207">SharedRecordTypmodRegistryAttach</a>((<a href="../../utils/cache/typcache.c.html#L166" title="utils/cache/typcache.c:166">SharedRecordTypmodRegistry</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; typmod_registry_space);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Remain attached until end of backend or <a href="#L201" title="access/common/session.c:201">DetachSession</a>(). */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/ipc/dsm.c.html#L915" title="storage/ipc/dsm.c:915">dsm_pin_mapping</a>(seg);<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/mmgr/dsa.c.html#L635" title="utils/mmgr/dsa.c:635">dsa_pin_mapping</a>(dsa);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; MemoryContextSwitchTo(old_context);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Detach from the current session DSM segment.&nbsp; It's not strictly necessary<br/></li>
<li></span><span class="Comment"> * to do this explicitly since we'll detach automatically at backend exit, but<br/></li>
<li></span><span class="Comment"> * if we ever reuse parallel workers it will become important for workers to<br/></li>
<li></span><span class="Comment"> * detach from one session <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> attaching to another.&nbsp; Note that this runs<br/></li>
<li></span><span class="Comment"> * detach hooks.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L201">&#x200c;</a></span><span class="linkable">DetachSession</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Runs detach hooks. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/ipc/dsm.c.html#L803" title="storage/ipc/dsm.c:803">dsm_detach</a>(<a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;segment);<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;segment = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../../utils/mmgr/dsa.c.html#L1952" title="utils/mmgr/dsa.c:1952">dsa_detach</a>(<a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;area);<br/></li>
<li>&nbsp; &nbsp; <a href="#L48" title="access/common/session.c:48">CurrentSession</a>-&gt;area = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
