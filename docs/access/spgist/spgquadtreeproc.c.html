<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>access/spgist/spgquadtreeproc.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>access/spgist/spgquadtreeproc.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L55">getQuadrant</a></li>
<li><a href="#L83">getQuadrantArea</a></li>
<li><a href="#L115">spg_quad_choose</a></li>
<li><a href="#L27">spg_quad_config</a></li>
<li><a href="#L227">spg_quad_inner_consistent</a></li>
<li><a href="#L407">spg_quad_leaf_consistent</a></li>
<li><a href="#L169">spg_quad_picksplit</a></li>
<li><a href="#L146">x_cmp</a></li>
<li><a href="#L157">y_cmp</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L39">SPTEST</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * spgquadtreeproc.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; implementation of quad tree over points for SP-GiST<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src/backend/access/spgist/spgquadtreeproc.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/spgist.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/spgist_private.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/stratnum.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_type.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/float.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/fmgrprotos.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/geo_decls.h&quot;<br/></li>
<li></span><br/></li>
<li>Datum<br/></li>
<li><a id="L27">&#x200c;</a><span class="linkable">spg_quad_config</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* spgConfigIn *cfgin = (spgConfigIn *) PG_GETARG_POINTER(0); */<br/></li>
<li></span>&nbsp; &nbsp; spgConfigOut *cfg = (spgConfigOut *) PG_GETARG_POINTER(<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; cfg-&gt;prefixType = POINTOID;<br/></li>
<li>&nbsp; &nbsp; cfg-&gt;labelType = VOIDOID;&nbsp; &nbsp; <span class="Comment">/* we don't need node labels */<br/></li>
<li></span>&nbsp; &nbsp; cfg-&gt;canReturnData = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; cfg-&gt;longValuesOK = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L39">&#x200c;</a><span class="PreProc">#define <span class="linkable">SPTEST</span>(f, x, y) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; DatumGetBool(DirectFunctionCall2(f, PointPGetDatum(x), PointPGetDatum(y)))<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Determine which quadrant a point falls into, relative to the centroid.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Quadrants are identified like this:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp;&nbsp; 4&nbsp; &nbsp; |&nbsp; 1<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; ----+-----<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp;&nbsp; 3&nbsp; &nbsp; |&nbsp; 2<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Points on one of the axes are taken to lie in the lowest-numbered<br/></li>
<li></span><span class="Comment"> * adjacent quadrant.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int16<br/></li>
<li><a id="L55">&#x200c;</a><span class="linkable">getQuadrant</span>(Point *centroid, Point *tst)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1919" title="utils/adt/geo_ops.c:1919">point_above</a>, tst, centroid) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1946" title="utils/adt/geo_ops.c:1946">point_horiz</a>, tst, centroid)) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1910" title="utils/adt/geo_ops.c:1910">point_right</a>, tst, centroid) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1937" title="utils/adt/geo_ops.c:1937">point_vert</a>, tst, centroid)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1928" title="utils/adt/geo_ops.c:1928">point_below</a>, tst, centroid) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1910" title="utils/adt/geo_ops.c:1910">point_right</a>, tst, centroid) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1937" title="utils/adt/geo_ops.c:1937">point_vert</a>, tst, centroid)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1928" title="utils/adt/geo_ops.c:1928">point_below</a>, tst, centroid) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1946" title="utils/adt/geo_ops.c:1946">point_horiz</a>, tst, centroid)) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1901" title="utils/adt/geo_ops.c:1901">point_left</a>, tst, centroid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">3</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1919" title="utils/adt/geo_ops.c:1919">point_above</a>, tst, centroid) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1901" title="utils/adt/geo_ops.c:1901">point_left</a>, tst, centroid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">4</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>: impossible case&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Returns bounding box of a given quadrant inside given bounding box */<br/></li>
<li></span><span class="Type">static</span> BOX *<br/></li>
<li><a id="L83">&#x200c;</a><span class="linkable">getQuadrantArea</span>(BOX *bbox, Point *centroid, <span class="Type">int</span> quadrant)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; BOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *result = (BOX *) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(BOX));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (quadrant)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">1</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;high = bbox-&gt;high;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;low = *centroid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">2</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;high.x = bbox-&gt;high.x;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;high.y = centroid-&gt;y;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;low.x = centroid-&gt;x;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;low.y = bbox-&gt;low.y;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">3</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;high = *centroid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;low = bbox-&gt;low;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">4</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;high.x = centroid-&gt;x;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;high.y = bbox-&gt;high.y;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;low.x = bbox-&gt;low.x;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;low.y = centroid-&gt;y;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L115">&#x200c;</a><span class="linkable">spg_quad_choose</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; spgChooseIn *in = (spgChooseIn *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; spgChooseOut *out = (spgChooseOut *) PG_GETARG_POINTER(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *inPoint = DatumGetPointP(in-&gt;datum),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *centroid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;allTheSame)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;resultType = spgMatchNode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* nodeN will be set by core */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;result.matchNode.levelAdd = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;result.matchNode.restDatum = PointPGetDatum(inPoint);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(in-&gt;hasPrefix);<br/></li>
<li>&nbsp; &nbsp; centroid = DatumGetPointP(in-&gt;prefixDatum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(in-&gt;nNodes == <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out-&gt;resultType = spgMatchNode;<br/></li>
<li>&nbsp; &nbsp; out-&gt;result.matchNode.nodeN = <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, inPoint) - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; out-&gt;result.matchNode.levelAdd = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; out-&gt;result.matchNode.restDatum = PointPGetDatum(inPoint);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_MEDIAN<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L146">&#x200c;</a></span><span class="linkable">x_cmp</span>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *pa = *(Point **) a;<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *pb = *(Point **) b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pa-&gt;x == pb-&gt;x)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (pa-&gt;x &gt; pb-&gt;x) ? <span class="Constant">1</span> : -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L157">&#x200c;</a></span><span class="linkable">y_cmp</span>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *pa = *(Point **) a;<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *pb = *(Point **) b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pa-&gt;y == pb-&gt;y)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (pa-&gt;y &gt; pb-&gt;y) ? <span class="Constant">1</span> : -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>Datum<br/></li>
<li><a id="L169">&#x200c;</a><span class="linkable">spg_quad_picksplit</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; spgPickSplitIn *in = (spgPickSplitIn *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; spgPickSplitOut *out = (spgPickSplitOut *) PG_GETARG_POINTER(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *centroid;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_MEDIAN<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Use the median <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> of x and y as the centroid point */<br/></li>
<li></span>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp; **sorted;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sorted = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(*sorted) * in-&gt;nTuples);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; in-&gt;nTuples; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sorted[i] = DatumGetPointP(in-&gt;datums[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; centroid = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(*centroid));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qsort(sorted, in-&gt;nTuples, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(*sorted), <a href="spgkdtreeproc.c.html#L85" title="access/spgist/spgkdtreeproc.c:85">x_cmp</a>);<br/></li>
<li>&nbsp; &nbsp; centroid-&gt;x = sorted[in-&gt;nTuples &gt;&gt; <span class="Constant">1</span>]-&gt;x;<br/></li>
<li>&nbsp; &nbsp; qsort(sorted, in-&gt;nTuples, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(*sorted), <a href="spgkdtreeproc.c.html#L96" title="access/spgist/spgkdtreeproc.c:96">y_cmp</a>);<br/></li>
<li>&nbsp; &nbsp; centroid-&gt;y = sorted[in-&gt;nTuples &gt;&gt; <span class="Constant">1</span>]-&gt;y;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Use the average <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> of x and y as the centroid point */<br/></li>
<li></span>&nbsp; &nbsp; centroid = <a href="../../utils/mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(*centroid));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; in-&gt;nTuples; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; centroid-&gt;x += DatumGetPointP(in-&gt;datums[i])-&gt;x;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; centroid-&gt;y += DatumGetPointP(in-&gt;datums[i])-&gt;y;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; centroid-&gt;x /= in-&gt;nTuples;<br/></li>
<li>&nbsp; &nbsp; centroid-&gt;y /= in-&gt;nTuples;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; out-&gt;hasPrefix = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; out-&gt;prefixDatum = PointPGetDatum(centroid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out-&gt;nNodes = <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; out-&gt;nodeLabels = <span class="Constant">NULL</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we don't need node labels */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; out-&gt;mapTuplesToNodes = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">int</span>) * in-&gt;nTuples);<br/></li>
<li>&nbsp; &nbsp; out-&gt;leafTupleDatums = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Datum) * in-&gt;nTuples);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; in-&gt;nTuples; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *p = DatumGetPointP(in-&gt;datums[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; quadrant = <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, p) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;leafTupleDatums[i] = PointPGetDatum(p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;mapTuplesToNodes[i] = quadrant;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L227">&#x200c;</a><span class="linkable">spg_quad_inner_consistent</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; spgInnerConsistentIn *in = (spgInnerConsistentIn *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; spgInnerConsistentOut *out = (spgInnerConsistentOut *) PG_GETARG_POINTER(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *centroid;<br/></li>
<li>&nbsp; &nbsp; BOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; infbbox;<br/></li>
<li>&nbsp; &nbsp; BOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *bbox = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(in-&gt;hasPrefix);<br/></li>
<li>&nbsp; &nbsp; centroid = DatumGetPointP(in-&gt;prefixDatum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * When ordering scan keys are specified, we've to calculate distance for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * them.&nbsp; In order to do that, we need calculate bounding boxes for all<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * children nodes.&nbsp; Calculation of those bounding boxes on non-zero level<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * require knowledge of bounding box of <a href="../../utils/adt/oracle_compat.c.html#L80" title="utils/adt/oracle_compat.c:80">upper</a> node.&nbsp; So, we save bounding<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * boxes to traversalValues.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;norderbys &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;distances = (<span class="Type">double</span> **) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">double</span> *) * in-&gt;nNodes);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;traversalValues = (<span class="Type">void</span> **) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">void</span> *) * in-&gt;nNodes);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;level == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; inf = get_float8_infinity();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; infbbox.high.x = inf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; infbbox.high.y = inf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; infbbox.low.x = -inf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; infbbox.low.y = -inf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bbox = &amp;infbbox;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bbox = in-&gt;traversalValue;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(bbox);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;allTheSame)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Report that all nodes should be visited */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;nNodes = in-&gt;nNodes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;nodeNumbers = (<span class="Type">int</span> *) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">int</span>) * in-&gt;nNodes);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; in-&gt;nNodes; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;nodeNumbers[i] = i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;norderbys &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContext oldCtx = MemoryContextSwitchTo(in-&gt;traversalMemoryContext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Use parent quadrant box as traversalValue */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *quadrant = <a href="spgproc.c.html#L82" title="access/spgist/spgproc.c:82">box_copy</a>(bbox);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(oldCtx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;traversalValues[i] = quadrant;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;distances[i] = <a href="spgproc.c.html#L63" title="access/spgist/spgproc.c:63">spg_key_orderbys_distances</a>(BoxPGetDatum(quadrant), <span class="Constant">false</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in-&gt;orderbys, in-&gt;norderbys);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(in-&gt;nNodes == <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* &quot;which&quot; is a bitmask of quadrants that satisfy all constraints */<br/></li>
<li></span>&nbsp; &nbsp; which = (<span class="Constant">1</span> &lt;&lt; <span class="Constant">1</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">2</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">3</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">4</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; in-&gt;nkeys; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *query = DatumGetPointP(in-&gt;scankeys[i].sk_argument);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; BOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *boxQuery;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (in-&gt;scankeys[i].sk_strategy)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTLeftStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1910" title="utils/adt/geo_ops.c:1910">point_right</a>, centroid, query))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &amp;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">3</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTRightStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1901" title="utils/adt/geo_ops.c:1901">point_left</a>, centroid, query))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &amp;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">1</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTSameStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &amp;= (<span class="Constant">1</span> &lt;&lt; <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, query));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTBelowStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTOldBelowStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1919" title="utils/adt/geo_ops.c:1919">point_above</a>, centroid, query))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &amp;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">2</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTAboveStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTOldAboveStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1928" title="utils/adt/geo_ops.c:1928">point_below</a>, centroid, query))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &amp;= (<span class="Constant">1</span> &lt;&lt; <span class="Constant">1</span>) | (<span class="Constant">1</span> &lt;&lt; <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTContainedByStrategyNumber:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * For this operator, the query is a box not a point.&nbsp; We<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * cheat to the extent of assuming that DatumGetPointP won't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * do anything that would be bad for a pointer-to-box.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; boxQuery = DatumGetBoxP(in-&gt;scankeys[i].sk_argument);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (DatumGetBool(DirectFunctionCall2(<a href="../../utils/adt/geo_ops.c.html#L3146" title="utils/adt/geo_ops.c:3146">box_contain_pt</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PointerGetDatum(boxQuery),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PointerGetDatum(centroid))))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* centroid is in box, so all quadrants are OK */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* identify quadrant(s) containing all corners of box */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp; &nbsp; p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = boxQuery-&gt;low;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r |= <span class="Constant">1</span> &lt;&lt; <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, &amp;p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.y = boxQuery-&gt;high.y;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r |= <span class="Constant">1</span> &lt;&lt; <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, &amp;p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = boxQuery-&gt;high;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r |= <span class="Constant">1</span> &lt;&lt; <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, &amp;p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p.x = boxQuery-&gt;low.x;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; r |= <span class="Constant">1</span> &lt;&lt; <a href="#L55" title="access/spgist/spgquadtreeproc.c:55">getQuadrant</a>(centroid, &amp;p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &amp;= r;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized strategy number: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in-&gt;scankeys[i].sk_strategy);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (which == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no need to consider remaining conditions */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out-&gt;levelAdds = <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">int</span>) * <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <span class="Constant">4</span>; ++i)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;levelAdds[i] = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We must descend into the quadrant(s) identified by which */<br/></li>
<li></span>&nbsp; &nbsp; out-&gt;nodeNumbers = (<span class="Type">int</span> *) <a href="../../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">int</span>) * <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; out-&gt;nNodes = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt;= <span class="Constant">4</span>; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (which &amp; (<span class="Constant">1</span> &lt;&lt; i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;nodeNumbers[out-&gt;nNodes] = i - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in-&gt;norderbys &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContext oldCtx = MemoryContextSwitchTo(in-&gt;traversalMemoryContext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *quadrant = <a href="#L83" title="access/spgist/spgquadtreeproc.c:83">getQuadrantArea</a>(bbox, centroid, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(oldCtx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;traversalValues[out-&gt;nNodes] = quadrant;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;distances[out-&gt;nNodes] = <a href="spgproc.c.html#L63" title="access/spgist/spgproc.c:63">spg_key_orderbys_distances</a>(BoxPGetDatum(quadrant), <span class="Constant">false</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in-&gt;orderbys, in-&gt;norderbys);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out-&gt;nNodes++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L407">&#x200c;</a><span class="linkable">spg_quad_leaf_consistent</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; spgLeafConsistentIn *in = (spgLeafConsistentIn *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; spgLeafConsistentOut *out = (spgLeafConsistentOut *) PG_GETARG_POINTER(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *datum = DatumGetPointP(in-&gt;leafDatum);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* all tests are exact */<br/></li>
<li></span>&nbsp; &nbsp; out-&gt;recheck = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* leafDatum is what it is... */<br/></li>
<li></span>&nbsp; &nbsp; out-&gt;leafValue = in-&gt;leafDatum;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Perform the required comparison(s) */<br/></li>
<li></span>&nbsp; &nbsp; res = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; in-&gt;nkeys; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Point&nbsp; &nbsp; &nbsp;&nbsp; *query = DatumGetPointP(in-&gt;scankeys[i].sk_argument);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (in-&gt;scankeys[i].sk_strategy)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTLeftStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1901" title="utils/adt/geo_ops.c:1901">point_left</a>, datum, query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTRightStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1910" title="utils/adt/geo_ops.c:1910">point_right</a>, datum, query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTSameStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1955" title="utils/adt/geo_ops.c:1955">point_eq</a>, datum, query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTBelowStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTOldBelowStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1928" title="utils/adt/geo_ops.c:1928">point_below</a>, datum, query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTAboveStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTOldAboveStrategyNumber:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L1919" title="utils/adt/geo_ops.c:1919">point_above</a>, datum, query);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RTContainedByStrategyNumber:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * For this operator, the query is a box not a point.&nbsp; We<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * cheat to the extent of assuming that DatumGetPointP won't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * do anything that would be bad for a pointer-to-box.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = <a href="#L39" title="access/spgist/spgquadtreeproc.c:39">SPTEST</a>(<a href="../../utils/adt/geo_ops.c.html#L3146" title="utils/adt/geo_ops.c:3146">box_contain_pt</a>, query, datum);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized strategy number: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in-&gt;scankeys[i].sk_strategy);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!res)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (res &amp;&amp; in-&gt;norderbys &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ok, it passes -&gt; let's compute the distances */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; out-&gt;distances = <a href="spgproc.c.html#L63" title="access/spgist/spgproc.c:63">spg_key_orderbys_distances</a>(in-&gt;leafDatum, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in-&gt;orderbys, in-&gt;norderbys);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(res);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
