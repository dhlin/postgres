<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/misc/injection_point.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/misc/injection_point.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L67">InjectionPointCache</a></li>
<li><a href="#L39">InjectionPointHash</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L61">InjectionPointCacheEntry</a></li>
<li><a href="#L65">InjectionPointCacheEntry</a></li>
<li><a href="#L47">InjectionPointEntry</a></li>
<li><a href="#L52">InjectionPointEntry</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L187">InjectionPointAttach</a></li>
<li><a href="#L238">InjectionPointDetach</a></li>
<li><a href="#L262">InjectionPointRun</a></li>
<li><a href="#L167">InjectionPointShmemInit</a></li>
<li><a href="#L150">InjectionPointShmemSize</a></li>
<li><a href="#L75">injection_point_cache_add</a></li>
<li><a href="#L127">injection_point_cache_get</a></li>
<li><a href="#L112">injection_point_cache_remove</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L54">INJECTION_POINT_HASH_INIT_SIZE</a></li>
<li><a href="#L55">INJECTION_POINT_HASH_MAX_SIZE</a></li>
<li><a href="#L44">INJ_FUNC_MAXLEN</a></li>
<li><a href="#L43">INJ_LIB_MAXLEN</a></li>
<li><a href="#L42">INJ_NAME_MAXLEN</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * injection_point.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Routines to control and run injection points in the code.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Injection points can be used to run arbitrary code by attaching callbacks<br/></li>
<li></span><span class="Comment"> * that would be executed in place of the named injection point.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/misc/injection_point.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;sys/stat.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;fmgr.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;port/pg_bitutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/lwlock.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/shmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/hsearch.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/injection_point.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef USE_INJECTION_POINTS<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Hash table for storing injection points.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L39" title="utils/misc/injection_point.c:39">InjectionPointHash</a> is used to <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> an injection point by name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L39">&#x200c;</a></span><span class="Type">static</span> <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a> *<span class="linkable">InjectionPointHash</span>;&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> points from names */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Field sizes */<br/></li>
<li><a id="L42">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">INJ_NAME_MAXLEN</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">64<br/></li>
<li><a id="L43">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">INJ_LIB_MAXLEN</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">128<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">INJ_FUNC_MAXLEN</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">128<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Single injection point stored in <a href="#L39" title="utils/misc/injection_point.c:39">InjectionPointHash</a> */<br/></li>
<li><a id="L47">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">InjectionPointEntry</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; name[<a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a>];&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> key */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; library[<a href="#L43" title="utils/misc/injection_point.c:43">INJ_LIB_MAXLEN</a>];&nbsp; &nbsp; <span class="Comment">/* library */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; function[<a href="#L44" title="utils/misc/injection_point.c:44">INJ_FUNC_MAXLEN</a>];&nbsp; &nbsp; <span class="Comment">/* function */<br/></li>
<li><a id="L52">&#x200c;</a></span>} <span class="linkable">InjectionPointEntry</span>;<br/></li>
<li><br/></li>
<li><a id="L54">&#x200c;</a><span class="PreProc">#define <span class="linkable">INJECTION_POINT_HASH_INIT_SIZE</span>&nbsp; &nbsp; </span><span class="Constant">16<br/></li>
<li><a id="L55">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">INJECTION_POINT_HASH_MAX_SIZE</span>&nbsp; &nbsp; </span><span class="Constant">128<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> local cache of injection callbacks already loaded, stored in<br/></li>
<li></span><span class="Comment"> * <a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L61">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">InjectionPointCacheEntry</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; name[<a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a>];<br/></li>
<li>&nbsp; &nbsp; InjectionPointCallback callback;<br/></li>
<li><a id="L65">&#x200c;</a>} <span class="linkable">InjectionPointCacheEntry</span>;<br/></li>
<li><br/></li>
<li><a id="L67">&#x200c;</a><span class="Type">static</span> <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a> *<span class="linkable">InjectionPointCache</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L75" title="utils/misc/injection_point.c:75">injection_point_cache_add</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Add an injection point to the local cache.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L75">&#x200c;</a></span><span class="linkable">injection_point_cache_add</span>(<span class="Type">const</span> <span class="Type">char</span> *name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InjectionPointCallback callback)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L61" title="utils/misc/injection_point.c:61">InjectionPointCacheEntry</a> *entry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If first time, <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; HASHCTL&nbsp; &nbsp; &nbsp; &nbsp; hash_ctl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash_ctl.keysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">char</span>[<a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash_ctl.entrysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L61" title="utils/misc/injection_point.c:61">InjectionPointCacheEntry</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hash_ctl.hcxt = <a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a> = <a href="../hash/dynahash.c.html#L352" title="utils/hash/dynahash.c:352">hash_create</a>(<span class="Constant">&quot;InjectionPoint cache <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L55" title="utils/misc/injection_point.c:55">INJECTION_POINT_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;hash_ctl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_ELEM | HASH_STRINGS | HASH_CONTEXT);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L61" title="utils/misc/injection_point.c:61">InjectionPointCacheEntry</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a>, name, HASH_ENTER, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(!found);<br/></li>
<li>&nbsp; &nbsp; strlcpy(entry-&gt;name, name, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(entry-&gt;name));<br/></li>
<li>&nbsp; &nbsp; entry-&gt;callback = callback;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L112" title="utils/misc/injection_point.c:112">injection_point_cache_remove</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Remove entry from the local cache.&nbsp; Note that this leaks a callback<br/></li>
<li></span><span class="Comment"> * loaded but removed later on, which should have no consequence from<br/></li>
<li></span><span class="Comment"> * a testing perspective.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L112">&#x200c;</a></span><span class="linkable">injection_point_cache_remove</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* leave if no cache */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a>, name, HASH_REMOVE, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L127" title="utils/misc/injection_point.c:127">injection_point_cache_get</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Retrieve an injection point from the local cache, if <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> InjectionPointCallback<br/></li>
<li><a id="L127">&#x200c;</a><span class="linkable">injection_point_cache_get</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; <a href="#L61" title="utils/misc/injection_point.c:61">InjectionPointCacheEntry</a> *entry;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* no callback if no cache yet */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L61" title="utils/misc/injection_point.c:61">InjectionPointCacheEntry</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L67" title="utils/misc/injection_point.c:67">InjectionPointCache</a>, name, HASH_FIND, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> entry-&gt;callback;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* USE_INJECTION_POINTS */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Return the space for dynamic shared <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L150">&#x200c;</a><span class="linkable">InjectionPointShmemSize</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_INJECTION_POINTS<br/></li>
<li></span>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; sz = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sz = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(sz, <a href="../hash/dynahash.c.html#L783" title="utils/hash/dynahash.c:783">hash_estimate_size</a>(<a href="#L55" title="utils/misc/injection_point.c:55">INJECTION_POINT_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L47" title="utils/misc/injection_point.c:47">InjectionPointEntry</a>)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> sz;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Allocate shmem space for dynamic shared <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L167">&#x200c;</a></span><span class="linkable">InjectionPointShmemInit</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_INJECTION_POINTS<br/></li>
<li></span>&nbsp; &nbsp; HASHCTL&nbsp; &nbsp; &nbsp; &nbsp; info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* key is a NULL-terminated string */<br/></li>
<li></span>&nbsp; &nbsp; info.keysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">char</span>[<a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a>]);<br/></li>
<li>&nbsp; &nbsp; info.entrysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L47" title="utils/misc/injection_point.c:47">InjectionPointEntry</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L39" title="utils/misc/injection_point.c:39">InjectionPointHash</a> = <a href="../../storage/ipc/shmem.c.html#L332" title="storage/ipc/shmem.c:332">ShmemInitHash</a>(<span class="Constant">&quot;InjectionPoint <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L54" title="utils/misc/injection_point.c:54">INJECTION_POINT_HASH_INIT_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L55" title="utils/misc/injection_point.c:55">INJECTION_POINT_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;info,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HASH_ELEM | HASH_FIXED_SIZE | HASH_STRINGS);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Attach a new injection point.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L187">&#x200c;</a></span><span class="linkable">InjectionPointAttach</span>(<span class="Type">const</span> <span class="Type">char</span> *name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *library,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type">char</span> *function)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_INJECTION_POINTS<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L47" title="utils/misc/injection_point.c:47">InjectionPointEntry</a> *entry_by_name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strlen(name) &gt;= <a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;injection point name </span><span class="Special">%s</span><span class="Constant"> too long (maximum of </span><span class="Special">%u</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; name, <a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strlen(library) &gt;= <a href="#L43" title="utils/misc/injection_point.c:43">INJ_LIB_MAXLEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;injection point library </span><span class="Special">%s</span><span class="Constant"> too long (maximum of </span><span class="Special">%u</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; library, <a href="#L43" title="utils/misc/injection_point.c:43">INJ_LIB_MAXLEN</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strlen(function) &gt;= <a href="#L44" title="utils/misc/injection_point.c:44">INJ_FUNC_MAXLEN</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;injection point function </span><span class="Special">%s</span><span class="Constant"> too long (maximum of </span><span class="Special">%u</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function, <a href="#L44" title="utils/misc/injection_point.c:44">INJ_FUNC_MAXLEN</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Allocate and register a new injection point.&nbsp; A new point should not<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * exist.&nbsp; For testing purposes this should be fine.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(InjectionPointLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; entry_by_name = (<a href="#L47" title="utils/misc/injection_point.c:47">InjectionPointEntry</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L39" title="utils/misc/injection_point.c:39">InjectionPointHash</a>, name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_ENTER, &amp;found);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(InjectionPointLock);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;injection point </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> already defined&quot;</span>, name);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Save the entry */<br/></li>
<li></span>&nbsp; &nbsp; strlcpy(entry_by_name-&gt;name, name, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(entry_by_name-&gt;name));<br/></li>
<li>&nbsp; &nbsp; entry_by_name-&gt;name[<a href="#L42" title="utils/misc/injection_point.c:42">INJ_NAME_MAXLEN</a> - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; strlcpy(entry_by_name-&gt;library, library, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(entry_by_name-&gt;library));<br/></li>
<li>&nbsp; &nbsp; entry_by_name-&gt;library[<a href="#L43" title="utils/misc/injection_point.c:43">INJ_LIB_MAXLEN</a> - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; strlcpy(entry_by_name-&gt;function, function, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(entry_by_name-&gt;function));<br/></li>
<li>&nbsp; &nbsp; entry_by_name-&gt;function[<a href="#L44" title="utils/misc/injection_point.c:44">INJ_FUNC_MAXLEN</a> - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(InjectionPointLock);<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;injection points are not supported by this build&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Detach an existing injection point.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L238">&#x200c;</a></span><span class="linkable">InjectionPointDetach</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_INJECTION_POINTS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(InjectionPointLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L39" title="utils/misc/injection_point.c:39">InjectionPointHash</a>, name, HASH_REMOVE, &amp;found);<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(InjectionPointLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;injection point </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> not found&quot;</span>, name);<br/></li>
<li><br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;Injection points are not supported by this build&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Execute an injection point, if defined.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Check first the shared <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table, and adapt the local cache depending<br/></li>
<li></span><span class="Comment"> * on that as it could be possible that an entry to run has been removed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L262">&#x200c;</a></span><span class="linkable">InjectionPointRun</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_INJECTION_POINTS<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L47" title="utils/misc/injection_point.c:47">InjectionPointEntry</a> *entry_by_name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; InjectionPointCallback injection_callback;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(InjectionPointLock, LW_SHARED);<br/></li>
<li>&nbsp; &nbsp; entry_by_name = (<a href="#L47" title="utils/misc/injection_point.c:47">InjectionPointEntry</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L39" title="utils/misc/injection_point.c:39">InjectionPointHash</a>, name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_FIND, &amp;found);<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(InjectionPointLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If not found, do nothing and remove it from the local cache if it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * existed there.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L112" title="utils/misc/injection_point.c:112">injection_point_cache_remove</a>(name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check if the callback exists in the local cache, to avoid unnecessary<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * external loads.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; injection_callback = <a href="#L127" title="utils/misc/injection_point.c:127">injection_point_cache_get</a>(name);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (injection_callback == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; path[MAXPGPATH];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* not found in local cache, so load and register */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(path, MAXPGPATH, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s%s</span><span class="Constant">&quot;</span>, <a href="../init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entry_by_name-&gt;library, DLSUFFIX);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../storage/file/fd.c.html#L503" title="storage/file/fd.c:503">pg_file_exists</a>(path))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> for injection point </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; path, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; injection_callback = (InjectionPointCallback)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../fmgr/dfmgr.c.html#L105" title="utils/fmgr/dfmgr.c:105">load_external_function</a>(path, entry_by_name-&gt;function, <span class="Constant">false</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (injection_callback == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> function </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> in library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> for injection point </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entry_by_name-&gt;function, path, name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* add it to the local cache when found */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L75" title="utils/misc/injection_point.c:75">injection_point_cache_add</a>(name, injection_callback);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; injection_callback(name);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;Injection points are not supported by this build&quot;</span>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
