<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/misc/rls.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/misc/rls.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L52">check_enable_rls</a></li>
<li><a href="#L142">row_security_active</a></li>
<li><a href="#L153">row_security_active_name</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * rls.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RLS-related utility <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src/backend/utils/misc/rls.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/htup.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/htup_details.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/transam.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/namespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_class.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/acl.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/fmgrprotos.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/lsyscache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/rls.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/syscache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/varlena.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L52" title="utils/misc/rls.c:52">check_enable_rls</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Determine, based on the relation, <a href="guc_tables.c.html#L513" title="utils/misc/guc_tables.c:513">row_security</a> setting, and current role,<br/></li>
<li></span><span class="Comment"> * if RLS is applicable to this query.&nbsp; RLS_NONE_ENV indicates that, while<br/></li>
<li></span><span class="Comment"> * RLS is not to be added for this query, a change in the environment may change<br/></li>
<li></span><span class="Comment"> * that.&nbsp; RLS_NONE means that RLS is not on the relation at all and therefore<br/></li>
<li></span><span class="Comment"> * we don't need to worry about it.&nbsp; RLS_ENABLED means RLS should be implemented<br/></li>
<li></span><span class="Comment"> * for the table and the plan cache needs to be invalidated if the environment<br/></li>
<li></span><span class="Comment"> * changes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Handle checking as another role via checkAsUser (for views, etc).&nbsp; Pass<br/></li>
<li></span><span class="Comment"> * InvalidOid to check the current user.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If noError is set to 'true' then we just return RLS_ENABLED instead of doing<br/></li>
<li></span><span class="Comment"> * an ereport() if the user has attempted to bypass RLS and they are not<br/></li>
<li></span><span class="Comment"> * allowed to.&nbsp; This allows users to check if RLS is enabled without having to<br/></li>
<li></span><span class="Comment"> * deal with the actual error case (eg: error cases which are trying to decide<br/></li>
<li></span><span class="Comment"> * if the user should get data from the relation back as part of the error).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">int<br/></li>
<li><a id="L52">&#x200c;</a></span><span class="linkable">check_enable_rls</span>(Oid relid, Oid checkAsUser, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> noError)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user_id = OidIsValid(checkAsUser) ? checkAsUser : <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tuple;<br/></li>
<li>&nbsp; &nbsp; Form_pg_class classform;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; relrowsecurity;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; relforcerowsecurity;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; amowner;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Nothing to do for built-in relations */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (relid &lt; (Oid) FirstNormalObjectId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> RLS_NONE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fetch relation's relrowsecurity and relforcerowsecurity flags */<br/></li>
<li></span>&nbsp; &nbsp; tuple = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(RELOID, ObjectIdGetDatum(relid));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tuple))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> RLS_NONE;<br/></li>
<li>&nbsp; &nbsp; classform = (Form_pg_class) GETSTRUCT(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; relrowsecurity = classform-&gt;relrowsecurity;<br/></li>
<li>&nbsp; &nbsp; relforcerowsecurity = classform-&gt;relforcerowsecurity;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Nothing to do if the relation does not have RLS */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!relrowsecurity)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> RLS_NONE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * BYPASSRLS users always bypass RLS.&nbsp; Note that superusers are always<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * considered to have BYPASSRLS.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Return RLS_NONE_ENV to indicate that this decision depends on the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * environment (in this case, the user_id).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/aclchk.c.html#L4230" title="catalog/aclchk.c:4230">has_bypassrls_privilege</a>(user_id))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> RLS_NONE_ENV;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Table owners generally bypass RLS, except if the table has been set (by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * an owner) to FORCE ROW SECURITY, and this is not a referential<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * integrity check.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Return RLS_NONE_ENV to indicate that this decision depends on the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * environment (in this case, the user_id).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; amowner = <a href="../../catalog/aclchk.c.html#L4130" title="catalog/aclchk.c:4130">object_ownercheck</a>(RelationRelationId, relid, user_id);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (amowner)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If FORCE ROW LEVEL SECURITY has been set on the relation then we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * should return RLS_ENABLED to indicate that RLS should be applied.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If not, or if we are in an <a href="../init/miscinit.c.html#L671" title="utils/init/miscinit.c:671">InNoForceRLSOperation</a> context, we return<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * RLS_NONE_ENV.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../init/miscinit.c.html#L671" title="utils/init/miscinit.c:671">InNoForceRLSOperation</a> indicates that we should not apply RLS even<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * if the table has FORCE RLS set - IF the current user is the owner.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This is specifically to ensure that referential integrity checks<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * are able to still run correctly.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This is intentionally only done after we have checked that the user<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * is the table owner, which should always be the case for referential<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * integrity checks.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!relforcerowsecurity || <a href="../init/miscinit.c.html#L671" title="utils/init/miscinit.c:671">InNoForceRLSOperation</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> RLS_NONE_ENV;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We should apply RLS.&nbsp; However, the user may turn off the <a href="guc_tables.c.html#L513" title="utils/misc/guc_tables.c:513">row_security</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * GUC to get a forced error instead.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="guc_tables.c.html#L513" title="utils/misc/guc_tables.c:513">row_security</a> &amp;&amp; !noError)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INSUFFICIENT_PRIVILEGE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;query would be affected by row-level security policy for table </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/lsyscache.c.html#L1928" title="utils/cache/lsyscache.c:1928">get_rel_name</a>(relid)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; amowner ? <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;To disable the policy for the table's owner, use ALTER TABLE NO FORCE ROW LEVEL SECURITY.&quot;</span>) : <span class="Constant">0</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* RLS should be fully enabled for this relation. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> RLS_ENABLED;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L142" title="utils/misc/rls.c:142">row_security_active</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L52" title="utils/misc/rls.c:52">check_enable_rls</a> wrapped as a SQL callable function except<br/></li>
<li></span><span class="Comment"> * RLS_NONE_ENV and RLS_NONE are the same for this purpose.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L142">&#x200c;</a><span class="linkable">row_security_active</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* By OID */<br/></li>
<li></span>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rls_status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rls_status = <a href="#L52" title="utils/misc/rls.c:52">check_enable_rls</a>(tableoid, InvalidOid, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(rls_status == RLS_ENABLED);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L153">&#x200c;</a><span class="linkable">row_security_active_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* By qualified name */<br/></li>
<li></span>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; RangeVar&nbsp;&nbsp; *tablerel;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rls_status;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Look up table name.&nbsp; Can't lock it - we might not have privileges. */<br/></li>
<li></span>&nbsp; &nbsp; tablerel = <a href="../../catalog/namespace.c.html#L3539" title="catalog/namespace.c:3539">makeRangeVarFromNameList</a>(<a href="../adt/varlena.c.html#L3399" title="utils/adt/varlena.c:3399">textToQualifiedNameList</a>(tablename));<br/></li>
<li>&nbsp; &nbsp; tableoid = RangeVarGetRelid(tablerel, NoLock, <span class="Constant">false</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rls_status = <a href="#L52" title="utils/misc/rls.c:52">check_enable_rls</a>(tableoid, InvalidOid, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(rls_status == RLS_ENABLED);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
