<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/fmgr/dfmgr.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/fmgr/dfmgr.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L77">Dynamic_library_path</a></li>
<li><a href="#L67">file_list</a></li>
<li><a href="#L68">file_tail</a></li>
<li><a href="#L88">magic_data</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L65">DynamicFileList</a></li>
<li><a href="#L42">PG_init_t</a></li>
<li><a href="#L55">df_files</a></li>
<li><a href="#L49">rendezvousHashEntry</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L637">EstimateLibraryStateSpace</a></li>
<li><a href="#L676">RestoreLibraryState</a></li>
<li><a href="#L654">SerializeLibraryState</a></li>
<li><a href="#L469">check_restricted_library_name</a></li>
<li><a href="#L414">expand_dynamic_library_name</a></li>
<li><a href="#L515">find_in_dynamic_libpath</a></li>
<li><a href="#L599">find_rendezvous_variable</a></li>
<li><a href="#L306">incompatible_module_error</a></li>
<li><a href="#L184">internal_load_library</a></li>
<li><a href="#L105">load_external_function</a></li>
<li><a href="#L144">load_file</a></li>
<li><a href="#L166">lookup_external_function</a></li>
<li><a href="#L484">substitute_libpath_macro</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L72">SAME_INODE</a></li>
<li><a href="#L74">SAME_INODE</a></li>
<li><a href="#L28">bool</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * dfmgr.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Dynamic function manager code.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/fmgr/dfmgr.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;sys/stat.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifndef WIN32<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;dlfcn.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * On macOS, &lt;dlfcn.h&gt; insists on including &lt;stdbool.h&gt;.&nbsp; If we're not<br/></li>
<li></span><span class="Comment"> * using stdbool, undef <a href="#L28" title="utils/fmgr/dfmgr.c:28">bool</a> to undo the damage.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#ifndef PG_USE_STDBOOL<br/></li>
<li></span><span class="PreProc">#ifdef <a href="#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L28">&#x200c;</a></span><span class="PreProc">#undef </span><span class="Type"><span class="linkable">bool</span><br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* !WIN32 */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;fmgr.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lib/stringinfo.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/shmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/hsearch.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* signature for PostgreSQL-specific library init function */<br/></li>
<li><a id="L42">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">void</span> (*<span class="linkable">PG_init_t</span>) (<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><span class="Comment">/* hashtable entry for rendezvous variables */<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; varName[NAMEDATALEN];&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> key (must be first) */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *varValue;<br/></li>
<li><a id="L49">&#x200c;</a>} <span class="linkable">rendezvousHashEntry</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * List of dynamically loaded files (kept in malloc'd memory).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L55">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">df_files</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="#L55" title="utils/fmgr/dfmgr.c:55">df_files</a> *<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* List link */<br/></li>
<li></span>&nbsp; &nbsp; dev_t&nbsp; &nbsp; &nbsp; &nbsp; device;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Device file is on */<br/></li>
<li></span><span class="PreProc">#ifndef WIN32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Comment">/* ensures we never again depend on this under<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * win32 */<br/></li>
<li></span>&nbsp; &nbsp; ino_t&nbsp; &nbsp; &nbsp; &nbsp; inode;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Inode number of file */<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *handle;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* a handle for pg_dl* <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; filename[FLEXIBLE_ARRAY_MEMBER];&nbsp; &nbsp; <span class="Comment">/* Full pathname of file */<br/></li>
<li><a id="L65">&#x200c;</a></span>} <span class="linkable">DynamicFileList</span>;<br/></li>
<li><br/></li>
<li><a id="L67">&#x200c;</a><span class="Type">static</span> <a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a> *<span class="linkable">file_list</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L68">&#x200c;</a><span class="Type">static</span> <a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a> *<span class="linkable">file_tail</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* stat() call under Win32 returns an st_ino field, but it has no meaning */<br/></li>
<li></span><span class="PreProc">#ifndef WIN32<br/></li>
<li><a id="L72">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SAME_INODE</span>(A,B) ((A).st_ino == (B).inode &amp;&amp; (A).st_dev == (B).device)<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li><a id="L74">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SAME_INODE</span>(A,B) </span><span class="Constant">false<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><a id="L77">&#x200c;</a><span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *<span class="linkable">Dynamic_library_path</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> *<a href="#L184" title="utils/fmgr/dfmgr.c:184">internal_load_library</a>(<span class="Type">const</span> <span class="Type">char</span> *libname);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L306" title="utils/fmgr/dfmgr.c:306">incompatible_module_error</a>(<span class="Type">const</span> <span class="Type">char</span> *libname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> Pg_magic_struct *module_magic_data) pg_attribute_noreturn();<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L414" title="utils/fmgr/dfmgr.c:414">expand_dynamic_library_name</a>(<span class="Type">const</span> <span class="Type">char</span> *name);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L469" title="utils/fmgr/dfmgr.c:469">check_restricted_library_name</a>(<span class="Type">const</span> <span class="Type">char</span> *name);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L484" title="utils/fmgr/dfmgr.c:484">substitute_libpath_macro</a>(<span class="Type">const</span> <span class="Type">char</span> *name);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L515" title="utils/fmgr/dfmgr.c:515">find_in_dynamic_libpath</a>(<span class="Type">const</span> <span class="Type">char</span> *basename);<br/></li>
<li><br/></li>
<li><span class="Comment">/* Magic structure that module needs to match to be accepted */<br/></li>
<li><a id="L88">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> Pg_magic_struct <span class="linkable">magic_data</span> = PG_MODULE_MAGIC_DATA;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Load the specified dynamic-link library file, and look for a function<br/></li>
<li></span><span class="Comment"> * named funcname in it.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If the function is not found, we raise an error if signalNotFound is true,<br/></li>
<li></span><span class="Comment"> * else return NULL.&nbsp; Note that errors in loading the library<br/></li>
<li></span><span class="Comment"> * will provoke ereport() regardless of signalNotFound.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If filehandle is not NULL, then *filehandle will be set to a handle<br/></li>
<li></span><span class="Comment"> * identifying the library file.&nbsp; The filehandle can be used with<br/></li>
<li></span><span class="Comment"> * <a href="#L166" title="utils/fmgr/dfmgr.c:166">lookup_external_function</a> to lookup additional <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> in the same file<br/></li>
<li></span><span class="Comment"> * at less cost than repeating <a href="#L105" title="utils/fmgr/dfmgr.c:105">load_external_function</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void</span> *<br/></li>
<li><a id="L105">&#x200c;</a><span class="linkable">load_external_function</span>(<span class="Type">const</span> <span class="Type">char</span> *filename, <span class="Type">const</span> <span class="Type">char</span> *funcname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> signalNotFound, <span class="Type">void</span> **filehandle)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *fullname;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *lib_handle;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *retval;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Expand the possibly-abbreviated filename to an exact path name */<br/></li>
<li></span>&nbsp; &nbsp; fullname = <a href="#L414" title="utils/fmgr/dfmgr.c:414">expand_dynamic_library_name</a>(filename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Load the shared library, unless we already did */<br/></li>
<li></span>&nbsp; &nbsp; lib_handle = <a href="#L184" title="utils/fmgr/dfmgr.c:184">internal_load_library</a>(fullname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Return handle if caller wants it */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (filehandle)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *filehandle = lib_handle;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Look up the function within the library. */<br/></li>
<li></span>&nbsp; &nbsp; retval = dlsym(lib_handle, funcname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (retval == <span class="Constant">NULL</span> &amp;&amp; signalNotFound)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_FUNCTION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> function </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> in file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; funcname, fullname)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(fullname);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> retval;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This function loads a shlib file without looking up <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> particular<br/></li>
<li></span><span class="Comment"> * function in it.&nbsp; If the same shlib has previously been loaded,<br/></li>
<li></span><span class="Comment"> * unload and reload it.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * When 'restricted' is true, only libraries in the presumed-secure<br/></li>
<li></span><span class="Comment"> * directory $libdir/plugins may be referenced.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L144">&#x200c;</a></span><span class="linkable">load_file</span>(<span class="Type">const</span> <span class="Type">char</span> *filename, <span class="Type"><a href="#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> restricted)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *fullname;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Apply security restriction if requested */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (restricted)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L469" title="utils/fmgr/dfmgr.c:469">check_restricted_library_name</a>(filename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Expand the possibly-abbreviated filename to an exact path name */<br/></li>
<li></span>&nbsp; &nbsp; fullname = <a href="#L414" title="utils/fmgr/dfmgr.c:414">expand_dynamic_library_name</a>(filename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Load the shared library */<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L184" title="utils/fmgr/dfmgr.c:184">internal_load_library</a>(fullname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(fullname);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Lookup a function whose library file is already loaded.<br/></li>
<li></span><span class="Comment"> * Return NULL if not found.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void</span> *<br/></li>
<li><a id="L166">&#x200c;</a><span class="linkable">lookup_external_function</span>(<span class="Type">void</span> *filehandle, <span class="Type">const</span> <span class="Type">char</span> *funcname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dlsym(filehandle, funcname);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Load the specified dynamic-link library file, unless it already is<br/></li>
<li></span><span class="Comment"> * loaded.&nbsp; Return the pg_dl* handle for the file.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: libname is expected to be an exact name for the library file.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: There is presently no way to unload a dynamically loaded file.&nbsp; We might<br/></li>
<li></span><span class="Comment"> * add one someday if we can convince ourselves we have safe protocols for un-<br/></li>
<li></span><span class="Comment"> * hooking from hook function pointers, releasing custom GUC variables, and<br/></li>
<li></span><span class="Comment"> * perhaps other things that are definitely unsafe currently.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void</span> *<br/></li>
<li><a id="L184">&#x200c;</a><span class="linkable">internal_load_library</span>(<span class="Type">const</span> <span class="Type">char</span> *libname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a> *file_scanner;<br/></li>
<li>&nbsp; &nbsp; PGModuleMagicFunction magic_func;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *load_error;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> stat stat_buf;<br/></li>
<li>&nbsp; &nbsp; <a href="#L42" title="utils/fmgr/dfmgr.c:42">PG_init_t</a>&nbsp; &nbsp; PG_init;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Scan the list of loaded FILES to see if the file has been loaded.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (file_scanner = <a href="#L67" title="utils/fmgr/dfmgr.c:67">file_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner != <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; strcmp(libname, file_scanner-&gt;filename) != <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner = file_scanner-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file_scanner == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Check for same files - different paths (ie, symlink or link)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stat(libname, &amp;stat_buf) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not access file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libname)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (file_scanner = <a href="#L67" title="utils/fmgr/dfmgr.c:67">file_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner != <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; !<a href="#L72" title="utils/fmgr/dfmgr.c:72">SAME_INODE</a>(stat_buf, *file_scanner);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner = file_scanner-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (file_scanner == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * File not loaded yet.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; file_scanner = (<a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; malloc(offsetof(<a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a>, filename) + strlen(libname) + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file_scanner == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_OUT_OF_MEMORY),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;out of memory&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(file_scanner, <span class="Constant">0</span>, offsetof(<a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a>, filename));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strcpy(file_scanner-&gt;filename, libname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file_scanner-&gt;device = stat_buf.st_dev;<br/></li>
<li><span class="PreProc">#ifndef WIN32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; file_scanner-&gt;inode = stat_buf.st_ino;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; file_scanner-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; file_scanner-&gt;handle = dlopen(file_scanner-&gt;filename, RTLD_NOW | RTLD_GLOBAL);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (file_scanner-&gt;handle == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; load_error = dlerror();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(file_scanner);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a> might not be appropriate here? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not load library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libname, load_error)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Check the magic function to determine compatibility */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; magic_func = (PGModuleMagicFunction)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dlsym(file_scanner-&gt;handle, PG_MAGIC_FUNCTION_NAME_STRING);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (magic_func)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> Pg_magic_struct *magic_data_ptr = (*magic_func) ();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (magic_data_ptr-&gt;len != <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.len ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcmp(magic_data_ptr, &amp;<a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>, <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.len) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* copy data block <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> unlinking library */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Pg_magic_struct module_magic_data = *magic_data_ptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* try to close library */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dlclose(file_scanner-&gt;handle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(file_scanner);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* issue suitable complaint */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L306" title="utils/fmgr/dfmgr.c:306">incompatible_module_error</a>(libname, &amp;module_magic_data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* try to close library */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dlclose(file_scanner-&gt;handle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; free(file_scanner);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* complain */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;incompatible library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: missing magic block&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libname),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;Extension libraries are required to use the PG_MODULE_MAGIC macro.&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If the library has a <a href="../../replication/libpqwalreceiver/libpqwalreceiver.c.html#L120" title="replication/libpqwalreceiver/libpqwalreceiver.c:120">_PG_init</a>() function, call it.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; PG_init = (<a href="#L42" title="utils/fmgr/dfmgr.c:42">PG_init_t</a>) dlsym(file_scanner-&gt;handle, <span class="Constant">&quot;<a href="../../replication/libpqwalreceiver/libpqwalreceiver.c.html#L120" title="replication/libpqwalreceiver/libpqwalreceiver.c:120">_PG_init</a>&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (PG_init)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*PG_init) ();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* OK to link it into list */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L67" title="utils/fmgr/dfmgr.c:67">file_list</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L67" title="utils/fmgr/dfmgr.c:67">file_list</a> = file_scanner;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L68" title="utils/fmgr/dfmgr.c:68">file_tail</a>-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = file_scanner;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L68" title="utils/fmgr/dfmgr.c:68">file_tail</a> = file_scanner;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> file_scanner-&gt;handle;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Report a suitable error for an incompatible magic block.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L306">&#x200c;</a></span><span class="linkable">incompatible_module_error</span>(<span class="Type">const</span> <span class="Type">char</span> *libname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> Pg_magic_struct *module_magic_data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; StringInfoData details;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the version doesn't match, just report that, because the rest of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * block might not even have the fields we expect.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.version != module_magic_data-&gt;version)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; library_version[<span class="Constant">32</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (module_magic_data-&gt;version &gt;= <span class="Constant">1000</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(library_version, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(library_version), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;version / <span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(library_version, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(library_version), <span class="Constant">&quot;</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;version / <span class="Constant">100</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;version % <span class="Constant">100</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;incompatible library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: version mismatch&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libname),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1205" title="utils/error/elog.c:1205">errdetail</a>(<span class="Constant">&quot;Server is version </span><span class="Special">%d</span><span class="Constant">, library is version </span><span class="Special">%s</span><span class="Constant">.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.version / <span class="Constant">100</span>, library_version)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Similarly, if the ABI extra field doesn't match, error out.&nbsp; Other<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * fields below might also mismatch, but that isn't useful information if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * you're using the wrong product altogether.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (strcmp(module_magic_data-&gt;abi_extra, <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.abi_extra) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;incompatible library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: ABI mismatch&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libname),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1205" title="utils/error/elog.c:1205">errdetail</a>(<span class="Constant">&quot;Server has ABI </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">, library has </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.abi_extra,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;abi_extra)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Otherwise, spell out which fields don't agree.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * </span><span class="Todo">XXX</span><span class="Comment"> this code has to be adjusted <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> time the set of fields in a magic<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * block change!<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; initStringInfo(&amp;details);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (module_magic_data-&gt;funcmaxargs != <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.funcmaxargs)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (details.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoChar(&amp;details, <span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;details,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>(<span class="Constant">&quot;Server has FUNC_MAX_ARGS = </span><span class="Special">%d</span><span class="Constant">, library has </span><span class="Special">%d</span><span class="Constant">.&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.funcmaxargs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;funcmaxargs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (module_magic_data-&gt;indexmaxkeys != <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.indexmaxkeys)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (details.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoChar(&amp;details, <span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;details,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>(<span class="Constant">&quot;Server has INDEX_MAX_KEYS = </span><span class="Special">%d</span><span class="Constant">, library has </span><span class="Special">%d</span><span class="Constant">.&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.indexmaxkeys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;indexmaxkeys);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (module_magic_data-&gt;namedatalen != <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.namedatalen)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (details.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoChar(&amp;details, <span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;details,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>(<span class="Constant">&quot;Server has NAMEDATALEN = </span><span class="Special">%d</span><span class="Constant">, library has </span><span class="Special">%d</span><span class="Constant">.&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.namedatalen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;namedatalen);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (module_magic_data-&gt;float8byval != <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.float8byval)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (details.len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoChar(&amp;details, <span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;details,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>(<span class="Constant">&quot;Server has FLOAT8PASSBYVAL = </span><span class="Special">%s</span><span class="Constant">, library has </span><span class="Special">%s</span><span class="Constant">.&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L88" title="utils/fmgr/dfmgr.c:88">magic_data</a>.float8byval ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; module_magic_data-&gt;float8byval ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (details.len == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;details,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>(<span class="Constant">&quot;Magic block has unexpected length or padding difference.&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;incompatible library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: magic block mismatch&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libname),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1232" title="utils/error/elog.c:1232">errdetail_internal</a>(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, details.data)));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * If name contains a slash, check if the file exists, if so return<br/></li>
<li></span><span class="Comment"> * the name.&nbsp; Else (no slash) try to expand using search path (see<br/></li>
<li></span><span class="Comment"> * <a href="#L515" title="utils/fmgr/dfmgr.c:515">find_in_dynamic_libpath</a> below); if that works, return the fully<br/></li>
<li></span><span class="Comment"> * expanded file name.&nbsp; If the previous failed, append DLSUFFIX and<br/></li>
<li></span><span class="Comment"> * try again.&nbsp; If all fails, just return the original name.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The result will always be freshly <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L414">&#x200c;</a><span class="linkable">expand_dynamic_library_name</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; have_slash;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *new;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *full;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; have_slash = (first_dir_separator(name) != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!have_slash)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; full = <a href="#L515" title="utils/fmgr/dfmgr.c:515">find_in_dynamic_libpath</a>(name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (full)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> full;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; full = <a href="#L484" title="utils/fmgr/dfmgr.c:484">substitute_libpath_macro</a>(name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../storage/file/fd.c.html#L503" title="storage/file/fd.c:503">pg_file_exists</a>(full))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> full;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(full);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; new = psprintf(<span class="Constant">&quot;</span><span class="Special">%s%s</span><span class="Constant">&quot;</span>, name, DLSUFFIX);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!have_slash)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; full = <a href="#L515" title="utils/fmgr/dfmgr.c:515">find_in_dynamic_libpath</a>(new);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(new);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (full)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> full;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; full = <a href="#L484" title="utils/fmgr/dfmgr.c:484">substitute_libpath_macro</a>(new);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(new);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../storage/file/fd.c.html#L503" title="storage/file/fd.c:503">pg_file_exists</a>(full))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> full;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(full);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If we can't <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> the file, just return the string as-is. The ensuing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * load attempt will fail and report a suitable message.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(name);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Check a restricted library name.&nbsp; It must begin with &quot;$libdir/plugins/&quot;<br/></li>
<li></span><span class="Comment"> * and there must not be <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> directory separators after that (this is<br/></li>
<li></span><span class="Comment"> * sufficient to prevent &quot;..&quot; style attacks).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L469">&#x200c;</a></span><span class="linkable">check_restricted_library_name</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strncmp(name, <span class="Constant">&quot;$libdir/plugins/&quot;</span>, <span class="Constant">16</span>) != <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; first_dir_separator(name + <span class="Constant">16</span>) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INSUFFICIENT_PRIVILEGE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;access to library </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not allowed&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name)));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Substitute for <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> macros appearing in the given string.<br/></li>
<li></span><span class="Comment"> * Result is always freshly <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L484">&#x200c;</a><span class="linkable">substitute_libpath_macro</span>(<span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *sep_ptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(name != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Currently, we only recognize $libdir at the start of the string */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (name[<span class="Constant">0</span>] != <span class="Constant">'$'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((sep_ptr = first_dir_separator(name)) == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sep_ptr = name + strlen(name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strlen(<span class="Constant">&quot;$libdir&quot;</span>) != sep_ptr - name ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strncmp(name, <span class="Constant">&quot;$libdir&quot;</span>, strlen(<span class="Constant">&quot;$libdir&quot;</span>)) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_NAME),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid macro name in dynamic library path: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; name)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> psprintf(<span class="Constant">&quot;</span><span class="Special">%s%s</span><span class="Constant">&quot;</span>, <a href="../init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>, sep_ptr);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Search for a file called 'basename' in the colon-separated search<br/></li>
<li></span><span class="Comment"> * path <a href="#L77" title="utils/fmgr/dfmgr.c:77">Dynamic_library_path</a>.&nbsp; If the file is found, the full file name<br/></li>
<li></span><span class="Comment"> * is returned in freshly <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d memory.&nbsp; If the file is not found,<br/></li>
<li></span><span class="Comment"> * return NULL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L515">&#x200c;</a><span class="linkable">find_in_dynamic_libpath</span>(<span class="Type">const</span> <span class="Type">char</span> *basename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; baselen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(basename != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(first_dir_separator(basename) == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L77" title="utils/fmgr/dfmgr.c:77">Dynamic_library_path</a> != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = <a href="#L77" title="utils/fmgr/dfmgr.c:77">Dynamic_library_path</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strlen(p) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; baselen = strlen(basename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *piece;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *mangled;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *full;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; piece = first_path_var_separator(p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (piece == p)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_NAME),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;zero-length component in parameter dynamic_library_path&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (piece == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = strlen(p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = piece - p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; piece = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(len + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strlcpy(piece, p, len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mangled = <a href="#L484" title="utils/fmgr/dfmgr.c:484">substitute_libpath_macro</a>(piece);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(piece);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; canonicalize_path(mangled);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* only absolute paths */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!is_absolute_path(mangled))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_NAME),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;component in parameter dynamic_library_path is not an absolute path&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; full = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(strlen(mangled) + <span class="Constant">1</span> + baselen + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; sprintf(full, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">&quot;</span>, mangled, basename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(mangled);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(DEBUG3, <span class="Constant">&quot;<a href="#L515" title="utils/fmgr/dfmgr.c:515">find_in_dynamic_libpath</a>: trying </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, full);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../storage/file/fd.c.html#L503" title="storage/file/fd.c:503">pg_file_exists</a>(full))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> full;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(full);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p[len] == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p += len + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Find (or create) a rendezvous variable that one dynamically<br/></li>
<li></span><span class="Comment"> * loaded library can use to meet up with another.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * On the first call of this function for a particular varName,<br/></li>
<li></span><span class="Comment"> * a &quot;rendezvous variable&quot; is created with the given name.<br/></li>
<li></span><span class="Comment"> * The value of the variable is a void pointer (initially set to NULL).<br/></li>
<li></span><span class="Comment"> * Subsequent calls with the same varName just return the address of<br/></li>
<li></span><span class="Comment"> * the existing variable.&nbsp; Once created, a rendezvous variable lasts<br/></li>
<li></span><span class="Comment"> * for the life of the process.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Dynamically loaded libraries can use rendezvous variables<br/></li>
<li></span><span class="Comment"> * to <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> each other and share information: they just need to agree<br/></li>
<li></span><span class="Comment"> * on the variable name and the data it will point to.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void</span>&nbsp; &nbsp; &nbsp; **<br/></li>
<li><a id="L599">&#x200c;</a><span class="linkable">find_rendezvous_variable</span>(<span class="Type">const</span> <span class="Type">char</span> *varName)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a> *rendezvousHash = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L49" title="utils/fmgr/dfmgr.c:49">rendezvousHashEntry</a> *hentry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create a hashtable if we haven't already done so in this process */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rendezvousHash == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; HASHCTL&nbsp; &nbsp; &nbsp; &nbsp; ctl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctl.keysize = NAMEDATALEN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ctl.entrysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L49" title="utils/fmgr/dfmgr.c:49">rendezvousHashEntry</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rendezvousHash = <a href="../hash/dynahash.c.html#L352" title="utils/hash/dynahash.c:352">hash_create</a>(<span class="Constant">&quot;Rendezvous variable <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">16</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;ctl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HASH_ELEM | HASH_STRINGS);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Find or create the hashtable entry for this varName */<br/></li>
<li></span>&nbsp; &nbsp; hentry = (<a href="#L49" title="utils/fmgr/dfmgr.c:49">rendezvousHashEntry</a> *) <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(rendezvousHash,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; varName,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HASH_ENTER,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Initialize to NULL if first time */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hentry-&gt;varValue = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> &amp;hentry-&gt;varValue;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Estimate the amount of space needed to serialize the list of libraries<br/></li>
<li></span><span class="Comment"> * we have loaded.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L637">&#x200c;</a><span class="linkable">EstimateLibraryStateSpace</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a> *file_scanner;<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (file_scanner = <a href="#L67" title="utils/fmgr/dfmgr.c:67">file_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner != <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner = file_scanner-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size, strlen(file_scanner-&gt;filename) + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Serialize the list of libraries we have loaded to a chunk of memory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L654">&#x200c;</a></span><span class="linkable">SerializeLibraryState</span>(Size maxsize, <span class="Type">char</span> *start_address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L65" title="utils/fmgr/dfmgr.c:65">DynamicFileList</a> *file_scanner;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (file_scanner = <a href="#L67" title="utils/fmgr/dfmgr.c:67">file_list</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner != <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; file_scanner = file_scanner-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = strlcpy(start_address, file_scanner-&gt;filename, maxsize) + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(len &lt; maxsize);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; maxsize -= len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_address += len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; start_address[<span class="Constant">0</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Load every library the serializing backend had loaded.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L676">&#x200c;</a></span><span class="linkable">RestoreLibraryState</span>(<span class="Type">char</span> *start_address)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (*start_address != <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L184" title="utils/fmgr/dfmgr.c:184">internal_load_library</a>(start_address);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; start_address += strlen(start_address) + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
