<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/activity/backend_status.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/activity/backend_status.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L55">BackendActivityBuffer</a></li>
<li><a href="#L56">BackendActivityBufferSize</a></li>
<li><a href="#L53">BackendAppnameBuffer</a></li>
<li><a href="#L54">BackendClientHostnameBuffer</a></li>
<li><a href="#L61">BackendGssStatusBuffer</a></li>
<li><a href="#L58">BackendSslStatusBuffer</a></li>
<li><a href="#L52">BackendStatusArray</a></li>
<li><a href="#L49">MyBEEntry</a></li>
<li><a href="#L71">backendStatusSnapContext</a></li>
<li><a href="#L66">localBackendStatusTable</a></li>
<li><a href="#L69">localNumBackends</a></li>
<li><a href="#L44">pgstat_track_activities</a></li>
<li><a href="#L45">pgstat_track_activity_query_size</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L83">BackendStatusShmemSize</a></li>
<li><a href="#L116">CreateSharedBackendStatus</a></li>
<li><a href="#L1049">cmp_lbestatus</a></li>
<li><a href="#L247">pgstat_beinit</a></li>
<li><a href="#L440">pgstat_beshutdown_hook</a></li>
<li><a href="#L273">pgstat_bestart</a></li>
<li><a href="#L467">pgstat_clear_backend_activity_snapshot</a></li>
<li><a href="#L1164">pgstat_clip_activity</a></li>
<li><a href="#L1148">pgstat_fetch_stat_numbackends</a></li>
<li><a href="#L885">pgstat_get_backend_current_activity</a></li>
<li><a href="#L1072">pgstat_get_beentry_by_proc_number</a></li>
<li><a href="#L963">pgstat_get_crashed_backend_activity</a></li>
<li><a href="#L1128">pgstat_get_local_beentry_by_index</a></li>
<li><a href="#L1097">pgstat_get_local_beentry_by_proc_number</a></li>
<li><a href="#L1027">pgstat_get_my_query_id</a></li>
<li><a href="#L709">pgstat_read_current_status</a></li>
<li><a href="#L503">pgstat_report_activity</a></li>
<li><a href="#L653">pgstat_report_appname</a></li>
<li><a href="#L613">pgstat_report_query_id</a></li>
<li><a href="#L682">pgstat_report_xact_timestamp</a></li>
<li><a href="#L482">pgstat_setup_backend_status_context</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L37">NumBackendStatSlots</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * backend_status.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; <a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> status reporting infrastructure.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Copyright (c) 2001-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/activity/backend_status.c<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/xact.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;libpq/libpq-be.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;pg_trace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;pgstat.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;port/atomics.h&quot;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for memory barriers */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/ipc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/proc.h&quot;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for <a href="../../storage/lmgr/proc.c.html#L66" title="storage/lmgr/proc.c:66">MyProc</a> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/procarray.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/sinvaladt.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/<a href="../adt/oracle_compat.c.html#L925" title="utils/adt/oracle_compat.c:925">ascii</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/guc.h&quot;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for <a href="../misc/guc_tables.c.html#L546" title="utils/misc/guc_tables.c:546">application_name</a> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * Total number of backends including auxiliary<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We reserve a slot for each possible PGPROC entry, including aux processes.<br/></li>
<li></span><span class="Comment"> * (But not including PGPROC entries reserved for prepared xacts; they are not<br/></li>
<li></span><span class="Comment"> * real processes.)<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L37">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NumBackendStatSlots</span> (<a href="../init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a> + NUM_AUXILIARY_PROCS)<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * GUC parameters<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">pgstat_track_activities</span> = <span class="Constant">false</span>;<br/></li>
<li><a id="L45">&#x200c;</a><span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">pgstat_track_activity_query_size</span> = <span class="Constant">1024</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* exposed so that backend_progress.c can access it */<br/></li>
<li><a id="L49">&#x200c;</a></span>PgBackendStatus *<span class="linkable">MyBEEntry</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L52">&#x200c;</a><span class="Type">static</span> PgBackendStatus *<span class="linkable">BackendStatusArray</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L53">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> *<span class="linkable">BackendAppnameBuffer</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L54">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> *<span class="linkable">BackendClientHostnameBuffer</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L55">&#x200c;</a><span class="Type">static</span> <span class="Type">char</span> *<span class="linkable">BackendActivityBuffer</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L56">&#x200c;</a><span class="Type">static</span> Size <span class="linkable">BackendActivityBufferSize</span> = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li><a id="L58">&#x200c;</a></span><span class="Type">static</span> PgBackendSSLStatus *<span class="linkable">BackendSslStatusBuffer</span> = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li><a id="L61">&#x200c;</a></span><span class="Type">static</span> PgBackendGSSStatus *<span class="linkable">BackendGssStatusBuffer</span> = <span class="Constant">NULL</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* Status for backends including auxiliary */<br/></li>
<li><a id="L66">&#x200c;</a></span><span class="Type">static</span> LocalPgBackendStatus *<span class="linkable">localBackendStatusTable</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* Total number of backends including auxiliary */<br/></li>
<li><a id="L69">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">localNumBackends</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li><a id="L71">&#x200c;</a><span class="Type">static</span> MemoryContext <span class="linkable">backendStatusSnapContext</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L440" title="utils/activity/backend_status.c:440">pgstat_beshutdown_hook</a>(<span class="Type">int</span> code, Datum arg);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L709" title="utils/activity/backend_status.c:709">pgstat_read_current_status</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L482" title="utils/activity/backend_status.c:482">pgstat_setup_backend_status_context</a>(<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Report shared-memory space needed by <a href="#L116" title="utils/activity/backend_status.c:116">CreateSharedBackendStatus</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L83">&#x200c;</a><span class="linkable">BackendStatusShmemSize</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>: */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendStatus), <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="#L53" title="utils/activity/backend_status.c:53">BackendAppnameBuffer</a>: */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(NAMEDATALEN, <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="#L54" title="utils/activity/backend_status.c:54">BackendClientHostnameBuffer</a>: */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(NAMEDATALEN, <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a>: */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a>, <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>));<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* <a href="#L58" title="utils/activity/backend_status.c:58">BackendSslStatusBuffer</a>: */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendSSLStatus), <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* <a href="#L61" title="utils/activity/backend_status.c:61">BackendGssStatusBuffer</a>: */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendGSSStatus), <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize the shared status array and several string buffers<br/></li>
<li></span><span class="Comment"> * during postmaster startup.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L116">&#x200c;</a></span><span class="linkable">CreateSharedBackendStatus</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *buffer;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create or attach to the shared array */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendStatus), <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a> = (PgBackendStatus *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> Status Array&quot;</span>, size, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We're the first - <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(<a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>, <span class="Constant">0</span>, size);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create or attach to the shared appname buffer */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(NAMEDATALEN, <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L53" title="utils/activity/backend_status.c:53">BackendAppnameBuffer</a> = (<span class="Type">char</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> Application Name Buffer&quot;</span>, size, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(<a href="#L53" title="utils/activity/backend_status.c:53">BackendAppnameBuffer</a>, <span class="Constant">0</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Initialize st_appname pointers. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; buffer = <a href="#L53" title="utils/activity/backend_status.c:53">BackendAppnameBuffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>[i].st_appname = buffer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer += NAMEDATALEN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create or attach to the shared client hostname buffer */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(NAMEDATALEN, <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L54" title="utils/activity/backend_status.c:54">BackendClientHostnameBuffer</a> = (<span class="Type">char</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> Client Host Name Buffer&quot;</span>, size, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(<a href="#L54" title="utils/activity/backend_status.c:54">BackendClientHostnameBuffer</a>, <span class="Constant">0</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Initialize st_clienthostname pointers. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; buffer = <a href="#L54" title="utils/activity/backend_status.c:54">BackendClientHostnameBuffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>[i].st_clienthostname = buffer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer += NAMEDATALEN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create or attach to the shared activity buffer */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L56" title="utils/activity/backend_status.c:56">BackendActivityBufferSize</a> = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a> = (<span class="Type">char</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> Activity Buffer&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L56" title="utils/activity/backend_status.c:56">BackendActivityBufferSize</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(<a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a>, <span class="Constant">0</span>, <a href="#L56" title="utils/activity/backend_status.c:56">BackendActivityBufferSize</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Initialize st_activity pointers. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; buffer = <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>[i].st_activity_raw = buffer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buffer += <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Create or attach to the shared SSL status buffer */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendSSLStatus), <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L58" title="utils/activity/backend_status.c:58">BackendSslStatusBuffer</a> = (PgBackendSSLStatus *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> SSL Status Buffer&quot;</span>, size, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgBackendSSLStatus *ptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(<a href="#L58" title="utils/activity/backend_status.c:58">BackendSslStatusBuffer</a>, <span class="Constant">0</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Initialize st_sslstatus pointers. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ptr = <a href="#L58" title="utils/activity/backend_status.c:58">BackendSslStatusBuffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>[i].st_sslstatus = ptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Create or attach to the shared GSSAPI status buffer */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendGSSStatus), <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L61" title="utils/activity/backend_status.c:61">BackendGssStatusBuffer</a> = (PgBackendGSSStatus *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> GSS Status Buffer&quot;</span>, size, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgBackendGSSStatus *ptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(<a href="#L61" title="utils/activity/backend_status.c:61">BackendGssStatusBuffer</a>, <span class="Constant">0</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Initialize st_gssstatus pointers. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ptr = <a href="#L61" title="utils/activity/backend_status.c:61">BackendGssStatusBuffer</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>[i].st_gssstatus = ptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize pgstats backend activity state, and set up our on-proc-exit<br/></li>
<li></span><span class="Comment"> * hook.&nbsp; Called from <a href="../init/postinit.c.html#L736" title="utils/init/postinit.c:736">InitPostgres</a> and AuxiliaryProcessMain.&nbsp; <a href="../init/globals.c.html#L87" title="utils/init/globals.c:87">MyProcNumber</a> must<br/></li>
<li></span><span class="Comment"> * be set, but we must not have started <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> transaction yet (since the exit<br/></li>
<li></span><span class="Comment"> * hook must run after the last transaction exit).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="../../regex/regcomp.c.html#L324" title="regex/regcomp.c:324">NOTE</a>: <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a> isn't set yet; so the shutdown hook has to be careful.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L247">&#x200c;</a></span><span class="linkable">pgstat_beinit</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Initialize <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a> */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="../init/globals.c.html#L87" title="utils/init/globals.c:87">MyProcNumber</a> != INVALID_PROC_NUMBER);<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="../init/globals.c.html#L87" title="utils/init/globals.c:87">MyProcNumber</a> &gt;= <span class="Constant">0</span> &amp;&amp; <a href="../init/globals.c.html#L87" title="utils/init/globals.c:87">MyProcNumber</a> &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a> = &amp;<a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>[<a href="../init/globals.c.html#L87" title="utils/init/globals.c:87">MyProcNumber</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set up a process-exit hook to clean up */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/ipc/ipc.c.html#L365" title="storage/ipc/ipc.c:365">on_shmem_exit</a>(<a href="#L440" title="utils/activity/backend_status.c:440">pgstat_beshutdown_hook</a>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L273" title="utils/activity/backend_status.c:273">pgstat_bestart</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Initialize this backend's entry in the PgBackendStatus array.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Called from <a href="../init/postinit.c.html#L736" title="utils/init/postinit.c:736">InitPostgres</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Apart from auxiliary processes, <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>, session userid, and<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; <a href="../misc/guc_tables.c.html#L546" title="utils/misc/guc_tables.c:546">application_name</a> must already be set (hence, this cannot be combined<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; with <a href="#L247" title="utils/activity/backend_status.c:247">pgstat_beinit</a>).&nbsp; Note also that we must be inside a transaction<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; if this isn't an aux process, as we may need to do encoding conversion<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; on some strings.<br/></li>
<li></span><span class="Comment"> *----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L273">&#x200c;</a></span><span class="linkable">pgstat_bestart</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *vbeentry = <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>;<br/></li>
<li>&nbsp; &nbsp; PgBackendStatus lbeentry;<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; PgBackendSSLStatus lsslstatus;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; PgBackendGSSStatus lgssstatus;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* pgstats state must be initialized from <a href="#L247" title="utils/activity/backend_status.c:247">pgstat_beinit</a>() */<br/></li>
<li></span>&nbsp; &nbsp; Assert(vbeentry != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * To minimize the time spent modifying the PgBackendStatus entry, and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * avoid risk of errors inside the critical section, we first copy the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * shared-memory struct to a local variable, then modify the data in the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * local variable, then copy the local variable back to shared memory.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Only the last step has to be inside the critical section.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Most of the data we copy from shared memory is just going to be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * overwritten, but the struct's not so large that it's worth the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * maintenance hassle to copy only the needful fields.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; memcpy(&amp;lbeentry,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unvolatize(PgBackendStatus *, vbeentry),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendStatus));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* These structs can just start from zeroes each time, though */<br/></li>
<li></span><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; memset(&amp;lsslstatus, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(lsslstatus));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; memset(&amp;lgssstatus, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(lgssstatus));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Now fill in all the fields of lbeentry, except for strings that are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * out-of-line data.&nbsp; Those have to be handled separately, below.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; lbeentry.st_procpid = <a href="../init/globals.c.html#L45" title="utils/init/globals.c:45">MyProcPid</a>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_backendType = <a href="../init/miscinit.c.html#L63" title="utils/init/miscinit.c:63">MyBackendType</a>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_proc_start_timestamp = <a href="../init/globals.c.html#L47" title="utils/init/globals.c:47">MyStartTimestamp</a>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_activity_start_timestamp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_state_start_timestamp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_xact_start_timestamp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_databaseid = <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We have userid for client-backends, wal-sender and bgworker processes */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (lbeentry.st_backendType == B_BACKEND<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || lbeentry.st_backendType == B_WAL_SENDER<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; || lbeentry.st_backendType == B_BG_WORKER)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_userid = <a href="../init/miscinit.c.html#L548" title="utils/init/miscinit.c:548">GetSessionUserId</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_userid = InvalidOid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We may not have a <a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a> (eg, if this is the autovacuum process).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If so, use all-zeroes client address, which is dealt with specially in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../adt/pgstatfuncs.c.html#L879" title="utils/adt/pgstatfuncs.c:879">pg_stat_get_backend_client_addr</a> and <a href="../adt/pgstatfuncs.c.html#L924" title="utils/adt/pgstatfuncs.c:924">pg_stat_get_backend_client_port</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(&amp;lbeentry.st_clientaddr, &amp;<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>-&gt;raddr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(lbeentry.st_clientaddr));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(&amp;lbeentry.st_clientaddr, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(lbeentry.st_clientaddr));<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a> &amp;&amp; <a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>-&gt;ssl_in_use)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_ssl = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lsslstatus.ssl_bits = <a href="../../libpq/be-secure-openssl.c.html#L1468" title="libpq/be-secure-openssl.c:1468">be_tls_get_cipher_bits</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strlcpy(lsslstatus.ssl_version, <a href="../../libpq/be-secure-openssl.c.html#L1482" title="libpq/be-secure-openssl.c:1482">be_tls_get_version</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>), NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strlcpy(lsslstatus.ssl_cipher, <a href="../../libpq/be-secure-openssl.c.html#L1491" title="libpq/be-secure-openssl.c:1491">be_tls_get_cipher</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>), NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../libpq/be-secure-openssl.c.html#L1500" title="libpq/be-secure-openssl.c:1500">be_tls_get_peer_subject_name</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>, lsslstatus.ssl_client_dn, NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../libpq/be-secure-openssl.c.html#L1518" title="libpq/be-secure-openssl.c:1518">be_tls_get_peer_serial</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>, lsslstatus.ssl_client_serial, NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../libpq/be-secure-openssl.c.html#L1509" title="libpq/be-secure-openssl.c:1509">be_tls_get_peer_issuer_name</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>, lsslstatus.ssl_issuer_dn, NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_ssl = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; lbeentry.st_ssl = <span class="Constant">false</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a> &amp;&amp; <a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>-&gt;gss != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *princ = <a href="../../libpq/be-secure-gssapi.c.html#L739" title="libpq/be-secure-gssapi.c:739">be_gssapi_get_princ</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_gss = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lgssstatus.gss_auth = <a href="../../libpq/be-secure-gssapi.c.html#L714" title="libpq/be-secure-gssapi.c:714">be_gssapi_get_auth</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lgssstatus.gss_enc = <a href="../../libpq/be-secure-gssapi.c.html#L726" title="libpq/be-secure-gssapi.c:726">be_gssapi_get_enc</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lgssstatus.gss_delegation = <a href="../../libpq/be-secure-gssapi.c.html#L752" title="libpq/be-secure-gssapi.c:752">be_gssapi_get_delegation</a>(<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (princ)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strlcpy(lgssstatus.gss_princ, princ, NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_gss = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; lbeentry.st_gss = <span class="Constant">false</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; lbeentry.st_state = STATE_UNDEFINED;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_progress_command = PROGRESS_COMMAND_INVALID;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_progress_command_target = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_query_id = UINT64CONST(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we don't zero st_progress_param here to save cycles; nobody should<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * examine it until st_progress_command has been set to something other<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * than PROGRESS_COMMAND_INVALID<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We're ready to enter the critical section that fills the shared-memory<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * status entry.&nbsp; We follow the protocol of bumping st_changecount <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and after; and make sure it's even afterwards.&nbsp; We use a volatile<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pointer here to ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(vbeentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* make sure we'll memcpy the same st_changecount back */<br/></li>
<li></span>&nbsp; &nbsp; lbeentry.st_changecount = vbeentry-&gt;st_changecount;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy(unvolatize(PgBackendStatus *, vbeentry),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;lbeentry,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendStatus));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We can write the out-of-line strings and structs using the pointers<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * that are in lbeentry; this saves some de-volatilizing messiness.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; lbeentry.st_appname[<span class="Constant">0</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a> &amp;&amp; <a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>-&gt;remote_hostname)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strlcpy(lbeentry.st_clienthostname, <a href="../init/globals.c.html#L49" title="utils/init/globals.c:49">MyProcPort</a>-&gt;remote_hostname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NAMEDATALEN);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; lbeentry.st_clienthostname[<span class="Constant">0</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_activity_raw[<span class="Constant">0</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Also make sure the last byte in each string area is always 0 */<br/></li>
<li></span>&nbsp; &nbsp; lbeentry.st_appname[NAMEDATALEN - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_clienthostname[NAMEDATALEN - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; lbeentry.st_activity_raw[<a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a> - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; memcpy(lbeentry.st_sslstatus, &amp;lsslstatus, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendSSLStatus));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; memcpy(lbeentry.st_gssstatus, &amp;lgssstatus, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendGSSStatus));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(vbeentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Update app name to current GUC setting */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../misc/guc_tables.c.html#L546" title="utils/misc/guc_tables.c:546">application_name</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L653" title="utils/activity/backend_status.c:653">pgstat_report_appname</a>(<a href="../misc/guc_tables.c.html#L546" title="utils/misc/guc_tables.c:546">application_name</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Clear out our entry in the PgBackendStatus array.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L440">&#x200c;</a></span><span class="linkable">pgstat_beshutdown_hook</span>(<span class="Type">int</span> code, Datum arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry = <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Clear my status entry, following the protocol of bumping st_changecount<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> and after.&nbsp; We use a volatile pointer here to ensure the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(beentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; beentry-&gt;st_procpid = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* mark invalid */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(beentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* so that <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> can check if backend_status.c is up via <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a> */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a> = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Discard <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> data collected in the current transaction.&nbsp; Any subsequent<br/></li>
<li></span><span class="Comment"> * request will cause new snapshots to be read.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is also invoked during transaction commit or abort to discard the<br/></li>
<li></span><span class="Comment"> * no-longer-wanted snapshot.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L467">&#x200c;</a></span><span class="linkable">pgstat_clear_backend_activity_snapshot</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release memory, if <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> was allocated */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L454" title="utils/mmgr/mcxt.c:454">MemoryContextDelete</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Reset variables */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L69" title="utils/activity/backend_status.c:69">localNumBackends</a> = <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L482">&#x200c;</a></span><span class="linkable">pgstat_setup_backend_status_context</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a> = AllocSetContextCreate(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> Status Snapshot&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ALLOCSET_SMALL_SIZES);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L503" title="utils/activity/backend_status.c:503">pgstat_report_activity</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Called from tcop/postgres.c to report what the backend is actually doing<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; (but note cmd_str can be NULL for certain cases).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * All updates of the status entry follow the protocol of bumping<br/></li>
<li></span><span class="Comment"> * st_changecount <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> and after.&nbsp; We use a volatile pointer here to<br/></li>
<li></span><span class="Comment"> * ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L503">&#x200c;</a></span><span class="linkable">pgstat_report_activity</span>(BackendState state, <span class="Type">const</span> <span class="Type">char</span> *cmd_str)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry = <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>;<br/></li>
<li>&nbsp; &nbsp; TimestampTz start_timestamp;<br/></li>
<li>&nbsp; &nbsp; TimestampTz current_timestamp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; TRACE_POSTGRESQL_STATEMENT_STATUS(cmd_str);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!beentry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L44" title="utils/activity/backend_status.c:44">pgstat_track_activities</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (beentry-&gt;st_state != STATE_DISABLED)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">volatile</span> PGPROC *proc = <a href="../../storage/lmgr/proc.c.html#L66" title="storage/lmgr/proc.c:66">MyProc</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * track_activities is disabled, but we last reported a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * non-disabled state.&nbsp; As our final update, change the state and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * clear fields we will not be updating anymore.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(beentry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_state = STATE_DISABLED;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_state_start_timestamp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_activity_raw[<span class="Constant">0</span>] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_activity_start_timestamp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* st_xact_start_timestamp and wait_event_info are also disabled */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_xact_start_timestamp = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_query_id = UINT64CONST(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; proc-&gt;wait_event_info = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(beentry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * To minimize the time spent modifying the entry, and avoid risk of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * errors inside the critical section, fetch all the needed data first.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; start_timestamp = <a href="../../access/transam/xact.c.html#L876" title="access/transam/xact.c:876">GetCurrentStatementStartTimestamp</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cmd_str != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Compute length of to-be-stored string unaware of multi-byte<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * characters. For speed reasons that'll get corrected on read, rather<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * than computed every write.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="../../jit/llvm/llvmjit_inline.cpp.html#L46" title="jit/llvm/llvmjit_inline.cpp:46">Min</a>(strlen(cmd_str), <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a> - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; current_timestamp = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the state has changed from &quot;active&quot; or &quot;idle in transaction&quot;,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * calculate the duration.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((beentry-&gt;st_state == STATE_RUNNING ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; beentry-&gt;st_state == STATE_FASTPATH ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; beentry-&gt;st_state == STATE_IDLEINTRANSACTION ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; beentry-&gt;st_state == STATE_IDLEINTRANSACTION_ABORTED) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state != beentry-&gt;st_state)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span>&nbsp; &nbsp; &nbsp; &nbsp; secs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usecs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../adt/timestamp.c.html#L1730" title="utils/adt/timestamp.c:1730">TimestampDifference</a>(beentry-&gt;st_state_start_timestamp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; current_timestamp,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;secs, &amp;usecs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (beentry-&gt;st_state == STATE_RUNNING ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_state == STATE_FASTPATH)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_count_conn_active_time((PgStat_Counter) secs * <span class="Constant">1000000</span> + usecs);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_count_conn_txn_idle_time((PgStat_Counter) secs * <span class="Constant">1000000</span> + usecs);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Now update the status entry<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(beentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; beentry-&gt;st_state = state;<br/></li>
<li>&nbsp; &nbsp; beentry-&gt;st_state_start_timestamp = current_timestamp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If a new query is started, we reset the query identifier as it'll only<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * be known after <a href="../../regex/regcomp.c.html#L715" title="regex/regcomp.c:715">parse</a> analysis, to avoid reporting last query's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * identifier.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (state == STATE_RUNNING)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_query_id = UINT64CONST(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cmd_str != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy((<span class="Type">char</span> *) beentry-&gt;st_activity_raw, cmd_str, len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_activity_raw[len] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; beentry-&gt;st_activity_start_timestamp = start_timestamp;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(beentry);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* --------<br/></li>
<li></span><span class="Comment"> * <a href="#L613" title="utils/activity/backend_status.c:613">pgstat_report_query_id</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Called to update top-level query identifier.<br/></li>
<li></span><span class="Comment"> * --------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L613">&#x200c;</a></span><span class="linkable">pgstat_report_query_id</span>(uint64 query_id, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> force)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry = <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * if track_activities is disabled, st_query_id should already have been<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * reset<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!beentry || !<a href="#L44" title="utils/activity/backend_status.c:44">pgstat_track_activities</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We only report the top-level query identifiers.&nbsp; The stored query_id is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * reset when a backend calls <a href="#L503" title="utils/activity/backend_status.c:503">pgstat_report_activity</a>(STATE_RUNNING), or<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * with an explicit call to this function using the force flag.&nbsp; If the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * saved query identifier is not zero it means that it's not a top-level<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * command, so ignore the one provided unless it's an explicit call to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * reset the identifier.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (beentry-&gt;st_query_id != <span class="Constant">0</span> &amp;&amp; !force)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Update my status entry, following the protocol of bumping<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * st_changecount <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> and after.&nbsp; We use a volatile pointer here to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(beentry);<br/></li>
<li>&nbsp; &nbsp; beentry-&gt;st_query_id = query_id;<br/></li>
<li>&nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(beentry);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L653" title="utils/activity/backend_status.c:653">pgstat_report_appname</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Called to update our application name.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L653">&#x200c;</a></span><span class="linkable">pgstat_report_appname</span>(<span class="Type">const</span> <span class="Type">char</span> *appname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry = <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!beentry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* This should be unnecessary if GUC did its job, but be safe */<br/></li>
<li></span>&nbsp; &nbsp; len = <a href="../mb/mbutils.c.html#L1083" title="utils/mb/mbutils.c:1083">pg_mbcliplen</a>(appname, strlen(appname), NAMEDATALEN - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Update my status entry, following the protocol of bumping<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * st_changecount <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> and after.&nbsp; We use a volatile pointer here to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(beentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy((<span class="Type">char</span> *) beentry-&gt;st_appname, appname, len);<br/></li>
<li>&nbsp; &nbsp; beentry-&gt;st_appname[len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(beentry);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Report current transaction start timestamp as the specified value.<br/></li>
<li></span><span class="Comment"> * Zero means there is no active transaction.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L682">&#x200c;</a></span><span class="linkable">pgstat_report_xact_timestamp</span>(TimestampTz tstamp)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry = <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L44" title="utils/activity/backend_status.c:44">pgstat_track_activities</a> || !beentry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Update my status entry, following the protocol of bumping<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * st_changecount <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> and after.&nbsp; We use a volatile pointer here to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; PGSTAT_BEGIN_WRITE_ACTIVITY(beentry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; beentry-&gt;st_xact_start_timestamp = tstamp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PGSTAT_END_WRITE_ACTIVITY(beentry);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L709" title="utils/activity/backend_status.c:709">pgstat_read_current_status</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Copy the current contents of the PgBackendStatus array to local memory,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; if not already done in this transaction.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L709">&#x200c;</a></span><span class="linkable">pgstat_read_current_status</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry;<br/></li>
<li>&nbsp; &nbsp; LocalPgBackendStatus *localtable;<br/></li>
<li>&nbsp; &nbsp; LocalPgBackendStatus *localentry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *localappname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *localclienthostname,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *localactivity;<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; PgBackendSSLStatus *localsslstatus;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; PgBackendGSSStatus *localgssstatus;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; ProcNumber&nbsp; &nbsp; procNumber;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* already done */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L482" title="utils/activity/backend_status.c:482">pgstat_setup_backend_status_context</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Allocate storage for local copy of state data.&nbsp; We can presume that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../optimizer/util/predtest.c.html#L1670" title="optimizer/util/predtest.c:1670">none</a> of these requests overflow size_t, because we already calculated<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the same <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> using <a href="../../storage/ipc/shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a> during shmem setup.&nbsp; However, with<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * probably-silly <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> of <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a> and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * max_connections, the localactivity buffer could exceed 1GB, so use<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * &quot;huge&quot; allocation for that one.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; localtable = (LocalPgBackendStatus *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(LocalPgBackendStatus) * <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; localappname = (<span class="Type">char</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NAMEDATALEN * <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; localclienthostname = (<span class="Type">char</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NAMEDATALEN * <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li>&nbsp; &nbsp; localactivity = (<span class="Type">char</span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1639" title="utils/mmgr/mcxt.c:1639">MemoryContextAllocHuge</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (Size) <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a> *<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (Size) <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; localsslstatus = (PgBackendSSLStatus *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendSSLStatus) * <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; localgssstatus = (PgBackendGSSStatus *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L71" title="utils/activity/backend_status.c:71">backendStatusSnapContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendGSSStatus) * <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L69" title="utils/activity/backend_status.c:69">localNumBackends</a> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; beentry = <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>;<br/></li>
<li>&nbsp; &nbsp; localentry = localtable;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (procNumber = <span class="Constant">0</span>; procNumber &lt; <a href="#L37" title="utils/activity/backend_status.c:37">NumBackendStatSlots</a>; procNumber++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Follow the protocol of retrying if st_changecount changes while we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * copy the entry, or if it's odd.&nbsp; (The check for odd is needed to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * cover the case where we are able to completely copy the entry while<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the source backend is between increment steps.)&nbsp; &nbsp; We use a volatile<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * pointer here to ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; before_changecount;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after_changecount;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_begin_read_activity(beentry, before_changecount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;backendStatus.st_procpid = beentry-&gt;st_procpid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Skip all the data-copying work if entry is not in use */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (localentry-&gt;backendStatus.st_procpid &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(&amp;localentry-&gt;backendStatus, unvolatize(PgBackendStatus *, beentry), <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendStatus));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * For each PgBackendStatus field that is a pointer, copy the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * pointed-to data, then adjust the local copy of the pointer<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * field to point at the local copy of the data.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * strcpy is safe even if the string is modified concurrently,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * because there's always a \0 at the end of the buffer.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcpy(localappname, (<span class="Type">char</span> *) beentry-&gt;st_appname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;backendStatus.st_appname = localappname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcpy(localclienthostname, (<span class="Type">char</span> *) beentry-&gt;st_clienthostname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;backendStatus.st_clienthostname = localclienthostname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcpy(localactivity, (<span class="Type">char</span> *) beentry-&gt;st_activity_raw);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;backendStatus.st_activity_raw = localactivity;<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (beentry-&gt;st_ssl)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(localsslstatus, beentry-&gt;st_sslstatus, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendSSLStatus));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;backendStatus.st_sslstatus = localsslstatus;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (beentry-&gt;st_gss)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(localgssstatus, beentry-&gt;st_gssstatus, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgBackendGSSStatus));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;backendStatus.st_gssstatus = localgssstatus;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_end_read_activity(beentry, after_changecount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pgstat_read_activity_complete(before_changecount,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after_changecount))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Make sure we can break out of loop if stuck... */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Only valid entries get included into the local array */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (localentry-&gt;backendStatus.st_procpid &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a> index is exactly the ProcNumber of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * source backend.&nbsp; Note that this means <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * is in order by proc_number. <a href="#L1072" title="utils/activity/backend_status.c:1072">pgstat_get_beentry_by_proc_number</a>()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * depends on that.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry-&gt;proc_number = procNumber;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/procarray.c.html#L3147" title="storage/ipc/procarray.c:3147">ProcNumberGetTransactionIds</a>(procNumber,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;localentry-&gt;backend_xid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;localentry-&gt;backend_xmin,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;localentry-&gt;backend_subxact_count,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;localentry-&gt;backend_subxact_overflowed);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localentry++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localappname += NAMEDATALEN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localclienthostname += NAMEDATALEN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localactivity += <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a>;<br/></li>
<li><span class="PreProc">#ifdef USE_SSL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localsslstatus++;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><span class="PreProc">#ifdef ENABLE_GSS<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localgssstatus++;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L69" title="utils/activity/backend_status.c:69">localNumBackends</a>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; beentry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set the pointer only after completion of a valid table */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a> = localtable;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L885" title="utils/activity/backend_status.c:885">pgstat_get_backend_current_activity</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Return a string representing the current activity of the backend with<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the specified PID.&nbsp; This looks directly at the <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; and so will provide current information regardless of the age of our<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; transaction's snapshot of the status array.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; It is the caller's responsibility to invoke this only for backends whose<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; state is expected to remain stable while the result is in use.&nbsp; The<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; only current use is in deadlock reporting, where we can expect that<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the target backend is blocked on a lock.&nbsp; (There are corner cases<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; where the target's wait could get aborted while we are looking at it,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; but the very worst consequence is to return a pointer to a string<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; that's been changed, so we won't worry too much.)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Note: return strings for special cases match <a href="../adt/pgstatfuncs.c.html#L741" title="utils/adt/pgstatfuncs.c:741">pg_stat_get_backend_activity</a>.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L885">&#x200c;</a><span class="linkable">pgstat_get_backend_current_activity</span>(<span class="Type">int</span> pid, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> checkUser)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PgBackendStatus *beentry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; beentry = <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt;= <a href="../init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a>; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Although we expect the target backend's entry to be stable, that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * doesn't imply that anyone else's is.&nbsp; To avoid identifying the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * wrong backend, while we check for a match to the desired PID we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * must follow the protocol of retrying if st_changecount changes<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * while we examine the entry, or if it's odd.&nbsp; (This might be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * unnecessary, since fetching or storing an int is almost certainly<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * atomic, but let's play it safe.)&nbsp; We use a volatile pointer here to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * ensure the compiler doesn't try to get cute.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *vbeentry = beentry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; before_changecount;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after_changecount;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_begin_read_activity(vbeentry, before_changecount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; found = (vbeentry-&gt;st_procpid == pid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_end_read_activity(vbeentry, after_changecount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pgstat_read_activity_complete(before_changecount,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after_changecount))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Make sure we can break out of loop if stuck... */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Now it is safe to use the non-volatile pointer */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (checkUser &amp;&amp; !<a href="../misc/superuser.c.html#L46" title="utils/misc/superuser.c:46">superuser</a>() &amp;&amp; beentry-&gt;st_userid != <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>())<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;&lt;insufficient privilege&gt;&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (*(beentry-&gt;st_activity_raw) == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;&lt;command string not enabled&gt;&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* this'll leak a <a href="../adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> of memory, but that seems acceptable */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1164" title="utils/activity/backend_status.c:1164">pgstat_clip_activity</a>(beentry-&gt;st_activity_raw);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; beentry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If we get here, caller is in error ... */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;&lt;backend information not available&gt;&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L963" title="utils/activity/backend_status.c:963">pgstat_get_crashed_backend_activity</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Return a string representing the current activity of the backend with<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the specified PID.&nbsp; Like the function above, but reads shared memory with<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the expectation that it may be corrupt.&nbsp; On success, copy the string<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; into the &quot;buffer&quot; argument and return that pointer.&nbsp; On failure,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; return NULL.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; This function is only intended to be used by the postmaster to report the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; query that crashed a backend.&nbsp; In particular, no attempt is made to<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; follow the correct concurrency protocol when accessing the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>.&nbsp; But that's OK, in the worst case we'll return a<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; corrupted message.&nbsp; We also must take care not to trip on ereport(ERROR).<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L963">&#x200c;</a><span class="linkable">pgstat_get_crashed_backend_activity</span>(<span class="Type">int</span> pid, <span class="Type">char</span> *buffer, <span class="Type">int</span> buflen)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">volatile</span> PgBackendStatus *beentry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; beentry = <a href="#L52" title="utils/activity/backend_status.c:52">BackendStatusArray</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We probably shouldn't get here <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> shared memory has been set up,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * but be safe.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (beentry == <span class="Constant">NULL</span> || <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt;= <a href="../init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a>; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (beentry-&gt;st_procpid == pid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Read pointer just once, so it can't change after validation */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *activity = beentry-&gt;st_activity_raw;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *activity_last;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We mustn't access activity string <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> we verify that it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * falls within the <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a>. To make sure that the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * entire string including its ending is contained within the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * buffer, subtract one activity length from the buffer size.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; activity_last = <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a> + <a href="#L56" title="utils/activity/backend_status.c:56">BackendActivityBufferSize</a><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (activity &lt; <a href="#L55" title="utils/activity/backend_status.c:55">BackendActivityBuffer</a> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; activity &gt; activity_last)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* If no string available, no point in a report */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (activity[<span class="Constant">0</span>] == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Copy only ASCII-safe characters so we don't run into encoding<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * problems when reporting the message; and be sure not to run off<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the end of memory.&nbsp; As only ASCII characters are reported, it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * doesn't seem necessary to perform multibyte aware clipping.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../adt/ascii.c.html#L174" title="utils/adt/ascii.c:174">ascii_safe_strlcpy</a>(buffer, activity,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../jit/llvm/llvmjit_inline.cpp.html#L46" title="jit/llvm/llvmjit_inline.cpp:46">Min</a>(buflen, <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> buffer;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; beentry++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* PID not found */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L1027" title="utils/activity/backend_status.c:1027">pgstat_get_my_query_id</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Return current backend's query identifier.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>uint64<br/></li>
<li><a id="L1027">&#x200c;</a><span class="linkable">pgstat_get_my_query_id</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * There's no need for a lock around pgstat_begin_read_activity /<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pgstat_end_read_activity here as it's only called from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../adt/pgstatfuncs.c.html#L303" title="utils/adt/pgstatfuncs.c:303">pg_stat_get_activity</a> which is already protected, or from the same<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * backend which means that there won't be concurrent writes.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L49" title="utils/activity/backend_status.c:49">MyBEEntry</a>-&gt;st_query_id;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L1049" title="utils/activity/backend_status.c:1049">cmp_lbestatus</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Comparison function for bsearch() on an array of LocalPgBackendStatus.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; The proc_number field is used to <a href="../../optimizer/geqo/geqo_pool.c.html#L145" title="optimizer/geqo/geqo_pool.c:145">compare</a> the arguments.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L1049">&#x200c;</a></span><span class="linkable">cmp_lbestatus</span>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> LocalPgBackendStatus *lbestatus1 = (<span class="Type">const</span> LocalPgBackendStatus *) a;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> LocalPgBackendStatus *lbestatus2 = (<span class="Type">const</span> LocalPgBackendStatus *) b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> lbestatus1-&gt;proc_number - lbestatus2-&gt;proc_number;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L1072" title="utils/activity/backend_status.c:1072">pgstat_get_beentry_by_proc_number</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Support function for the SQL-callable pgstat* <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>. Returns<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; our local copy of the current-activity entry for one backend,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; or NULL if the given beid doesn't identify <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> known session.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; The argument is the ProcNumber of the desired session<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; (note that this is unlike <a href="#L1128" title="utils/activity/backend_status.c:1128">pgstat_get_local_beentry_by_index</a>()).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; NB: caller is responsible for a check if the user is permitted to see<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; this info (especially the querystring).<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>PgBackendStatus *<br/></li>
<li><a id="L1072">&#x200c;</a><span class="linkable">pgstat_get_beentry_by_proc_number</span>(ProcNumber procNumber)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LocalPgBackendStatus *ret = <a href="#L1097" title="utils/activity/backend_status.c:1097">pgstat_get_local_beentry_by_proc_number</a>(procNumber);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ret)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> &amp;ret-&gt;backendStatus;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L1097" title="utils/activity/backend_status.c:1097">pgstat_get_local_beentry_by_proc_number</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Like <a href="#L1072" title="utils/activity/backend_status.c:1072">pgstat_get_beentry_by_proc_number</a>() but with locally computed additions<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; (like xid and xmin <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> of the backend)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; The argument is the ProcNumber of the desired session<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; (note that this is unlike <a href="#L1128" title="utils/activity/backend_status.c:1128">pgstat_get_local_beentry_by_index</a>()).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; NB: caller is responsible for checking if the user is permitted to see this<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; info (especially the querystring).<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>LocalPgBackendStatus *<br/></li>
<li><a id="L1097">&#x200c;</a><span class="linkable">pgstat_get_local_beentry_by_proc_number</span>(ProcNumber procNumber)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; LocalPgBackendStatus key;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L709" title="utils/activity/backend_status.c:709">pgstat_read_current_status</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Since the <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a> is in order by proc_number, we can<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * use bsearch() to search it efficiently.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; key.proc_number = procNumber;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> bsearch(&amp;key, <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a>, <a href="#L69" title="utils/activity/backend_status.c:69">localNumBackends</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(LocalPgBackendStatus), <a href="#L1049" title="utils/activity/backend_status.c:1049">cmp_lbestatus</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L1128" title="utils/activity/backend_status.c:1128">pgstat_get_local_beentry_by_index</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Like <a href="#L1072" title="utils/activity/backend_status.c:1072">pgstat_get_beentry_by_proc_number</a>() but with locally computed<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; additions (like xid and xmin <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> of the backend)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; The idx argument is a 1-based index in the <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; (note that this is unlike <a href="#L1072" title="utils/activity/backend_status.c:1072">pgstat_get_beentry_by_proc_number</a>()).<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Returns NULL if the argument is out of <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> (no current caller does that).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; NB: caller is responsible for a check if the user is permitted to see<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; this info (especially the querystring).<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>LocalPgBackendStatus *<br/></li>
<li><a id="L1128">&#x200c;</a><span class="linkable">pgstat_get_local_beentry_by_index</span>(<span class="Type">int</span> idx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L709" title="utils/activity/backend_status.c:709">pgstat_read_current_status</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (idx &lt; <span class="Constant">1</span> || idx &gt; <a href="#L69" title="utils/activity/backend_status.c:69">localNumBackends</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> &amp;<a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a>[idx - <span class="Constant">1</span>];<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L1148" title="utils/activity/backend_status.c:1148">pgstat_fetch_stat_numbackends</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Support function for the SQL-callable pgstat* <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>. Returns<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the number of sessions known in the <a href="#L66" title="utils/activity/backend_status.c:66">localBackendStatusTable</a>, i.e.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the maximum 1-based index to pass to <a href="#L1128" title="utils/activity/backend_status.c:1128">pgstat_get_local_beentry_by_index</a>().<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">int<br/></li>
<li><a id="L1148">&#x200c;</a></span><span class="linkable">pgstat_fetch_stat_numbackends</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L709" title="utils/activity/backend_status.c:709">pgstat_read_current_status</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L69" title="utils/activity/backend_status.c:69">localNumBackends</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Convert a potentially unsafely truncated activity string (see<br/></li>
<li></span><span class="Comment"> * PgBackendStatus.st_activity_raw's documentation) into a correctly truncated<br/></li>
<li></span><span class="Comment"> * one.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The returned string is allocated in the caller's memory context and may be<br/></li>
<li></span><span class="Comment"> * freed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L1164">&#x200c;</a><span class="linkable">pgstat_clip_activity</span>(<span class="Type">const</span> <span class="Type">char</span> *raw_activity)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *activity;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rawlen;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mb/mbutils.c.html#L1150" title="utils/mb/mbutils.c:1150">cliplen</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Some callers, like <a href="#L885" title="utils/activity/backend_status.c:885">pgstat_get_backend_current_activity</a>(), do not<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * guarantee that the buffer isn't concurrently modified. We try to take<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * care that the buffer is always terminated by a NUL byte regardless, but<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * let's still be paranoid about the string's length. In those cases the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * underlying buffer is guaranteed to be <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * large.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; activity = <a href="../mmgr/mcxt.c.html#L1706" title="utils/mmgr/mcxt.c:1706">pnstrdup</a>(raw_activity, <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a> - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> double-guaranteed to be NUL terminated */<br/></li>
<li></span>&nbsp; &nbsp; rawlen = strlen(activity);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * All supported server-encodings make it possible to determine the length<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of a multi-byte character from its first byte (this is not the case for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * client encodings, see GB18030). As st_activity is always stored using<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * server encoding, this allows us to perform multi-byte aware truncation,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * even if the string earlier was truncated in the middle of a multi-byte<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * character.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../mb/mbutils.c.html#L1150" title="utils/mb/mbutils.c:1150">cliplen</a> = <a href="../mb/mbutils.c.html#L1083" title="utils/mb/mbutils.c:1083">pg_mbcliplen</a>(activity, rawlen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L45" title="utils/activity/backend_status.c:45">pgstat_track_activity_query_size</a> - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; activity[<a href="../mb/mbutils.c.html#L1150" title="utils/mb/mbutils.c:1150">cliplen</a>] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> activity;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
