<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/activity/wait_event.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/activity/wait_event.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L89">WaitEventExtensionCounter</a></li>
<li><a href="#L61">WaitEventExtensionHashById</a></li>
<li><a href="#L62">WaitEventExtensionHashByName</a></li>
<li><a href="#L40">local_my_wait_event_info</a></li>
<li><a href="#L41">my_wait_event_info</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L82">WaitEventExtensionCounterData</a></li>
<li><a href="#L86">WaitEventExtensionCounterData</a></li>
<li><a href="#L68">WaitEventExtensionEntryById</a></li>
<li><a href="#L72">WaitEventExtensionEntryById</a></li>
<li><a href="#L74">WaitEventExtensionEntryByName</a></li>
<li><a href="#L78">WaitEventExtensionEntryByName</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L241">GetWaitEventExtensionIdentifier</a></li>
<li><a href="#L271">GetWaitEventExtensionNames</a></li>
<li><a href="#L162">WaitEventExtensionNew</a></li>
<li><a href="#L120">WaitEventExtensionShmemInit</a></li>
<li><a href="#L104">WaitEventExtensionShmemSize</a></li>
<li><a href="#L393">pgstat_get_wait_event</a></li>
<li><a href="#L338">pgstat_get_wait_event_type</a></li>
<li><a href="#L326">pgstat_reset_wait_event_storage</a></li>
<li><a href="#L314">pgstat_set_wait_event_storage</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L92">NUM_BUILTIN_WAIT_EVENT_EXTENSION</a></li>
<li><a href="#L43">WAIT_EVENT_CLASS_MASK</a></li>
<li><a href="#L64">WAIT_EVENT_EXTENSION_HASH_INIT_SIZE</a></li>
<li><a href="#L65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a></li>
<li><a href="#L96">WAIT_EVENT_EXTENSION_INFO</a></li>
<li><a href="#L44">WAIT_EVENT_ID_MASK</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * wait_event.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Wait event reporting infrastructure.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Copyright (c) 2001-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/activity/wait_event.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NOTES<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * To make pgstat_report_wait_start() and pgstat_report_wait_end() as<br/></li>
<li></span><span class="Comment"> * lightweight as possible, they do not check if shared memory (<a href="../../storage/lmgr/proc.c.html#L66" title="storage/lmgr/proc.c:66">MyProc</a><br/></li>
<li></span><span class="Comment"> * specifically, where the wait event is stored) is already available. Instead<br/></li>
<li></span><span class="Comment"> * we initially set <a href="../../storage/lmgr/s_lock.c.html#L70" title="storage/lmgr/s_lock.c:70">my_wait_event_info</a> to a process local variable, which then<br/></li>
<li></span><span class="Comment"> * is redirected to shared memory using <a href="#L314" title="utils/activity/wait_event.c:314">pgstat_set_wait_event_storage</a>(). For<br/></li>
<li></span><span class="Comment"> * the same reason <a href="backend_status.c.html#L44" title="utils/activity/backend_status.c:44">pgstat_track_activities</a> is not checked - the check adds<br/></li>
<li></span><span class="Comment"> * more work than it saves.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;port/pg_bitutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/lmgr.h&quot;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for <a href="../../storage/lmgr/lmgr.c.html#L1340" title="storage/lmgr/lmgr.c:1340">GetLockNameFromTagType</a> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/lwlock.h&quot;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for <a href="../../storage/lmgr/lwlock.c.html#L769" title="storage/lmgr/lwlock.c:769">GetLWLockIdentifier</a> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/spin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/wait_event.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *pgstat_get_wait_activity(WaitEventActivity w);<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *pgstat_get_wait_bufferpin(WaitEventBufferPin w);<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *pgstat_get_wait_client(WaitEventClient w);<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *pgstat_get_wait_ipc(WaitEventIPC w);<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *pgstat_get_wait_timeout(WaitEventTimeout w);<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *pgstat_get_wait_io(WaitEventIO w);<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L40">&#x200c;</a><span class="Type">static</span> uint32 <span class="linkable">local_my_wait_event_info</span>;<br/></li>
<li><a id="L41">&#x200c;</a>uint32&nbsp; &nbsp; &nbsp;&nbsp; *<span class="linkable">my_wait_event_info</span> = &amp;<a href="../../storage/lmgr/s_lock.c.html#L69" title="storage/lmgr/s_lock.c:69">local_my_wait_event_info</a>;<br/></li>
<li><br/></li>
<li><a id="L43">&#x200c;</a><span class="PreProc">#define <span class="linkable">WAIT_EVENT_CLASS_MASK</span>&nbsp; &nbsp; </span><span class="Constant">0xFF000000<br/></li>
<li><a id="L44">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">WAIT_EVENT_ID_MASK</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x0000FFFF<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Hash tables for storing custom wait event ids and their names in<br/></li>
<li></span><span class="Comment"> * shared memory.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L61" title="utils/activity/wait_event.c:61">WaitEventExtensionHashById</a> is used to <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> the name from an event id.<br/></li>
<li></span><span class="Comment"> * Any backend can search it to <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> custom wait events.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a> is used to <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> the event ID from a name.<br/></li>
<li></span><span class="Comment"> * It is used to ensure that no duplicated entries are registered.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The size of the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table is based on the assumption that<br/></li>
<li></span><span class="Comment"> * <a href="#L64" title="utils/activity/wait_event.c:64">WAIT_EVENT_EXTENSION_HASH_INIT_SIZE</a> is enough for most cases, and it seems<br/></li>
<li></span><span class="Comment"> * unlikely that the number of entries will reach<br/></li>
<li></span><span class="Comment"> * <a href="#L65" title="utils/activity/wait_event.c:65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L61">&#x200c;</a></span><span class="Type">static</span> <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a> *<span class="linkable">WaitEventExtensionHashById</span>;&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> names from IDs */<br/></li>
<li><a id="L62">&#x200c;</a></span><span class="Type">static</span> <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a> *<span class="linkable">WaitEventExtensionHashByName</span>;&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> IDs from names */<br/></li>
<li></span><br/></li>
<li><a id="L64">&#x200c;</a><span class="PreProc">#define <span class="linkable">WAIT_EVENT_EXTENSION_HASH_INIT_SIZE</span>&nbsp; &nbsp; </span><span class="Constant">16<br/></li>
<li><a id="L65">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</span>&nbsp; &nbsp; </span><span class="Constant">128<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table entries */<br/></li>
<li><a id="L68">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">WaitEventExtensionEntryById</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint16&nbsp; &nbsp; &nbsp; &nbsp; event_id;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> key */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; wait_event_name[NAMEDATALEN];&nbsp; &nbsp; <span class="Comment">/* custom wait event name */<br/></li>
<li><a id="L72">&#x200c;</a></span>} <span class="linkable">WaitEventExtensionEntryById</span>;<br/></li>
<li><br/></li>
<li><a id="L74">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">WaitEventExtensionEntryByName</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; wait_event_name[NAMEDATALEN];&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> key */<br/></li>
<li></span>&nbsp; &nbsp; uint16&nbsp; &nbsp; &nbsp; &nbsp; event_id;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* wait event ID */<br/></li>
<li><a id="L78">&#x200c;</a></span>} <span class="linkable">WaitEventExtensionEntryByName</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* dynamic allocation counter for custom wait events in extensions */<br/></li>
<li><a id="L82">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">WaitEventExtensionCounterData</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nextId;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> ID to assign */<br/></li>
<li></span>&nbsp; &nbsp; slock_t&nbsp; &nbsp; &nbsp; &nbsp; mutex;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* protects the counter */<br/></li>
<li><a id="L86">&#x200c;</a></span>} <span class="linkable">WaitEventExtensionCounterData</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* pointer to the shared memory */<br/></li>
<li><a id="L89">&#x200c;</a></span><span class="Type">static</span> <a href="#L82" title="utils/activity/wait_event.c:82">WaitEventExtensionCounterData</a> *<span class="linkable">WaitEventExtensionCounter</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* first event ID of custom wait events for extensions */<br/></li>
<li><a id="L92">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">NUM_BUILTIN_WAIT_EVENT_EXTENSION</span>&nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; (WAIT_EVENT_EXTENSION_FIRST_USER_DEFINED - WAIT_EVENT_EXTENSION)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* wait event info for extensions */<br/></li>
<li><a id="L96">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">WAIT_EVENT_EXTENSION_INFO</span>(eventId)&nbsp; &nbsp; (PG_WAIT_EXTENSION | eventId)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<a href="#L241" title="utils/activity/wait_event.c:241">GetWaitEventExtensionIdentifier</a>(uint16 eventId);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; Return the space for dynamic shared <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> tables and dynamic allocation counter.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L104">&#x200c;</a><span class="linkable">WaitEventExtensionShmemSize</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; sz;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sz = MAXALIGN(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L82" title="utils/activity/wait_event.c:82">WaitEventExtensionCounterData</a>));<br/></li>
<li>&nbsp; &nbsp; sz = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(sz, <a href="../hash/dynahash.c.html#L783" title="utils/hash/dynahash.c:783">hash_estimate_size</a>(<a href="#L65" title="utils/activity/wait_event.c:65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L68" title="utils/activity/wait_event.c:68">WaitEventExtensionEntryById</a>)));<br/></li>
<li>&nbsp; &nbsp; sz = <a href="../../storage/ipc/shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(sz, <a href="../hash/dynahash.c.html#L783" title="utils/hash/dynahash.c:783">hash_estimate_size</a>(<a href="#L65" title="utils/activity/wait_event.c:65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a>)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> sz;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Allocate shmem space for dynamic shared <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> and dynamic allocation counter.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L120">&#x200c;</a></span><span class="linkable">WaitEventExtensionShmemInit</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; HASHCTL&nbsp; &nbsp; &nbsp; &nbsp; info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a> = (<a href="#L82" title="utils/activity/wait_event.c:82">WaitEventExtensionCounterData</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/ipc/shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="#L82" title="utils/activity/wait_event.c:82">WaitEventExtensionCounterData</a>&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L82" title="utils/activity/wait_event.c:82">WaitEventExtensionCounterData</a>), &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> the allocation counter and its spinlock. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;nextId = <a href="#L92" title="utils/activity/wait_event.c:92">NUM_BUILTIN_WAIT_EVENT_EXTENSION</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SpinLockInit(&amp;<a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;mutex);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> or attach the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> tables to store custom wait events */<br/></li>
<li></span>&nbsp; &nbsp; info.keysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(uint16);<br/></li>
<li>&nbsp; &nbsp; info.entrysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L68" title="utils/activity/wait_event.c:68">WaitEventExtensionEntryById</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L61" title="utils/activity/wait_event.c:61">WaitEventExtensionHashById</a> = <a href="../../storage/ipc/shmem.c.html#L332" title="storage/ipc/shmem.c:332">ShmemInitHash</a>(<span class="Constant">&quot;WaitEventExtension <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> by id&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L64" title="utils/activity/wait_event.c:64">WAIT_EVENT_EXTENSION_HASH_INIT_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L65" title="utils/activity/wait_event.c:65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;info,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HASH_ELEM | HASH_BLOBS);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* key is a NULL-terminated string */<br/></li>
<li></span>&nbsp; &nbsp; info.keysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">char</span>[NAMEDATALEN]);<br/></li>
<li>&nbsp; &nbsp; info.entrysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a> = <a href="../../storage/ipc/shmem.c.html#L332" title="storage/ipc/shmem.c:332">ShmemInitHash</a>(<span class="Constant">&quot;WaitEventExtension <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> by name&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L64" title="utils/activity/wait_event.c:64">WAIT_EVENT_EXTENSION_HASH_INIT_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L65" title="utils/activity/wait_event.c:65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;info,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HASH_ELEM | HASH_STRINGS);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Allocate a new event ID and return the wait event info.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If the wait event name is already defined, this does not allocate a new<br/></li>
<li></span><span class="Comment"> * entry; it returns the wait event information associated to the name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>uint32<br/></li>
<li><a id="L162">&#x200c;</a><span class="linkable">WaitEventExtensionNew</span>(<span class="Type">const</span> <span class="Type">char</span> *wait_event_name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint16&nbsp; &nbsp; &nbsp; &nbsp; eventId;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a> *entry_by_name;<br/></li>
<li>&nbsp; &nbsp; <a href="#L68" title="utils/activity/wait_event.c:68">WaitEventExtensionEntryById</a> *entry_by_id;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check the limit of the length of the event name */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (strlen(wait_event_name) &gt;= NAMEDATALEN)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;cannot use custom wait event string longer than </span><span class="Special">%u</span><span class="Constant"> characters&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NAMEDATALEN - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check if the wait event info associated to the name is already defined,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and return it if so.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(WaitEventExtensionLock, LW_SHARED);<br/></li>
<li>&nbsp; &nbsp; entry_by_name = (<a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a>, wait_event_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_FIND, &amp;found);<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(WaitEventExtensionLock);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L96" title="utils/activity/wait_event.c:96">WAIT_EVENT_EXTENSION_INFO</a>(entry_by_name-&gt;event_id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Allocate and register a new wait event.&nbsp; Recheck if the event name<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * exists, as it could be possible that a concurrent process has inserted<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * one with the same name since the LWLock acquired again here was<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * previously released.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(WaitEventExtensionLock, LW_EXCLUSIVE);<br/></li>
<li>&nbsp; &nbsp; entry_by_name = (<a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a>, wait_event_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_FIND, &amp;found);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(WaitEventExtensionLock);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L96" title="utils/activity/wait_event.c:96">WAIT_EVENT_EXTENSION_INFO</a>(entry_by_name-&gt;event_id);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Allocate a new event Id */<br/></li>
<li></span>&nbsp; &nbsp; SpinLockAcquire(&amp;<a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;nextId &gt;= <a href="#L65" title="utils/activity/wait_event.c:65">WAIT_EVENT_EXTENSION_HASH_MAX_SIZE</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SpinLockRelease(&amp;<a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;mutex);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_PROGRAM_LIMIT_EXCEEDED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;too many wait events for extensions&quot;</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; eventId = <a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;nextId++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SpinLockRelease(&amp;<a href="#L89" title="utils/activity/wait_event.c:89">WaitEventExtensionCounter</a>-&gt;mutex);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Register the new wait event */<br/></li>
<li></span>&nbsp; &nbsp; entry_by_id = (<a href="#L68" title="utils/activity/wait_event.c:68">WaitEventExtensionEntryById</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L61" title="utils/activity/wait_event.c:61">WaitEventExtensionHashById</a>, &amp;eventId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_ENTER, &amp;found);<br/></li>
<li>&nbsp; &nbsp; Assert(!found);<br/></li>
<li>&nbsp; &nbsp; strlcpy(entry_by_id-&gt;wait_event_name, wait_event_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(entry_by_id-&gt;wait_event_name));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry_by_name = (<a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a>, wait_event_name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_ENTER, &amp;found);<br/></li>
<li>&nbsp; &nbsp; Assert(!found);<br/></li>
<li>&nbsp; &nbsp; entry_by_name-&gt;event_id = eventId;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(WaitEventExtensionLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L96" title="utils/activity/wait_event.c:96">WAIT_EVENT_EXTENSION_INFO</a>(eventId);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Return the name of an wait event ID for extension.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L241">&#x200c;</a><span class="linkable">GetWaitEventExtensionIdentifier</span>(uint16 eventId)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; <a href="#L68" title="utils/activity/wait_event.c:68">WaitEventExtensionEntryById</a> *entry;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Built-in event? */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (eventId &lt; <a href="#L92" title="utils/activity/wait_event.c:92">NUM_BUILTIN_WAIT_EVENT_EXTENSION</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;Extension&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* It is a user-defined wait event, so lookup <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(WaitEventExtensionLock, LW_SHARED);<br/></li>
<li>&nbsp; &nbsp; entry = (<a href="#L68" title="utils/activity/wait_event.c:68">WaitEventExtensionEntryById</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L61" title="utils/activity/wait_event.c:61">WaitEventExtensionHashById</a>, &amp;eventId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_FIND, &amp;found);<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(WaitEventExtensionLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> custom wait event name for ID </span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; eventId);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> entry-&gt;wait_event_name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Returns a list of currently defined custom wait event names for extensions.<br/></li>
<li></span><span class="Comment"> * The result is a <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d array, with the number of elements saved in<br/></li>
<li></span><span class="Comment"> * *nwaitevents.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span>&nbsp; &nbsp; &nbsp; **<br/></li>
<li><a id="L271">&#x200c;</a><span class="linkable">GetWaitEventExtensionNames</span>(<span class="Type">int</span> *nwaitevents)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; **waiteventnames;<br/></li>
<li>&nbsp; &nbsp; <a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a> *hentry;<br/></li>
<li>&nbsp; &nbsp; HASH_SEQ_STATUS hash_seq;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; els;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(WaitEventExtensionLock, LW_SHARED);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Now we can safely count the number of entries */<br/></li>
<li></span>&nbsp; &nbsp; els = <a href="../hash/dynahash.c.html#L1341" title="utils/hash/dynahash.c:1341">hash_get_num_entries</a>(<a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Allocate enough space for all entries */<br/></li>
<li></span>&nbsp; &nbsp; waiteventnames = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(els * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">char</span> *));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Now scan the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table to copy the data */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../hash/dynahash.c.html#L1385" title="utils/hash/dynahash.c:1385">hash_seq_init</a>(&amp;hash_seq, <a href="#L62" title="utils/activity/wait_event.c:62">WaitEventExtensionHashByName</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; index = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((hentry = (<a href="#L74" title="utils/activity/wait_event.c:74">WaitEventExtensionEntryByName</a> *) <a href="../hash/dynahash.c.html#L1395" title="utils/hash/dynahash.c:1395">hash_seq_search</a>(&amp;hash_seq)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; waiteventnames[index] = <a href="../mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(hentry-&gt;wait_event_name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; index++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(WaitEventExtensionLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(index == els);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *nwaitevents = index;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> waiteventnames;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Configure wait event reporting to report wait events to *wait_event_info.<br/></li>
<li></span><span class="Comment"> * *wait_event_info needs to be valid until <a href="#L326" title="utils/activity/wait_event.c:326">pgstat_reset_wait_event_storage</a>()<br/></li>
<li></span><span class="Comment"> * is called.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Expected to be called during backend startup, to point <a href="../../storage/lmgr/s_lock.c.html#L70" title="storage/lmgr/s_lock.c:70">my_wait_event_info</a><br/></li>
<li></span><span class="Comment"> * into shared memory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L314">&#x200c;</a></span><span class="linkable">pgstat_set_wait_event_storage</span>(uint32 *wait_event_info)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/s_lock.c.html#L70" title="storage/lmgr/s_lock.c:70">my_wait_event_info</a> = wait_event_info;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Reset wait event storage location.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Expected to be called during backend shutdown, <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the location set up<br/></li>
<li></span><span class="Comment"> * <a href="#L314" title="utils/activity/wait_event.c:314">pgstat_set_wait_event_storage</a>() becomes invalid.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L326">&#x200c;</a></span><span class="linkable">pgstat_reset_wait_event_storage</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/lmgr/s_lock.c.html#L70" title="storage/lmgr/s_lock.c:70">my_wait_event_info</a> = &amp;<a href="../../storage/lmgr/s_lock.c.html#L69" title="storage/lmgr/s_lock.c:69">local_my_wait_event_info</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L338" title="utils/activity/wait_event.c:338">pgstat_get_wait_event_type</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Return a string representing the current wait event type, backend is<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; <a href="../../storage/ipc/latch.c.html#L162" title="storage/ipc/latch.c:162">waiting</a> on.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L338">&#x200c;</a><span class="linkable">pgstat_get_wait_event_type</span>(uint32 wait_event_info)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; classId;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *event_type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* report process as not <a href="../../storage/ipc/latch.c.html#L162" title="storage/ipc/latch.c:162">waiting</a>. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (wait_event_info == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; classId = wait_event_info &amp; <a href="#L43" title="utils/activity/wait_event.c:43">WAIT_EVENT_CLASS_MASK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (classId)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_LWLOCK:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;LWLock&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_LOCK:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;Lock&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_BUFFERPIN:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;BufferPin&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_ACTIVITY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;Activity&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_CLIENT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;Client&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_EXTENSION:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;Extension&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_IPC:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;IPC&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_TIMEOUT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;Timeout&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_IO:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;IO&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_type = <span class="Constant">&quot;???&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> event_type;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="#L393" title="utils/activity/wait_event.c:393">pgstat_get_wait_event</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Return a string representing the current wait event, backend is<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; <a href="../../storage/ipc/latch.c.html#L162" title="storage/ipc/latch.c:162">waiting</a> on.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L393">&#x200c;</a><span class="linkable">pgstat_get_wait_event</span>(uint32 wait_event_info)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; classId;<br/></li>
<li>&nbsp; &nbsp; uint16&nbsp; &nbsp; &nbsp; &nbsp; eventId;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *event_name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* report process as not <a href="../../storage/ipc/latch.c.html#L162" title="storage/ipc/latch.c:162">waiting</a>. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (wait_event_info == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; classId = wait_event_info &amp; <a href="#L43" title="utils/activity/wait_event.c:43">WAIT_EVENT_CLASS_MASK</a>;<br/></li>
<li>&nbsp; &nbsp; eventId = wait_event_info &amp; <a href="#L44" title="utils/activity/wait_event.c:44">WAIT_EVENT_ID_MASK</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (classId)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_LWLOCK:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = <a href="../../storage/lmgr/lwlock.c.html#L769" title="storage/lmgr/lwlock.c:769">GetLWLockIdentifier</a>(classId, eventId);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_LOCK:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = <a href="../../storage/lmgr/lmgr.c.html#L1340" title="storage/lmgr/lmgr.c:1340">GetLockNameFromTagType</a>(eventId);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_EXTENSION:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = <a href="#L241" title="utils/activity/wait_event.c:241">GetWaitEventExtensionIdentifier</a>(eventId);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_BUFFERPIN:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitEventBufferPin w = (WaitEventBufferPin) wait_event_info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = pgstat_get_wait_bufferpin(w);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_ACTIVITY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitEventActivity w = (WaitEventActivity) wait_event_info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = pgstat_get_wait_activity(w);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_CLIENT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitEventClient w = (WaitEventClient) wait_event_info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = pgstat_get_wait_client(w);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_IPC:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitEventIPC w = (WaitEventIPC) wait_event_info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = pgstat_get_wait_ipc(w);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_TIMEOUT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitEventTimeout w = (WaitEventTimeout) wait_event_info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = pgstat_get_wait_timeout(w);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> PG_WAIT_IO:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WaitEventIO w = (WaitEventIO) wait_event_info;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = pgstat_get_wait_io(w);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event_name = <span class="Constant">&quot;unknown wait event&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> event_name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;pgstat_wait_event.c&quot;<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
