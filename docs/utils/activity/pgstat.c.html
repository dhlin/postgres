<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/activity/pgstat.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/activity/pgstat.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L231">force_stats_snapshot_clear</a></li>
<li><a href="#L225">pgStatForceNextFlush</a></li>
<li><a href="#L193">pgStatLocal</a></li>
<li><a href="#L218">pgStatPending</a></li>
<li><a href="#L210">pgStatPendingContext</a></li>
<li><a href="#L185">pgstat_fetch_consistency</a></li>
<li><a href="#L239">pgstat_is_initialized</a></li>
<li><a href="#L240">pgstat_is_shutdown</a></li>
<li><a href="#L257">pgstat_kind_infos</a></li>
<li><a href="#L184">pgstat_track_counts</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L132">PgStat_SnapshotEntry</a></li>
<li><a href="#L137">PgStat_SnapshotEntry</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L1707">assign_stats_fetch_consistency</a></li>
<li><a href="#L703">match_db_entries</a></li>
<li><a href="#L1277">pgstat_assert_is_up</a></li>
<li><a href="#L462">pgstat_before_server_shutdown</a></li>
<li><a href="#L976">pgstat_build_snapshot</a></li>
<li><a href="#L1064">pgstat_build_snapshot_fixed</a></li>
<li><a href="#L782">pgstat_clear_snapshot</a></li>
<li><a href="#L1156">pgstat_delete_pending_entry</a></li>
<li><a href="#L419">pgstat_discard_stats</a></li>
<li><a href="#L812">pgstat_fetch_entry</a></li>
<li><a href="#L1143">pgstat_fetch_pending_entry</a></li>
<li><a href="#L1180">pgstat_flush_pending_entries</a></li>
<li><a href="#L694">pgstat_force_next_flush</a></li>
<li><a href="#L1242">pgstat_get_kind_from_str</a></li>
<li><a href="#L1263">pgstat_get_kind_info</a></li>
<li><a href="#L905">pgstat_get_stat_snapshot_timestamp</a></li>
<li><a href="#L922">pgstat_have_entry</a></li>
<li><a href="#L537">pgstat_initialize</a></li>
<li><a href="#L1257">pgstat_is_kind_valid</a></li>
<li><a href="#L1105">pgstat_prep_pending_entry</a></li>
<li><a href="#L955">pgstat_prep_snapshot</a></li>
<li><a href="#L1483">pgstat_read_statsfile</a></li>
<li><a href="#L579">pgstat_report_stat</a></li>
<li><a href="#L734">pgstat_reset</a></li>
<li><a href="#L1684">pgstat_reset_after_failure</a></li>
<li><a href="#L715">pgstat_reset_counters</a></li>
<li><a href="#L756">pgstat_reset_of_kind</a></li>
<li><a href="#L407">pgstat_restore_stats</a></li>
<li><a href="#L503">pgstat_shutdown_hook</a></li>
<li><a href="#L938">pgstat_snapshot_fixed</a></li>
<li><a href="#L1308">pgstat_write_statsfile</a></li>
<li><a href="#L1469">read_chunk</a></li>
<li><a href="#L1291">write_chunk</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L121">PGSTAT_IDLE_INTERVAL</a></li>
<li><a href="#L119">PGSTAT_MAX_INTERVAL</a></li>
<li><a href="#L117">PGSTAT_MIN_INTERVAL</a></li>
<li><a href="#L128">PGSTAT_SNAPSHOT_HASH_SIZE</a></li>
<li><a href="#L156">SH_DECLARE</a></li>
<li><a href="#L155">SH_DEFINE</a></li>
<li><a href="#L147">SH_ELEMENT_TYPE</a></li>
<li><a href="#L152">SH_EQUAL</a></li>
<li><a href="#L150">SH_HASH_KEY</a></li>
<li><a href="#L149">SH_KEY</a></li>
<li><a href="#L148">SH_KEY_TYPE</a></li>
<li><a href="#L146">SH_PREFIX</a></li>
<li><a href="#L154">SH_SCOPE</a></li>
<li><a href="#L1474">read_chunk_s</a></li>
<li><a href="#L1301">write_chunk_s</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * pgstat.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Infrastructure for the cumulative statistics system.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The cumulative statistics system accumulates statistics for different kinds<br/></li>
<li></span><span class="Comment"> * of objects. Some kinds of statistics are collected for a fixed number of<br/></li>
<li></span><span class="Comment"> * objects (most commonly 1), e.g., checkpointer statistics. Other kinds of<br/></li>
<li></span><span class="Comment"> * statistics are collected for a varying number of objects<br/></li>
<li></span><span class="Comment"> * (e.g. relations). See PgStat_KindInfo for a list of currently handled<br/></li>
<li></span><span class="Comment"> * statistics.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Statistics are loaded from the filesystem during startup (by the startup<br/></li>
<li></span><span class="Comment"> * process), unless preceded by a crash, in which case all stats are<br/></li>
<li></span><span class="Comment"> * discarded. They are written out by the checkpointer process just <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment"> * shutting down, except when shutting down in immediate mode.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Fixed-numbered stats are stored in plain (non-dynamic) shared memory.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Statistics for variable-numbered objects are stored in dynamic shared<br/></li>
<li></span><span class="Comment"> * memory and can be found via a dshash hashtable. The statistics counters are<br/></li>
<li></span><span class="Comment"> * not part of the dshash entry (PgStatShared_HashEntry) directly, but are<br/></li>
<li></span><span class="Comment"> * separately allocated (PgStatShared_HashEntry-&gt;body). The separate<br/></li>
<li></span><span class="Comment"> * allocation allows different kinds of statistics to be stored in the same<br/></li>
<li></span><span class="Comment"> * hashtable without wasting space in PgStatShared_HashEntry.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Variable-numbered stats are addressed by PgStat_HashKey while running.&nbsp; It<br/></li>
<li></span><span class="Comment"> * is not possible to have statistics for an object that cannot be addressed<br/></li>
<li></span><span class="Comment"> * that way at runtime. A wider identifier can be used when serializing to<br/></li>
<li></span><span class="Comment"> * disk (used for replication slot stats).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * To avoid contention on the shared hashtable, each backend has a<br/></li>
<li></span><span class="Comment"> * backend-local hashtable (<a href="pgstat_shmem.c.html#L82" title="utils/activity/pgstat_shmem.c:82">pgStatEntryRefHash</a>) in front of the shared<br/></li>
<li></span><span class="Comment"> * hashtable, containing references (PgStat_EntryRef) to shared hashtable<br/></li>
<li></span><span class="Comment"> * entries. The shared hashtable only needs to be accessed when no prior<br/></li>
<li></span><span class="Comment"> * reference is found in the local hashtable. Besides pointing to the<br/></li>
<li></span><span class="Comment"> * shared hashtable entry (PgStatShared_HashEntry) PgStat_EntryRef also<br/></li>
<li></span><span class="Comment"> * contains a pointer to the shared statistics data, as a process-local<br/></li>
<li></span><span class="Comment"> * address, to reduce access costs.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The names for structs stored in shared memory are prefixed with<br/></li>
<li></span><span class="Comment"> * PgStatShared instead of PgStat. Each stats entry in shared memory is<br/></li>
<li></span><span class="Comment"> * protected by a dedicated lwlock.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Most stats updates are first accumulated locally in each process as pending<br/></li>
<li></span><span class="Comment"> * entries, then later flushed to shared memory (just after commit, or by<br/></li>
<li></span><span class="Comment"> * idle-timeout). This practically eliminates contention on individual stats<br/></li>
<li></span><span class="Comment"> * entries. For most kinds of variable-numbered pending stats data is stored<br/></li>
<li></span><span class="Comment"> * in PgStat_EntryRef-&gt;pending. All entries with pending data are in the<br/></li>
<li></span><span class="Comment"> * <a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a> list. Pending statistics updates are flushed out by<br/></li>
<li></span><span class="Comment"> * <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>().<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The behavior of different kinds of statistics is determined by the kind's<br/></li>
<li></span><span class="Comment"> * entry in <a href="#L257" title="utils/activity/pgstat.c:257">pgstat_kind_infos</a>, see PgStat_KindInfo for details.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The consistency of read accesses to statistics can be configured using the<br/></li>
<li></span><span class="Comment"> * <a href="../misc/guc_tables.c.html#L258" title="utils/misc/guc_tables.c:258">stats_fetch_consistency</a> GUC (see config.sgml and monitoring.sgml for the<br/></li>
<li></span><span class="Comment"> * settings). When using PGSTAT_FETCH_CONSISTENCY_CACHE or<br/></li>
<li></span><span class="Comment"> * PGSTAT_FETCH_CONSISTENCY_SNAPSHOT statistics are stored in<br/></li>
<li></span><span class="Comment"> * <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * To keep things manageable, stats handling is split across several<br/></li>
<li></span><span class="Comment"> * files. Infrastructure pieces are in:<br/></li>
<li></span><span class="Comment"> * - pgstat.c - this file, to tie it all together<br/></li>
<li></span><span class="Comment"> * - pgstat_shmem.c - nearly everything dealing with shared memory, including<br/></li>
<li></span><span class="Comment"> *&nbsp;&nbsp; the maintenance of hashtable entries<br/></li>
<li></span><span class="Comment"> * - pgstat_xact.c - transactional integration, including the transactional<br/></li>
<li></span><span class="Comment"> *&nbsp;&nbsp; creation and dropping of stats entries<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Each statistics kind is handled in a dedicated file:<br/></li>
<li></span><span class="Comment"> * - pgstat_archiver.c<br/></li>
<li></span><span class="Comment"> * - pgstat_bgwriter.c<br/></li>
<li></span><span class="Comment"> * - pgstat_checkpointer.c<br/></li>
<li></span><span class="Comment"> * - pgstat_database.c<br/></li>
<li></span><span class="Comment"> * - pgstat_function.c<br/></li>
<li></span><span class="Comment"> * - pgstat_io.c<br/></li>
<li></span><span class="Comment"> * - pgstat_relation.c<br/></li>
<li></span><span class="Comment"> * - pgstat_replslot.c<br/></li>
<li></span><span class="Comment"> * - pgstat_slru.c<br/></li>
<li></span><span class="Comment"> * - pgstat_subscription.c<br/></li>
<li></span><span class="Comment"> * - pgstat_wal.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Whenever possible infrastructure files should not contain code related to<br/></li>
<li></span><span class="Comment"> * specific kinds of stats.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Copyright (c) 2001-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/activity/pgstat.c<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/xact.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lib/dshash.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;pgstat.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;port/atomics.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/ipc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/lwlock.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/guc_hooks.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/pgstat_internal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/timestamp.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * Timer definitions.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In milliseconds.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* minimum interval non-forced stats flushes.*/<br/></li>
<li><a id="L117">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PGSTAT_MIN_INTERVAL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">1000<br/></li>
<li></span><span class="Comment">/* how long until to block flushing pending stats updates */<br/></li>
<li><a id="L119">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PGSTAT_MAX_INTERVAL</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">60000<br/></li>
<li></span><span class="Comment">/* when to call <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>() again, even when idle */<br/></li>
<li><a id="L121">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PGSTAT_IDLE_INTERVAL</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">10000<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * Initial size hints for the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> tables used in statistics.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L128">&#x200c;</a><span class="PreProc">#define <span class="linkable">PGSTAT_SNAPSHOT_HASH_SIZE</span>&nbsp; &nbsp; </span><span class="Constant">512<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table for statistics snapshots entry */<br/></li>
<li><a id="L132">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">PgStat_SnapshotEntry</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PgStat_HashKey key;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; status;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for simplehash use */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *data;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* the stats data itself */<br/></li>
<li><a id="L137">&#x200c;</a></span>} <span class="linkable">PgStat_SnapshotEntry</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * <a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a>-local Hash Table Definitions<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* for stats snapshot entries */<br/></li>
<li><a id="L146">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_PREFIX</span> pgstat_snapshot<br/></li>
<li><a id="L147">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_ELEMENT_TYPE</span> <a href="#L132" title="utils/activity/pgstat.c:132">PgStat_SnapshotEntry</a><br/></li>
<li><a id="L148">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_KEY_TYPE</span> PgStat_HashKey<br/></li>
<li><a id="L149">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_KEY</span> key<br/></li>
<li><a id="L150">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_HASH_KEY</span>(tb, key) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; pgstat_hash_hash_key(&amp;key, </span><span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span><span class="PreProc">(PgStat_HashKey), </span><span class="Constant">NULL</span><span class="PreProc">)<br/></li>
<li><a id="L152">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_EQUAL</span>(tb, a, b) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; pgstat_cmp_hash_key(&amp;a, &amp;b, </span><span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span><span class="PreProc">(PgStat_HashKey), </span><span class="Constant">NULL</span><span class="PreProc">) == </span><span class="Constant">0<br/></li>
<li><a id="L154">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_SCOPE</span> </span><span class="Type">static</span><span class="PreProc"> </span><span class="Type">inline<br/></li>
<li><a id="L155">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_DEFINE</span><br/></li>
<li><a id="L156">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">SH_DECLARE</span><br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lib/simplehash.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * Local function forward declarations<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1308" title="utils/activity/pgstat.c:1308">pgstat_write_statsfile</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1483" title="utils/activity/pgstat.c:1483">pgstat_read_statsfile</a>(<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1684" title="utils/activity/pgstat.c:1684">pgstat_reset_after_failure</a>(<span class="Type">void</span>);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L1180" title="utils/activity/pgstat.c:1180">pgstat_flush_pending_entries</a>(<span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> nowait);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L955" title="utils/activity/pgstat.c:955">pgstat_prep_snapshot</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L976" title="utils/activity/pgstat.c:976">pgstat_build_snapshot</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PgStat_Kind kind);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">inline</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L1257" title="utils/activity/pgstat.c:1257">pgstat_is_kind_valid</a>(<span class="Type">int</span> ikind);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * GUC parameters<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L184">&#x200c;</a><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">pgstat_track_counts</span> = <span class="Constant">false</span>;<br/></li>
<li><a id="L185">&#x200c;</a><span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="linkable">pgstat_fetch_consistency</span> = PGSTAT_FETCH_CONSISTENCY_CACHE;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * state shared with pgstat_*.c<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L193">&#x200c;</a>PgStat_LocalState <span class="linkable">pgStatLocal</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ----------<br/></li>
<li></span><span class="Comment"> * Local data<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: There should be only variables related to stats infrastructure here,<br/></li>
<li></span><span class="Comment"> * not for specific kinds of stats.<br/></li>
<li></span><span class="Comment"> * ----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Memory contexts containing the <a href="pgstat_shmem.c.html#L82" title="utils/activity/pgstat_shmem.c:82">pgStatEntryRefHash</a> table, the<br/></li>
<li></span><span class="Comment"> * pgStatSharedRef entries, and pending data respectively. Mostly to make it<br/></li>
<li></span><span class="Comment"> * easier to track / attribute memory usage.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L210">&#x200c;</a><span class="Type">static</span> MemoryContext <span class="linkable">pgStatPendingContext</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> local list of PgStat_EntryRef with unflushed pending stats.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Newly pending entries should only ever be added to the end of the list,<br/></li>
<li></span><span class="Comment"> * otherwise <a href="#L1180" title="utils/activity/pgstat.c:1180">pgstat_flush_pending_entries</a>() might not see them immediately.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L218">&#x200c;</a></span><span class="Type">static</span> dlist_head <span class="linkable">pgStatPending</span> = DLIST_STATIC_INIT(<span class="linkable">pgStatPending</span>);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Force the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> stats flush to happen regardless of<br/></li>
<li></span><span class="Comment"> * <a href="#L117" title="utils/activity/pgstat.c:117">PGSTAT_MIN_INTERVAL</a>. Useful in test scripts.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L225">&#x200c;</a></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <span class="linkable">pgStatForceNextFlush</span> = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Force-clear existing snapshot <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> use when <a href="../misc/guc_tables.c.html#L258" title="utils/misc/guc_tables.c:258">stats_fetch_consistency</a><br/></li>
<li></span><span class="Comment"> * is changed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L231">&#x200c;</a></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <span class="linkable">force_stats_snapshot_clear</span> = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * For assertions that check pgstat is not used <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> initialization / after<br/></li>
<li></span><span class="Comment"> * shutdown.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#ifdef USE_ASSERT_CHECKING<br/></li>
<li><a id="L239">&#x200c;</a></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <span class="linkable">pgstat_is_initialized</span> = <span class="Constant">false</span>;<br/></li>
<li><a id="L240">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <span class="linkable">pgstat_is_shutdown</span> = <span class="Constant">false</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The different kinds of statistics.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If reasonably possible, handling specific to one kind of stats should go<br/></li>
<li></span><span class="Comment"> * through this abstraction, rather than making more of pgstat.c aware.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * See comments for struct PgStat_KindInfo for details about the individual<br/></li>
<li></span><span class="Comment"> * fields.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * </span><span class="Todo">XXX</span><span class="Comment">: It'd be nicer to define this outside of this file. But there doesn't<br/></li>
<li></span><span class="Comment"> * seem to be a great way of doing that, given the split across multiple<br/></li>
<li></span><span class="Comment"> * files.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L257">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> PgStat_KindInfo <span class="linkable">pgstat_kind_infos</span>[PGSTAT_NUM_KINDS] = {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* stats kinds for variable-numbered objects */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_DATABASE] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;database&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">false</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* so pg_stat_database entries can be seen in all databases */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; .accessed_across_databases = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStatShared_Database),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_off = offsetof(PgStatShared_Database, stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_len = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(((PgStatShared_Database *) <span class="Constant">0</span>)-&gt;stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .pending_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStat_StatDBEntry),<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .flush_pending_cb = <a href="pgstat_database.c.html#L375" title="utils/activity/pgstat_database.c:375">pgstat_database_flush_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_timestamp_cb = <a href="pgstat_database.c.html#L438" title="utils/activity/pgstat_database.c:438">pgstat_database_reset_timestamp_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_RELATION] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;relation&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">false</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStatShared_Relation),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_off = offsetof(PgStatShared_Relation, stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_len = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(((PgStatShared_Relation *) <span class="Constant">0</span>)-&gt;stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .pending_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStat_TableStatus),<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .flush_pending_cb = <a href="pgstat_relation.c.html#L802" title="utils/activity/pgstat_relation.c:802">pgstat_relation_flush_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .delete_pending_cb = <a href="pgstat_relation.c.html#L885" title="utils/activity/pgstat_relation.c:885">pgstat_relation_delete_pending_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_FUNCTION] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;function&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">false</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStatShared_Function),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_off = offsetof(PgStatShared_Function, stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_len = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(((PgStatShared_Function *) <span class="Constant">0</span>)-&gt;stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .pending_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStat_FunctionCounts),<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .flush_pending_cb = <a href="pgstat_function.c.html#L193" title="utils/activity/pgstat_function.c:193">pgstat_function_flush_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_REPLSLOT] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;replslot&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">false</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .accessed_across_databases = <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .named_on_disk = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStatShared_ReplSlot),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_off = offsetof(PgStatShared_ReplSlot, stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_len = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(((PgStatShared_ReplSlot *) <span class="Constant">0</span>)-&gt;stats),<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_timestamp_cb = <a href="pgstat_replslot.c.html#L217" title="utils/activity/pgstat_replslot.c:217">pgstat_replslot_reset_timestamp_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .to_serialized_name = <a href="pgstat_replslot.c.html#L188" title="utils/activity/pgstat_replslot.c:188">pgstat_replslot_to_serialized_name_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .from_serialized_name = <a href="pgstat_replslot.c.html#L201" title="utils/activity/pgstat_replslot.c:201">pgstat_replslot_from_serialized_name_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_SUBSCRIPTION] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;subscription&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">false</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* so pg_stat_subscription_stats entries can be seen in all databases */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; .accessed_across_databases = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStatShared_Subscription),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_off = offsetof(PgStatShared_Subscription, stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .shared_data_len = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(((PgStatShared_Subscription *) <span class="Constant">0</span>)-&gt;stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .pending_size = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(PgStat_BackendSubEntry),<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .flush_pending_cb = <a href="pgstat_subscription.c.html#L88" title="utils/activity/pgstat_subscription.c:88">pgstat_subscription_flush_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_timestamp_cb = <a href="pgstat_subscription.c.html#L111" title="utils/activity/pgstat_subscription.c:111">pgstat_subscription_reset_timestamp_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* stats for fixed-numbered (mostly 1) objects */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_ARCHIVER] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;archiver&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_all_cb = <a href="pgstat_archiver.c.html#L66" title="utils/activity/pgstat_archiver.c:66">pgstat_archiver_reset_all_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .snapshot_cb = <a href="pgstat_archiver.c.html#L81" title="utils/activity/pgstat_archiver.c:81">pgstat_archiver_snapshot_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_BGWRITER] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;bgwriter&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_all_cb = <a href="pgstat_bgwriter.c.html#L79" title="utils/activity/pgstat_bgwriter.c:79">pgstat_bgwriter_reset_all_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .snapshot_cb = <a href="pgstat_bgwriter.c.html#L94" title="utils/activity/pgstat_bgwriter.c:94">pgstat_bgwriter_snapshot_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_CHECKPOINTER] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;checkpointer&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_all_cb = <a href="pgstat_checkpointer.c.html#L88" title="utils/activity/pgstat_checkpointer.c:88">pgstat_checkpointer_reset_all_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .snapshot_cb = <a href="pgstat_checkpointer.c.html#L103" title="utils/activity/pgstat_checkpointer.c:103">pgstat_checkpointer_snapshot_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_IO] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;io&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_all_cb = <a href="pgstat_io.c.html#L255" title="utils/activity/pgstat_io.c:255">pgstat_io_reset_all_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .snapshot_cb = <a href="pgstat_io.c.html#L277" title="utils/activity/pgstat_io.c:277">pgstat_io_snapshot_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_SLRU] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;slru&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_all_cb = <a href="pgstat_slru.c.html#L196" title="utils/activity/pgstat_slru.c:196">pgstat_slru_reset_all_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .snapshot_cb = <a href="pgstat_slru.c.html#L203" title="utils/activity/pgstat_slru.c:203">pgstat_slru_snapshot_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [PGSTAT_KIND_WAL] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .name = <span class="Constant">&quot;wal&quot;</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .fixed_amount = <span class="Constant">true</span>,<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .reset_all_cb = <a href="pgstat_wal.c.html#L167" title="utils/activity/pgstat_wal.c:167">pgstat_wal_reset_all_cb</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; .snapshot_cb = <a href="pgstat_wal.c.html#L178" title="utils/activity/pgstat_wal.c:178">pgstat_wal_snapshot_cb</a>,<br/></li>
<li>&nbsp; &nbsp; },<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * Functions managing the state of the stats system for all backends.<br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Read on-disk stats into memory at server start.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Should only be called by the startup process or in single user mode.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L407">&#x200c;</a></span><span class="linkable">pgstat_restore_stats</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L1483" title="utils/activity/pgstat.c:1483">pgstat_read_statsfile</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Remove the stats file.&nbsp; This is currently used only if WAL recovery is<br/></li>
<li></span><span class="Comment"> * needed after a crash.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Should only be called by the startup process or in single user mode.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L419">&#x200c;</a></span><span class="linkable">pgstat_discard_stats</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* NB: this needs to be done even in single user mode */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; ret = unlink(PGSTAT_STAT_PERMANENT_FILENAME);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ret != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (errno == <span class="Constant">ENOENT</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(DEBUG2,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;didn't need to unlink permanent stats file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> - didn't exist&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PGSTAT_STAT_PERMANENT_FILENAME);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not unlink permanent statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGSTAT_STAT_PERMANENT_FILENAME)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(DEBUG2,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1159" title="utils/error/elog.c:1159">errmsg_internal</a>(<span class="Constant">&quot;unlinked permanent statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PGSTAT_STAT_PERMANENT_FILENAME)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Reset stats contents. This will set reset timestamps of fixed-numbered<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * stats to the current time (no variable stats exist).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1684" title="utils/activity/pgstat.c:1684">pgstat_reset_after_failure</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L462" title="utils/activity/pgstat.c:462">pgstat_before_server_shutdown</a>() needs to be called by exactly one process<br/></li>
<li></span><span class="Comment"> * during regular server shutdowns. Otherwise all stats will be lost.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We currently only write out stats for <a href="../../storage/ipc/ipc.c.html#L104" title="storage/ipc/ipc.c:104">proc_exit</a>(0). We might want to change<br/></li>
<li></span><span class="Comment"> * that at some point... But right <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> <a href="#L419" title="utils/activity/pgstat.c:419">pgstat_discard_stats</a>() would be called<br/></li>
<li></span><span class="Comment"> * during the start after a disorderly shutdown, anyway.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L462">&#x200c;</a></span><span class="linkable">pgstat_before_server_shutdown</span>(<span class="Type">int</span> code, Datum arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shmem != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(!<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shmem-&gt;is_shutdown);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Stats should only be reported after <a href="#L537" title="utils/activity/pgstat.c:537">pgstat_initialize</a>() and <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pgstat_shutdown(). This is a convenient point to catch most violations<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of this rule.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="#L239" title="utils/activity/pgstat.c:239">pgstat_is_initialized</a> &amp;&amp; !<a href="#L240" title="utils/activity/pgstat.c:240">pgstat_is_shutdown</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* flush out our own pending changes <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> writing out */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>(<span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Only write out file during normal shutdown. Don't even signal that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we've shutdown during irregular shutdowns, because the shutdown<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * sequence isn't coordinated to ensure this backend shuts down last.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (code == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shmem-&gt;is_shutdown = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1308" title="utils/activity/pgstat.c:1308">pgstat_write_statsfile</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * <a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a> initialization / shutdown <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a><br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Shut down a single backend's statistics reporting at process exit.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Flush out <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> remaining statistics counts.&nbsp; Without this, operations<br/></li>
<li></span><span class="Comment"> * triggered during backend exit (such as temp table deletions) won't be<br/></li>
<li></span><span class="Comment"> * counted.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L503">&#x200c;</a></span><span class="linkable">pgstat_shutdown_hook</span>(<span class="Type">int</span> code, Datum arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(!<a href="#L240" title="utils/activity/pgstat.c:240">pgstat_is_shutdown</a>);<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="../init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a> || !<a href="../init/globals.c.html#L116" title="utils/init/globals.c:116">IsPostmasterEnvironment</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If we got as far as discovering our own database ID, we can flush out<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * what we did so far.&nbsp; Otherwise, we'd be reporting an invalid database<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ID, so forget it.&nbsp; (This means that accesses to pg_database during<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * failed backend starts might never get counted.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (OidIsValid(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="pgstat_database.c.html#L208" title="utils/activity/pgstat_database.c:208">pgstat_report_disconnect</a>(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>(<span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* there shouldn't be <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> pending changes left */<br/></li>
<li></span>&nbsp; &nbsp; Assert(dlist_is_empty(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>));<br/></li>
<li>&nbsp; &nbsp; dlist_init(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L238" title="utils/activity/pgstat_shmem.c:238">pgstat_detach_shmem</a>();<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_ASSERT_CHECKING<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L240" title="utils/activity/pgstat.c:240">pgstat_is_shutdown</a> = <span class="Constant">true</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize pgstats state, and set up our on-proc-exit hook. Called from<br/></li>
<li></span><span class="Comment"> * <a href="../init/postinit.c.html#L645" title="utils/init/postinit.c:645">BaseInit</a>().<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="../../regex/regcomp.c.html#L324" title="regex/regcomp.c:324">NOTE</a>: <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a> isn't set yet; so the shutdown hook has to be careful.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L537">&#x200c;</a></span><span class="linkable">pgstat_initialize</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(!<a href="#L239" title="utils/activity/pgstat.c:239">pgstat_is_initialized</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L218" title="utils/activity/pgstat_shmem.c:218">pgstat_attach_shmem</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_wal.c.html#L141" title="utils/activity/pgstat_wal.c:141">pgstat_init_wal</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set up a process-exit hook to clean up */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/ipc/ipc.c.html#L337" title="storage/ipc/ipc.c:337">before_shmem_exit</a>(<a href="#L503" title="utils/activity/pgstat.c:503">pgstat_shutdown_hook</a>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef USE_ASSERT_CHECKING<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L239" title="utils/activity/pgstat.c:239">pgstat_is_initialized</a> = <span class="Constant">true</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * Public <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> used by backends follow<br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Must be called by processes that performs DML: tcop/postgres.c, logical<br/></li>
<li></span><span class="Comment"> * receiver processes, SPI worker, etc. to flush pending statistics updates to<br/></li>
<li></span><span class="Comment"> * shared memory.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Unless called with 'force', pending stats updates are flushed happen once<br/></li>
<li></span><span class="Comment"> * per <a href="#L117" title="utils/activity/pgstat.c:117">PGSTAT_MIN_INTERVAL</a> (1000ms). When not forced, stats flushes do not<br/></li>
<li></span><span class="Comment"> * block on lock acquisition, except if stats updates have been pending for<br/></li>
<li></span><span class="Comment"> * longer than <a href="#L119" title="utils/activity/pgstat.c:119">PGSTAT_MAX_INTERVAL</a> (60000ms).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Whenever pending stats updates remain at the end of <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>() a<br/></li>
<li></span><span class="Comment"> * suggested idle timeout is returned. Currently this is always<br/></li>
<li></span><span class="Comment"> * <a href="#L121" title="utils/activity/pgstat.c:121">PGSTAT_IDLE_INTERVAL</a> (10000ms). Callers can use the returned time to set up<br/></li>
<li></span><span class="Comment"> * a timeout after which to call <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>(true), but are not<br/></li>
<li></span><span class="Comment"> * required to do so.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that this is called only when not within a transaction, so it is fair<br/></li>
<li></span><span class="Comment"> * to use transaction stop time as an approximation of current time.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">long<br/></li>
<li><a id="L579">&#x200c;</a></span><span class="linkable">pgstat_report_stat</span>(<span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> force)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> TimestampTz pending_since = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> TimestampTz last_flush = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; partial_flush;<br/></li>
<li>&nbsp; &nbsp; TimestampTz <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; nowait;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1277" title="utils/activity/pgstat.c:1277">pgstat_assert_is_up</a>();<br/></li>
<li>&nbsp; &nbsp; Assert(!<a href="../../access/transam/xact.c.html#L4933" title="access/transam/xact.c:4933">IsTransactionOrTransactionBlock</a>());<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* &quot;absorb&quot; the forced flush even if there's nothing to flush */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L225" title="utils/activity/pgstat.c:225">pgStatForceNextFlush</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; force = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L225" title="utils/activity/pgstat.c:225">pgStatForceNextFlush</a> = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Don't expend a clock check if nothing to do */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (dlist_is_empty(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="pgstat_io.c.html#L32" title="utils/activity/pgstat_io.c:32">have_iostats</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="pgstat_slru.c.html#L35" title="utils/activity/pgstat_slru.c:35">have_slrustats</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="pgstat_wal.c.html#L159" title="utils/activity/pgstat_wal.c:159">pgstat_have_pending_wal</a>())<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(pending_since == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * There should never be stats to report once stats are shut down. Can't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * assert that <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the checks above, as there is an unconditional<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>() call in <a href="#L503" title="utils/activity/pgstat.c:503">pgstat_shutdown_hook</a>() - which at least<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the process that ran <a href="#L462" title="utils/activity/pgstat.c:462">pgstat_before_server_shutdown</a>() will still call.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shmem-&gt;is_shutdown);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (force)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Stats reports are forced either when it's been too long since stats<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * have been reported or in processes that force stats reporting to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * happen at specific points (including shutdown). In the former case<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the transaction stop time might be quite old, in the latter it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * would never get cleared.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> = <a href="../../access/transam/xact.c.html#L888" title="access/transam/xact.c:888">GetCurrentTransactionStopTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pending_since &gt; <span class="Constant">0</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../adt/timestamp.c.html#L1790" title="utils/adt/timestamp.c:1790">TimestampDifferenceExceeds</a>(pending_since, <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>, <a href="#L119" title="utils/activity/pgstat.c:119">PGSTAT_MAX_INTERVAL</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* don't keep pending updates longer than <a href="#L119" title="utils/activity/pgstat.c:119">PGSTAT_MAX_INTERVAL</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; force = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (last_flush &gt; <span class="Constant">0</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; !<a href="../adt/timestamp.c.html#L1790" title="utils/adt/timestamp.c:1790">TimestampDifferenceExceeds</a>(last_flush, <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>, <a href="#L117" title="utils/activity/pgstat.c:117">PGSTAT_MIN_INTERVAL</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* don't flush too frequently */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pending_since == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pending_since = <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L121" title="utils/activity/pgstat.c:121">PGSTAT_IDLE_INTERVAL</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_database.c.html#L270" title="utils/activity/pgstat_database.c:270">pgstat_update_dbstats</a>(<a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* don't wait for lock acquisition when !force */<br/></li>
<li></span>&nbsp; &nbsp; nowait = !force;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; partial_flush = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* flush database / relation / function / ... stats */<br/></li>
<li></span>&nbsp; &nbsp; partial_flush |= <a href="#L1180" title="utils/activity/pgstat.c:1180">pgstat_flush_pending_entries</a>(nowait);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* flush IO stats */<br/></li>
<li></span>&nbsp; &nbsp; partial_flush |= <a href="pgstat_io.c.html#L173" title="utils/activity/pgstat_io.c:173">pgstat_flush_io</a>(nowait);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* flush wal stats */<br/></li>
<li></span>&nbsp; &nbsp; partial_flush |= <a href="pgstat_wal.c.html#L82" title="utils/activity/pgstat_wal.c:82">pgstat_flush_wal</a>(nowait);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* flush SLRU stats */<br/></li>
<li></span>&nbsp; &nbsp; partial_flush |= <a href="pgstat_slru.c.html#L156" title="utils/activity/pgstat_slru.c:156">pgstat_slru_flush</a>(nowait);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; last_flush = <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If some of the pending stats could not be flushed due to lock<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * contention, let the caller know when to retry.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (partial_flush)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* force should have prevented us from getting here */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!force);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* remember since when stats have been pending */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pending_since == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pending_since = <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L121" title="utils/activity/pgstat.c:121">PGSTAT_IDLE_INTERVAL</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pending_since = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Force locally pending stats to be flushed during the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a><br/></li>
<li></span><span class="Comment"> * <a href="#L579" title="utils/activity/pgstat.c:579">pgstat_report_stat</a>() call. This is useful for writing tests.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L694">&#x200c;</a></span><span class="linkable">pgstat_force_next_flush</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L225" title="utils/activity/pgstat.c:225">pgStatForceNextFlush</a> = <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Only for use by <a href="#L715" title="utils/activity/pgstat.c:715">pgstat_reset_counters</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L703">&#x200c;</a></span><span class="linkable">match_db_entries</span>(PgStatShared_HashEntry *entry, Datum match_data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> entry-&gt;key.dboid == DatumGetObjectId(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Reset counters for our database.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Permission checking for this function is managed through the normal<br/></li>
<li></span><span class="Comment"> * GRANT system.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L715">&#x200c;</a></span><span class="linkable">pgstat_reset_counters</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L954" title="utils/activity/pgstat_shmem.c:954">pgstat_reset_matching_entries</a>(<a href="#L703" title="utils/activity/pgstat.c:703">match_db_entries</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ObjectIdGetDatum(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ts);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Reset a single variable-numbered entry.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If the stats kind is within a database, also reset the database's<br/></li>
<li></span><span class="Comment"> * stat_reset_timestamp.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Permission checking for this function is managed through the normal<br/></li>
<li></span><span class="Comment"> * GRANT system.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L734">&#x200c;</a></span><span class="linkable">pgstat_reset</span>(PgStat_Kind kind, Oid dboid, Oid objoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not needed atm, and doesn't make sense with the current signature */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!<a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind)-&gt;fixed_amount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* reset the &quot;single counter&quot; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L934" title="utils/activity/pgstat_shmem.c:934">pgstat_reset_entry</a>(kind, dboid, objoid, ts);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!kind_info-&gt;accessed_across_databases)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="pgstat_database.c.html#L354" title="utils/activity/pgstat_database.c:354">pgstat_reset_database_timestamp</a>(dboid, ts);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Reset stats for all entries of a kind.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Permission checking for this function is managed through the normal<br/></li>
<li></span><span class="Comment"> * GRANT system.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L756">&#x200c;</a></span><span class="linkable">pgstat_reset_of_kind</span>(PgStat_Kind kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (kind_info-&gt;fixed_amount)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; kind_info-&gt;reset_all_cb(ts);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="pgstat_shmem.c.html#L990" title="utils/activity/pgstat_shmem.c:990">pgstat_reset_entries_of_kind</a>(kind, ts);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * Fetching of stats<br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Discard <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> data collected in the current transaction.&nbsp; Any subsequent<br/></li>
<li></span><span class="Comment"> * request will cause new snapshots to be read.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is also invoked during transaction commit or abort to discard<br/></li>
<li></span><span class="Comment"> * the no-longer-wanted snapshot.&nbsp; Updates of <a href="../misc/guc_tables.c.html#L258" title="utils/misc/guc_tables.c:258">stats_fetch_consistency</a> can<br/></li>
<li></span><span class="Comment"> * cause this routine to be called.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L782">&#x200c;</a></span><span class="linkable">pgstat_clear_snapshot</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L1277" title="utils/activity/pgstat.c:1277">pgstat_assert_is_up</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid));<br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.mode = PGSTAT_FETCH_CONSISTENCY_NONE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release memory, if <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> was allocated */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L454" title="utils/mmgr/mcxt.c:454">MemoryContextDelete</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Reset variables */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Historically the backend_status.c facilities lived in this file, and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * were reset with the same function. For <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> keep it that way, and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * forward the reset request.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="backend_status.c.html#L467" title="utils/activity/backend_status.c:467">pgstat_clear_backend_activity_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Reset this flag, as it may be possible that a <a href="../../regex/regc_nfa.c.html#L2929" title="regex/regc_nfa.c:2929">cleanup</a> was forced. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L231" title="utils/activity/pgstat.c:231">force_stats_snapshot_clear</a> = <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">void</span> *<br/></li>
<li><a id="L812">&#x200c;</a><span class="linkable">pgstat_fetch_entry</span>(PgStat_Kind kind, Oid dboid, Oid objoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PgStat_HashKey key;<br/></li>
<li>&nbsp; &nbsp; PgStat_EntryRef *entry_ref;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *stats_data;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* should be called from backends */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="../init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a> || !<a href="../init/globals.c.html#L116" title="utils/init/globals.c:116">IsPostmasterEnvironment</a>);<br/></li>
<li>&nbsp; &nbsp; Assert(!kind_info-&gt;fixed_amount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L955" title="utils/activity/pgstat.c:955">pgstat_prep_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; key.kind = kind;<br/></li>
<li>&nbsp; &nbsp; key.dboid = dboid;<br/></li>
<li>&nbsp; &nbsp; key.objoid = objoid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* if we need to build a full snapshot, do so */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_SNAPSHOT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L976" title="utils/activity/pgstat.c:976">pgstat_build_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* if caching is desired, look up in cache */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> &gt; PGSTAT_FETCH_CONSISTENCY_NONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L132" title="utils/activity/pgstat.c:132">PgStat_SnapshotEntry</a> *entry = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry = pgstat_snapshot_lookup(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats, key);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> entry-&gt;data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If we built a full snapshot and the key is not in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats, there are no matching stats.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_SNAPSHOT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.mode = <a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry_ref = <a href="pgstat_shmem.c.html#L398" title="utils/activity/pgstat_shmem.c:398">pgstat_get_entry_ref</a>(kind, dboid, objoid, <span class="Constant">false</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entry_ref == <span class="Constant">NULL</span> || entry_ref-&gt;shared_entry-&gt;dropped)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* create empty entry when using PGSTAT_FETCH_CONSISTENCY_CACHE */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_CACHE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L132" title="utils/activity/pgstat.c:132">PgStat_SnapshotEntry</a> *entry = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry = pgstat_snapshot_insert(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats, key, &amp;found);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(!found);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry-&gt;data = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Allocate in caller's context for PGSTAT_FETCH_CONSISTENCY_NONE,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * otherwise we could quickly end up with a fair <a href="../adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> of memory used due to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * repeated accesses.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_NONE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stats_data = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(kind_info-&gt;shared_data_len);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; stats_data = <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind_info-&gt;shared_data_len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L592" title="utils/activity/pgstat_shmem.c:592">pgstat_lock_entry_shared</a>(entry_ref, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; memcpy(stats_data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pgstat_get_entry_data(kind, entry_ref-&gt;shared_stats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; kind_info-&gt;shared_data_len);<br/></li>
<li>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L604" title="utils/activity/pgstat_shmem.c:604">pgstat_unlock_entry</a>(entry_ref);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> &gt; PGSTAT_FETCH_CONSISTENCY_NONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L132" title="utils/activity/pgstat.c:132">PgStat_SnapshotEntry</a> *entry = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry = pgstat_snapshot_insert(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats, key, &amp;found);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry-&gt;data = stats_data;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> stats_data;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * If a stats snapshot has been taken, return the timestamp at which that was<br/></li>
<li></span><span class="Comment"> * done, and set *have_snapshot to true. Otherwise *have_snapshot is set to<br/></li>
<li></span><span class="Comment"> * false.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>TimestampTz<br/></li>
<li><a id="L905">&#x200c;</a><span class="linkable">pgstat_get_stat_snapshot_timestamp</span>(<span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *have_snapshot)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L231" title="utils/activity/pgstat.c:231">force_stats_snapshot_clear</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L782" title="utils/activity/pgstat.c:782">pgstat_clear_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.mode == PGSTAT_FETCH_CONSISTENCY_SNAPSHOT)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *have_snapshot = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.snapshot_timestamp;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *have_snapshot = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L922">&#x200c;</a></span><span class="linkable">pgstat_have_entry</span>(PgStat_Kind kind, Oid dboid, Oid objoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* fixed-numbered stats always exist */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind)-&gt;fixed_amount)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="pgstat_shmem.c.html#L398" title="utils/activity/pgstat_shmem.c:398">pgstat_get_entry_ref</a>(kind, dboid, objoid, <span class="Constant">false</span>, <span class="Constant">NULL</span>) != <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Ensure snapshot for fixed-numbered 'kind' exists.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Typically used by the pgstat_fetch_* <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> for a kind of stats, <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment"> * massaging the data into the desired format.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L938">&#x200c;</a></span><span class="linkable">pgstat_snapshot_fixed</span>(PgStat_Kind kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L1257" title="utils/activity/pgstat.c:1257">pgstat_is_kind_valid</a>(kind));<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind)-&gt;fixed_amount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L231" title="utils/activity/pgstat.c:231">force_stats_snapshot_clear</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L782" title="utils/activity/pgstat.c:782">pgstat_clear_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_SNAPSHOT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L976" title="utils/activity/pgstat.c:976">pgstat_build_snapshot</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid[kind]);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L955">&#x200c;</a></span><span class="linkable">pgstat_prep_snapshot</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L231" title="utils/activity/pgstat.c:231">force_stats_snapshot_clear</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L782" title="utils/activity/pgstat.c:782">pgstat_clear_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_NONE ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context = AllocSetContextCreate(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;PgStat Snapshot&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ALLOCSET_SMALL_SIZES);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pgstat_snapshot_create(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L128" title="utils/activity/pgstat.c:128">PGSTAT_SNAPSHOT_HASH_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L976">&#x200c;</a></span><span class="linkable">pgstat_build_snapshot</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; dshash_seq_status hstat;<br/></li>
<li>&nbsp; &nbsp; PgStatShared_HashEntry *p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* should only be called when we need a snapshot */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_SNAPSHOT);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* snapshot already built */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.mode == PGSTAT_FETCH_CONSISTENCY_SNAPSHOT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L955" title="utils/activity/pgstat.c:955">pgstat_prep_snapshot</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats-&gt;members == <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.snapshot_timestamp = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Snapshot all variable stats.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../lib/dshash.c.html#L638" title="lib/dshash.c:638">dshash_seq_init</a>(&amp;hstat, <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shared_hash, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((p = <a href="../../lib/dshash.c.html#L657" title="lib/dshash.c:657">dshash_seq_next</a>(&amp;hstat)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgStat_Kind kind = p-&gt;key.kind;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L132" title="utils/activity/pgstat.c:132">PgStat_SnapshotEntry</a> *entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgStatShared_Common *stats_data;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Check if the stats object should be included in the snapshot.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Unless the stats kind can be accessed from all databases (e.g.,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * database stats themselves), we only include stats for the current<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * database or objects not associated with a database (e.g. shared<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * relations).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;key.dboid != <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p-&gt;key.dboid != InvalidOid &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; !kind_info-&gt;accessed_across_databases)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (p-&gt;dropped)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(pg_atomic_read_u32(&amp;p-&gt;refcount) &gt; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; stats_data = <a href="../mmgr/dsa.c.html#L942" title="utils/mmgr/dsa.c:942">dsa_get_address</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.dsa, p-&gt;body);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(stats_data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry = pgstat_snapshot_insert(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.stats, p-&gt;key, &amp;found);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry-&gt;data = <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.context,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; kind_info-&gt;shared_size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Acquire the LWLock directly instead of using<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * pg_stat_lock_entry_shared() which requires a reference.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1170" title="storage/lmgr/lwlock.c:1170">LWLockAcquire</a>(&amp;stats_data-&gt;lock, LW_SHARED);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(entry-&gt;data,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pgstat_get_entry_data(kind, stats_data),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; kind_info-&gt;shared_size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lwlock.c.html#L1783" title="storage/lmgr/lwlock.c:1783">LWLockRelease</a>(&amp;stats_data-&gt;lock);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../lib/dshash.c.html#L747" title="lib/dshash.c:747">dshash_seq_term</a>(&amp;hstat);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Build snapshot of all fixed-numbered stats.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> kind = PGSTAT_KIND_FIRST_VALID; kind &lt;= PGSTAT_KIND_LAST; kind++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!kind_info-&gt;fixed_amount)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(kind_info-&gt;snapshot_cb == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(kind);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.mode = PGSTAT_FETCH_CONSISTENCY_SNAPSHOT;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1064">&#x200c;</a></span><span class="linkable">pgstat_build_snapshot_fixed</span>(PgStat_Kind kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(kind_info-&gt;fixed_amount);<br/></li>
<li>&nbsp; &nbsp; Assert(kind_info-&gt;snapshot_cb != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_NONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rebuild every time */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid[kind] = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid[kind])<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* in snapshot mode we shouldn't get called again */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> == PGSTAT_FETCH_CONSISTENCY_CACHE);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(!<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid[kind]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; kind_info-&gt;snapshot_cb();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(!<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid[kind]);<br/></li>
<li>&nbsp; &nbsp; <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.fixed_valid[kind] = <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * <a href="../../postmaster/postmaster.c.html#L177" title="postmaster/postmaster.c:177">Backend</a>-local pending stats infrastructure<br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Returns the appropriate PgStat_EntryRef, preparing it to receive pending<br/></li>
<li></span><span class="Comment"> * stats if not already done.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If created_entry is non-NULL, it'll be set to true if the entry is newly<br/></li>
<li></span><span class="Comment"> * created, false otherwise.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>PgStat_EntryRef *<br/></li>
<li><a id="L1105">&#x200c;</a><span class="linkable">pgstat_prep_pending_entry</span>(PgStat_Kind kind, Oid dboid, Oid objoid, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *created_entry)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PgStat_EntryRef *entry_ref;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* need to be able to flush out */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind)-&gt;flush_pending_cb != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (unlikely(!<a href="#L210" title="utils/activity/pgstat.c:210">pgStatPendingContext</a>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L210" title="utils/activity/pgstat.c:210">pgStatPendingContext</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AllocSetContextCreate(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;PgStat Pending&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ALLOCSET_SMALL_SIZES);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry_ref = <a href="pgstat_shmem.c.html#L398" title="utils/activity/pgstat_shmem.c:398">pgstat_get_entry_ref</a>(kind, dboid, objoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">true</span>, created_entry);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entry_ref-&gt;pending == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; entrysize = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind)-&gt;pending_size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(entrysize != (<span class="Type">size_t</span>) -<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; entry_ref-&gt;pending = <a href="../mmgr/mcxt.c.html#L1214" title="utils/mmgr/mcxt.c:1214">MemoryContextAllocZero</a>(<a href="#L210" title="utils/activity/pgstat.c:210">pgStatPendingContext</a>, entrysize);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dlist_push_tail(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>, &amp;entry_ref-&gt;pending_node);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> entry_ref;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Return an existing stats entry, or NULL.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This should only be used for helper function for pgstatfuncs.c - outside of<br/></li>
<li></span><span class="Comment"> * that it shouldn't be needed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>PgStat_EntryRef *<br/></li>
<li><a id="L1143">&#x200c;</a><span class="linkable">pgstat_fetch_pending_entry</span>(PgStat_Kind kind, Oid dboid, Oid objoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PgStat_EntryRef *entry_ref;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; entry_ref = <a href="pgstat_shmem.c.html#L398" title="utils/activity/pgstat_shmem.c:398">pgstat_get_entry_ref</a>(kind, dboid, objoid, <span class="Constant">false</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (entry_ref == <span class="Constant">NULL</span> || entry_ref-&gt;pending == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> entry_ref;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L1156">&#x200c;</a></span><span class="linkable">pgstat_delete_pending_entry</span>(PgStat_EntryRef *entry_ref)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; PgStat_Kind kind = entry_ref-&gt;shared_entry-&gt;key.kind;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *pending_data = entry_ref-&gt;pending;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(pending_data != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* !fixed_amount stats should be handled explicitly */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!<a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind)-&gt;fixed_amount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (kind_info-&gt;delete_pending_cb)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; kind_info-&gt;delete_pending_cb(entry_ref);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(pending_data);<br/></li>
<li>&nbsp; &nbsp; entry_ref-&gt;pending = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dlist_delete(&amp;entry_ref-&gt;pending_node);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Flush out pending stats for database objects (databases, relations,<br/></li>
<li></span><span class="Comment"> * <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L1180">&#x200c;</a></span><span class="linkable">pgstat_flush_pending_entries</span>(<span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> nowait)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; have_pending = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; dlist_node *cur = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Need to be a <a href="../adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> careful iterating over the list of pending entries.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Processing a pending entry may queue further pending entries to the end<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of the list that we want to process, so a simple iteration won't do.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Further complicating matters is that we want to delete the current<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * entry in each iteration from the list if we flushed successfully.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * So we just keep track of the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> pointer in each loop iteration.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!dlist_is_empty(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cur = dlist_head_node(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (cur)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgStat_EntryRef *entry_ref =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dlist_container(PgStat_EntryRef, pending_node, cur);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgStat_HashKey key = entry_ref-&gt;shared_entry-&gt;key;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgStat_Kind kind = key.kind;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; did_flush;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dlist_node *<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!kind_info-&gt;fixed_amount);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(kind_info-&gt;flush_pending_cb != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* flush the stats, if possible */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; did_flush = kind_info-&gt;flush_pending_cb(entry_ref, nowait);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(did_flush || nowait);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* determine <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> entry, <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> deleting the pending entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dlist_has_next(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>, cur))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = dlist_next_node(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>, cur);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* if successfully flushed, remove entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (did_flush)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1156" title="utils/activity/pgstat.c:1156">pgstat_delete_pending_entry</a>(entry_ref);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; have_pending = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; cur = <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(dlist_is_empty(&amp;<a href="#L218" title="utils/activity/pgstat.c:218">pgStatPending</a>) == !have_pending);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> have_pending;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * Helper / infrastructure <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a><br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li>PgStat_Kind<br/></li>
<li><a id="L1242">&#x200c;</a><span class="linkable">pgstat_get_kind_from_str</span>(<span class="Type">char</span> *kind_str)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> kind = PGSTAT_KIND_FIRST_VALID; kind &lt;= PGSTAT_KIND_LAST; kind++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_strcasecmp(kind_str, <a href="#L257" title="utils/activity/pgstat.c:257">pgstat_kind_infos</a>[kind].name) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> kind;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid statistics kind: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, kind_str)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> PGSTAT_KIND_DATABASE;&nbsp; &nbsp; <span class="Comment">/* avoid compiler warnings */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">inline</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L1257">&#x200c;</a></span><span class="linkable">pgstat_is_kind_valid</span>(<span class="Type">int</span> ikind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ikind &gt;= PGSTAT_KIND_FIRST_VALID &amp;&amp; ikind &lt;= PGSTAT_KIND_LAST;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">const</span> PgStat_KindInfo *<br/></li>
<li><a id="L1263">&#x200c;</a><span class="linkable">pgstat_get_kind_info</span>(PgStat_Kind kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L1257" title="utils/activity/pgstat.c:1257">pgstat_is_kind_valid</a>(kind));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> &amp;<a href="#L257" title="utils/activity/pgstat.c:257">pgstat_kind_infos</a>[kind];<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Stats should only be reported after <a href="#L537" title="utils/activity/pgstat.c:537">pgstat_initialize</a>() and <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment"> * pgstat_shutdown(). This check is put in a few central places to catch<br/></li>
<li></span><span class="Comment"> * violations of this rule more easily.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#ifdef USE_ASSERT_CHECKING<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L1277">&#x200c;</a></span><span class="linkable">pgstat_assert_is_up</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L239" title="utils/activity/pgstat.c:239">pgstat_is_initialized</a> &amp;&amp; !<a href="#L240" title="utils/activity/pgstat.c:240">pgstat_is_shutdown</a>);<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> * reading and writing of on-disk stats file<br/></li>
<li></span><span class="Comment"> * ------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* helpers for <a href="#L1308" title="utils/activity/pgstat.c:1308">pgstat_write_statsfile</a>() */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1291">&#x200c;</a></span><span class="linkable">write_chunk</span>(<span class="Type">FILE</span> *fpout, <span class="Type">void</span> *ptr, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rc = fwrite(ptr, len, <span class="Constant">1</span>, fpout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* we'll check for errors with ferror once at the end */<br/></li>
<li></span>&nbsp; &nbsp; (<span class="Type">void</span>) rc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1301">&#x200c;</a><span class="PreProc">#define <span class="linkable">write_chunk_s</span>(fpout, ptr) <a href="#L1291" title="utils/activity/pgstat.c:1291">write_chunk</a>(fpout, ptr, </span><span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span><span class="PreProc">(*ptr))<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * This function is called in the last process that is accessing the shared<br/></li>
<li></span><span class="Comment"> * stats so locking is not required.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1308">&#x200c;</a></span><span class="linkable">pgstat_write_statsfile</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">FILE</span>&nbsp; &nbsp; &nbsp;&nbsp; *fpout;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; format_id;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *tmpfile = PGSTAT_STAT_PERMANENT_TMPFILE;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *statfile = PGSTAT_STAT_PERMANENT_FILENAME;<br/></li>
<li>&nbsp; &nbsp; dshash_seq_status hstat;<br/></li>
<li>&nbsp; &nbsp; PgStatShared_HashEntry *ps;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1277" title="utils/activity/pgstat.c:1277">pgstat_assert_is_up</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* we're shutting down, so it's ok to just override this */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> = PGSTAT_FETCH_CONSISTENCY_NONE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; elog(DEBUG2, <span class="Constant">&quot;writing stats file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, statfile);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Open the statistics temp file to write out the current <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; fpout = <a href="../../storage/file/fd.c.html#L2583" title="storage/file/fd.c:2583">AllocateFile</a>(tmpfile, PG_BINARY_W);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fpout == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not open temporary statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpfile)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write the file header --- currently just a format ID.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; format_id = PGSTAT_FILE_FORMAT_ID;<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;format_id);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * </span><span class="Todo">XXX</span><span class="Comment">: The following could <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> be generalized to just iterate over<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L257" title="utils/activity/pgstat.c:257">pgstat_kind_infos</a> instead of knowing about the different kinds of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * stats.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write archiver stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PGSTAT_KIND_ARCHIVER);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.archiver);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write bgwriter stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PGSTAT_KIND_BGWRITER);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.bgwriter);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write checkpointer stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PGSTAT_KIND_CHECKPOINTER);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.checkpointer);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write IO stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PGSTAT_KIND_IO);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.io);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write SLRU stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PGSTAT_KIND_SLRU);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.slru);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write WAL stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L1064" title="utils/activity/pgstat.c:1064">pgstat_build_snapshot_fixed</a>(PGSTAT_KIND_WAL);<br/></li>
<li>&nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.snapshot.wal);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Walk through the stats entries<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../lib/dshash.c.html#L638" title="lib/dshash.c:638">dshash_seq_init</a>(&amp;hstat, <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shared_hash, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((ps = <a href="../../lib/dshash.c.html#L657" title="lib/dshash.c:657">dshash_seq_next</a>(&amp;hstat)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PgStatShared_Common *shstats;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we may have some &quot;dropped&quot; entries not yet removed, <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> them */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!ps-&gt;dropped);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ps-&gt;dropped)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; shstats = (PgStatShared_Common *) <a href="../mmgr/dsa.c.html#L942" title="utils/mmgr/dsa.c:942">dsa_get_address</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.dsa, ps-&gt;body);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(ps-&gt;key.kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* if not dropped the valid-entry refcount should exist */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(pg_atomic_read_u32(&amp;ps-&gt;refcount) &gt; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!kind_info-&gt;to_serialized_name)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* normal stats entry, identified by PgStat_HashKey */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fputc(<span class="Constant">'S'</span>, fpout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;ps-&gt;key);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* stats entry identified by name on disk (e.g. slots) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NameData&nbsp; &nbsp; name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind_info-&gt;to_serialized_name(&amp;ps-&gt;key, shstats, &amp;name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fputc(<span class="Constant">'N'</span>, fpout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;ps-&gt;key.kind);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1301" title="utils/activity/pgstat.c:1301">write_chunk_s</a>(fpout, &amp;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Write except the header part of the entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1291" title="utils/activity/pgstat.c:1291">write_chunk</a>(fpout,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_get_entry_data(ps-&gt;key.kind, shstats),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_get_entry_len(ps-&gt;key.kind));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../lib/dshash.c.html#L747" title="lib/dshash.c:747">dshash_seq_term</a>(&amp;hstat);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * No more output to be done. Close the temp file and replace the old<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pgstat.stat with it.&nbsp; The ferror() check replaces testing for error<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * after each individual fputc or fwrite (in <a href="#L1291" title="utils/activity/pgstat.c:1291">write_chunk</a>()) above.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; fputc(<span class="Constant">'E'</span>, fpout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ferror(fpout))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not write temporary statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpfile)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(fpout);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; unlink(tmpfile);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (<a href="../../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(fpout) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not close temporary statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpfile)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; unlink(tmpfile);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (rename(tmpfile, statfile) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not rename temporary statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> to </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpfile, statfile)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; unlink(tmpfile);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* helpers for <a href="#L1483" title="utils/activity/pgstat.c:1483">pgstat_read_statsfile</a>() */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L1469">&#x200c;</a></span><span class="linkable">read_chunk</span>(<span class="Type">FILE</span> *fpin, <span class="Type">void</span> *ptr, <span class="Type">size_t</span> len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> fread(ptr, <span class="Constant">1</span>, len, fpin) == len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1474">&#x200c;</a><span class="PreProc">#define <span class="linkable">read_chunk_s</span>(fpin, ptr) <a href="#L1469" title="utils/activity/pgstat.c:1469">read_chunk</a>(fpin, ptr, </span><span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span><span class="PreProc">(*ptr))<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Reads in existing statistics file into the shared stats <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This function is called in the only process that is accessing the shared<br/></li>
<li></span><span class="Comment"> * stats so locking is not required.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1483">&#x200c;</a></span><span class="linkable">pgstat_read_statsfile</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">FILE</span>&nbsp; &nbsp; &nbsp;&nbsp; *fpin;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; format_id;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *statfile = PGSTAT_STAT_PERMANENT_FILENAME;<br/></li>
<li>&nbsp; &nbsp; PgStat_ShmemControl *shmem = <a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shmem;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* shouldn't be called from postmaster */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="../init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a> || !<a href="../init/globals.c.html#L116" title="utils/init/globals.c:116">IsPostmasterEnvironment</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; elog(DEBUG2, <span class="Constant">&quot;reading stats file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, statfile);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Try to open the stats file. If it doesn't exist, the backends simply<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * returns zero for anything and statistics simply starts from scratch<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * with empty counters.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ENOENT is a possibility if stats collection was previously disabled or<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * has not yet written the stats file for the first time.&nbsp; Any other<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * failure condition is suspicious.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((fpin = <a href="../../storage/file/fd.c.html#L2583" title="storage/file/fd.c:2583">AllocateFile</a>(statfile, PG_BINARY_R)) == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (errno != <span class="Constant">ENOENT</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not open statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statfile)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1684" title="utils/activity/pgstat.c:1684">pgstat_reset_after_failure</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Verify it's of the expected format.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;format_id) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; format_id != PGSTAT_FILE_FORMAT_ID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * </span><span class="Todo">XXX</span><span class="Comment">: The following could <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> be generalized to just iterate over<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L257" title="utils/activity/pgstat.c:257">pgstat_kind_infos</a> instead of knowing about the different kinds of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * stats.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Read archiver stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;shmem-&gt;archiver.stats))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Read bgwriter stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;shmem-&gt;bgwriter.stats))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Read checkpointer stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;shmem-&gt;checkpointer.stats))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Read IO stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;shmem-&gt;io.stats))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Read SLRU stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;shmem-&gt;slru.stats))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Read WAL stats struct<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;shmem-&gt;wal.stats))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We found an existing statistics file. Read it and put all the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * table entries into place.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t = fgetc(fpin);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (t)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'S'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'N'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgStat_HashKey key;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgStatShared_HashEntry *p;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgStatShared_Common *header;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (t == <span class="Constant">'S'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* normal stats entry, identified by PgStat_HashKey */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;key))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1257" title="utils/activity/pgstat.c:1257">pgstat_is_kind_valid</a>(key.kind))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* stats entry identified by name on disk (e.g. slots) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PgStat_Kind kind;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NameData&nbsp; &nbsp; name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;kind))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1474" title="utils/activity/pgstat.c:1474">read_chunk_s</a>(fpin, &amp;name))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1257" title="utils/activity/pgstat.c:1257">pgstat_is_kind_valid</a>(kind))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!kind_info-&gt;from_serialized_name)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!kind_info-&gt;from_serialized_name(&amp;name, &amp;key))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> over data for entry we don't care about */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fseek(fpin, pgstat_get_entry_len(kind), <span class="Constant">SEEK_CUR</span>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(key.kind == kind);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This intentionally doesn't use <a href="pgstat_shmem.c.html#L398" title="utils/activity/pgstat_shmem.c:398">pgstat_get_entry_ref</a>() -<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * putting all stats into checkpointer's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="pgstat_shmem.c.html#L82" title="utils/activity/pgstat_shmem.c:82">pgStatEntryRefHash</a> would be wasted effort and memory.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = <a href="../../lib/dshash.c.html#L433" title="lib/dshash.c:433">dshash_find_or_insert</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shared_hash, &amp;key, &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* don't allow duplicate entries */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../lib/dshash.c.html#L558" title="lib/dshash.c:558">dshash_release_lock</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shared_hash, p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(WARNING, <span class="Constant">&quot;found duplicate stats entry </span><span class="Special">%d</span><span class="Constant">/</span><span class="Special">%u</span><span class="Constant">/</span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; key.kind, key.dboid, key.objoid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; header = <a href="pgstat_shmem.c.html#L259" title="utils/activity/pgstat_shmem.c:259">pgstat_init_entry</a>(key.kind, p);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../lib/dshash.c.html#L558" title="lib/dshash.c:558">dshash_release_lock</a>(<a href="#L193" title="utils/activity/pgstat.c:193">pgStatLocal</a>.shared_hash, p);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1469" title="utils/activity/pgstat.c:1469">read_chunk</a>(fpin,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_get_entry_data(key.kind, header),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pgstat_get_entry_len(key.kind)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'E'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* check that 'E' actually signals end of file */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fgetc(fpin) != <span class="Constant">EOF</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> error;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="Statement">done</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(fpin);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; elog(DEBUG2, <span class="Constant">&quot;removing permanent stats file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, statfile);<br/></li>
<li>&nbsp; &nbsp; unlink(statfile);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">error</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;corrupted statistics file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, statfile)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1684" title="utils/activity/pgstat.c:1684">pgstat_reset_after_failure</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">goto</span> done;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Helper to reset / drop stats after a crash or after restoring stats from<br/></li>
<li></span><span class="Comment"> * disk failed, potentially after already loading parts.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1684">&#x200c;</a></span><span class="linkable">pgstat_reset_after_failure</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TimestampTz ts = <a href="../adt/timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* reset fixed-numbered stats */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> kind = PGSTAT_KIND_FIRST_VALID; kind &lt;= PGSTAT_KIND_LAST; kind++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> PgStat_KindInfo *kind_info = <a href="#L1263" title="utils/activity/pgstat.c:1263">pgstat_get_kind_info</a>(kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!kind_info-&gt;fixed_amount)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; kind_info-&gt;reset_all_cb(ts);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* and drop variable-numbered ones */<br/></li>
<li></span>&nbsp; &nbsp; <a href="pgstat_shmem.c.html#L896" title="utils/activity/pgstat_shmem.c:896">pgstat_drop_all_entries</a>();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * GUC assign_hook for <a href="../misc/guc_tables.c.html#L258" title="utils/misc/guc_tables.c:258">stats_fetch_consistency</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L1707">&#x200c;</a></span><span class="linkable">assign_stats_fetch_consistency</span>(<span class="Type">int</span> <a href="../misc/guc.c.html#L3703" title="utils/misc/guc.c:3703">newval</a>, <span class="Type">void</span> *extra)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Changing this value in a transaction may cause snapshot state<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * inconsistencies, so force a clear of the current snapshot on the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * snapshot build attempt.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L185" title="utils/activity/pgstat.c:185">pgstat_fetch_consistency</a> != <a href="../misc/guc.c.html#L3703" title="utils/misc/guc.c:3703">newval</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L231" title="utils/activity/pgstat.c:231">force_stats_snapshot_clear</a> = <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
