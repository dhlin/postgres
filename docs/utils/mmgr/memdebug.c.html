<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/mmgr/memdebug.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/mmgr/memdebug.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L75">randomize_mem</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * memdebug.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Declarations used in memory context implementations, not part of the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; public API of the memory management subsystem.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * src/backend/utils/mmgr/memdebug.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; About CLOBBER_FREED_MEMORY:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; If this symbol is defined, all freed memory is overwritten with 0x7F's.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; This is useful for catching places that reference already-freed memory.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; About MEMORY_CONTEXT_CHECKING:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Since we usually round request sizes up to the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> power of 2, there<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; is often some unused space immediately after a requested data area.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Thus, if someone makes the common error of writing past what they've<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; requested, the problem is likely to go unnoticed ... until the day when<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; there *isn't* <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> wasted space, perhaps because of different memory<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; alignment on a new platform, or some other effect.&nbsp; To catch this sort<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; of problem, the MEMORY_CONTEXT_CHECKING option stores 0x7E just beyond<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the requested space whenever the request is less than the actual chunk<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; size, and verifies that the byte is undamaged when the chunk is freed.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; About USE_VALGRIND and Valgrind client requests:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Valgrind provides &quot;client request&quot; macros that exchange information with<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; the host Valgrind (if <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>).&nbsp; Under !USE_VALGRIND, memdebug.h stubs out<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; currently-used macros.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; When running under Valgrind, we want a NOACCESS memory region both <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; and after the allocation.&nbsp; The chunk header is tempting as the preceding<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; region, but mcxt.c expects to able to examine the standard chunk header<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; fields.&nbsp; Therefore, we use, when available, the requested_size field and<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> subsequent padding.&nbsp; requested_size is made NOACCESS <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> returning<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; a chunk pointer to a caller.&nbsp; However, to reduce client request traffic,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; it is kept DEFINED in chunks on the free list.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; The rounded-up capacity of the chunk usually acts as a post-allocation<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; NOACCESS region.&nbsp; If the request consumes precisely the entire chunk,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; there is no such region; another chunk header may immediately follow.&nbsp; In<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; that case, Valgrind will not detect access beyond the end of the chunk.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; See also the cooperating Valgrind client requests in mcxt.c.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;utils/memdebug.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef RANDOMIZE_ALLOCATED_MEMORY<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Fill a just-allocated piece of memory with &quot;random&quot; data.&nbsp; It's not really<br/></li>
<li></span><span class="Comment"> * very random, just a repeating sequence with a length that's prime.&nbsp; What<br/></li>
<li></span><span class="Comment"> * we mainly want out of it is to have a good probability that two <a href="mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'s<br/></li>
<li></span><span class="Comment"> * of the same number of bytes start out containing different data.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The region may be NOACCESS, so make it UNDEFINED first to avoid errors as<br/></li>
<li></span><span class="Comment"> * we fill it.&nbsp; Filling the region makes it DEFINED, so make it UNDEFINED<br/></li>
<li></span><span class="Comment"> * again afterward.&nbsp; Whether to finally make it UNDEFINED or NOACCESS is<br/></li>
<li></span><span class="Comment"> * fairly arbitrary.&nbsp; UNDEFINED is more convenient for <a href="slab.c.html#L826" title="utils/mmgr/slab.c:826">SlabRealloc</a>(), and<br/></li>
<li></span><span class="Comment"> * other callers have no preference.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L75">&#x200c;</a></span><span class="linkable">randomize_mem</span>(<span class="Type">char</span> *ptr, <span class="Type">size_t</span> size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; save_ctr = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; remaining = size;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ctr = save_ctr;<br/></li>
<li>&nbsp; &nbsp; VALGRIND_MAKE_MEM_UNDEFINED(ptr, size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (remaining-- &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *ptr++ = ctr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++ctr &gt; <span class="Constant">251</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctr = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; VALGRIND_MAKE_MEM_UNDEFINED(ptr - size, size);<br/></li>
<li>&nbsp; &nbsp; save_ctr = ctr;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* RANDOMIZE_ALLOCATED_MEMORY */<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
