<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/adt/jsonb.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/adt/jsonb.c - pgsql17devel-backend</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L36">JsonbAggState</a></li>
<li><a href="#L43">JsonbAggState</a></li>
<li><a href="#L28">JsonbInState</a></li>
<li><a href="#L34">JsonbInState</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L159">JsonbContainerTypeName</a></li>
<li><a href="#L1968">JsonbExtractScalar</a></li>
<li><a href="#L473">JsonbToCString</a></li>
<li><a href="#L482">JsonbToCStringIndent</a></li>
<li><a href="#L491">JsonbToCStringWorker</a></li>
<li><a href="#L180">JsonbTypeName</a></li>
<li><a href="#L2166">JsonbUnquote</a></li>
<li><a href="#L615">add_indent</a></li>
<li><a href="#L1016">add_jsonb</a></li>
<li><a href="#L862">array_dim_to_jsonb</a></li>
<li><a href="#L894">array_to_jsonb_internal</a></li>
<li><a href="#L2008">cannotCastJsonbValue</a></li>
<li><a href="#L277">checkStringLen</a></li>
<li><a href="#L1471">clone_parse_state</a></li>
<li><a href="#L942">composite_to_jsonb</a></li>
<li><a href="#L1112">datum_to_jsonb</a></li>
<li><a href="#L638">datum_to_jsonb_internal</a></li>
<li><a href="#L1640">jsonb_agg_finalfn</a></li>
<li><a href="#L1634">jsonb_agg_strict_transfn</a></li>
<li><a href="#L1625">jsonb_agg_transfn</a></li>
<li><a href="#L1501">jsonb_agg_transfn_worker</a></li>
<li><a href="#L2038">jsonb_bool</a></li>
<li><a href="#L1237">jsonb_build_array</a></li>
<li><a href="#L1258">jsonb_build_array_noargs</a></li>
<li><a href="#L1210">jsonb_build_array_worker</a></li>
<li><a href="#L1177">jsonb_build_object</a></li>
<li><a href="#L1197">jsonb_build_object_noargs</a></li>
<li><a href="#L1125">jsonb_build_object_worker</a></li>
<li><a href="#L2127">jsonb_float4</a></li>
<li><a href="#L2145">jsonb_float8</a></li>
<li><a href="#L248">jsonb_from_cstring</a></li>
<li><a href="#L147">jsonb_from_text</a></li>
<li><a href="#L73">jsonb_in</a></li>
<li><a href="#L321">jsonb_in_array_end</a></li>
<li><a href="#L311">jsonb_in_array_start</a></li>
<li><a href="#L301">jsonb_in_object_end</a></li>
<li><a href="#L331">jsonb_in_object_field_start</a></li>
<li><a href="#L290">jsonb_in_object_start</a></li>
<li><a href="#L379">jsonb_in_scalar</a></li>
<li><a href="#L2073">jsonb_int2</a></li>
<li><a href="#L2091">jsonb_int4</a></li>
<li><a href="#L2109">jsonb_int8</a></li>
<li><a href="#L2052">jsonb_numeric</a></li>
<li><a href="#L1279">jsonb_object</a></li>
<li><a href="#L1930">jsonb_object_agg_finalfn</a></li>
<li><a href="#L1906">jsonb_object_agg_strict_transfn</a></li>
<li><a href="#L1896">jsonb_object_agg_transfn</a></li>
<li><a href="#L1673">jsonb_object_agg_transfn_worker</a></li>
<li><a href="#L1924">jsonb_object_agg_unique_strict_transfn</a></li>
<li><a href="#L1915">jsonb_object_agg_unique_transfn</a></li>
<li><a href="#L1379">jsonb_object_two_arg</a></li>
<li><a href="#L108">jsonb_out</a></li>
<li><a href="#L349">jsonb_put_escaped_value</a></li>
<li><a href="#L89">jsonb_recv</a></li>
<li><a href="#L124">jsonb_send</a></li>
<li><a href="#L229">jsonb_typeof</a></li>
<li><a href="#L1088">to_jsonb</a></li>
<li><a href="#L1049">to_jsonb_is_immutable</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * jsonb.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; I/O routines for jsonb type<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Copyright (c) 2014-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/adt/jsonb.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/htup_details.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_proc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_type.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;funcapi.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;libpq/pqformat.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/json.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/jsonb.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/jsonfuncs.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/lsyscache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/typcache.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L28">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">JsonbInState</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonbParseState *parseState;<br/></li>
<li>&nbsp; &nbsp; JsonbValue *res;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; unique_keys;<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *escontext;<br/></li>
<li><a id="L34">&#x200c;</a>} <span class="linkable">JsonbInState</span>;<br/></li>
<li><br/></li>
<li><a id="L36">&#x200c;</a><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">JsonbAggState</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *res;<br/></li>
<li>&nbsp; &nbsp; JsonTypeCategory key_category;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key_output_func;<br/></li>
<li>&nbsp; &nbsp; JsonTypeCategory val_category;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val_output_func;<br/></li>
<li><a id="L43">&#x200c;</a>} <span class="linkable">JsonbAggState</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">inline</span> Datum <a href="#L248" title="utils/adt/jsonb.c:248">jsonb_from_cstring</a>(<span class="Type">char</span> *json, <span class="Type">int</span> len, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> unique_keys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Node *escontext);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L277" title="utils/adt/jsonb.c:277">checkStringLen</a>(<span class="Type">size_t</span> len, Node *escontext);<br/></li>
<li><span class="Type">static</span> JsonParseErrorType <a href="#L290" title="utils/adt/jsonb.c:290">jsonb_in_object_start</a>(<span class="Type">void</span> *pstate);<br/></li>
<li><span class="Type">static</span> JsonParseErrorType <a href="#L301" title="utils/adt/jsonb.c:301">jsonb_in_object_end</a>(<span class="Type">void</span> *pstate);<br/></li>
<li><span class="Type">static</span> JsonParseErrorType <a href="#L311" title="utils/adt/jsonb.c:311">jsonb_in_array_start</a>(<span class="Type">void</span> *pstate);<br/></li>
<li><span class="Type">static</span> JsonParseErrorType <a href="#L321" title="utils/adt/jsonb.c:321">jsonb_in_array_end</a>(<span class="Type">void</span> *pstate);<br/></li>
<li><span class="Type">static</span> JsonParseErrorType <a href="#L331" title="utils/adt/jsonb.c:331">jsonb_in_object_field_start</a>(<span class="Type">void</span> *pstate, <span class="Type">char</span> *fname, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isnull);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L349" title="utils/adt/jsonb.c:349">jsonb_put_escaped_value</a>(StringInfo out, JsonbValue *scalarVal);<br/></li>
<li><span class="Type">static</span> JsonParseErrorType <a href="#L379" title="utils/adt/jsonb.c:379">jsonb_in_scalar</a>(<span class="Type">void</span> *pstate, <span class="Type">char</span> *token, JsonTokenType tokentype);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L942" title="utils/adt/jsonb.c:942">composite_to_jsonb</a>(Datum composite, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L862" title="utils/adt/jsonb.c:862">array_dim_to_jsonb</a>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result, <span class="Type">int</span> dim, <span class="Type">int</span> ndims, <span class="Type">int</span> *dims,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> Datum *vals, <span class="Type">const</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *nulls, <span class="Type">int</span> *valcount,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; JsonTypeCategory tcategory, Oid outfuncoid);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L894" title="utils/adt/jsonb.c:894">array_to_jsonb_internal</a>(Datum array, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(Datum val, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> is_null, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonTypeCategory tcategory, Oid outfuncoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> key_scalar);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1016" title="utils/adt/jsonb.c:1016">add_jsonb</a>(Datum val, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> is_null, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid val_type, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> key_scalar);<br/></li>
<li><span class="Type">static</span> JsonbParseState *<a href="#L1471" title="utils/adt/jsonb.c:1471">clone_parse_state</a>(JsonbParseState *state);<br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<a href="#L491" title="utils/adt/jsonb.c:491">JsonbToCStringWorker</a>(StringInfo out, JsonbContainer *in, <span class="Type">int</span> estimated_len, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> indent);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(StringInfo out, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> indent, <span class="Type">int</span> level);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb type input function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L73">&#x200c;</a><span class="linkable">jsonb_in</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *json = PG_GETARG_CSTRING(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L248" title="utils/adt/jsonb.c:248">jsonb_from_cstring</a>(json, strlen(json), <span class="Constant">false</span>, fcinfo-&gt;context);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb type <a href="../../port/win32/socket.c.html#L37" title="port/win32/socket.c:37">recv</a> function<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The type is sent as text in binary mode, so this is almost the same<br/></li>
<li></span><span class="Comment"> * as the input function, but it's prefixed with a version number so we<br/></li>
<li></span><span class="Comment"> * can change the binary format sent in future if necessary. For <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>,<br/></li>
<li></span><span class="Comment"> * only version 1 is supported.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L89">&#x200c;</a><span class="linkable">jsonb_recv</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; StringInfo&nbsp; &nbsp; buf = (StringInfo) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; version = <a href="../../libpq/pqformat.c.html#L415" title="libpq/pqformat.c:415">pq_getmsgint</a>(buf, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *str;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbytes;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (version == <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; str = <a href="../../libpq/pqformat.c.html#L546" title="libpq/pqformat.c:546">pq_getmsgtext</a>(buf, buf-&gt;len - buf-&gt;cursor, &amp;nbytes);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unsupported jsonb version number </span><span class="Special">%d</span><span class="Constant">&quot;</span>, version);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L248" title="utils/adt/jsonb.c:248">jsonb_from_cstring</a>(str, nbytes, <span class="Constant">false</span>, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb type output function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L108">&#x200c;</a><span class="linkable">jsonb_out</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *jb = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <a href="#L473" title="utils/adt/jsonb.c:473">JsonbToCString</a>(<span class="Constant">NULL</span>, &amp;jb-&gt;root, VARSIZE(jb));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_CSTRING(out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb type <a href="../../port/win32/socket.c.html#L38" title="port/win32/socket.c:38">send</a> function<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Just <a href="../../port/win32/socket.c.html#L38" title="port/win32/socket.c:38">send</a> jsonb as a version number, then a string of text<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L124">&#x200c;</a><span class="linkable">jsonb_send</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *jb = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; StringInfoData buf;<br/></li>
<li>&nbsp; &nbsp; StringInfo&nbsp; &nbsp; jtext = makeStringInfo();<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; version = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L473" title="utils/adt/jsonb.c:473">JsonbToCString</a>(jtext, &amp;jb-&gt;root, VARSIZE(jb));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../libpq/pqformat.c.html#L326" title="libpq/pqformat.c:326">pq_begintypsend</a>(&amp;buf);<br/></li>
<li>&nbsp; &nbsp; pq_sendint8(&amp;buf, version);<br/></li>
<li>&nbsp; &nbsp; <a href="../../libpq/pqformat.c.html#L172" title="libpq/pqformat.c:172">pq_sendtext</a>(&amp;buf, jtext-&gt;data, jtext-&gt;len);<br/></li>
<li>&nbsp; &nbsp; destroyStringInfo(jtext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BYTEA_P(<a href="../../libpq/pqformat.c.html#L346" title="libpq/pqformat.c:346">pq_endtypsend</a>(&amp;buf));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L147" title="utils/adt/jsonb.c:147">jsonb_from_text</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Turns json text string into a jsonb Datum.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L147">&#x200c;</a><span class="linkable">jsonb_from_text</span>(text *js, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> unique_keys)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L248" title="utils/adt/jsonb.c:248">jsonb_from_cstring</a>(VARDATA_ANY(js),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VARSIZE_ANY_EXHDR(js),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unique_keys,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get the type name of a jsonb container.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L159">&#x200c;</a><span class="linkable">JsonbContainerTypeName</span>(JsonbContainer *jbc)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; scalar;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(jbc, &amp;scalar))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L180" title="utils/adt/jsonb.c:180">JsonbTypeName</a>(&amp;scalar);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (JsonContainerIsArray(jbc))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;array&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (JsonContainerIsObject(jbc))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;object&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;invalid jsonb container type: 0x</span><span class="Special">%08x</span><span class="Constant">&quot;</span>, jbc-&gt;header);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;unknown&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get the type name of a jsonb value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L180">&#x200c;</a><span class="linkable">JsonbTypeName</span>(JsonbValue *val)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (val-&gt;type)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvBinary:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L159" title="utils/adt/jsonb.c:159">JsonbContainerTypeName</a>(val-&gt;val.binary.data);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvObject:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;object&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvArray:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;array&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvNumeric:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;number&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvString:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;string&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvBool:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;boolean&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvNull:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;null&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvDatetime:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (val-&gt;val.datetime.typid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> DATEOID:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;date&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> TIMEOID:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;time without time zone&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> TIMETZOID:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;time with time zone&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> TIMESTAMPOID:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;timestamp without time zone&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> TIMESTAMPTZOID:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;timestamp with time zone&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized jsonb value datetime type: </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; val-&gt;val.datetime.typid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;unknown&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized jsonb value type: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, val-&gt;type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;unknown&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL function <a href="#L229" title="utils/adt/jsonb.c:229">jsonb_typeof</a>(jsonb) -&gt; text<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This function is here because the analog json function is in json.c, since<br/></li>
<li></span><span class="Comment"> * it uses the json parser internals not exposed elsewhere.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L229">&#x200c;</a><span class="linkable">jsonb_typeof</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *result = <a href="#L159" title="utils/adt/jsonb.c:159">JsonbContainerTypeName</a>(&amp;in-&gt;root);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_TEXT_P(<a href="varlena.c.html#L184" title="utils/adt/varlena.c:184">cstring_to_text</a>(result));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L248" title="utils/adt/jsonb.c:248">jsonb_from_cstring</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Turns json string into a jsonb Datum.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Uses the json parser (with hooks) to construct a jsonb.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If escontext points to an ErrorSaveContext, errors are reported there<br/></li>
<li></span><span class="Comment"> * instead of being thrown.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">inline</span> Datum<br/></li>
<li><a id="L248">&#x200c;</a><span class="linkable">jsonb_from_cstring</span>(<span class="Type">char</span> *json, <span class="Type">int</span> len, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> unique_keys, Node *escontext)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonLexContext lex;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> state;<br/></li>
<li>&nbsp; &nbsp; JsonSemAction sem;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;state, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(state));<br/></li>
<li>&nbsp; &nbsp; memset(&amp;sem, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(sem));<br/></li>
<li>&nbsp; &nbsp; makeJsonLexContextCstringLen(&amp;lex, json, len, <a href="../mb/mbutils.c.html#L1261" title="utils/mb/mbutils.c:1261">GetDatabaseEncoding</a>(), <span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; state.unique_keys = unique_keys;<br/></li>
<li>&nbsp; &nbsp; state.escontext = escontext;<br/></li>
<li>&nbsp; &nbsp; sem.semstate = (<span class="Type">void</span> *) &amp;state;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; sem.object_start = <a href="#L290" title="utils/adt/jsonb.c:290">jsonb_in_object_start</a>;<br/></li>
<li>&nbsp; &nbsp; sem.array_start = <a href="#L311" title="utils/adt/jsonb.c:311">jsonb_in_array_start</a>;<br/></li>
<li>&nbsp; &nbsp; sem.object_end = <a href="#L301" title="utils/adt/jsonb.c:301">jsonb_in_object_end</a>;<br/></li>
<li>&nbsp; &nbsp; sem.array_end = <a href="#L321" title="utils/adt/jsonb.c:321">jsonb_in_array_end</a>;<br/></li>
<li>&nbsp; &nbsp; sem.scalar = <a href="#L379" title="utils/adt/jsonb.c:379">jsonb_in_scalar</a>;<br/></li>
<li>&nbsp; &nbsp; sem.object_field_start = <a href="#L331" title="utils/adt/jsonb.c:331">jsonb_in_object_field_start</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="jsonfuncs.c.html#L516" title="utils/adt/jsonfuncs.c:516">pg_parse_json_or_errsave</a>(&amp;lex, &amp;sem, escontext))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (Datum) <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* after parsing, the item member has the composed jsonb structure */<br/></li>
<li></span>&nbsp; &nbsp; PG_RETURN_POINTER(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(state.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L277">&#x200c;</a></span><span class="linkable">checkStringLen</span>(<span class="Type">size_t</span> len, Node *escontext)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (len &gt; JENTRY_OFFLENMASK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">false</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_PROGRAM_LIMIT_EXCEEDED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;string too long to represent as jsonb string&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1205" title="utils/error/elog.c:1205">errdetail</a>(<span class="Constant">&quot;Due to an implementation restriction, jsonb strings cannot exceed </span><span class="Special">%d</span><span class="Constant"> bytes.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; JENTRY_OFFLENMASK)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> JsonParseErrorType<br/></li>
<li><a id="L290">&#x200c;</a><span class="linkable">jsonb_in_object_start</span>(<span class="Type">void</span> *pstate)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *_state = (<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *) pstate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; _state-&gt;parseState-&gt;unique_keys = _state-&gt;unique_keys;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JSON_SUCCESS;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> JsonParseErrorType<br/></li>
<li><a id="L301">&#x200c;</a><span class="linkable">jsonb_in_object_end</span>(<span class="Type">void</span> *pstate)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *_state = (<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *) pstate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JSON_SUCCESS;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> JsonParseErrorType<br/></li>
<li><a id="L311">&#x200c;</a><span class="linkable">jsonb_in_array_start</span>(<span class="Type">void</span> *pstate)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *_state = (<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *) pstate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_BEGIN_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JSON_SUCCESS;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> JsonParseErrorType<br/></li>
<li><a id="L321">&#x200c;</a><span class="linkable">jsonb_in_array_end</span>(<span class="Type">void</span> *pstate)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *_state = (<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *) pstate;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JSON_SUCCESS;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> JsonParseErrorType<br/></li>
<li><a id="L331">&#x200c;</a><span class="linkable">jsonb_in_object_field_start</span>(<span class="Type">void</span> *pstate, <span class="Type">char</span> *fname, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isnull)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *_state = (<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *) pstate;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(fname != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; v.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; v.val.string.len = strlen(fname);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L277" title="utils/adt/jsonb.c:277">checkStringLen</a>(v.val.string.len, _state-&gt;escontext))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> JSON_SEM_ACTION_FAILED;<br/></li>
<li>&nbsp; &nbsp; v.val.string.val = fname;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_KEY, &amp;v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JSON_SUCCESS;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L349">&#x200c;</a></span><span class="linkable">jsonb_put_escaped_value</span>(StringInfo out, JsonbValue *scalarVal)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (scalarVal-&gt;type)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvNull:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;null&quot;</span>, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvString:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="json.c.html#L1549" title="utils/adt/json.c:1549">escape_json</a>(out, <a href="../mmgr/mcxt.c.html#L1706" title="utils/mmgr/mcxt.c:1706">pnstrdup</a>(scalarVal-&gt;val.string.val, scalarVal-&gt;val.string.len));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvNumeric:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(out,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; DatumGetCString(DirectFunctionCall1(<a href="numeric.c.html#L807" title="utils/adt/numeric.c:807">numeric_out</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PointerGetDatum(scalarVal-&gt;val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>))));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvBool:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (scalarVal-&gt;val.boolean)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;true&quot;</span>, <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;false&quot;</span>, <span class="Constant">5</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unknown jsonb scalar type&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * For jsonb we always want the de-escaped value - that's what's in token<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> JsonParseErrorType<br/></li>
<li><a id="L379">&#x200c;</a><span class="linkable">jsonb_in_scalar</span>(<span class="Type">void</span> *pstate, <span class="Type">char</span> *token, JsonTokenType tokentype)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *_state = (<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *) pstate;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; numd;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (tokentype)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSON_TOKEN_STRING:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(token != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.len = strlen(token);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L277" title="utils/adt/jsonb.c:277">checkStringLen</a>(v.val.string.len, _state-&gt;escontext))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> JSON_SEM_ACTION_FAILED;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = token;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSON_TOKEN_NUMBER:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * No need to check size of <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, because maximum<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> size is well below the JsonbValue restriction<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(token != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvNumeric;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../fmgr/fmgr.c.html#L1640" title="utils/fmgr/fmgr.c:1640">DirectInputFunctionCallSafe</a>(<a href="numeric.c.html#L628" title="utils/adt/numeric.c:628">numeric_in</a>, token,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; InvalidOid, -<span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; _state-&gt;escontext,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;numd))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> JSON_SEM_ACTION_FAILED;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> = DatumGetNumeric(numd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSON_TOKEN_TRUE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvBool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.boolean = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSON_TOKEN_FALSE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvBool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.boolean = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSON_TOKEN_NULL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvNull;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* should not be possible */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;invalid json token type&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (_state-&gt;parseState == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* single scalar */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue&nbsp; &nbsp; va;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; va.type = jbvArray;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; va.val.array.rawScalar = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; va.val.array.nElems = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_BEGIN_ARRAY, &amp;va);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_ELEM, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue *o = &amp;_state-&gt;parseState-&gt;contVal;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (o-&gt;type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvArray:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_ELEM, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvObject:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _state-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;_state-&gt;parseState, WJB_VALUE, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unexpected parent of nested structure&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JSON_SUCCESS;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L473" title="utils/adt/jsonb.c:473">JsonbToCString</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp;&nbsp; Converts jsonb value to a C-string.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If 'out' argument is non-null, the resulting C-string is stored inside the<br/></li>
<li></span><span class="Comment"> * StringBuffer.&nbsp; The resulting string is always returned.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * A typical case for passing the StringInfo in rather than NULL is where the<br/></li>
<li></span><span class="Comment"> * caller wants access to the len attribute without having to call strlen, e.g.<br/></li>
<li></span><span class="Comment"> * if they are converting it to a text* object.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L473">&#x200c;</a><span class="linkable">JsonbToCString</span>(StringInfo out, JsonbContainer *in, <span class="Type">int</span> estimated_len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L491" title="utils/adt/jsonb.c:491">JsonbToCStringWorker</a>(out, in, estimated_len, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * same thing but with indentation turned on<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L482">&#x200c;</a><span class="linkable">JsonbToCStringIndent</span>(StringInfo out, JsonbContainer *in, <span class="Type">int</span> estimated_len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L491" title="utils/adt/jsonb.c:491">JsonbToCStringWorker</a>(out, in, estimated_len, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * common worker for above two <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a><br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L491">&#x200c;</a><span class="linkable">JsonbToCStringWorker</span>(StringInfo out, JsonbContainer *in, <span class="Type">int</span> estimated_len, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> indent)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; JsonbIterator *it;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; JsonbIteratorToken type = WJB_DONE;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; redo_switch = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If we are indenting, don't add a space after a comma */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ispaces = indent ? <span class="Constant">1</span> : <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Don't indent the very first item. This gets set to the indent flag at<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the bottom of the loop.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; use_indent = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; raw_scalar = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; last_was_key = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (out == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; out = makeStringInfo();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; enlargeStringInfo(out, (estimated_len &gt;= <span class="Constant">0</span>) ? estimated_len : <span class="Constant">64</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; it = <a href="jsonb_util.c.html#L817" title="utils/adt/jsonb_util.c:817">JsonbIteratorInit</a>(in);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (redo_switch ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ((type = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;v, <span class="Constant">false</span>)) != WJB_DONE))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; redo_switch = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!first)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;, &quot;</span>, ispaces);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!v.val.array.rawScalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(out, use_indent &amp;&amp; !last_was_key, level);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoCharMacro(out, <span class="Constant">'['</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raw_scalar = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_OBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!first)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;, &quot;</span>, ispaces);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(out, use_indent &amp;&amp; !last_was_key, level);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoCharMacro(out, <span class="Constant">'{'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_KEY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!first)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;, &quot;</span>, ispaces);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(out, use_indent, level);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* json rules guarantee this is a string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L349" title="utils/adt/jsonb.c:349">jsonb_put_escaped_value</a>(out, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;: &quot;</span>, <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;v, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == WJB_VALUE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L349" title="utils/adt/jsonb.c:349">jsonb_put_escaped_value</a>(out, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(type == WJB_BEGIN_OBJECT || type == WJB_BEGIN_ARRAY);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We need to rerun the current switch() since we need to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * output the object which we just got from the iterator<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> calling the iterator again.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; redo_switch = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_ELEM:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!first)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendBinaryStringInfo(out, <span class="Constant">&quot;, &quot;</span>, ispaces);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!raw_scalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(out, use_indent, level);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L349" title="utils/adt/jsonb.c:349">jsonb_put_escaped_value</a>(out, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!raw_scalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(out, use_indent, level);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoCharMacro(out, <span class="Constant">']'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_OBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; level--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/jsonb.c:615">add_indent</a>(out, use_indent, level);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoCharMacro(out, <span class="Constant">'}'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; first = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unknown jsonb iterator token type&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; use_indent = indent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; last_was_key = redo_switch;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(level == <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> out-&gt;data;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L615">&#x200c;</a></span><span class="linkable">add_indent</span>(StringInfo out, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> indent, <span class="Type">int</span> level)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (indent)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoCharMacro(out, <span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoSpaces(out, level * <span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Turn a Datum into jsonb, adding it to the result <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * tcategory and outfuncoid are from a previous call to <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>,<br/></li>
<li></span><span class="Comment"> * except that if is_null is true then they can be invalid.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If key_scalar is true, the value is stored as a key, so insist<br/></li>
<li></span><span class="Comment"> * it's of an acceptable type, and force it to be a jbvString.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: currently, we assume that result-&gt;escontext is NULL and errors<br/></li>
<li></span><span class="Comment"> * will be thrown.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L638">&#x200c;</a></span><span class="linkable">datum_to_jsonb_internal</span>(Datum val, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> is_null, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonTypeCategory tcategory, Oid outfuncoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> key_scalar)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *outputstr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; numeric_error;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; jb;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; scalar_jsonb = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../tcop/postgres.c.html#L3531" title="tcop/postgres.c:3531">check_stack_depth</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Convert val to a JsonbValue in jb (in most cases) */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (is_null)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!key_scalar);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvNull;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (key_scalar &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (tcategory == JSONTYPE_ARRAY ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcategory == JSONTYPE_COMPOSITE ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcategory == JSONTYPE_JSON ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcategory == JSONTYPE_JSONB ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcategory == JSONTYPE_JSON))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;key value must be scalar, not array, composite, or json&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tcategory == JSONTYPE_CAST)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val = OidFunctionCall1(outfuncoid, val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (tcategory)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L894" title="utils/adt/jsonb.c:894">array_to_jsonb_internal</a>(val, result);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_COMPOSITE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L942" title="utils/adt/jsonb.c:942">composite_to_jsonb</a>(val, result);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_BOOL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key_scalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outputstr = DatumGetBool(val) ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(outputstr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = outputstr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvBool;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.boolean = DatumGetBool(val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_NUMERIC:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outputstr = <a href="../fmgr/fmgr.c.html#L1763" title="utils/fmgr/fmgr.c:1763">OidOutputFunctionCall</a>(outfuncoid, val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key_scalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* always quote keys */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(outputstr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = outputstr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Make it <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> if it's a valid JSON number, otherwise<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * a string. Invalid <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> output will always have an<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * 'N' or 'n' in it (I think).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numeric_error = (strchr(outputstr, <span class="Constant">'N'</span>) != <span class="Constant">NULL</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; strchr(outputstr, <span class="Constant">'n'</span>) != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!numeric_error)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; numd;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvNumeric;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numd = DirectFunctionCall3(<a href="numeric.c.html#L628" title="utils/adt/numeric.c:628">numeric_in</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; CStringGetDatum(outputstr),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ObjectIdGetDatum(InvalidOid),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Int32GetDatum(-<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> = DatumGetNumeric(numd);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(outputstr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(outputstr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = outputstr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_DATE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = <a href="json.c.html#L301" title="utils/adt/json.c:301">JsonEncodeDateTime</a>(<span class="Constant">NULL</span>, val,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; DATEOID, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(jb.val.string.val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_TIMESTAMP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = <a href="json.c.html#L301" title="utils/adt/json.c:301">JsonEncodeDateTime</a>(<span class="Constant">NULL</span>, val,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TIMESTAMPOID, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(jb.val.string.val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_TIMESTAMPTZ:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = <a href="json.c.html#L301" title="utils/adt/json.c:301">JsonEncodeDateTime</a>(<span class="Constant">NULL</span>, val,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TIMESTAMPTZOID, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(jb.val.string.val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_CAST:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_JSON:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regcomp.c.html#L715" title="regex/regcomp.c:715">parse</a> the json right into the existing result object */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonLexContext lex;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonSemAction sem;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *json = DatumGetTextPP(val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="jsonfuncs.c.html#L537" title="utils/adt/jsonfuncs.c:537">makeJsonLexContext</a>(&amp;lex, json, <span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memset(&amp;sem, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(sem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.semstate = (<span class="Type">void</span> *) result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.object_start = <a href="#L290" title="utils/adt/jsonb.c:290">jsonb_in_object_start</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.array_start = <a href="#L311" title="utils/adt/jsonb.c:311">jsonb_in_array_start</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.object_end = <a href="#L301" title="utils/adt/jsonb.c:301">jsonb_in_object_end</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.array_end = <a href="#L321" title="utils/adt/jsonb.c:321">jsonb_in_array_end</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.scalar = <a href="#L379" title="utils/adt/jsonb.c:379">jsonb_in_scalar</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sem.object_field_start = <a href="#L331" title="utils/adt/jsonb.c:331">jsonb_in_object_field_start</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_parse_json_or_ereport(&amp;lex, &amp;sem);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; freeJsonLexContext(&amp;lex);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_JSONB:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *jsonb = DatumGetJsonbP(val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonbIterator *it;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; it = <a href="jsonb_util.c.html#L817" title="utils/adt/jsonb_util.c:817">JsonbIteratorInit</a>(&amp;jsonb-&gt;root);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (JB_ROOT_IS_SCALAR(jsonb))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;jb, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(jb.type == jbvArray);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;jb, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scalar_jsonb = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; JsonbIteratorToken type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> ((type = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;jb, <span class="Constant">false</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; != WJB_DONE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == WJB_END_ARRAY || type == WJB_END_OBJECT ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type == WJB_BEGIN_ARRAY || type == WJB_BEGIN_OBJECT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, &amp;jb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outputstr = <a href="../fmgr/fmgr.c.html#L1763" title="utils/fmgr/fmgr.c:1763">OidOutputFunctionCall</a>(outfuncoid, val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.len = strlen(outputstr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L277" title="utils/adt/jsonb.c:277">checkStringLen</a>(jb.val.string.len, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb.val.string.val = outputstr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Now insert jb into result, unless we did it recursively */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!is_null &amp;&amp; !scalar_jsonb &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcategory &gt;= JSONTYPE_JSON &amp;&amp; tcategory &lt;= JSONTYPE_CAST)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* work has been done recursively */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (result-&gt;parseState == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* single root scalar */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue&nbsp; &nbsp; va;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; va.type = jbvArray;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; va.val.array.rawScalar = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; va.val.array.nElems = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_BEGIN_ARRAY, &amp;va);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_ELEM, &amp;jb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue *o = &amp;result-&gt;parseState-&gt;contVal;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (o-&gt;type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvArray:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_ELEM, &amp;jb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> jbvObject:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; key_scalar ? WJB_KEY : WJB_VALUE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;jb);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unexpected parent of nested structure&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Process a single dimension of an array.<br/></li>
<li></span><span class="Comment"> * If it's the innermost dimension, output the <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, otherwise call<br/></li>
<li></span><span class="Comment"> * ourselves recursively to process the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> dimension.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L862">&#x200c;</a></span><span class="linkable">array_dim_to_jsonb</span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result, <span class="Type">int</span> dim, <span class="Type">int</span> ndims, <span class="Type">int</span> *dims, <span class="Type">const</span> Datum *vals,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *nulls, <span class="Type">int</span> *valcount, JsonTypeCategory tcategory,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Oid outfuncoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(dim &lt; ndims);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_BEGIN_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">1</span>; i &lt;= dims[dim]; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dim + <span class="Constant">1</span> == ndims)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(vals[*valcount], nulls[*valcount], result, tcategory,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*valcount)++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L862" title="utils/adt/jsonb.c:862">array_dim_to_jsonb</a>(result, dim + <span class="Constant">1</span>, ndims, dims, vals, nulls,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; valcount, tcategory, outfuncoid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Turn an array into JSON.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L894">&#x200c;</a></span><span class="linkable">array_to_jsonb_internal</span>(Datum array, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *v = DatumGetArrayTypeP(array);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; element_type = ARR_ELEMTYPE(v);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *dim;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndim;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nitems;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *elements;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp;&nbsp; *nulls;<br/></li>
<li>&nbsp; &nbsp; int16&nbsp; &nbsp; &nbsp; &nbsp; typlen;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; typbyval;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; typalign;<br/></li>
<li>&nbsp; &nbsp; JsonTypeCategory tcategory;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ndim = ARR_NDIM(v);<br/></li>
<li>&nbsp; &nbsp; dim = ARR_DIMS(v);<br/></li>
<li>&nbsp; &nbsp; nitems = <a href="arrayutils.c.html#L57" title="utils/adt/arrayutils.c:57">ArrayGetNItems</a>(ndim, dim);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nitems &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_BEGIN_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../cache/lsyscache.c.html#L2271" title="utils/cache/lsyscache.c:2271">get_typlenbyvalalign</a>(element_type,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;typlen, &amp;typbyval, &amp;typalign);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(element_type, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;tcategory, &amp;outfuncoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="arrayfuncs.c.html#L3612" title="utils/adt/arrayfuncs.c:3612">deconstruct_array</a>(v, element_type, typlen, typbyval,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typalign, &amp;elements, &amp;nulls,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;nitems);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L862" title="utils/adt/jsonb.c:862">array_dim_to_jsonb</a>(result, <span class="Constant">0</span>, ndim, dim, elements, nulls, &amp;count, tcategory,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; outfuncoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(elements);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(nulls);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Turn a composite / record into JSON.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L942">&#x200c;</a></span><span class="linkable">composite_to_jsonb</span>(Datum composite, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HeapTupleHeader td;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tupType;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; tupTypmod;<br/></li>
<li>&nbsp; &nbsp; TupleDesc&nbsp; &nbsp; tupdesc;<br/></li>
<li>&nbsp; &nbsp; HeapTupleData tmptup,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tuple;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; td = DatumGetHeapTupleHeader(composite);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Extract rowtype info and <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> a tupdesc */<br/></li>
<li></span>&nbsp; &nbsp; tupType = HeapTupleHeaderGetTypeId(td);<br/></li>
<li>&nbsp; &nbsp; tupTypmod = HeapTupleHeaderGetTypMod(td);<br/></li>
<li>&nbsp; &nbsp; tupdesc = <a href="../cache/typcache.c.html#L1833" title="utils/cache/typcache.c:1833">lookup_rowtype_tupdesc</a>(tupType, tupTypmod);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Build a temporary HeapTuple control structure */<br/></li>
<li></span>&nbsp; &nbsp; tmptup.t_len = HeapTupleHeaderGetDatumLength(td);<br/></li>
<li>&nbsp; &nbsp; tmptup.t_data = td;<br/></li>
<li>&nbsp; &nbsp; tuple = &amp;tmptup;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; tupdesc-&gt;natts; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isnull;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *attname;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonTypeCategory tcategory;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_attribute att = TupleDescAttr(tupdesc, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (att-&gt;attisdropped)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; attname = NameStr(att-&gt;attname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvString;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* don't need <a href="#L277" title="utils/adt/jsonb.c:277">checkStringLen</a> here - can't exceed maximum name length */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; v.val.string.len = strlen(attname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = attname;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_KEY, &amp;v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; val = heap_getattr(tuple, i + <span class="Constant">1</span>, tupdesc, &amp;isnull);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tcategory = JSONTYPE_NULL;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(att-&gt;atttypid, <span class="Constant">true</span>, &amp;tcategory,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;outfuncoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(val, isnull, result, tcategory, outfuncoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState, WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; ReleaseTupleDesc(tupdesc);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Append JSON text for &quot;val&quot; to &quot;result&quot;.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is just a thin wrapper around <a href="#L1112" title="utils/adt/jsonb.c:1112">datum_to_jsonb</a>.&nbsp; If the same type will be<br/></li>
<li></span><span class="Comment"> * printed many times, avoid using this; better to do the <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a><br/></li>
<li></span><span class="Comment"> * lookups only once.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1016">&#x200c;</a></span><span class="linkable">add_jsonb</span>(Datum val, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> is_null, <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid val_type, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> key_scalar)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonTypeCategory tcategory;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val_type == InvalidOid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not determine input data type&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_null)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tcategory = JSONTYPE_NULL;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; outfuncoid = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(val_type, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;tcategory, &amp;outfuncoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(val, is_null, result, tcategory, outfuncoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key_scalar);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Is the given type immutable when coming out of a JSONB context?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * At present, datetimes are all considered mutable, because they<br/></li>
<li></span><span class="Comment"> * depend on timezone.&nbsp; </span><span class="Todo">XXX</span><span class="Comment"> we should also drill down into objects and<br/></li>
<li></span><span class="Comment"> * arrays, but do not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L1049">&#x200c;</a></span><span class="linkable">to_jsonb_is_immutable</span>(Oid typoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonTypeCategory tcategory;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(typoid, <span class="Constant">true</span>, &amp;tcategory, &amp;outfuncoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (tcategory)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_NULL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_BOOL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_JSON:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_JSONB:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_DATE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_TIMESTAMP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_TIMESTAMPTZ:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> recurse into elements */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_COMPOSITE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">TODO</span><span class="Comment"> recurse into fields */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_NUMERIC:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_CAST:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> JSONTYPE_OTHER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../cache/lsyscache.c.html#L1780" title="utils/cache/lsyscache.c:1780">func_volatile</a>(outfuncoid) == PROVOLATILE_IMMUTABLE;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* not reached */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL function <a href="#L1088" title="utils/adt/jsonb.c:1088">to_jsonb</a>(anyvalue)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1088">&#x200c;</a><span class="linkable">to_jsonb</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; val = PG_GETARG_DATUM(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val_type = <a href="../fmgr/fmgr.c.html#L1910" title="utils/fmgr/fmgr.c:1910">get_fn_expr_argtype</a>(fcinfo-&gt;flinfo, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonTypeCategory tcategory;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; outfuncoid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (val_type == InvalidOid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not determine input data type&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(val_type, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;tcategory, &amp;outfuncoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(<a href="#L1112" title="utils/adt/jsonb.c:1112">datum_to_jsonb</a>(val, tcategory, outfuncoid));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Turn a Datum into jsonb.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * tcategory and outfuncoid are from a previous call to <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1112">&#x200c;</a><span class="linkable">datum_to_jsonb</span>(Datum val, JsonTypeCategory tcategory, Oid outfuncoid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(val, <span class="Constant">false</span>, &amp;result, tcategory, outfuncoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">false</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JsonbPGetDatum(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1125">&#x200c;</a><span class="linkable">jsonb_build_object_worker</span>(<span class="Type">int</span> nargs, <span class="Type">const</span> Datum *args, <span class="Type">const</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *nulls, <span class="Type">const</span> Oid *types,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> absent_on_null, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> unique_keys)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nargs % <span class="Constant">2</span> != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;argument list must have even number of elements&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* translator: %s is a SQL function name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;The arguments of </span><span class="Special">%s</span><span class="Constant"> must consist of alternating keys and <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;<a href="#L1177" title="utils/adt/jsonb.c:1177">jsonb_build_object</a>()&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; result.parseState-&gt;unique_keys = unique_keys;<br/></li>
<li>&nbsp; &nbsp; result.parseState-&gt;skip_nulls = absent_on_null;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nargs; i += <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* process key */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nulls[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;argument </span><span class="Special">%d</span><span class="Constant">: key must not be null&quot;</span>, i + <span class="Constant">1</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> null <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> if absent_on_null */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> = absent_on_null &amp;&amp; nulls[i + <span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we need to save skipped keys for the key uniqueness check */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> &amp;&amp; !unique_keys)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1016" title="utils/adt/jsonb.c:1016">add_jsonb</a>(args[i], <span class="Constant">false</span>, &amp;result, types[i], <span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* process value */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1016" title="utils/adt/jsonb.c:1016">add_jsonb</a>(args[i + <span class="Constant">1</span>], nulls[i + <span class="Constant">1</span>], &amp;result, types[i + <span class="Constant">1</span>], <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JsonbPGetDatum(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL function <a href="#L1177" title="utils/adt/jsonb.c:1177">jsonb_build_object</a>(variadic &quot;<a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>&quot;)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1177">&#x200c;</a><span class="linkable">jsonb_build_object</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *args;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp;&nbsp; *nulls;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *types;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* build argument <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> to build the object */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nargs = <a href="../fmgr/funcapi.c.html#L2005" title="utils/fmgr/funcapi.c:2005">extract_variadic_args</a>(fcinfo, <span class="Constant">0</span>, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;args, &amp;types, &amp;nulls);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nargs &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(<a href="#L1125" title="utils/adt/jsonb.c:1125">jsonb_build_object_worker</a>(nargs, args, nulls, types, <span class="Constant">false</span>, <span class="Constant">false</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * degenerate case of <a href="#L1177" title="utils/adt/jsonb.c:1177">jsonb_build_object</a> where it gets 0 arguments.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1197">&#x200c;</a><span class="linkable">jsonb_build_object_noargs</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1210">&#x200c;</a><span class="linkable">jsonb_build_array_worker</span>(<span class="Type">int</span> nargs, <span class="Type">const</span> Datum *args, <span class="Type">const</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *nulls, <span class="Type">const</span> Oid *types,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> absent_on_null)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_BEGIN_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nargs; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (absent_on_null &amp;&amp; nulls[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1016" title="utils/adt/jsonb.c:1016">add_jsonb</a>(args[i], nulls[i], &amp;result, types[i], <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> JsonbPGetDatum(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL function <a href="#L1237" title="utils/adt/jsonb.c:1237">jsonb_build_array</a>(variadic &quot;<a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>&quot;)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1237">&#x200c;</a><span class="linkable">jsonb_build_array</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *args;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp;&nbsp; *nulls;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *types;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* build argument <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> to build the object */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nargs = <a href="../fmgr/funcapi.c.html#L2005" title="utils/fmgr/funcapi.c:2005">extract_variadic_args</a>(fcinfo, <span class="Constant">0</span>, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;args, &amp;types, &amp;nulls);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nargs &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(<a href="#L1210" title="utils/adt/jsonb.c:1210">jsonb_build_array_worker</a>(nargs, args, nulls, types, <span class="Constant">false</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * degenerate case of <a href="#L1237" title="utils/adt/jsonb.c:1237">jsonb_build_array</a> where it gets 0 arguments.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1258">&#x200c;</a><span class="linkable">jsonb_build_array_noargs</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_BEGIN_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL function <a href="#L1279" title="utils/adt/jsonb.c:1279">jsonb_object</a>(text[])<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * take a one or two dimensional array of text as name value pairs<br/></li>
<li></span><span class="Comment"> * for a jsonb object.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1279">&#x200c;</a><span class="linkable">jsonb_object</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *in_array = PG_GETARG_ARRAYTYPE_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndims = ARR_NDIM(in_array);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *in_datums;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp;&nbsp; *in_nulls;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in_count,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; count,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (ndims)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">0</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> close_object;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">1</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((ARR_DIMS(in_array)[<span class="Constant">0</span>]) % <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;array must have even number of elements&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">2</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((ARR_DIMS(in_array)[<span class="Constant">1</span>]) != <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;array must have two columns&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;wrong number of array subscripts&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="arrayfuncs.c.html#L3678" title="utils/adt/arrayfuncs.c:3678">deconstruct_array_builtin</a>(in_array, TEXTOID, &amp;in_datums, &amp;in_nulls, &amp;in_count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; count = in_count / <span class="Constant">2</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; count; ++i)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in_nulls[i * <span class="Constant">2</span>])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NULL_VALUE_NOT_ALLOWED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;null value not allowed for object key&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; str = TextDatumGetCString(in_datums[i * <span class="Constant">2</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = strlen(str);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvString;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.val.string.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = str;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_KEY, &amp;v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (in_nulls[i * <span class="Constant">2</span> + <span class="Constant">1</span>])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvNull;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; str = TextDatumGetCString(in_datums[i * <span class="Constant">2</span> + <span class="Constant">1</span>]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = strlen(str);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvString;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_VALUE, &amp;v);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(in_datums);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(in_nulls);<br/></li>
<li><br/></li>
<li><span class="Statement">close_object</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL function <a href="#L1279" title="utils/adt/jsonb.c:1279">jsonb_object</a>(text[], text[])<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * take separate name and value arrays of text to construct a jsonb object<br/></li>
<li></span><span class="Comment"> * pairwise.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1379">&#x200c;</a><span class="linkable">jsonb_object_two_arg</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *key_array = PG_GETARG_ARRAYTYPE_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *val_array = PG_GETARG_ARRAYTYPE_P(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nkdims = ARR_NDIM(key_array);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nvdims = ARR_NDIM(val_array);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *key_datums,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *val_datums;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp;&nbsp; *key_nulls,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *val_nulls;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; key_count,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val_count,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nkdims &gt; <span class="Constant">1</span> || nkdims != nvdims)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;wrong number of array subscripts&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nkdims == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> close_object;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="arrayfuncs.c.html#L3678" title="utils/adt/arrayfuncs.c:3678">deconstruct_array_builtin</a>(key_array, TEXTOID, &amp;key_datums, &amp;key_nulls, &amp;key_count);<br/></li>
<li>&nbsp; &nbsp; <a href="arrayfuncs.c.html#L3678" title="utils/adt/arrayfuncs.c:3678">deconstruct_array_builtin</a>(val_array, TEXTOID, &amp;val_datums, &amp;val_nulls, &amp;val_count);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (key_count != val_count)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;mismatched array dimensions&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; key_count; ++i)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (key_nulls[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NULL_VALUE_NOT_ALLOWED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;null value not allowed for object key&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; str = TextDatumGetCString(key_datums[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = strlen(str);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvString;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.val.string.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = str;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_KEY, &amp;v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (val_nulls[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvNull;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; str = TextDatumGetCString(val_datums[i]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = strlen(str);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvString;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.len = len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = str;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_VALUE, &amp;v);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(key_datums);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(key_nulls);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(val_datums);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(val_nulls);<br/></li>
<li><br/></li>
<li><span class="Statement">close_object</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState, WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * shallow clone of a <a href="../../regex/regcomp.c.html#L715" title="regex/regcomp.c:715">parse</a> state, suitable for use in aggregate<br/></li>
<li></span><span class="Comment"> * final <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> that will only append to the <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> rather than<br/></li>
<li></span><span class="Comment"> * change them.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> JsonbParseState *<br/></li>
<li><a id="L1471">&#x200c;</a><span class="linkable">clone_parse_state</span>(JsonbParseState *state)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonbParseState *result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *icursor,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ocursor;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (state == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(JsonbParseState));<br/></li>
<li>&nbsp; &nbsp; icursor = state;<br/></li>
<li>&nbsp; &nbsp; ocursor = result;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ocursor-&gt;contVal = icursor-&gt;contVal;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ocursor-&gt;size = icursor-&gt;size;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ocursor-&gt;unique_keys = icursor-&gt;unique_keys;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ocursor-&gt;skip_nulls = icursor-&gt;skip_nulls;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; icursor = icursor-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (icursor == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ocursor-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(JsonbParseState));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ocursor = ocursor-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; ocursor-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Datum<br/></li>
<li><a id="L1501">&#x200c;</a><span class="linkable">jsonb_agg_transfn_worker</span>(FunctionCallInfo fcinfo, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> absent_on_null)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; MemoryContext oldcontext,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aggcontext;<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *state;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> elem;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; single_scalar = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; JsonbIterator *it;<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *jbelem;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; JsonbIteratorToken type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../executor/nodeAgg.c.html#L4511" title="executor/nodeAgg.c:4511">AggCheckCallContext</a>(fcinfo, &amp;aggcontext))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cannot be called directly because of <a href="pseudotypes.c.html#L373" title="utils/adt/pseudotypes.c:373">internal</a>-type argument */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L1625" title="utils/adt/jsonb.c:1625">jsonb_agg_transfn</a> called in non-aggregate context&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* set up the accumulator on the first go round */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (PG_ARGISNULL(<span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; arg_type = <a href="../fmgr/fmgr.c.html#L1910" title="utils/fmgr/fmgr.c:1910">get_fn_expr_argtype</a>(fcinfo-&gt;flinfo, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (arg_type == InvalidOid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not determine input data type&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldcontext = MemoryContextSwitchTo(aggcontext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = <a href="../mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state-&gt;res = result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WJB_BEGIN_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(arg_type, <span class="Constant">true</span>, &amp;state-&gt;val_category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;state-&gt;val_output_func);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state = (<a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = state-&gt;res;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (absent_on_null &amp;&amp; PG_ARGISNULL(<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(state);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* turn the argument into jsonb in the normal function context */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; val = PG_ARGISNULL(<span class="Constant">1</span>) ? (Datum) <span class="Constant">0</span> : PG_GETARG_DATUM(<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;elem, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(val, PG_ARGISNULL(<span class="Constant">1</span>), &amp;elem, state-&gt;val_category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state-&gt;val_output_func, <span class="Constant">false</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; jbelem = <a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(elem.res);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* switch to the aggregate context for accumulation operations */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; oldcontext = MemoryContextSwitchTo(aggcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; it = <a href="jsonb_util.c.html#L817" title="utils/adt/jsonb_util.c:817">JsonbIteratorInit</a>(&amp;jbelem-&gt;root);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((type = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;v, <span class="Constant">false</span>)) != WJB_DONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v.val.array.rawScalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; single_scalar = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!single_scalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_OBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_OBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_ELEM:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_KEY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_VALUE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v.type == jbvString)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* copy string <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> in the aggregate context */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *buf = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(v.val.string.len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, v.val.string.len + <span class="Constant">1</span>, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, v.val.string.val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (v.type == jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* same for <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DatumGetNumeric(DirectFunctionCall1(<a href="numeric.c.html#L1453" title="utils/adt/numeric.c:1453">numeric_uplus</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unknown jsonb iterator token type&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(state);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb_agg aggregate function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1625">&#x200c;</a><span class="linkable">jsonb_agg_transfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1501" title="utils/adt/jsonb.c:1501">jsonb_agg_transfn_worker</a>(fcinfo, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb_agg_strict aggregate function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1634">&#x200c;</a><span class="linkable">jsonb_agg_strict_transfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1501" title="utils/adt/jsonb.c:1501">jsonb_agg_transfn_worker</a>(fcinfo, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1640">&#x200c;</a><span class="linkable">jsonb_agg_finalfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *arg;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* cannot be called directly because of <a href="pseudotypes.c.html#L373" title="utils/adt/pseudotypes.c:373">internal</a>-type argument */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="../../executor/nodeAgg.c.html#L4511" title="executor/nodeAgg.c:4511">AggCheckCallContext</a>(fcinfo, <span class="Constant">NULL</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (PG_ARGISNULL(<span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* returns null iff no input <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; arg = (<a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We need to do a shallow clone of the argument in case the final<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * function is called more than once, so we avoid changing the argument. A<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * shallow clone is sufficient as we aren't going to change <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, just add the final array end marker.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.parseState = <a href="#L1471" title="utils/adt/jsonb.c:1471">clone_parse_state</a>(arg-&gt;res-&gt;parseState);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WJB_END_ARRAY, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Datum<br/></li>
<li><a id="L1673">&#x200c;</a><span class="linkable">jsonb_object_agg_transfn_worker</span>(FunctionCallInfo fcinfo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> absent_on_null, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> unique_keys)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; MemoryContext oldcontext,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aggcontext;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> elem;<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *state;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; val;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> *result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; single_scalar;<br/></li>
<li>&nbsp; &nbsp; JsonbIterator *it;<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *jbkey,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *jbval;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; JsonbIteratorToken type;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../executor/nodeAgg.c.html#L4511" title="executor/nodeAgg.c:4511">AggCheckCallContext</a>(fcinfo, &amp;aggcontext))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cannot be called directly because of <a href="pseudotypes.c.html#L373" title="utils/adt/pseudotypes.c:373">internal</a>-type argument */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L1896" title="utils/adt/jsonb.c:1896">jsonb_object_agg_transfn</a> called in non-aggregate context&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* set up the accumulator on the first go round */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (PG_ARGISNULL(<span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; arg_type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldcontext = MemoryContextSwitchTo(aggcontext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = <a href="../mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state-&gt;res = result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WJB_BEGIN_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;parseState-&gt;unique_keys = unique_keys;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result-&gt;parseState-&gt;skip_nulls = absent_on_null;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; arg_type = <a href="../fmgr/fmgr.c.html#L1910" title="utils/fmgr/fmgr.c:1910">get_fn_expr_argtype</a>(fcinfo-&gt;flinfo, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (arg_type == InvalidOid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not determine input data type&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(arg_type, <span class="Constant">true</span>, &amp;state-&gt;key_category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;state-&gt;key_output_func);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; arg_type = <a href="../fmgr/fmgr.c.html#L1910" title="utils/fmgr/fmgr.c:1910">get_fn_expr_argtype</a>(fcinfo-&gt;flinfo, <span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (arg_type == InvalidOid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not determine input data type&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="jsonfuncs.c.html#L5953" title="utils/adt/jsonfuncs.c:5953">json_categorize_type</a>(arg_type, <span class="Constant">true</span>, &amp;state-&gt;val_category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;state-&gt;val_output_func);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; state = (<a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = state-&gt;res;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* turn the argument into jsonb in the normal function context */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (PG_ARGISNULL(<span class="Constant">1</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;field name must not be null&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Skip null <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> if absent_on_null unless key uniqueness check is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * needed (because we must save keys in this case).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> = absent_on_null &amp;&amp; PG_ARGISNULL(<span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> &amp;&amp; !unique_keys)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(state);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = PG_GETARG_DATUM(<span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;elem, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(val, <span class="Constant">false</span>, &amp;elem, state-&gt;key_category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state-&gt;key_output_func, <span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; jbkey = <a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(elem.res);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; val = PG_ARGISNULL(<span class="Constant">2</span>) ? (Datum) <span class="Constant">0</span> : PG_GETARG_DATUM(<span class="Constant">2</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;elem, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L638" title="utils/adt/jsonb.c:638">datum_to_jsonb_internal</a>(val, PG_ARGISNULL(<span class="Constant">2</span>), &amp;elem, state-&gt;val_category,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; state-&gt;val_output_func, <span class="Constant">false</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; jbval = <a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(elem.res);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; it = <a href="jsonb_util.c.html#L817" title="utils/adt/jsonb_util.c:817">JsonbIteratorInit</a>(&amp;jbkey-&gt;root);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* switch to the aggregate context for accumulation operations */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; oldcontext = MemoryContextSwitchTo(aggcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * keys should be scalar, and we should have already checked for that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * above when calling <a href="#L1112" title="utils/adt/jsonb.c:1112">datum_to_jsonb</a>, so we only need to look for these<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * things.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((type = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;v, <span class="Constant">false</span>)) != WJB_DONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!v.val.array.rawScalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unexpected structure for key&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_ELEM:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v.type == jbvString)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* copy string <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> in the aggregate context */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *buf = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(v.val.string.len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, v.val.string.len + <span class="Constant">1</span>, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, v.val.string.val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;object keys must be strings&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WJB_KEY, &amp;v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.type = jbvNull;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WJB_VALUE, &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(state);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unexpected structure for key&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; it = <a href="jsonb_util.c.html#L817" title="utils/adt/jsonb_util.c:817">JsonbIteratorInit</a>(&amp;jbval-&gt;root);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; single_scalar = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> can be anything, including structured and null, so we treat them<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * as in <a href="json.c.html#L852" title="utils/adt/json.c:852">json_agg_transfn</a>, except that single scalars are always pushed as<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * WJB_VALUE items.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((type = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;v, <span class="Constant">false</span>)) != WJB_DONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v.val.array.rawScalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; single_scalar = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_ARRAY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!single_scalar)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_BEGIN_OBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_END_OBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; type, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_ELEM:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_KEY:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WJB_VALUE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v.type == jbvString)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* copy string <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> in the aggregate context */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *buf = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(v.val.string.len + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, v.val.string.len + <span class="Constant">1</span>, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, v.val.string.val);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.string.val = buf;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (v.type == jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* same for <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DatumGetNumeric(DirectFunctionCall1(<a href="numeric.c.html#L1453" title="utils/adt/numeric.c:1453">numeric_uplus</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result-&gt;res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result-&gt;parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; single_scalar ? WJB_VALUE : type,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;v);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unknown jsonb iterator token type&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(state);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb_object_agg aggregate function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1896">&#x200c;</a><span class="linkable">jsonb_object_agg_transfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1673" title="utils/adt/jsonb.c:1673">jsonb_object_agg_transfn_worker</a>(fcinfo, <span class="Constant">false</span>, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb_object_agg_strict aggregate function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1906">&#x200c;</a><span class="linkable">jsonb_object_agg_strict_transfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1673" title="utils/adt/jsonb.c:1673">jsonb_object_agg_transfn_worker</a>(fcinfo, <span class="Constant">true</span>, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb_object_agg_unique aggregate function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1915">&#x200c;</a><span class="linkable">jsonb_object_agg_unique_transfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1673" title="utils/adt/jsonb.c:1673">jsonb_object_agg_transfn_worker</a>(fcinfo, <span class="Constant">false</span>, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * jsonb_object_agg_unique_strict aggregate function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1924">&#x200c;</a><span class="linkable">jsonb_object_agg_unique_strict_transfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1673" title="utils/adt/jsonb.c:1673">jsonb_object_agg_transfn_worker</a>(fcinfo, <span class="Constant">true</span>, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1930">&#x200c;</a><span class="linkable">jsonb_object_agg_finalfn</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *arg;<br/></li>
<li>&nbsp; &nbsp; <a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a> result;<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *out;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* cannot be called directly because of <a href="pseudotypes.c.html#L373" title="utils/adt/pseudotypes.c:373">internal</a>-type argument */<br/></li>
<li></span>&nbsp; &nbsp; Assert(<a href="../../executor/nodeAgg.c.html#L4511" title="executor/nodeAgg.c:4511">AggCheckCallContext</a>(fcinfo, <span class="Constant">NULL</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (PG_ARGISNULL(<span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* returns null iff no input <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; arg = (<a href="#L36" title="utils/adt/jsonb.c:36">JsonbAggState</a> *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We need to do a shallow clone of the argument's res field in case the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * final function is called more than once, so we avoid changing the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * aggregate state value.&nbsp; A shallow clone is sufficient as we aren't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * going to change <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> of the <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, just add the final object end<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * marker.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; memset(&amp;result, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L28" title="utils/adt/jsonb.c:28">JsonbInState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.parseState = <a href="#L1471" title="utils/adt/jsonb.c:1471">clone_parse_state</a>(arg-&gt;res-&gt;parseState);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result.res = <a href="jsonb_util.c.html#L566" title="utils/adt/jsonb_util.c:566">pushJsonbValue</a>(&amp;result.parseState,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WJB_END_OBJECT, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <a href="jsonb_util.c.html#L92" title="utils/adt/jsonb_util.c:92">JsonbValueToJsonb</a>(result.res);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Extract scalar value from raw-scalar pseudo-array jsonb.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L1968">&#x200c;</a></span><span class="linkable">JsonbExtractScalar</span>(JsonbContainer *jbc, JsonbValue *res)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; JsonbIterator *it;<br/></li>
<li>&nbsp; &nbsp; JsonbIteratorToken tok <a href="../../storage/lmgr/lock.c.html#L185" title="storage/lmgr/lock.c:185">PG_USED_FOR_ASSERTS_ONLY</a>;<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; tmp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!JsonContainerIsArray(jbc) || !JsonContainerIsScalar(jbc))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* inform caller about actual type of container */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; res-&gt;type = (JsonContainerIsArray(jbc)) ? jbvArray : jbvObject;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * A root scalar is stored as an array of one <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a>, so we get the array<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * and then its first (and only) member.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; it = <a href="jsonb_util.c.html#L817" title="utils/adt/jsonb_util.c:817">JsonbIteratorInit</a>(jbc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tok = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;tmp, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(tok == WJB_BEGIN_ARRAY);<br/></li>
<li>&nbsp; &nbsp; Assert(tmp.val.array.nElems == <span class="Constant">1</span> &amp;&amp; tmp.val.array.rawScalar);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tok = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, res, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(tok == WJB_ELEM);<br/></li>
<li>&nbsp; &nbsp; Assert(IsAJsonbScalar(res));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tok = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;tmp, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(tok == WJB_END_ARRAY);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tok = <a href="jsonb_util.c.html#L853" title="utils/adt/jsonb_util.c:853">JsonbIteratorNext</a>(&amp;it, &amp;tmp, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(tok == WJB_DONE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Emit correct, translatable cast error message<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L2008">&#x200c;</a></span><span class="linkable">cannotCastJsonbValue</span>(<span class="Type">enum</span> jbvType type, <span class="Type">const</span> <span class="Type">char</span> *sqltype)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <span class="Type">struct<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">enum</span> jbvType type;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *msg;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; messages[] =<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvNull, gettext_noop(<span class="Constant">&quot;cannot cast jsonb null to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvString, gettext_noop(<span class="Constant">&quot;cannot cast jsonb string to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvNumeric, gettext_noop(<span class="Constant">&quot;cannot cast jsonb <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvBool, gettext_noop(<span class="Constant">&quot;cannot cast jsonb boolean to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvArray, gettext_noop(<span class="Constant">&quot;cannot cast jsonb array to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvObject, gettext_noop(<span class="Constant">&quot;cannot cast jsonb object to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {jbvBinary, gettext_noop(<span class="Constant">&quot;cannot cast jsonb array or object to type </span><span class="Special">%s</span><span class="Constant">&quot;</span>)}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; lengthof(messages); i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (messages[i].type == type)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(messages[i].msg, sqltype)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* should be unreachable */<br/></li>
<li></span>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unknown jsonb type: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, (<span class="Type">int</span>) type);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2038">&#x200c;</a><span class="linkable">jsonb_bool</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvBool)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;boolean&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(v.val.boolean);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2052">&#x200c;</a><span class="linkable">jsonb_numeric</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; retValue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> points into jsonb body, so we need to make a copy to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * return<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; retValue = DatumGetNumericCopy(NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_NUMERIC(retValue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2073">&#x200c;</a><span class="linkable">jsonb_int2</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; retValue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;smallint&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; retValue = DirectFunctionCall1(<a href="numeric.c.html#L4553" title="utils/adt/numeric.c:4553">numeric_int2</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(retValue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2091">&#x200c;</a><span class="linkable">jsonb_int4</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; retValue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;integer&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; retValue = DirectFunctionCall1(<a href="numeric.c.html#L4447" title="utils/adt/numeric.c:4447">numeric_int4</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(retValue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2109">&#x200c;</a><span class="linkable">jsonb_int8</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; retValue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;bigint&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; retValue = DirectFunctionCall1(<a href="numeric.c.html#L4535" title="utils/adt/numeric.c:4535">numeric_int8</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(retValue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2127">&#x200c;</a><span class="linkable">jsonb_float4</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; retValue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;real&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; retValue = DirectFunctionCall1(<a href="numeric.c.html#L4722" title="utils/adt/numeric.c:4722">numeric_float4</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(retValue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L2145">&#x200c;</a><span class="linkable">jsonb_float8</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Jsonb&nbsp; &nbsp; &nbsp;&nbsp; *in = PG_GETARG_JSONB_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; retValue;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;in-&gt;root, &amp;v) || v.type != jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L2008" title="utils/adt/jsonb.c:2008">cannotCastJsonbValue</a>(v.type, <span class="Constant">&quot;double precision&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; retValue = DirectFunctionCall1(<a href="numeric.c.html#L4628" title="utils/adt/numeric.c:4628">numeric_float8</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NumericGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(in, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(retValue);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Convert jsonb to a C-string stripping quotes from scalar strings.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L2166">&#x200c;</a><span class="linkable">JsonbUnquote</span>(Jsonb *jb)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (JB_ROOT_IS_SCALAR(jb))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; JsonbValue&nbsp; &nbsp; v;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L1968" title="utils/adt/jsonb.c:1968">JsonbExtractScalar</a>(&amp;jb-&gt;root, &amp;v);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (v.type == jbvString)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../mmgr/mcxt.c.html#L1706" title="utils/mmgr/mcxt.c:1706">pnstrdup</a>(v.val.string.val, v.val.string.len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (v.type == jbvBool)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(v.val.boolean ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (v.type == jbvNumeric)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> DatumGetCString(DirectFunctionCall1(<a href="numeric.c.html#L807" title="utils/adt/numeric.c:807">numeric_out</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PointerGetDatum(v.val.<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (v.type == jbvNull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="../mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(<span class="Constant">&quot;null&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized jsonb value type </span><span class="Special">%d</span><span class="Constant">&quot;</span>, v.type);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L473" title="utils/adt/jsonb.c:473">JsonbToCString</a>(<span class="Constant">NULL</span>, &amp;jb-&gt;root, VARSIZE(jb));<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
