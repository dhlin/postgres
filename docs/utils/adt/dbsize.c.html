<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/adt/dbsize.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/adt/dbsize.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L67">size_bytes_aliases</a></li>
<li><a href="#L49">size_pretty_units</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L60">size_bytes_unit_alias</a></li>
<li><a href="#L38">size_pretty_unit</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L118">calculate_database_size</a></li>
<li><a href="#L451">calculate_indexes_size</a></li>
<li><a href="#L308">calculate_relation_size</a></li>
<li><a href="#L424">calculate_table_size</a></li>
<li><a href="#L202">calculate_tablespace_size</a></li>
<li><a href="#L378">calculate_toast_table_size</a></li>
<li><a href="#L528">calculate_total_relation_size</a></li>
<li><a href="#L74">db_dir_size</a></li>
<li><a href="#L624">numeric_absolute</a></li>
<li><a href="#L634">numeric_half_rounded</a></li>
<li><a href="#L615">numeric_is_less</a></li>
<li><a href="#L607">numeric_to_cstring</a></li>
<li><a href="#L656">numeric_truncated_divide</a></li>
<li><a href="#L182">pg_database_size_name</a></li>
<li><a href="#L168">pg_database_size_oid</a></li>
<li><a href="#L923">pg_filenode_relation</a></li>
<li><a href="#L505">pg_indexes_size</a></li>
<li><a href="#L875">pg_relation_filenode</a></li>
<li><a href="#L947">pg_relation_filepath</a></li>
<li><a href="#L346">pg_relation_size</a></li>
<li><a href="#L709">pg_size_bytes</a></li>
<li><a href="#L569">pg_size_pretty</a></li>
<li><a href="#L668">pg_size_pretty_numeric</a></li>
<li><a href="#L486">pg_table_size</a></li>
<li><a href="#L286">pg_tablespace_size_name</a></li>
<li><a href="#L272">pg_tablespace_size_oid</a></li>
<li><a href="#L547">pg_total_relation_size</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L35">half_rounded</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * dbsize.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Database object size <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>, and related inquiries<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Copyright (c) 2002-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/adt/dbsize.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;sys/stat.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/htup_details.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/relation.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/namespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_authid.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_database.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_tablespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;commands/dbcommands.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;commands/tablespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/acl.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/rel.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/relfilenumbermap.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/relmapper.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/syscache.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Divide by two and round away from zero */<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">half_rounded</span>(x)&nbsp;&nbsp; (((x) + ((x) &lt; </span><span class="Constant">0</span><span class="PreProc"> ? -</span><span class="Constant">1</span><span class="PreProc"> : </span><span class="Constant">1</span><span class="PreProc">)) / </span><span class="Constant">2</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Units used in <a href="#L569" title="utils/adt/dbsize.c:569">pg_size_pretty</a> <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>.&nbsp; All units must be powers of 2 */<br/></li>
<li><a id="L38">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">size_pretty_unit</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* bytes, kB, MB, GB etc */<br/></li>
<li></span>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; limit;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="oracle_compat.c.html#L80" title="utils/adt/oracle_compat.c:80">upper</a> limit, prior to half rounding after<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * converting to this unit. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; round;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* do half rounding for this unit */<br/></li>
<li></span>&nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; unitbits;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* (1 &lt;&lt; unitbits) bytes to make 1 of this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * unit */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* When adding units here also update the docs and the error message in <a href="#L709" title="utils/adt/dbsize.c:709">pg_size_bytes</a> */<br/></li>
<li><a id="L49">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">struct</span> <a href="#L38" title="utils/adt/dbsize.c:38">size_pretty_unit</a> <span class="linkable">size_pretty_units</span>[] = {<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;bytes&quot;</span>, <span class="Constant">10</span> * <span class="Constant">1024</span>, <span class="Constant">false</span>, <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;kB&quot;</span>, <span class="Constant">20</span> * <span class="Constant">1024</span> - <span class="Constant">1</span>, <span class="Constant">true</span>, <span class="Constant">10</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;MB&quot;</span>, <span class="Constant">20</span> * <span class="Constant">1024</span> - <span class="Constant">1</span>, <span class="Constant">true</span>, <span class="Constant">20</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;GB&quot;</span>, <span class="Constant">20</span> * <span class="Constant">1024</span> - <span class="Constant">1</span>, <span class="Constant">true</span>, <span class="Constant">30</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;TB&quot;</span>, <span class="Constant">20</span> * <span class="Constant">1024</span> - <span class="Constant">1</span>, <span class="Constant">true</span>, <span class="Constant">40</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;PB&quot;</span>, <span class="Constant">20</span> * <span class="Constant">1024</span> - <span class="Constant">1</span>, <span class="Constant">true</span>, <span class="Constant">50</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">false</span>, <span class="Constant">0</span>}<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* Additional unit aliases accepted by <a href="#L709" title="utils/adt/dbsize.c:709">pg_size_bytes</a> */<br/></li>
<li><a id="L60">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">size_bytes_unit_alias</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *alias;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unit_index;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* corresponding <a href="#L49" title="utils/adt/dbsize.c:49">size_pretty_units</a> <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> */<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* When adding units here also update the docs and the error message in <a href="#L709" title="utils/adt/dbsize.c:709">pg_size_bytes</a> */<br/></li>
<li><a id="L67">&#x200c;</a></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">struct</span> <a href="#L60" title="utils/adt/dbsize.c:60">size_bytes_unit_alias</a> <span class="linkable">size_bytes_aliases</span>[] = {<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">&quot;B&quot;</span>, <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; {<span class="Constant">NULL</span>}<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* Return physical size of directory contents, or 0 if dir doesn't exist */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L74">&#x200c;</a><span class="linkable">db_dir_size</span>(<span class="Type">const</span> <span class="Type">char</span> *path)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; dirsize = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> dirent *direntry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">DIR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *dirdesc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; filename[MAXPGPATH * <span class="Constant">2</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dirdesc = <a href="../../storage/file/fd.c.html#L2843" title="storage/file/fd.c:2843">AllocateDir</a>(path);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!dirdesc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((direntry = <a href="../../storage/file/fd.c.html#L2909" title="storage/file/fd.c:2909">ReadDir</a>(dirdesc, path)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> stat fst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strcmp(direntry-&gt;d_name, <span class="Constant">&quot;.&quot;</span>) == <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcmp(direntry-&gt;d_name, <span class="Constant">&quot;..&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(filename, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(filename), <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">&quot;</span>, path, direntry-&gt;d_name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stat(filename, &amp;fst) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (errno == <span class="Constant">ENOENT</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not stat file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>, filename)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dirsize += fst.st_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/file/fd.c.html#L2961" title="storage/file/fd.c:2961">FreeDir</a>(dirdesc);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> dirsize;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * calculate size of database in all tablespaces<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L118">&#x200c;</a><span class="linkable">calculate_database_size</span>(Oid dbOid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; totalsize;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">DIR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *dirdesc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> dirent *direntry;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; dirpath[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; pathname[MAXPGPATH + <span class="Constant">21</span> + <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(TABLESPACE_VERSION_DIRECTORY)];<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * User must have <a href="../../port/win32/socket.c.html#L35" title="port/win32/socket.c:35">connect</a> privilege for target database or have privileges<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of pg_read_all_stats<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(DatabaseRelationId, dbOid, <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>(), ACL_CONNECT);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="acl.c.html#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>(<a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>(), ROLE_PG_READ_ALL_STATS))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../catalog/aclchk.c.html#L2688" title="catalog/aclchk.c:2688">aclcheck_error</a>(aclresult, OBJECT_DATABASE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../commands/dbcommands.c.html#L3153" title="commands/dbcommands.c:3153">get_database_name</a>(dbOid));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Shared storage in pg_global is not counted */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Include pg_default storage */<br/></li>
<li></span>&nbsp; &nbsp; snprintf(pathname, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pathname), <span class="Constant">&quot;base/</span><span class="Special">%u</span><span class="Constant">&quot;</span>, dbOid);<br/></li>
<li>&nbsp; &nbsp; totalsize = <a href="#L74" title="utils/adt/dbsize.c:74">db_dir_size</a>(pathname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Scan the non-default tablespaces */<br/></li>
<li></span>&nbsp; &nbsp; snprintf(dirpath, MAXPGPATH, <span class="Constant">&quot;pg_tblspc&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; dirdesc = <a href="../../storage/file/fd.c.html#L2843" title="storage/file/fd.c:2843">AllocateDir</a>(dirpath);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((direntry = <a href="../../storage/file/fd.c.html#L2909" title="storage/file/fd.c:2909">ReadDir</a>(dirdesc, dirpath)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strcmp(direntry-&gt;d_name, <span class="Constant">&quot;.&quot;</span>) == <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcmp(direntry-&gt;d_name, <span class="Constant">&quot;..&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(pathname, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pathname), <span class="Constant">&quot;pg_tblspc/</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; direntry-&gt;d_name, TABLESPACE_VERSION_DIRECTORY, dbOid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; totalsize += <a href="#L74" title="utils/adt/dbsize.c:74">db_dir_size</a>(pathname);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/file/fd.c.html#L2961" title="storage/file/fd.c:2961">FreeDir</a>(dirdesc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> totalsize;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L168">&#x200c;</a><span class="linkable">pg_database_size_oid</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L118" title="utils/adt/dbsize.c:118">calculate_database_size</a>(dbOid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L182">&#x200c;</a><span class="linkable">pg_database_size_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; dbName = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbOid = <a href="../../commands/dbcommands.c.html#L3106" title="commands/dbcommands.c:3106">get_database_oid</a>(NameStr(*dbName), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L118" title="utils/adt/dbsize.c:118">calculate_database_size</a>(dbOid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Calculate total size of tablespace. Returns -1 if the tablespace directory<br/></li>
<li></span><span class="Comment"> * cannot be found.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L202">&#x200c;</a><span class="linkable">calculate_tablespace_size</span>(Oid tblspcOid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; tblspcPath[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; pathname[MAXPGPATH * <span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; totalsize = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">DIR</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *dirdesc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> dirent *direntry;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * User must have privileges of pg_read_all_stats or have CREATE privilege<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * for target tablespace, either explicitly granted or implicitly because<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * it is default for current database.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (tblspcOid != <a href="../init/globals.c.html#L93" title="utils/init/globals.c:93">MyDatabaseTableSpace</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="acl.c.html#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>(<a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>(), ROLE_PG_READ_ALL_STATS))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TableSpaceRelationId, tblspcOid, <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>(), ACL_CREATE);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../catalog/aclchk.c.html#L2688" title="catalog/aclchk.c:2688">aclcheck_error</a>(aclresult, OBJECT_TABLESPACE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../../commands/tablespace.c.html#L1472" title="commands/tablespace.c:1472">get_tablespace_name</a>(tblspcOid));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (tblspcOid == DEFAULTTABLESPACE_OID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(tblspcPath, MAXPGPATH, <span class="Constant">&quot;base&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (tblspcOid == GLOBALTABLESPACE_OID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(tblspcPath, MAXPGPATH, <span class="Constant">&quot;global&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(tblspcPath, MAXPGPATH, <span class="Constant">&quot;pg_tblspc/</span><span class="Special">%u</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">&quot;</span>, tblspcOid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TABLESPACE_VERSION_DIRECTORY);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; dirdesc = <a href="../../storage/file/fd.c.html#L2843" title="storage/file/fd.c:2843">AllocateDir</a>(tblspcPath);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!dirdesc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> ((direntry = <a href="../../storage/file/fd.c.html#L2909" title="storage/file/fd.c:2909">ReadDir</a>(dirdesc, tblspcPath)) != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> stat fst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strcmp(direntry-&gt;d_name, <span class="Constant">&quot;.&quot;</span>) == <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcmp(direntry-&gt;d_name, <span class="Constant">&quot;..&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(pathname, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pathname), <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">&quot;</span>, tblspcPath, direntry-&gt;d_name);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stat(pathname, &amp;fst) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (errno == <span class="Constant">ENOENT</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not stat file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>, pathname)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (S_ISDIR(fst.st_mode))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; totalsize += <a href="#L74" title="utils/adt/dbsize.c:74">db_dir_size</a>(pathname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; totalsize += fst.st_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../storage/file/fd.c.html#L2961" title="storage/file/fd.c:2961">FreeDir</a>(dirdesc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> totalsize;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L272">&#x200c;</a><span class="linkable">pg_tablespace_size_oid</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tblspcOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L202" title="utils/adt/dbsize.c:202">calculate_tablespace_size</a>(tblspcOid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L286">&#x200c;</a><span class="linkable">pg_tablespace_size_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; tblspcName = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tblspcOid = <a href="../../commands/tablespace.c.html#L1426" title="commands/tablespace.c:1426">get_tablespace_oid</a>(NameStr(*tblspcName), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L202" title="utils/adt/dbsize.c:202">calculate_tablespace_size</a>(tblspcOid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * calculate size of (one fork of) a relation<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: we can safely apply this to temp tables of other sessions, so there<br/></li>
<li></span><span class="Comment"> * is no check here or at the call sites for that.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L308">&#x200c;</a><span class="linkable">calculate_relation_size</span>(RelFileLocator *rfn, ProcNumber backend, ForkNumber forknum)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; totalsize = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *relationpath;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; pathname[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> segcount = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; relationpath = relpathbackend(*rfn, backend, forknum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (segcount = <span class="Constant">0</span>;; segcount++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct</span> stat fst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (segcount == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(pathname, MAXPGPATH, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; relationpath);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(pathname, MAXPGPATH, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">.</span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; relationpath, segcount);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (stat(pathname, &amp;fst) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (errno == <span class="Constant">ENOENT</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not stat file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>, pathname)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; totalsize += fst.st_size;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> totalsize;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L346">&#x200c;</a><span class="linkable">pg_relation_size</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *forkName = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; rel;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rel = <a href="../../access/common/relation.c.html#L88" title="access/common/relation.c:88">try_relation_open</a>(relOid, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Before 9.2, we used to throw an error if the relation didn't exist, but<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * that makes queries like &quot;SELECT <a href="#L346" title="utils/adt/dbsize.c:346">pg_relation_size</a>(oid) FROM pg_class&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * less robust, because while we scan pg_class with an MVCC snapshot,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * someone else might drop the table. It's better to return NULL for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * already-dropped tables than throw an error and abort the whole query.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rel == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L308" title="utils/adt/dbsize.c:308">calculate_relation_size</a>(&amp;(rel-&gt;rd_locator), rel-&gt;rd_backend,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; forkname_to_number(<a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(forkName)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(rel, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Calculate total on-disk size of a TOAST relation, including its indexes.<br/></li>
<li></span><span class="Comment"> * Must not be applied to non-TOAST relations.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L378">&#x200c;</a><span class="linkable">calculate_toast_table_size</span>(Oid toastrelid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; toastRel;<br/></li>
<li>&nbsp; &nbsp; ForkNumber&nbsp; &nbsp; forkNum;<br/></li>
<li>&nbsp; &nbsp; ListCell&nbsp;&nbsp; *lc;<br/></li>
<li>&nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *indexlist;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; toastRel = <a href="../../access/common/relation.c.html#L47" title="access/common/relation.c:47">relation_open</a>(toastrelid, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* toast heap size, including FSM and VM size */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (forkNum = <span class="Constant">0</span>; forkNum &lt;= MAX_FORKNUM; forkNum++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L308" title="utils/adt/dbsize.c:308">calculate_relation_size</a>(&amp;(toastRel-&gt;rd_locator),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; toastRel-&gt;rd_backend, forkNum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* toast index size, including FSM and VM size */<br/></li>
<li></span>&nbsp; &nbsp; indexlist = <a href="../cache/relcache.c.html#L4760" title="utils/cache/relcache.c:4760">RelationGetIndexList</a>(toastRel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Size is calculated using all the indexes available */<br/></li>
<li></span>&nbsp; &nbsp; foreach(lc, indexlist)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Relation&nbsp; &nbsp; toastIdxRel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; toastIdxRel = <a href="../../access/common/relation.c.html#L47" title="access/common/relation.c:47">relation_open</a>(lfirst_oid(lc),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AccessShareLock);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (forkNum = <span class="Constant">0</span>; forkNum &lt;= MAX_FORKNUM; forkNum++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L308" title="utils/adt/dbsize.c:308">calculate_relation_size</a>(&amp;(toastIdxRel-&gt;rd_locator),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; toastIdxRel-&gt;rd_backend, forkNum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(toastIdxRel, AccessShareLock);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../../nodes/list.c.html#L1546" title="nodes/list.c:1546">list_free</a>(indexlist);<br/></li>
<li>&nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(toastRel, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Calculate total on-disk size of a given table,<br/></li>
<li></span><span class="Comment"> * including FSM and VM, plus TOAST table if <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a>.<br/></li>
<li></span><span class="Comment"> * Indexes other than the TOAST table's index are not included.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that this also behaves sanely if applied to an index or toast table;<br/></li>
<li></span><span class="Comment"> * those won't have attached toast tables, but they can have multiple forks.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L424">&#x200c;</a><span class="linkable">calculate_table_size</span>(Relation rel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ForkNumber&nbsp; &nbsp; forkNum;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * heap size, including FSM and VM<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (forkNum = <span class="Constant">0</span>; forkNum &lt;= MAX_FORKNUM; forkNum++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L308" title="utils/adt/dbsize.c:308">calculate_relation_size</a>(&amp;(rel-&gt;rd_locator), rel-&gt;rd_backend,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forkNum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Size of toast relation<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (OidIsValid(rel-&gt;rd_rel-&gt;reltoastrelid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L378" title="utils/adt/dbsize.c:378">calculate_toast_table_size</a>(rel-&gt;rd_rel-&gt;reltoastrelid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Calculate total on-disk size of all indexes attached to the given table.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Can be applied safely to an index, but you'll just get zero.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L451">&#x200c;</a><span class="linkable">calculate_indexes_size</span>(Relation rel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Aggregate all indexes on the given relation<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (rel-&gt;rd_rel-&gt;relhasindex)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *index_oids = <a href="../cache/relcache.c.html#L4760" title="utils/cache/relcache.c:4760">RelationGetIndexList</a>(rel);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ListCell&nbsp;&nbsp; *cell;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; foreach(cell, index_oids)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idxOid = lfirst_oid(cell);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Relation&nbsp; &nbsp; idxRel;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ForkNumber&nbsp; &nbsp; forkNum;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idxRel = <a href="../../access/common/relation.c.html#L47" title="access/common/relation.c:47">relation_open</a>(idxOid, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (forkNum = <span class="Constant">0</span>; forkNum &lt;= MAX_FORKNUM; forkNum++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size += <a href="#L308" title="utils/adt/dbsize.c:308">calculate_relation_size</a>(&amp;(idxRel-&gt;rd_locator),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idxRel-&gt;rd_backend,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forkNum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(idxRel, AccessShareLock);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../nodes/list.c.html#L1546" title="nodes/list.c:1546">list_free</a>(index_oids);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L486">&#x200c;</a><span class="linkable">pg_table_size</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; rel;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rel = <a href="../../access/common/relation.c.html#L88" title="access/common/relation.c:88">try_relation_open</a>(relOid, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rel == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L424" title="utils/adt/dbsize.c:424">calculate_table_size</a>(rel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(rel, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L505">&#x200c;</a><span class="linkable">pg_indexes_size</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; rel;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rel = <a href="../../access/common/relation.c.html#L88" title="access/common/relation.c:88">try_relation_open</a>(relOid, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rel == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L451" title="utils/adt/dbsize.c:451">calculate_indexes_size</a>(rel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(rel, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Compute the on-disk size of all files for the relation,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; including heap data, index data, toast data, FSM, VM.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> int64<br/></li>
<li><a id="L528">&#x200c;</a><span class="linkable">calculate_total_relation_size</span>(Relation rel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Aggregate the table size, this includes size of the heap, toast and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * toast index with free space and visibility map<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; size = <a href="#L424" title="utils/adt/dbsize.c:424">calculate_table_size</a>(rel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Add size of all attached indexes as well<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; size += <a href="#L451" title="utils/adt/dbsize.c:451">calculate_indexes_size</a>(rel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L547">&#x200c;</a><span class="linkable">pg_total_relation_size</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relOid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; rel;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; rel = <a href="../../access/common/relation.c.html#L88" title="access/common/relation.c:88">try_relation_open</a>(relOid, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rel == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = <a href="#L528" title="utils/adt/dbsize.c:528">calculate_total_relation_size</a>(rel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(rel, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(size);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * formatting with size units<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L569">&#x200c;</a><span class="linkable">pg_size_pretty</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; size = PG_GETARG_INT64(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; buf[<span class="Constant">64</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">struct</span> <a href="#L38" title="utils/adt/dbsize.c:38">size_pretty_unit</a> *unit;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (unit = <a href="#L49" title="utils/adt/dbsize.c:49">size_pretty_units</a>; unit-&gt;name != <span class="Constant">NULL</span>; unit++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; bits;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* use this unit if there are no more units or we're below the limit */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unit[<span class="Constant">1</span>].name == <span class="Constant">NULL</span> || i64abs(size) &lt; unit-&gt;limit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unit-&gt;round)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="#L35" title="utils/adt/dbsize.c:35">half_rounded</a>(size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(buf, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(buf), INT64_FORMAT <span class="Constant">&quot; </span><span class="Special">%s</span><span class="Constant">&quot;</span>, size, unit-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Determine the number of bits to use to build the divisor.&nbsp; We may<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * need to use 1 <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> less than the difference between this and the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> unit if the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> unit uses half rounding.&nbsp; Or we may need to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * shift an extra <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> if this unit uses half rounding and the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> one<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * does not.&nbsp; We use division rather than shifting right by this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * number of bits to ensure positive and negative <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> are rounded<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * in the same way.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; bits = (unit[<span class="Constant">1</span>].unitbits - unit-&gt;unitbits - (unit[<span class="Constant">1</span>].round == <span class="Constant">true</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; + (unit-&gt;round == <span class="Constant">true</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size /= ((int64) <span class="Constant">1</span>) &lt;&lt; bits;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_TEXT_P(<a href="varlena.c.html#L184" title="utils/adt/varlena.c:184">cstring_to_text</a>(buf));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">char</span> *<br/></li>
<li><a id="L607">&#x200c;</a><span class="linkable">numeric_to_cstring</span>(Numeric n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; d = NumericGetDatum(n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> DatumGetCString(DirectFunctionCall1(<a href="numeric.c.html#L807" title="utils/adt/numeric.c:807">numeric_out</a>, d));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L615">&#x200c;</a></span><span class="linkable">numeric_is_less</span>(Numeric a, Numeric b)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; da = NumericGetDatum(a);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; db = NumericGetDatum(b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> DatumGetBool(DirectFunctionCall2(<a href="numeric.c.html#L2475" title="utils/adt/numeric.c:2475">numeric_lt</a>, da, db));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Numeric<br/></li>
<li><a id="L624">&#x200c;</a><span class="linkable">numeric_absolute</span>(Numeric n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; d = NumericGetDatum(n);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = DirectFunctionCall1(<a href="numeric.c.html#L1384" title="utils/adt/numeric.c:1384">numeric_abs</a>, d);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> DatumGetNumeric(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Numeric<br/></li>
<li><a id="L634">&#x200c;</a><span class="linkable">numeric_half_rounded</span>(Numeric n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; d = NumericGetDatum(n);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; zero;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; one;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; two;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; zero = NumericGetDatum(<a href="numeric.c.html#L4283" title="utils/adt/numeric.c:4283">int64_to_numeric</a>(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; one = NumericGetDatum(<a href="numeric.c.html#L4283" title="utils/adt/numeric.c:4283">int64_to_numeric</a>(<span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; two = NumericGetDatum(<a href="numeric.c.html#L4283" title="utils/adt/numeric.c:4283">int64_to_numeric</a>(<span class="Constant">2</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (DatumGetBool(DirectFunctionCall2(<a href="numeric.c.html#L2460" title="utils/adt/numeric.c:2460">numeric_ge</a>, d, zero)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; d = DirectFunctionCall2(<a href="numeric.c.html#L2848" title="utils/adt/numeric.c:2848">numeric_add</a>, d, one);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; d = DirectFunctionCall2(<a href="numeric.c.html#L2925" title="utils/adt/numeric.c:2925">numeric_sub</a>, d, one);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = DirectFunctionCall2(<a href="numeric.c.html#L3259" title="utils/adt/numeric.c:3259">numeric_div_trunc</a>, d, two);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> DatumGetNumeric(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Numeric<br/></li>
<li><a id="L656">&#x200c;</a><span class="linkable">numeric_truncated_divide</span>(Numeric n, int64 divisor)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; d = NumericGetDatum(n);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; divisor_numeric;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; divisor_numeric = NumericGetDatum(<a href="numeric.c.html#L4283" title="utils/adt/numeric.c:4283">int64_to_numeric</a>(divisor));<br/></li>
<li>&nbsp; &nbsp; result = DirectFunctionCall2(<a href="numeric.c.html#L3259" title="utils/adt/numeric.c:3259">numeric_div_trunc</a>, d, divisor_numeric);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> DatumGetNumeric(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L668">&#x200c;</a><span class="linkable">pg_size_pretty_numeric</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; size = PG_GETARG_NUMERIC(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *result = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">struct</span> <a href="#L38" title="utils/adt/dbsize.c:38">size_pretty_unit</a> *unit;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (unit = <a href="#L49" title="utils/adt/dbsize.c:49">size_pretty_units</a>; unit-&gt;name != <span class="Constant">NULL</span>; unit++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">int</span> shiftby;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* use this unit if there are no more units or we're below the limit */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unit[<span class="Constant">1</span>].name == <span class="Constant">NULL</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L615" title="utils/adt/dbsize.c:615">numeric_is_less</a>(<a href="#L624" title="utils/adt/dbsize.c:624">numeric_absolute</a>(size),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="numeric.c.html#L4283" title="utils/adt/numeric.c:4283">int64_to_numeric</a>(unit-&gt;limit)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unit-&gt;round)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = <a href="#L634" title="utils/adt/dbsize.c:634">numeric_half_rounded</a>(size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = psprintf(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%s</span><span class="Constant">&quot;</span>, <a href="#L607" title="utils/adt/dbsize.c:607">numeric_to_cstring</a>(size), unit-&gt;name);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Determine the number of bits to use to build the divisor.&nbsp; We may<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * need to use 1 <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> less than the difference between this and the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> unit if the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> unit uses half rounding.&nbsp; Or we may need to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * shift an extra <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> if this unit uses half rounding and the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> one<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * does not.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; shiftby = (unit[<span class="Constant">1</span>].unitbits - unit-&gt;unitbits - (unit[<span class="Constant">1</span>].round == <span class="Constant">true</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; + (unit-&gt;round == <span class="Constant">true</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; size = <a href="#L656" title="utils/adt/dbsize.c:656">numeric_truncated_divide</a>(size, ((int64) <span class="Constant">1</span>) &lt;&lt; shiftby);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_TEXT_P(<a href="varlena.c.html#L184" title="utils/adt/varlena.c:184">cstring_to_text</a>(result));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Convert a human-readable size to a size in bytes<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L709">&#x200c;</a><span class="linkable">pg_size_bytes</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *arg = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *str,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *strptr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *endptr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; saved_char;<br/></li>
<li>&nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; have_digits = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; str = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(arg);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Skip leading whitespace */<br/></li>
<li></span>&nbsp; &nbsp; strptr = str;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *strptr))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strptr++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check that we have a valid number and determine where it ends */<br/></li>
<li></span>&nbsp; &nbsp; endptr = strptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Part (1): sign */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*endptr == <span class="Constant">'-'</span> || *endptr == <span class="Constant">'+'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; endptr++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Part (2): <a href="../../storage/lmgr/s_lock.c.html#L257" title="storage/lmgr/s_lock.c:257">main</a> digit string */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (isdigit((<span class="Type">unsigned</span> <span class="Type">char</span>) *endptr))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; have_digits = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; endptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (isdigit((<span class="Type">unsigned</span> <span class="Type">char</span>) *endptr));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Part (3): optional decimal point and fractional digits */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*endptr == <span class="Constant">'.'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; endptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isdigit((<span class="Type">unsigned</span> <span class="Type">char</span>) *endptr))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; have_digits = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">do<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; endptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (isdigit((<span class="Type">unsigned</span> <span class="Type">char</span>) *endptr));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Complain if we don't have a valid number at this point */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!have_digits)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid size: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, str)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Part (4): optional exponent */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*endptr == <span class="Constant">'e'</span> || *endptr == <span class="Constant">'E'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">long</span>&nbsp; &nbsp; &nbsp; &nbsp; exponent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *cp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Note we might one day support EB units, so if what follows 'E'<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * isn't a number, just treat it all as a unit to be parsed.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; exponent = strtol(endptr + <span class="Constant">1</span>, &amp;cp, <span class="Constant">10</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) exponent;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Silence -Wunused-result warnings */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (cp &gt; endptr + <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; endptr = cp;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Parse the number, saving the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> character, which may be the first<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * character of the unit string.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; saved_char = *endptr;<br/></li>
<li>&nbsp; &nbsp; *endptr = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; num = DatumGetNumeric(DirectFunctionCall3(<a href="numeric.c.html#L628" title="utils/adt/numeric.c:628">numeric_in</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CStringGetDatum(strptr),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ObjectIdGetDatum(InvalidOid),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Int32GetDatum(-<span class="Constant">1</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *endptr = saved_char;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Skip whitespace between number and unit */<br/></li>
<li></span>&nbsp; &nbsp; strptr = endptr;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *strptr))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; strptr++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Handle possible unit */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*strptr != <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">struct</span> <a href="#L38" title="utils/adt/dbsize.c:38">size_pretty_unit</a> *unit;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; multiplier = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Trim <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> trailing whitespace */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; endptr = str + VARSIZE_ANY_EXHDR(arg) - <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *endptr))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; endptr--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; endptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *endptr = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (unit = <a href="#L49" title="utils/adt/dbsize.c:49">size_pretty_units</a>; unit-&gt;name != <span class="Constant">NULL</span>; unit++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Parse the unit case-insensitively */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_strcasecmp(strptr, unit-&gt;name) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* If not found, look in table of aliases */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unit-&gt;name == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">const</span> <span class="Type">struct</span> <a href="#L60" title="utils/adt/dbsize.c:60">size_bytes_unit_alias</a> *a = <a href="#L67" title="utils/adt/dbsize.c:67">size_bytes_aliases</a>; a-&gt;alias != <span class="Constant">NULL</span>; a++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_strcasecmp(strptr, a-&gt;alias) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unit = &amp;<a href="#L49" title="utils/adt/dbsize.c:49">size_pretty_units</a>[a-&gt;unit_index];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Verify we found a valid unit in the loop above */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unit-&gt;name == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid size: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(arg)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1205" title="utils/error/elog.c:1205">errdetail</a>(<span class="Constant">&quot;Invalid size unit: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">.&quot;</span>, strptr),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;Valid units are </span><span class="Special">\&quot;</span><span class="Constant">bytes</span><span class="Special">\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">B</span><span class="Special">\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">kB</span><span class="Special">\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">MB</span><span class="Special">\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">GB</span><span class="Special">\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">TB</span><span class="Special">\&quot;</span><span class="Constant">, and </span><span class="Special">\&quot;</span><span class="Constant">PB</span><span class="Special">\&quot;</span><span class="Constant">.&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; multiplier = ((int64) <span class="Constant">1</span>) &lt;&lt; unit-&gt;unitbits;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (multiplier &gt; <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; mul_num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mul_num = <a href="numeric.c.html#L4283" title="utils/adt/numeric.c:4283">int64_to_numeric</a>(multiplier);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num = DatumGetNumeric(DirectFunctionCall2(<a href="numeric.c.html#L3003" title="utils/adt/numeric.c:3003">numeric_mul</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NumericGetDatum(mul_num),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NumericGetDatum(num)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = DatumGetInt64(DirectFunctionCall1(<a href="numeric.c.html#L4535" title="utils/adt/numeric.c:4535">numeric_int8</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NumericGetDatum(num)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get the filenode of a relation<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is expected to be used in queries like<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; SELECT <a href="#L875" title="utils/adt/dbsize.c:875">pg_relation_filenode</a>(oid) FROM pg_class;<br/></li>
<li></span><span class="Comment"> * That leads to a couple of choices.&nbsp; We work from the pg_class row alone<br/></li>
<li></span><span class="Comment"> * rather than actually opening each relation, for efficiency.&nbsp; We don't<br/></li>
<li></span><span class="Comment"> * fail if we can't <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> the relation --- some rows might be visible in<br/></li>
<li></span><span class="Comment"> * the query's MVCC snapshot even though the relations have been dropped.<br/></li>
<li></span><span class="Comment"> * (Note: we could avoid using the catcache, but there's little point<br/></li>
<li></span><span class="Comment"> * because the relation mapper also works &quot;in the <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>&quot;.)&nbsp; We also don't<br/></li>
<li></span><span class="Comment"> * fail if the relation doesn't have storage.&nbsp; In all these cases it<br/></li>
<li></span><span class="Comment"> * seems better to quietly return NULL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L875">&#x200c;</a><span class="linkable">pg_relation_filenode</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; RelFileNumber result;<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tuple;<br/></li>
<li>&nbsp; &nbsp; Form_pg_class relform;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tuple = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(RELOID, ObjectIdGetDatum(relid));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tuple))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; relform = (Form_pg_class) GETSTRUCT(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (RELKIND_HAS_STORAGE(relform-&gt;relkind))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (relform-&gt;relfilenode)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = relform-&gt;relfilenode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Consult the relation mapper */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = <a href="../cache/relmapper.c.html#L165" title="utils/cache/relmapper.c:165">RelationMapOidToFilenumber</a>(relid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relform-&gt;relisshared);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no storage, return NULL */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; result = InvalidRelFileNumber;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!RelFileNumberIsValid(result))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_OID(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get the relation via (reltablespace, relfilenumber)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is expected to be used when somebody wants to match an individual file<br/></li>
<li></span><span class="Comment"> * on the filesystem back to its table. That's not trivially possible via<br/></li>
<li></span><span class="Comment"> * pg_class, because that doesn't contain the relfilenumbers of shared and nailed<br/></li>
<li></span><span class="Comment"> * tables.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We don't fail but return NULL if we cannot <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> a mapping.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * InvalidOid can be passed instead of the current database's default<br/></li>
<li></span><span class="Comment"> * tablespace.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L923">&#x200c;</a><span class="linkable">pg_filenode_relation</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reltablespace = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; RelFileNumber relfilenumber = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; heaprel;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* test needed so <a href="../cache/relfilenumbermap.c.html#L136" title="utils/cache/relfilenumbermap.c:136">RelidByRelfilenumber</a> doesn't misbehave */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!RelFileNumberIsValid(relfilenumber))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; heaprel = <a href="../cache/relfilenumbermap.c.html#L136" title="utils/cache/relfilenumbermap.c:136">RelidByRelfilenumber</a>(reltablespace, relfilenumber);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(heaprel))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_OID(heaprel);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get the pathname (relative to $PGDATA) of a relation<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * See comments for <a href="#L875" title="utils/adt/dbsize.c:875">pg_relation_filenode</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L947">&#x200c;</a><span class="linkable">pg_relation_filepath</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tuple;<br/></li>
<li>&nbsp; &nbsp; Form_pg_class relform;<br/></li>
<li>&nbsp; &nbsp; RelFileLocator rlocator;<br/></li>
<li>&nbsp; &nbsp; ProcNumber&nbsp; &nbsp; backend;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *path;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tuple = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(RELOID, ObjectIdGetDatum(relid));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tuple))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; relform = (Form_pg_class) GETSTRUCT(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (RELKIND_HAS_STORAGE(relform-&gt;relkind))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* This logic should match <a href="../cache/relcache.c.html#L1319" title="utils/cache/relcache.c:1319">RelationInitPhysicalAddr</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (relform-&gt;reltablespace)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rlocator.spcOid = relform-&gt;reltablespace;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rlocator.spcOid = <a href="../init/globals.c.html#L93" title="utils/init/globals.c:93">MyDatabaseTableSpace</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rlocator.spcOid == GLOBALTABLESPACE_OID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rlocator.dbOid = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rlocator.dbOid = <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (relform-&gt;relfilenode)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rlocator.relNumber = relform-&gt;relfilenode;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Consult the relation mapper */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rlocator.relNumber = <a href="../cache/relmapper.c.html#L165" title="utils/cache/relmapper.c:165">RelationMapOidToFilenumber</a>(relid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; relform-&gt;relisshared);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no storage, return NULL */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rlocator.relNumber = InvalidRelFileNumber;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* some compilers generate warnings without these <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> two lines */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; rlocator.dbOid = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rlocator.spcOid = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!RelFileNumberIsValid(rlocator.relNumber))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(tuple);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Determine owning backend. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">switch</span> (relform-&gt;relpersistence)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RELPERSISTENCE_UNLOGGED:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RELPERSISTENCE_PERMANENT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; backend = INVALID_PROC_NUMBER;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> RELPERSISTENCE_TEMP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/namespace.c.html#L3658" title="catalog/namespace.c:3658">isTempOrTempToastNamespace</a>(relform-&gt;relnamespace))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; backend = ProcNumberForTempRelations();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Do it the hard way. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; backend = <a href="../../catalog/namespace.c.html#L3751" title="catalog/namespace.c:3751">GetTempNamespaceProcNumber</a>(relform-&gt;relnamespace);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(backend != INVALID_PROC_NUMBER);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;invalid relpersistence: </span><span class="Special">%c</span><span class="Constant">&quot;</span>, relform-&gt;relpersistence);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; backend = INVALID_PROC_NUMBER;&nbsp; &nbsp; <span class="Comment">/* placate compiler */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; path = relpathbackend(rlocator, backend, MAIN_FORKNUM);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_TEXT_P(<a href="varlena.c.html#L184" title="utils/adt/varlena.c:184">cstring_to_text</a>(path));<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
