<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/adt/pseudorandomfuncs.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/adt/pseudorandomfuncs.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L26">prng_seed_set</a></li>
<li><a href="#L25">prng_state</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L84">drandom</a></li>
<li><a href="#L102">drandom_normal</a></li>
<li><a href="#L34">initialize_prng</a></li>
<li><a href="#L126">int4random</a></li>
<li><a href="#L150">int8random</a></li>
<li><a href="#L174">numeric_random</a></li>
<li><a href="#L62">setseed</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * pseudorandomfuncs.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Functions giving SQL access to a pseudorandom number generator.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/adt/pseudorandomfuncs.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;math.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;common/pg_prng.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/fmgrprotos.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/<a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/timestamp.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Shared PRNG state used by all the random <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> */<br/></li>
<li><a id="L25">&#x200c;</a></span><span class="Type">static</span> pg_prng_state <span class="linkable">prng_state</span>;<br/></li>
<li><a id="L26">&#x200c;</a><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <span class="linkable">prng_seed_set</span> = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L34" title="utils/adt/pseudorandomfuncs.c:34">initialize_prng</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Initialize (seed) the PRNG, if not done yet in this process.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="linkable">initialize_prng</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (unlikely(!<a href="#L26" title="utils/adt/pseudorandomfuncs.c:26">prng_seed_set</a>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If possible, seed the PRNG using high-quality random bits. Should<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * that fail for some reason, we fall back on a <a href="oracle_compat.c.html#L49" title="utils/adt/oracle_compat.c:49">lower</a>-quality seed<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * based on current time and PID.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (unlikely(!pg_prng_strong_seed(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TimestampTz <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> = <a href="timestamp.c.html#L1654" title="utils/adt/timestamp.c:1654">GetCurrentTimestamp</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; iseed;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Mix the PID with the most predictable bits of the timestamp */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iseed = (uint64) <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> ^ ((uint64) <a href="../init/globals.c.html#L45" title="utils/init/globals.c:45">MyProcPid</a> &lt;&lt; <span class="Constant">32</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_prng_seed(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>, iseed);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L26" title="utils/adt/pseudorandomfuncs.c:26">prng_seed_set</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L62" title="utils/adt/pseudorandomfuncs.c:62">setseed</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Seed the PRNG from a specified value in the <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> [-1.0, 1.0].<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L62">&#x200c;</a><span class="linkable">setseed</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; float8&nbsp; &nbsp; &nbsp; &nbsp; seed = PG_GETARG_FLOAT8(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (seed &lt; -<span class="Constant">1</span> || seed &gt; <span class="Constant">1</span> || isnan(seed))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;<a href="#L62" title="utils/adt/pseudorandomfuncs.c:62">setseed</a> parameter </span><span class="Special">%g</span><span class="Constant"> is out of allowed <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> [-1,1]&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; seed));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; pg_prng_fseed(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>, seed);<br/></li>
<li>&nbsp; &nbsp; <a href="#L26" title="utils/adt/pseudorandomfuncs.c:26">prng_seed_set</a> = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_VOID();<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L84" title="utils/adt/pseudorandomfuncs.c:84">drandom</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Returns a random number chosen uniformly in the <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> [0.0, 1.0).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L84">&#x200c;</a><span class="linkable">drandom</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; float8&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L34" title="utils/adt/pseudorandomfuncs.c:34">initialize_prng</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* pg_prng_double produces desired result <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a> [0.0, 1.0) */<br/></li>
<li></span>&nbsp; &nbsp; result = pg_prng_double(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT8(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L102" title="utils/adt/pseudorandomfuncs.c:102">drandom_normal</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Returns a random number from a normal distribution.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L102">&#x200c;</a><span class="linkable">drandom_normal</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; float8&nbsp; &nbsp; &nbsp; &nbsp; mean = PG_GETARG_FLOAT8(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; float8&nbsp; &nbsp; &nbsp; &nbsp; stddev = PG_GETARG_FLOAT8(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; float8&nbsp; &nbsp; &nbsp; &nbsp; result,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; z;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L34" title="utils/adt/pseudorandomfuncs.c:34">initialize_prng</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Get random value from standard normal(mean = 0.0, stddev = 1.0) */<br/></li>
<li></span>&nbsp; &nbsp; z = pg_prng_double_normal(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Transform the normal standard variable (z) */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* using the target normal distribution parameters */<br/></li>
<li></span>&nbsp; &nbsp; result = (stddev * z) + mean;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT8(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L126" title="utils/adt/pseudorandomfuncs.c:126">int4random</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Returns a random 32-<a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> integer chosen uniformly in the specified <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L126">&#x200c;</a><span class="linkable">int4random</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; rmin = PG_GETARG_INT32(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; rmax = PG_GETARG_INT32(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rmin &gt; rmax)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;<a href="oracle_compat.c.html#L49" title="utils/adt/oracle_compat.c:49">lower</a> bound must be less than or <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to <a href="oracle_compat.c.html#L80" title="utils/adt/oracle_compat.c:80">upper</a> bound&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L34" title="utils/adt/pseudorandomfuncs.c:34">initialize_prng</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = (int32) pg_prng_int64_range(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>, rmin, rmax);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L150" title="utils/adt/pseudorandomfuncs.c:150">int8random</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Returns a random 64-<a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> integer chosen uniformly in the specified <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L150">&#x200c;</a><span class="linkable">int8random</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; rmin = PG_GETARG_INT64(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; rmax = PG_GETARG_INT64(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (rmin &gt; rmax)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;<a href="oracle_compat.c.html#L49" title="utils/adt/oracle_compat.c:49">lower</a> bound must be less than or <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to <a href="oracle_compat.c.html#L80" title="utils/adt/oracle_compat.c:80">upper</a> bound&quot;</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L34" title="utils/adt/pseudorandomfuncs.c:34">initialize_prng</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = pg_prng_int64_range(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>, rmin, rmax);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L174" title="utils/adt/pseudorandomfuncs.c:174">numeric_random</a>() -<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; Returns a random <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> value chosen uniformly in the specified <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L174">&#x200c;</a><span class="linkable">numeric_random</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; rmin = PG_GETARG_NUMERIC(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; rmax = PG_GETARG_NUMERIC(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Numeric&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L34" title="utils/adt/pseudorandomfuncs.c:34">initialize_prng</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="numeric.c.html#L4228" title="utils/adt/numeric.c:4228">random_numeric</a>(&amp;<a href="#L25" title="utils/adt/pseudorandomfuncs.c:25">prng_state</a>, rmin, rmax);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_NUMERIC(result);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
