<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/adt/windowfuncs.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/adt/windowfuncs.c - pgsql17devel-backend</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L38">ntile_context</a></li>
<li><a href="#L24">rank_context</a></li>
<li><a href="#L27">rank_context</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L528">leadlag_common</a></li>
<li><a href="#L49">rank_up</a></li>
<li><a href="#L330">window_cume_dist</a></li>
<li><a href="#L371">window_cume_dist_support</a></li>
<li><a href="#L200">window_dense_rank</a></li>
<li><a href="#L220">window_dense_rank_support</a></li>
<li><a href="#L649">window_first_value</a></li>
<li><a href="#L580">window_lag</a></li>
<li><a href="#L592">window_lag_with_offset</a></li>
<li><a href="#L603">window_lag_with_offset_and_default</a></li>
<li><a href="#L670">window_last_value</a></li>
<li><a href="#L615">window_lead</a></li>
<li><a href="#L627">window_lead_with_offset</a></li>
<li><a href="#L638">window_lead_with_offset_and_default</a></li>
<li><a href="#L691">window_nth_value</a></li>
<li><a href="#L411">window_ntile</a></li>
<li><a href="#L483">window_ntile_support</a></li>
<li><a href="#L261">window_percent_rank</a></li>
<li><a href="#L288">window_percent_rank_support</a></li>
<li><a href="#L138">window_rank</a></li>
<li><a href="#L158">window_rank_support</a></li>
<li><a href="#L84">window_row_number</a></li>
<li><a href="#L98">window_row_number_support</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * windowfuncs.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Standard window <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> defined in SQL spec.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 2000-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/adt/windowfuncs.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;nodes/parsenodes.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;nodes/supportnodes.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/fmgrprotos.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;windowapi.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * ranking process information<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L24">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">rank_context</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; rank;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* current rank */<br/></li>
<li><a id="L27">&#x200c;</a></span>} <span class="linkable">rank_context</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * ntile process information<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; ntile;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* current result */<br/></li>
<li></span>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; rows_per_bucket;&nbsp; &nbsp; <span class="Comment">/* row number of current bucket */<br/></li>
<li></span>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; boundary;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* how many rows should be in the bucket */<br/></li>
<li></span>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; remainder;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* (total rows) % (bucket num) */<br/></li>
<li><a id="L38">&#x200c;</a></span>} <span class="linkable">ntile_context</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L49" title="utils/adt/windowfuncs.c:49">rank_up</a>(WindowObject winobj);<br/></li>
<li><span class="Type">static</span> Datum <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(FunctionCallInfo fcinfo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> forward, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> withoffset, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> withdefault);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * utility routine for *_rank <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L49">&#x200c;</a></span><span class="linkable">rank_up</span>(WindowObject winobj)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; up = <span class="Constant">false</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* should rank increase? */<br/></li>
<li></span>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; curpos = <a href="../../executor/nodeWindowAgg.c.html#L3186" title="executor/nodeWindowAgg.c:3186">WinGetCurrentPosition</a>(winobj);<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *context;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; context = (<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3171" title="executor/nodeWindowAgg.c:3171">WinGetPartitionLocalMemory</a>(winobj, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (context-&gt;rank == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* first call: rank of first row is always 1 */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(curpos == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rank = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(curpos &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* do current and prior tuples match by ORDER BY clause? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../executor/nodeWindowAgg.c.html#L3254" title="executor/nodeWindowAgg.c:3254">WinRowsArePeers</a>(winobj, curpos - <span class="Constant">1</span>, curpos))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; up = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We can advance the mark, but only *after* access to prior row */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3219" title="executor/nodeWindowAgg.c:3219">WinSetMarkPosition</a>(winobj, curpos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> up;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * row_number<br/></li>
<li></span><span class="Comment"> * just increment up from 1 until current partition finishes.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L84">&#x200c;</a><span class="linkable">window_row_number</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; curpos = <a href="../../executor/nodeWindowAgg.c.html#L3186" title="executor/nodeWindowAgg.c:3186">WinGetCurrentPosition</a>(winobj);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3219" title="executor/nodeWindowAgg.c:3219">WinSetMarkPosition</a>(winobj, curpos);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(curpos + <span class="Constant">1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L98" title="utils/adt/windowfuncs.c:98">window_row_number_support</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; prosupport function for <a href="#L84" title="utils/adt/windowfuncs.c:84">window_row_number</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L98">&#x200c;</a><span class="linkable">window_row_number_support</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *rawreq = (Node *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestWFuncMonotonic))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestWFuncMonotonic *req = (SupportRequestWFuncMonotonic *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* row_number() is monotonically increasing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;monotonic = MONOTONICFUNC_INCREASING;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestOptimizeWindowClause))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestOptimizeWindowClause *req = (SupportRequestOptimizeWindowClause *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The frame options can always become &quot;ROWS BETWEEN UNBOUNDED<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * PRECEDING AND CURRENT ROW&quot;.&nbsp; row_number() always just increments by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * 1 with each row in the partition.&nbsp; Using ROWS instead of <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * saves effort checking peer rows during execution.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;frameOptions = (FRAMEOPTION_NONDEFAULT |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_ROWS |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_START_UNBOUNDED_PRECEDING |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_END_CURRENT_ROW);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * rank<br/></li>
<li></span><span class="Comment"> * Rank changes when key columns change.<br/></li>
<li></span><span class="Comment"> * The new rank number is the current row number.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L138">&#x200c;</a><span class="linkable">window_rank</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *context;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; up;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; up = <a href="#L49" title="utils/adt/windowfuncs.c:49">rank_up</a>(winobj);<br/></li>
<li>&nbsp; &nbsp; context = (<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3171" title="executor/nodeWindowAgg.c:3171">WinGetPartitionLocalMemory</a>(winobj, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (up)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rank = <a href="../../executor/nodeWindowAgg.c.html#L3186" title="executor/nodeWindowAgg.c:3186">WinGetCurrentPosition</a>(winobj) + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(context-&gt;rank);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L158" title="utils/adt/windowfuncs.c:158">window_rank_support</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; prosupport function for <a href="#L138" title="utils/adt/windowfuncs.c:138">window_rank</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L158">&#x200c;</a><span class="linkable">window_rank_support</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *rawreq = (Node *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestWFuncMonotonic))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestWFuncMonotonic *req = (SupportRequestWFuncMonotonic *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* rank() is monotonically increasing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;monotonic = MONOTONICFUNC_INCREASING;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestOptimizeWindowClause))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestOptimizeWindowClause *req = (SupportRequestOptimizeWindowClause *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * rank() is coded in such a way that it returns &quot;(COUNT (*) OVER<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * (&lt;opt&gt; <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a> UNBOUNDED PRECEDING) - COUNT (*) OVER (&lt;opt&gt; <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * CURRENT ROW) + 1)&quot; regardless of the frame options.&nbsp; We'll set the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * frame options to &quot;ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW&quot;<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * so they agree with what <a href="#L98" title="utils/adt/windowfuncs.c:98">window_row_number_support</a>() optimized the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * frame options to be.&nbsp; Using ROWS instead of <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a> saves from doing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * peer row checks during execution.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;frameOptions = (FRAMEOPTION_NONDEFAULT |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_ROWS |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_START_UNBOUNDED_PRECEDING |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_END_CURRENT_ROW);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * dense_rank<br/></li>
<li></span><span class="Comment"> * Rank increases by 1 when key columns change.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L200">&#x200c;</a><span class="linkable">window_dense_rank</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *context;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; up;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; up = <a href="#L49" title="utils/adt/windowfuncs.c:49">rank_up</a>(winobj);<br/></li>
<li>&nbsp; &nbsp; context = (<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3171" title="executor/nodeWindowAgg.c:3171">WinGetPartitionLocalMemory</a>(winobj, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (up)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rank++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT64(context-&gt;rank);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L220" title="utils/adt/windowfuncs.c:220">window_dense_rank_support</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; prosupport function for <a href="#L200" title="utils/adt/windowfuncs.c:200">window_dense_rank</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L220">&#x200c;</a><span class="linkable">window_dense_rank_support</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *rawreq = (Node *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestWFuncMonotonic))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestWFuncMonotonic *req = (SupportRequestWFuncMonotonic *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* dense_rank() is monotonically increasing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;monotonic = MONOTONICFUNC_INCREASING;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestOptimizeWindowClause))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestOptimizeWindowClause *req = (SupportRequestOptimizeWindowClause *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * dense_rank() is unaffected by the frame options.&nbsp; Here we set the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * frame options to match what's done in row_number's support<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * function.&nbsp; Using ROWS instead of <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a> (the default) saves the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * executor from having to check for peer rows.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;frameOptions = (FRAMEOPTION_NONDEFAULT |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_ROWS |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_START_UNBOUNDED_PRECEDING |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_END_CURRENT_ROW);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * percent_rank<br/></li>
<li></span><span class="Comment"> * return fraction between 0 and 1 inclusive,<br/></li>
<li></span><span class="Comment"> * which is described as (RK - 1) / (NR - 1), where RK is the current row's<br/></li>
<li></span><span class="Comment"> * rank and NR is the total number of rows, per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L261">&#x200c;</a><span class="linkable">window_percent_rank</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *context;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; up;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; totalrows = <a href="../../executor/nodeWindowAgg.c.html#L3201" title="executor/nodeWindowAgg.c:3201">WinGetPartitionRowCount</a>(winobj);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(totalrows &gt; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; up = <a href="#L49" title="utils/adt/windowfuncs.c:49">rank_up</a>(winobj);<br/></li>
<li>&nbsp; &nbsp; context = (<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3171" title="executor/nodeWindowAgg.c:3171">WinGetPartitionLocalMemory</a>(winobj, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (up)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rank = <a href="../../executor/nodeWindowAgg.c.html#L3186" title="executor/nodeWindowAgg.c:3186">WinGetCurrentPosition</a>(winobj) + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* return zero if there's only one row, per spec */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (totalrows &lt;= <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(<span class="Constant">0.0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT8((float8) (context-&gt;rank - <span class="Constant">1</span>) / (float8) (totalrows - <span class="Constant">1</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L288" title="utils/adt/windowfuncs.c:288">window_percent_rank_support</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; prosupport function for <a href="#L261" title="utils/adt/windowfuncs.c:261">window_percent_rank</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L288">&#x200c;</a><span class="linkable">window_percent_rank_support</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *rawreq = (Node *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestWFuncMonotonic))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestWFuncMonotonic *req = (SupportRequestWFuncMonotonic *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* percent_rank() is monotonically increasing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;monotonic = MONOTONICFUNC_INCREASING;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestOptimizeWindowClause))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestOptimizeWindowClause *req = (SupportRequestOptimizeWindowClause *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * percent_rank() is unaffected by the frame options.&nbsp; Here we set the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * frame options to match what's done in row_number's support<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * function.&nbsp; Using ROWS instead of <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a> (the default) saves the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * executor from having to check for peer rows.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;frameOptions = (FRAMEOPTION_NONDEFAULT |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_ROWS |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_START_UNBOUNDED_PRECEDING |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_END_CURRENT_ROW);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * cume_dist<br/></li>
<li></span><span class="Comment"> * return fraction between 0 and 1 inclusive,<br/></li>
<li></span><span class="Comment"> * which is described as NP / NR, where NP is the number of rows preceding or<br/></li>
<li></span><span class="Comment"> * peers to the current row, and NR is the total number of rows, per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L330">&#x200c;</a><span class="linkable">window_cume_dist</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; <a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *context;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; up;<br/></li>
<li>&nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; totalrows = <a href="../../executor/nodeWindowAgg.c.html#L3201" title="executor/nodeWindowAgg.c:3201">WinGetPartitionRowCount</a>(winobj);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(totalrows &gt; <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; up = <a href="#L49" title="utils/adt/windowfuncs.c:49">rank_up</a>(winobj);<br/></li>
<li>&nbsp; &nbsp; context = (<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3171" title="executor/nodeWindowAgg.c:3171">WinGetPartitionLocalMemory</a>(winobj, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L24" title="utils/adt/windowfuncs.c:24">rank_context</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (up || context-&gt;rank == <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The current row is not peer to prior row or is just the first, so<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * count up the number of rows that are peer to the current.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; row;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rank = <a href="../../executor/nodeWindowAgg.c.html#L3186" title="executor/nodeWindowAgg.c:3186">WinGetCurrentPosition</a>(winobj) + <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * start from current + 1<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (row = context-&gt;rank; row &lt; totalrows; row++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../executor/nodeWindowAgg.c.html#L3254" title="executor/nodeWindowAgg.c:3254">WinRowsArePeers</a>(winobj, row - <span class="Constant">1</span>, row))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rank++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT8((float8) context-&gt;rank / (float8) totalrows);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L371" title="utils/adt/windowfuncs.c:371">window_cume_dist_support</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; prosupport function for <a href="#L330" title="utils/adt/windowfuncs.c:330">window_cume_dist</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L371">&#x200c;</a><span class="linkable">window_cume_dist_support</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *rawreq = (Node *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestWFuncMonotonic))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestWFuncMonotonic *req = (SupportRequestWFuncMonotonic *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* cume_dist() is monotonically increasing */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;monotonic = MONOTONICFUNC_INCREASING;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestOptimizeWindowClause))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestOptimizeWindowClause *req = (SupportRequestOptimizeWindowClause *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * cume_dist() is unaffected by the frame options.&nbsp; Here we set the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * frame options to match what's done in row_number's support<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * function.&nbsp; Using ROWS instead of <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a> (the default) saves the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * executor from having to check for peer rows.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;frameOptions = (FRAMEOPTION_NONDEFAULT |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_ROWS |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_START_UNBOUNDED_PRECEDING |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_END_CURRENT_ROW);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * ntile<br/></li>
<li></span><span class="Comment"> * compute an exact <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> value with scale 0 (zero),<br/></li>
<li></span><span class="Comment"> * ranging from 1 (one) to n, per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L411">&#x200c;</a><span class="linkable">window_ntile</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; <a href="#L38" title="utils/adt/windowfuncs.c:38">ntile_context</a> *context;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; context = (<a href="#L38" title="utils/adt/windowfuncs.c:38">ntile_context</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../executor/nodeWindowAgg.c.html#L3171" title="executor/nodeWindowAgg.c:3171">WinGetPartitionLocalMemory</a>(winobj, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L38" title="utils/adt/windowfuncs.c:38">ntile_context</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (context-&gt;ntile == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* first call */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; int64&nbsp; &nbsp; &nbsp; &nbsp; total;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; nbuckets;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isnull;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; total = <a href="../../executor/nodeWindowAgg.c.html#L3201" title="executor/nodeWindowAgg.c:3201">WinGetPartitionRowCount</a>(winobj);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nbuckets = DatumGetInt32(<a href="../../executor/nodeWindowAgg.c.html#L3594" title="executor/nodeWindowAgg.c:3594">WinGetFuncArgCurrent</a>(winobj, <span class="Constant">0</span>, &amp;isnull));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * per spec: If NT is the null value, then the result is the null<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * value.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * per spec: If NT is less than or <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to 0 (zero), then an<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * exception condition is raised.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nbuckets &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_ARGUMENT_FOR_NTILE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;argument of ntile must be greater than zero&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;ntile = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rows_per_bucket = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;boundary = total / nbuckets;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (context-&gt;boundary &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context-&gt;boundary = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If the total number is not divisible, add 1 row to leading<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * buckets.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context-&gt;remainder = total % nbuckets;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (context-&gt;remainder != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context-&gt;boundary++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; context-&gt;rows_per_bucket++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (context-&gt;boundary &lt; context-&gt;rows_per_bucket)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ntile up */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (context-&gt;remainder != <span class="Constant">0</span> &amp;&amp; context-&gt;ntile == context-&gt;remainder)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context-&gt;remainder = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context-&gt;boundary -= <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;ntile += <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; context-&gt;rows_per_bucket = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_INT32(context-&gt;ntile);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L483" title="utils/adt/windowfuncs.c:483">window_ntile_support</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; prosupport function for <a href="#L411" title="utils/adt/windowfuncs.c:411">window_ntile</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L483">&#x200c;</a><span class="linkable">window_ntile_support</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *rawreq = (Node *) PG_GETARG_POINTER(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestWFuncMonotonic))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestWFuncMonotonic *req = (SupportRequestWFuncMonotonic *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * ntile() is monotonically increasing as the number of buckets cannot<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * change after the first call<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;monotonic = MONOTONICFUNC_INCREASING;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (IsA(rawreq, SupportRequestOptimizeWindowClause))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SupportRequestOptimizeWindowClause *req = (SupportRequestOptimizeWindowClause *) rawreq;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * ntile() is unaffected by the frame options.&nbsp; Here we set the frame<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * options to match what's done in row_number's support function.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Using ROWS instead of <a href="../../regex/regcomp.c.html#L339" title="regex/regcomp.c:339">RANGE</a> (the default) saves the executor from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * having to check for peer rows.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; req-&gt;frameOptions = (FRAMEOPTION_NONDEFAULT |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_ROWS |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_START_UNBOUNDED_PRECEDING |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; FRAMEOPTION_END_CURRENT_ROW);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_POINTER(req);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_POINTER(<span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a><br/></li>
<li></span><span class="Comment"> * common operation of lead() and lag()<br/></li>
<li></span><span class="Comment"> * For lead() forward is true, whereas for lag() it is false.<br/></li>
<li></span><span class="Comment"> * withoffset indicates we have an offset second argument.<br/></li>
<li></span><span class="Comment"> * withdefault indicates we have a default third argument.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Datum<br/></li>
<li><a id="L528">&#x200c;</a><span class="linkable">leadlag_common</span>(FunctionCallInfo fcinfo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> forward, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> withoffset, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> withdefault)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; offset;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; const_offset;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isnull;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isout;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (withoffset)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = DatumGetInt32(<a href="../../executor/nodeWindowAgg.c.html#L3594" title="executor/nodeWindowAgg.c:3594">WinGetFuncArgCurrent</a>(winobj, <span class="Constant">1</span>, &amp;isnull));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; const_offset = <a href="../fmgr/fmgr.c.html#L1975" title="utils/fmgr/fmgr.c:1975">get_fn_expr_arg_stable</a>(fcinfo-&gt;flinfo, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; offset = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; const_offset = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../../executor/nodeWindowAgg.c.html#L3311" title="executor/nodeWindowAgg.c:3311">WinGetFuncArgInPartition</a>(winobj, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (forward ? offset : -offset),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WINDOW_SEEK_CURRENT,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const_offset,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;isnull, &amp;isout);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isout)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * target row is out of the partition; supply default value if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * provided.&nbsp; otherwise it'll stay NULL<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (withdefault)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = <a href="../../executor/nodeWindowAgg.c.html#L3594" title="executor/nodeWindowAgg.c:3594">WinGetFuncArgCurrent</a>(winobj, <span class="Constant">2</span>, &amp;isnull);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lag<br/></li>
<li></span><span class="Comment"> * returns the value of VE evaluated on a row that is 1<br/></li>
<li></span><span class="Comment"> * row <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the current row within a partition,<br/></li>
<li></span><span class="Comment"> * per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L580">&#x200c;</a><span class="linkable">window_lag</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(fcinfo, <span class="Constant">false</span>, <span class="Constant">false</span>, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lag_with_offset<br/></li>
<li></span><span class="Comment"> * returns the value of VE evaluated on a row that is OFFSET<br/></li>
<li></span><span class="Comment"> * rows <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the current row within a partition,<br/></li>
<li></span><span class="Comment"> * per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L592">&#x200c;</a><span class="linkable">window_lag_with_offset</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(fcinfo, <span class="Constant">false</span>, <span class="Constant">true</span>, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lag_with_offset_and_default<br/></li>
<li></span><span class="Comment"> * same as lag_with_offset but accepts default value<br/></li>
<li></span><span class="Comment"> * as its third argument.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L603">&#x200c;</a><span class="linkable">window_lag_with_offset_and_default</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(fcinfo, <span class="Constant">false</span>, <span class="Constant">true</span>, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lead<br/></li>
<li></span><span class="Comment"> * returns the value of VE evaluated on a row that is 1<br/></li>
<li></span><span class="Comment"> * row after the current row within a partition,<br/></li>
<li></span><span class="Comment"> * per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L615">&#x200c;</a><span class="linkable">window_lead</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(fcinfo, <span class="Constant">true</span>, <span class="Constant">false</span>, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lead_with_offset<br/></li>
<li></span><span class="Comment"> * returns the value of VE evaluated on a row that is OFFSET<br/></li>
<li></span><span class="Comment"> * number of rows after the current row within a partition,<br/></li>
<li></span><span class="Comment"> * per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L627">&#x200c;</a><span class="linkable">window_lead_with_offset</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(fcinfo, <span class="Constant">true</span>, <span class="Constant">true</span>, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * lead_with_offset_and_default<br/></li>
<li></span><span class="Comment"> * same as lead_with_offset but accepts default value<br/></li>
<li></span><span class="Comment"> * as its third argument.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L638">&#x200c;</a><span class="linkable">window_lead_with_offset_and_default</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L528" title="utils/adt/windowfuncs.c:528">leadlag_common</a>(fcinfo, <span class="Constant">true</span>, <span class="Constant">true</span>, <span class="Constant">true</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * first_value<br/></li>
<li></span><span class="Comment"> * return the value of VE evaluated on the first row of the<br/></li>
<li></span><span class="Comment"> * window frame, per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L649">&#x200c;</a><span class="linkable">window_first_value</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isnull;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../../executor/nodeWindowAgg.c.html#L3399" title="executor/nodeWindowAgg.c:3399">WinGetFuncArgInFrame</a>(winobj, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span>, WINDOW_SEEK_HEAD, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;isnull, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * last_value<br/></li>
<li></span><span class="Comment"> * return the value of VE evaluated on the last row of the<br/></li>
<li></span><span class="Comment"> * window frame, per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L670">&#x200c;</a><span class="linkable">window_last_value</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isnull;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../../executor/nodeWindowAgg.c.html#L3399" title="executor/nodeWindowAgg.c:3399">WinGetFuncArgInFrame</a>(winobj, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span>, WINDOW_SEEK_TAIL, <span class="Constant">true</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;isnull, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * nth_value<br/></li>
<li></span><span class="Comment"> * return the value of VE evaluated on the n-th row from the first<br/></li>
<li></span><span class="Comment"> * row of the window frame, per spec.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L691">&#x200c;</a><span class="linkable">window_nth_value</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WindowObject winobj = PG_WINDOW_OBJECT();<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; const_offset;<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isnull;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; nth;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; nth = DatumGetInt32(<a href="../../executor/nodeWindowAgg.c.html#L3594" title="executor/nodeWindowAgg.c:3594">WinGetFuncArgCurrent</a>(winobj, <span class="Constant">1</span>, &amp;isnull));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; const_offset = <a href="../fmgr/fmgr.c.html#L1975" title="utils/fmgr/fmgr.c:1975">get_fn_expr_arg_stable</a>(fcinfo-&gt;flinfo, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (nth &lt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_ARGUMENT_FOR_NTH_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;argument of nth_value must be greater than zero&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../../executor/nodeWindowAgg.c.html#L3399" title="executor/nodeWindowAgg.c:3399">WinGetFuncArgInFrame</a>(winobj, <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nth - <span class="Constant">1</span>, WINDOW_SEEK_HEAD, const_offset,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;isnull, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_DATUM(result);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
