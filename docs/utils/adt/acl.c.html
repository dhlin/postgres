<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/adt/acl.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/adt/acl.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L80">cached_db_hash</a></li>
<li><a href="#L78">cached_role</a></li>
<li><a href="#L79">cached_roles</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L72">RoleRecurseType</a></li>
<li><a href="#L56">priv_map</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L4914">RoleMembershipCacheCallback</a></li>
<li><a href="#L460">aclconcat</a></li>
<li><a href="#L1589">aclcontains</a></li>
<li><a href="#L440">aclcopy</a></li>
<li><a href="#L786">acldefault</a></li>
<li><a href="#L903">acldefault_sql</a></li>
<li><a href="#L542">aclequal</a></li>
<li><a href="#L1768">aclexplode</a></li>
<li><a href="#L1569">aclinsert</a></li>
<li><a href="#L707">aclitemComparator</a></li>
<li><a href="#L731">aclitem_eq</a></li>
<li><a href="#L696">aclitem_match</a></li>
<li><a href="#L598">aclitemin</a></li>
<li><a href="#L629">aclitemout</a></li>
<li><a href="#L528">aclitemsort</a></li>
<li><a href="#L1365">aclmask</a></li>
<li><a href="#L1454">aclmask_direct</a></li>
<li><a href="#L1517">aclmembers</a></li>
<li><a href="#L484">aclmerge</a></li>
<li><a href="#L1096">aclnewowner</a></li>
<li><a href="#L253">aclparse</a></li>
<li><a href="#L1579">aclremove</a></li>
<li><a href="#L975">aclupdate</a></li>
<li><a href="#L409">allocacl</a></li>
<li><a href="#L573">check_acl</a></li>
<li><a href="#L5185">check_can_set_role</a></li>
<li><a href="#L1199">check_circularity</a></li>
<li><a href="#L5555">check_rolespec_name</a></li>
<li><a href="#L2515">column_privilege_check</a></li>
<li><a href="#L1712">convert_aclright_to_string</a></li>
<li><a href="#L1664">convert_any_priv_string</a></li>
<li><a href="#L2875">convert_column_name</a></li>
<li><a href="#L2933">convert_column_priv_string</a></li>
<li><a href="#L3127">convert_database_name</a></li>
<li><a href="#L3139">convert_database_priv_string</a></li>
<li><a href="#L3333">convert_foreign_data_wrapper_name</a></li>
<li><a href="#L3345">convert_foreign_data_wrapper_priv_string</a></li>
<li><a href="#L3533">convert_function_name</a></li>
<li><a href="#L3554">convert_function_priv_string</a></li>
<li><a href="#L3742">convert_language_name</a></li>
<li><a href="#L3754">convert_language_priv_string</a></li>
<li><a href="#L4653">convert_parameter_priv_string</a></li>
<li><a href="#L4831">convert_role_priv_string</a></li>
<li><a href="#L3942">convert_schema_name</a></li>
<li><a href="#L3954">convert_schema_priv_string</a></li>
<li><a href="#L2278">convert_sequence_priv_string</a></li>
<li><a href="#L4144">convert_server_name</a></li>
<li><a href="#L4156">convert_server_priv_string</a></li>
<li><a href="#L2026">convert_table_name</a></li>
<li><a href="#L2041">convert_table_priv_string</a></li>
<li><a href="#L4344">convert_tablespace_name</a></li>
<li><a href="#L4356">convert_tablespace_priv_string</a></li>
<li><a href="#L4543">convert_type_name</a></li>
<li><a href="#L4564">convert_type_priv_string</a></li>
<li><a href="#L5298">count_one_bits</a></li>
<li><a href="#L5414">get_role_oid</a></li>
<li><a href="#L5432">get_role_oid_or_public</a></li>
<li><a href="#L5533">get_rolespec_name</a></li>
<li><a href="#L5448">get_rolespec_oid</a></li>
<li><a href="#L5487">get_rolespec_tuple</a></li>
<li><a href="#L149">getid</a></li>
<li><a href="#L2404">has_any_column_privilege_id</a></li>
<li><a href="#L2464">has_any_column_privilege_id_id</a></li>
<li><a href="#L2437">has_any_column_privilege_id_name</a></li>
<li><a href="#L2341">has_any_column_privilege_name</a></li>
<li><a href="#L2369">has_any_column_privilege_name_id</a></li>
<li><a href="#L2311">has_any_column_privilege_name_name</a></li>
<li><a href="#L2847">has_column_privilege_id_attnum</a></li>
<li><a href="#L2740">has_column_privilege_id_id_attnum</a></li>
<li><a href="#L2715">has_column_privilege_id_id_name</a></li>
<li><a href="#L2820">has_column_privilege_id_name</a></li>
<li><a href="#L2690">has_column_privilege_id_name_attnum</a></li>
<li><a href="#L2663">has_column_privilege_id_name_name</a></li>
<li><a href="#L2793">has_column_privilege_name_attnum</a></li>
<li><a href="#L2638">has_column_privilege_name_id_attnum</a></li>
<li><a href="#L2611">has_column_privilege_name_id_name</a></li>
<li><a href="#L2764">has_column_privilege_name_name</a></li>
<li><a href="#L2584">has_column_privilege_name_name_attnum</a></li>
<li><a href="#L2555">has_column_privilege_name_name_name</a></li>
<li><a href="#L3047">has_database_privilege_id</a></li>
<li><a href="#L3098">has_database_privilege_id_id</a></li>
<li><a href="#L3075">has_database_privilege_id_name</a></li>
<li><a href="#L2993">has_database_privilege_name</a></li>
<li><a href="#L3017">has_database_privilege_name_id</a></li>
<li><a href="#L2967">has_database_privilege_name_name</a></li>
<li><a href="#L3253">has_foreign_data_wrapper_privilege_id</a></li>
<li><a href="#L3304">has_foreign_data_wrapper_privilege_id_id</a></li>
<li><a href="#L3281">has_foreign_data_wrapper_privilege_id_name</a></li>
<li><a href="#L3199">has_foreign_data_wrapper_privilege_name</a></li>
<li><a href="#L3223">has_foreign_data_wrapper_privilege_name_id</a></li>
<li><a href="#L3173">has_foreign_data_wrapper_privilege_name_name</a></li>
<li><a href="#L3453">has_function_privilege_id</a></li>
<li><a href="#L3504">has_function_privilege_id_id</a></li>
<li><a href="#L3481">has_function_privilege_id_name</a></li>
<li><a href="#L3399">has_function_privilege_name</a></li>
<li><a href="#L3423">has_function_privilege_name_id</a></li>
<li><a href="#L3373">has_function_privilege_name_name</a></li>
<li><a href="#L3662">has_language_privilege_id</a></li>
<li><a href="#L3713">has_language_privilege_id_id</a></li>
<li><a href="#L3690">has_language_privilege_id_name</a></li>
<li><a href="#L3608">has_language_privilege_name</a></li>
<li><a href="#L3632">has_language_privilege_name_id</a></li>
<li><a href="#L3582">has_language_privilege_name_name</a></li>
<li><a href="#L4592">has_param_priv_byname</a></li>
<li><a href="#L4635">has_parameter_privilege_id_name</a></li>
<li><a href="#L4621">has_parameter_privilege_name</a></li>
<li><a href="#L4605">has_parameter_privilege_name_name</a></li>
<li><a href="#L5128">has_privs_of_role</a></li>
<li><a href="#L3862">has_schema_privilege_id</a></li>
<li><a href="#L3913">has_schema_privilege_id_id</a></li>
<li><a href="#L3890">has_schema_privilege_id_name</a></li>
<li><a href="#L3808">has_schema_privilege_name</a></li>
<li><a href="#L3832">has_schema_privilege_name_id</a></li>
<li><a href="#L3782">has_schema_privilege_name_name</a></li>
<li><a href="#L2182">has_sequence_privilege_id</a></li>
<li><a href="#L2245">has_sequence_privilege_id_id</a></li>
<li><a href="#L2217">has_sequence_privilege_id_name</a></li>
<li><a href="#L2116">has_sequence_privilege_name</a></li>
<li><a href="#L2145">has_sequence_privilege_name_id</a></li>
<li><a href="#L2085">has_sequence_privilege_name_name</a></li>
<li><a href="#L4064">has_server_privilege_id</a></li>
<li><a href="#L4115">has_server_privilege_id_id</a></li>
<li><a href="#L4092">has_server_privilege_id_name</a></li>
<li><a href="#L4010">has_server_privilege_name</a></li>
<li><a href="#L4034">has_server_privilege_name_id</a></li>
<li><a href="#L3984">has_server_privilege_name_name</a></li>
<li><a href="#L1950">has_table_privilege_id</a></li>
<li><a href="#L1999">has_table_privilege_id_id</a></li>
<li><a href="#L1976">has_table_privilege_id_name</a></li>
<li><a href="#L1898">has_table_privilege_name</a></li>
<li><a href="#L1922">has_table_privilege_name_id</a></li>
<li><a href="#L1872">has_table_privilege_name_name</a></li>
<li><a href="#L4264">has_tablespace_privilege_id</a></li>
<li><a href="#L4315">has_tablespace_privilege_id_id</a></li>
<li><a href="#L4292">has_tablespace_privilege_id_name</a></li>
<li><a href="#L4210">has_tablespace_privilege_name</a></li>
<li><a href="#L4234">has_tablespace_privilege_name_id</a></li>
<li><a href="#L4184">has_tablespace_privilege_name_name</a></li>
<li><a href="#L4463">has_type_privilege_id</a></li>
<li><a href="#L4514">has_type_privilege_id_id</a></li>
<li><a href="#L4491">has_type_privilege_id_name</a></li>
<li><a href="#L4409">has_type_privilege_name</a></li>
<li><a href="#L4433">has_type_privilege_name_id</a></li>
<li><a href="#L4383">has_type_privilege_name_name</a></li>
<li><a href="#L751">hash_aclitem</a></li>
<li><a href="#L765">hash_aclitem_extended</a></li>
<li><a href="#L4884">initialize_acl</a></li>
<li><a href="#L5258">is_admin_of_role</a></li>
<li><a href="#L5208">is_member_of_role</a></li>
<li><a href="#L5236">is_member_of_role_nosuper</a></li>
<li><a href="#L431">make_empty_acl</a></li>
<li><a href="#L1611">makeaclitem</a></li>
<li><a href="#L5162">member_can_set_role</a></li>
<li><a href="#L4756">pg_has_role_id</a></li>
<li><a href="#L4801">pg_has_role_id_id</a></li>
<li><a href="#L4778">pg_has_role_id_name</a></li>
<li><a href="#L4708">pg_has_role_name</a></li>
<li><a href="#L4732">pg_has_role_name_id</a></li>
<li><a href="#L4682">pg_has_role_name_name</a></li>
<li><a href="#L4854">pg_role_aclcheck</a></li>
<li><a href="#L201">putid</a></li>
<li><a href="#L1279">recursive_revoke</a></li>
<li><a href="#L4996">roles_is_member_of</a></li>
<li><a href="#L4936">roles_list_append</a></li>
<li><a href="#L5283">select_best_admin</a></li>
<li><a href="#L5338">select_best_grantor</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L88">ROLES_LIST_BLOOM_THRESHOLD</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * acl.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Basic access control list data structures manipulation routines.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/adt/acl.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;ctype.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/htup_details.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/catalog.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/namespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_auth_members.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_authid.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_class.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_database.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_foreign_data_wrapper.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_foreign_server.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_language.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_namespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_proc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_tablespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_type.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;commands/dbcommands.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;commands/proclang.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;commands/tablespace.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;common/hashfn.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;foreign/foreign.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;funcapi.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lib/bloomfilter.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;lib/qunique.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/acl.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/array.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/catcache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/inval.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/lsyscache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/syscache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/varlena.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; value;<br/></li>
<li><a id="L56">&#x200c;</a>} <span class="linkable">priv_map</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * We frequently need to test whether a given role is a member of some other<br/></li>
<li></span><span class="Comment"> * role.&nbsp; In most of these tests the &quot;given role&quot; is the same, namely the<br/></li>
<li></span><span class="Comment"> * active current user.&nbsp; So we can <a href="../../regex/regc_nfa.c.html#L1593" title="regex/regc_nfa.c:1593">optimize</a> it by keeping cached lists of all<br/></li>
<li></span><span class="Comment"> * the roles the &quot;given role&quot; is a member of, directly or indirectly.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Possibly this mechanism should be generalized to allow caching membership<br/></li>
<li></span><span class="Comment"> * info for multiple roles?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Each <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> of <a href="#L79" title="utils/adt/acl.c:79">cached_roles</a> is an OID list of constituent roles for the<br/></li>
<li></span><span class="Comment"> * corresponding <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> of <a href="#L78" title="utils/adt/acl.c:78">cached_role</a> (always including the <a href="#L78" title="utils/adt/acl.c:78">cached_role</a><br/></li>
<li></span><span class="Comment"> * itself).&nbsp; There's a separate cache for each <a href="#L72" title="utils/adt/acl.c:72">RoleRecurseType</a>, with the<br/></li>
<li></span><span class="Comment"> * corresponding semantics.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L72">&#x200c;</a></span><span class="Type">enum</span> <span class="linkable">RoleRecurseType</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ROLERECURSE_MEMBERS = <span class="Constant">0</span>,&nbsp; &nbsp; <span class="Comment">/* recurse unconditionally */<br/></li>
<li></span>&nbsp; &nbsp; ROLERECURSE_PRIVS = <span class="Constant">1</span>,&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* recurse through inheritable grants */<br/></li>
<li></span>&nbsp; &nbsp; ROLERECURSE_SETROLE = <span class="Constant">2</span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* recurse through grants with set_option */<br/></li>
<li></span>};<br/></li>
<li><a id="L78">&#x200c;</a><span class="Type">static</span> Oid&nbsp; &nbsp; <span class="linkable">cached_role</span>[] = {InvalidOid, InvalidOid, InvalidOid};<br/></li>
<li><a id="L79">&#x200c;</a><span class="Type">static</span> List *<span class="linkable">cached_roles</span>[] = {NIL, NIL, NIL};<br/></li>
<li><a id="L80">&#x200c;</a><span class="Type">static</span> uint32 <span class="linkable">cached_db_hash</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * If the list of roles gathered by <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>() grows larger than the<br/></li>
<li></span><span class="Comment"> * below threshold, a Bloom filter is created to speed up list membership<br/></li>
<li></span><span class="Comment"> * checks.&nbsp; This threshold is set arbitrarily high to avoid the overhead of<br/></li>
<li></span><span class="Comment"> * creating the Bloom filter until it seems likely to provide a net benefit.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L88">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">ROLES_LIST_BLOOM_THRESHOLD</span> </span><span class="Constant">1024<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<a href="#L149" title="utils/adt/acl.c:149">getid</a>(<span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">char</span> *n, Node *escontext);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L201" title="utils/adt/acl.c:201">putid</a>(<span class="Type">char</span> *p, <span class="Type">const</span> <span class="Type">char</span> *s);<br/></li>
<li><span class="Type">static</span> Acl *<a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(<span class="Type">int</span> n);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(<span class="Type">const</span> Acl *acl);<br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<a href="#L253" title="utils/adt/acl.c:253">aclparse</a>(<span class="Type">const</span> <span class="Type">char</span> *s, AclItem *aip, Node *escontext);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L696" title="utils/adt/acl.c:696">aclitem_match</a>(<span class="Type">const</span> AclItem *<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>, <span class="Type">const</span> AclItem *<a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>);<br/></li>
<li><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <a href="#L707" title="utils/adt/acl.c:707">aclitemComparator</a>(<span class="Type">const</span> <span class="Type">void</span> *arg1, <span class="Type">const</span> <span class="Type">void</span> *arg2);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1199" title="utils/adt/acl.c:1199">check_circularity</a>(<span class="Type">const</span> Acl *old_acl, <span class="Type">const</span> AclItem *mod_aip,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid ownerId);<br/></li>
<li><span class="Type">static</span> Acl *<a href="#L1279" title="utils/adt/acl.c:1279">recursive_revoke</a>(Acl *acl, Oid grantee, AclMode revoke_privs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Oid ownerId, DropBehavior behavior);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> AclMode <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(text *priv_type_text,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> *privileges);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(text *tablename);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> AttrNumber <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(Oid tableoid, text *column);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L3127" title="utils/adt/acl.c:3127">convert_database_name</a>(text *databasename);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L3333" title="utils/adt/acl.c:3333">convert_foreign_data_wrapper_name</a>(text *fdwname);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L3533" title="utils/adt/acl.c:3533">convert_function_name</a>(text *functionname);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L3742" title="utils/adt/acl.c:3742">convert_language_name</a>(text *languagename);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L3942" title="utils/adt/acl.c:3942">convert_schema_name</a>(text *schemaname);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L4144" title="utils/adt/acl.c:4144">convert_server_name</a>(text *servername);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L4344" title="utils/adt/acl.c:4344">convert_tablespace_name</a>(text *tablespacename);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> Oid&nbsp; &nbsp; <a href="#L4543" title="utils/adt/acl.c:4543">convert_type_name</a>(text *typename);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L4653" title="utils/adt/acl.c:4653">convert_parameter_priv_string</a>(text *priv_text);<br/></li>
<li><span class="Type">static</span> AclMode <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(text *priv_type_text);<br/></li>
<li><span class="Type">static</span> AclResult <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(Oid role_oid, Oid roleid, AclMode mode);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L4914" title="utils/adt/acl.c:4914">RoleMembershipCacheCallback</a>(Datum arg, <span class="Type">int</span> cacheid, uint32 hashvalue);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L149" title="utils/adt/acl.c:149">getid</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Consumes the first alphanumeric string (identifier) found in string<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; 's', ignoring <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> leading white space.&nbsp; If it finds a double quote<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; it returns the <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a> inside the quotes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * RETURNS:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the string position in 's' that points to the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> non-space character<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; in 's', after <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> quotes.&nbsp; Also:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; - loads the identifier into 'n'.&nbsp; (If no identifier is found, 'n'<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; contains an empty string.)&nbsp; 'n' must be NAMEDATALEN bytes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Errors are reported via ereport, unless escontext is an ErrorSaveData node,<br/></li>
<li></span><span class="Comment"> * in which case we log the error there and return NULL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L149">&#x200c;</a><span class="linkable">getid</span>(<span class="Type">const</span> <span class="Type">char</span> *s, <span class="Type">char</span> *n, Node *escontext)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; in_quotes = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(s &amp;&amp; n);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *s))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s++;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* This code had better match what <a href="#L201" title="utils/adt/acl.c:201">putid</a>() does, below */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *s != <span class="Special">'\0'</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (isalnum((<span class="Type">unsigned</span> <span class="Type">char</span>) *s) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *s == <span class="Constant">'<a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>'</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *s == <span class="Constant">'&quot;'</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in_quotes);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; s++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*s == <span class="Constant">'&quot;'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* safe to look at <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> char (could be '\0' though) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*(s + <span class="Constant">1</span>) != <span class="Constant">'&quot;'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in_quotes = !in_quotes;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* it's an escaped double quote; <a href="../../regex/regc_lex.c.html#L982" title="regex/regc_lex.c:982">skip</a> the escaping char */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; s++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Add the character to the string */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt;= NAMEDATALEN - <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NAME_TOO_LONG),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;identifier too long&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1205" title="utils/error/elog.c:1205">errdetail</a>(<span class="Constant">&quot;Identifier must be less than </span><span class="Special">%d</span><span class="Constant"> characters.&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NAMEDATALEN)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; n[len++] = *s;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; n[len] = <span class="Special">'\0'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *s))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Write a role name at *p, adding double quotes if needed.<br/></li>
<li></span><span class="Comment"> * There must be at least (2*NAMEDATALEN)+2 bytes available at *p.<br/></li>
<li></span><span class="Comment"> * This needs to be kept in sync with dequoteAclUserName in pg_dump/dumputils.c<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L201">&#x200c;</a></span><span class="linkable">putid</span>(<span class="Type">char</span> *p, <span class="Type">const</span> <span class="Type">char</span> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *src;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; safe = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (src = s; *src; src++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* This test had better match what <a href="#L149" title="utils/adt/acl.c:149">getid</a>() does, above */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!isalnum((<span class="Type">unsigned</span> <span class="Type">char</span>) *src) &amp;&amp; *src != <span class="Constant">'<a href="../error/elog.c.html#L89" title="utils/error/elog.c:89">_</a>'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; safe = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!safe)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'&quot;'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (src = s; *src; src++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* A double quote character in a username is encoded as &quot;&quot; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*src == <span class="Constant">'&quot;'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'&quot;'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = *src;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!safe)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'&quot;'</span>;<br/></li>
<li>&nbsp; &nbsp; *p = <span class="Special">'\0'</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L253" title="utils/adt/acl.c:253">aclparse</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Consumes and parses an ACL specification of the form:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [group|user] [A-Za-z0-9]*=[rwaR]*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; from string 's', ignoring <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> leading white space or white space<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; between the optional id type keyword (group|user) and the actual<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; ACL specification.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The group|user decoration is unnecessary in the roles world,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; but we still <a href="../../port/win32/socket.c.html#L34" title="port/win32/socket.c:34">accept</a> it for backward compatibility.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; This routine is called by the parser as well as <a href="#L598" title="utils/adt/acl.c:598">aclitemin</a>(), hence<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the added generality.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * RETURNS:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the string position in 's' immediately following the ACL<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; specification.&nbsp; Also:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; - loads the structure pointed to by 'aip' with the appropriate<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UID/GID, id type identifier and mode type <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Errors are reported via ereport, unless escontext is an ErrorSaveData node,<br/></li>
<li></span><span class="Comment"> * in which case we log the error there and return NULL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L253">&#x200c;</a><span class="linkable">aclparse</span>(<span class="Type">const</span> <span class="Type">char</span> *s, AclItem *aip, Node *escontext)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; privs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goption,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; name[NAMEDATALEN];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; name2[NAMEDATALEN];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(s &amp;&amp; aip);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = <a href="#L149" title="utils/adt/acl.c:149">getid</a>(s, name, escontext);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*s != <span class="Constant">'='</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we just read a keyword, not a name */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strcmp(name, <span class="Constant">&quot;group&quot;</span>) != <span class="Constant">0</span> &amp;&amp; strcmp(name, <span class="Constant">&quot;user&quot;</span>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_TEXT_REPRESENTATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;unrecognized key <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a>: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, name),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;ACL key <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a> must be </span><span class="Special">\&quot;</span><span class="Constant">group</span><span class="Special">\&quot;</span><span class="Constant"> or </span><span class="Special">\&quot;</span><span class="Constant">user</span><span class="Special">\&quot;</span><span class="Constant">.&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* move s to the name beyond the keyword */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L149" title="utils/adt/acl.c:149">getid</a>(s, name, escontext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name[<span class="Constant">0</span>] == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_TEXT_REPRESENTATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;missing name&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;A name must follow the </span><span class="Special">\&quot;</span><span class="Constant">group</span><span class="Special">\&quot;</span><span class="Constant"> or </span><span class="Special">\&quot;</span><span class="Constant">user</span><span class="Special">\&quot;</span><span class="Constant"> key <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a>.&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*s != <span class="Constant">'='</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_TEXT_REPRESENTATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;missing </span><span class="Special">\&quot;</span><span class="Constant">=</span><span class="Special">\&quot;</span><span class="Constant"> sign&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privs = goption = ACL_NO_RIGHTS;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (++s, read = <span class="Constant">0</span>; isalpha((<span class="Type">unsigned</span> <span class="Type">char</span>) *s) || *s == <span class="Constant">'*'</span>; s++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (*s)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'*'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goption |= read;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_INSERT_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_INSERT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_SELECT_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_SELECT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_UPDATE_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_UPDATE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_DELETE_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_DELETE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_TRUNCATE_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_TRUNCATE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_REFERENCES_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_REFERENCES;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_TRIGGER_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_TRIGGER;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_EXECUTE_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_EXECUTE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_USAGE_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_USAGE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_CREATE_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_CREATE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_CREATE_TEMP_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_CREATE_TEMP;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_CONNECT_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_CONNECT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_SET_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_SET;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_ALTER_SYSTEM_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_ALTER_SYSTEM;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_MAINTAIN_CHR:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = ACL_MAINTAIN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'R'</span>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ignore old RULE privileges */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_TEXT_REPRESENTATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;invalid mode character: must be one of </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACL_ALL_RIGHTS_STR)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; privs |= read;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (name[<span class="Constant">0</span>] == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantee = ACL_ID_PUBLIC;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantee = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(name, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(aip-&gt;ai_grantee))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, name)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * </span><span class="Todo">XXX</span><span class="Comment"> Allow a degree of backward compatibility by defaulting the grantor<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * to the <a href="../misc/superuser.c.html#L46" title="utils/misc/superuser.c:46">superuser</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (*s == <span class="Constant">'/'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; s = <a href="#L149" title="utils/adt/acl.c:149">getid</a>(s + <span class="Constant">1</span>, name2, escontext);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (name2[<span class="Constant">0</span>] == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_TEXT_REPRESENTATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;a name must follow the </span><span class="Special">\&quot;</span><span class="Constant">/</span><span class="Special">\&quot;</span><span class="Constant"> sign&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantor = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(name2, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(aip-&gt;ai_grantor))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, <span class="Constant">NULL</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, name2)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantor = BOOTSTRAP_SUPERUSERID;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(WARNING,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_GRANTOR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;defaulting grantor to user ID </span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BOOTSTRAP_SUPERUSERID)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ACLITEM_SET_PRIVS_GOPTIONS(*aip, privs, goption);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> s;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L409" title="utils/adt/acl.c:409">allocacl</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Allocates storage for a new Acl with 'n' entries.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * RETURNS:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the new Acl<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Acl *<br/></li>
<li><a id="L409">&#x200c;</a><span class="linkable">allocacl</span>(<span class="Type">int</span> n)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *new_acl;<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (n &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;invalid size: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, n);<br/></li>
<li>&nbsp; &nbsp; size = ACL_N_SIZE(n);<br/></li>
<li>&nbsp; &nbsp; new_acl = (Acl *) <a href="../mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(size);<br/></li>
<li>&nbsp; &nbsp; SET_VARSIZE(new_acl, size);<br/></li>
<li>&nbsp; &nbsp; new_acl-&gt;ndim = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; new_acl-&gt;dataoffset = <span class="Constant">0</span>;&nbsp; &nbsp; <span class="Comment">/* we never put in <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> nulls */<br/></li>
<li></span>&nbsp; &nbsp; new_acl-&gt;elemtype = ACLITEMOID;<br/></li>
<li>&nbsp; &nbsp; ARR_LBOUND(new_acl)[<span class="Constant">0</span>] = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; ARR_DIMS(new_acl)[<span class="Constant">0</span>] = n;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> new_acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Create a zero-entry ACL<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L431">&#x200c;</a><span class="linkable">make_empty_acl</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(<span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Copy an ACL<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L440">&#x200c;</a><span class="linkable">aclcopy</span>(<span class="Type">const</span> Acl *orig_acl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *result_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result_acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(ACL_NUM(orig_acl));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy(ACL_DAT(result_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_DAT(orig_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_NUM(orig_acl) * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result_acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Concatenate two ACLs<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is a <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> cheesy, since we may produce an ACL with redundant entries.<br/></li>
<li></span><span class="Comment"> * Be careful what the result is used for!<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L460">&#x200c;</a><span class="linkable">aclconcat</span>(<span class="Type">const</span> Acl *left_acl, <span class="Type">const</span> Acl *right_acl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *result_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result_acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(ACL_NUM(left_acl) + ACL_NUM(right_acl));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy(ACL_DAT(result_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_DAT(left_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_NUM(left_acl) * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy(ACL_DAT(result_acl) + ACL_NUM(left_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_DAT(right_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_NUM(right_acl) * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result_acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Merge two ACLs<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This produces a properly merged ACL with no redundant entries.<br/></li>
<li></span><span class="Comment"> * Returns NULL on NULL input.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L484">&#x200c;</a><span class="linkable">aclmerge</span>(<span class="Type">const</span> Acl *left_acl, <span class="Type">const</span> Acl *right_acl, Oid ownerId)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *result_acl;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check for cases where one or both are empty/null */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (left_acl == <span class="Constant">NULL</span> || ACL_NUM(left_acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (right_acl == <span class="Constant">NULL</span> || ACL_NUM(right_acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L440" title="utils/adt/acl.c:440">aclcopy</a>(right_acl);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (right_acl == <span class="Constant">NULL</span> || ACL_NUM(right_acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L440" title="utils/adt/acl.c:440">aclcopy</a>(left_acl);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Merge them the hard way, one item at a time */<br/></li>
<li></span>&nbsp; &nbsp; result_acl = <a href="#L440" title="utils/adt/acl.c:440">aclcopy</a>(left_acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aip = ACL_DAT(right_acl);<br/></li>
<li>&nbsp; &nbsp; num = ACL_NUM(right_acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; i++, aip++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *tmp_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; tmp_acl = <a href="#L975" title="utils/adt/acl.c:975">aclupdate</a>(result_acl, aip, ACL_MODECHG_ADD,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ownerId, DROP_RESTRICT);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(result_acl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result_acl = tmp_acl;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result_acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Sort the items in an ACL (into an arbitrary but consistent order)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L528">&#x200c;</a></span><span class="linkable">aclitemsort</span>(Acl *acl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (acl != <span class="Constant">NULL</span> &amp;&amp; ACL_NUM(acl) &gt; <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qsort(ACL_DAT(acl), ACL_NUM(acl), <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem), <a href="#L707" title="utils/adt/acl.c:707">aclitemComparator</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Check if two ACLs are exactly <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This will not detect equality if the two arrays contain the same items<br/></li>
<li></span><span class="Comment"> * in different orders.&nbsp; To handle that case, sort both inputs first,<br/></li>
<li></span><span class="Comment"> * using <a href="#L528" title="utils/adt/acl.c:528">aclitemsort</a>().<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L542">&#x200c;</a></span><span class="linkable">aclequal</span>(<span class="Type">const</span> Acl *left_acl, <span class="Type">const</span> Acl *right_acl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check for cases where one or both are empty/null */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (left_acl == <span class="Constant">NULL</span> || ACL_NUM(left_acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (right_acl == <span class="Constant">NULL</span> || ACL_NUM(right_acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (right_acl == <span class="Constant">NULL</span> || ACL_NUM(right_acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ACL_NUM(left_acl) != ACL_NUM(right_acl))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (memcmp(ACL_DAT(left_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_DAT(right_acl),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_NUM(left_acl) * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem)) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Verify that an ACL array is acceptable (one-dimensional and has no nulls)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L573">&#x200c;</a></span><span class="linkable">check_acl</span>(<span class="Type">const</span> Acl *acl)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ARR_ELEMTYPE(acl) != ACLITEMOID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;ACL array contains wrong data type&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ARR_NDIM(acl) != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;ACL arrays must be one-dimensional&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ARR_HASNULL(acl))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NULL_VALUE_NOT_ALLOWED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;ACL arrays must not contain null <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>&quot;</span>)));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L598" title="utils/adt/acl.c:598">aclitemin</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Allocates storage for, and fills in, a new AclItem given a string<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; 's' that contains an ACL specification.&nbsp; See <a href="#L253" title="utils/adt/acl.c:253">aclparse</a> for details.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * RETURNS:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the new AclItem<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L598">&#x200c;</a><span class="linkable">aclitemin</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *s = PG_GETARG_CSTRING(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Node&nbsp; &nbsp; &nbsp;&nbsp; *escontext = fcinfo-&gt;context;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aip = (AclItem *) <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; s = <a href="#L253" title="utils/adt/acl.c:253">aclparse</a>(s, aip, escontext);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (s == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *s))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ++s;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*s)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereturn(escontext, (Datum) <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_TEXT_REPRESENTATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;extra garbage at the end of the ACL specification&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_ACLITEM_P(aip);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L629" title="utils/adt/acl.c:629">aclitemout</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Allocates storage for, and fills in, a new null-delimited string<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; containing a formatted ACL specification.&nbsp; See <a href="#L253" title="utils/adt/acl.c:253">aclparse</a> for details.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * RETURNS:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the new string<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L629">&#x200c;</a><span class="linkable">aclitemout</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip = PG_GETARG_ACLITEM_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *out;<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; htup;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span>&nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; out = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(strlen(<span class="Constant">&quot;=/&quot;</span>) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">2</span> * N_ACL_RIGHTS +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">2</span> * (<span class="Constant">2</span> * NAMEDATALEN + <span class="Constant">2</span>) +<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; p = out;<br/></li>
<li>&nbsp; &nbsp; *p = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aip-&gt;ai_grantee != ACL_ID_PUBLIC)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; htup = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(AUTHOID, ObjectIdGetDatum(aip-&gt;ai_grantee));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (HeapTupleIsValid(htup))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L201" title="utils/adt/acl.c:201">putid</a>(p, NameStr(((Form_pg_authid) GETSTRUCT(htup))-&gt;rolname));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(htup);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Generate <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> OID if we don't <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> an entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(p, <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">&quot;</span>, aip-&gt;ai_grantee);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (*p)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ++p;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p++ = <span class="Constant">'='</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; N_ACL_RIGHTS; ++i)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ACLITEM_GET_PRIVS(*aip) &amp; (UINT64CONST(<span class="Constant">1</span>) &lt;&lt; i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = ACL_ALL_RIGHTS_STR[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ACLITEM_GET_GOPTIONS(*aip) &amp; (UINT64CONST(<span class="Constant">1</span>) &lt;&lt; i))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *p++ = <span class="Constant">'*'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *p++ = <span class="Constant">'/'</span>;<br/></li>
<li>&nbsp; &nbsp; *p = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; htup = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(AUTHOID, ObjectIdGetDatum(aip-&gt;ai_grantor));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (HeapTupleIsValid(htup))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L201" title="utils/adt/acl.c:201">putid</a>(p, NameStr(((Form_pg_authid) GETSTRUCT(htup))-&gt;rolname));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(htup);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Generate <a href="numeric.c.html#L1237" title="utils/adt/numeric.c:1237">numeric</a> OID if we don't <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> an entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; sprintf(p, <span class="Constant">&quot;</span><span class="Special">%u</span><span class="Constant">&quot;</span>, aip-&gt;ai_grantor);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_CSTRING(out);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L696" title="utils/adt/acl.c:696">aclitem_match</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Two AclItems are considered to match iff they have the same<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; grantee and grantor; the privileges are ignored.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L696">&#x200c;</a></span><span class="linkable">aclitem_match</span>(<span class="Type">const</span> AclItem *<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>, <span class="Type">const</span> AclItem *<a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantee == <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantee &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantor == <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantor;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L707" title="utils/adt/acl.c:707">aclitemComparator</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; qsort comparison function for AclItems<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L707">&#x200c;</a></span><span class="linkable">aclitemComparator</span>(<span class="Type">const</span> <span class="Type">void</span> *arg1, <span class="Type">const</span> <span class="Type">void</span> *arg2)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> AclItem *<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a> = (<span class="Type">const</span> AclItem *) arg1;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> AclItem *<a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a> = (<span class="Type">const</span> AclItem *) arg2;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantee &gt; <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantee)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantee &lt; <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantee)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantor &gt; <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantor)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantor &lt; <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantor)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_privs &gt; <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_privs)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_privs &lt; <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_privs)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * aclitem equality operator<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L731">&#x200c;</a><span class="linkable">aclitem_eq</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *<a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a> = PG_GETARG_ACLITEM_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *<a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a> = PG_GETARG_ACLITEM_P(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_privs == <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_privs &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantee == <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantee &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../catalog/heap.c.html#L142" title="catalog/heap.c:142">a1</a>-&gt;ai_grantor == <a href="../../catalog/heap.c.html#L156" title="catalog/heap.c:156">a2</a>-&gt;ai_grantor;<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * aclitem <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> function<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We make aclitems hashable not so much because anyone is likely to <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a><br/></li>
<li></span><span class="Comment"> * them, as because we want array equality to work on aclitem arrays, and<br/></li>
<li></span><span class="Comment"> * with the typcache mechanism we must have a <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> or btree opclass.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L751">&#x200c;</a><span class="linkable">hash_aclitem</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *a = PG_GETARG_ACLITEM_P(<span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* not very bright, but avoids <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> issue of padding in struct */<br/></li>
<li></span>&nbsp; &nbsp; PG_RETURN_UINT32((uint32) (a-&gt;ai_privs + a-&gt;ai_grantee + a-&gt;ai_grantor));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * 64-<a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> function for aclitem.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Similar to <a href="#L751" title="utils/adt/acl.c:751">hash_aclitem</a>, but accepts a seed and returns a uint64 value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L765">&#x200c;</a><span class="linkable">hash_aclitem_extended</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *a = PG_GETARG_ACLITEM_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; uint64&nbsp; &nbsp; &nbsp; &nbsp; seed = PG_GETARG_INT64(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; sum = (uint32) (a-&gt;ai_privs + a-&gt;ai_grantee + a-&gt;ai_grantor);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (seed == <span class="Constant">0</span>) ? UInt64GetDatum(sum) : hash_uint32_extended(sum, seed);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L786" title="utils/adt/acl.c:786">acldefault</a>()&nbsp; --- create an ACL describing default access permissions<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Change this routine if you want to alter the default access policy for<br/></li>
<li></span><span class="Comment"> * newly-created objects (or <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> object with a NULL acl entry).&nbsp; When<br/></li>
<li></span><span class="Comment"> * you make a change here, don't forget to update the GRANT man page,<br/></li>
<li></span><span class="Comment"> * which explains all the default permissions.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that these are the hard-wired &quot;defaults&quot; that are used in the<br/></li>
<li></span><span class="Comment"> * absence of <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> pg_default_acl entry.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L786">&#x200c;</a><span class="linkable">acldefault</span>(ObjectType objtype, Oid ownerId)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; world_default;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; owner_default;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nacl;<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *acl;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (objtype)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_COLUMN:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* by default, columns have no extra privileges */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_TABLE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_RELATION;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_SEQUENCE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_SEQUENCE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_DATABASE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* for backwards compatibility, grant some rights by default */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_CREATE_TEMP | ACL_CONNECT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_DATABASE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_FUNCTION:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Grant EXECUTE by default, for <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_EXECUTE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_FUNCTION;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_LANGUAGE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Grant USAGE by default, for <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_USAGE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_LANGUAGE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_LARGEOBJECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_LARGEOBJECT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_SCHEMA:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_SCHEMA;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_TABLESPACE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_TABLESPACE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_FDW:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_FDW;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_FOREIGN_SERVER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_FOREIGN_SERVER;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_DOMAIN:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_TYPE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_USAGE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_TYPE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> OBJECT_PARAMETER_ACL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_ALL_RIGHTS_PARAMETER_ACL;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized object type: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, (<span class="Type">int</span>) objtype);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; world_default = ACL_NO_RIGHTS;&nbsp; &nbsp; <span class="Comment">/* keep compiler quiet */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner_default = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; nacl = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (world_default != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nacl++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner_default != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nacl++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(nacl);<br/></li>
<li>&nbsp; &nbsp; aip = ACL_DAT(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (world_default != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantee = ACL_ID_PUBLIC;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantor = ownerId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_PRIVS_GOPTIONS(*aip, world_default, ACL_NO_RIGHTS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note that the owner's entry shows all ordinary privileges but no grant<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * options.&nbsp; This is because his grant options come &quot;from the system&quot; and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * not from his own efforts.&nbsp; (The SQL spec says that the owner's rights<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * come from a &quot;_SYSTEM&quot; authid.)&nbsp; However, we do consider that the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * owner's ordinary privileges are self-granted; this lets him revoke<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * them.&nbsp; We implement the owner's grant options without <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> explicit<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * &quot;_SYSTEM&quot;-like ACL entry, by internally special-casing the owner<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * wherever we are testing grant options.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner_default != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantee = ownerId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantor = ownerId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_PRIVS_GOPTIONS(*aip, owner_default, ACL_NO_RIGHTS);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * SQL-accessible version of <a href="#L786" title="utils/adt/acl.c:786">acldefault</a>().&nbsp; Hackish mapping from &quot;char&quot; type to<br/></li>
<li></span><span class="Comment"> * OBJECT_* <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L903">&#x200c;</a><span class="linkable">acldefault_sql</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; objtypec = PG_GETARG_CHAR(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; ObjectType&nbsp; &nbsp; objtype = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (objtypec)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'c'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_COLUMN;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'r'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_TABLE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'s'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_SEQUENCE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'d'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_DATABASE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'f'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_FUNCTION;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'l'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_LANGUAGE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'L'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_LARGEOBJECT;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'n'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_SCHEMA;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'p'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_PARAMETER_ACL;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'t'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_TABLESPACE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'F'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_FDW;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'S'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_FOREIGN_SERVER;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> <span class="Constant">'T'</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; objtype = OBJECT_TYPE;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized object type abbreviation: </span><span class="Special">%c</span><span class="Constant">&quot;</span>, objtypec);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_ACL_P(<a href="#L786" title="utils/adt/acl.c:786">acldefault</a>(objtype, owner));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Update an ACL array to add or remove specified privileges.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; old_acl: the input ACL array<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; mod_aip: defines the privileges to be added, removed, or substituted<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; modechg: ACL_MODECHG_ADD, ACL_MODECHG_DEL, or ACL_MODECHG_EQL<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; ownerId: Oid of object owner<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; behavior: RESTRICT or CASCADE behavior for recursive removal<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * ownerid and behavior are only relevant when the update operation specifies<br/></li>
<li></span><span class="Comment"> * deletion of grant options.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The result is a modified copy; the input object is not changed.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: caller is responsible for having detoasted the input ACL, if needed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L975">&#x200c;</a><span class="linkable">aclupdate</span>(<span class="Type">const</span> Acl *old_acl, <span class="Type">const</span> AclItem *mod_aip,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span> modechg, Oid ownerId, DropBehavior behavior)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *new_acl = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *old_aip,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *new_aip = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; old_rights,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_goptions,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_rights,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_goptions;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Caller probably already checked old_acl, but be safe */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(old_acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If granting grant options, check for circularity */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (modechg != ACL_MODECHG_DEL &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_GET_GOPTIONS(*mod_aip) != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1199" title="utils/adt/acl.c:1199">check_circularity</a>(old_acl, mod_aip, ownerId);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; num = ACL_NUM(old_acl);<br/></li>
<li>&nbsp; &nbsp; old_aip = ACL_DAT(old_acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Search the ACL for an existing entry for this grantee and grantor. If<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * one exists, just modify the entry in-place (well, in the same position,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * since we actually return a copy); otherwise, insert the new entry at<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the end.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (dst = <span class="Constant">0</span>; dst &lt; num; ++dst)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L696" title="utils/adt/acl.c:696">aclitem_match</a>(mod_aip, old_aip + dst))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* found a match, so modify existing item */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(num);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_aip = ACL_DAT(new_acl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(new_acl, old_acl, ACL_SIZE(old_acl));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (dst == num)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* need to append a new item */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; new_acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(num + <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; new_aip = ACL_DAT(new_acl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(new_aip, old_aip, num * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> the new entry with no permissions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; new_aip[dst].ai_grantee = mod_aip-&gt;ai_grantee;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; new_aip[dst].ai_grantor = mod_aip-&gt;ai_grantor;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_PRIVS_GOPTIONS(new_aip[dst],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACL_NO_RIGHTS, ACL_NO_RIGHTS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; num++;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* set num to the size of new_acl */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; old_rights = ACLITEM_GET_RIGHTS(new_aip[dst]);<br/></li>
<li>&nbsp; &nbsp; old_goptions = ACLITEM_GET_GOPTIONS(new_aip[dst]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* apply the specified permissions change */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">switch</span> (modechg)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_MODECHG_ADD:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_RIGHTS(new_aip[dst],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; old_rights | ACLITEM_GET_RIGHTS(*mod_aip));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_MODECHG_DEL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_RIGHTS(new_aip[dst],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; old_rights &amp; ~ACLITEM_GET_RIGHTS(*mod_aip));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_MODECHG_EQL:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_RIGHTS(new_aip[dst],<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACLITEM_GET_RIGHTS(*mod_aip));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; new_rights = ACLITEM_GET_RIGHTS(new_aip[dst]);<br/></li>
<li>&nbsp; &nbsp; new_goptions = ACLITEM_GET_GOPTIONS(new_aip[dst]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the adjusted entry has no permissions, delete it from the list.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (new_rights == ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memmove(new_aip + dst,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_aip + dst + <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (num - dst - <span class="Constant">1</span>) * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Adjust array size to be 'num - 1' items */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ARR_DIMS(new_acl)[<span class="Constant">0</span>] = num - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SET_VARSIZE(new_acl, ACL_N_SIZE(num - <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Remove abandoned privileges (cascading revoke).&nbsp; Currently we can only<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * handle this when the grantee is not PUBLIC.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((old_goptions &amp; ~new_goptions) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(mod_aip-&gt;ai_grantee != ACL_ID_PUBLIC);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; new_acl = <a href="#L1279" title="utils/adt/acl.c:1279">recursive_revoke</a>(new_acl, mod_aip-&gt;ai_grantee,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (old_goptions &amp; ~new_goptions),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ownerId, behavior);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> new_acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Update an ACL array to reflect a change of owner to the parent object<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; old_acl: the input ACL array (must not be NULL)<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; oldOwnerId: Oid of the old object owner<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; newOwnerId: Oid of the new object owner<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The result is a modified copy; the input object is not changed.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: caller is responsible for having detoasted the input ACL, if needed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Acl *<br/></li>
<li><a id="L1096">&#x200c;</a><span class="linkable">aclnewowner</span>(<span class="Type">const</span> Acl *old_acl, Oid oldOwnerId, Oid newOwnerId)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *new_acl;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *new_aip;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *old_aip;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *dst_aip;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *src_aip;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *targ_aip;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; newpresent = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; src,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; targ,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(old_acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Make a copy of the given ACL, substituting new owner ID for old<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * wherever it appears as either grantor or grantee.&nbsp; Also note if the new<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * owner ID is already present.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; num = ACL_NUM(old_acl);<br/></li>
<li>&nbsp; &nbsp; old_aip = ACL_DAT(old_acl);<br/></li>
<li>&nbsp; &nbsp; new_acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(num);<br/></li>
<li>&nbsp; &nbsp; new_aip = ACL_DAT(new_acl);<br/></li>
<li>&nbsp; &nbsp; memcpy(new_aip, old_aip, num * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (dst = <span class="Constant">0</span>, dst_aip = new_aip; dst &lt; num; dst++, dst_aip++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst_aip-&gt;ai_grantor == oldOwnerId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst_aip-&gt;ai_grantor = newOwnerId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (dst_aip-&gt;ai_grantor == newOwnerId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newpresent = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst_aip-&gt;ai_grantee == oldOwnerId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst_aip-&gt;ai_grantee = newOwnerId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (dst_aip-&gt;ai_grantee == newOwnerId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newpresent = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the old ACL contained <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> references to the new owner, then we may<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> have generated an ACL containing duplicate entries.&nbsp; Find them and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../lib/pairingheap.c.html#L79" title="lib/pairingheap.c:79">merge</a> them so that there are not duplicates.&nbsp; (This is relatively<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * expensive since we use a stupid O(N^2) algorithm, but it's unlikely to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * be the normal case.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * To simplify deletion of duplicate entries, we temporarily leave them in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the array but set their privilege masks to zero; when we reach such an<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * entry it's just skipped.&nbsp; (Thus, a side effect of this code will be to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * remove privilege-free entries, should there be <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> in the input.)&nbsp; dst<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * is the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> output slot, targ is the currently considered input slot<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (always &gt;= dst), and src scans entries to the right of targ looking for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * duplicates.&nbsp; Once an entry has been emitted to dst it is known<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * duplicate-free and need not be considered anymore.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (newpresent)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dst = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (targ = <span class="Constant">0</span>, targ_aip = new_aip; targ &lt; num; targ++, targ_aip++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ignore if deleted in an earlier pass */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ACLITEM_GET_RIGHTS(*targ_aip) == ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> and <a href="../../lib/pairingheap.c.html#L79" title="lib/pairingheap.c:79">merge</a> <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> duplicates */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (src = targ + <span class="Constant">1</span>, src_aip = targ_aip + <span class="Constant">1</span>; src &lt; num;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src++, src_aip++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ACLITEM_GET_RIGHTS(*src_aip) == ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L696" title="utils/adt/acl.c:696">aclitem_match</a>(targ_aip, src_aip))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_RIGHTS(*targ_aip,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACLITEM_GET_RIGHTS(*targ_aip) |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ACLITEM_GET_RIGHTS(*src_aip));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* mark the duplicate deleted */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_RIGHTS(*src_aip, ACL_NO_RIGHTS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* and emit to output */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_aip[dst] = *targ_aip;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Adjust array size to be 'dst' items */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ARR_DIMS(new_acl)[<span class="Constant">0</span>] = dst;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; SET_VARSIZE(new_acl, ACL_N_SIZE(dst));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> new_acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * When granting grant options, we must disallow attempts to set up circular<br/></li>
<li></span><span class="Comment"> * chains of grant options.&nbsp; Suppose A (the object owner) grants B some<br/></li>
<li></span><span class="Comment"> * privileges with grant option, and B re-grants them to C.&nbsp; If C could<br/></li>
<li></span><span class="Comment"> * grant the privileges to B as well, then A would be unable to effectively<br/></li>
<li></span><span class="Comment"> * revoke the privileges from B, since <a href="#L1279" title="utils/adt/acl.c:1279">recursive_revoke</a> would consider that<br/></li>
<li></span><span class="Comment"> * B still has 'em from C.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We check for this by recursively deleting all grant options belonging to<br/></li>
<li></span><span class="Comment"> * the target grantee, and then seeing if the would-be grantor still has the<br/></li>
<li></span><span class="Comment"> * grant option or not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1199">&#x200c;</a></span><span class="linkable">check_circularity</span>(<span class="Type">const</span> Acl *old_acl, <span class="Type">const</span> AclItem *mod_aip,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid ownerId)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *acl;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; own_privs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(old_acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * For <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>, grant options can only be granted to roles, not PUBLIC.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Otherwise we'd have to work a <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> harder here.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; Assert(mod_aip-&gt;ai_grantee != ACL_ID_PUBLIC);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The owner always has grant options, no need to check */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (mod_aip-&gt;ai_grantor == ownerId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Make a working copy */<br/></li>
<li></span>&nbsp; &nbsp; acl = <a href="#L409" title="utils/adt/acl.c:409">allocacl</a>(ACL_NUM(old_acl));<br/></li>
<li>&nbsp; &nbsp; memcpy(acl, old_acl, ACL_SIZE(old_acl));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Zap all grant options of target grantee, plus what depends on 'em */<br/></li>
<li></span><span class="Statement">cc_restart</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; num = ACL_NUM(acl);<br/></li>
<li>&nbsp; &nbsp; aip = ACL_DAT(acl);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aip[i].ai_grantee == mod_aip-&gt;ai_grantee &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_GET_GOPTIONS(aip[i]) != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *new_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* We'll actually zap ordinary privs too, but no matter */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_acl = <a href="#L975" title="utils/adt/acl.c:975">aclupdate</a>(acl, &amp;aip[i], ACL_MODECHG_DEL,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ownerId, DROP_CASCADE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(acl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acl = new_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> cc_restart;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Now we can compute grantor's independently-derived privileges */<br/></li>
<li></span>&nbsp; &nbsp; own_privs = <a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a>(acl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mod_aip-&gt;ai_grantor,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACL_GRANT_OPTION_FOR(ACLITEM_GET_GOPTIONS(*mod_aip)),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ALL);<br/></li>
<li>&nbsp; &nbsp; own_privs = ACL_OPTION_TO_PRIVS(own_privs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((ACLITEM_GET_GOPTIONS(*mod_aip) &amp; ~own_privs) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_GRANT_OPERATION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;grant options cannot be granted back to your own grantor&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(acl);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Ensure that no privilege is &quot;abandoned&quot;.&nbsp; A privilege is abandoned<br/></li>
<li></span><span class="Comment"> * if the user that granted the privilege loses the grant option.&nbsp; (So<br/></li>
<li></span><span class="Comment"> * the chain through which it was granted is broken.)&nbsp; Either the<br/></li>
<li></span><span class="Comment"> * abandoned privileges are revoked as well, or an error message is<br/></li>
<li></span><span class="Comment"> * printed, depending on the drop behavior option.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; acl: the input ACL list<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; grantee: the user from whom some grant options have been revoked<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; revoke_privs: the grant options being revoked<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; ownerId: Oid of object owner<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; behavior: RESTRICT or CASCADE behavior for recursive removal<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The input Acl object is <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>'d if replaced.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Acl *<br/></li>
<li><a id="L1279">&#x200c;</a><span class="linkable">recursive_revoke</span>(Acl *acl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Oid grantee,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; AclMode revoke_privs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Oid ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; DropBehavior behavior)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; still_has;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The owner can never truly lose grant options, so short-circuit */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (grantee == ownerId)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The grantee might still have some grant options via another grantor */<br/></li>
<li></span>&nbsp; &nbsp; still_has = <a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a>(acl, grantee, ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACL_GRANT_OPTION_FOR(revoke_privs),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ALL);<br/></li>
<li>&nbsp; &nbsp; revoke_privs &amp;= ~ACL_OPTION_TO_PRIVS(still_has);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (revoke_privs == ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> acl;<br/></li>
<li><br/></li>
<li><span class="Statement">restart</span><span class="cUserCont">:<br/></li>
<li></span>&nbsp; &nbsp; num = ACL_NUM(acl);<br/></li>
<li>&nbsp; &nbsp; aip = ACL_DAT(acl);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aip[i].ai_grantor == grantee<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (ACLITEM_GET_PRIVS(aip[i]) &amp; revoke_privs) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AclItem&nbsp; &nbsp; &nbsp; &nbsp; mod_acl;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *new_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (behavior == DROP_RESTRICT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_DEPENDENT_OBJECTS_STILL_EXIST),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;dependent privileges exist&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;Use CASCADE to revoke them too.&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mod_acl.ai_grantor = grantee;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mod_acl.ai_grantee = aip[i].ai_grantee;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLITEM_SET_PRIVS_GOPTIONS(mod_acl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; revoke_privs,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; revoke_privs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_acl = <a href="#L975" title="utils/adt/acl.c:975">aclupdate</a>(acl, &amp;mod_acl, ACL_MODECHG_DEL,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ownerId, behavior);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(acl);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; acl = new_acl;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> restart;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> acl;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a> --- compute bitmask of all privileges held by roleid.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * When 'how' = ACLMASK_ALL, this simply returns the privilege bits<br/></li>
<li></span><span class="Comment"> * held by the given roleid according to the given ACL list, ANDed<br/></li>
<li></span><span class="Comment"> * with 'mask'.&nbsp; (The point of passing 'mask' is to let the routine<br/></li>
<li></span><span class="Comment"> * exit early if all privileges of interest have been found.)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * When 'how' = ACLMASK_ANY, returns as soon as <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> in the mask<br/></li>
<li></span><span class="Comment"> * is known true.&nbsp; (This lets us exit soonest in cases where the<br/></li>
<li></span><span class="Comment"> * caller is only going to test for zero or nonzero result.)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Usage patterns:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * To see if <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> of a set of privileges are held:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; if (<a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a>(acl, roleid, ownerId, privs, ACLMASK_ANY) != 0)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * To see if all of a set of privileges are held:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; if (<a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a>(acl, roleid, ownerId, privs, ACLMASK_ALL) == privs)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * To determine exactly which of a set of privileges are held:<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; heldprivs = <a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a>(acl, roleid, ownerId, privs, ACLMASK_ALL);<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>AclMode<br/></li>
<li><a id="L1365">&#x200c;</a><span class="linkable">aclmask</span>(<span class="Type">const</span> Acl *acl, Oid roleid, Oid ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclMode mask, AclMaskHow how)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; remaining;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidat;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Null ACL should not happen, since caller should have inserted<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * appropriate default<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (acl == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;null ACL&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Quick exit for mask == 0 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (mask == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Owner always implicitly has all grant options */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((mask &amp; ACLITEM_ALL_GOPTION_BITS) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>(roleid, ownerId))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = mask &amp; ACLITEM_ALL_GOPTION_BITS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((how == ACLMASK_ALL) ? (result == mask) : (result != <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; num = ACL_NUM(acl);<br/></li>
<li>&nbsp; &nbsp; aidat = ACL_DAT(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check privileges granted directly to roleid or to public<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidata = &amp;aidat[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aidata-&gt;ai_grantee == ACL_ID_PUBLIC ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aidata-&gt;ai_grantee == roleid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result |= aidata-&gt;ai_privs &amp; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((how == ACLMASK_ALL) ? (result == mask) : (result != <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check privileges granted indirectly via role memberships. We do this in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * a separate pass to minimize expensive indirect membership tests.&nbsp; In<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * particular, it's worth testing whether a given ACL entry grants <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * privileges still of interest <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> we perform the <a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * test.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; remaining = mask &amp; ~result;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidata = &amp;aidat[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aidata-&gt;ai_grantee == ACL_ID_PUBLIC ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aidata-&gt;ai_grantee == roleid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* already checked it */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((aidata-&gt;ai_privs &amp; remaining) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>(roleid, aidata-&gt;ai_grantee))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result |= aidata-&gt;ai_privs &amp; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((how == ACLMASK_ALL) ? (result == mask) : (result != <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remaining = mask &amp; ~result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1454" title="utils/adt/acl.c:1454">aclmask_direct</a> --- compute bitmask of all privileges held by roleid.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is exactly like <a href="#L1365" title="utils/adt/acl.c:1365">aclmask</a>() except that we consider only privileges<br/></li>
<li></span><span class="Comment"> * held *directly* by roleid, not those inherited via role membership.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L1454">&#x200c;</a><span class="linkable">aclmask_direct</span>(<span class="Type">const</span> Acl *acl, Oid roleid, Oid ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; AclMode mask, AclMaskHow how)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidat;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Null ACL should not happen, since caller should have inserted<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * appropriate default<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (acl == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;null ACL&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Quick exit for mask == 0 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (mask == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Owner always implicitly has all grant options */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((mask &amp; ACLITEM_ALL_GOPTION_BITS) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; roleid == ownerId)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; result = mask &amp; ACLITEM_ALL_GOPTION_BITS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((how == ACLMASK_ALL) ? (result == mask) : (result != <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; num = ACL_NUM(acl);<br/></li>
<li>&nbsp; &nbsp; aidat = ACL_DAT(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check privileges granted directly to roleid (and not to public)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidata = &amp;aidat[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aidata-&gt;ai_grantee == roleid)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result |= aidata-&gt;ai_privs &amp; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> ((how == ACLMASK_ALL) ? (result == mask) : (result != <span class="Constant">0</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1517" title="utils/adt/acl.c:1517">aclmembers</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Find out all the roleids mentioned in an Acl.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Note that we do not distinguish grantors from grantees.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * *roleids is set to point to a <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'d array containing distinct OIDs<br/></li>
<li></span><span class="Comment"> * in sorted order.&nbsp; The length of the array is the function result.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">int<br/></li>
<li><a id="L1517">&#x200c;</a></span><span class="linkable">aclmembers</span>(<span class="Type">const</span> Acl *acl, Oid **roleids)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *list;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> AclItem *acldat;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (acl == <span class="Constant">NULL</span> || ACL_NUM(acl) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *roleids = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Allocate the worst-case space requirement */<br/></li>
<li></span>&nbsp; &nbsp; list = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(ACL_NUM(acl) * <span class="Constant">2</span> * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Oid));<br/></li>
<li>&nbsp; &nbsp; acldat = ACL_DAT(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Walk the ACL collecting mentioned RoleIds.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; j = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; ACL_NUM(acl); i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> AclItem *ai = &amp;acldat[i];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ai-&gt;ai_grantee != ACL_ID_PUBLIC)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list[j++] = ai-&gt;ai_grantee;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* grantor is currently never PUBLIC, but let's check anyway */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ai-&gt;ai_grantor != ACL_ID_PUBLIC)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list[j++] = ai-&gt;ai_grantor;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Sort the array */<br/></li>
<li></span>&nbsp; &nbsp; qsort(list, j, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Oid), <a href="oid.c.html#L258" title="utils/adt/oid.c:258">oid_cmp</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We could <a href="../mmgr/mcxt.c.html#L1540" title="utils/mmgr/mcxt.c:1540">repalloc</a> the array down to minimum size, but it's hardly worth<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * it since it's only transient memory.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; *roleids = list;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Remove duplicates from the array */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> qunique(list, j, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Oid), <a href="oid.c.html#L258" title="utils/adt/oid.c:258">oid_cmp</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1569" title="utils/adt/acl.c:1569">aclinsert</a> (exported function)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1569">&#x200c;</a><span class="linkable">aclinsert</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_FEATURE_NOT_SUPPORTED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;<a href="#L1569" title="utils/adt/acl.c:1569">aclinsert</a> is no longer supported&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_NULL();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* keep compiler quiet */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1579">&#x200c;</a><span class="linkable">aclremove</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_FEATURE_NOT_SUPPORTED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;<a href="#L1579" title="utils/adt/acl.c:1579">aclremove</a> is no longer supported&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_NULL();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* keep compiler quiet */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1589">&#x200c;</a><span class="linkable">aclcontains</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *acl = PG_GETARG_ACL_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aip = PG_GETARG_ACLITEM_P(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidat;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(acl);<br/></li>
<li>&nbsp; &nbsp; num = ACL_NUM(acl);<br/></li>
<li>&nbsp; &nbsp; aidat = ACL_DAT(acl);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; num; ++i)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (aip-&gt;ai_grantee == aidat[i].ai_grantee &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; aip-&gt;ai_grantor == aidat[i].ai_grantor &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (ACLITEM_GET_RIGHTS(*aip) &amp; ACLITEM_GET_RIGHTS(aidat[i])) == ACLITEM_GET_RIGHTS(*aip))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_BOOL(<span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(<span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1611">&#x200c;</a><span class="linkable">makeaclitem</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; grantee = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; grantor = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *privtext = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; goption = PG_GETARG_BOOL(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *result;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; priv;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> any_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT&quot;</span>, ACL_SELECT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;INSERT&quot;</span>, ACL_INSERT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE&quot;</span>, ACL_UPDATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;DELETE&quot;</span>, ACL_DELETE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TRUNCATE&quot;</span>, ACL_TRUNCATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;REFERENCES&quot;</span>, ACL_REFERENCES},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TRIGGER&quot;</span>, ACL_TRIGGER},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;EXECUTE&quot;</span>, ACL_EXECUTE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE&quot;</span>, ACL_CREATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TEMP&quot;</span>, ACL_CREATE_TEMP},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TEMPORARY&quot;</span>, ACL_CREATE_TEMP},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CONNECT&quot;</span>, ACL_CONNECT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a>&quot;</span>, ACL_SET},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;ALTER SYSTEM&quot;</span>, ACL_ALTER_SYSTEM},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;MAINTAIN&quot;</span>, ACL_MAINTAIN},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;RULE&quot;</span>, <span class="Constant">0</span>},&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ignore old RULE privileges */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; priv = <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(privtext, any_priv_map);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result = (AclItem *) <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(AclItem));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; result-&gt;ai_grantee = grantee;<br/></li>
<li>&nbsp; &nbsp; result-&gt;ai_grantor = grantor;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ACLITEM_SET_PRIVS_GOPTIONS(*result, priv,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (goption ? priv : ACL_NO_RIGHTS));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_ACLITEM_P(result);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>: recognize privilege strings for has_foo_privilege<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We <a href="../../port/win32/socket.c.html#L34" title="port/win32/socket.c:34">accept</a> a comma-separated list of case-insensitive privilege names,<br/></li>
<li></span><span class="Comment"> * producing a bitmask of the OR'd privilege bits.&nbsp; We are liberal about<br/></li>
<li></span><span class="Comment"> * whitespace between items, not so much about whitespace within items.<br/></li>
<li></span><span class="Comment"> * The allowed privilege names are given as an array of <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> structs,<br/></li>
<li></span><span class="Comment"> * terminated by one with a NULL name pointer.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L1664">&#x200c;</a><span class="linkable">convert_any_priv_string</span>(text *priv_type_text,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> *privileges)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; result = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *priv_type = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *chunk;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *next_chunk;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We rely on priv_type being a private, modifiable string */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (chunk = priv_type; chunk; chunk = next_chunk)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunk_len;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> *this_priv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Split string at commas */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; next_chunk = strchr(chunk, <span class="Constant">','</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (next_chunk)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *next_chunk++ = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Drop leading/trailing whitespace in this chunk */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (*chunk &amp;&amp; isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) *chunk))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunk++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk_len = strlen(chunk);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (chunk_len &gt; <span class="Constant">0</span> &amp;&amp; isspace((<span class="Type">unsigned</span> <span class="Type">char</span>) chunk[chunk_len - <span class="Constant">1</span>]))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; chunk_len--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; chunk[chunk_len] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Match to the privileges list */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (this_priv = privileges; this_priv-&gt;name; this_priv++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_strcasecmp(this_priv-&gt;name, chunk) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result |= this_priv-&gt;value;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!this_priv-&gt;name)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;unrecognized privilege type: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>, chunk)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(priv_type);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L1712">&#x200c;</a><span class="linkable">convert_aclright_to_string</span>(<span class="Type">int</span> aclright)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (aclright)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_INSERT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;INSERT&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_SELECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;SELECT&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_UPDATE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;UPDATE&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_DELETE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;DELETE&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_TRUNCATE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;TRUNCATE&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_REFERENCES:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;REFERENCES&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_TRIGGER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;TRIGGER&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_EXECUTE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;EXECUTE&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_USAGE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;USAGE&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_CREATE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;CREATE&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_CREATE_TEMP:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;TEMPORARY&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_CONNECT:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;CONNECT&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_SET:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a>&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_ALTER_SYSTEM:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;ALTER SYSTEM&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ACL_MAINTAIN:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">&quot;MAINTAIN&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unrecognized aclright: </span><span class="Special">%d</span><span class="Constant">&quot;</span>, aclright);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*----------<br/></li>
<li></span><span class="Comment"> * Convert an aclitem[] to a table.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Example:<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="#L1768" title="utils/adt/acl.c:1768">aclexplode</a>('{=r/joe,foo=a*w/joe}'::aclitem[])<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * returns the table<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * {{ OID(joe), 0::OID,&nbsp;&nbsp; 'SELECT', false },<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; { OID(joe), OID(foo), 'INSERT', true },<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; { OID(joe), OID(foo), 'UPDATE', false }}<br/></li>
<li></span><span class="Comment"> *----------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1768">&#x200c;</a><span class="linkable">aclexplode</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Acl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *acl = PG_GETARG_ACL_P(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; FuncCallContext *funcctx;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *idx;<br/></li>
<li>&nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidat;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (SRF_IS_FIRSTCALL())<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; TupleDesc&nbsp; &nbsp; tupdesc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemoryContext oldcontext;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L573" title="utils/adt/acl.c:573">check_acl</a>(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; funcctx = SRF_FIRSTCALL_INIT();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldcontext = MemoryContextSwitchTo(funcctx-&gt;multi_call_memory_ctx);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * build tupdesc for result tuples (matches out parameters in pg_proc<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * entry)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; tupdesc = <a href="../../access/common/tupdesc.c.html#L67" title="access/common/tupdesc.c:67">CreateTemplateTupleDesc</a>(<span class="Constant">4</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../access/common/tupdesc.c.html#L651" title="access/common/tupdesc.c:651">TupleDescInitEntry</a>(tupdesc, (AttrNumber) <span class="Constant">1</span>, <span class="Constant">&quot;grantor&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OIDOID, -<span class="Constant">1</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../access/common/tupdesc.c.html#L651" title="access/common/tupdesc.c:651">TupleDescInitEntry</a>(tupdesc, (AttrNumber) <span class="Constant">2</span>, <span class="Constant">&quot;grantee&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; OIDOID, -<span class="Constant">1</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../access/common/tupdesc.c.html#L651" title="access/common/tupdesc.c:651">TupleDescInitEntry</a>(tupdesc, (AttrNumber) <span class="Constant">3</span>, <span class="Constant">&quot;privilege_type&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TEXTOID, -<span class="Constant">1</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../access/common/tupdesc.c.html#L651" title="access/common/tupdesc.c:651">TupleDescInitEntry</a>(tupdesc, (AttrNumber) <span class="Constant">4</span>, <span class="Constant">&quot;is_grantable&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; BOOLOID, -<span class="Constant">1</span>, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; funcctx-&gt;tuple_desc = <a href="../../executor/execTuples.c.html#L2158" title="executor/execTuples.c:2158">BlessTupleDesc</a>(tupdesc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* allocate memory for user context */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; idx = (<span class="Type">int</span> *) <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">int</span>[<span class="Constant">2</span>]));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; idx[<span class="Constant">0</span>] = <span class="Constant">0</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ACL array item index */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; idx[<span class="Constant">1</span>] = -<span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* privilege type counter */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; funcctx-&gt;user_fctx = (<span class="Type">void</span> *) idx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; funcctx = SRF_PERCALL_SETUP();<br/></li>
<li>&nbsp; &nbsp; idx = (<span class="Type">int</span> *) funcctx-&gt;user_fctx;<br/></li>
<li>&nbsp; &nbsp; aidat = ACL_DAT(acl);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* need test here in case acl has no items */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (idx[<span class="Constant">0</span>] &lt; ACL_NUM(acl))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclItem&nbsp; &nbsp; *aidata;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; priv_bit;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; idx[<span class="Constant">1</span>]++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (idx[<span class="Constant">1</span>] == N_ACL_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idx[<span class="Constant">1</span>] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idx[<span class="Constant">0</span>]++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (idx[<span class="Constant">0</span>] &gt;= ACL_NUM(acl)) <span class="Comment">/* done */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aidata = &amp;aidat[idx[<span class="Constant">0</span>]];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; priv_bit = UINT64CONST(<span class="Constant">1</span>) &lt;&lt; idx[<span class="Constant">1</span>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ACLITEM_GET_PRIVS(*aidata) &amp; priv_bit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; nulls[<span class="Constant">4</span>] = {<span class="Constant">0</span>};<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tuple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">0</span>] = ObjectIdGetDatum(aidata-&gt;ai_grantor);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">1</span>] = ObjectIdGetDatum(aidata-&gt;ai_grantee);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">2</span>] = CStringGetTextDatum(<a href="#L1712" title="utils/adt/acl.c:1712">convert_aclright_to_string</a>(priv_bit));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>[<span class="Constant">3</span>] = BoolGetDatum((ACLITEM_GET_GOPTIONS(*aidata) &amp; priv_bit) != <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple = <a href="../../access/common/heaptuple.c.html#L1116" title="access/common/heaptuple.c:1116">heap_form_tuple</a>(funcctx-&gt;tuple_desc, <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>, nulls);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = HeapTupleGetDatum(tuple);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SRF_RETURN_NEXT(funcctx, result);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; SRF_RETURN_DONE(funcctx);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_table_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_table_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of relation name, relation OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.&nbsp; The variants that take a relation OID<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; return NULL if the OID doesn't exist (rather than failing, as<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; they did <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> Postgres 8.4).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1872" title="utils/adt/acl.c:1872">has_table_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text tablename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1872">&#x200c;</a><span class="linkable">has_table_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*rolename));<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(tableoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1898" title="utils/adt/acl.c:1898">has_table_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text tablename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1898">&#x200c;</a><span class="linkable">has_table_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(tableoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1922" title="utils/adt/acl.c:1922">has_table_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, table oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1922">&#x200c;</a><span class="linkable">has_table_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1950" title="utils/adt/acl.c:1950">has_table_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; table oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1950">&#x200c;</a><span class="linkable">has_table_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1976" title="utils/adt/acl.c:1976">has_table_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text tablename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1976">&#x200c;</a><span class="linkable">has_table_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(tableoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L1999" title="utils/adt/acl.c:1999">has_table_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, table oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L1999">&#x200c;</a><span class="linkable">has_table_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_table_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a table name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L2026">&#x200c;</a><span class="linkable">convert_table_name</span>(text *tablename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; RangeVar&nbsp;&nbsp; *relrv;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; relrv = <a href="../../catalog/namespace.c.html#L3539" title="catalog/namespace.c:3539">makeRangeVarFromNameList</a>(<a href="varlena.c.html#L3399" title="utils/adt/varlena.c:3399">textToQualifiedNameList</a>(tablename));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We might not even have permissions on this relation; don't lock it. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> RangeVarGetRelid(relrv, NoLock, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2041" title="utils/adt/acl.c:2041">convert_table_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L2041">&#x200c;</a><span class="linkable">convert_table_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> table_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT&quot;</span>, ACL_SELECT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_SELECT)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;INSERT&quot;</span>, ACL_INSERT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;INSERT WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_INSERT)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE&quot;</span>, ACL_UPDATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_UPDATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;DELETE&quot;</span>, ACL_DELETE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;DELETE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_DELETE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TRUNCATE&quot;</span>, ACL_TRUNCATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TRUNCATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_TRUNCATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;REFERENCES&quot;</span>, ACL_REFERENCES},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;REFERENCES WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_REFERENCES)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TRIGGER&quot;</span>, ACL_TRIGGER},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TRIGGER WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_TRIGGER)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;MAINTAIN&quot;</span>, ACL_MAINTAIN},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;MAINTAIN WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_MAINTAIN)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;RULE&quot;</span>, <span class="Constant">0</span>},&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ignore old RULE privileges */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;RULE WITH GRANT OPTION&quot;</span>, <span class="Constant">0</span>},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, table_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_sequence_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_sequence_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of relation name, relation OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.&nbsp; The variants that take a relation OID<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; return NULL if the OID doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2085" title="utils/adt/acl.c:2085">has_sequence_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a sequence given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text sequencename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2085">&#x200c;</a><span class="linkable">has_sequence_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *sequencename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sequenceoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*rolename));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; sequenceoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(sequencename);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../cache/lsyscache.c.html#L2003" title="utils/cache/lsyscache.c:2003">get_rel_relkind</a>(sequenceoid) != RELKIND_SEQUENCE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_WRONG_OBJECT_TYPE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not a sequence&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(sequencename))));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(sequenceoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2116" title="utils/adt/acl.c:2116">has_sequence_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a sequence given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text sequencename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2116">&#x200c;</a><span class="linkable">has_sequence_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *sequencename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sequenceoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; sequenceoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(sequencename);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../cache/lsyscache.c.html#L2003" title="utils/cache/lsyscache.c:2003">get_rel_relkind</a>(sequenceoid) != RELKIND_SEQUENCE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_WRONG_OBJECT_TYPE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not a sequence&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(sequencename))));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(sequenceoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2145" title="utils/adt/acl.c:2145">has_sequence_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a sequence given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, sequence oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2145">&#x200c;</a><span class="linkable">has_sequence_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sequenceoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; relkind;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; relkind = <a href="../cache/lsyscache.c.html#L2003" title="utils/cache/lsyscache.c:2003">get_rel_relkind</a>(sequenceoid);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (relkind == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (relkind != RELKIND_SEQUENCE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_WRONG_OBJECT_TYPE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not a sequence&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/lsyscache.c.html#L1928" title="utils/cache/lsyscache.c:1928">get_rel_name</a>(sequenceoid))));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(sequenceoid, roleid, mode, &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2182" title="utils/adt/acl.c:2182">has_sequence_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a sequence given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; sequence oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2182">&#x200c;</a><span class="linkable">has_sequence_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sequenceoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; relkind;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; relkind = <a href="../cache/lsyscache.c.html#L2003" title="utils/cache/lsyscache.c:2003">get_rel_relkind</a>(sequenceoid);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (relkind == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (relkind != RELKIND_SEQUENCE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_WRONG_OBJECT_TYPE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not a sequence&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/lsyscache.c.html#L1928" title="utils/cache/lsyscache.c:1928">get_rel_name</a>(sequenceoid))));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(sequenceoid, roleid, mode, &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2217" title="utils/adt/acl.c:2217">has_sequence_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a sequence given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text sequencename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2217">&#x200c;</a><span class="linkable">has_sequence_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *sequencename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sequenceoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; sequenceoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(sequencename);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../cache/lsyscache.c.html#L2003" title="utils/cache/lsyscache.c:2003">get_rel_relkind</a>(sequenceoid) != RELKIND_SEQUENCE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_WRONG_OBJECT_TYPE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not a sequence&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(sequencename))));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(sequenceoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2245" title="utils/adt/acl.c:2245">has_sequence_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a sequence given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, sequence oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2245">&#x200c;</a><span class="linkable">has_sequence_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sequenceoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; relkind;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a>(priv_type_text);<br/></li>
<li>&nbsp; &nbsp; relkind = <a href="../cache/lsyscache.c.html#L2003" title="utils/cache/lsyscache.c:2003">get_rel_relkind</a>(sequenceoid);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (relkind == <span class="Special">'\0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (relkind != RELKIND_SEQUENCE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_WRONG_OBJECT_TYPE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is not a sequence&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/lsyscache.c.html#L1928" title="utils/cache/lsyscache.c:1928">get_rel_name</a>(sequenceoid))));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(sequenceoid, roleid, mode, &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2278" title="utils/adt/acl.c:2278">convert_sequence_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L2278">&#x200c;</a><span class="linkable">convert_sequence_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> sequence_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_USAGE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT&quot;</span>, ACL_SELECT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_SELECT)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE&quot;</span>, ACL_UPDATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_UPDATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, sequence_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_any_column_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_any_column_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of relation name, relation OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege for <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of the table, false if not.&nbsp; The variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; that take a relation OID return NULL if the OID doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2311" title="utils/adt/acl.c:2311">has_any_column_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text tablename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2311">&#x200c;</a><span class="linkable">has_any_column_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*rolename));<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* First check at table level, then examine each column if needed */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(tableoid, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3950" title="catalog/aclchk.c:3950">pg_attribute_aclcheck_all</a>(tableoid, roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ANY);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2341" title="utils/adt/acl.c:2341">has_any_column_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text tablename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2341">&#x200c;</a><span class="linkable">has_any_column_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* First check at table level, then examine each column if needed */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(tableoid, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3950" title="catalog/aclchk.c:3950">pg_attribute_aclcheck_all</a>(tableoid, roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ANY);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2369" title="utils/adt/acl.c:2369">has_any_column_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, table oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2369">&#x200c;</a><span class="linkable">has_any_column_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* First check at table level, then examine each column if needed */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3961" title="catalog/aclchk.c:3961">pg_attribute_aclcheck_all_ext</a>(tableoid, roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ANY, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2404" title="utils/adt/acl.c:2404">has_any_column_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; table oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2404">&#x200c;</a><span class="linkable">has_any_column_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* First check at table level, then examine each column if needed */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3961" title="catalog/aclchk.c:3961">pg_attribute_aclcheck_all_ext</a>(tableoid, roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ANY, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2437" title="utils/adt/acl.c:2437">has_any_column_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text tablename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2437">&#x200c;</a><span class="linkable">has_any_column_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* First check at table level, then examine each column if needed */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4079" title="catalog/aclchk.c:4079">pg_class_aclcheck</a>(tableoid, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3950" title="catalog/aclchk.c:3950">pg_attribute_aclcheck_all</a>(tableoid, roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ANY);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2464" title="utils/adt/acl.c:2464">has_any_column_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> column of a table given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, table oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2464">&#x200c;</a><span class="linkable">has_any_column_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* First check at table level, then examine each column if needed */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult != ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3961" title="catalog/aclchk.c:3961">pg_attribute_aclcheck_all_ext</a>(tableoid, roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACLMASK_ANY, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_column_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_column_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of relation name, relation OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; column name, column attnum, user name, user OID, or<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.&nbsp; The variants that take a relation OID<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; return NULL (rather than throwing an error) if that relation OID<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; doesn't exist.&nbsp; Likewise, the variants that take an integer attnum<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; return NULL (rather than throwing an error) if there is no such<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; pg_attribute entry.&nbsp; All variants return NULL if an attisdropped<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; column is selected.&nbsp; These rules are meant to avoid unnecessary<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; failures in queries that scan pg_attribute.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>: check column privileges, but don't throw an error<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; for dropped column or table<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Returns 1 if have the privilege, 0 if not, -1 if dropped column/table.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L2515">&#x200c;</a></span><span class="linkable">column_privilege_check</span>(Oid tableoid, AttrNumber attnum,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Oid roleid, AclMode mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a> failed, we can just return -1 immediately.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (attnum == InvalidAttrNumber)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check for column-level privileges first. This serves in part as a check<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * on whether the column even exists, so we need to do it <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> checking<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * table-level privilege.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3920" title="catalog/aclchk.c:3920">pg_attribute_aclcheck_ext</a>(tableoid, attnum, roleid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mode, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult == ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Next check if we have the privilege at the table level */<br/></li>
<li></span>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L4089" title="catalog/aclchk.c:4089">pg_class_aclcheck_ext</a>(tableoid, roleid, mode, &amp;is_missing);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (aclresult == ACLCHECK_OK)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2555" title="utils/adt/acl.c:2555">has_column_privilege_name_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text tablename, text colname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2555">&#x200c;</a><span class="linkable">has_column_privilege_name_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *column = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*rolename));<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; colattnum = <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(tableoid, column);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2584" title="utils/adt/acl.c:2584">has_column_privilege_name_name_attnum</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text tablename, int attnum, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2584">&#x200c;</a><span class="linkable">has_column_privilege_name_name_attnum</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum = PG_GETARG_INT16(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*rolename));<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2611" title="utils/adt/acl.c:2611">has_column_privilege_name_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, table oid, text colname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2611">&#x200c;</a><span class="linkable">has_column_privilege_name_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *column = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; colattnum = <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(tableoid, column);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2638" title="utils/adt/acl.c:2638">has_column_privilege_name_id_attnum</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, table oid, int attnum, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2638">&#x200c;</a><span class="linkable">has_column_privilege_name_id_attnum</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum = PG_GETARG_INT16(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2663" title="utils/adt/acl.c:2663">has_column_privilege_id_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; oid roleid, text tablename, text colname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2663">&#x200c;</a><span class="linkable">has_column_privilege_id_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *column = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; colattnum = <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(tableoid, column);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2690" title="utils/adt/acl.c:2690">has_column_privilege_id_name_attnum</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; oid roleid, text tablename, int attnum, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2690">&#x200c;</a><span class="linkable">has_column_privilege_id_name_attnum</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum = PG_GETARG_INT16(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2715" title="utils/adt/acl.c:2715">has_column_privilege_id_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; oid roleid, table oid, text colname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2715">&#x200c;</a><span class="linkable">has_column_privilege_id_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *column = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; colattnum = <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(tableoid, column);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2740" title="utils/adt/acl.c:2740">has_column_privilege_id_id_attnum</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; oid roleid, table oid, int attnum, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2740">&#x200c;</a><span class="linkable">has_column_privilege_id_id_attnum</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum = PG_GETARG_INT16(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2764" title="utils/adt/acl.c:2764">has_column_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text tablename, text colname, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2764">&#x200c;</a><span class="linkable">has_column_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *column = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; colattnum = <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(tableoid, column);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2793" title="utils/adt/acl.c:2793">has_column_privilege_name_attnum</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text tablename, int attnum, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2793">&#x200c;</a><span class="linkable">has_column_privilege_name_attnum</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum = PG_GETARG_INT16(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; tableoid = <a href="#L2026" title="utils/adt/acl.c:2026">convert_table_name</a>(tablename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2820" title="utils/adt/acl.c:2820">has_column_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; table oid, text colname, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2820">&#x200c;</a><span class="linkable">has_column_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *column = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; colattnum = <a href="#L2875" title="utils/adt/acl.c:2875">convert_column_name</a>(tableoid, column);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2847" title="utils/adt/acl.c:2847">has_column_privilege_id_attnum</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a column given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; table oid, int attnum, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2847">&#x200c;</a><span class="linkable">has_column_privilege_id_attnum</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tableoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; colattnum = PG_GETARG_INT16(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; privresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; privresult = <a href="#L2515" title="utils/adt/acl.c:2515">column_privilege_check</a>(tableoid, colattnum, roleid, mode);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (privresult &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(privresult);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_column_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a table OID and a column name expressed as a string, look it up<br/></li>
<li></span><span class="Comment"> * and return the column number.&nbsp; Returns InvalidAttrNumber in cases<br/></li>
<li></span><span class="Comment"> * where caller should return NULL instead of failing.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AttrNumber<br/></li>
<li><a id="L2875">&#x200c;</a><span class="linkable">convert_column_name</span>(Oid tableoid, text *column)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *colname;<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; attTuple;<br/></li>
<li>&nbsp; &nbsp; AttrNumber&nbsp; &nbsp; attnum;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; colname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(column);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We don't use <a href="../cache/lsyscache.c.html#L858" title="utils/cache/lsyscache.c:858">get_attnum</a>() here because it will report that dropped<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * columns don't exist.&nbsp; We need to treat dropped columns differently from<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * nonexistent columns.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; attTuple = <a href="../cache/syscache.c.html#L229" title="utils/cache/syscache.c:229">SearchSysCache2</a>(ATTNAME,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ObjectIdGetDatum(tableoid),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; CStringGetDatum(colname));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (HeapTupleIsValid(attTuple))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_attribute attributeForm;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; attributeForm = (Form_pg_attribute) GETSTRUCT(attTuple);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* We want to return NULL for dropped columns */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (attributeForm-&gt;attisdropped)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attnum = InvalidAttrNumber;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attnum = attributeForm-&gt;attnum;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(attTuple);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *tablename = <a href="../cache/lsyscache.c.html#L1928" title="utils/cache/lsyscache.c:1928">get_rel_name</a>(tableoid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If the table OID is bogus, or it's just been dropped, we'll get<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * NULL back.&nbsp; In such cases we want has_column_privilege to return<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * NULL too, so just return InvalidAttrNumber.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (tablename != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* tableoid exists, colname does not, so throw error */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_COLUMN),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;column </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> of relation </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; colname, tablename)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* tableoid doesn't exist, so act like attisdropped case */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; attnum = InvalidAttrNumber;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(colname);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> attnum;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2933" title="utils/adt/acl.c:2933">convert_column_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L2933">&#x200c;</a><span class="linkable">convert_column_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> column_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT&quot;</span>, ACL_SELECT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;SELECT WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_SELECT)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;INSERT&quot;</span>, ACL_INSERT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;INSERT WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_INSERT)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE&quot;</span>, ACL_UPDATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;UPDATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_UPDATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;REFERENCES&quot;</span>, ACL_REFERENCES},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;REFERENCES WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_REFERENCES)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, column_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_database_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_database_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of database name, database OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not, or NULL if object doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2967" title="utils/adt/acl.c:2967">has_database_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a database given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text databasename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2967">&#x200c;</a><span class="linkable">has_database_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *databasename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databaseoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; databaseoid = <a href="#L3127" title="utils/adt/acl.c:3127">convert_database_name</a>(databasename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(DatabaseRelationId, databaseoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L2993" title="utils/adt/acl.c:2993">has_database_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a database given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text databasename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L2993">&#x200c;</a><span class="linkable">has_database_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *databasename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databaseoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; databaseoid = <a href="#L3127" title="utils/adt/acl.c:3127">convert_database_name</a>(databasename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(DatabaseRelationId, databaseoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3017" title="utils/adt/acl.c:3017">has_database_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a database given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, database oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3017">&#x200c;</a><span class="linkable">has_database_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databaseoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(DatabaseRelationId, databaseoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3047" title="utils/adt/acl.c:3047">has_database_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a database given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; database oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3047">&#x200c;</a><span class="linkable">has_database_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databaseoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(DatabaseRelationId, databaseoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3075" title="utils/adt/acl.c:3075">has_database_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a database given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text databasename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3075">&#x200c;</a><span class="linkable">has_database_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *databasename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databaseoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; databaseoid = <a href="#L3127" title="utils/adt/acl.c:3127">convert_database_name</a>(databasename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(DatabaseRelationId, databaseoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3098" title="utils/adt/acl.c:3098">has_database_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a database given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, database oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3098">&#x200c;</a><span class="linkable">has_database_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; databaseoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(DatabaseRelationId, databaseoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_database_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a database name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L3127">&#x200c;</a><span class="linkable">convert_database_name</span>(text *databasename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *dbname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(databasename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../commands/dbcommands.c.html#L3106" title="commands/dbcommands.c:3106">get_database_oid</a>(dbname, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3139" title="utils/adt/acl.c:3139">convert_database_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L3139">&#x200c;</a><span class="linkable">convert_database_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> database_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE&quot;</span>, ACL_CREATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TEMPORARY&quot;</span>, ACL_CREATE_TEMP},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TEMPORARY WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE_TEMP)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TEMP&quot;</span>, ACL_CREATE_TEMP},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;TEMP WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE_TEMP)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CONNECT&quot;</span>, ACL_CONNECT},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CONNECT WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CONNECT)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, database_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_foreign_data_wrapper_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_foreign_data_wrapper_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of foreign-data wrapper name,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; fdw OID, user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3173" title="utils/adt/acl.c:3173">has_foreign_data_wrapper_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign-data wrapper given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text fdwname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3173">&#x200c;</a><span class="linkable">has_foreign_data_wrapper_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *fdwname = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdwid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; fdwid = <a href="#L3333" title="utils/adt/acl.c:3333">convert_foreign_data_wrapper_name</a>(fdwname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ForeignDataWrapperRelationId, fdwid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3199" title="utils/adt/acl.c:3199">has_foreign_data_wrapper_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign-data wrapper given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text fdwname and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3199">&#x200c;</a><span class="linkable">has_foreign_data_wrapper_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *fdwname = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdwid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; fdwid = <a href="#L3333" title="utils/adt/acl.c:3333">convert_foreign_data_wrapper_name</a>(fdwname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ForeignDataWrapperRelationId, fdwid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3223" title="utils/adt/acl.c:3223">has_foreign_data_wrapper_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign-data wrapper given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, foreign-data wrapper oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3223">&#x200c;</a><span class="linkable">has_foreign_data_wrapper_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdwid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ForeignDataWrapperRelationId, fdwid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3253" title="utils/adt/acl.c:3253">has_foreign_data_wrapper_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign-data wrapper given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; foreign-data wrapper oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3253">&#x200c;</a><span class="linkable">has_foreign_data_wrapper_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdwid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ForeignDataWrapperRelationId, fdwid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3281" title="utils/adt/acl.c:3281">has_foreign_data_wrapper_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign-data wrapper given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text fdwname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3281">&#x200c;</a><span class="linkable">has_foreign_data_wrapper_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *fdwname = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdwid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; fdwid = <a href="#L3333" title="utils/adt/acl.c:3333">convert_foreign_data_wrapper_name</a>(fdwname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ForeignDataWrapperRelationId, fdwid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3304" title="utils/adt/acl.c:3304">has_foreign_data_wrapper_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign-data wrapper given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, fdw oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3304">&#x200c;</a><span class="linkable">has_foreign_data_wrapper_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fdwid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ForeignDataWrapperRelationId, fdwid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_foreign_data_wrapper_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a FDW name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L3333">&#x200c;</a><span class="linkable">convert_foreign_data_wrapper_name</span>(text *fdwname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *fdwstr = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(fdwname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../foreign/foreign.c.html#L671" title="foreign/foreign.c:671">get_foreign_data_wrapper_oid</a>(fdwstr, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3345" title="utils/adt/acl.c:3345">convert_foreign_data_wrapper_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L3345">&#x200c;</a><span class="linkable">convert_foreign_data_wrapper_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> foreign_data_wrapper_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_USAGE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, foreign_data_wrapper_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_function_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_function_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of function name, function OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not, or NULL if object doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3373" title="utils/adt/acl.c:3373">has_function_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a function given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text functionname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3373">&#x200c;</a><span class="linkable">has_function_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *functionname = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; functionoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; functionoid = <a href="#L3533" title="utils/adt/acl.c:3533">convert_function_name</a>(functionname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ProcedureRelationId, functionoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3399" title="utils/adt/acl.c:3399">has_function_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a function given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text functionname and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3399">&#x200c;</a><span class="linkable">has_function_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *functionname = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; functionoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; functionoid = <a href="#L3533" title="utils/adt/acl.c:3533">convert_function_name</a>(functionname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ProcedureRelationId, functionoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3423" title="utils/adt/acl.c:3423">has_function_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a function given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, function oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3423">&#x200c;</a><span class="linkable">has_function_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; functionoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ProcedureRelationId, functionoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3453" title="utils/adt/acl.c:3453">has_function_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a function given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; function oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3453">&#x200c;</a><span class="linkable">has_function_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; functionoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ProcedureRelationId, functionoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3481" title="utils/adt/acl.c:3481">has_function_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a function given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text functionname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3481">&#x200c;</a><span class="linkable">has_function_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *functionname = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; functionoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; functionoid = <a href="#L3533" title="utils/adt/acl.c:3533">convert_function_name</a>(functionname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ProcedureRelationId, functionoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3504" title="utils/adt/acl.c:3504">has_function_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a function given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, function oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3504">&#x200c;</a><span class="linkable">has_function_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; functionoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ProcedureRelationId, functionoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_function_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a function name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L3533">&#x200c;</a><span class="linkable">convert_function_name</span>(text *functionname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *funcname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(functionname);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; oid = DatumGetObjectId(DirectFunctionCall1(<a href="regproc.c.html#L224" title="utils/adt/regproc.c:224">regprocedurein</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; CStringGetDatum(funcname)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(oid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_FUNCTION),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;function </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, funcname)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> oid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3554" title="utils/adt/acl.c:3554">convert_function_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L3554">&#x200c;</a><span class="linkable">convert_function_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> function_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;EXECUTE&quot;</span>, ACL_EXECUTE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;EXECUTE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_EXECUTE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, function_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_language_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_language_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of language name, language OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not, or NULL if object doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3582" title="utils/adt/acl.c:3582">has_language_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a language given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text languagename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3582">&#x200c;</a><span class="linkable">has_language_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *languagename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; languageoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; languageoid = <a href="#L3742" title="utils/adt/acl.c:3742">convert_language_name</a>(languagename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(LanguageRelationId, languageoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3608" title="utils/adt/acl.c:3608">has_language_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a language given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text languagename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3608">&#x200c;</a><span class="linkable">has_language_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *languagename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; languageoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; languageoid = <a href="#L3742" title="utils/adt/acl.c:3742">convert_language_name</a>(languagename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(LanguageRelationId, languageoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3632" title="utils/adt/acl.c:3632">has_language_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a language given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, language oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3632">&#x200c;</a><span class="linkable">has_language_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; languageoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(LanguageRelationId, languageoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3662" title="utils/adt/acl.c:3662">has_language_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a language given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; language oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3662">&#x200c;</a><span class="linkable">has_language_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; languageoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(LanguageRelationId, languageoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3690" title="utils/adt/acl.c:3690">has_language_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a language given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text languagename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3690">&#x200c;</a><span class="linkable">has_language_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *languagename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; languageoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; languageoid = <a href="#L3742" title="utils/adt/acl.c:3742">convert_language_name</a>(languagename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(LanguageRelationId, languageoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3713" title="utils/adt/acl.c:3713">has_language_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a language given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, language oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3713">&#x200c;</a><span class="linkable">has_language_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; languageoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(LanguageRelationId, languageoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_language_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a language name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L3742">&#x200c;</a><span class="linkable">convert_language_name</span>(text *languagename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *langname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(languagename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../commands/proclang.c.html#L226" title="commands/proclang.c:226">get_language_oid</a>(langname, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3754" title="utils/adt/acl.c:3754">convert_language_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L3754">&#x200c;</a><span class="linkable">convert_language_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> language_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_USAGE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, language_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_schema_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_schema_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of schema name, schema OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not, or NULL if object doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3782" title="utils/adt/acl.c:3782">has_schema_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a schema given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text schemaname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3782">&#x200c;</a><span class="linkable">has_schema_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *schemaname = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schemaoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; schemaoid = <a href="#L3942" title="utils/adt/acl.c:3942">convert_schema_name</a>(schemaname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(NamespaceRelationId, schemaoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3808" title="utils/adt/acl.c:3808">has_schema_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a schema given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text schemaname and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3808">&#x200c;</a><span class="linkable">has_schema_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *schemaname = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schemaoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; schemaoid = <a href="#L3942" title="utils/adt/acl.c:3942">convert_schema_name</a>(schemaname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(NamespaceRelationId, schemaoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3832" title="utils/adt/acl.c:3832">has_schema_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a schema given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, schema oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3832">&#x200c;</a><span class="linkable">has_schema_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schemaoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(NamespaceRelationId, schemaoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3862" title="utils/adt/acl.c:3862">has_schema_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a schema given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; schema oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3862">&#x200c;</a><span class="linkable">has_schema_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schemaoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(NamespaceRelationId, schemaoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3890" title="utils/adt/acl.c:3890">has_schema_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a schema given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text schemaname, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3890">&#x200c;</a><span class="linkable">has_schema_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *schemaname = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schemaoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; schemaoid = <a href="#L3942" title="utils/adt/acl.c:3942">convert_schema_name</a>(schemaname);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(NamespaceRelationId, schemaoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3913" title="utils/adt/acl.c:3913">has_schema_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a schema given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, schema oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3913">&#x200c;</a><span class="linkable">has_schema_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; schemaoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(NamespaceRelationId, schemaoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_schema_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a schema name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L3942">&#x200c;</a><span class="linkable">convert_schema_name</span>(text *schemaname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *nspname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(schemaname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../catalog/namespace.c.html#L3520" title="catalog/namespace.c:3520">get_namespace_oid</a>(nspname, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3954" title="utils/adt/acl.c:3954">convert_schema_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L3954">&#x200c;</a><span class="linkable">convert_schema_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> schema_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE&quot;</span>, ACL_CREATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_USAGE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, schema_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_server_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_server_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of foreign server name,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; server OID, user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L3984" title="utils/adt/acl.c:3984">has_server_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign server given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text servername, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L3984">&#x200c;</a><span class="linkable">has_server_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *servername = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serverid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; serverid = <a href="#L4144" title="utils/adt/acl.c:4144">convert_server_name</a>(servername);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ForeignServerRelationId, serverid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4010" title="utils/adt/acl.c:4010">has_server_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign server given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text servername and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4010">&#x200c;</a><span class="linkable">has_server_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *servername = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serverid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; serverid = <a href="#L4144" title="utils/adt/acl.c:4144">convert_server_name</a>(servername);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ForeignServerRelationId, serverid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4034" title="utils/adt/acl.c:4034">has_server_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign server given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, foreign server oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4034">&#x200c;</a><span class="linkable">has_server_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serverid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ForeignServerRelationId, serverid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4064" title="utils/adt/acl.c:4064">has_server_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign server given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; server oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4064">&#x200c;</a><span class="linkable">has_server_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serverid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ForeignServerRelationId, serverid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4092" title="utils/adt/acl.c:4092">has_server_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign server given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text servername, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4092">&#x200c;</a><span class="linkable">has_server_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *servername = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serverid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; serverid = <a href="#L4144" title="utils/adt/acl.c:4144">convert_server_name</a>(servername);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(ForeignServerRelationId, serverid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4115" title="utils/adt/acl.c:4115">has_server_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a foreign server given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, server oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4115">&#x200c;</a><span class="linkable">has_server_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; serverid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(ForeignServerRelationId, serverid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_server_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a server name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L4144">&#x200c;</a><span class="linkable">convert_server_name</span>(text *servername)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *serverstr = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(servername);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../foreign/foreign.c.html#L694" title="foreign/foreign.c:694">get_foreign_server_oid</a>(serverstr, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4156" title="utils/adt/acl.c:4156">convert_server_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L4156">&#x200c;</a><span class="linkable">convert_server_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> server_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_USAGE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, server_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_tablespace_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_tablespace_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of tablespace name, tablespace OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4184" title="utils/adt/acl.c:4184">has_tablespace_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a tablespace given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text tablespacename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4184">&#x200c;</a><span class="linkable">has_tablespace_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablespacename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tablespaceoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; tablespaceoid = <a href="#L4344" title="utils/adt/acl.c:4344">convert_tablespace_name</a>(tablespacename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TableSpaceRelationId, tablespaceoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4210" title="utils/adt/acl.c:4210">has_tablespace_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a tablespace given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text tablespacename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4210">&#x200c;</a><span class="linkable">has_tablespace_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablespacename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tablespaceoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; tablespaceoid = <a href="#L4344" title="utils/adt/acl.c:4344">convert_tablespace_name</a>(tablespacename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TableSpaceRelationId, tablespaceoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4234" title="utils/adt/acl.c:4234">has_tablespace_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a tablespace given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, tablespace oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4234">&#x200c;</a><span class="linkable">has_tablespace_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tablespaceoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(TableSpaceRelationId, tablespaceoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4264" title="utils/adt/acl.c:4264">has_tablespace_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a tablespace given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; tablespace oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4264">&#x200c;</a><span class="linkable">has_tablespace_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tablespaceoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(TableSpaceRelationId, tablespaceoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4292" title="utils/adt/acl.c:4292">has_tablespace_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a tablespace given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text tablespacename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4292">&#x200c;</a><span class="linkable">has_tablespace_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *tablespacename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tablespaceoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tablespaceoid = <a href="#L4344" title="utils/adt/acl.c:4344">convert_tablespace_name</a>(tablespacename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TableSpaceRelationId, tablespaceoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4315" title="utils/adt/acl.c:4315">has_tablespace_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a tablespace given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, tablespace oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4315">&#x200c;</a><span class="linkable">has_tablespace_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tablespaceoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(TableSpaceRelationId, tablespaceoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_tablespace_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a tablespace name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L4344">&#x200c;</a><span class="linkable">convert_tablespace_name</span>(text *tablespacename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *spcname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(tablespacename);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../commands/tablespace.c.html#L1426" title="commands/tablespace.c:1426">get_tablespace_oid</a>(spcname, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4356" title="utils/adt/acl.c:4356">convert_tablespace_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L4356">&#x200c;</a><span class="linkable">convert_tablespace_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> tablespace_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE&quot;</span>, ACL_CREATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;CREATE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, tablespace_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_type_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_type_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of type name, type OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not, or NULL if object doesn't exist.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4383" title="utils/adt/acl.c:4383">has_type_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a type given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, text typename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4383">&#x200c;</a><span class="linkable">has_type_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *typename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typeoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; typeoid = <a href="#L4543" title="utils/adt/acl.c:4543">convert_type_name</a>(typename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TypeRelationId, typeoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4409" title="utils/adt/acl.c:4409">has_type_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a type given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text typename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4409">&#x200c;</a><span class="linkable">has_type_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *typename = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typeoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; typeoid = <a href="#L4543" title="utils/adt/acl.c:4543">convert_type_name</a>(typename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TypeRelationId, typeoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4433" title="utils/adt/acl.c:4433">has_type_privilege_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a type given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, type oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4433">&#x200c;</a><span class="linkable">has_type_privilege_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typeoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(TypeRelationId, typeoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4463" title="utils/adt/acl.c:4463">has_type_privilege_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a type given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; type oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4463">&#x200c;</a><span class="linkable">has_type_privilege_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typeoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(TypeRelationId, typeoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4491" title="utils/adt/acl.c:4491">has_type_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a type given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, text typename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4491">&#x200c;</a><span class="linkable">has_type_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *typename = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typeoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; typeoid = <a href="#L4543" title="utils/adt/acl.c:4543">convert_type_name</a>(typename);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3876" title="catalog/aclchk.c:3876">object_aclcheck</a>(TypeRelationId, typeoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4514" title="utils/adt/acl.c:4514">has_type_privilege_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a type given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, type oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4514">&#x200c;</a><span class="linkable">has_type_privilege_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typeoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; is_missing = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="../../catalog/aclchk.c.html#L3886" title="catalog/aclchk.c:3886">object_aclcheck_ext</a>(TypeRelationId, typeoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid, mode,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;is_missing);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (is_missing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_type_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a type name expressed as a string, look it up and return Oid<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Oid<br/></li>
<li><a id="L4543">&#x200c;</a><span class="linkable">convert_type_name</span>(text *typename)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *typname = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(typename);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; oid = DatumGetObjectId(DirectFunctionCall1(<a href="regproc.c.html#L1176" title="utils/adt/regproc.c:1176">regtypein</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; CStringGetDatum(typname)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(oid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;type </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, typname)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> oid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4564" title="utils/adt/acl.c:4564">convert_type_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L4564">&#x200c;</a><span class="linkable">convert_type_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> type_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_USAGE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, type_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * has_parameter_privilege variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;has_parameter_privilege&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of parameter name with<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has been granted<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; the indicated privilege or false if not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4592" title="utils/adt/acl.c:4592">has_param_priv_byname</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Helper function to check user privileges on a parameter given the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; role by Oid, parameter by text name, and privileges as AclMode.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L4592">&#x200c;</a></span><span class="linkable">has_param_priv_byname</span>(Oid roleid, <span class="Type">const</span> text *parameter, AclMode priv)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *paramstr = <a href="varlena.c.html#L217" title="utils/adt/varlena.c:217">text_to_cstring</a>(parameter);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../catalog/aclchk.c.html#L4104" title="catalog/aclchk.c:4104">pg_parameter_aclcheck</a>(paramstr, roleid, priv) == ACLCHECK_OK;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4605" title="utils/adt/acl.c:4605">has_parameter_privilege_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a parameter given name username, text<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; parameter, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4605">&#x200c;</a><span class="linkable">has_parameter_privilege_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *parameter = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; priv = <a href="#L4653" title="utils/adt/acl.c:4653">convert_parameter_priv_string</a>(PG_GETARG_TEXT_PP(<span class="Constant">2</span>));<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a>(NameStr(*username));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(<a href="#L4592" title="utils/adt/acl.c:4592">has_param_priv_byname</a>(roleid, parameter, priv));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4621" title="utils/adt/acl.c:4621">has_parameter_privilege_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a parameter given text parameter and text priv<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name.&nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4621">&#x200c;</a><span class="linkable">has_parameter_privilege_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *parameter = PG_GETARG_TEXT_PP(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; priv = <a href="#L4653" title="utils/adt/acl.c:4653">convert_parameter_priv_string</a>(PG_GETARG_TEXT_PP(<span class="Constant">1</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(<a href="#L4592" title="utils/adt/acl.c:4592">has_param_priv_byname</a>(<a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>(), parameter, priv));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4635" title="utils/adt/acl.c:4635">has_parameter_privilege_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a parameter given roleid, text parameter, and<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4635">&#x200c;</a><span class="linkable">has_parameter_privilege_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *parameter = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; priv = <a href="#L4653" title="utils/adt/acl.c:4653">convert_parameter_priv_string</a>(PG_GETARG_TEXT_PP(<span class="Constant">2</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(<a href="#L4592" title="utils/adt/acl.c:4592">has_param_priv_byname</a>(roleid, parameter, priv));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for has_parameter_privilege family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4653" title="utils/adt/acl.c:4653">convert_parameter_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L4653">&#x200c;</a><span class="linkable">convert_parameter_priv_string</span>(text *priv_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> parameter_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a>&quot;</span>, ACL_SET},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_SET)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;ALTER SYSTEM&quot;</span>, ACL_ALTER_SYSTEM},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;ALTER SYSTEM WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_ALTER_SYSTEM)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_text, parameter_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * pg_has_role variants<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; These are all named &quot;pg_has_role&quot; at the SQL level.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; They take various combinations of role name, role OID,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; user name, user OID, or implicit user = <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; The result is a boolean value: true if user has the indicated<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; privilege, false if not.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4682" title="utils/adt/acl.c:4682">pg_has_role_name_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a role given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name username, name rolename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4682">&#x200c;</a><span class="linkable">pg_has_role_name_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(NameStr(*username), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; roleoid = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(NameStr(*rolename), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(roleoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4708" title="utils/adt/acl.c:4708">pg_has_role_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a role given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name rolename and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4708">&#x200c;</a><span class="linkable">pg_has_role_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; roleoid = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(NameStr(*rolename), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(roleoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4732" title="utils/adt/acl.c:4732">pg_has_role_name_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a role given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; name usename, role oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4732">&#x200c;</a><span class="linkable">pg_has_role_name_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; username = PG_GETARG_NAME(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(NameStr(*username), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(roleoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4756" title="utils/adt/acl.c:4756">pg_has_role_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a role given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; role oid, and text priv name.<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="name.c.html#L263" title="utils/adt/name.c:263">current_user</a> is assumed<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4756">&#x200c;</a><span class="linkable">pg_has_role_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleoid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(roleoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4778" title="utils/adt/acl.c:4778">pg_has_role_id_name</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a role given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, name rolename, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4778">&#x200c;</a><span class="linkable">pg_has_role_id_name</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Name&nbsp; &nbsp; &nbsp; &nbsp; rolename = PG_GETARG_NAME(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleoid;<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; roleoid = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(NameStr(*rolename), <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(roleoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4801" title="utils/adt/acl.c:4801">pg_has_role_id_id</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Check user privileges on a role given<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; roleid, role oid, and text priv name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Datum<br/></li>
<li><a id="L4801">&#x200c;</a><span class="linkable">pg_has_role_id_id</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleid = PG_GETARG_OID(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roleoid = PG_GETARG_OID(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; text&nbsp; &nbsp; &nbsp;&nbsp; *priv_type_text = PG_GETARG_TEXT_PP(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; mode;<br/></li>
<li>&nbsp; &nbsp; AclResult&nbsp; &nbsp; aclresult;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; mode = <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a>(priv_type_text);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; aclresult = <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>(roleoid, roleid, mode);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_RETURN_BOOL(aclresult == ACLCHECK_OK);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Support routines for pg_has_role family.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4831" title="utils/adt/acl.c:4831">convert_role_priv_string</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Convert text string to AclMode value.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We use USAGE to denote whether the privileges of the role are accessible<br/></li>
<li></span><span class="Comment"> * (<a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>), MEMBER to denote <a href="../../libpq/hba.c.html#L919" title="libpq/hba.c:919">is_member</a>, and MEMBER WITH GRANT<br/></li>
<li></span><span class="Comment"> * (or ADMIN) OPTION to denote is_admin.&nbsp; There is no ACL <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> corresponding<br/></li>
<li></span><span class="Comment"> * to MEMBER so we cheat and use ACL_CREATE for that.&nbsp; This convention<br/></li>
<li></span><span class="Comment"> * is shared only with <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a>, below.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclMode<br/></li>
<li><a id="L4831">&#x200c;</a><span class="linkable">convert_role_priv_string</span>(text *priv_type_text)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">const</span> <a href="#L56" title="utils/adt/acl.c:56">priv_map</a> role_priv_map[] = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE&quot;</span>, ACL_USAGE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;MEMBER&quot;</span>, ACL_CREATE},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a>&quot;</span>, ACL_SET},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;USAGE WITH ADMIN OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;MEMBER WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;MEMBER WITH ADMIN OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> WITH GRANT OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">&quot;<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> WITH ADMIN OPTION&quot;</span>, ACL_GRANT_OPTION_FOR(ACL_CREATE)},<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<span class="Constant">NULL</span>, <span class="Constant">0</span>}<br/></li>
<li>&nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L1664" title="utils/adt/acl.c:1664">convert_any_priv_string</a>(priv_type_text, role_priv_map);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4854" title="utils/adt/acl.c:4854">pg_role_aclcheck</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Quick-and-dirty support for pg_has_role<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> AclResult<br/></li>
<li><a id="L4854">&#x200c;</a><span class="linkable">pg_role_aclcheck</span>(Oid role_oid, Oid roleid, AclMode mode)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mode &amp; ACL_GRANT_OPTION_FOR(ACL_CREATE))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L5258" title="utils/adt/acl.c:5258">is_admin_of_role</a>(roleid, role_oid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ACLCHECK_OK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mode &amp; ACL_CREATE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L5208" title="utils/adt/acl.c:5208">is_member_of_role</a>(roleid, role_oid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ACLCHECK_OK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mode &amp; ACL_USAGE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>(roleid, role_oid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ACLCHECK_OK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (mode &amp; ACL_SET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L5162" title="utils/adt/acl.c:5162">member_can_set_role</a>(roleid, role_oid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ACLCHECK_OK;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ACLCHECK_NO_PRIV;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * initialization function (called by <a href="../init/postinit.c.html#L736" title="utils/init/postinit.c:736">InitPostgres</a>)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L4884">&#x200c;</a></span><span class="linkable">initialize_acl</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!IsBootstrapProcessingMode())<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L80" title="utils/adt/acl.c:80">cached_db_hash</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetSysCacheHashValue1(DATABASEOID,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ObjectIdGetDatum(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * In normal mode, set a callback on <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> syscache invalidation of rows<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * of pg_auth_members (for <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>()) pg_database (for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>())<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/inval.c.html#L1516" title="utils/cache/inval.c:1516">CacheRegisterSyscacheCallback</a>(AUTHMEMROLEMEM,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4914" title="utils/adt/acl.c:4914">RoleMembershipCacheCallback</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (Datum) <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/inval.c.html#L1516" title="utils/cache/inval.c:1516">CacheRegisterSyscacheCallback</a>(AUTHOID,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4914" title="utils/adt/acl.c:4914">RoleMembershipCacheCallback</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (Datum) <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/inval.c.html#L1516" title="utils/cache/inval.c:1516">CacheRegisterSyscacheCallback</a>(DATABASEOID,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L4914" title="utils/adt/acl.c:4914">RoleMembershipCacheCallback</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (Datum) <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L4914" title="utils/adt/acl.c:4914">RoleMembershipCacheCallback</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Syscache inval callback function<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L4914">&#x200c;</a></span><span class="linkable">RoleMembershipCacheCallback</span>(Datum arg, <span class="Type">int</span> cacheid, uint32 hashvalue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cacheid == DATABASEOID &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hashvalue != <a href="#L80" title="utils/adt/acl.c:80">cached_db_hash</a> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; hashvalue != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ignore pg_database changes for other DBs */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Force membership caches to be recomputed on <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> use */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[ROLERECURSE_MEMBERS] = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[ROLERECURSE_PRIVS] = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[ROLERECURSE_SETROLE] = InvalidOid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * A helper function for <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>() that provides an optimized<br/></li>
<li></span><span class="Comment"> * implementation of <a href="../../nodes/list.c.html#L1380" title="nodes/list.c:1380">list_append_unique_oid</a>() via a Bloom filter.&nbsp; The caller<br/></li>
<li></span><span class="Comment"> * (i.e., <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>()) is responsible for freeing bf once it is done<br/></li>
<li></span><span class="Comment"> * using this function.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">inline</span> List *<br/></li>
<li><a id="L4936">&#x200c;</a><span class="linkable">roles_list_append</span>(List *roles_list, <a href="../../lib/bloomfilter.c.html#L44" title="lib/bloomfilter.c:44">bloom_filter</a> **bf, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">char</span> *roleptr = (<span class="Type">unsigned</span> <span class="Type">char</span> *) &amp;role;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If there is a previously-created Bloom filter, use it to try to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * determine whether the role is missing from the list.&nbsp; If it says yes,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * that's a hard fact and we can go ahead and add the role.&nbsp; If it says<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * no, that's only probabilistic and we'd better search the list.&nbsp; Without<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * a filter, we must always do an ordinary linear search through the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * existing list.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((*bf &amp;&amp; <a href="../../lib/bloomfilter.c.html#L157" title="lib/bloomfilter.c:157">bloom_lacks_element</a>(*bf, roleptr, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Oid))) ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; !<a href="../../nodes/list.c.html#L722" title="nodes/list.c:722">list_member_oid</a>(roles_list, role))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If the list is large, we take on the overhead of creating and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * populating a Bloom filter to speed up future calls to this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * function.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*bf == <span class="Constant">NULL</span> &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list_length(roles_list) &gt; <a href="#L88" title="utils/adt/acl.c:88">ROLES_LIST_BLOOM_THRESHOLD</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *bf = <a href="../../lib/bloomfilter.c.html#L87" title="lib/bloomfilter.c:87">bloom_create</a>(<a href="#L88" title="utils/adt/acl.c:88">ROLES_LIST_BLOOM_THRESHOLD</a> * <span class="Constant">10</span>, <a href="../init/globals.c.html#L128" title="utils/init/globals.c:128">work_mem</a>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach_oid(roleid, roles_list)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../lib/bloomfilter.c.html#L135" title="lib/bloomfilter.c:135">bloom_add_element</a>(*bf, (<span class="Type">unsigned</span> <span class="Type">char</span> *) &amp;roleid, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Oid));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Finally, add the role to the list and the Bloom filter, if it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * exists.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; roles_list = <a href="../../nodes/list.c.html#L375" title="nodes/list.c:375">lappend_oid</a>(roles_list, role);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (*bf)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../lib/bloomfilter.c.html#L135" title="lib/bloomfilter.c:135">bloom_add_element</a>(*bf, roleptr, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Oid));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> roles_list;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Get a list of roles that the specified roleid is a member of<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Type ROLERECURSE_MEMBERS recurses through all grants; ROLERECURSE_PRIVS<br/></li>
<li></span><span class="Comment"> * recurses only through inheritable grants; and ROLERECURSE_SETROLE recurses<br/></li>
<li></span><span class="Comment"> * only through grants with set_option.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Since indirect membership testing is relatively expensive, we cache<br/></li>
<li></span><span class="Comment"> * a list of memberships.&nbsp; Hence, the result is only guaranteed good until<br/></li>
<li></span><span class="Comment"> * the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> call of <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>()!<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * For the benefit of <a href="#L5338" title="utils/adt/acl.c:5338">select_best_grantor</a>, the result is defined to be<br/></li>
<li></span><span class="Comment"> * in breadth-first order, ie, closer relationships earlier.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If admin_of is not InvalidOid, this function sets *admin_role, either<br/></li>
<li></span><span class="Comment"> * to the OID of the first role in the result list that directly possesses<br/></li>
<li></span><span class="Comment"> * ADMIN OPTION on the role corresponding to admin_of, or to InvalidOid if<br/></li>
<li></span><span class="Comment"> * there is no such role.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> List *<br/></li>
<li><a id="L4996">&#x200c;</a><span class="linkable">roles_is_member_of</span>(Oid roleid, <span class="Type">enum</span> <a href="#L72" title="utils/adt/acl.c:72">RoleRecurseType</a> type,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Oid admin_of, Oid *admin_role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dba;<br/></li>
<li>&nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *roles_list;<br/></li>
<li>&nbsp; &nbsp; ListCell&nbsp;&nbsp; *l;<br/></li>
<li>&nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *new_cached_roles;<br/></li>
<li>&nbsp; &nbsp; MemoryContext oldctx;<br/></li>
<li>&nbsp; &nbsp; <a href="../../lib/bloomfilter.c.html#L44" title="lib/bloomfilter.c:44">bloom_filter</a> *bf = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(OidIsValid(admin_of) == PointerIsValid(admin_role));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (admin_role != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *admin_role = InvalidOid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If cache is valid and ADMIN OPTION not sought, just return the list */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[type] == roleid &amp;&amp; !OidIsValid(admin_of) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; OidIsValid(<a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[type]))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L79" title="utils/adt/acl.c:79">cached_roles</a>[type];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Role expansion happens in a non-database backend when guc.c checks<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * ROLE_PG_READ_ALL_SETTINGS for a physical walsender SHOW command.&nbsp; In<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * that case, no role gets pg_database_owner.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dba = InvalidOid;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple&nbsp; &nbsp; dbtup;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dbtup = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(DATABASEOID, ObjectIdGetDatum(<a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(dbtup))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;cache lookup failed for database </span><span class="Special">%u</span><span class="Constant">&quot;</span>, <a href="../init/globals.c.html#L91" title="utils/init/globals.c:91">MyDatabaseId</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; dba = ((Form_pg_database) GETSTRUCT(dbtup))-&gt;datdba;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(dbtup);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Find all the roles that roleid is a member of, including multi-level<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * recursion.&nbsp; The role itself will always be the first <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * resulting list.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Each <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> of the list is scanned to see if it adds <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> indirect<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * memberships.&nbsp; We can use a single list as both the record of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * already-found memberships and the agenda of roles yet to be scanned.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * This is a <a href="varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> tricky but works because the foreach() macro doesn't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * fetch the <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> list <a href="../../regex/regc_locale.c.html#L376" title="regex/regc_locale.c:376">element</a> until the bottom of the loop.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; roles_list = list_make1_oid(roleid);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; foreach(l, roles_list)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memberid = lfirst_oid(l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CatCList&nbsp;&nbsp; *memlist;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Find roles that memberid is directly a member of */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; memlist = SearchSysCacheList1(AUTHMEMMEMROLE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ObjectIdGetDatum(memberid));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; memlist-&gt;n_members; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tup = &amp;memlist-&gt;members[i]-&gt;tuple;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Form_pg_auth_members form = (Form_pg_auth_members) GETSTRUCT(tup);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otherid = form-&gt;roleid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * While otherid==InvalidOid shouldn't appear in the catalog, the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * OidIsValid() avoids crashing if that arises.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (otherid == admin_of &amp;&amp; form-&gt;admin_option &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OidIsValid(admin_of) &amp;&amp; !OidIsValid(*admin_role))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *admin_role = memberid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* If we're supposed to ignore non-heritable grants, do so. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == ROLERECURSE_PRIVS &amp;&amp; !form-&gt;inherit_option)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* If we're supposed to ignore non-<a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> grants, do so. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (type == ROLERECURSE_SETROLE &amp;&amp; !form-&gt;set_option)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Even though there shouldn't be <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> loops in the membership<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * graph, we must test for having already seen this role. It is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * legal for instance to have both A-&gt;B and A-&gt;C-&gt;B.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roles_list = <a href="#L4936" title="utils/adt/acl.c:4936">roles_list_append</a>(roles_list, &amp;bf, otherid);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ReleaseSysCacheList(memlist);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* implement pg_database_owner implicit membership */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (memberid == dba &amp;&amp; OidIsValid(dba))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; roles_list = <a href="#L4936" title="utils/adt/acl.c:4936">roles_list_append</a>(roles_list, &amp;bf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ROLE_PG_DATABASE_OWNER);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Free the Bloom filter created by <a href="#L4936" title="utils/adt/acl.c:4936">roles_list_append</a>(), if there is one.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (bf)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../lib/bloomfilter.c.html#L126" title="lib/bloomfilter.c:126">bloom_free</a>(bf);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Copy the completed list into <a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a> so it will persist.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; oldctx = MemoryContextSwitchTo(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>);<br/></li>
<li>&nbsp; &nbsp; new_cached_roles = <a href="../../nodes/list.c.html#L1573" title="nodes/list.c:1573">list_copy</a>(roles_list);<br/></li>
<li>&nbsp; &nbsp; MemoryContextSwitchTo(oldctx);<br/></li>
<li>&nbsp; &nbsp; <a href="../../nodes/list.c.html#L1546" title="nodes/list.c:1546">list_free</a>(roles_list);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Now safe to assign to state variable<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[type] = InvalidOid; <span class="Comment">/* just paranoia */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../nodes/list.c.html#L1546" title="nodes/list.c:1546">list_free</a>(<a href="#L79" title="utils/adt/acl.c:79">cached_roles</a>[type]);<br/></li>
<li>&nbsp; &nbsp; <a href="#L79" title="utils/adt/acl.c:79">cached_roles</a>[type] = new_cached_roles;<br/></li>
<li>&nbsp; &nbsp; <a href="#L78" title="utils/adt/acl.c:78">cached_role</a>[type] = roleid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* And <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> we can return the answer */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L79" title="utils/adt/acl.c:79">cached_roles</a>[type];<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Does member have the privileges of role (directly or indirectly)?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is defined not to recurse through grants that are not inherited,<br/></li>
<li></span><span class="Comment"> * and only inherited grants confer the associated privileges automatically.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * See also <a href="#L5162" title="utils/adt/acl.c:5162">member_can_set_role</a>, below.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L5128">&#x200c;</a></span><span class="linkable">has_privs_of_role</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fast path for simple case */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (member == role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Superusers have every privilege, so are part of every role */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../misc/superuser.c.html#L56" title="utils/misc/superuser.c:56">superuser_arg</a>(member))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Find all the roles that member has the privileges of, including<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * multi-level recursion, then see if target role is <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> one of them.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../nodes/list.c.html#L722" title="nodes/list.c:722">list_member_oid</a>(<a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(member, ROLERECURSE_PRIVS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvalidOid, <span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; role);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Can member use <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE to this role?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * There must be a chain of grants from 'member' to 'role' each of which<br/></li>
<li></span><span class="Comment"> * permits <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE; that is, each of which has set_option = true.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * It doesn't matter whether the grants are inheritable. That's a separate<br/></li>
<li></span><span class="Comment"> * question; see <a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This function should be used to determine whether the session user can<br/></li>
<li></span><span class="Comment"> * use <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE to become the target user. We also use it to determine whether<br/></li>
<li></span><span class="Comment"> * the session user can change an existing object to be owned by the target<br/></li>
<li></span><span class="Comment"> * user, or create new objects owned by the target user.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L5162">&#x200c;</a></span><span class="linkable">member_can_set_role</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fast path for simple case */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (member == role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Superusers have every privilege, so can always <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../misc/superuser.c.html#L56" title="utils/misc/superuser.c:56">superuser_arg</a>(member))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Find all the roles that member can access via <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE, including<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * multi-level recursion, then see if target role is <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> one of them.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../nodes/list.c.html#L722" title="nodes/list.c:722">list_member_oid</a>(<a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(member, ROLERECURSE_SETROLE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvalidOid, <span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; role);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Permission violation error unless able to <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE to target role.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L5185">&#x200c;</a></span><span class="linkable">check_can_set_role</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L5162" title="utils/adt/acl.c:5162">member_can_set_role</a>(member, role))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INSUFFICIENT_PRIVILEGE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;must be able to <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../init/miscinit.c.html#L980" title="utils/init/miscinit.c:980">GetUserNameFromId</a>(role, <span class="Constant">false</span>))));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Is member a member of role (directly or indirectly)?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is defined to recurse through grants whether they are inherited or not.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Do not use this for privilege checking, instead use <a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>().<br/></li>
<li></span><span class="Comment"> * Don't use it for determining whether it's possible to <a href="../../regex/regc_lex.c.html#L43" title="regex/regc_lex.c:43">SET</a> ROLE to some<br/></li>
<li></span><span class="Comment"> * other role; for that, use <a href="#L5162" title="utils/adt/acl.c:5162">member_can_set_role</a>(). And don't use it for<br/></li>
<li></span><span class="Comment"> * determining whether it's OK to create an object owned by some other role:<br/></li>
<li></span><span class="Comment"> * use <a href="#L5162" title="utils/adt/acl.c:5162">member_can_set_role</a>() for that, too.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In short, calling this function is the wrong thing to do nearly everywhere.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L5208">&#x200c;</a></span><span class="linkable">is_member_of_role</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fast path for simple case */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (member == role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Superusers have every privilege, so are part of every role */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../misc/superuser.c.html#L56" title="utils/misc/superuser.c:56">superuser_arg</a>(member))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Find all the roles that member is a member of, including multi-level<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * recursion, then see if target role is <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> one of them.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../nodes/list.c.html#L722" title="nodes/list.c:722">list_member_oid</a>(<a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(member, ROLERECURSE_MEMBERS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvalidOid, <span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; role);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Is member a member of role, not considering superuserness?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is identical to <a href="#L5208" title="utils/adt/acl.c:5208">is_member_of_role</a> except we ignore <a href="../misc/superuser.c.html#L46" title="utils/misc/superuser.c:46">superuser</a><br/></li>
<li></span><span class="Comment"> * status.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Do not use this for privilege checking, instead use <a href="#L5128" title="utils/adt/acl.c:5128">has_privs_of_role</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L5236">&#x200c;</a></span><span class="linkable">is_member_of_role_nosuper</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fast path for simple case */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (member == role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Find all the roles that member is a member of, including multi-level<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * recursion, then see if target role is <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> one of them.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <a href="../../nodes/list.c.html#L722" title="nodes/list.c:722">list_member_oid</a>(<a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(member, ROLERECURSE_MEMBERS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvalidOid, <span class="Constant">NULL</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; role);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Is member an admin of role?&nbsp; &nbsp; That is, is member the role itself (subject to<br/></li>
<li></span><span class="Comment"> * restrictions below), a member (directly or indirectly) WITH ADMIN OPTION,<br/></li>
<li></span><span class="Comment"> * or a <a href="../misc/superuser.c.html#L46" title="utils/misc/superuser.c:46">superuser</a>?<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L5258">&#x200c;</a></span><span class="linkable">is_admin_of_role</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; admin_role;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../misc/superuser.c.html#L56" title="utils/misc/superuser.c:56">superuser_arg</a>(member))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* By policy, a role cannot have WITH ADMIN OPTION on itself. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (member == role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(member, ROLERECURSE_MEMBERS, role, &amp;admin_role);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> OidIsValid(admin_role);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Find a role whose privileges &quot;member&quot; inherits which has ADMIN OPTION<br/></li>
<li></span><span class="Comment"> * on &quot;role&quot;, ignoring super-userness.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * There might be more than one such role; prefer one which involves fewer<br/></li>
<li></span><span class="Comment"> * hops. That is, if member has ADMIN OPTION, prefer that over all other<br/></li>
<li></span><span class="Comment"> * options; if not, prefer a role from which member inherits more directly<br/></li>
<li></span><span class="Comment"> * over more indirect inheritance.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Oid<br/></li>
<li><a id="L5283">&#x200c;</a><span class="linkable">select_best_admin</span>(Oid member, Oid role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; admin_role;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* By policy, a role cannot have WITH ADMIN OPTION on itself. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (member == role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> InvalidOid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; (<span class="Type">void</span>) <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(member, ROLERECURSE_PRIVS, role, &amp;admin_role);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> admin_role;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* does what it says ... */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L5298">&#x200c;</a></span><span class="linkable">count_one_bits</span>(AclMode mask)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbits = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* this code relies on AclMode being an unsigned type */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (mask)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (mask &amp; <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nbits++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; mask &gt;&gt;= <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> nbits;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Select the effective grantor ID for a GRANT or REVOKE operation.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The grantor must always be either the object owner or some role that has<br/></li>
<li></span><span class="Comment"> * been explicitly granted grant options.&nbsp; This ensures that all granted<br/></li>
<li></span><span class="Comment"> * privileges appear to flow from the object owner, and there are never<br/></li>
<li></span><span class="Comment"> * multiple &quot;original sources&quot; of a privilege.&nbsp; Therefore, if the would-be<br/></li>
<li></span><span class="Comment"> * grantor is a member of a role that has the needed grant options, we have<br/></li>
<li></span><span class="Comment"> * to do the grant as that role instead.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * It is possible that the would-be grantor is a member of several roles<br/></li>
<li></span><span class="Comment"> * that have different subsets of the desired grant options, but no one<br/></li>
<li></span><span class="Comment"> * role has 'em all.&nbsp; In this case we pick a role with the largest number<br/></li>
<li></span><span class="Comment"> * of desired options.&nbsp; Ties are broken in favor of closer ancestors.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * roleId: the role attempting to do the GRANT/REVOKE<br/></li>
<li></span><span class="Comment"> * privileges: the privileges to be granted/revoked<br/></li>
<li></span><span class="Comment"> * acl: the ACL of the object in question<br/></li>
<li></span><span class="Comment"> * ownerId: the role owning the object in question<br/></li>
<li></span><span class="Comment"> * *grantorId: receives the OID of the role to do the grant as<br/></li>
<li></span><span class="Comment"> * *grantOptions: receives the grant options actually held by grantorId<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If no grant options exist, we set grantorId to roleId, grantOptions to 0.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L5338">&#x200c;</a></span><span class="linkable">select_best_grantor</span>(Oid roleId, AclMode privileges,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> Acl *acl, Oid ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid *grantorId, AclMode *grantOptions)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; needed_goptions = ACL_GRANT_OPTION_FOR(privileges);<br/></li>
<li>&nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *roles_list;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nrights;<br/></li>
<li>&nbsp; &nbsp; ListCell&nbsp;&nbsp; *l;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The object owner is always treated as having all grant options, so if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * roleId is the owner it's easy.&nbsp; Also, if roleId is a <a href="../misc/superuser.c.html#L46" title="utils/misc/superuser.c:46">superuser</a> it's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * easy: superusers are implicitly members of every role, so they act as<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the object owner.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (roleId == ownerId || <a href="../misc/superuser.c.html#L56" title="utils/misc/superuser.c:56">superuser_arg</a>(roleId))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *grantorId = ownerId;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *grantOptions = needed_goptions;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Otherwise we have to do a careful search to see if roleId has the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * privileges of <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> suitable role.&nbsp; Note: we can hang onto the result of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>() throughout this loop, because <a href="#L1454" title="utils/adt/acl.c:1454">aclmask_direct</a>()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * doesn't query <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> role memberships.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; roles_list = <a href="#L4996" title="utils/adt/acl.c:4996">roles_is_member_of</a>(roleId, ROLERECURSE_PRIVS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvalidOid, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> candidate result as default */<br/></li>
<li></span>&nbsp; &nbsp; *grantorId = roleId;<br/></li>
<li>&nbsp; &nbsp; *grantOptions = ACL_NO_RIGHTS;<br/></li>
<li>&nbsp; &nbsp; nrights = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; foreach(l, roles_list)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; otherrole = lfirst_oid(l);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; AclMode&nbsp; &nbsp; &nbsp; &nbsp; otherprivs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; otherprivs = <a href="#L1454" title="utils/adt/acl.c:1454">aclmask_direct</a>(acl, otherrole, ownerId,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; needed_goptions, ACLMASK_ALL);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (otherprivs == needed_goptions)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Found a suitable grantor */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *grantorId = otherrole;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *grantOptions = otherprivs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If it has just some of the needed privileges, remember best<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * candidate.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (otherprivs != ACL_NO_RIGHTS)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nnewrights = <a href="#L5298" title="utils/adt/acl.c:5298">count_one_bits</a>(otherprivs);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nnewrights &gt; nrights)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *grantorId = otherrole;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *grantOptions = otherprivs;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nrights = nnewrights;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a> - Given a role name, look up the role's OID.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If missing_ok is false, throw an error if role name not found.&nbsp; If<br/></li>
<li></span><span class="Comment"> * true, just return InvalidOid.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Oid<br/></li>
<li><a id="L5414">&#x200c;</a><span class="linkable">get_role_oid</span>(<span class="Type">const</span> <span class="Type">char</span> *rolname, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> missing_ok)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; oid = GetSysCacheOid1(AUTHNAME, Anum_pg_authid_oid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CStringGetDatum(rolname));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!OidIsValid(oid) &amp;&amp; !missing_ok)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, rolname)));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> oid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L5432" title="utils/adt/acl.c:5432">get_role_oid_or_public</a> - As above, but return ACL_ID_PUBLIC if the<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; role name is &quot;public&quot;.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Oid<br/></li>
<li><a id="L5432">&#x200c;</a><span class="linkable">get_role_oid_or_public</span>(<span class="Type">const</span> <span class="Type">char</span> *rolname)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (strcmp(rolname, <span class="Constant">&quot;public&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> ACL_ID_PUBLIC;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(rolname, <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a RoleSpec node, return the OID it corresponds to.&nbsp; If missing_ok is<br/></li>
<li></span><span class="Comment"> * true, return InvalidOid if the role does not exist.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * PUBLIC is always disallowed here.&nbsp; Routines wanting to handle the PUBLIC<br/></li>
<li></span><span class="Comment"> * case must check the case separately.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Oid<br/></li>
<li><a id="L5448">&#x200c;</a><span class="linkable">get_rolespec_oid</span>(<span class="Type">const</span> RoleSpec *role, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> missing_ok)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (role-&gt;roletype)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_CSTRING:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(role-&gt;rolename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid = <a href="#L5414" title="utils/adt/acl.c:5414">get_role_oid</a>(role-&gt;rolename, missing_ok);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_CURRENT_ROLE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_CURRENT_USER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid = <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_SESSION_USER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid = <a href="../init/miscinit.c.html#L548" title="utils/init/miscinit.c:548">GetSessionUserId</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_PUBLIC:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, <span class="Constant">&quot;public&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oid = InvalidOid;&nbsp; &nbsp; <span class="Comment">/* make compiler happy */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unexpected role type </span><span class="Special">%d</span><span class="Constant">&quot;</span>, role-&gt;roletype);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> oid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a RoleSpec node, return the pg_authid HeapTuple it corresponds to.<br/></li>
<li></span><span class="Comment"> * Caller must <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a> when done with the result tuple.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>HeapTuple<br/></li>
<li><a id="L5487">&#x200c;</a><span class="linkable">get_rolespec_tuple</span>(<span class="Type">const</span> RoleSpec *role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tuple;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">switch</span> (role-&gt;roletype)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_CSTRING:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(role-&gt;rolename);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(AUTHNAME, CStringGetDatum(role-&gt;rolename));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tuple))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, role-&gt;rolename)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_CURRENT_ROLE:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_CURRENT_USER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(AUTHOID, ObjectIdGetDatum(<a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>()));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tuple))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;cache lookup failed for role </span><span class="Special">%u</span><span class="Constant">&quot;</span>, <a href="../init/miscinit.c.html#L514" title="utils/init/miscinit.c:514">GetUserId</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_SESSION_USER:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple = <a href="../cache/syscache.c.html#L218" title="utils/cache/syscache.c:218">SearchSysCache1</a>(AUTHOID, ObjectIdGetDatum(<a href="../init/miscinit.c.html#L548" title="utils/init/miscinit.c:548">GetSessionUserId</a>()));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tuple))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;cache lookup failed for role </span><span class="Special">%u</span><span class="Constant">&quot;</span>, <a href="../init/miscinit.c.html#L548" title="utils/init/miscinit.c:548">GetSessionUserId</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> ROLESPEC_PUBLIC:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_UNDEFINED_OBJECT),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> does not exist&quot;</span>, <span class="Constant">&quot;public&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tuple = <span class="Constant">NULL</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* make compiler happy */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unexpected role type </span><span class="Special">%d</span><span class="Constant">&quot;</span>, role-&gt;roletype);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> tuple;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a RoleSpec, returns a <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>'ed copy of the corresponding role's name.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">char</span> *<br/></li>
<li><a id="L5533">&#x200c;</a><span class="linkable">get_rolespec_name</span>(<span class="Type">const</span> RoleSpec *role)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tp;<br/></li>
<li>&nbsp; &nbsp; Form_pg_authid authForm;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *rolename;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; tp = <a href="#L5487" title="utils/adt/acl.c:5487">get_rolespec_tuple</a>(role);<br/></li>
<li>&nbsp; &nbsp; authForm = (Form_pg_authid) GETSTRUCT(tp);<br/></li>
<li>&nbsp; &nbsp; rolename = <a href="../mmgr/mcxt.c.html#L1695" title="utils/mmgr/mcxt.c:1695">pstrdup</a>(NameStr(authForm-&gt;rolname));<br/></li>
<li>&nbsp; &nbsp; <a href="../cache/syscache.c.html#L266" title="utils/cache/syscache.c:266">ReleaseSysCache</a>(tp);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> rolename;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Given a RoleSpec, throw an error if the name is reserved, using detail_msg,<br/></li>
<li></span><span class="Comment"> * if provided (which must be already translated).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If node is NULL, no error is thrown.&nbsp; If detail_msg is NULL then no detail<br/></li>
<li></span><span class="Comment"> * message is provided.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L5555">&#x200c;</a></span><span class="linkable">check_rolespec_name</span>(<span class="Type">const</span> RoleSpec *role, <span class="Type">const</span> <span class="Type">char</span> *detail_msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!role)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (role-&gt;roletype != ROLESPEC_CSTRING)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../catalog/catalog.c.html#L217" title="catalog/catalog.c:217">IsReservedName</a>(role-&gt;rolename))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (detail_msg)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_RESERVED_NAME),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role name </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is reserved&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; role-&gt;rolename),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1232" title="utils/error/elog.c:1232">errdetail_internal</a>(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">&quot;</span>, detail_msg)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_RESERVED_NAME),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;role name </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> is reserved&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; role-&gt;rolename)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
