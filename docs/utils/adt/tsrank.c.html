<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/adt/tsrank.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/adt/tsrank.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L24">weights</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L590">CoverExt</a></li>
<li><a href="#L516">DocRepresentation</a></li>
<li><a href="#L554">QueryRepresentation</a></li>
<li><a href="#L548">QueryRepresentationOperand</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L646">Cover</a></li>
<li><a href="#L154">SortAndUniqItems</a></li>
<li><a href="#L357">calc_rank</a></li>
<li><a href="#L200">calc_rank_and</a></li>
<li><a href="#L850">calc_rank_cd</a></li>
<li><a href="#L283">calc_rank_or</a></li>
<li><a href="#L563">checkcondition_QueryOperand</a></li>
<li><a href="#L53">cnt_length</a></li>
<li><a href="#L519">compareDocR</a></li>
<li><a href="#L135">compareQueryOperand</a></li>
<li><a href="#L606">fillQueryRepresentationData</a></li>
<li><a href="#L86">find_wordentry</a></li>
<li><a href="#L400">getWeights</a></li>
<li><a href="#L727">get_docrep</a></li>
<li><a href="#L593">resetQueryRepresentation</a></li>
<li><a href="#L486">ts_rank_tt</a></li>
<li><a href="#L471">ts_rank_ttf</a></li>
<li><a href="#L455">ts_rank_wtt</a></li>
<li><a href="#L438">ts_rank_wttf</a></li>
<li><a href="#L1001">ts_rankcd_tt</a></li>
<li><a href="#L986">ts_rankcd_ttf</a></li>
<li><a href="#L970">ts_rankcd_wtt</a></li>
<li><a href="#L953">ts_rankcd_wttf</a></li>
<li><a href="#L44">word_distance</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L35">DEF_NORM_METHOD</a></li>
<li><a href="#L540">MAXQROPOS</a></li>
<li><a href="#L556">QR_GET_OPERAND_DATA</a></li>
<li><a href="#L31">RANK_NORM_EXTDIST</a></li>
<li><a href="#L30">RANK_NORM_LENGTH</a></li>
<li><a href="#L29">RANK_NORM_LOGLENGTH</a></li>
<li><a href="#L33">RANK_NORM_LOGUNIQ</a></li>
<li><a href="#L34">RANK_NORM_RDIVRPLUS1</a></li>
<li><a href="#L32">RANK_NORM_UNIQ</a></li>
<li><a href="#L28">RANK_NO_NORM</a></li>
<li><a href="#L75">WordECompareQueryItem</a></li>
<li><a href="#L26">wpos</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * tsrank.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; rank tsvector by tsquery<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/adt/tsrank.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;limits.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;math.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;tsearch/ts_utils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/array.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/fmgrprotos.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L24">&#x200c;</a><span class="Type">static</span> <span class="Type">const</span> <span class="Type">float</span> <span class="linkable">weights</span>[] = {<span class="Constant">0.1f</span>, <span class="Constant">0.2f</span>, <span class="Constant">0.4f</span>, <span class="Constant">1.0f</span>};<br/></li>
<li><br/></li>
<li><a id="L26">&#x200c;</a><span class="PreProc">#define <span class="linkable">wpos</span>(wep)&nbsp; &nbsp; ( w[ WEP_GETWEIGHT(wep) ] )<br/></li>
<li></span><br/></li>
<li><a id="L28">&#x200c;</a><span class="PreProc">#define <span class="linkable">RANK_NO_NORM</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x00<br/></li>
<li><a id="L29">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RANK_NORM_LOGLENGTH</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x01<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RANK_NORM_LENGTH</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x02<br/></li>
<li><a id="L31">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RANK_NORM_EXTDIST</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x04<br/></li>
<li><a id="L32">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RANK_NORM_UNIQ</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x08<br/></li>
<li><a id="L33">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RANK_NORM_LOGUNIQ</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0x10<br/></li>
<li><a id="L34">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RANK_NORM_RDIVRPLUS1</span>&nbsp; &nbsp; </span><span class="Constant">0x20<br/></li>
<li><a id="L35">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">DEF_NORM_METHOD</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L28" title="utils/adt/tsrank.c:28">RANK_NO_NORM</a><br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">float</span> <a href="#L283" title="utils/adt/tsrank.c:283">calc_rank_or</a>(<span class="Type">const</span> <span class="Type">float</span> *w, TSVector t, TSQuery q);<br/></li>
<li><span class="Type">static</span> <span class="Type">float</span> <a href="#L200" title="utils/adt/tsrank.c:200">calc_rank_and</a>(<span class="Type">const</span> <span class="Type">float</span> *w, TSVector t, TSQuery q);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Returns a weight of a <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a> collocation<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> float4<br/></li>
<li><a id="L44">&#x200c;</a><span class="linkable">word_distance</span>(int32 w)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (w &gt; <span class="Constant">100</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1e-30f</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1.0</span> / (<span class="Constant">1.005</span> + <span class="Constant">0.05</span> * exp(((float4) w) / <span class="Constant">1.5</span> - <span class="Constant">2</span>));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L53">&#x200c;</a></span><span class="linkable">cnt_length</span>(TSVector t)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *ptr = ARRPTR(t),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *end = (WordEntry *) STRPTR(t);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (ptr &lt; end)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clen = POSDATALEN(t, ptr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (clen == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len += clen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> len;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><a id="L75">&#x200c;</a><span class="PreProc">#define <span class="linkable">WordECompareQueryItem</span>(e,q,p,i,m) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; <a href="tsvector_op.c.html#L1152" title="utils/adt/tsvector_op.c:1152">tsCompareString</a>((q) + (i)-&gt;distance, (i)-&gt;length,&nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (e) + (p)-&gt;pos, (p)-&gt;len, (m))<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Returns a pointer to a WordEntry's array corresponding to 'item' from<br/></li>
<li></span><span class="Comment"> * tsvector 't'. 'q' is the TSQuery containing 'item'.<br/></li>
<li></span><span class="Comment"> * Returns NULL if not found.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> WordEntry *<br/></li>
<li><a id="L86">&#x200c;</a><span class="linkable">find_wordentry</span>(TSVector t, TSQuery q, QueryOperand *item, int32 *nitem)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *StopLow = ARRPTR(t);<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *StopHigh = (WordEntry *) STRPTR(t);<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *StopMiddle = StopHigh;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; difference;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *nitem = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Loop invariant: StopLow &lt;= item &lt; StopHigh */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (StopLow &lt; StopHigh)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; StopMiddle = StopLow + (StopHigh - StopLow) / <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; difference = <a href="#L75" title="utils/adt/tsrank.c:75">WordECompareQueryItem</a>(STRPTR(t), GETOPERAND(q), StopMiddle, item, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (difference == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StopHigh = StopMiddle;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *nitem = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (difference &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StopLow = StopMiddle + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StopHigh = StopMiddle;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (item-&gt;prefix)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (StopLow &gt;= StopHigh)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StopMiddle = StopHigh;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *nitem = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (StopMiddle &lt; (WordEntry *) STRPTR(t) &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L75" title="utils/adt/tsrank.c:75">WordECompareQueryItem</a>(STRPTR(t), GETOPERAND(q), StopMiddle, item, <span class="Constant">true</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (*nitem)++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; StopMiddle++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (*nitem &gt; <span class="Constant">0</span>) ? StopHigh : <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * sort QueryOperands by (length, <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a>)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L135">&#x200c;</a></span><span class="linkable">compareQueryOperand</span>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *operand = (<span class="Type">char</span> *) arg;<br/></li>
<li>&nbsp; &nbsp; QueryOperand *qa = (*(QueryOperand *<span class="Type">const</span> *) a);<br/></li>
<li>&nbsp; &nbsp; QueryOperand *qb = (*(QueryOperand *<span class="Type">const</span> *) b);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="tsvector_op.c.html#L1152" title="utils/adt/tsvector_op.c:1152">tsCompareString</a>(operand + qa-&gt;distance, qa-&gt;length,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; operand + qb-&gt;distance, qb-&gt;length,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">false</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Returns a sorted, de-duplicated array of QueryOperands in a query.<br/></li>
<li></span><span class="Comment"> * The returned QueryOperands are pointers to the original QueryOperands<br/></li>
<li></span><span class="Comment"> * in the query.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Length of the returned array is stored in *size<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> QueryOperand **<br/></li>
<li><a id="L154">&#x200c;</a><span class="linkable">SortAndUniqItems</span>(TSQuery q, <span class="Type">int</span> *size)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *operand = GETOPERAND(q);<br/></li>
<li>&nbsp; &nbsp; QueryItem&nbsp; *item = GETQUERY(q);<br/></li>
<li>&nbsp; &nbsp; QueryOperand **res,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **ptr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; **prevptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ptr = res = (QueryOperand **) <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(QueryOperand *) * *size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Collect all operands from the tree to res */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> ((*size)--)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (item-&gt;type == QI_VAL)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *ptr = (QueryOperand *) item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; item++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *size = ptr - res;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (*size &lt; <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qsort_arg(res, *size, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(QueryOperand *), <a href="#L135" title="utils/adt/tsrank.c:135">compareQueryOperand</a>, operand);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ptr = res + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; prevptr = res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* remove duplicates */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (ptr - res &lt; *size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L135" title="utils/adt/tsrank.c:135">compareQueryOperand</a>((<span class="Type">void</span> *) ptr, (<span class="Type">void</span> *) prevptr, (<span class="Type">void</span> *) operand) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prevptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *prevptr = *ptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *size = prevptr + <span class="Constant">1</span> - res;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">float<br/></li>
<li><a id="L200">&#x200c;</a></span><span class="linkable">calc_rank_and</span>(<span class="Type">const</span> <span class="Type">float</span> *w, TSVector t, TSQuery q)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WordEntryPosVector **pos;<br/></li>
<li>&nbsp; &nbsp; WordEntryPosVector1 posnull;<br/></li>
<li>&nbsp; &nbsp; WordEntryPosVector *POSNULL;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; k,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p;<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *entry,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *firstentry;<br/></li>
<li>&nbsp; &nbsp; WordEntryPos *post,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *ct;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; dimt,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lenct,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dist,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nitem;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res = -<span class="Constant">1.0</span>;<br/></li>
<li>&nbsp; &nbsp; QueryOperand **item;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = q-&gt;size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; item = <a href="#L154" title="utils/adt/tsrank.c:154">SortAndUniqItems</a>(q, &amp;size);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &lt; <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(item);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L283" title="utils/adt/tsrank.c:283">calc_rank_or</a>(w, t, q);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; pos = (WordEntryPosVector **) <a href="../mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(WordEntryPosVector *) * q-&gt;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* A dummy WordEntryPos array to use when haspos is false */<br/></li>
<li></span>&nbsp; &nbsp; posnull.npos = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; posnull.pos[<span class="Constant">0</span>] = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; WEP_SETPOS(posnull.pos[<span class="Constant">0</span>], MAXENTRYPOS - <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; POSNULL = (WordEntryPosVector *) &amp;posnull;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; size; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; firstentry = entry = <a href="#L86" title="utils/adt/tsrank.c:86">find_wordentry</a>(t, q, item[i], &amp;nitem);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (entry - firstentry &lt; nitem)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entry-&gt;haspos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos[i] = _POSVECPTR(t, entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos[i] = POSNULL;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dimt = pos[i]-&gt;npos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; post = pos[i]-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (k = <span class="Constant">0</span>; k &lt; i; k++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!pos[k])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lenct = pos[k]-&gt;npos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ct = pos[k]-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (l = <span class="Constant">0</span>; l &lt; dimt; l++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (p = <span class="Constant">0</span>; p &lt; lenct; p++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dist = abs((<span class="Type">int</span>) WEP_GETPOS(post[l]) - (<span class="Type">int</span>) WEP_GETPOS(ct[p]));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dist || (dist == <span class="Constant">0</span> &amp;&amp; (pos[i] == POSNULL || pos[k] == POSNULL)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; curw;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!dist)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dist = MAXENTRYPOS;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curw = sqrt(<a href="#L26" title="utils/adt/tsrank.c:26">wpos</a>(post[l]) * <a href="#L26" title="utils/adt/tsrank.c:26">wpos</a>(ct[p]) * <a href="#L44" title="utils/adt/tsrank.c:44">word_distance</a>(dist));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = (res &lt; <span class="Constant">0</span>) ? curw : <span class="Constant">1.0</span> - (<span class="Constant">1.0</span> - res) * (<span class="Constant">1.0</span> - curw);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(pos);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(item);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">float<br/></li>
<li><a id="L283">&#x200c;</a></span><span class="linkable">calc_rank_or</span>(<span class="Type">const</span> <span class="Type">float</span> *w, TSVector t, TSQuery q)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *entry,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *firstentry;<br/></li>
<li>&nbsp; &nbsp; WordEntryPosVector1 posnull;<br/></li>
<li>&nbsp; &nbsp; WordEntryPos *post;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; dimt,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nitem;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; QueryOperand **item;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = q-&gt;size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* A dummy WordEntryPos array to use when haspos is false */<br/></li>
<li></span>&nbsp; &nbsp; posnull.npos = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; posnull.pos[<span class="Constant">0</span>] = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; item = <a href="#L154" title="utils/adt/tsrank.c:154">SortAndUniqItems</a>(q, &amp;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; size; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; resj,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wjm;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; jm;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; firstentry = entry = <a href="#L86" title="utils/adt/tsrank.c:86">find_wordentry</a>(t, q, item[i], &amp;nitem);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (entry - firstentry &lt; nitem)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entry-&gt;haspos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dimt = POSDATALEN(t, entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; post = POSDATAPTR(t, entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dimt = posnull.npos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; post = posnull.pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resj = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wjm = -<span class="Constant">1.0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jm = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; dimt; j++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resj = resj + <a href="#L26" title="utils/adt/tsrank.c:26">wpos</a>(post[j]) / ((j + <span class="Constant">1</span>) * (j + <span class="Constant">1</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L26" title="utils/adt/tsrank.c:26">wpos</a>(post[j]) &gt; wjm)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wjm = <a href="#L26" title="utils/adt/tsrank.c:26">wpos</a>(post[j]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jm = j;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; limit (sum(1/i^2),i=1,inf) = pi^2/6<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resj = sum(wi/i^2),i=1,noccurrence,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wi - should be sorted desc,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; don't sort for <a href="timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>, just choose maximum weight. This should be corrected<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oleg Bartunov<br/></li>
<li></span><span class="Comment">*/<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res = res + (wjm + resj - wjm / ((jm + <span class="Constant">1</span>) * (jm + <span class="Constant">1</span>))) / <span class="Constant">1.64493406685</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res = res / size;<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(item);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">float<br/></li>
<li><a id="L357">&#x200c;</a></span><span class="linkable">calc_rank</span>(<span class="Type">const</span> <span class="Type">float</span> *w, TSVector t, TSQuery q, int32 method)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; QueryItem&nbsp; *item = GETQUERY(q);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!t-&gt;size || !q-&gt;size)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0.0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* </span><span class="Todo">XXX</span><span class="Comment">: What about NOT? */<br/></li>
<li></span>&nbsp; &nbsp; res = (item-&gt;type == QI_OPR &amp;&amp; (item-&gt;qoperator.<a href="../../parser/parse_oper.c.html#L370" title="parser/parse_oper.c:370">oper</a> == OP_AND ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item-&gt;qoperator.<a href="../../parser/parse_oper.c.html#L370" title="parser/parse_oper.c:370">oper</a> == OP_PHRASE)) ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L200" title="utils/adt/tsrank.c:200">calc_rank_and</a>(w, t, q) :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L283" title="utils/adt/tsrank.c:283">calc_rank_or</a>(w, t, q);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (res &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res = <span class="Constant">1e-20f</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L29" title="utils/adt/tsrank.c:29">RANK_NORM_LOGLENGTH</a>) &amp;&amp; t-&gt;size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res /= log((<span class="Type">double</span>) (<a href="#L53" title="utils/adt/tsrank.c:53">cnt_length</a>(t) + <span class="Constant">1</span>)) / log(<span class="Constant">2.0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (method &amp; <a href="#L30" title="utils/adt/tsrank.c:30">RANK_NORM_LENGTH</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L53" title="utils/adt/tsrank.c:53">cnt_length</a>(t);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res /= (<span class="Type">float</span>) len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="#L31" title="utils/adt/tsrank.c:31">RANK_NORM_EXTDIST</a> not applicable */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L32" title="utils/adt/tsrank.c:32">RANK_NORM_UNIQ</a>) &amp;&amp; t-&gt;size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res /= (<span class="Type">float</span>) (t-&gt;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L33" title="utils/adt/tsrank.c:33">RANK_NORM_LOGUNIQ</a>) &amp;&amp; t-&gt;size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res /= log((<span class="Type">double</span>) (t-&gt;size + <span class="Constant">1</span>)) / log(<span class="Constant">2.0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (method &amp; <a href="#L34" title="utils/adt/tsrank.c:34">RANK_NORM_RDIVRPLUS1</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; res /= (res + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> res;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">const</span> <span class="Type">float</span> *<br/></li>
<li><a id="L400">&#x200c;</a><span class="linkable">getWeights</span>(ArrayType *win)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">float</span> ws[lengthof(<a href="#L24" title="utils/adt/tsrank.c:24">weights</a>)];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; float4&nbsp; &nbsp; &nbsp;&nbsp; *arrdata;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (win == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <a href="#L24" title="utils/adt/tsrank.c:24">weights</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ARR_NDIM(win) != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;array of weight must be one-dimensional&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="arrayutils.c.html#L57" title="utils/adt/arrayutils.c:57">ArrayGetNItems</a>(ARR_NDIM(win), ARR_DIMS(win)) &lt; lengthof(<a href="#L24" title="utils/adt/tsrank.c:24">weights</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_ARRAY_SUBSCRIPT_ERROR),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;array of weight is too short&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="arrayfuncs.c.html#L3748" title="utils/adt/arrayfuncs.c:3748">array_contains_nulls</a>(win))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_NULL_VALUE_NOT_ALLOWED),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;array of weight must not contain nulls&quot;</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; arrdata = (float4 *) ARR_DATA_PTR(win);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; lengthof(<a href="#L24" title="utils/adt/tsrank.c:24">weights</a>); i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ws[i] = (arrdata[i] &gt;= <span class="Constant">0</span>) ? arrdata[i] : <a href="#L24" title="utils/adt/tsrank.c:24">weights</a>[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (ws[i] &gt; <span class="Constant">1.0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;weight out of <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> ws;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L438">&#x200c;</a><span class="linkable">ts_rank_wttf</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *win = (ArrayType *) PG_DETOAST_DATUM(PG_GETARG_DATUM(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method = PG_GETARG_INT32(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L357" title="utils/adt/tsrank.c:357">calc_rank</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(win), txt, query, method);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(win, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L455">&#x200c;</a><span class="linkable">ts_rank_wtt</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *win = (ArrayType *) PG_DETOAST_DATUM(PG_GETARG_DATUM(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L357" title="utils/adt/tsrank.c:357">calc_rank</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(win), txt, query, <a href="#L35" title="utils/adt/tsrank.c:35">DEF_NORM_METHOD</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(win, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L471">&#x200c;</a><span class="linkable">ts_rank_ttf</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method = PG_GETARG_INT32(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L357" title="utils/adt/tsrank.c:357">calc_rank</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(<span class="Constant">NULL</span>), txt, query, method);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L486">&#x200c;</a><span class="linkable">ts_rank_tt</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L357" title="utils/adt/tsrank.c:357">calc_rank</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(<span class="Constant">NULL</span>), txt, query, <a href="#L35" title="utils/adt/tsrank.c:35">DEF_NORM_METHOD</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">union<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* compiled doc representation */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QueryItem **items;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int16&nbsp; &nbsp; &nbsp; &nbsp; nitem;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">struct<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* struct is used for preparing doc<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * representation */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QueryItem&nbsp; *item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WordEntry&nbsp; *entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map;<br/></li>
<li>&nbsp; &nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data;<br/></li>
<li>&nbsp; &nbsp; WordEntryPos pos;<br/></li>
<li><a id="L516">&#x200c;</a>} <span class="linkable">DocRepresentation</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L519">&#x200c;</a></span><span class="linkable">compareDocR</span>(<span class="Type">const</span> <span class="Type">void</span> *va, <span class="Type">const</span> <span class="Type">void</span> *vb)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *a = (<span class="Type">const</span> <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *) va;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *b = (<span class="Type">const</span> <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *) vb;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (WEP_GETPOS(a-&gt;pos) == WEP_GETPOS(b-&gt;pos))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (WEP_GETWEIGHT(a-&gt;pos) == WEP_GETWEIGHT(b-&gt;pos))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (a-&gt;data.map.entry == b-&gt;data.map.entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (a-&gt;data.map.entry &gt; b-&gt;data.map.entry) ? <span class="Constant">1</span> : -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> (WEP_GETWEIGHT(a-&gt;pos) &gt; WEP_GETWEIGHT(b-&gt;pos)) ? <span class="Constant">1</span> : -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (WEP_GETPOS(a-&gt;pos) &gt; WEP_GETPOS(b-&gt;pos)) ? <span class="Constant">1</span> : -<span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L540">&#x200c;</a><span class="PreProc">#define <span class="linkable">MAXQROPOS</span>&nbsp; &nbsp; MAXENTRYPOS<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; operandexists;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; reverseinsert;&nbsp; &nbsp; <span class="Comment">/* indicates insert order, true means<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * descending order */<br/></li>
<li></span>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; npos;<br/></li>
<li>&nbsp; &nbsp; WordEntryPos pos[<a href="#L540" title="utils/adt/tsrank.c:540">MAXQROPOS</a>];<br/></li>
<li><a id="L548">&#x200c;</a>} <span class="linkable">QueryRepresentationOperand</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query;<br/></li>
<li>&nbsp; &nbsp; <a href="#L548" title="utils/adt/tsrank.c:548">QueryRepresentationOperand</a> *operandData;<br/></li>
<li><a id="L554">&#x200c;</a>} <span class="linkable">QueryRepresentation</span>;<br/></li>
<li><br/></li>
<li><a id="L556">&#x200c;</a><span class="PreProc">#define <span class="linkable">QR_GET_OPERAND_DATA</span>(q, v) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; ( (q)-&gt;operandData + (((QueryItem*)(v)) - GETQUERY((q)-&gt;query)) )<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="tsvector_op.c.html#L1854" title="utils/adt/tsvector_op.c:1854">TS_execute</a> callback for matching a tsquery operand to <a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a><br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> TSTernaryValue<br/></li>
<li><a id="L563">&#x200c;</a><span class="linkable">checkcondition_QueryOperand</span>(<span class="Type">void</span> *checkval, QueryOperand *val,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecPhraseData *data)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> *qr = (<a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> *) checkval;<br/></li>
<li>&nbsp; &nbsp; <a href="#L548" title="utils/adt/tsrank.c:548">QueryRepresentationOperand</a> *opData = <a href="#L556" title="utils/adt/tsrank.c:556">QR_GET_OPERAND_DATA</a>(qr, val);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!opData-&gt;operandexists)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> TS_NO;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (data)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;npos = opData-&gt;npos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos = opData-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (opData-&gt;reverseinsert)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data-&gt;pos += <a href="#L540" title="utils/adt/tsrank.c:540">MAXQROPOS</a> - opData-&gt;npos;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> TS_YES;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pos;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q;<br/></li>
<li>&nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *begin;<br/></li>
<li>&nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *end;<br/></li>
<li><a id="L590">&#x200c;</a>} <span class="linkable">CoverExt</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L593">&#x200c;</a></span><span class="linkable">resetQueryRepresentation</span>(<a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> *qr, <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> reverseinsert)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; qr-&gt;query-&gt;size; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qr-&gt;operandData[i].operandexists = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qr-&gt;operandData[i].reverseinsert = reverseinsert;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; qr-&gt;operandData[i].npos = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L606">&#x200c;</a></span><span class="linkable">fillQueryRepresentationData</span>(<a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> *qr, <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *entry)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastPos;<br/></li>
<li>&nbsp; &nbsp; <a href="#L548" title="utils/adt/tsrank.c:548">QueryRepresentationOperand</a> *opData;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; entry-&gt;data.query.nitem; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entry-&gt;data.query.items[i]-&gt;type != QI_VAL)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; opData = <a href="#L556" title="utils/adt/tsrank.c:556">QR_GET_OPERAND_DATA</a>(qr, entry-&gt;data.query.items[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; opData-&gt;operandexists = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (opData-&gt;npos == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastPos = (opData-&gt;reverseinsert) ? (<a href="#L540" title="utils/adt/tsrank.c:540">MAXQROPOS</a> - <span class="Constant">1</span>) : <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; opData-&gt;pos[lastPos] = entry-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; opData-&gt;npos++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; lastPos = opData-&gt;reverseinsert ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="#L540" title="utils/adt/tsrank.c:540">MAXQROPOS</a> - opData-&gt;npos) :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (opData-&gt;npos - <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (WEP_GETPOS(opData-&gt;pos[lastPos]) != WEP_GETPOS(entry-&gt;pos))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastPos = opData-&gt;reverseinsert ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="#L540" title="utils/adt/tsrank.c:540">MAXQROPOS</a> - <span class="Constant">1</span> - opData-&gt;npos) :<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (opData-&gt;npos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; opData-&gt;pos[lastPos] = entry-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; opData-&gt;npos++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L646">&#x200c;</a></span><span class="linkable">Cover</span>(<a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *doc, <span class="Type">int</span> len, <a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> *qr, <a href="#L590" title="utils/adt/tsrank.c:590">CoverExt</a> *ext)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *ptr;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastpos = ext-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * since this function recurses, it could be driven to stack overflow.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (though <a href="pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> decent compiler will <a href="../../regex/regc_nfa.c.html#L1593" title="regex/regc_nfa.c:1593">optimize</a> away the tail-recursion.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../tcop/postgres.c.html#L3531" title="tcop/postgres.c:3531">check_stack_depth</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L593" title="utils/adt/tsrank.c:593">resetQueryRepresentation</a>(qr, <span class="Constant">false</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ext-&gt;p = <span class="Constant">INT_MAX</span>;<br/></li>
<li>&nbsp; &nbsp; ext-&gt;q = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; ptr = doc + ext-&gt;pos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> <a href="oracle_compat.c.html#L80" title="utils/adt/oracle_compat.c:80">upper</a> bound of cover from current position, move up */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (ptr - doc &lt; len)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L606" title="utils/adt/tsrank.c:606">fillQueryRepresentationData</a>(qr, ptr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="tsvector_op.c.html#L1854" title="utils/adt/tsvector_op.c:1854">TS_execute</a>(GETQUERY(qr-&gt;query), (<span class="Type">void</span> *) qr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TS_EXEC_EMPTY, <a href="#L563" title="utils/adt/tsrank.c:563">checkcondition_QueryOperand</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (WEP_GETPOS(ptr-&gt;pos) &gt; ext-&gt;q)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ext-&gt;q = WEP_GETPOS(ptr-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ext-&gt;end = ptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastpos = ptr - doc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; found = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L593" title="utils/adt/tsrank.c:593">resetQueryRepresentation</a>(qr, <span class="Constant">true</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ptr = doc + lastpos;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> <a href="oracle_compat.c.html#L49" title="utils/adt/oracle_compat.c:49">lower</a> bound of cover from found <a href="oracle_compat.c.html#L80" title="utils/adt/oracle_compat.c:80">upper</a> bound, move down */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (ptr &gt;= doc + ext-&gt;pos)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * we scan doc from right to left, so pos info in reverse order!<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L606" title="utils/adt/tsrank.c:606">fillQueryRepresentationData</a>(qr, ptr);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="tsvector_op.c.html#L1854" title="utils/adt/tsvector_op.c:1854">TS_execute</a>(GETQUERY(qr-&gt;query), (<span class="Type">void</span> *) qr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TS_EXEC_EMPTY, <a href="#L563" title="utils/adt/tsrank.c:563">checkcondition_QueryOperand</a>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (WEP_GETPOS(ptr-&gt;pos) &lt; ext-&gt;p)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ext-&gt;begin = ptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ext-&gt;p = WEP_GETPOS(ptr-&gt;pos);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ptr--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ext-&gt;p &lt;= ext-&gt;q)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * set position for <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> try to <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> lexeme after beginning of found<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * cover<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ext-&gt;pos = (ptr - doc) + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ext-&gt;pos++;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L646" title="utils/adt/tsrank.c:646">Cover</a>(doc, len, qr, ext);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *<br/></li>
<li><a id="L727">&#x200c;</a><span class="linkable">get_docrep</span>(TSVector txt, <a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> *qr, <span class="Type">int</span> *doclen)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; QueryItem&nbsp; *item = GETQUERY(qr-&gt;query);<br/></li>
<li>&nbsp; &nbsp; WordEntry&nbsp; *entry,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *firstentry;<br/></li>
<li>&nbsp; &nbsp; WordEntryPos *post;<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; dimt,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* number of 'post' items */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nitem;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = qr-&gt;query-&gt;size * <span class="Constant">4</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cur = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *doc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; doc = (<a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *) <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a>) * len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Iterate through query to make <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> for words and it's<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * entries satisfied by query<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; qr-&gt;query-&gt;size; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; QueryOperand *curoperand;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (item[i].type != QI_VAL)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; curoperand = &amp;item[i].qoperand;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; firstentry = entry = <a href="#L86" title="utils/adt/tsrank.c:86">find_wordentry</a>(txt, qr-&gt;query, curoperand, &amp;nitem);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* iterations over entries in tsvector */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (entry - firstentry &lt; nitem)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (entry-&gt;haspos)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dimt = POSDATALEN(txt, entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; post = POSDATAPTR(txt, entry);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* ignore words without positions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (cur + dimt &gt;= len)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len *= <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc = (<a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *) <a href="../mmgr/mcxt.c.html#L1540" title="utils/mmgr/mcxt.c:1540">repalloc</a>(doc, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a>) * len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* iterations over entry's positions */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (j = <span class="Constant">0</span>; j &lt; dimt; j++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (curoperand-&gt;weight == <span class="Constant">0</span> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curoperand-&gt;weight &amp; (<span class="Constant">1</span> &lt;&lt; WEP_GETWEIGHT(post[j])))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc[cur].pos = post[j];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc[cur].data.map.entry = entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc[cur].data.map.item = (QueryItem *) curoperand;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cur++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cur &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *rptr = doc + <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *wptr = doc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Sort representation in ascending order by pos and entry<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; qsort(doc, cur, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a>), <a href="#L519" title="utils/adt/tsrank.c:519">compareDocR</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Join QueryItem per WordEntry and it's position<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; storage.pos = doc-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.items = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(QueryItem *) * qr-&gt;query-&gt;size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.items[<span class="Constant">0</span>] = doc-&gt;data.map.item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.nitem = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (rptr - doc &lt; cur)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rptr-&gt;pos == (rptr - <span class="Constant">1</span>)-&gt;pos &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rptr-&gt;data.map.entry == (rptr - <span class="Constant">1</span>)-&gt;data.map.entry)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.items[storage.data.query.nitem] = rptr-&gt;data.map.item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.nitem++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *wptr = storage;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage.pos = rptr-&gt;pos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.items = <a href="../mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(QueryItem *) * qr-&gt;query-&gt;size);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.items[<span class="Constant">0</span>] = rptr-&gt;data.map.item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; storage.data.query.nitem = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *wptr = storage;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; wptr++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *doclen = wptr - doc;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> doc;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(doc);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> float4<br/></li>
<li><a id="L850">&#x200c;</a><span class="linkable">calc_rank_cd</span>(<span class="Type">const</span> float4 *arrdata, TSVector txt, TSQuery query, <span class="Type">int</span> method)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *doc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doclen = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L590" title="utils/adt/tsrank.c:590">CoverExt</a>&nbsp; &nbsp; ext;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; invws[lengthof(<a href="#L24" title="utils/adt/tsrank.c:24">weights</a>)];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; SumDist = <span class="Constant">0.0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PrevExtPos = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NExtent = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L554" title="utils/adt/tsrank.c:554">QueryRepresentation</a> qr;<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; lengthof(<a href="#L24" title="utils/adt/tsrank.c:24">weights</a>); i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; invws[i] = ((<span class="Type">double</span>) ((arrdata[i] &gt;= <span class="Constant">0</span>) ? arrdata[i] : <a href="#L24" title="utils/adt/tsrank.c:24">weights</a>[i]));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (invws[i] &gt; <span class="Constant">1.0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../error/elog.c.html#L859" title="utils/error/elog.c:859">errcode</a>(ERRCODE_INVALID_PARAMETER_VALUE),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;weight out of <a href="../../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; invws[i] = <span class="Constant">1.0</span> / invws[i];<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qr.query = query;<br/></li>
<li>&nbsp; &nbsp; qr.operandData = (<a href="#L548" title="utils/adt/tsrank.c:548">QueryRepresentationOperand</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L548" title="utils/adt/tsrank.c:548">QueryRepresentationOperand</a>) * query-&gt;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; doc = <a href="#L727" title="utils/adt/tsrank.c:727">get_docrep</a>(txt, &amp;qr, &amp;doclen);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!doc)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(qr.operandData);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; MemSet(&amp;ext, <span class="Constant">0</span>, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L590" title="utils/adt/tsrank.c:590">CoverExt</a>));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="#L646" title="utils/adt/tsrank.c:646">Cover</a>(doc, doclen, &amp;qr, &amp;ext))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; Cpos = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; InvSum = <span class="Constant">0.0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">double</span>&nbsp; &nbsp; &nbsp; &nbsp; CurExtPos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nNoise;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L516" title="utils/adt/tsrank.c:516">DocRepresentation</a> *ptr = ext.begin;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (ptr &lt;= ext.end)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvSum += invws[WEP_GETWEIGHT(ptr-&gt;pos)];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ptr++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Cpos = ((<span class="Type">double</span>) (ext.end - ext.begin + <span class="Constant">1</span>)) / InvSum;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * if doc are big enough then ext.q may be <a href="../../nodes/equalfuncs.c.html#L223" title="nodes/equalfuncs.c:223">equal</a> to ext.p due to limit<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * of positional information. In this case we approximate number of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * noise <a href="../../regex/regcomp.c.html#L1474" title="regex/regcomp.c:1474">word</a> as half cover's length<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; nNoise = (ext.q - ext.p) - (ext.end - ext.begin);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (nNoise &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nNoise = (ext.end - ext.begin) / <span class="Constant">2</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc += Cpos / ((<span class="Type">double</span>) (<span class="Constant">1</span> + nNoise));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CurExtPos = ((<span class="Type">double</span>) (ext.q + ext.p)) / <span class="Constant">2.0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (NExtent &gt; <span class="Constant">0</span> &amp;&amp; CurExtPos &gt; PrevExtPos&nbsp; &nbsp; <span class="Comment">/* prevent division by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * zero in a case of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * multiple lexize */</span> )<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SumDist += <span class="Constant">1.0</span> / (CurExtPos - PrevExtPos);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; PrevExtPos = CurExtPos;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; NExtent++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L29" title="utils/adt/tsrank.c:29">RANK_NORM_LOGLENGTH</a>) &amp;&amp; txt-&gt;size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc /= log((<span class="Type">double</span>) (<a href="#L53" title="utils/adt/tsrank.c:53">cnt_length</a>(txt) + <span class="Constant">1</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (method &amp; <a href="#L30" title="utils/adt/tsrank.c:30">RANK_NORM_LENGTH</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; len = <a href="#L53" title="utils/adt/tsrank.c:53">cnt_length</a>(txt);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (len &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Wdoc /= (<span class="Type">double</span>) len;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L31" title="utils/adt/tsrank.c:31">RANK_NORM_EXTDIST</a>) &amp;&amp; NExtent &gt; <span class="Constant">0</span> &amp;&amp; SumDist &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc /= ((<span class="Type">double</span>) NExtent) / SumDist;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L32" title="utils/adt/tsrank.c:32">RANK_NORM_UNIQ</a>) &amp;&amp; txt-&gt;size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc /= (<span class="Type">double</span>) (txt-&gt;size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> ((method &amp; <a href="#L33" title="utils/adt/tsrank.c:33">RANK_NORM_LOGUNIQ</a>) &amp;&amp; txt-&gt;size &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc /= log((<span class="Type">double</span>) (txt-&gt;size + <span class="Constant">1</span>)) / log(<span class="Constant">2.0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (method &amp; <a href="#L34" title="utils/adt/tsrank.c:34">RANK_NORM_RDIVRPLUS1</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Wdoc /= (Wdoc + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(doc);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(qr.operandData);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (float4) Wdoc;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L953">&#x200c;</a><span class="linkable">ts_rankcd_wttf</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *win = (ArrayType *) PG_DETOAST_DATUM(PG_GETARG_DATUM(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method = PG_GETARG_INT32(<span class="Constant">3</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L850" title="utils/adt/tsrank.c:850">calc_rank_cd</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(win), txt, query, method);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(win, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L970">&#x200c;</a><span class="linkable">ts_rankcd_wtt</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *win = (ArrayType *) PG_DETOAST_DATUM(PG_GETARG_DATUM(<span class="Constant">0</span>));<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L850" title="utils/adt/tsrank.c:850">calc_rank_cd</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(win), txt, query, <a href="#L35" title="utils/adt/tsrank.c:35">DEF_NORM_METHOD</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(win, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L986">&#x200c;</a><span class="linkable">ts_rankcd_ttf</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; method = PG_GETARG_INT32(<span class="Constant">2</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L850" title="utils/adt/tsrank.c:850">calc_rank_cd</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(<span class="Constant">NULL</span>), txt, query, method);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li>Datum<br/></li>
<li><a id="L1001">&#x200c;</a><span class="linkable">ts_rankcd_tt</span>(PG_FUNCTION_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; TSVector&nbsp; &nbsp; txt = PG_GETARG_TSVECTOR(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; TSQuery&nbsp; &nbsp; &nbsp; &nbsp; query = PG_GETARG_TSQUERY(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Type">float</span>&nbsp; &nbsp; &nbsp; &nbsp; res;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; res = <a href="#L850" title="utils/adt/tsrank.c:850">calc_rank_cd</a>(<a href="#L400" title="utils/adt/tsrank.c:400">getWeights</a>(<span class="Constant">NULL</span>), txt, query, <a href="#L35" title="utils/adt/tsrank.c:35">DEF_NORM_METHOD</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(txt, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; PG_FREE_IF_COPY(query, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; PG_RETURN_FLOAT4(res);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
