<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/resowner/resowner.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/resowner/resowner.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L168">AuxProcessResourceOwner</a></li>
<li><a href="#L166">CurTransactionResourceOwner</a></li>
<li><a href="#L165">CurrentResourceOwner</a></li>
<li><a href="#L187">ResourceRelease_callbacks</a></li>
<li><a href="#L167">TopTransactionResourceOwner</a></li>
<li><a href="#L173">narray_lookups</a></li>
<li><a href="#L174">nhash_lookups</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L62">ResourceElem</a></li>
<li><a href="#L66">ResourceElem</a></li>
<li><a href="#L110">ResourceOwnerData</a></li>
<li><a href="#L158">ResourceOwnerData</a></li>
<li><a href="#L180">ResourceReleaseCallbackItem</a></li>
<li><a href="#L185">ResourceReleaseCallbackItem</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L982">CreateAuxProcessResourceOwner</a></li>
<li><a href="#L944">RegisterResourceReleaseCallback</a></li>
<li><a href="#L1002">ReleaseAuxProcessResources</a></li>
<li><a href="#L1027">ReleaseAuxProcessResourcesCallback</a></li>
<li><a href="#L237">ResourceOwnerAddToHash</a></li>
<li><a href="#L413">ResourceOwnerCreate</a></li>
<li><a href="#L854">ResourceOwnerDelete</a></li>
<li><a href="#L442">ResourceOwnerEnlarge</a></li>
<li><a href="#L554">ResourceOwnerForget</a></li>
<li><a href="#L1065">ResourceOwnerForgetLock</a></li>
<li><a href="#L888">ResourceOwnerGetParent</a></li>
<li><a href="#L897">ResourceOwnerNewParent</a></li>
<li><a href="#L648">ResourceOwnerRelease</a></li>
<li><a href="#L340">ResourceOwnerReleaseAll</a></li>
<li><a href="#L801">ResourceOwnerReleaseAllOfKind</a></li>
<li><a href="#L668">ResourceOwnerReleaseInternal</a></li>
<li><a href="#L514">ResourceOwnerRemember</a></li>
<li><a href="#L1045">ResourceOwnerRememberLock</a></li>
<li><a href="#L284">ResourceOwnerSort</a></li>
<li><a href="#L958">UnregisterResourceReleaseCallback</a></li>
<li><a href="#L214">hash_resource_elem</a></li>
<li><a href="#L261">resource_priority_cmp</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L105">MAX_RESOWNER_LOCKS</a></li>
<li><a href="#L71">RESOWNER_ARRAY_SIZE</a></li>
<li><a href="#L77">RESOWNER_HASH_INIT_SIZE</a></li>
<li><a href="#L89">RESOWNER_HASH_MAX_ITEMS</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * resowner.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; POSTGRES resource owner management code.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Query-lifespan resources are tracked by associating them with<br/></li>
<li></span><span class="Comment"> * ResourceOwner objects.&nbsp; This provides a simple mechanism for ensuring<br/></li>
<li></span><span class="Comment"> * that such resources are freed at the right time.<br/></li>
<li></span><span class="Comment"> * See utils/resowner/README for more info on how to use it.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The implementation consists of a small fixed-size array and a <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table.<br/></li>
<li></span><span class="Comment"> * New entries are inserted to the fixed-size array, and when the array<br/></li>
<li></span><span class="Comment"> * fills up, all the entries are moved to the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table.&nbsp; This way, the<br/></li>
<li></span><span class="Comment"> * array always contains a few most recently remembered references.&nbsp; To <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a><br/></li>
<li></span><span class="Comment"> * a particular reference, you need to search both the array and the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a><br/></li>
<li></span><span class="Comment"> * table.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The most frequent usage is that a resource is remembered, and forgotten<br/></li>
<li></span><span class="Comment"> * shortly thereafter.&nbsp; For example, pin a buffer, read one tuple from it,<br/></li>
<li></span><span class="Comment"> * release the pin.&nbsp; Linearly scanning the small array handles that case<br/></li>
<li></span><span class="Comment"> * efficiently.&nbsp; However, some resources are held for a longer time, and<br/></li>
<li></span><span class="Comment"> * sometimes a lot of resources need to be held simultaneously.&nbsp; The <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a><br/></li>
<li></span><span class="Comment"> * table handles those cases.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * When it's time to release the resources, we sort them according to the<br/></li>
<li></span><span class="Comment"> * release-priority of each resource, and release them in that order.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Local lock references are special, they are not stored in the array or<br/></li>
<li></span><span class="Comment"> * the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table.&nbsp; Instead, each resource owner has a separate small cache<br/></li>
<li></span><span class="Comment"> * of locks it owns.&nbsp; The lock manager has the same information in its local<br/></li>
<li></span><span class="Comment"> * lock <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table, and we fall back on that if the cache overflows, but<br/></li>
<li></span><span class="Comment"> * traversing the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table is slower when there are a lot of locks<br/></li>
<li></span><span class="Comment"> * belonging to other resource owners.&nbsp; This is to speed up bulk releasing<br/></li>
<li></span><span class="Comment"> * or reassigning locks from a resource owner to its parent.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/resowner/resowner.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;common/hashfn.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;common/int.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/ipc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/predicate.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/proc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/resowner.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> represents a reference associated with a resource owner.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * All objects managed by this code are required to fit into a Datum,<br/></li>
<li></span><span class="Comment"> * which is fine since they are generally pointers or integers.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L62">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">ResourceElem</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; item;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> ResourceOwnerDesc *kind;&nbsp; &nbsp; <span class="Comment">/* NULL indicates a free <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table slot */<br/></li>
<li><a id="L66">&#x200c;</a></span>} <span class="linkable">ResourceElem</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Size of the fixed-size array to hold most-recently remembered resources.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L71">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RESOWNER_ARRAY_SIZE</span> </span><span class="Constant">32<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initially allocated size of a ResourceOwner's <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table.&nbsp; Must be power of<br/></li>
<li></span><span class="Comment"> * two because we use (capacity - 1) as mask for hashing.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L77">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RESOWNER_HASH_INIT_SIZE</span> </span><span class="Constant">64<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * How many items may be stored in a <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table of given capacity.&nbsp; When this<br/></li>
<li></span><span class="Comment"> * number is reached, we must <a href="../../lib/dshash.c.html#L858" title="lib/dshash.c:858">resize</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table must always have enough free space that we can copy the<br/></li>
<li></span><span class="Comment"> * entries from the array to it, in <a href="#L284" title="utils/resowner/resowner.c:284">ResourceOwnerSort</a>.&nbsp; We also insist that<br/></li>
<li></span><span class="Comment"> * the initial size is large enough that we don't hit the max size immediately<br/></li>
<li></span><span class="Comment"> * when it's created.&nbsp; Aside from those limitations, 0.75 is a reasonable fill<br/></li>
<li></span><span class="Comment"> * factor.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L89">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">RESOWNER_HASH_MAX_ITEMS</span>(capacity) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; <a href="../../jit/llvm/llvmjit_inline.cpp.html#L46" title="jit/llvm/llvmjit_inline.cpp:46">Min</a>(capacity - <a href="#L71" title="utils/resowner/resowner.c:71">RESOWNER_ARRAY_SIZE</a>, (capacity)/</span><span class="Constant">4</span><span class="PreProc"> * </span><span class="Constant">3</span><span class="PreProc">)<br/></li>
<li></span><br/></li>
<li>StaticAssertDecl(<a href="#L89" title="utils/resowner/resowner.c:89">RESOWNER_HASH_MAX_ITEMS</a>(<a href="#L77" title="utils/resowner/resowner.c:77">RESOWNER_HASH_INIT_SIZE</a>) &gt;= <a href="#L71" title="utils/resowner/resowner.c:71">RESOWNER_ARRAY_SIZE</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;initial <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> size too small compared to array size&quot;</span>);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a> is the size of the per-resource owner locks cache. It's<br/></li>
<li></span><span class="Comment"> * chosen based on some testing with pg_dump with a large schema. When the<br/></li>
<li></span><span class="Comment"> * tests were done (on 9.2), resource owners in a pg_dump run contained up<br/></li>
<li></span><span class="Comment"> * to 9 locks, regardless of the schema size, except for the top resource<br/></li>
<li></span><span class="Comment"> * owner which contained much more (overflowing the cache). 15 seems like a<br/></li>
<li></span><span class="Comment"> * nice round number that's somewhat higher than what pg_dump needs. Note that<br/></li>
<li></span><span class="Comment"> * making this number larger is not free - the bigger the cache, the slower<br/></li>
<li></span><span class="Comment"> * it is to release locks (in retail), when a resource owner holds many locks.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L105">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">MAX_RESOWNER_LOCKS</span> </span><span class="Constant">15<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * ResourceOwner objects look like this<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L110">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">ResourceOwnerData</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ResourceOwner parent;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* NULL if no parent (toplevel owner) */<br/></li>
<li></span>&nbsp; &nbsp; ResourceOwner firstchild;&nbsp; &nbsp; <span class="Comment">/* head of linked list of children */<br/></li>
<li></span>&nbsp; &nbsp; ResourceOwner nextchild;&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> child of same parent */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* name (just for debugging) */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * When <a href="#L648" title="utils/resowner/resowner.c:648">ResourceOwnerRelease</a> is called, we sort the '<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>' and 'arr' by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the release priority.&nbsp; After that, no new resources can be remembered<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * or forgotten in retail.&nbsp; We have separate flags because<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L801" title="utils/resowner/resowner.c:801">ResourceOwnerReleaseAllOfKind</a>() temporarily sets 'releasing' without<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * sorting the arrays.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; releasing;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; sorted;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* are '<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>' and 'arr' sorted by priority? */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Number of items in the locks cache, array, and <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table respectively.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (These are packed together to avoid padding in the struct.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; nlocks;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* number of owned locks */<br/></li>
<li></span>&nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; narr;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* how many items are stored in the array */<br/></li>
<li></span>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; nhash;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* how many items are stored in the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The fixed-size array for recent resources.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If 'sorted' is set, the contents are sorted by release priority.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> arr[<a href="#L71" title="utils/resowner/resowner.c:71">RESOWNER_ARRAY_SIZE</a>];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table.&nbsp; Uses open-addressing.&nbsp; 'nhash' is the number of items<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * present; if it would exceed 'grow_at', we enlarge it and re-<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 'grow_at' should be rather less than 'capacity' so that we don't waste<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * too much time searching for empty slots.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If 'sorted' is set, the contents are no longer hashed, but sorted by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * release priority.&nbsp; The first 'nhash' elements are occupied, the rest<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * are empty.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>;<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; capacity;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* allocated length of <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[] */<br/></li>
<li></span>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; grow_at;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* grow <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> when reach this */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* The local locks cache. */<br/></li>
<li></span>&nbsp; &nbsp; LOCALLOCK&nbsp; *locks[<a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a>];&nbsp; &nbsp; <span class="Comment">/* list of owned locks */<br/></li>
<li><a id="L158">&#x200c;</a></span>} <span class="linkable">ResourceOwnerData</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; GLOBAL MEMORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><a id="L165">&#x200c;</a>ResourceOwner <span class="linkable">CurrentResourceOwner</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L166">&#x200c;</a>ResourceOwner <span class="linkable">CurTransactionResourceOwner</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L167">&#x200c;</a>ResourceOwner <span class="linkable">TopTransactionResourceOwner</span> = <span class="Constant">NULL</span>;<br/></li>
<li><a id="L168">&#x200c;</a>ResourceOwner <span class="linkable">AuxProcessResourceOwner</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/* #define RESOWNER_STATS */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef RESOWNER_STATS<br/></li>
<li><a id="L173">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">narray_lookups</span> = <span class="Constant">0</span>;<br/></li>
<li><a id="L174">&#x200c;</a><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">nhash_lookups</span> = <span class="Constant">0</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * List of add-on callbacks for resource releasing<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L180">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">struct</span> <span class="linkable">ResourceReleaseCallbackItem</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; ResourceReleaseCallback callback;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *arg;<br/></li>
<li><a id="L185">&#x200c;</a>} <span class="linkable">ResourceReleaseCallbackItem</span>;<br/></li>
<li><br/></li>
<li><a id="L187">&#x200c;</a><span class="Type">static</span> <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *<span class="linkable">ResourceRelease_callbacks</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/* Internal routines */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">inline</span> uint32 <a href="#L214" title="utils/resowner/resowner.c:214">hash_resource_elem</a>(Datum value, <span class="Type">const</span> ResourceOwnerDesc *kind);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L237" title="utils/resowner/resowner.c:237">ResourceOwnerAddToHash</a>(ResourceOwner owner, Datum value,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">const</span> ResourceOwnerDesc *kind);<br/></li>
<li><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <a href="#L261" title="utils/resowner/resowner.c:261">resource_priority_cmp</a>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L284" title="utils/resowner/resowner.c:284">ResourceOwnerSort</a>(ResourceOwner owner);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L340" title="utils/resowner/resowner.c:340">ResourceOwnerReleaseAll</a>(ResourceOwner owner,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResourceReleasePhase phase,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> printLeakWarnings);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L668" title="utils/resowner/resowner.c:668">ResourceOwnerReleaseInternal</a>(ResourceOwner owner,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ResourceReleasePhase phase,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isCommit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isTopLevel);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L1027" title="utils/resowner/resowner.c:1027">ReleaseAuxProcessResourcesCallback</a>(<span class="Type">int</span> code, Datum arg);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; INTERNAL ROUTINES&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Hash function for value+kind combination.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">inline</span> uint32<br/></li>
<li><a id="L214">&#x200c;</a><span class="linkable">hash_resource_elem</span>(Datum value, <span class="Type">const</span> ResourceOwnerDesc *kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Most resource kinds store a pointer in 'value', and pointers are unique<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * all on their own.&nbsp; But some resources store plain integers (Files and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Buffers as of this writing), so we want to incorporate the 'kind' in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> too, otherwise those resources will collide a lot.&nbsp; But<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * because there are only a few resource kinds like that - and only a few<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * resource kinds to begin with - we don't need to work too hard to mix<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * 'kind' into the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>.&nbsp; Just add it with hash_combine(), it perturbs the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * result enough for our purposes.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="PreProc">#if SIZEOF_DATUM == </span><span class="Constant">8<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> hash_combine64(murmurhash64((uint64) value), (uint64) kind);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> hash_combine(murmurhash32((uint32) value), (uint32) kind);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Adds 'value' of given 'kind' to the ResourceOwner's <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L237">&#x200c;</a></span><span class="linkable">ResourceOwnerAddToHash</span>(ResourceOwner owner, Datum value, <span class="Type">const</span> ResourceOwnerDesc *kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; mask = owner-&gt;capacity - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; idx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(kind != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../../storage/file/fd.c.html#L1313" title="storage/file/fd.c:1313">Insert</a> into first free slot at or after <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> location. */<br/></li>
<li></span>&nbsp; &nbsp; idx = <a href="#L214" title="utils/resowner/resowner.c:214">hash_resource_elem</a>(value, kind) &amp; mask;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].kind == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* found a free slot */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; idx = (idx + <span class="Constant">1</span>) &amp; mask;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].item = value;<br/></li>
<li>&nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].kind = kind;<br/></li>
<li>&nbsp; &nbsp; owner-&gt;nhash++;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Comparison function to sort by release phase and priority<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">int<br/></li>
<li><a id="L261">&#x200c;</a></span><span class="linkable">resource_priority_cmp</span>(<span class="Type">const</span> <span class="Type">void</span> *a, <span class="Type">const</span> <span class="Type">void</span> *b)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *ra = (<span class="Type">const</span> <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *) a;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *rb = (<span class="Type">const</span> <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *) b;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Note: reverse order */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (ra-&gt;kind-&gt;release_phase == rb-&gt;kind-&gt;release_phase)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> pg_cmp_u32(rb-&gt;kind-&gt;release_priority, ra-&gt;kind-&gt;release_priority);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (ra-&gt;kind-&gt;release_phase &gt; rb-&gt;kind-&gt;release_phase)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">1</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Sort resources in reverse release priority.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * If the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table is in use, all the elements from the fixed-size array are<br/></li>
<li></span><span class="Comment"> * moved to the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table, and then the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table is sorted.&nbsp; If there is no<br/></li>
<li></span><span class="Comment"> * <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table, then the fixed-size array is sorted directly.&nbsp; In either case,<br/></li>
<li></span><span class="Comment"> * the result is one sorted array that contains all the resources.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L284">&#x200c;</a></span><span class="linkable">ResourceOwnerSort</span>(ResourceOwner owner)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *items;<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; nitems;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nhash == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; items = owner-&gt;arr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nitems = owner-&gt;narr;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Compact the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table, so that all the elements are in the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * beginning of the '<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>' array, with no empty elements.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; dst = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> idx = <span class="Constant">0</span>; idx &lt; owner-&gt;capacity; idx++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].kind != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (dst != idx)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[dst] = owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Move all entries from the fixed-size array to '<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>'.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * <a href="#L89" title="utils/resowner/resowner.c:89">RESOWNER_HASH_MAX_ITEMS</a> is defined so that there is always enough<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * free space to move all the elements from the fixed-size array to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; Assert(dst + owner-&gt;narr &lt;= owner-&gt;capacity);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> idx = <span class="Constant">0</span>; idx &lt; owner-&gt;narr; idx++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[dst] = owner-&gt;arr[idx];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dst++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(dst == owner-&gt;nhash + owner-&gt;narr);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;narr = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nhash = dst;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; items = owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nitems = owner-&gt;nhash;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; qsort(items, nitems, <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a>), <a href="#L261" title="utils/resowner/resowner.c:261">resource_priority_cmp</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Call the ReleaseResource callback on entries with given 'phase'.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L340">&#x200c;</a></span><span class="linkable">ResourceOwnerReleaseAll</span>(ResourceOwner owner, ResourceReleasePhase phase,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> printLeakWarnings)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *items;<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; nitems;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="#L284" title="utils/resowner/resowner.c:284">ResourceOwnerSort</a> must've been called already.&nbsp; All the resources are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * either in the array or the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; Assert(owner-&gt;releasing);<br/></li>
<li>&nbsp; &nbsp; Assert(owner-&gt;sorted);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nhash == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; items = owner-&gt;arr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nitems = owner-&gt;narr;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(owner-&gt;narr == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; items = owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nitems = owner-&gt;nhash;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The resources are sorted in reverse priority order.&nbsp; Release them<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * starting from the end, until we hit the end of the phase that we are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * releasing <a href="../adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a>.&nbsp; We will continue from there when called again for the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> phase.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (nitems &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; idx = nitems - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; value = items[idx].item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> ResourceOwnerDesc *kind = items[idx].kind;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (kind-&gt;release_phase &gt; phase)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(kind-&gt;release_phase == phase);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (printLeakWarnings)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *res_str;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res_str = kind-&gt;DebugPrint ?<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind-&gt;DebugPrint(value)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : psprintf(<span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant">&quot;</span>, kind-&gt;name, DatumGetPointer(value));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(WARNING, <span class="Constant">&quot;resource was not closed: </span><span class="Special">%s</span><span class="Constant">&quot;</span>, res_str);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(res_str);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; kind-&gt;ReleaseResource(value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; nitems--;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nhash == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;narr = nitems;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nhash = nitems;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*****************************************************************************<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; EXPORTED ROUTINES&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment"> *****************************************************************************/<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L413" title="utils/resowner/resowner.c:413">ResourceOwnerCreate</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Create an empty ResourceOwner.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * All ResourceOwner objects are kept in <a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>, since they should<br/></li>
<li></span><span class="Comment"> * only be freed explicitly.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>ResourceOwner<br/></li>
<li><a id="L413">&#x200c;</a><span class="linkable">ResourceOwnerCreate</span>(ResourceOwner parent, <span class="Type">const</span> <span class="Type">char</span> *name)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ResourceOwner owner;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; owner = (ResourceOwner) <a href="../mmgr/mcxt.c.html#L1214" title="utils/mmgr/mcxt.c:1214">MemoryContextAllocZero</a>(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L110" title="utils/resowner/resowner.c:110">ResourceOwnerData</a>));<br/></li>
<li>&nbsp; &nbsp; owner-&gt;name = name;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (parent)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;parent = parent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nextchild = parent-&gt;firstchild;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; parent-&gt;firstchild = owner;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> owner;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Make sure there is room for at least one more resource in an array.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is separate from actually inserting a resource because if we run out<br/></li>
<li></span><span class="Comment"> * of memory, it's critical to do so *<a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a>* acquiring the resource.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: Make sure there are no unrelated <a href="#L514" title="utils/resowner/resowner.c:514">ResourceOwnerRemember</a>() calls between<br/></li>
<li></span><span class="Comment"> * your <a href="#L442" title="utils/resowner/resowner.c:442">ResourceOwnerEnlarge</a>() call and the <a href="#L514" title="utils/resowner/resowner.c:514">ResourceOwnerRemember</a>() call that<br/></li>
<li></span><span class="Comment"> * you reserved the space for!<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L442">&#x200c;</a></span><span class="linkable">ResourceOwnerEnlarge</span>(ResourceOwner owner)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Mustn't try to remember more resources after we have already started<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * releasing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;releasing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L442" title="utils/resowner/resowner.c:442">ResourceOwnerEnlarge</a> called after release started&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;narr &lt; <a href="#L71" title="utils/resowner/resowner.c:71">RESOWNER_ARRAY_SIZE</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* no work needed */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Is there space in the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>? If not, enlarge it.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;narr + owner-&gt;nhash &gt;= owner-&gt;grow_at)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; i,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oldcap,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newcap;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *oldhash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *newhash;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldhash = owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; oldcap = owner-&gt;capacity;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Double the capacity (it must stay a power of 2!) */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; newcap = (oldcap &gt; <span class="Constant">0</span>) ? oldcap * <span class="Constant">2</span> : <a href="#L77" title="utils/resowner/resowner.c:77">RESOWNER_HASH_INIT_SIZE</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; newhash = (<a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a> *) <a href="../mmgr/mcxt.c.html#L1214" title="utils/mmgr/mcxt.c:1214">MemoryContextAllocZero</a>(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newcap * <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L62" title="utils/resowner/resowner.c:62">ResourceElem</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We assume we can't fail below this point, so OK to scribble on the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * owner<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> = newhash;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;capacity = newcap;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;grow_at = <a href="#L89" title="utils/resowner/resowner.c:89">RESOWNER_HASH_MAX_ITEMS</a>(newcap);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nhash = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (oldhash != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Transfer <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> pre-existing entries into the new <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table; they<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * don't necessarily go where they were <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a>, so this simple<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * logic is the best way.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; oldcap; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (oldhash[i].kind != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L237" title="utils/resowner/resowner.c:237">ResourceOwnerAddToHash</a>(owner, oldhash[i].item, oldhash[i].kind);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* And release old <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(oldhash);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Move items from the array to the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; owner-&gt;narr; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L237" title="utils/resowner/resowner.c:237">ResourceOwnerAddToHash</a>(owner, owner-&gt;arr[i].item, owner-&gt;arr[i].kind);<br/></li>
<li>&nbsp; &nbsp; owner-&gt;narr = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(owner-&gt;nhash &lt;= owner-&gt;grow_at);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Remember that an object is owned by a ResourceOwner<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Caller must have previously done <a href="#L442" title="utils/resowner/resowner.c:442">ResourceOwnerEnlarge</a>()<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L514">&#x200c;</a></span><span class="linkable">ResourceOwnerRemember</span>(ResourceOwner owner, Datum value, <span class="Type">const</span> ResourceOwnerDesc *kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; idx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* sanity check the ResourceOwnerDesc */<br/></li>
<li></span>&nbsp; &nbsp; Assert(kind-&gt;release_phase != <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(kind-&gt;release_priority != <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Mustn't try to remember more resources after we have already started<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * releasing.&nbsp; We already checked this in <a href="#L442" title="utils/resowner/resowner.c:442">ResourceOwnerEnlarge</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!owner-&gt;releasing);<br/></li>
<li>&nbsp; &nbsp; Assert(!owner-&gt;sorted);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;narr &gt;= <a href="#L71" title="utils/resowner/resowner.c:71">RESOWNER_ARRAY_SIZE</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* forgot to call <a href="#L442" title="utils/resowner/resowner.c:442">ResourceOwnerEnlarge</a>? */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L514" title="utils/resowner/resowner.c:514">ResourceOwnerRemember</a> called but array was full&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Append to the array. */<br/></li>
<li></span>&nbsp; &nbsp; idx = owner-&gt;narr;<br/></li>
<li>&nbsp; &nbsp; owner-&gt;arr[idx].item = value;<br/></li>
<li>&nbsp; &nbsp; owner-&gt;arr[idx].kind = kind;<br/></li>
<li>&nbsp; &nbsp; owner-&gt;narr++;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Forget that an object is owned by a ResourceOwner<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: If same resource ID is associated with the ResourceOwner more than<br/></li>
<li></span><span class="Comment"> * once, one instance is removed.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: Forgetting a resource does not guarantee that there is room to<br/></li>
<li></span><span class="Comment"> * remember a new resource.&nbsp; One exception is when you forget the most<br/></li>
<li></span><span class="Comment"> * recently remembered resource; that does make room for a new remember call.<br/></li>
<li></span><span class="Comment"> * Some code callers rely on that exception.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L554">&#x200c;</a></span><span class="linkable">ResourceOwnerForget</span>(ResourceOwner owner, Datum value, <span class="Type">const</span> ResourceOwnerDesc *kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Mustn't call this after we have already started releasing resources.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (Release callback <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> are not allowed to release additional<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * resources.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;releasing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L554" title="utils/resowner/resowner.c:554">ResourceOwnerForget</a> called for </span><span class="Special">%s</span><span class="Constant"> after release started&quot;</span>, kind-&gt;name);<br/></li>
<li>&nbsp; &nbsp; Assert(!owner-&gt;sorted);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Search through all items in the array first. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = owner-&gt;narr - <span class="Constant">1</span>; i &gt;= <span class="Constant">0</span>; i--)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;arr[i].item == value &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;arr[i].kind == kind)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;arr[i] = owner-&gt;arr[owner-&gt;narr - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;narr--;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef RESOWNER_STATS<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L173" title="utils/resowner/resowner.c:173">narray_lookups</a>++;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Search <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nhash &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; mask = owner-&gt;capacity - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint32&nbsp; &nbsp; &nbsp; &nbsp; idx;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; idx = <a href="#L214" title="utils/resowner/resowner.c:214">hash_resource_elem</a>(value, kind) &amp; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (uint32 i = <span class="Constant">0</span>; i &lt; owner-&gt;capacity; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].item == value &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].kind == kind)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].item = (Datum) <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[idx].kind = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nhash--;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef RESOWNER_STATS<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L174" title="utils/resowner/resowner.c:174">nhash_lookups</a>++;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idx = (idx + <span class="Constant">1</span>) &amp; mask;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Use %p to <a href="../../nodes/print.c.html#L36" title="nodes/print.c:36">print</a> the reference, since most objects tracked by a resource<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * owner are pointers.&nbsp; It's a <a href="../adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> misleading if it's not a pointer, but<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * this is a programmer error, anyway.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant"> </span><span class="Special">%p</span><span class="Constant"> is not owned by resource owner </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; kind-&gt;name, DatumGetPointer(value), owner-&gt;name);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L648" title="utils/resowner/resowner.c:648">ResourceOwnerRelease</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Release all resources owned by a ResourceOwner and its descendants,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; but don't delete the owner objects themselves.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that this executes just one phase of release, and so typically<br/></li>
<li></span><span class="Comment"> * must be called three times.&nbsp; We do it this way because (a) we want to<br/></li>
<li></span><span class="Comment"> * do all the recursion separately for each phase, thereby preserving<br/></li>
<li></span><span class="Comment"> * the needed order of operations; and (b) xact.c may have other operations<br/></li>
<li></span><span class="Comment"> * to do between the phases.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * phase: release phase to execute<br/></li>
<li></span><span class="Comment"> * isCommit: true for successful completion of a query or transaction,<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; false for unsuccessful<br/></li>
<li></span><span class="Comment"> * isTopLevel: true if completing a <a href="../../storage/lmgr/s_lock.c.html#L257" title="storage/lmgr/s_lock.c:257">main</a> transaction, else false<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * isCommit is passed because some modules may expect that their resources<br/></li>
<li></span><span class="Comment"> * were all released already if the transaction or portal finished normally.<br/></li>
<li></span><span class="Comment"> * If so it is reasonable to give a warning (NOT an error) should <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a><br/></li>
<li></span><span class="Comment"> * unreleased resources be present.&nbsp; When isCommit is false, such warnings<br/></li>
<li></span><span class="Comment"> * are generally inappropriate.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * isTopLevel is passed when we are releasing <a href="#L167" title="utils/resowner/resowner.c:167">TopTransactionResourceOwner</a><br/></li>
<li></span><span class="Comment"> * at completion of a <a href="../../storage/lmgr/s_lock.c.html#L257" title="storage/lmgr/s_lock.c:257">main</a> transaction.&nbsp; This generally means that *all*<br/></li>
<li></span><span class="Comment"> * resources will be released, and so we can <a href="../../regex/regc_nfa.c.html#L1593" title="regex/regc_nfa.c:1593">optimize</a> things a <a href="../adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a>.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * <a href="../../regex/regcomp.c.html#L324" title="regex/regcomp.c:324">NOTE</a>: After starting the release process, by calling this function, no new<br/></li>
<li></span><span class="Comment"> * resources can be remembered in the resource owner.&nbsp; You also cannot call<br/></li>
<li></span><span class="Comment"> * <a href="#L554" title="utils/resowner/resowner.c:554">ResourceOwnerForget</a> on <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> previously remembered resources to release<br/></li>
<li></span><span class="Comment"> * resources &quot;in retail&quot; after that, you must let the bulk release take care<br/></li>
<li></span><span class="Comment"> * of them.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L648">&#x200c;</a></span><span class="linkable">ResourceOwnerRelease</span>(ResourceOwner owner,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ResourceReleasePhase phase,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isCommit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isTopLevel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* There's not currently <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> setup needed <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> recursing */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L668" title="utils/resowner/resowner.c:668">ResourceOwnerReleaseInternal</a>(owner, phase, isCommit, isTopLevel);<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef RESOWNER_STATS<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (isTopLevel)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(LOG, <span class="Constant">&quot;RESOWNER STATS: lookups: array </span><span class="Special">%d</span><span class="Constant">, <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L173" title="utils/resowner/resowner.c:173">narray_lookups</a>, <a href="#L174" title="utils/resowner/resowner.c:174">nhash_lookups</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L173" title="utils/resowner/resowner.c:173">narray_lookups</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L174" title="utils/resowner/resowner.c:174">nhash_lookups</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L668">&#x200c;</a></span><span class="linkable">ResourceOwnerReleaseInternal</span>(ResourceOwner owner,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ResourceReleasePhase phase,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isCommit,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isTopLevel)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ResourceOwner child;<br/></li>
<li>&nbsp; &nbsp; ResourceOwner save;<br/></li>
<li>&nbsp; &nbsp; <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *item;<br/></li>
<li>&nbsp; &nbsp; <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Recurse to handle descendants */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (child = owner-&gt;firstchild; child != <span class="Constant">NULL</span>; child = child-&gt;nextchild)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L668" title="utils/resowner/resowner.c:668">ResourceOwnerReleaseInternal</a>(child, phase, isCommit, isTopLevel);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * To release the resources in the right order, sort them by phase and<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * priority.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The ReleaseResource callback <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> are not allowed to remember or<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * forget <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> other resources after this. Otherwise we lose track of where<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we are in processing the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>/array.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!owner-&gt;releasing)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(phase == RESOURCE_RELEASE_BEFORE_LOCKS);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!owner-&gt;sorted);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;releasing = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Phase is normally &gt; RESOURCE_RELEASE_BEFORE_LOCKS, if this is not<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the first call to <a href="#L648" title="utils/resowner/resowner.c:648">ResourceOwnerRelease</a>. But if an error happens<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * between the release phases, we might get called again for the same<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * ResourceOwner from <a href="../../access/transam/xact.c.html#L2749" title="access/transam/xact.c:2749">AbortTransaction</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!owner-&gt;sorted)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L284" title="utils/resowner/resowner.c:284">ResourceOwnerSort</a>(owner);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;sorted = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Make <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> point to me, so that the release callback<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> know which resource owner is been released.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; save = <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> = owner;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (phase == RESOURCE_RELEASE_BEFORE_LOCKS)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Release all resources that need to be released <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the locks.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * During a commit, there shouldn't be <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> remaining resources ---<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * that would indicate failure to clean up the executor correctly ---<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * so issue warnings.&nbsp; In the abort case, just clean up quietly.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L340" title="utils/resowner/resowner.c:340">ResourceOwnerReleaseAll</a>(owner, phase, isCommit);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (phase == RESOURCE_RELEASE_LOCKS)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isTopLevel)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * For a top-level xact we are going to release all locks (or at<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * least all non-session locks), so just do a single lmgr call at<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the top of the recursion.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner == <a href="#L167" title="utils/resowner/resowner.c:167">TopTransactionResourceOwner</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/proc.c.html#L806" title="storage/lmgr/proc.c:806">ProcReleaseLocks</a>(isCommit);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/predicate.c.html#L3297" title="storage/lmgr/predicate.c:3297">ReleasePredicateLocks</a>(isCommit, <span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Release locks retail.&nbsp; Note that if we are committing a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * subtransaction, we do NOT release its locks yet, but transfer<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * them to the parent.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LOCALLOCK **locks;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nlocks;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert(owner-&gt;parent != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Pass the list of locks owned by this resource owner to the lock<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * manager, unless it has overflowed.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nlocks &gt; <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locks = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nlocks = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; locks = owner-&gt;locks;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nlocks = owner-&gt;nlocks;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (isCommit)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lock.c.html#L2537" title="storage/lmgr/lock.c:2537">LockReassignCurrentOwner</a>(locks, nlocks);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/lmgr/lock.c.html#L2442" title="storage/lmgr/lock.c:2442">LockReleaseCurrentOwner</a>(locks, nlocks);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (phase == RESOURCE_RELEASE_AFTER_LOCKS)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Release all resources that need to be released after the locks.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L340" title="utils/resowner/resowner.c:340">ResourceOwnerReleaseAll</a>(owner, phase, isCommit);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Let add-on modules get a chance too */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (item = <a href="#L187" title="utils/resowner/resowner.c:187">ResourceRelease_callbacks</a>; item; item = <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* allow callbacks to unregister themselves when called */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = item-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; item-&gt;callback(phase, isCommit, isTopLevel, item-&gt;arg);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> = save;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L801" title="utils/resowner/resowner.c:801">ResourceOwnerReleaseAllOfKind</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Release all resources of a certain type held by this owner.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L801">&#x200c;</a></span><span class="linkable">ResourceOwnerReleaseAllOfKind</span>(ResourceOwner owner, <span class="Type">const</span> ResourceOwnerDesc *kind)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Mustn't call this after we have already started releasing resources. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;releasing)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;<a href="#L554" title="utils/resowner/resowner.c:554">ResourceOwnerForget</a> called for </span><span class="Special">%s</span><span class="Constant"> after release started&quot;</span>, kind-&gt;name);<br/></li>
<li>&nbsp; &nbsp; Assert(!owner-&gt;sorted);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Temporarily set 'releasing', to prevent calls to <a href="#L514" title="utils/resowner/resowner.c:514">ResourceOwnerRemember</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * while we're scanning the owner.&nbsp; Enlarging the <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> would cause us to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * lose track of the point we're scanning.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; owner-&gt;releasing = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Array first */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; owner-&gt;narr; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;arr[i].kind == kind)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; value = owner-&gt;arr[i].item;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;arr[i] = owner-&gt;arr[owner-&gt;narr - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;narr--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind-&gt;ReleaseResource(value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Then <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> i = <span class="Constant">0</span>; i &lt; owner-&gt;capacity; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[i].kind == kind)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; value = owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[i].item;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[i].item = (Datum) <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>[i].kind = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nhash--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kind-&gt;ReleaseResource(value);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; owner-&gt;releasing = <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L854" title="utils/resowner/resowner.c:854">ResourceOwnerDelete</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; <a href="../../storage/file/fd.c.html#L1268" title="storage/file/fd.c:1268">Delete</a> an owner object and its descendants.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The caller must have already released all resources in the object tree.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L854">&#x200c;</a></span><span class="linkable">ResourceOwnerDelete</span>(ResourceOwner owner)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We had better not be deleting <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> ... */<br/></li>
<li></span>&nbsp; &nbsp; Assert(owner != <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* And it better not own <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> resources, either */<br/></li>
<li></span>&nbsp; &nbsp; Assert(owner-&gt;narr == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(owner-&gt;nhash == <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(owner-&gt;nlocks == <span class="Constant">0</span> || owner-&gt;nlocks == <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a> + <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../../storage/file/fd.c.html#L1268" title="storage/file/fd.c:1268">Delete</a> children.&nbsp; The recursive call will delink the child from me, so<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * just iterate as long as there is a child.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (owner-&gt;firstchild != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L854" title="utils/resowner/resowner.c:854">ResourceOwnerDelete</a>(owner-&gt;firstchild);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We delink the owner from its parent <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> deleting it, so that if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * there's an error we won't have deleted/busted owners still attached to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the owner tree.&nbsp; Better a leak than a crash.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L897" title="utils/resowner/resowner.c:897">ResourceOwnerNewParent</a>(owner, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* And free the object. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(owner-&gt;<a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(owner);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Fetch parent of a ResourceOwner (returns NULL if top-level owner)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>ResourceOwner<br/></li>
<li><a id="L888">&#x200c;</a><span class="linkable">ResourceOwnerGetParent</span>(ResourceOwner owner)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> owner-&gt;parent;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Reassign a ResourceOwner to have a new parent<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L897">&#x200c;</a></span><span class="linkable">ResourceOwnerNewParent</span>(ResourceOwner owner,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ResourceOwner newparent)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ResourceOwner oldparent = owner-&gt;parent;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (oldparent)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner == oldparent-&gt;firstchild)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oldparent-&gt;firstchild = owner-&gt;nextchild;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResourceOwner child;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (child = oldparent-&gt;firstchild; child; child = child-&gt;nextchild)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (owner == child-&gt;nextchild)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; child-&gt;nextchild = owner-&gt;nextchild;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (newparent)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(owner != newparent);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;parent = newparent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nextchild = newparent-&gt;firstchild;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; newparent-&gt;firstchild = owner;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;parent = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nextchild = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Register or deregister callback <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> for resource <a href="../../regex/regc_nfa.c.html#L2929" title="regex/regc_nfa.c:2929">cleanup</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * These <a href="../../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a> can be used by dynamically loaded modules.&nbsp; These used<br/></li>
<li></span><span class="Comment"> * to be the only way for an extension to register custom resource types<br/></li>
<li></span><span class="Comment"> * with a resource owner, but nowadays it is easier to define a new<br/></li>
<li></span><span class="Comment"> * ResourceOwnerDesc with custom callbacks.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L944">&#x200c;</a></span><span class="linkable">RegisterResourceReleaseCallback</span>(ResourceReleaseCallback callback, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *item;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; item = (<a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="../mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a>));<br/></li>
<li>&nbsp; &nbsp; item-&gt;callback = callback;<br/></li>
<li>&nbsp; &nbsp; item-&gt;arg = arg;<br/></li>
<li>&nbsp; &nbsp; item-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = <a href="#L187" title="utils/resowner/resowner.c:187">ResourceRelease_callbacks</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L187" title="utils/resowner/resowner.c:187">ResourceRelease_callbacks</a> = item;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Type">void<br/></li>
<li><a id="L958">&#x200c;</a></span><span class="linkable">UnregisterResourceReleaseCallback</span>(ResourceReleaseCallback callback, <span class="Type">void</span> *arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *item;<br/></li>
<li>&nbsp; &nbsp; <a href="#L180" title="utils/resowner/resowner.c:180">ResourceReleaseCallbackItem</a> *prev;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; prev = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (item = <a href="#L187" title="utils/resowner/resowner.c:187">ResourceRelease_callbacks</a>; item; prev = item, item = item-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (item-&gt;callback == callback &amp;&amp; item-&gt;arg == arg)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (prev)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prev-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> = item-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L187" title="utils/resowner/resowner.c:187">ResourceRelease_callbacks</a> = item-&gt;<a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(item);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Establish an <a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a> for the current process.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L982">&#x200c;</a></span><span class="linkable">CreateAuxProcessResourceOwner</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a> == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> == <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a> = <a href="#L413" title="utils/resowner/resowner.c:413">ResourceOwnerCreate</a>(<span class="Constant">NULL</span>, <span class="Constant">&quot;AuxiliaryProcess&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L165" title="utils/resowner/resowner.c:165">CurrentResourceOwner</a> = <a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Register a shmem-exit callback for <a href="../../regex/regc_nfa.c.html#L2929" title="regex/regc_nfa.c:2929">cleanup</a> of aux-process resource<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * owner.&nbsp; (This needs to run after, e.g., <a href="../../access/transam/xlog.c.html#L6539" title="access/transam/xlog.c:6539">ShutdownXLOG</a>.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../storage/ipc/ipc.c.html#L365" title="storage/ipc/ipc.c:365">on_shmem_exit</a>(<a href="#L1027" title="utils/resowner/resowner.c:1027">ReleaseAuxProcessResourcesCallback</a>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Convenience routine to release all resources tracked in<br/></li>
<li></span><span class="Comment"> * <a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a> (but that resowner is not destroyed here).<br/></li>
<li></span><span class="Comment"> * Warn about leaked resources if isCommit is true.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L1002">&#x200c;</a></span><span class="linkable">ReleaseAuxProcessResources</span>(<span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> isCommit)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * At this writing, the only thing that could actually get released is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * buffer pins; but we may as well do the full release protocol.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L648" title="utils/resowner/resowner.c:648">ResourceOwnerRelease</a>(<a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RESOURCE_RELEASE_BEFORE_LOCKS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; isCommit, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L648" title="utils/resowner/resowner.c:648">ResourceOwnerRelease</a>(<a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RESOURCE_RELEASE_LOCKS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; isCommit, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L648" title="utils/resowner/resowner.c:648">ResourceOwnerRelease</a>(<a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RESOURCE_RELEASE_AFTER_LOCKS,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; isCommit, <span class="Constant">true</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* allow it to be reused */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a>-&gt;releasing = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L168" title="utils/resowner/resowner.c:168">AuxProcessResourceOwner</a>-&gt;sorted = <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Shmem-exit callback for the same.<br/></li>
<li></span><span class="Comment"> * Warn about leaked resources if process exit code is zero (ie normal).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L1027">&#x200c;</a></span><span class="linkable">ReleaseAuxProcessResourcesCallback</span>(<span class="Type">int</span> code, Datum arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; isCommit = (code == <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1002" title="utils/resowner/resowner.c:1002">ReleaseAuxProcessResources</a>(isCommit);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Remember that a Local Lock is owned by a ResourceOwner<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is different from the generic <a href="#L514" title="utils/resowner/resowner.c:514">ResourceOwnerRemember</a> in that the list of<br/></li>
<li></span><span class="Comment"> * locks is only a lossy cache.&nbsp; It can hold up to <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a> entries,<br/></li>
<li></span><span class="Comment"> * and when it overflows, we stop tracking locks.&nbsp; The point of only remembering<br/></li>
<li></span><span class="Comment"> * only up to <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a> entries is that if a lot of locks are held,<br/></li>
<li></span><span class="Comment"> * <a href="#L1065" title="utils/resowner/resowner.c:1065">ResourceOwnerForgetLock</a> doesn't need to scan through a large array to <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a><br/></li>
<li></span><span class="Comment"> * the entry.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L1045">&#x200c;</a></span><span class="linkable">ResourceOwnerRememberLock</span>(ResourceOwner owner, LOCALLOCK *locallock)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(locallock != <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nlocks &gt; <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we have already overflowed */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nlocks &lt; <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;locks[owner-&gt;nlocks] = locallock;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* overflowed */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; owner-&gt;nlocks++;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Forget that a Local Lock is owned by a ResourceOwner<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L1065">&#x200c;</a></span><span class="linkable">ResourceOwnerForgetLock</span>(ResourceOwner owner, LOCALLOCK *locallock)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (owner-&gt;nlocks &gt; <a href="#L105" title="utils/resowner/resowner.c:105">MAX_RESOWNER_LOCKS</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* we have overflowed */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; Assert(owner-&gt;nlocks &gt; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = owner-&gt;nlocks - <span class="Constant">1</span>; i &gt;= <span class="Constant">0</span>; i--)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (locallock == owner-&gt;locks[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;locks[i] = owner-&gt;locks[owner-&gt;nlocks - <span class="Constant">1</span>];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; owner-&gt;nlocks--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;lock reference </span><span class="Special">%p</span><span class="Constant"> is not owned by resource owner </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; locallock, owner-&gt;name);<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
