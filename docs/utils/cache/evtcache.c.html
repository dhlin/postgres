<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/cache/evtcache.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>utils/cache/evtcache.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L46">EventTriggerCache</a></li>
<li><a href="#L47">EventTriggerCacheContext</a></li>
<li><a href="#L48">EventTriggerCacheState</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L44">EventTriggerCacheEntry</a></li>
<li><a href="#L38">EventTriggerCacheStateType</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L77">BuildEventTriggerCache</a></li>
<li><a href="#L222">DecodeTextArrayToBitmapset</a></li>
<li><a href="#L63">EventCacheLookup</a></li>
<li><a href="#L255">InvalidateEventCacheCallback</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * evtcache.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Special-purpose cache for event <a href="../adt/pseudotypes.c.html#L366" title="utils/adt/pseudotypes.c:366">trigger</a> data.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/utils/cache/evtcache.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/genam.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/htup_details.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/relation.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_event_trigger.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;catalog/pg_type.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;commands/<a href="../adt/pseudotypes.c.html#L366" title="utils/adt/pseudotypes.c:366">trigger</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;tcop/cmdtag.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/array.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/catcache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/evtcache.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/hsearch.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/inval.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/rel.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/syscache.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">typedef</span> <span class="Type">enum<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; ETCS_NEEDS_REBUILD,<br/></li>
<li>&nbsp; &nbsp; ETCS_REBUILD_STARTED,<br/></li>
<li>&nbsp; &nbsp; ETCS_VALID,<br/></li>
<li><a id="L38">&#x200c;</a>} <span class="linkable">EventTriggerCacheStateType</span>;<br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; EventTriggerEvent event;<br/></li>
<li>&nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *triggerlist;<br/></li>
<li><a id="L44">&#x200c;</a>} <span class="linkable">EventTriggerCacheEntry</span>;<br/></li>
<li><br/></li>
<li><a id="L46">&#x200c;</a><span class="Type">static</span> <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a> *<span class="linkable">EventTriggerCache</span>;<br/></li>
<li><a id="L47">&#x200c;</a><span class="Type">static</span> MemoryContext <span class="linkable">EventTriggerCacheContext</span>;<br/></li>
<li><a id="L48">&#x200c;</a><span class="Type">static</span> <a href="#L38" title="utils/cache/evtcache.c:38">EventTriggerCacheStateType</a> <span class="linkable">EventTriggerCacheState</span> = ETCS_NEEDS_REBUILD;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L77" title="utils/cache/evtcache.c:77">BuildEventTriggerCache</a>(<span class="Type">void</span>);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L255" title="utils/cache/evtcache.c:255">InvalidateEventCacheCallback</a>(Datum arg,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">int</span> cacheid, uint32 hashvalue);<br/></li>
<li><span class="Type">static</span> Bitmapset *<a href="#L222" title="utils/cache/evtcache.c:222">DecodeTextArrayToBitmapset</a>(Datum array);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Search the event cache by <a href="../adt/pseudotypes.c.html#L366" title="utils/adt/pseudotypes.c:366">trigger</a> event.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note that the caller had better copy <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> data it wants to keep around<br/></li>
<li></span><span class="Comment"> * across <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> operation that might touch a system catalog into some other<br/></li>
<li></span><span class="Comment"> * memory context, since a cache reset could blow the return value away.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>List *<br/></li>
<li><a id="L63">&#x200c;</a><span class="linkable">EventCacheLookup</span>(EventTriggerEvent event)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="utils/cache/evtcache.c:44">EventTriggerCacheEntry</a> *entry;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L48" title="utils/cache/evtcache.c:48">EventTriggerCacheState</a> != ETCS_VALID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L77" title="utils/cache/evtcache.c:77">BuildEventTriggerCache</a>();<br/></li>
<li>&nbsp; &nbsp; entry = <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(<a href="#L46" title="utils/cache/evtcache.c:46">EventTriggerCache</a>, &amp;event, HASH_FIND, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> entry != <span class="Constant">NULL</span> ? entry-&gt;triggerlist : NIL;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Rebuild the event <a href="../adt/pseudotypes.c.html#L366" title="utils/adt/pseudotypes.c:366">trigger</a> cache.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L77">&#x200c;</a></span><span class="linkable">BuildEventTriggerCache</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HASHCTL&nbsp; &nbsp; &nbsp; &nbsp; ctl;<br/></li>
<li>&nbsp; &nbsp; <a href="../hash/dynahash.c.html#L219" title="utils/hash/dynahash.c:219">HTAB</a>&nbsp; &nbsp; &nbsp;&nbsp; *cache;<br/></li>
<li>&nbsp; &nbsp; MemoryContext oldcontext;<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; rel;<br/></li>
<li>&nbsp; &nbsp; Relation&nbsp; &nbsp; irel;<br/></li>
<li>&nbsp; &nbsp; SysScanDesc scan;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a> != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Free up <a href="../adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> memory already allocated in <a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This can happen either because a previous rebuild failed, or<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * because an invalidation happened <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the rebuild was complete.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L383" title="utils/mmgr/mcxt.c:383">MemoryContextReset</a>(<a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * This is our first time attempting to build the cache, so we need to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * set up the memory context and register a syscache callback to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * capture future invalidation events.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../mmgr/mcxt.c.html#L152" title="utils/mmgr/mcxt.c:152">CacheMemoryContext</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="catcache.c.html#L679" title="utils/cache/catcache.c:679">CreateCacheMemoryContext</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AllocSetContextCreate(<a href="../mmgr/mcxt.c.html#L152" title="utils/mmgr/mcxt.c:152">CacheMemoryContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;<a href="#L46" title="utils/cache/evtcache.c:46">EventTriggerCache</a>&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ALLOCSET_DEFAULT_SIZES);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="inval.c.html#L1516" title="utils/cache/inval.c:1516">CacheRegisterSyscacheCallback</a>(EVENTTRIGGEROID,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L255" title="utils/cache/evtcache.c:255">InvalidateEventCacheCallback</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (Datum) <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Switch to correct memory context. */<br/></li>
<li></span>&nbsp; &nbsp; oldcontext = MemoryContextSwitchTo(<a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Prevent the memory context from being nuked while we're rebuilding. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L48" title="utils/cache/evtcache.c:48">EventTriggerCacheState</a> = ETCS_REBUILD_STARTED;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Create new <a href="../../regex/rege_dfa.c.html#L715" title="regex/rege_dfa.c:715">hash</a> table. */<br/></li>
<li></span>&nbsp; &nbsp; ctl.keysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(EventTriggerEvent);<br/></li>
<li>&nbsp; &nbsp; ctl.entrysize = <span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L44" title="utils/cache/evtcache.c:44">EventTriggerCacheEntry</a>);<br/></li>
<li>&nbsp; &nbsp; ctl.hcxt = <a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a>;<br/></li>
<li>&nbsp; &nbsp; cache = <a href="../hash/dynahash.c.html#L352" title="utils/hash/dynahash.c:352">hash_create</a>(<span class="Constant">&quot;EventTriggerCacheHash&quot;</span>, <span class="Constant">32</span>, &amp;ctl,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HASH_ELEM | HASH_BLOBS | HASH_CONTEXT);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Prepare to scan pg_event_trigger in name order.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; rel = <a href="../../access/common/relation.c.html#L47" title="access/common/relation.c:47">relation_open</a>(EventTriggerRelationId, AccessShareLock);<br/></li>
<li>&nbsp; &nbsp; irel = <a href="../../access/index/indexam.c.html#L133" title="access/index/indexam.c:133">index_open</a>(EventTriggerNameIndexId, AccessShareLock);<br/></li>
<li>&nbsp; &nbsp; scan = <a href="../../access/index/genam.c.html#L643" title="access/index/genam.c:643">systable_beginscan_ordered</a>(rel, irel, <span class="Constant">NULL</span>, <span class="Constant">0</span>, <span class="Constant">NULL</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Build a cache item for each pg_event_trigger tuple, and append each one<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * to the appropriate cache entry.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (;;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; HeapTuple&nbsp; &nbsp; tup;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_event_trigger form;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *evtevent;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; EventTriggerEvent event;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; EventTriggerCacheItem *item;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; evttags;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; evttags_isnull;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L44" title="utils/cache/evtcache.c:44">EventTriggerCacheEntry</a> *entry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Get <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> tuple. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; tup = <a href="../../access/index/genam.c.html#L710" title="access/index/genam.c:710">systable_getnext_ordered</a>(scan, ForwardScanDirection);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!HeapTupleIsValid(tup))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Skip <a href="../adt/pseudotypes.c.html#L366" title="utils/adt/pseudotypes.c:366">trigger</a> if disabled. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; form = (Form_pg_event_trigger) GETSTRUCT(tup);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (form-&gt;evtenabled == TRIGGER_DISABLED)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Decode event name. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; evtevent = NameStr(form-&gt;evtevent);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strcmp(evtevent, <span class="Constant">&quot;ddl_command_start&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event = EVT_DDLCommandStart;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (strcmp(evtevent, <span class="Constant">&quot;ddl_command_end&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event = EVT_DDLCommandEnd;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (strcmp(evtevent, <span class="Constant">&quot;sql_drop&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event = EVT_SQLDrop;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (strcmp(evtevent, <span class="Constant">&quot;table_rewrite&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event = EVT_TableRewrite;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (strcmp(evtevent, <span class="Constant">&quot;login&quot;</span>) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; event = EVT_Login;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Allocate new cache item. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; item = <a href="../mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(EventTriggerCacheItem));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; item-&gt;fnoid = form-&gt;evtfoid;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; item-&gt;enabled = form-&gt;evtenabled;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Decode and sort tags array. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; evttags = heap_getattr(tup, Anum_pg_event_trigger_evttags,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RelationGetDescr(rel), &amp;evttags_isnull);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!evttags_isnull)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; item-&gt;tagset = <a href="#L222" title="utils/cache/evtcache.c:222">DecodeTextArrayToBitmapset</a>(evttags);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Add to cache entry. */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; entry = <a href="../hash/dynahash.c.html#L955" title="utils/hash/dynahash.c:955">hash_search</a>(cache, &amp;event, HASH_ENTER, &amp;found);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry-&gt;triggerlist = <a href="../../nodes/list.c.html#L339" title="nodes/list.c:339">lappend</a>(entry-&gt;triggerlist, item);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entry-&gt;triggerlist = list_make1(item);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Done with pg_event_trigger scan. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../../access/index/genam.c.html#L735" title="access/index/genam.c:735">systable_endscan_ordered</a>(scan);<br/></li>
<li>&nbsp; &nbsp; <a href="../../access/index/indexam.c.html#L177" title="access/index/indexam.c:177">index_close</a>(irel, AccessShareLock);<br/></li>
<li>&nbsp; &nbsp; <a href="../../access/common/relation.c.html#L205" title="access/common/relation.c:205">relation_close</a>(rel, AccessShareLock);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Restore previous memory context. */<br/></li>
<li></span>&nbsp; &nbsp; MemoryContextSwitchTo(oldcontext);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Install new cache. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L46" title="utils/cache/evtcache.c:46">EventTriggerCache</a> = cache;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the cache has been invalidated since we entered this routine, we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * still use and return the cache we just finished constructing, to avoid<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * infinite loops, but we leave the cache marked stale so that we'll<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * rebuild it again on <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> access.&nbsp; Otherwise, we mark the cache valid.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L48" title="utils/cache/evtcache.c:48">EventTriggerCacheState</a> == ETCS_REBUILD_STARTED)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L48" title="utils/cache/evtcache.c:48">EventTriggerCacheState</a> = ETCS_VALID;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Decode text[] to a Bitmapset of CommandTags.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We could avoid a <a href="../adt/varbit.c.html#L391" title="utils/adt/varbit.c:391">bit</a> of overhead here if we were willing to duplicate some<br/></li>
<li></span><span class="Comment"> * of the logic from <a href="../adt/arrayfuncs.c.html#L3612" title="utils/adt/arrayfuncs.c:3612">deconstruct_array</a>, but it doesn't seem worth the code<br/></li>
<li></span><span class="Comment"> * complexity.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> Bitmapset *<br/></li>
<li><a id="L222">&#x200c;</a><span class="linkable">DecodeTextArrayToBitmapset</span>(Datum array)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; ArrayType&nbsp; *arr = DatumGetArrayTypeP(array);<br/></li>
<li>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *elems;<br/></li>
<li>&nbsp; &nbsp; Bitmapset&nbsp; *bms;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nelems;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ARR_NDIM(arr) != <span class="Constant">1</span> || ARR_HASNULL(arr) || ARR_ELEMTYPE(arr) != TEXTOID)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;expected 1-D text array&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="../adt/arrayfuncs.c.html#L3678" title="utils/adt/arrayfuncs.c:3678">deconstruct_array_builtin</a>(arr, TEXTOID, &amp;elems, <span class="Constant">NULL</span>, &amp;nelems);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (bms = <span class="Constant">NULL</span>, i = <span class="Constant">0</span>; i &lt; nelems; ++i)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *str = TextDatumGetCString(elems[i]);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bms = <a href="../../nodes/bitmapset.c.html#L815" title="nodes/bitmapset.c:815">bms_add_member</a>(bms, <a href="../../tcop/cmdtag.c.html#L83" title="tcop/cmdtag.c:83">GetCommandTagEnum</a>(str));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(str);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(elems);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> bms;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Flush all cache entries when pg_event_trigger is updated.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This should be rare enough that we don't need to be very granular about<br/></li>
<li></span><span class="Comment"> * it, so we just blow away everything, which also avoids the possibility of<br/></li>
<li></span><span class="Comment"> * memory leaks.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L255">&#x200c;</a></span><span class="linkable">InvalidateEventCacheCallback</span>(Datum arg, <span class="Type">int</span> cacheid, uint32 hashvalue)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If the cache isn't valid, then there might be a rebuild in progress, so<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we can't immediately blow it away.&nbsp; But it's advantageous to do this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * when possible, so as to immediately free memory.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L48" title="utils/cache/evtcache.c:48">EventTriggerCacheState</a> == ETCS_VALID)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../mmgr/mcxt.c.html#L383" title="utils/mmgr/mcxt.c:383">MemoryContextReset</a>(<a href="#L47" title="utils/cache/evtcache.c:47">EventTriggerCacheContext</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L46" title="utils/cache/evtcache.c:46">EventTriggerCache</a> = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Mark cache for rebuild. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L48" title="utils/cache/evtcache.c:48">EventTriggerCacheState</a> = ETCS_NEEDS_REBUILD;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
