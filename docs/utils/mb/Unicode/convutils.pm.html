<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>utils/mb/Unicode/convutils.pm - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

  <h1>utils/mb/Unicode/convutils.pm - pgsql17devel-backend</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L643">build_segments_from_tree</a></li>
<li><a href="#L665">build_segments_recurse</a></li>
<li><a href="#L718">make_charmap</a></li>
<li><a href="#L779">make_charmap_combined</a></li>
<li><a href="#L95">print_conversion_tables</a></li>
<li><a href="#L119">print_conversion_tables_direction</a></li>
<li><a href="#L168">print_from_utf8_combined_map</a></li>
<li><a href="#L247">print_radix_table</a></li>
<li><a href="#L203">print_to_utf8_combined_map</a></li>
<li><a href="#L30">read_source</a></li>
<li><a href="#L811">ucs2utf</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">#<br/></li>
<li></span><span class="Comment"># Copyright (c) 2001-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># src/backend/utils/mb/Unicode/convutils.pm<br/></li>
<li></span><br/></li>
<li><span class="Statement">package</span><span class="Type"> convutils</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">use strict</span>;<br/></li>
<li><span class="Statement">use warnings</span> <span class="Constant">FATAL</span> =&gt; <span class="Constant">'all'</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">use </span>Carp;<br/></li>
<li><span class="Statement">use </span>Exporter <span class="Constant">'import'</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">our</span> <span class="Identifier">@EXPORT</span> =<br/></li>
<li>&nbsp; <span class="Constant">qw( NONE TO_UNICODE FROM_UNICODE BOTH <a href="#L30" title="utils/mb/Unicode/convutils.pm:30">read_source</a> <a href="#L95" title="utils/mb/Unicode/convutils.pm:95">print_conversion_tables</a>)</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Constants used in the 'direction' field of the character maps<br/></li>
<li></span><span class="Statement">use constant</span> {<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">NONE</span> =&gt; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">TO_UNICODE</span> =&gt; <span class="Constant">1</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">FROM_UNICODE</span> =&gt; <span class="Constant">2</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">BOTH</span> =&gt; <span class="Constant">3<br/></li>
<li></span>};<br/></li>
<li><br/></li>
<li><span class="Comment">#######################################################################<br/></li>
<li></span><span class="Comment"># <a href="#L30" title="utils/mb/Unicode/convutils.pm:30">read_source</a> - common routine to read source file<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># fname ; input file name<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L30">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">read_source</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$fname</span>) = <span class="Identifier">@_</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@r</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">open</span>(<span class="Statement">my</span> <span class="Identifier">$in</span>, <span class="Constant">'&lt;'</span>, <span class="Identifier">$fname</span>) || <span class="Statement">die</span>(<span class="Constant">&quot;cannot open </span><span class="Identifier">$fname</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (&lt;<span class="Identifier">$in</span>&gt;)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Statement">/</span><span class="Constant">^#</span><span class="Statement">/</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">chop</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Statement">/</span><span class="Constant">^$</span><span class="Statement">/</span>);&nbsp; &nbsp; <span class="Comment"># Ignore empty lines<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Statement">/</span><span class="Constant">^0x</span><span class="Special">([0-9A-F]+)\s+(</span><span class="Constant">#</span><span class="Special">.*)</span><span class="Constant">$</span><span class="Statement">/</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># The Unicode source files have three columns<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># 1: The &quot;foreign&quot; code (in hex)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># 2: Unicode code point (in hex)<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># 3: Unicode name<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<span class="Statement">/</span><span class="Constant">^0x</span><span class="Special">([0-9A-Fa-f]+)\s+</span><span class="Constant">0x</span><span class="Special">([0-9A-Fa-f]+)\s+(</span><span class="Constant">#</span><span class="Special">.*)</span><span class="Constant">$</span><span class="Statement">/</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">STDERR</span> <span class="Constant">&quot;READ ERROR at line </span><span class="Identifier">$.</span><span class="Constant"> in </span><span class="Identifier">$fname</span><span class="Constant">: </span><span class="Identifier">$_</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">exit</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$out</span> = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">code</span> =&gt; <span class="Statement">hex</span>(<span class="Identifier">$1</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">ucs</span> =&gt; <span class="Statement">hex</span>(<span class="Identifier">$2</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">comment</span> =&gt; <span class="Identifier">$4</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">direction</span> =&gt; BOTH,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">f</span> =&gt; <span class="Identifier">$fname</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">l</span> =&gt; <span class="Identifier">$.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Ignore pure ASCII mappings. PostgreSQL character conversion code<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># never even passes these to the conversion code.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Identifier">$out-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span> &lt; <span class="Constant">0x80</span> || <span class="Identifier">$out-&gt;{</span><span class="Constant">ucs</span><span class="Identifier">}</span> &lt; <span class="Constant">0x80</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span>(<span class="Identifier">@r</span>, <span class="Identifier">$out</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">close</span>(<span class="Identifier">$in</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> \<span class="Identifier">@r</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">##################################################################<br/></li>
<li></span><span class="Comment"># <a href="#L95" title="utils/mb/Unicode/convutils.pm:95">print_conversion_tables</a> - output mapping tables<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># <a href="#L95" title="utils/mb/Unicode/convutils.pm:95">print_conversion_tables</a>($this_script, $csname, \%charset)<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># this_script - the name of the *caller script* of this feature<br/></li>
<li></span><span class="Comment"># csname&nbsp; &nbsp; &nbsp; - character set name other than ucs<br/></li>
<li></span><span class="Comment"># charset&nbsp; &nbsp;&nbsp; - ref to character set array<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># Input character set array format:<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># Each element in the character set array is a hash. Each hash has the following fields:<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; direction&nbsp; - BOTH, TO_UNICODE, or FROM_UNICODE (or NONE, to ignore the entry altogether)<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; ucs&nbsp; &nbsp; &nbsp; &nbsp; - Unicode code point<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; ucs_second - Second Unicode code point, if this is a &quot;combined&quot; character.<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; code&nbsp; &nbsp; &nbsp;&nbsp; - Byte sequence in the &quot;other&quot; character set, as an integer<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; comment&nbsp; &nbsp; - Text representation of the character<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; f&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Source filename<br/></li>
<li></span><span class="Comment">#&nbsp;&nbsp; l&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - Line number in source file<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L95">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_conversion_tables</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$this_script</span>, <span class="Identifier">$csname</span>, <span class="Identifier">$charset</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L119" title="utils/mb/Unicode/convutils.pm:119">print_conversion_tables_direction</a>(<span class="Identifier">$this_script</span>, <span class="Identifier">$csname</span>, FROM_UNICODE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$charset</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L119" title="utils/mb/Unicode/convutils.pm:119">print_conversion_tables_direction</a>(<span class="Identifier">$this_script</span>, <span class="Identifier">$csname</span>, TO_UNICODE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$charset</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">#############################################################################<br/></li>
<li></span><span class="Comment"># INTERNAL ROUTINES<br/></li>
<li></span><br/></li>
<li><span class="Comment">#######################################################################<br/></li>
<li></span><span class="Comment"># <a href="#L119" title="utils/mb/Unicode/convutils.pm:119">print_conversion_tables_direction</a> - write the whole content of C source of radix tree<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># <a href="#L119" title="utils/mb/Unicode/convutils.pm:119">print_conversion_tables_direction</a>($this_script, $csname, $direction, \%charset, $tblwidth)<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># this_script - the name of the *caller script* of this feature<br/></li>
<li></span><span class="Comment"># csname&nbsp; &nbsp; &nbsp; - character set name other than ucs<br/></li>
<li></span><span class="Comment"># direction&nbsp;&nbsp; - desired direction, TO_UNICODE or FROM_UNICODE<br/></li>
<li></span><span class="Comment"># charset&nbsp; &nbsp;&nbsp; - ref to character set array<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L119">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_conversion_tables_direction</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$this_script</span>, <span class="Identifier">$csname</span>, <span class="Identifier">$direction</span>, <span class="Identifier">$charset</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$fname</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$tblname</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$direction</span> == TO_UNICODE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$fname</span> = <span class="Statement">lc</span>(<span class="Constant">&quot;</span><span class="Identifier">${csname}</span><span class="Constant">_to_utf8.map&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$tblname</span> = <span class="Statement">lc</span>(<span class="Constant">&quot;</span><span class="Identifier">${csname}</span><span class="Constant">_to_unicode_tree&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Constant">&quot;- Writing </span><span class="Identifier">${csname}</span><span class="Constant">=&gt;UTF8 conversion table: </span><span class="Identifier">$fname</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$fname</span> = <span class="Statement">lc</span>(<span class="Constant">&quot;utf8_to_</span><span class="Identifier">${csname}</span><span class="Constant">.map&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$tblname</span> = <span class="Statement">lc</span>(<span class="Constant">&quot;</span><span class="Identifier">${csname}</span><span class="Constant">_from_unicode_tree&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Constant">&quot;- Writing UTF8=&gt;</span><span class="Identifier">${csname}</span><span class="Constant"> conversion table: </span><span class="Identifier">$fname</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">open</span>(<span class="Statement">my</span> <span class="Identifier">$out</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$fname</span>) || <span class="Statement">die</span>(<span class="Constant">&quot;cannot open </span><span class="Identifier">$fname</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;/* src/backend/utils/mb/Unicode/</span><span class="Identifier">$fname</span><span class="Constant"> */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;/* This file is generated by </span><span class="Identifier">$this_script</span><span class="Constant"> */</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Collect regular, non-combined, mappings, and create the radix tree from them.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$charmap</span> = <span class="Identifier">&amp;<a href="#L718" title="utils/mb/Unicode/convutils.pm:718">make_charmap</a></span>(<span class="Identifier">$out</span>, <span class="Identifier">$charset</span>, <span class="Identifier">$direction</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L247" title="utils/mb/Unicode/convutils.pm:247">print_radix_table</a>(<span class="Identifier">$out</span>, <span class="Identifier">$tblname</span>, <span class="Identifier">$charmap</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Collect combined characters, and create combined character table (if any)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$charmap_combined</span> = <span class="Identifier">&amp;<a href="#L779" title="utils/mb/Unicode/convutils.pm:779">make_charmap_combined</a></span>(<span class="Identifier">$charset</span>, <span class="Identifier">$direction</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">scalar</span> <span class="Identifier">@{$charmap_combined}</span> &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$direction</span> == TO_UNICODE)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L203" title="utils/mb/Unicode/convutils.pm:203">print_to_utf8_combined_map</a>(<span class="Identifier">$out</span>, <span class="Identifier">$csname</span>, <span class="Identifier">$charmap_combined</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L168" title="utils/mb/Unicode/convutils.pm:168">print_from_utf8_combined_map</a>(<span class="Identifier">$out</span>, <span class="Identifier">$csname</span>, <span class="Identifier">$charmap_combined</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">close</span>(<span class="Identifier">$out</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L168">&#x200c;</a><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_from_utf8_combined_map</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$out</span>, <span class="Identifier">$charset</span>, <span class="Identifier">$table</span>, <span class="Identifier">$verbose</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$last_comment</span> = <span class="Constant">&quot;&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">/* Combined character map */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;static const pg_utf_to_local_combined ULmap</span><span class="Identifier">${charset}</span><span class="Constant">_combined[%d] = {&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">scalar</span>(<span class="Identifier">@$table</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$first</span> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$i</span> (<span class="Statement">sort</span> <span class="Statement">{</span> <span class="Identifier">$a-&gt;{</span><span class="Constant">utf8</span><span class="Identifier">}</span> &lt;=&gt; <span class="Identifier">$b-&gt;{</span><span class="Constant">utf8</span><span class="Identifier">}</span> <span class="Statement">}</span> <span class="Identifier">@$table</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span>(<span class="Identifier">$out</span> <span class="Constant">&quot;,&quot;</span>) <span class="Statement">if</span> (!<span class="Identifier">$first</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$first</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">/* </span><span class="Identifier">$last_comment</span><span class="Constant"> */&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span> &amp;&amp; <span class="Identifier">$last_comment</span> <span class="Statement">ne</span> <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&nbsp; {0x%08x, 0x%08x, 0x%04x}&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i-&gt;{</span><span class="Constant">utf8</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">utf8_second</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span> &gt;= <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$last_comment</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sprintf</span>(<span class="Constant">&quot;%s:%d %s&quot;</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">f</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">l</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">comment</span><span class="Identifier">}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$verbose</span> &gt;= <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$last_comment</span> = <span class="Identifier">$i-&gt;{</span><span class="Constant">comment</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">/* </span><span class="Identifier">$last_comment</span><span class="Constant"> */&quot;</span> <span class="Statement">if</span> (<span class="Identifier">$verbose</span> &amp;&amp; <span class="Identifier">$last_comment</span> <span class="Statement">ne</span> <span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">};</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L203">&#x200c;</a><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_to_utf8_combined_map</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$out</span>, <span class="Identifier">$charset</span>, <span class="Identifier">$table</span>, <span class="Identifier">$verbose</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$last_comment</span> = <span class="Constant">&quot;&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">/* Combined character map */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;static const pg_local_to_utf_combined LUmap</span><span class="Identifier">${charset}</span><span class="Constant">_combined[%d] = {&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Statement">scalar</span>(<span class="Identifier">@$table</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$first</span> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$i</span> (<span class="Statement">sort</span> <span class="Statement">{</span> <span class="Identifier">$a-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span> &lt;=&gt; <span class="Identifier">$b-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span> <span class="Statement">}</span> <span class="Identifier">@$table</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span>(<span class="Identifier">$out</span> <span class="Constant">&quot;,&quot;</span>) <span class="Statement">if</span> (!<span class="Identifier">$first</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$first</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">/* </span><span class="Identifier">$last_comment</span><span class="Constant"> */&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span> &amp;&amp; <span class="Identifier">$last_comment</span> <span class="Statement">ne</span> <span class="Constant">&quot;&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&nbsp; {0x%04x, 0x%08x, 0x%08x}&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">utf8</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">utf8_second</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span> &gt;= <span class="Constant">2</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$last_comment</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sprintf</span>(<span class="Constant">&quot;%s:%d %s&quot;</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">f</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">l</span><span class="Identifier">}</span>, <span class="Identifier">$i-&gt;{</span><span class="Constant">comment</span><span class="Identifier">}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$verbose</span> &gt;= <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$last_comment</span> = <span class="Identifier">$i-&gt;{</span><span class="Constant">comment</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">/* </span><span class="Identifier">$last_comment</span><span class="Constant"> */&quot;</span> <span class="Statement">if</span> (<span class="Identifier">$verbose</span> &amp;&amp; <span class="Identifier">$last_comment</span> <span class="Statement">ne</span> <span class="Constant">&quot;&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">};</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">#######################################################################<br/></li>
<li></span><span class="Comment"># <a href="#L247" title="utils/mb/Unicode/convutils.pm:247">print_radix_table</a>(&lt;output handle&gt;, &lt;table name&gt;, &lt;charmap hash ref&gt;)<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># Input: A hash, mapping an input character to an output character.<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># Constructs a radix tree from the hash, and prints it out as a C-struct.<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L247">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_radix_table</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$out</span>, <span class="Identifier">$tblname</span>, <span class="Identifier">$c</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Build radix trees in memory, for 1-, 2-, 3- and 4-byte inputs. Each<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### radix tree is represented as a nested hash, each hash indexed by<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### input byte<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%b1map</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%b2map</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%b3map</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%b4map</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$in</span> (<span class="Statement">keys</span> <span class="Identifier">%$c</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$out</span> = <span class="Identifier">$c-&gt;{$in}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$in</span> &lt;= <span class="Constant">0xff</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$b1map{$in}</span> = <span class="Identifier">$out</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$in</span> &lt;= <span class="Constant">0xffff</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b1</span> = <span class="Identifier">$in</span> &gt;&gt; <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2</span> = <span class="Identifier">$in</span> &amp; <span class="Constant">0xff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$b2map{$b1}{$b2}</span> = <span class="Identifier">$out</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$in</span> &lt;= <span class="Constant">0xffffff</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b1</span> = <span class="Identifier">$in</span> &gt;&gt; <span class="Constant">16</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2</span> = (<span class="Identifier">$in</span> &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3</span> = <span class="Identifier">$in</span> &amp; <span class="Constant">0xff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$b3map{$b1}{$b2}{$b3}</span> = <span class="Identifier">$out</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$in</span> &lt;= <span class="Constant">0xffffffff</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b1</span> = <span class="Identifier">$in</span> &gt;&gt; <span class="Constant">24</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2</span> = (<span class="Identifier">$in</span> &gt;&gt; <span class="Constant">16</span>) &amp; <span class="Constant">0xff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3</span> = (<span class="Identifier">$in</span> &gt;&gt; <span class="Constant">8</span>) &amp; <span class="Constant">0xff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4</span> = <span class="Identifier">$in</span> &amp; <span class="Constant">0xff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$b4map{$b1}{$b2}{$b3}{$b4}</span> = <span class="Identifier">$out</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">die</span> <span class="Statement">sprintf</span>(<span class="Constant">&quot;up to 4 byte code is supported: %x&quot;</span>, <span class="Identifier">$in</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@segments</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Build a linear list of &quot;segments&quot;, from the nested hashes.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Each segment is a lookup table, keyed by the next byte in the input.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### The segments are written out physically to one big array in the final<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### step, but logically, they form a radix tree. Or rather, four radix<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### trees: one for 1-byte inputs, another for 2-byte inputs, 3-byte<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### inputs, and 4-byte inputs.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Each segment is represented by a hash with following fields:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### comment =&gt; &lt;string to output as a comment&gt;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### label =&gt; &lt;label that can be used to refer to this segment from elsewhere&gt;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### values =&gt; &lt;a hash, keyed by byte, 0-0xff&gt;<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Entries in 'values' can be integers (for leaf-level segments), or<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### string labels, pointing to a segment with that label. Any missing<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### values are treated as zeros. If 'values' hash is missing altogether,<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### it's treated as all-zeros.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Subsequent steps will enrich the segments with more fields.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Add the segments for the radix trees themselves.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L643" title="utils/mb/Unicode/convutils.pm:643">build_segments_from_tree</a>(<span class="Constant">&quot;Single byte table&quot;</span>, <span class="Constant">&quot;1-byte&quot;</span>, <span class="Constant">1</span>, \<span class="Identifier">%b1map</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L643" title="utils/mb/Unicode/convutils.pm:643">build_segments_from_tree</a>(<span class="Constant">&quot;Two byte table&quot;</span>, <span class="Constant">&quot;2-byte&quot;</span>, <span class="Constant">2</span>, \<span class="Identifier">%b2map</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L643" title="utils/mb/Unicode/convutils.pm:643">build_segments_from_tree</a>(<span class="Constant">&quot;Three byte table&quot;</span>, <span class="Constant">&quot;3-byte&quot;</span>, <span class="Constant">3</span>, \<span class="Identifier">%b3map</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <a href="#L643" title="utils/mb/Unicode/convutils.pm:643">build_segments_from_tree</a>(<span class="Constant">&quot;Four byte table&quot;</span>, <span class="Constant">&quot;4-byte&quot;</span>, <span class="Constant">4</span>, \<span class="Identifier">%b4map</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Find min and max index used in each level of each tree.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### These are stored separately, and we can then leave out the unused<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### parts of every segment. (When using the resulting tree, you must<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### check each input byte against the min and max.)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%min_idx</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%max_idx</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$this_min</span> = <span class="Identifier">$min_idx{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">depth</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}-&gt;{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$this_max</span> = <span class="Identifier">$max_idx{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">depth</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}-&gt;{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$i</span> (<span class="Statement">keys</span> <span class="Identifier">%{</span><span class="perlVarBlock2"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}</span><span class="perlVarBlock2"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$this_min</span> = <span class="Identifier">$i</span> <span class="Statement">if</span> (!<span class="Statement">defined</span> <span class="Identifier">$this_min</span> || <span class="Identifier">$i</span> &lt; <span class="Identifier">$this_min</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$this_max</span> = <span class="Identifier">$i</span> <span class="Statement">if</span> (!<span class="Statement">defined</span> <span class="Identifier">$this_max</span> || <span class="Identifier">$i</span> &gt; <span class="Identifier">$this_max</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$min_idx{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">depth</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$this_min</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$max_idx{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">depth</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$this_max</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Copy the mins and max's back to every segment, for convenience.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$seg-&gt;{</span><span class="Constant">min_idx</span><span class="Identifier">}</span> = <span class="Identifier">$min_idx{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">depth</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span> = <span class="Identifier">$max_idx{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">depth</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Prepend a dummy all-zeros map to the beginning.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### A 0 is an invalid value anywhere in the table, and this allows us to<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### point to 0 offset from any table, to get a 0 result.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Find the max range between min and max indexes in any of the segments.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$widest_range</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$this_range</span> = <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span> - <span class="Identifier">$seg-&gt;{</span><span class="Constant">min_idx</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$widest_range</span> = <span class="Identifier">$this_range</span> <span class="Statement">if</span> (<span class="Identifier">$this_range</span> &gt; <span class="Identifier">$widest_range</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">unshift</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">header</span> =&gt; <span class="Constant">&quot;Dummy map, for invalid values&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">min_idx</span> =&gt; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">max_idx</span> =&gt; <span class="Identifier">$widest_range</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">label</span> =&gt; <span class="Constant">&quot;dummy map&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Eliminate overlapping zeros<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### For each segment, if there are zero values at the end of, and there<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### are also zero values at the beginning of the next segment, we can<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### overlay the tail of this segment with the head of next segment, to<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### save space.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### To achieve that, we subtract the 'max_idx' of each segment with the<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### amount of zeros that can be overlaid.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Statement">my</span> <span class="Identifier">$j</span> = <span class="Constant">0</span>; <span class="Identifier">$j</span> &lt; <span class="Identifier">$#segments</span> - <span class="Constant">1</span>; <span class="Identifier">$j</span>++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$seg</span> = <span class="Identifier">$segments[$j]</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$nextseg</span> = <span class="Identifier">$segments[</span><span class="perlVarMember"> </span><span class="Identifier">$j</span><span class="perlVarMember"> + </span><span class="Constant">1</span><span class="perlVarMember"> </span><span class="Identifier">]</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Count the number of zero values at the end of this segment.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$this_trail_zeros</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$i</span> = <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i</span> &gt;= <span class="Identifier">$seg-&gt;{</span><span class="Constant">min_idx</span><span class="Identifier">}</span> &amp;&amp; !<span class="Identifier">$seg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}-&gt;{$i}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i</span>--)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$this_trail_zeros</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Count the number of zeros at the beginning of next segment.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$next_lead_zeros</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$i</span> = <span class="Identifier">$nextseg-&gt;{</span><span class="Constant">min_idx</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i</span> &lt;= <span class="Identifier">$nextseg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span> &amp;&amp; !<span class="Identifier">$nextseg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}-&gt;{$i}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i</span>++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$next_lead_zeros</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># How many zeros in common?<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$overlaid_trail_zeros</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Identifier">$this_trail_zeros</span> &gt; <span class="Identifier">$next_lead_zeros</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? <span class="Identifier">$next_lead_zeros<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <span class="Identifier">$this_trail_zeros</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$seg-&gt;{</span><span class="Constant">overlaid_trail_zeros</span><span class="Identifier">}</span> = <span class="Identifier">$overlaid_trail_zeros</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span> = <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span> - <span class="Identifier">$overlaid_trail_zeros</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Replace label references with real offsets.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### So far, the non-leaf segments have referred to other segments by<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### their labels. Replace them with numerical offsets from the beginning<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### of the final array. You cannot move, add, or remove segments after<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### this step, as that would invalidate the offsets calculated here!<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$flatoff</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%segmap</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># First pass: assign offsets to each segment, and build hash<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># of label =&gt; offset.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$seg-&gt;{</span><span class="Constant">offset</span><span class="Identifier">}</span> = <span class="Identifier">$flatoff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$segmap{</span><span class="perlVarMember"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">label</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$flatoff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$flatoff</span> += <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span> - <span class="Identifier">$seg-&gt;{</span><span class="Constant">min_idx</span><span class="Identifier">}</span> + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$tblsize</span> = <span class="Identifier">$flatoff</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Second pass: look up the offset of each label reference in the hash.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (<span class="Statement">my</span> (<span class="Identifier">$i</span>, <span class="Identifier">$val</span>) = <span class="Statement">each</span> <span class="Identifier">%{</span><span class="perlVarBlock2"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}</span><span class="perlVarBlock2"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!(<span class="Identifier">$val</span> =~ <span class="Statement">/</span><span class="Constant">^</span><span class="Special">[0-9,.E]+</span><span class="Constant">$</span><span class="Statement">/</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$segoff</span> = <span class="Identifier">$segmap{$val}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$segoff</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$seg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}-&gt;{$i}</span> = <span class="Identifier">$segoff</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">die</span> <span class="Constant">&quot;no segment with label </span><span class="Identifier">$val</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Also look up the positions of the roots in the table.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># Missing map represents dummy mapping.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b1root</span> = <span class="Identifier">$segmap{</span><span class="Constant">&quot;1-byte&quot;</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2root</span> = <span class="Identifier">$segmap{</span><span class="Constant">&quot;2-byte&quot;</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3root</span> = <span class="Identifier">$segmap{</span><span class="Constant">&quot;3-byte&quot;</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4root</span> = <span class="Identifier">$segmap{</span><span class="Constant">&quot;4-byte&quot;</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># And the lower-upper values of each level in each radix tree.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># Missing values represent zero.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b1_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">1</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b1_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">1</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2_1_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">2</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2_1_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">2</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2_2_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">2</span><span class="Identifier">}{</span><span class="Constant">2</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b2_2_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">2</span><span class="Identifier">}{</span><span class="Constant">2</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3_1_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">3</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3_1_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">3</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3_2_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">3</span><span class="Identifier">}{</span><span class="Constant">2</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3_2_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">3</span><span class="Identifier">}{</span><span class="Constant">2</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3_3_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">3</span><span class="Identifier">}{</span><span class="Constant">3</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b3_3_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">3</span><span class="Identifier">}{</span><span class="Constant">3</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_1_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_1_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">1</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_2_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">2</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_2_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">2</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_3_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">3</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_3_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">3</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_4_lower</span> = <span class="Identifier">$min_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">4</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$b4_4_upper</span> = <span class="Identifier">$max_idx{</span><span class="Constant">4</span><span class="Identifier">}{</span><span class="Constant">4</span><span class="Identifier">}</span> || <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Find the maximum value in the whole table, to determine if we can<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### use uint16 or if we need to use uint32.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$max_val</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$val</span> (<span class="Statement">values</span> <span class="Identifier">%{</span><span class="perlVarBlock2"> </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}</span><span class="perlVarBlock2"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$max_val</span> = <span class="Identifier">$val</span> <span class="Statement">if</span> (<span class="Identifier">$val</span> &gt; <span class="Identifier">$max_val</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$datatype</span> = (<span class="Identifier">$max_val</span> &lt;= <span class="Constant">0xffff</span>) ? <span class="Constant">&quot;uint16&quot;</span> : <span class="Constant">&quot;uint32&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># For formatting, determine how many values we can fit on a single<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># line, and how wide each value needs to be to align nicely.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$vals_per_line</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$colwidth</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$max_val</span> &lt;= <span class="Constant">0xffff</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$vals_per_line</span> = <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$colwidth</span> = <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$max_val</span> &lt;= <span class="Constant">0xffffff</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$vals_per_line</span> = <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$colwidth</span> = <span class="Constant">6</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$vals_per_line</span> = <span class="Constant">4</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$colwidth</span> = <span class="Constant">8</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">### Print the struct and array.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">###<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;static const </span><span class="Identifier">$datatype</span><span class="Constant"> </span><span class="Identifier">${tblname}</span><span class="Constant">_table[</span><span class="Identifier">$tblsize</span><span class="Constant">];</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;static const pg_mb_radix_tree </span><span class="Identifier">$tblname</span><span class="Constant"> =</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;{</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$datatype</span> <span class="Statement">eq</span> <span class="Constant">&quot;uint16&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; </span><span class="Identifier">${tblname}</span><span class="Constant">_table,</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; NULL, /* 32-bit table not used */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$datatype</span> <span class="Statement">eq</span> <span class="Constant">&quot;uint32&quot;</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; NULL, /* 16-bit table not used */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; </span><span class="Identifier">${tblname}</span><span class="Constant">_table,</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%04x, /* offset of table for 1-byte inputs */</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$b1root</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b1_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b1_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b1_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b1_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%04x, /* offset of table for 2-byte inputs */</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$b2root</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b2_1_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b2_1_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b2_1_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b2_1_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b2_2_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b2_2_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b2_2_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b2_2_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%04x, /* offset of table for 3-byte inputs */</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$b3root</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b3_1_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b3_1_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b3_1_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b3_1_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b3_2_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b3_2_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b3_2_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b3_2_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b3_3_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b3_3_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b3_3_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b3_3_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%04x, /* offset of table for 4-byte inputs */</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$b4root</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_1_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_1_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_1_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_1_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_2_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_2_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_2_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_2_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_3_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_3_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_3_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_3_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x, /* b4_4_lower */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_4_lower</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; 0x%02x&nbsp; /* b4_4_upper */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$b4_4_upper</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;};</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;static const </span><span class="Identifier">$datatype</span><span class="Constant"> </span><span class="Identifier">${tblname}</span><span class="Constant">_table[</span><span class="Identifier">$tblsize</span><span class="Constant">] =</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;{&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$off</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$seg</span> (<span class="Identifier">@segments</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; /*** %s - offset 0x%05x ***/</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$seg-&gt;{</span><span class="Constant">header</span><span class="Identifier">}</span>, <span class="Identifier">$off</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<span class="Statement">my</span> <span class="Identifier">$i</span> = <span class="Identifier">$seg-&gt;{</span><span class="Constant">min_idx</span><span class="Identifier">}</span>; <span class="Identifier">$i</span> &lt;= <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span>;)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Print the next line's worth of values.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># </span><span class="Todo">XXX</span><span class="Comment"> pad to begin at a nice boundary<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&nbsp; /* %02x */ &quot;</span>, <span class="Identifier">$i</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$j</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$j</span> &lt; <span class="Identifier">$vals_per_line</span> &amp;&amp; <span class="Identifier">$i</span> &lt;= <span class="Identifier">$seg-&gt;{</span><span class="Constant">max_idx</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$j</span>++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># missing values represent zero.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$val</span> = <span class="Identifier">$seg-&gt;{</span><span class="Constant">values</span><span class="Identifier">}-&gt;{$i}</span> || <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot; 0x%0*x&quot;</span>, <span class="Identifier">$colwidth</span>, <span class="Identifier">$val</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$off</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$off</span> != <span class="Identifier">$tblsize</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;,&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$i</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$seg-&gt;{</span><span class="Constant">overlaid_trail_zeros</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;&nbsp; &nbsp; /* </span><span class="Identifier">$seg-&gt;{</span><span class="Constant">overlaid_trail_zeros</span><span class="Identifier">}</span><span class="Constant"> trailing zero values shared with next segment */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Sanity check.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$off</span> != <span class="Identifier">$tblsize</span>) { <span class="Statement">die</span> <span class="Constant">&quot;table size didn't match!&quot;</span>; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;};</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">###<br/></li>
<li><a id="L643">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">build_segments_from_tree</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$header</span>, <span class="Identifier">$rootlabel</span>, <span class="Identifier">$depth</span>, <span class="Identifier">$map</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@segments</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">%{$map}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@segments</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L665" title="utils/mb/Unicode/convutils.pm:665">build_segments_recurse</a>(<span class="Identifier">$header</span>, <span class="Identifier">$rootlabel</span>, <span class="Constant">&quot;&quot;</span>, <span class="Constant">1</span>, <span class="Identifier">$depth</span>, <span class="Identifier">$map</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Sort the segments into &quot;breadth-first&quot; order. Not strictly required,<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># but makes the maps nicer to read.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@segments</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sort</span> <span class="Statement">{</span> <span class="Identifier">$a-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span> <span class="Statement">cmp</span> <span class="Identifier">$b-&gt;{</span><span class="Constant">level</span><span class="Identifier">}</span> <span class="Statement">or</span> <span class="Identifier">$a-&gt;{</span><span class="Constant">path</span><span class="Identifier">}</span> <span class="Statement">cmp</span> <span class="Identifier">$b-&gt;{</span><span class="Constant">path</span><span class="Identifier">}</span> <span class="Statement">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@segments</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Identifier">@segments</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">###<br/></li>
<li><a id="L665">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">build_segments_recurse</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$header</span>, <span class="Identifier">$label</span>, <span class="Identifier">$path</span>, <span class="Identifier">$level</span>, <span class="Identifier">$depth</span>, <span class="Identifier">$map</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@segments</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$level</span> == <span class="Identifier">$depth</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">header</span> =&gt; <span class="Identifier">$header</span> . <span class="Constant">&quot;, leaf: </span><span class="Identifier">${path}</span><span class="Constant">xx&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">label</span> =&gt; <span class="Identifier">$label</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">level</span> =&gt; <span class="Identifier">$level</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">depth</span> =&gt; <span class="Identifier">$depth</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">path</span> =&gt; <span class="Identifier">$path</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">values</span> =&gt; <span class="Identifier">$map<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%children</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">while</span> (<span class="Statement">my</span> (<span class="Identifier">$i</span>, <span class="Identifier">$val</span>) = <span class="Statement">each</span> <span class="Identifier">%$map</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$childpath</span> = <span class="Identifier">$path</span> . <span class="Statement">sprintf</span>(<span class="Constant">&quot;%02x&quot;</span>, <span class="Identifier">$i</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$childlabel</span> = <span class="Constant">&quot;</span><span class="Identifier">$depth</span><span class="Constant">-level-</span><span class="Identifier">$level</span><span class="Constant">-</span><span class="Identifier">$childpath</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L665" title="utils/mb/Unicode/convutils.pm:665">build_segments_recurse</a>(<span class="Identifier">$header</span>, <span class="Identifier">$childlabel</span>, <span class="Identifier">$childpath</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$level</span> + <span class="Constant">1</span>, <span class="Identifier">$depth</span>, <span class="Identifier">$val</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$children{$i}</span> = <span class="Identifier">$childlabel</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@segments</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">header</span> =&gt; <span class="Identifier">$header</span> . <span class="Constant">&quot;, byte #</span><span class="Identifier">$level</span><span class="Constant">: </span><span class="Identifier">${path}</span><span class="Constant">xx&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">label</span> =&gt; <span class="Identifier">$label</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">level</span> =&gt; <span class="Identifier">$level</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">depth</span> =&gt; <span class="Identifier">$depth</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">path</span> =&gt; <span class="Identifier">$path</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">values</span> =&gt; \<span class="Identifier">%children<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Identifier">@segments</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">#######################################################################<br/></li>
<li></span><span class="Comment"># <a href="#L718" title="utils/mb/Unicode/convutils.pm:718">make_charmap</a> - convert charset table to charmap hash<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># <a href="#L718" title="utils/mb/Unicode/convutils.pm:718">make_charmap</a>(\@charset, $direction)<br/></li>
<li></span><span class="Comment"># charset&nbsp; &nbsp;&nbsp; - ref to charset table : see <a href="#L95" title="utils/mb/Unicode/convutils.pm:95">print_conversion_tables</a><br/></li>
<li></span><span class="Comment"># direction&nbsp;&nbsp; - conversion direction<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L718">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">make_charmap</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$out</span>, <span class="Identifier">$charset</span>, <span class="Identifier">$direction</span>, <span class="Identifier">$verbose</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; croak <span class="Constant">&quot;unacceptable direction : </span><span class="Identifier">$direction</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$direction</span> != TO_UNICODE &amp;&amp; <span class="Identifier">$direction</span> != FROM_UNICODE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># In verbose mode, print a large comment with the source and comment of<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># each character<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;/*</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;&lt;src&gt;&nbsp; &lt;dst&gt;&nbsp; &nbsp; &lt;file&gt;:&lt;lineno&gt; &lt;comment&gt;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%charmap</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$c</span> (<span class="Identifier">@$charset</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># combined characters are handled elsewhere<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$c-&gt;{</span><span class="Constant">ucs_second</span><span class="Identifier">}</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Identifier">$c-&gt;{</span><span class="Constant">direction</span><span class="Identifier">}</span> != <span class="Identifier">$direction</span> &amp;&amp; <span class="Identifier">$c-&gt;{</span><span class="Constant">direction</span><span class="Identifier">}</span> != BOTH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$src</span>, <span class="Identifier">$dst</span>) =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$direction</span> == TO_UNICODE<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? (<span class="Identifier">$c-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span>, <a href="#L811" title="utils/mb/Unicode/convutils.pm:811">ucs2utf</a>(<span class="Identifier">$c-&gt;{</span><span class="Constant">ucs</span><span class="Identifier">}</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : (<a href="#L811" title="utils/mb/Unicode/convutils.pm:811">ucs2utf</a>(<span class="Identifier">$c-&gt;{</span><span class="Constant">ucs</span><span class="Identifier">}</span>), <span class="Identifier">$c-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># check for duplicate source codes<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$charmap{$src}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> STDERR<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Error: duplicate source code on %s:%d: 0x%04x =&gt; 0x%04x, 0x%04x</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$c-&gt;{</span><span class="Constant">f</span><span class="Identifier">}</span>, <span class="Identifier">$c-&gt;{</span><span class="Constant">l</span><span class="Identifier">}</span>, <span class="Identifier">$src</span>, <span class="Identifier">$charmap{$src}</span>, <span class="Identifier">$dst</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">exit</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$charmap{$src}</span> = <span class="Identifier">$dst</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$out</span> <span class="Constant">&quot;0x%04x 0x%04x %s:%d %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$src</span>, <span class="Identifier">$dst</span>, <span class="Identifier">$c-&gt;{</span><span class="Constant">f</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$c-&gt;{</span><span class="Constant">l</span><span class="Identifier">}</span>, <span class="Identifier">$c-&gt;{</span><span class="Constant">comment</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$verbose</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$out</span> <span class="Constant">&quot;*/</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> \<span class="Identifier">%charmap</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">#######################################################################<br/></li>
<li></span><span class="Comment"># <a href="#L779" title="utils/mb/Unicode/convutils.pm:779">make_charmap_combined</a> - convert charset table to charmap hash<br/></li>
<li></span><span class="Comment">#&nbsp; &nbsp;&nbsp; with checking duplicate source code<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># <a href="#L779" title="utils/mb/Unicode/convutils.pm:779">make_charmap_combined</a>(\@charset, $direction)<br/></li>
<li></span><span class="Comment"># charset&nbsp; &nbsp;&nbsp; - ref to charset table : see <a href="#L95" title="utils/mb/Unicode/convutils.pm:95">print_conversion_tables</a><br/></li>
<li></span><span class="Comment"># direction&nbsp;&nbsp; - conversion direction<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L779">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">make_charmap_combined</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$charset</span>, <span class="Identifier">$direction</span>) = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; croak <span class="Constant">&quot;unacceptable direction : </span><span class="Identifier">$direction</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$direction</span> != TO_UNICODE &amp;&amp; <span class="Identifier">$direction</span> != FROM_UNICODE);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@combined</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$c</span> (<span class="Identifier">@$charset</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> (<span class="Identifier">$c-&gt;{</span><span class="Constant">direction</span><span class="Identifier">}</span> != <span class="Identifier">$direction</span> &amp;&amp; <span class="Identifier">$c-&gt;{</span><span class="Constant">direction</span><span class="Identifier">}</span> != BOTH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$c-&gt;{</span><span class="Constant">ucs_second</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$entry</span> = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">utf8</span> =&gt; <a href="#L811" title="utils/mb/Unicode/convutils.pm:811">ucs2utf</a>(<span class="Identifier">$c-&gt;{</span><span class="Constant">ucs</span><span class="Identifier">}</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">utf8_second</span> =&gt; <a href="#L811" title="utils/mb/Unicode/convutils.pm:811">ucs2utf</a>(<span class="Identifier">$c-&gt;{</span><span class="Constant">ucs_second</span><span class="Identifier">}</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">code</span> =&gt; <span class="Identifier">$c-&gt;{</span><span class="Constant">code</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">comment</span> =&gt; <span class="Identifier">$c-&gt;{</span><span class="Constant">comment</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">f</span> =&gt; <span class="Identifier">$c-&gt;{</span><span class="Constant">f</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">l</span> =&gt; <span class="Identifier">$c-&gt;{</span><span class="Constant">l</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@combined</span>, <span class="Identifier">$entry</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> \<span class="Identifier">@combined</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">#######################################################################<br/></li>
<li></span><span class="Comment"># convert UCS-4 to UTF-8<br/></li>
<li></span><span class="Comment">#<br/></li>
<li><a id="L811">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">ucs2utf</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$ucs</span>) = <span class="Identifier">@_</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$utf</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$ucs</span> &lt;= <span class="Constant">0x007f</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$utf</span> = <span class="Identifier">$ucs</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$ucs</span> &gt; <span class="Constant">0x007f</span> &amp;&amp; <span class="Identifier">$ucs</span> &lt;= <span class="Constant">0x07ff</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$utf</span> = ((<span class="Identifier">$ucs</span> &amp; <span class="Constant">0x003f</span>) | <span class="Constant">0x80</span>) | (((<span class="Identifier">$ucs</span> &gt;&gt; <span class="Constant">6</span>) | <span class="Constant">0xc0</span>) &lt;&lt; <span class="Constant">8</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$ucs</span> &gt; <span class="Constant">0x07ff</span> &amp;&amp; <span class="Identifier">$ucs</span> &lt;= <span class="Constant">0xffff</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$utf</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (((<span class="Identifier">$ucs</span> &gt;&gt; <span class="Constant">12</span>) | <span class="Constant">0xe0</span>) &lt;&lt; <span class="Constant">16</span>) |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((((<span class="Identifier">$ucs</span> &amp; <span class="Constant">0x0fc0</span>) &gt;&gt; <span class="Constant">6</span>) | <span class="Constant">0x80</span>) &lt;&lt; <span class="Constant">8</span>) | ((<span class="Identifier">$ucs</span> &amp; <span class="Constant">0x003f</span>) | <span class="Constant">0x80</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$utf</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (((<span class="Identifier">$ucs</span> &gt;&gt; <span class="Constant">18</span>) | <span class="Constant">0xf0</span>) &lt;&lt; <span class="Constant">24</span>) |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((((<span class="Identifier">$ucs</span> &amp; <span class="Constant">0x3ffff</span>) &gt;&gt; <span class="Constant">12</span>) | <span class="Constant">0x80</span>) &lt;&lt; <span class="Constant">16</span>) |<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((((<span class="Identifier">$ucs</span> &amp; <span class="Constant">0x0fc0</span>) &gt;&gt; <span class="Constant">6</span>) | <span class="Constant">0x80</span>) &lt;&lt; <span class="Constant">8</span>) | ((<span class="Identifier">$ucs</span> &amp; <span class="Constant">0x003f</span>) | <span class="Constant">0x80</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Identifier">$utf</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Constant">1</span>;<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
