<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>postmaster/launch_backend.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>postmaster/launch_backend.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L179">child_process_kinds</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L152">BackendParameters</a></li>
<li><a href="#L85">InheritableSocket</a></li>
<li><a href="#L87">InheritableSocket</a></li>
<li><a href="#L177">child_process_kind</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L209">PostmasterChildName</a></li>
<li><a href="#L569">SubPostmasterMain</a></li>
<li><a href="#L282">internal_forkexec</a></li>
<li><a href="#L391">internal_forkexec</a></li>
<li><a href="#L226">postmaster_child_launch</a></li>
<li><a href="#L866">read_backend_variables</a></li>
<li><a href="#L829">read_inheritable_socket</a></li>
<li><a href="#L960">restore_backend_variables</a></li>
<li><a href="#L696">save_backend_variables</a></li>
<li><a href="#L778">write_duplicated_handle</a></li>
<li><a href="#L808">write_inheritable_socket</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L154">SizeOfBackendParameters</a></li>
<li><a href="#L685">read_inheritable_socket</a></li>
<li><a href="#L684">write_inheritable_socket</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * launch_backend.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Functions for launching backends and other postmaster child<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; processes.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * On Unix systems, a new child process is launched with fork().&nbsp; It inherits<br/></li>
<li></span><span class="Comment"> * all the global variables and data structures that had been initialized in<br/></li>
<li></span><span class="Comment"> * the postmaster.&nbsp; After forking, the child process closes the file<br/></li>
<li></span><span class="Comment"> * descriptors that are not needed in the child process, and sets up the<br/></li>
<li></span><span class="Comment"> * mechanism to detect death of the parent postmaster process, etc.&nbsp; After<br/></li>
<li></span><span class="Comment"> * that, it calls the right Main function depending on the kind of child<br/></li>
<li></span><span class="Comment"> * process.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In EXEC_BACKEND mode, which is used on Windows but can be enabled on other<br/></li>
<li></span><span class="Comment"> * platforms for testing, the child process is launched by fork() + exec() (or<br/></li>
<li></span><span class="Comment"> * CreateProcess() on Windows).&nbsp; It does not inherit the state from the<br/></li>
<li></span><span class="Comment"> * postmaster, so it needs to re-attach to the shared memory, re-<a href="../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a><br/></li>
<li></span><span class="Comment"> * global variables, reload the config file etc. to get the process to the<br/></li>
<li></span><span class="Comment"> * same state as after fork() on a Unix system.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2023, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/postmaster/launch_backend.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/xlog.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;common/file_utils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;libpq/libpq-be.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;libpq/pqsignal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;nodes/queryjumble.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;port.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/autovacuum.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/auxprocess.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/bgworker_internals.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/bgwriter.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/<a href="fork_process.c.html#L32" title="postmaster/fork_process.c:32">fork_process</a>.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/pgarch.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/postmaster.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/startup.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/syslogger.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/walsummarizer.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/walwriter.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;replication/slotsync.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;replication/walreceiver.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/fd.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/ipc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/pg_shmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/pmsignal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/proc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;tcop/backend_startup.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;tcop/tcopprot.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/datetime.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/guc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/timestamp.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef EXEC_BACKEND<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;nodes/queryjumble.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/pg_shmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/spin.h&quot;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef EXEC_BACKEND<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* Type for a <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> that can be inherited to a client process */<br/></li>
<li></span><span class="PreProc">#ifdef WIN32<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; SOCKET&nbsp; &nbsp; &nbsp; &nbsp; origsocket;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Original <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> value, or PGINVALID_SOCKET<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * if not a <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> */<br/></li>
<li></span>&nbsp; &nbsp; WSAPROTOCOL_INFO wsainfo;<br/></li>
<li><a id="L85">&#x200c;</a>} <span class="linkable">InheritableSocket</span>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li><a id="L87">&#x200c;</a></span><span class="Type">typedef</span> <span class="Type">int</span> <span class="linkable">InheritableSocket</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Structure contains all variables passed to exec:ed backends<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L68" title="utils/init/globals.c:68">DataDir</a>[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; int32&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L50" title="utils/init/globals.c:50">MyCancelKey</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a>;<br/></li>
<li><span class="PreProc">#ifndef WIN32<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">unsigned</span> <span class="Type">long</span> <a href="../port/win32_shmem.c.html#L44" title="port/win32_shmem.c:44">UsedShmemSegID</a>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *<a href="../port/win32_shmem.c.html#L42" title="port/win32_shmem.c:42">ShmemProtectiveRegion</a>;<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; <a href="../port/win32_shmem.c.html#L44" title="port/win32_shmem.c:44">UsedShmemSegID</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp;&nbsp; *<a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a>;<br/></li>
<li>&nbsp; &nbsp; slock_t&nbsp; &nbsp; *<a href="../storage/ipc/shmem.c.html#L87" title="storage/ipc/shmem.c:87">ShmemLock</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">struct</span> <a href="postmaster.c.html#L168" title="postmaster/postmaster.c:168">bkend</a> *<a href="postmaster.c.html#L182" title="postmaster/postmaster.c:182">ShmemBackendArray</a>;<br/></li>
<li><span class="PreProc">#ifndef HAVE_SPINLOCKS<br/></li>
<li></span>&nbsp; &nbsp; PGSemaphore *<a href="../storage/lmgr/spin.c.html#L42" title="storage/lmgr/spin.c:42">SpinlockSemaArray</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/lmgr/lwlock.c.html#L227" title="storage/lmgr/lwlock.c:227">NamedLWLockTrancheRequests</a>;<br/></li>
<li>&nbsp; &nbsp; NamedLWLockTranche *<a href="../storage/lmgr/lwlock.c.html#L230" title="storage/lmgr/lwlock.c:230">NamedLWLockTrancheArray</a>;<br/></li>
<li>&nbsp; &nbsp; LWLockPadded *<a href="../storage/lmgr/lwlock.c.html#L191" title="storage/lmgr/lwlock.c:191">MainLWLockArray</a>;<br/></li>
<li>&nbsp; &nbsp; slock_t&nbsp; &nbsp; *<a href="../storage/lmgr/proc.c.html#L75" title="storage/lmgr/proc.c:75">ProcStructLock</a>;<br/></li>
<li>&nbsp; &nbsp; PROC_HDR&nbsp;&nbsp; *<a href="../storage/lmgr/proc.c.html#L78" title="storage/lmgr/proc.c:78">ProcGlobal</a>;<br/></li>
<li>&nbsp; &nbsp; PGPROC&nbsp; &nbsp; &nbsp;&nbsp; *<a href="../storage/lmgr/proc.c.html#L79" title="storage/lmgr/proc.c:79">AuxiliaryProcs</a>;<br/></li>
<li>&nbsp; &nbsp; PGPROC&nbsp; &nbsp; &nbsp;&nbsp; *<a href="../storage/lmgr/proc.c.html#L80" title="storage/lmgr/proc.c:80">PreparedXactProcs</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/ipc/pmsignal.c.html#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> *<a href="../storage/ipc/pmsignal.c.html#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>;<br/></li>
<li>&nbsp; &nbsp; pid_t&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L103" title="utils/init/globals.c:103">PostmasterPid</a>;<br/></li>
<li>&nbsp; &nbsp; TimestampTz <a href="../utils/adt/timestamp.c.html#L52" title="utils/adt/timestamp.c:52">PgStartTime</a>;<br/></li>
<li>&nbsp; &nbsp; TimestampTz <a href="../utils/adt/timestamp.c.html#L55" title="utils/adt/timestamp.c:55">PgReloadTime</a>;<br/></li>
<li>&nbsp; &nbsp; pg_time_t&nbsp; &nbsp; <a href="syslogger.c.html#L89" title="postmaster/syslogger.c:89">first_syslogger_file_time</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="postmaster.c.html#L353" title="postmaster/postmaster.c:353">redirection_done</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L118" title="utils/init/globals.c:118">IsBinaryUpgrade</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../nodes/queryjumblefuncs.c.html#L52" title="nodes/queryjumblefuncs.c:52">query_id_enabled</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/file/fd.c.html#L159" title="storage/file/fd.c:159">max_safe_fds</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a>;<br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; <a href="postmaster.c.html#L482" title="postmaster/postmaster.c:482">PostmasterHandle</a>;<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; initial_signal_pipe;<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; <a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>[<span class="Constant">2</span>];<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>[<span class="Constant">2</span>];<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L78" title="utils/init/globals.c:78">my_exec_path</a>[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>[MAXPGPATH];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * These are only used by backend processes, but are here because passing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * a <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> needs some special handling on Windows. 'client_sock' is an<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * explicit argument to <a href="#L226" title="postmaster/launch_backend.c:226">postmaster_child_launch</a>, but is stored in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../utils/init/globals.c.html#L48" title="utils/init/globals.c:48">MyClientSocket</a> in the child process.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; ClientSocket client_sock;<br/></li>
<li>&nbsp; &nbsp; <a href="#L85" title="postmaster/launch_backend.c:85">InheritableSocket</a> inh_sock;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Extra startup data, content depends on the child process.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; startup_data_len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; startup_data[FLEXIBLE_ARRAY_MEMBER];<br/></li>
<li><a id="L152">&#x200c;</a>} <span class="linkable">BackendParameters</span>;<br/></li>
<li><br/></li>
<li><a id="L154">&#x200c;</a><span class="PreProc">#define <span class="linkable">SizeOfBackendParameters</span>(startup_data_len) (offsetof(<a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a>, startup_data) + startup_data_len)<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L866" title="postmaster/launch_backend.c:866">read_backend_variables</a>(<span class="Type">char</span> *id, <span class="Type">char</span> **startup_data, <span class="Type">size_t</span> *startup_data_len);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L960" title="postmaster/launch_backend.c:960">restore_backend_variables</a>(<a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *param);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L696" title="postmaster/launch_backend.c:696">save_backend_variables</a>(<a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *param, ClientSocket *client_sock,<br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HANDLE childProcess, pid_t childPid,<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len);<br/></li>
<li><br/></li>
<li><span class="Type">static</span> pid_t <a href="#L282" title="postmaster/launch_backend.c:282">internal_forkexec</a>(<span class="Type">const</span> <span class="Type">char</span> *child_kind, <span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len, ClientSocket *client_sock);<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* EXEC_BACKEND */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Information needed to launch different kinds of child processes.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *name;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">void</span>&nbsp; &nbsp; &nbsp; &nbsp; (*main_fn) (<span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len) pg_attribute_noreturn();<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; shmem_attach;<br/></li>
<li><a id="L177">&#x200c;</a>} <span class="linkable">child_process_kind</span>;<br/></li>
<li><br/></li>
<li><a id="L179">&#x200c;</a><a href="#L177" title="postmaster/launch_backend.c:177">child_process_kind</a> <span class="linkable">child_process_kinds</span>[] = {<br/></li>
<li>&nbsp; &nbsp; [B_INVALID] = {<span class="Constant">&quot;invalid&quot;</span>, <span class="Constant">NULL</span>, <span class="Constant">false</span>},<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [B_BACKEND] = {<span class="Constant">&quot;backend&quot;</span>, <a href="../tcop/backend_startup.c.html#L57" title="tcop/backend_startup.c:57">BackendMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_AUTOVAC_LAUNCHER] = {<span class="Constant">&quot;autovacuum launcher&quot;</span>, <a href="autovacuum.c.html#L361" title="postmaster/autovacuum.c:361">AutoVacLauncherMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_AUTOVAC_WORKER] = {<span class="Constant">&quot;autovacuum worker&quot;</span>, <a href="autovacuum.c.html#L1359" title="postmaster/autovacuum.c:1359">AutoVacWorkerMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_BG_WORKER] = {<span class="Constant">&quot;bgworker&quot;</span>, <a href="bgworker.c.html#L723" title="postmaster/bgworker.c:723">BackgroundWorkerMain</a>, <span class="Constant">true</span>},<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * WAL senders start their life as regular backend processes, and change<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * their type after authenticating the client for replication.&nbsp; We list it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * here for <a href="#L209" title="postmaster/launch_backend.c:209">PostmasterChildName</a>() but cannot launch them directly.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; [B_WAL_SENDER] = {<span class="Constant">&quot;wal sender&quot;</span>, <span class="Constant">NULL</span>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_SLOTSYNC_WORKER] = {<span class="Constant">&quot;slot sync worker&quot;</span>, <a href="../replication/logical/slotsync.c.html#L1331" title="replication/logical/slotsync.c:1331">ReplSlotSyncWorkerMain</a>, <span class="Constant">true</span>},<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [B_STANDALONE_BACKEND] = {<span class="Constant">&quot;standalone backend&quot;</span>, <span class="Constant">NULL</span>, <span class="Constant">false</span>},<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [B_ARCHIVER] = {<span class="Constant">&quot;archiver&quot;</span>, <a href="pgarch.c.html#L217" title="postmaster/pgarch.c:217">PgArchiverMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_BG_WRITER] = {<span class="Constant">&quot;bgwriter&quot;</span>, <a href="bgwriter.c.html#L87" title="postmaster/bgwriter.c:87">BackgroundWriterMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_CHECKPOINTER] = {<span class="Constant">&quot;checkpointer&quot;</span>, <a href="checkpointer.c.html#L173" title="postmaster/checkpointer.c:173">CheckpointerMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_STARTUP] = {<span class="Constant">&quot;startup&quot;</span>, <a href="startup.c.html#L216" title="postmaster/startup.c:216">StartupProcessMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_WAL_RECEIVER] = {<span class="Constant">&quot;wal_receiver&quot;</span>, <a href="../replication/walreceiver.c.html#L183" title="replication/walreceiver.c:183">WalReceiverMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_WAL_SUMMARIZER] = {<span class="Constant">&quot;wal_summarizer&quot;</span>, <a href="walsummarizer.c.html#L210" title="postmaster/walsummarizer.c:210">WalSummarizerMain</a>, <span class="Constant">true</span>},<br/></li>
<li>&nbsp; &nbsp; [B_WAL_WRITER] = {<span class="Constant">&quot;wal_writer&quot;</span>, <a href="walwriter.c.html#L89" title="postmaster/walwriter.c:89">WalWriterMain</a>, <span class="Constant">true</span>},<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; [B_LOGGER] = {<span class="Constant">&quot;syslogger&quot;</span>, <a href="syslogger.c.html#L167" title="postmaster/syslogger.c:167">SysLoggerMain</a>, <span class="Constant">false</span>},<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Type">const</span> <span class="Type">char</span> *<br/></li>
<li><a id="L209">&#x200c;</a><span class="linkable">PostmasterChildName</span>(BackendType child_type)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>[child_type].name;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Start a new postmaster child process.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The child process will be restored to roughly the same state whether<br/></li>
<li></span><span class="Comment"> * EXEC_BACKEND is used or not: it will be attached to shared memory, and fds<br/></li>
<li></span><span class="Comment"> * and other resources that we've inherited from postmaster that are not<br/></li>
<li></span><span class="Comment"> * needed in a child process have been closed.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * 'startup_data' is an optional contiguous chunk of data that is passed to<br/></li>
<li></span><span class="Comment"> * the child process.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>pid_t<br/></li>
<li><a id="L226">&#x200c;</a><span class="linkable">postmaster_child_launch</span>(BackendType child_type,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ClientSocket *client_sock)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; pid_t&nbsp; &nbsp; &nbsp; &nbsp; pid;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(<a href="../utils/init/globals.c.html#L116" title="utils/init/globals.c:116">IsPostmasterEnvironment</a> &amp;&amp; !<a href="../utils/init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a>);<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef EXEC_BACKEND<br/></li>
<li></span>&nbsp; &nbsp; pid = <a href="#L282" title="postmaster/launch_backend.c:282">internal_forkexec</a>(<a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>[child_type].name,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; startup_data, startup_data_len, client_sock);<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* the child process will arrive in <a href="#L569" title="postmaster/launch_backend.c:569">SubPostmasterMain</a> */<br/></li>
<li></span><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* !EXEC_BACKEND */<br/></li>
<li></span>&nbsp; &nbsp; pid = <a href="fork_process.c.html#L32" title="postmaster/fork_process.c:32">fork_process</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pid == <span class="Constant">0</span>)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* child */<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Close the postmaster's sockets */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="postmaster.c.html#L1955" title="postmaster/postmaster.c:1955">ClosePostmasterPorts</a>(child_type == B_LOGGER);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Detangle from postmaster */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/miscinit.c.html#L95" title="utils/init/miscinit.c:95">InitPostmasterChild</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Enter the Main function with <a href="../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>.&nbsp; The startup data is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * allocated in <a href="../utils/mmgr/mcxt.c.html#L151" title="utils/mmgr/mcxt.c:151">PostmasterContext</a>, so we cannot release it here yet.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The Main function will do it after it's done handling the startup<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * data.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(<a href="../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (client_sock)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L48" title="utils/init/globals.c:48">MyClientSocket</a> = <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(<span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ClientSocket));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memcpy(<a href="../utils/init/globals.c.html#L48" title="utils/init/globals.c:48">MyClientSocket</a>, client_sock, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ClientSocket));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Run the appropriate Main function<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>[child_type].main_fn(startup_data, startup_data_len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pg_unreachable();&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* main_fn never returns */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* EXEC_BACKEND */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> pid;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef EXEC_BACKEND<br/></li>
<li></span><span class="PreProc">#ifndef WIN32<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L282" title="postmaster/launch_backend.c:282">internal_forkexec</a> non-win32 implementation<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * - writes out backend variables to the parameter file<br/></li>
<li></span><span class="Comment"> * - fork():s, and then exec():s the child process<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> pid_t<br/></li>
<li><a id="L282">&#x200c;</a><span class="linkable">internal_forkexec</span>(<span class="Type">const</span> <span class="Type">char</span> *child_kind, <span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len, ClientSocket *client_sock)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">static</span> <span class="Type">unsigned</span> <span class="Type">long</span> tmpBackendFileNum = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; pid_t&nbsp; &nbsp; &nbsp; &nbsp; pid;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; tmpfilename[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; paramsz;<br/></li>
<li>&nbsp; &nbsp; <a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *param;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">FILE</span>&nbsp; &nbsp; &nbsp;&nbsp; *fp;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *argv[<span class="Constant">4</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; forkav[MAXPGPATH];<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Use <a href="../utils/mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a> to make sure padding bytes are initialized, to prevent<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Valgrind from complaining about writing uninitialized bytes to the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * file.&nbsp; This isn't performance critical, and the win32 implementation<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * initializes the padding bytes to zeros, so do it even when not using<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Valgrind.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; paramsz = <a href="#L154" title="postmaster/launch_backend.c:154">SizeOfBackendParameters</a>(startup_data_len);<br/></li>
<li>&nbsp; &nbsp; param = <a href="../utils/mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(paramsz);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L696" title="postmaster/launch_backend.c:696">save_backend_variables</a>(param, client_sock, startup_data, startup_data_len))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(param);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* log made by <a href="#L696" title="postmaster/launch_backend.c:696">save_backend_variables</a> */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Calculate name for temp file */<br/></li>
<li></span>&nbsp; &nbsp; snprintf(tmpfilename, MAXPGPATH, <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">.backend_var.</span><span class="Special">%d</span><span class="Constant">.</span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; PG_TEMP_FILES_DIR, PG_TEMP_FILE_PREFIX,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/init/globals.c.html#L45" title="utils/init/globals.c:45">MyProcPid</a>, ++tmpBackendFileNum);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Open file */<br/></li>
<li></span>&nbsp; &nbsp; fp = <a href="../storage/file/fd.c.html#L2583" title="storage/file/fd.c:2583">AllocateFile</a>(tmpfilename, PG_BINARY_W);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!fp)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * As in <a href="../storage/file/fd.c.html#L1804" title="storage/file/fd.c:1804">OpenTemporaryFileInTablespace</a>, try to make the temp-file<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * directory, ignoring errors.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">void</span>) <a href="../storage/file/fd.c.html#L3913" title="storage/file/fd.c:3913">MakePGDirectory</a>(PG_TEMP_FILES_DIR);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; fp = <a href="../storage/file/fd.c.html#L2583" title="storage/file/fd.c:2583">AllocateFile</a>(tmpfilename, PG_BINARY_W);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!fp)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not create file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpfilename)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(param);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fwrite(param, paramsz, <span class="Constant">1</span>, fp) != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not write to file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>, tmpfilename)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(fp);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(param);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(param);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release file */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(fp))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not write to file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>, tmpfilename)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* set up argv properly */<br/></li>
<li></span>&nbsp; &nbsp; argv[<span class="Constant">0</span>] = <span class="Constant">&quot;postgres&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; snprintf(forkav, MAXPGPATH, <span class="Constant">&quot;--forkchild=</span><span class="Special">%s</span><span class="Constant">&quot;</span>, child_kind);<br/></li>
<li>&nbsp; &nbsp; argv[<span class="Constant">1</span>] = forkav;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* <a href="../storage/file/fd.c.html#L1313" title="storage/file/fd.c:1313">Insert</a> temp file name after --forkchild argument */<br/></li>
<li></span>&nbsp; &nbsp; argv[<span class="Constant">2</span>] = tmpfilename;<br/></li>
<li>&nbsp; &nbsp; argv[<span class="Constant">3</span>] = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Fire off execv in child */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> ((pid = <a href="fork_process.c.html#L32" title="postmaster/fork_process.c:32">fork_process</a>()) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (execv(<a href="../utils/init/globals.c.html#L82" title="utils/init/globals.c:82">postgres_exec_path</a>, argv) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not execute server process </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L82" title="utils/init/globals.c:82">postgres_exec_path</a>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* We're already in the child process here, can't return */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> pid;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Parent returns pid, or -1 on fork failure */<br/></li>
<li></span>}<br/></li>
<li><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* WIN32 */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L282" title="postmaster/launch_backend.c:282">internal_forkexec</a> win32 implementation<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * - starts backend using CreateProcess(), in suspended state<br/></li>
<li></span><span class="Comment"> * - writes out backend variables to the parameter file<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; - during this, duplicates handles and sockets required for<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; inheritance into the new process<br/></li>
<li></span><span class="Comment"> * - resumes execution of the new process once the backend parameter<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp;&nbsp; file is complete.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> pid_t<br/></li>
<li><a id="L391">&#x200c;</a><span class="linkable">internal_forkexec</span>(<span class="Type">const</span> <span class="Type">char</span> *child_kind, <span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len, ClientSocket *client_sock)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retry_count = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; STARTUPINFO si;<br/></li>
<li>&nbsp; &nbsp; PROCESS_INFORMATION pi;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; cmdLine[MAXPGPATH * <span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; paramHandle;<br/></li>
<li>&nbsp; &nbsp; <a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *param;<br/></li>
<li>&nbsp; &nbsp; SECURITY_ATTRIBUTES sa;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; paramsz;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; paramHandleStr[<span class="Constant">32</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; paramsz = <a href="#L154" title="postmaster/launch_backend.c:154">SizeOfBackendParameters</a>(startup_data_len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Resume here if we need to retry */<br/></li>
<li></span><span class="Statement">retry</span><span class="cUserCont">:<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set up shared memory for parameter passing */<br/></li>
<li></span>&nbsp; &nbsp; ZeroMemory(&amp;sa, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(sa));<br/></li>
<li>&nbsp; &nbsp; sa.nLength = <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(sa);<br/></li>
<li>&nbsp; &nbsp; sa.bInheritHandle = TRUE;<br/></li>
<li>&nbsp; &nbsp; paramHandle = CreateFileMapping(INVALID_HANDLE_VALUE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;sa,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PAGE_READWRITE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; paramsz,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (paramHandle == INVALID_HANDLE_VALUE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not create backend parameter file mapping: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; param = MapViewOfFile(paramHandle, FILE_MAP_WRITE, <span class="Constant">0</span>, <span class="Constant">0</span>, paramsz);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!param)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not map backend parameter memory: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(paramHandle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Format the cmd line */<br/></li>
<li></span><span class="PreProc">#ifdef _WIN64<br/></li>
<li></span>&nbsp; &nbsp; sprintf(paramHandleStr, <span class="Constant">&quot;</span><span class="Special">%llu</span><span class="Constant">&quot;</span>, (LONG_PTR) paramHandle);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; sprintf(paramHandleStr, <span class="Constant">&quot;</span><span class="Special">%lu</span><span class="Constant">&quot;</span>, (DWORD) paramHandle);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; l = snprintf(cmdLine, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(cmdLine) - <span class="Constant">1</span>, <span class="Constant">&quot;</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> --forkchild=</span><span class="Special">\&quot;%s\&quot;</span><span class="Constant"> </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/init/globals.c.html#L82" title="utils/init/globals.c:82">postgres_exec_path</a>, child_kind, paramHandleStr);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (l &gt;= <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(cmdLine))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;subprocess command line too long&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; UnmapViewOfFile(param);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(paramHandle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memset(&amp;pi, <span class="Constant">0</span>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pi));<br/></li>
<li>&nbsp; &nbsp; memset(&amp;si, <span class="Constant">0</span>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(si));<br/></li>
<li>&nbsp; &nbsp; si.cb = <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(si);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Create the subprocess in a suspended state. This will be resumed later,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * once we have written out the parameter file.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!CreateProcess(<span class="Constant">NULL</span>, cmdLine, <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, TRUE, CREATE_SUSPENDED,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">NULL</span>, <span class="Constant">NULL</span>, &amp;si, &amp;pi))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;CreateProcess() call failed: %m (error code </span><span class="Special">%lu</span><span class="Constant">)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; UnmapViewOfFile(param);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(paramHandle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L696" title="postmaster/launch_backend.c:696">save_backend_variables</a>(param, client_sock, pi.hProcess, pi.dwProcessId, startup_data, startup_data_len))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * log made by <a href="#L696" title="postmaster/launch_backend.c:696">save_backend_variables</a>, but we have to clean up the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * mess with the half-started process<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!TerminateProcess(pi.hProcess, <span class="Constant">255</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1159" title="utils/error/elog.c:1159">errmsg_internal</a>(<span class="Constant">&quot;could not terminate unstarted process: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hProcess);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hThread);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; UnmapViewOfFile(param);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(paramHandle);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* log made by <a href="#L696" title="postmaster/launch_backend.c:696">save_backend_variables</a> */<br/></li>
<li></span>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Drop the parameter shared memory that is <a href="../utils/adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> inherited to the backend */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!UnmapViewOfFile(param))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not unmap view of backend parameter file: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!CloseHandle(paramHandle))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not close handle to backend parameter file: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Reserve the memory region used by our <a href="../storage/lmgr/s_lock.c.html#L257" title="storage/lmgr/s_lock.c:257">main</a> shared memory segment <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we resume the child process.&nbsp; Normally this should succeed, but if ASLR<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * is active then it might sometimes fail due to the stack or heap having<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * gotten mapped into that <a href="../regex/regc_locale.c.html#L412" title="regex/regc_locale.c:412">range</a>.&nbsp; In that case, just terminate the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * process and retry.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../port/win32_shmem.c.html#L573" title="port/win32_shmem.c:573">pgwin32_ReserveSharedMemoryRegion</a>(pi.hProcess))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../port/win32_shmem.c.html#L573" title="port/win32_shmem.c:573">pgwin32_ReserveSharedMemoryRegion</a> already made a log entry */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!TerminateProcess(pi.hProcess, <span class="Constant">255</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1159" title="utils/error/elog.c:1159">errmsg_internal</a>(<span class="Constant">&quot;could not terminate process that failed to reserve memory: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hProcess);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hThread);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (++retry_count &lt; <span class="Constant">100</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">goto</span> retry;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;giving up after too many tries to reserve shared memory&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1319" title="utils/error/elog.c:1319">errhint</a>(<span class="Constant">&quot;This might be caused by ASLR or antivirus software.&quot;</span>)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Now that the backend variables are written out, we start the child<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * thread so it can start initializing while we set up the rest of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * parent state.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (ResumeThread(pi.hThread) == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!TerminateProcess(pi.hProcess, <span class="Constant">255</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1159" title="utils/error/elog.c:1159">errmsg_internal</a>(<span class="Constant">&quot;could not terminate unstartable process: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hProcess);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hThread);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hProcess);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(pi.hThread);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1159" title="utils/error/elog.c:1159">errmsg_internal</a>(<span class="Constant">&quot;could not resume thread of unstarted process: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> -<span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set up notification when the child process dies */<br/></li>
<li></span>&nbsp; &nbsp; <a href="postmaster.c.html#L4675" title="postmaster/postmaster.c:4675">pgwin32_register_deadchild_callback</a>(pi.hProcess, pi.dwProcessId);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Don't close pi.hProcess, it's owned by the deadchild callback <a href="../utils/adt/timestamp.c.html#L1618" title="utils/adt/timestamp.c:1618">now</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; CloseHandle(pi.hThread);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> pi.dwProcessId;<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* WIN32 */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L569" title="postmaster/launch_backend.c:569">SubPostmasterMain</a> -- Get the fork/exec'd process into a state equivalent<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to what it would be if we'd simply forked on Unix, and then<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dispatch to the appropriate place.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The first two command line arguments are expected to be &quot;--forkchild=&lt;name&gt;&quot;,<br/></li>
<li></span><span class="Comment"> * where &lt;name&gt; indicates which postmaster child we are to become, and<br/></li>
<li></span><span class="Comment"> * the name of a variables file that we can read to load data that would<br/></li>
<li></span><span class="Comment"> * have been inherited by fork() on Unix.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L569">&#x200c;</a></span><span class="linkable">SubPostmasterMain</span>(<span class="Type">int</span> argc, <span class="Type">char</span> *argv[])<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *startup_data;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; startup_data_len;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp;&nbsp; *child_kind;<br/></li>
<li>&nbsp; &nbsp; BackendType child_type;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* In EXEC_BACKEND case we will not have inherited these settings */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/init/globals.c.html#L116" title="utils/init/globals.c:116">IsPostmasterEnvironment</a> = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="../tcop/postgres.c.html#L90" title="tcop/postgres.c:90">whereToSendOutput</a> = DestNone;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Setup essential subsystems (to ensure elog() behaves sanely) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/misc/guc.c.html#L1532" title="utils/misc/guc.c:1532">InitializeGUCOptions</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check we got appropriate args */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (argc != <span class="Constant">3</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(FATAL, <span class="Constant">&quot;invalid subpostmaster invocation&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Find the entry in <a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (strncmp(argv[<span class="Constant">1</span>], <span class="Constant">&quot;--forkchild=&quot;</span>, <span class="Constant">12</span>) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(FATAL, <span class="Constant">&quot;invalid subpostmaster invocation (--forkchild argument missing)&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; child_kind = argv[<span class="Constant">1</span>] + <span class="Constant">12</span>;<br/></li>
<li>&nbsp; &nbsp; found = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (<span class="Type">int</span> idx = <span class="Constant">0</span>; idx &lt; lengthof(<a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>); idx++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (strcmp(<a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>[idx].name, child_kind) == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; child_type = (BackendType) idx;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; found = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;unknown child kind </span><span class="Special">%s</span><span class="Constant">&quot;</span>, child_kind);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Read in the variables file */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L866" title="postmaster/launch_backend.c:866">read_backend_variables</a>(argv[<span class="Constant">2</span>], &amp;startup_data, &amp;startup_data_len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Close the postmaster's sockets (as soon as we know them) */<br/></li>
<li></span>&nbsp; &nbsp; <a href="postmaster.c.html#L1955" title="postmaster/postmaster.c:1955">ClosePostmasterPorts</a>(child_type == B_LOGGER);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Setup as postmaster child */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/init/miscinit.c.html#L95" title="utils/init/miscinit.c:95">InitPostmasterChild</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If appropriate, physically re-attach to shared memory segment. We want<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * to do this <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> going <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> further to ensure that we can attach at the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * same address the postmaster used.&nbsp; On the other hand, if we choose not<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * to re-attach, we may have other <a href="../regex/regc_nfa.c.html#L2929" title="regex/regc_nfa.c:2929">cleanup</a> to do.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If testing EXEC_BACKEND on Linux, you should run this as root <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * starting the postmaster:<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * sysctl -w kernel.randomize_va_space=0<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * This prevents using randomized stack and code addresses that cause the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * child process's memory map to be different from the parent's, making it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * sometimes impossible to attach to shared memory at the desired address.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Return the setting to its old value (usually '1' or '2') when finished.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>[child_type].shmem_attach)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../port/win32_shmem.c.html#L424" title="port/win32_shmem.c:424">PGSharedMemoryReAttach</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../port/win32_shmem.c.html#L472" title="port/win32_shmem.c:472">PGSharedMemoryNoReAttach</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Read in remaining GUC variables */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/misc/guc.c.html#L5694" title="utils/misc/guc.c:5694">read_nondefault_variables</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Check that the data directory looks valid, which will also check the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * privileges on the data directory and update our umask and file/group<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * variables for creating files later.&nbsp; Note: this should really be done<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> we create <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> files or directories.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/init/miscinit.c.html#L341" title="utils/init/miscinit.c:341">checkDataDir</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * (re-)read control file, as it contains config. The postmaster will<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * already have read this, but this process doesn't know about that.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../access/transam/xlog.c.html#L4813" title="access/transam/xlog.c:4813">LocalProcessControlFile</a>(<span class="Constant">false</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Reload <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> libraries that were preloaded by the postmaster.&nbsp; Since we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * exec'd this process, those libraries didn't come along with us; but we<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * should load them into all child processes to be consistent with the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * non-EXEC_BACKEND behavior.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/init/miscinit.c.html#L1843" title="utils/init/miscinit.c:1843">process_shared_preload_libraries</a>();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Restore basic shared memory pointers */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a> != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/ipc/shmem.c.html#L100" title="storage/ipc/shmem.c:100">InitShmemAccess</a>(<a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Run the appropriate Main function<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L179" title="postmaster/launch_backend.c:179">child_process_kinds</a>[child_type].main_fn(startup_data, startup_data_len);<br/></li>
<li>&nbsp; &nbsp; pg_unreachable();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* main_fn never returns */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The following need to be available to the save/<a href="#L960" title="postmaster/launch_backend.c:960">restore_backend_variables</a><br/></li>
<li></span><span class="Comment"> * <a href="../regex/regcomp.c.html#L356" title="regex/regcomp.c:356">functions</a>.&nbsp; They are marked NON_EXEC_STATIC in their home modules.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">extern</span> slock_t *<a href="../storage/ipc/shmem.c.html#L87" title="storage/ipc/shmem.c:87">ShmemLock</a>;<br/></li>
<li><span class="Type">extern</span> slock_t *<a href="../storage/lmgr/proc.c.html#L75" title="storage/lmgr/proc.c:75">ProcStructLock</a>;<br/></li>
<li><span class="Type">extern</span> PGPROC *<a href="../storage/lmgr/proc.c.html#L79" title="storage/lmgr/proc.c:79">AuxiliaryProcs</a>;<br/></li>
<li><span class="Type">extern</span> <a href="../storage/ipc/pmsignal.c.html#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> *<a href="../storage/ipc/pmsignal.c.html#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>;<br/></li>
<li><span class="Type">extern</span> pg_time_t <a href="syslogger.c.html#L89" title="postmaster/syslogger.c:89">first_syslogger_file_time</a>;<br/></li>
<li><span class="Type">extern</span> <span class="Type">struct</span> <a href="postmaster.c.html#L168" title="postmaster/postmaster.c:168">bkend</a> *<a href="postmaster.c.html#L182" title="postmaster/postmaster.c:182">ShmemBackendArray</a>;<br/></li>
<li><span class="Type">extern</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="postmaster.c.html#L353" title="postmaster/postmaster.c:353">redirection_done</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef WIN32<br/></li>
<li><a id="L684">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">write_inheritable_socket</span>(dest, src, childpid) ((*(dest) = (src)), </span><span class="Constant">true</span><span class="PreProc">)<br/></li>
<li><a id="L685">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">read_inheritable_socket</span>(dest, src) (*(dest) = *(src))<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L778" title="postmaster/launch_backend.c:778">write_duplicated_handle</a>(HANDLE *dest, HANDLE src, HANDLE child);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L684" title="postmaster/launch_backend.c:684">write_inheritable_socket</a>(<a href="#L85" title="postmaster/launch_backend.c:85">InheritableSocket</a> *dest, SOCKET src,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pid_t childPid);<br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L685" title="postmaster/launch_backend.c:685">read_inheritable_socket</a>(SOCKET *dest, <a href="#L85" title="postmaster/launch_backend.c:85">InheritableSocket</a> *src);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/* Save critical backend variables into the <a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> struct */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L696">&#x200c;</a></span><span class="linkable">save_backend_variables</span>(<a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *param, ClientSocket *client_sock,<br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; HANDLE childProcess, pid_t childPid,<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Type">char</span> *startup_data, <span class="Type">size_t</span> startup_data_len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (client_sock)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(&amp;param-&gt;client_sock, client_sock, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ClientSocket));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; memset(&amp;param-&gt;client_sock, <span class="Constant">0</span>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ClientSocket));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L684" title="postmaster/launch_backend.c:684">write_inheritable_socket</a>(&amp;param-&gt;inh_sock,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client_sock ? client_sock-&gt;sock : PGINVALID_SOCKET,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; childPid))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; strlcpy(param-&gt;<a href="../utils/init/globals.c.html#L68" title="utils/init/globals.c:68">DataDir</a>, <a href="../utils/init/globals.c.html#L68" title="utils/init/globals.c:68">DataDir</a>, MAXPGPATH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/init/globals.c.html#L50" title="utils/init/globals.c:50">MyCancelKey</a> = <a href="../utils/init/globals.c.html#L50" title="utils/init/globals.c:50">MyCancelKey</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a> = <a href="../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; param-&gt;<a href="../port/win32_shmem.c.html#L42" title="port/win32_shmem.c:42">ShmemProtectiveRegion</a> = <a href="../port/win32_shmem.c.html#L42" title="port/win32_shmem.c:42">ShmemProtectiveRegion</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; param-&gt;<a href="../port/win32_shmem.c.html#L44" title="port/win32_shmem.c:44">UsedShmemSegID</a> = <a href="../port/win32_shmem.c.html#L44" title="port/win32_shmem.c:44">UsedShmemSegID</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a> = <a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/ipc/shmem.c.html#L87" title="storage/ipc/shmem.c:87">ShmemLock</a> = <a href="../storage/ipc/shmem.c.html#L87" title="storage/ipc/shmem.c:87">ShmemLock</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="postmaster.c.html#L182" title="postmaster/postmaster.c:182">ShmemBackendArray</a> = <a href="postmaster.c.html#L182" title="postmaster/postmaster.c:182">ShmemBackendArray</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef HAVE_SPINLOCKS<br/></li>
<li></span>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/spin.c.html#L42" title="storage/lmgr/spin.c:42">SpinlockSemaArray</a> = <a href="../storage/lmgr/spin.c.html#L42" title="storage/lmgr/spin.c:42">SpinlockSemaArray</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/lwlock.c.html#L227" title="storage/lmgr/lwlock.c:227">NamedLWLockTrancheRequests</a> = <a href="../storage/lmgr/lwlock.c.html#L227" title="storage/lmgr/lwlock.c:227">NamedLWLockTrancheRequests</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/lwlock.c.html#L230" title="storage/lmgr/lwlock.c:230">NamedLWLockTrancheArray</a> = <a href="../storage/lmgr/lwlock.c.html#L230" title="storage/lmgr/lwlock.c:230">NamedLWLockTrancheArray</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/lwlock.c.html#L191" title="storage/lmgr/lwlock.c:191">MainLWLockArray</a> = <a href="../storage/lmgr/lwlock.c.html#L191" title="storage/lmgr/lwlock.c:191">MainLWLockArray</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/proc.c.html#L75" title="storage/lmgr/proc.c:75">ProcStructLock</a> = <a href="../storage/lmgr/proc.c.html#L75" title="storage/lmgr/proc.c:75">ProcStructLock</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/proc.c.html#L78" title="storage/lmgr/proc.c:78">ProcGlobal</a> = <a href="../storage/lmgr/proc.c.html#L78" title="storage/lmgr/proc.c:78">ProcGlobal</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/proc.c.html#L79" title="storage/lmgr/proc.c:79">AuxiliaryProcs</a> = <a href="../storage/lmgr/proc.c.html#L79" title="storage/lmgr/proc.c:79">AuxiliaryProcs</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/lmgr/proc.c.html#L80" title="storage/lmgr/proc.c:80">PreparedXactProcs</a> = <a href="../storage/lmgr/proc.c.html#L80" title="storage/lmgr/proc.c:80">PreparedXactProcs</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/ipc/pmsignal.c.html#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a> = <a href="../storage/ipc/pmsignal.c.html#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/init/globals.c.html#L103" title="utils/init/globals.c:103">PostmasterPid</a> = <a href="../utils/init/globals.c.html#L103" title="utils/init/globals.c:103">PostmasterPid</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/adt/timestamp.c.html#L52" title="utils/adt/timestamp.c:52">PgStartTime</a> = <a href="../utils/adt/timestamp.c.html#L52" title="utils/adt/timestamp.c:52">PgStartTime</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/adt/timestamp.c.html#L55" title="utils/adt/timestamp.c:55">PgReloadTime</a> = <a href="../utils/adt/timestamp.c.html#L55" title="utils/adt/timestamp.c:55">PgReloadTime</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="syslogger.c.html#L89" title="postmaster/syslogger.c:89">first_syslogger_file_time</a> = <a href="syslogger.c.html#L89" title="postmaster/syslogger.c:89">first_syslogger_file_time</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="postmaster.c.html#L353" title="postmaster/postmaster.c:353">redirection_done</a> = <a href="postmaster.c.html#L353" title="postmaster/postmaster.c:353">redirection_done</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/init/globals.c.html#L118" title="utils/init/globals.c:118">IsBinaryUpgrade</a> = <a href="../utils/init/globals.c.html#L118" title="utils/init/globals.c:118">IsBinaryUpgrade</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../nodes/queryjumblefuncs.c.html#L52" title="nodes/queryjumblefuncs.c:52">query_id_enabled</a> = <a href="../nodes/queryjumblefuncs.c.html#L52" title="nodes/queryjumblefuncs.c:52">query_id_enabled</a>;<br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../storage/file/fd.c.html#L159" title="storage/file/fd.c:159">max_safe_fds</a> = <a href="../storage/file/fd.c.html#L159" title="storage/file/fd.c:159">max_safe_fds</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;<a href="../utils/init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a> = <a href="../utils/init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; param-&gt;<a href="postmaster.c.html#L482" title="postmaster/postmaster.c:482">PostmasterHandle</a> = <a href="postmaster.c.html#L482" title="postmaster/postmaster.c:482">PostmasterHandle</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L778" title="postmaster/launch_backend.c:778">write_duplicated_handle</a>(&amp;param-&gt;initial_signal_pipe,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../port/win32/signal.c.html#L227" title="port/win32/signal.c:227">pgwin32_create_signal_listener</a>(childPid),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; childProcess))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; memcpy(&amp;param-&gt;<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>, &amp;<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; memcpy(&amp;param-&gt;<a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>, &amp;<a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; strlcpy(param-&gt;<a href="../utils/init/globals.c.html#L78" title="utils/init/globals.c:78">my_exec_path</a>, <a href="../utils/init/globals.c.html#L78" title="utils/init/globals.c:78">my_exec_path</a>, MAXPGPATH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; strlcpy(param-&gt;<a href="../utils/init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>, <a href="../utils/init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>, MAXPGPATH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; param-&gt;startup_data_len = startup_data_len;<br/></li>
<li>&nbsp; &nbsp; memcpy(param-&gt;startup_data, startup_data, startup_data_len);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Duplicate a handle for usage in a child process, and write the child<br/></li>
<li></span><span class="Comment"> * process instance of the handle to the parameter file.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L778">&#x200c;</a></span><span class="linkable">write_duplicated_handle</span>(HANDLE *dest, HANDLE src, HANDLE childProcess)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; hChild = INVALID_HANDLE_VALUE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!DuplicateHandle(GetCurrentProcess(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; src,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; childProcess,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &amp;hChild,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TRUE,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; DUPLICATE_CLOSE_SOURCE | DUPLICATE_SAME_ACCESS))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1159" title="utils/error/elog.c:1159">errmsg_internal</a>(<span class="Constant">&quot;could not duplicate handle to be written to backend parameter file: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; *dest = hChild;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Duplicate a <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> for usage in a child process, and write the resulting<br/></li>
<li></span><span class="Comment"> * structure to the parameter file.<br/></li>
<li></span><span class="Comment"> * This is required because a number of LSPs (Layered Service Providers) very<br/></li>
<li></span><span class="Comment"> * common on Windows (antivirus, firewalls, download managers etc) break<br/></li>
<li></span><span class="Comment"> * straight <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> inheritance.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L808">&#x200c;</a></span><span class="linkable">write_inheritable_socket</span>(<a href="#L85" title="postmaster/launch_backend.c:85">InheritableSocket</a> *dest, SOCKET src, pid_t childpid)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; dest-&gt;origsocket = src;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src != <span class="Constant">0</span> &amp;&amp; src != PGINVALID_SOCKET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Actual <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (WSADuplicateSocket(src, childpid, &amp;dest-&gt;wsainfo) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(LOG,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not duplicate <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> </span><span class="Special">%d</span><span class="Constant"> for use in backend: error code </span><span class="Special">%d</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Type">int</span>) src, WSAGetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Read a duplicate <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> structure back, and get the <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a> descriptor.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L829">&#x200c;</a></span><span class="linkable">read_inheritable_socket</span>(SOCKET *dest, <a href="#L85" title="postmaster/launch_backend.c:85">InheritableSocket</a> *src)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; SOCKET&nbsp; &nbsp; &nbsp; &nbsp; s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (src-&gt;origsocket == PGINVALID_SOCKET || src-&gt;origsocket == <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Not a real <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a>! */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *dest = src-&gt;origsocket;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Actual <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a>, so create from structure */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; s = WSASocket(FROM_PROTOCOL_INFO,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM_PROTOCOL_INFO,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM_PROTOCOL_INFO,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;src-&gt;wsainfo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (s == INVALID_SOCKET)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not create inherited <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a>: error code </span><span class="Special">%d\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WSAGetLastError());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *dest = s;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * To make sure we don't get two references to the same <a href="../port/win32/socket.c.html#L31" title="port/win32/socket.c:31">socket</a>, close<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the original one. (This would happen when inheritance actually<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * works..<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; closesocket(src-&gt;origsocket);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L866">&#x200c;</a></span><span class="linkable">read_backend_variables</span>(<span class="Type">char</span> *id, <span class="Type">char</span> **startup_data, <span class="Type">size_t</span> *startup_data_len)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> param;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef WIN32<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Non-win32 implementation reads from file */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">FILE</span>&nbsp; &nbsp; &nbsp;&nbsp; *fp;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Open file */<br/></li>
<li></span>&nbsp; &nbsp; fp = <a href="../storage/file/fd.c.html#L2583" title="storage/file/fd.c:2583">AllocateFile</a>(id, PG_BINARY_R);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!fp)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not open backend variables file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m</span><span class="Special">\n</span><span class="Constant">&quot;</span>, id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (fread(&amp;param, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(param), <span class="Constant">1</span>, fp) != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not read from backend variables file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m</span><span class="Special">\n</span><span class="Constant">&quot;</span>, id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* read startup data */<br/></li>
<li></span>&nbsp; &nbsp; *startup_data_len = param.startup_data_len;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (param.startup_data_len &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *startup_data = <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(*startup_data_len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (fread(*startup_data, *startup_data_len, <span class="Constant">1</span>, fp) != <span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not read startup data from backend variables file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *startup_data = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release file */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../storage/file/fd.c.html#L2781" title="storage/file/fd.c:2781">FreeFile</a>(fp);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (unlink(id) != <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not remove file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">: %m</span><span class="Special">\n</span><span class="Constant">&quot;</span>, id);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* Win32 version uses mapped file */<br/></li>
<li></span>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; paramHandle;<br/></li>
<li>&nbsp; &nbsp; <a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *paramp;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef _WIN64<br/></li>
<li></span>&nbsp; &nbsp; paramHandle = (HANDLE) _atoi64(id);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; paramHandle = (HANDLE) atol(id);<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; paramp = MapViewOfFile(paramHandle, FILE_MAP_READ, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!paramp)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not map view of backend variables: error code </span><span class="Special">%lu\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; memcpy(&amp;param, paramp, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* read startup data */<br/></li>
<li></span>&nbsp; &nbsp; *startup_data_len = param.startup_data_len;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (param.startup_data_len &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; *startup_data = <a href="../utils/mmgr/mcxt.c.html#L1316" title="utils/mmgr/mcxt.c:1316">palloc</a>(paramp-&gt;startup_data_len);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(*startup_data, paramp-&gt;startup_data, param.startup_data_len);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; *startup_data = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!UnmapViewOfFile(paramp))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not unmap view of backend variables: error code </span><span class="Special">%lu\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!CloseHandle(paramHandle))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L3707" title="utils/error/elog.c:3707">write_stderr</a>(<span class="Constant">&quot;could not close handle to backend parameter variables: error code </span><span class="Special">%lu\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; GetLastError());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; exit(<span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <a href="#L960" title="postmaster/launch_backend.c:960">restore_backend_variables</a>(&amp;param);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/* Restore critical backend variables from the <a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> struct */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L960">&#x200c;</a></span><span class="linkable">restore_backend_variables</span>(<a href="#L152" title="postmaster/launch_backend.c:152">BackendParameters</a> *param)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (param-&gt;client_sock.sock != PGINVALID_SOCKET)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/init/globals.c.html#L48" title="utils/init/globals.c:48">MyClientSocket</a> = <a href="../utils/mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(<a href="../utils/mmgr/mcxt.c.html#L149" title="utils/mmgr/mcxt.c:149">TopMemoryContext</a>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ClientSocket));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; memcpy(<a href="../utils/init/globals.c.html#L48" title="utils/init/globals.c:48">MyClientSocket</a>, &amp;param-&gt;client_sock, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(ClientSocket));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L685" title="postmaster/launch_backend.c:685">read_inheritable_socket</a>(&amp;<a href="../utils/init/globals.c.html#L48" title="utils/init/globals.c:48">MyClientSocket</a>-&gt;sock, &amp;param-&gt;inh_sock);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/init/miscinit.c.html#L434" title="utils/init/miscinit.c:434">SetDataDir</a>(param-&gt;<a href="../utils/init/globals.c.html#L68" title="utils/init/globals.c:68">DataDir</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/init/globals.c.html#L50" title="utils/init/globals.c:50">MyCancelKey</a> = param-&gt;<a href="../utils/init/globals.c.html#L50" title="utils/init/globals.c:50">MyCancelKey</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a> = param-&gt;<a href="../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; <a href="../port/win32_shmem.c.html#L42" title="port/win32_shmem.c:42">ShmemProtectiveRegion</a> = param-&gt;<a href="../port/win32_shmem.c.html#L42" title="port/win32_shmem.c:42">ShmemProtectiveRegion</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="../port/win32_shmem.c.html#L44" title="port/win32_shmem.c:44">UsedShmemSegID</a> = param-&gt;<a href="../port/win32_shmem.c.html#L44" title="port/win32_shmem.c:44">UsedShmemSegID</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a> = param-&gt;<a href="../port/win32_shmem.c.html#L45" title="port/win32_shmem.c:45">UsedShmemSegAddr</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/ipc/shmem.c.html#L87" title="storage/ipc/shmem.c:87">ShmemLock</a> = param-&gt;<a href="../storage/ipc/shmem.c.html#L87" title="storage/ipc/shmem.c:87">ShmemLock</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="postmaster.c.html#L182" title="postmaster/postmaster.c:182">ShmemBackendArray</a> = param-&gt;<a href="postmaster.c.html#L182" title="postmaster/postmaster.c:182">ShmemBackendArray</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifndef HAVE_SPINLOCKS<br/></li>
<li></span>&nbsp; &nbsp; <a href="../storage/lmgr/spin.c.html#L42" title="storage/lmgr/spin.c:42">SpinlockSemaArray</a> = param-&gt;<a href="../storage/lmgr/spin.c.html#L42" title="storage/lmgr/spin.c:42">SpinlockSemaArray</a>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; <a href="../storage/lmgr/lwlock.c.html#L227" title="storage/lmgr/lwlock.c:227">NamedLWLockTrancheRequests</a> = param-&gt;<a href="../storage/lmgr/lwlock.c.html#L227" title="storage/lmgr/lwlock.c:227">NamedLWLockTrancheRequests</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/lmgr/lwlock.c.html#L230" title="storage/lmgr/lwlock.c:230">NamedLWLockTrancheArray</a> = param-&gt;<a href="../storage/lmgr/lwlock.c.html#L230" title="storage/lmgr/lwlock.c:230">NamedLWLockTrancheArray</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/lmgr/lwlock.c.html#L191" title="storage/lmgr/lwlock.c:191">MainLWLockArray</a> = param-&gt;<a href="../storage/lmgr/lwlock.c.html#L191" title="storage/lmgr/lwlock.c:191">MainLWLockArray</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/lmgr/proc.c.html#L75" title="storage/lmgr/proc.c:75">ProcStructLock</a> = param-&gt;<a href="../storage/lmgr/proc.c.html#L75" title="storage/lmgr/proc.c:75">ProcStructLock</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/lmgr/proc.c.html#L78" title="storage/lmgr/proc.c:78">ProcGlobal</a> = param-&gt;<a href="../storage/lmgr/proc.c.html#L78" title="storage/lmgr/proc.c:78">ProcGlobal</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/lmgr/proc.c.html#L79" title="storage/lmgr/proc.c:79">AuxiliaryProcs</a> = param-&gt;<a href="../storage/lmgr/proc.c.html#L79" title="storage/lmgr/proc.c:79">AuxiliaryProcs</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/lmgr/proc.c.html#L80" title="storage/lmgr/proc.c:80">PreparedXactProcs</a> = param-&gt;<a href="../storage/lmgr/proc.c.html#L80" title="storage/lmgr/proc.c:80">PreparedXactProcs</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/ipc/pmsignal.c.html#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a> = param-&gt;<a href="../storage/ipc/pmsignal.c.html#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/init/globals.c.html#L103" title="utils/init/globals.c:103">PostmasterPid</a> = param-&gt;<a href="../utils/init/globals.c.html#L103" title="utils/init/globals.c:103">PostmasterPid</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/timestamp.c.html#L52" title="utils/adt/timestamp.c:52">PgStartTime</a> = param-&gt;<a href="../utils/adt/timestamp.c.html#L52" title="utils/adt/timestamp.c:52">PgStartTime</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/timestamp.c.html#L55" title="utils/adt/timestamp.c:55">PgReloadTime</a> = param-&gt;<a href="../utils/adt/timestamp.c.html#L55" title="utils/adt/timestamp.c:55">PgReloadTime</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="syslogger.c.html#L89" title="postmaster/syslogger.c:89">first_syslogger_file_time</a> = param-&gt;<a href="syslogger.c.html#L89" title="postmaster/syslogger.c:89">first_syslogger_file_time</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="postmaster.c.html#L353" title="postmaster/postmaster.c:353">redirection_done</a> = param-&gt;<a href="postmaster.c.html#L353" title="postmaster/postmaster.c:353">redirection_done</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/init/globals.c.html#L118" title="utils/init/globals.c:118">IsBinaryUpgrade</a> = param-&gt;<a href="../utils/init/globals.c.html#L118" title="utils/init/globals.c:118">IsBinaryUpgrade</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../nodes/queryjumblefuncs.c.html#L52" title="nodes/queryjumblefuncs.c:52">query_id_enabled</a> = param-&gt;<a href="../nodes/queryjumblefuncs.c.html#L52" title="nodes/queryjumblefuncs.c:52">query_id_enabled</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/file/fd.c.html#L159" title="storage/file/fd.c:159">max_safe_fds</a> = param-&gt;<a href="../storage/file/fd.c.html#L159" title="storage/file/fd.c:159">max_safe_fds</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a> = param-&gt;<a href="../utils/init/globals.c.html#L143" title="utils/init/globals.c:143">MaxBackends</a>;<br/></li>
<li><br/></li>
<li><span class="PreProc">#ifdef WIN32<br/></li>
<li></span>&nbsp; &nbsp; <a href="postmaster.c.html#L482" title="postmaster/postmaster.c:482">PostmasterHandle</a> = param-&gt;<a href="postmaster.c.html#L482" title="postmaster/postmaster.c:482">PostmasterHandle</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="../port/win32/signal.c.html#L28" title="port/win32/signal.c:28">pgwin32_initial_signal_pipe</a> = param-&gt;initial_signal_pipe;<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span>&nbsp; &nbsp; memcpy(&amp;<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>, &amp;param-&gt;<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>));<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; memcpy(&amp;<a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>, &amp;param-&gt;<a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="syslogger.c.html#L116" title="postmaster/syslogger.c:116">syslogPipe</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; strlcpy(<a href="../utils/init/globals.c.html#L78" title="utils/init/globals.c:78">my_exec_path</a>, param-&gt;<a href="../utils/init/globals.c.html#L78" title="utils/init/globals.c:78">my_exec_path</a>, MAXPGPATH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; strlcpy(<a href="../utils/init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>, param-&gt;<a href="../utils/init/globals.c.html#L79" title="utils/init/globals.c:79">pkglib_path</a>, MAXPGPATH);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We need to restore fd.c's counts of externally-opened FDs; to avoid<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * confusion, be sure to do this after restoring <a href="../storage/file/fd.c.html#L159" title="storage/file/fd.c:159">max_safe_fds</a>.&nbsp; (Note:<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * <a href="../tcop/backend_startup.c.html#L122" title="tcop/backend_startup.c:122">BackendInitialize</a> will handle this for (*client_sock)-&gt;sock.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><span class="PreProc">#ifndef WIN32<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>[<span class="Constant">0</span>] &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/file/fd.c.html#L1221" title="storage/file/fd.c:1221">ReserveExternalFD</a>();<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>[<span class="Constant">1</span>] &gt;= <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/file/fd.c.html#L1221" title="storage/file/fd.c:1221">ReserveExternalFD</a>();<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* EXEC_BACKEND */<br/></li>
</ol></span></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
