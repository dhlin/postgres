<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>catalog/genbki.pl - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>catalog/genbki.pl - pgsql17devel-backend</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L1132">assign_next_oid</a></li>
<li><a href="#L1110">form_pg_type_symbol</a></li>
<li><a href="#L852">gen_pg_attribute</a></li>
<li><a href="#L1071">lookup_oids</a></li>
<li><a href="#L933">morph_row_for_pgattr</a></li>
<li><a href="#L1028">morph_row_for_schemapg</a></li>
<li><a href="#L988">print_bki_insert</a></li>
<li><a href="#L1150">print_boilerplate</a></li>
<li><a href="#L1174">usage</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="PreProc">#!/usr/bin/perl<br/></li>
<li></span><span class="Comment">#----------------------------------------------------------------------<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># genbki.pl<br/></li>
<li></span><span class="Comment">#&nbsp; &nbsp; Perl script that generates postgres.bki and symbol definition<br/></li>
<li></span><span class="Comment">#&nbsp; &nbsp; headers from specially formatted header files and data files.<br/></li>
<li></span><span class="Comment">#&nbsp; &nbsp; postgres.bki is used to initialize the postgres template database.<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"># Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># src/backend/catalog/genbki.pl<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment">#----------------------------------------------------------------------<br/></li>
<li></span><br/></li>
<li><span class="Statement">use strict</span>;<br/></li>
<li><span class="Statement">use warnings</span> <span class="Constant">FATAL</span> =&gt; <span class="Constant">'all'</span>;<br/></li>
<li><span class="Statement">use </span>Getopt::Long;<br/></li>
<li><br/></li>
<li><span class="Statement">use </span>FindBin;<br/></li>
<li><span class="Statement">use lib</span> <span class="Identifier">$</span><span class="Type">FindBin::</span><span class="Identifier">RealBin</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">use </span>Catalog;<br/></li>
<li><br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$output_path</span> = <span class="Constant">''</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$major_version</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$include_path</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$num_errors</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>GetOptions(<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">'output:s'</span> =&gt; \<span class="Identifier">$output_path</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">'set-version:s'</span> =&gt; \<span class="Identifier">$major_version</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">'include-path:s'</span> =&gt; \<span class="Identifier">$include_path</span>) || <a href="#L1174" title="catalog/genbki.pl:1174">usage</a>();<br/></li>
<li><br/></li>
<li><span class="Comment"># Sanity check arguments.<br/></li>
<li></span><span class="Statement">die</span> <span class="Constant">&quot;No input files.</span><span class="Special">\n</span><span class="Constant">&quot;</span> <span class="Statement">unless</span> <span class="Identifier">@ARGV</span>;<br/></li>
<li><span class="Statement">die</span> <span class="Constant">&quot;--set-version must be specified.</span><span class="Special">\n</span><span class="Constant">&quot;</span> <span class="Statement">unless</span> <span class="Identifier">$major_version</span>;<br/></li>
<li><span class="Statement">die</span> <span class="Constant">&quot;Invalid version string: </span><span class="Identifier">$major_version</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; <span class="Statement">unless</span> <span class="Identifier">$major_version</span> =~ <span class="Statement">/</span><span class="Constant">^</span><span class="Special">\d+</span><span class="Constant">$</span><span class="Statement">/</span>;<br/></li>
<li><span class="Statement">die</span> <span class="Constant">&quot;--include-path must be specified.</span><span class="Special">\n</span><span class="Constant">&quot;</span> <span class="Statement">unless</span> <span class="Identifier">$include_path</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Make sure paths end with a slash.<br/></li>
<li></span><span class="Statement">if</span> (<span class="Identifier">$output_path</span> <span class="Statement">ne</span> <span class="Constant">''</span> &amp;&amp; <span class="Statement">substr</span>(<span class="Identifier">$output_path</span>, -<span class="Constant">1</span>) <span class="Statement">ne</span> <span class="Constant">'/'</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$output_path</span> .= <span class="Constant">'/'</span>;<br/></li>
<li>}<br/></li>
<li><span class="Statement">if</span> (<span class="Statement">substr</span>(<span class="Identifier">$include_path</span>, -<span class="Constant">1</span>) <span class="Statement">ne</span> <span class="Constant">'/'</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$include_path</span> .= <span class="Constant">'/'</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Read all the files into internal data structures.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">@catnames</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">%catalogs</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">%catalog_data</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">@toast_decls</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">@index_decls</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">%syscaches</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">%syscache_catalogs</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">%oidcounts</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">@system_constraints</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$header</span> (<span class="Identifier">@ARGV</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$header</span> =~ <span class="Statement">/</span><span class="Special">(.+)\.</span><span class="Constant">h$</span><span class="Statement">/<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;Input files need to be header files.</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$datfile</span> = <span class="Constant">&quot;</span><span class="Identifier">$1</span><span class="Constant">.dat&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$catalog</span> = Catalog::<a href="Catalog.pm.html#L24" title="catalog/Catalog.pm:24">ParseHeader</a>(<span class="Identifier">$header</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$catname</span> = <span class="Identifier">$catalog-&gt;{</span><span class="Constant">catname</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$schema</span> = <span class="Identifier">$catalog-&gt;{</span><span class="Constant">columns</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$catname</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@catnames</span>, <span class="Identifier">$catname</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$catalogs{$catname}</span> = <span class="Identifier">$catalog</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># While checking for duplicated OIDs, we ignore the pg_class OID and<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># rowtype OID of bootstrap catalogs, as those are expected to appear<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># in the initial data for pg_class and pg_type.&nbsp; For regular catalogs,<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># include these OIDs.&nbsp; (See also Catalog::<a href="Catalog.pm.html#L574" title="catalog/Catalog.pm:574">FindAllOidsFromHeaders</a><br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># if you change this logic.)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<span class="Identifier">$catalog-&gt;{</span><span class="Constant">bootstrap</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$oidcounts{</span><span class="perlVarMember"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>++<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$oidcounts{</span><span class="perlVarMember"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">rowtype_oid</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>++<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$catalog-&gt;{</span><span class="Constant">rowtype_oid</span><span class="Identifier">}</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Not all catalogs have a data file.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">-e</span> <span class="Identifier">$datfile</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$data</span> = Catalog::<a href="Catalog.pm.html#L308" title="catalog/Catalog.pm:308">ParseData</a>(<span class="Identifier">$datfile</span>, <span class="Identifier">$schema</span>, <span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$catalog_data{$catname}</span> = <span class="Identifier">$data</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@$data</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Generate entries for pg_description and pg_shdescription.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$row-&gt;{</span><span class="Constant">descr</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%descr</span> = (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">objoid</span> =&gt; <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">classoid</span> =&gt; <span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">objsubid</span> =&gt; <span class="Constant">0</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">description</span> =&gt; <span class="Identifier">$row-&gt;{</span><span class="Constant">descr</span><span class="Identifier">}</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$catalog-&gt;{</span><span class="Constant">shared_relation</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> <span class="Identifier">$descr{</span><span class="Constant">objsubid</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_shdescription</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>, \<span class="Identifier">%descr</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_description</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>, \<span class="Identifier">%descr</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Check for duplicated OIDs while we're at it.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$oidcounts{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>++ <span class="Statement">if</span> <span class="Statement">defined</span> <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Lookup table to get index info by index name<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%indexes</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># If the header file contained toast or index info, build BKI<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># commands for those, which we'll output later.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$toast</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">toasting</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@toast_decls</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sprintf</span> <span class="Constant">&quot;declare toast %s %s on %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_oid</span><span class="Identifier">}</span>, <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_index_oid</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$toast-&gt;{</span><span class="Constant">parent_table</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$oidcounts{</span><span class="perlVarMember"> </span><span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_oid</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$oidcounts{</span><span class="perlVarMember"> </span><span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_index_oid</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$index</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">indexing</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$indexes{</span><span class="perlVarMember"> </span><span class="Identifier">$index-&gt;{</span><span class="Constant">index_name</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$index</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@index_decls</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sprintf</span> <span class="Constant">&quot;declare %sindex %s %s on %s using %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">is_unique</span><span class="Identifier">}</span> ? <span class="Constant">'unique '</span> : <span class="Constant">''</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">index_name</span><span class="Identifier">}</span>, <span class="Identifier">$index-&gt;{</span><span class="Constant">index_oid</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">table_name</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">index_decl</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$oidcounts{</span><span class="perlVarMember"> </span><span class="Identifier">$index-&gt;{</span><span class="Constant">index_oid</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$index-&gt;{</span><span class="Constant">is_unique</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@system_constraints</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sprintf</span> <span class="Constant">&quot;ALTER TABLE %s ADD %s USING INDEX %s;&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">table_name</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">is_pkey</span><span class="Identifier">}</span> ? <span class="Constant">&quot;PRIMARY KEY&quot;</span> : <span class="Constant">&quot;UNIQUE&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">index_name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Analyze syscache info<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$syscache</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">syscaches</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$index</span> = <span class="Identifier">$indexes{</span><span class="perlVarMember"> </span><span class="Identifier">$syscache-&gt;{</span><span class="Constant">index_name</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$tblname</span> = <span class="Identifier">$index-&gt;{</span><span class="Constant">table_name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$key</span> = <span class="Identifier">$index-&gt;{</span><span class="Constant">index_decl</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$key</span> =~ <span class="Statement">s/</span><span class="Constant">^</span><span class="Special">\w+\(</span><span class="Statement">//</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$key</span> =~ <span class="Statement">s/</span><span class="Special">\)</span><span class="Constant">$</span><span class="Statement">//</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$key</span> =~ <span class="Statement">s/</span><span class="Special">(\w+)\s+\w+</span><span class="Statement">/</span><span class="Constant">Anum_</span><span class="Identifier">${tblname}</span><span class="Constant">_</span><span class="Identifier">$1</span><span class="Statement">/g</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$syscaches{</span><span class="perlVarMember"> </span><span class="Identifier">$syscache-&gt;{</span><span class="Constant">syscache_name</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">table_oid_macro</span> =&gt; <span class="Identifier">$catalogs{$tblname}-&gt;{</span><span class="Constant">relation_oid_macro</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">index_oid_macro</span> =&gt; <span class="Identifier">$index-&gt;{</span><span class="Constant">index_oid_macro</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">key</span> =&gt; <span class="Identifier">$key</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">nbuckets</span> =&gt; <span class="Identifier">$syscache-&gt;{</span><span class="Constant">syscache_nbuckets</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; };<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$syscache_catalogs{$catname}</span> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Complain and exit if we found any duplicate OIDs.<br/></li>
<li></span><span class="Comment"># While duplicate OIDs would only cause a failure if they appear in<br/></li>
<li></span><span class="Comment"># the same catalog, our project policy is that manually assigned OIDs<br/></li>
<li></span><span class="Comment"># should be globally unique, to avoid confusion.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">$found</span> = <span class="Constant">0</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$oid</span> (<span class="Statement">keys</span> <span class="Identifier">%oidcounts</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">unless</span> <span class="Identifier">$oidcounts{$oid}</span> &gt; <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">STDERR</span> <span class="Constant">&quot;Duplicate OIDs detected:</span><span class="Special">\n</span><span class="Constant">&quot;</span> <span class="Statement">if</span> !<span class="Identifier">$found</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">STDERR</span> <span class="Constant">&quot;</span><span class="Identifier">$oid</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$found</span>++;<br/></li>
<li>}<br/></li>
<li><span class="Statement">die</span> <span class="Constant">&quot;found </span><span class="Identifier">$found</span><span class="Constant"> duplicate OID(s) in catalog data</span><span class="Special">\n</span><span class="Constant">&quot;</span> <span class="Statement">if</span> <span class="Identifier">$found</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment"># OIDs not specified in the input files are automatically assigned,<br/></li>
<li></span><span class="Comment"># starting at FirstGenbkiObjectId, extending up to FirstUnpinnedObjectId.<br/></li>
<li></span><span class="Comment"># We allow such OIDs to be assigned independently within each catalog.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">$FirstGenbkiObjectId</span> =<br/></li>
<li>&nbsp; Catalog::<a href="Catalog.pm.html#L531" title="catalog/Catalog.pm:531">FindDefinedSymbol</a>(<span class="Constant">'access/transam.h'</span>, <span class="Identifier">$include_path</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">'FirstGenbkiObjectId'</span>);<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$FirstUnpinnedObjectId</span> =<br/></li>
<li>&nbsp; Catalog::<a href="Catalog.pm.html#L531" title="catalog/Catalog.pm:531">FindDefinedSymbol</a>(<span class="Constant">'access/transam.h'</span>, <span class="Identifier">$include_path</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">'FirstUnpinnedObjectId'</span>);<br/></li>
<li><span class="Comment"># Hash of next available OID, indexed by catalog name.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%GenbkiNextOids</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment"># Fetch some special data that we will substitute into the output file.<br/></li>
<li></span><span class="Comment"># CAUTION: be wary about what symbols you substitute into the .bki file here!<br/></li>
<li></span><span class="Comment"># It's okay to substitute things that are expected to be really constant<br/></li>
<li></span><span class="Comment"># within a given Postgres release, such as fixed OIDs.&nbsp; Do not substitute<br/></li>
<li></span><span class="Comment"># anything that could depend on platform or configuration.&nbsp; (The right place<br/></li>
<li></span><span class="Comment"># to handle those sorts of things is in initdb.c's bootstrap_template1().)<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">$C_COLLATION_OID</span> =<br/></li>
<li>&nbsp; Catalog::<a href="Catalog.pm.html#L557" title="catalog/Catalog.pm:557">FindDefinedSymbolFromData</a>(<span class="Identifier">$catalog_data{</span><span class="Constant">pg_collation</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">'C_COLLATION_OID'</span>);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment"># Fill in pg_class.relnatts by looking at the referenced catalog's schema.<br/></li>
<li></span><span class="Comment"># This is ugly but there's no better place; Catalog::<a href="Catalog.pm.html#L394" title="catalog/Catalog.pm:394">AddDefaultValues</a><br/></li>
<li></span><span class="Comment"># can't do it, for lack of easy access to the other catalog.<br/></li>
<li></span><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_class</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">relnatts</span><span class="Identifier">}</span> = <span class="Statement">scalar</span>(<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalogs{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">relname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}-&gt;{</span><span class="Constant">columns</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment"># Build lookup tables.<br/></li>
<li></span><br/></li>
<li><span class="Comment"># access method OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%amoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_am</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$amoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">amname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># role OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%authidoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_authid</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$authidoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">rolname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># class (relation) OID lookup (note this only covers bootstrap catalogs!)<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%classoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_class</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$classoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">relname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># collation OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%collationoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_collation</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$collationoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">collname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># language OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%langoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_language</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$langoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">lanname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># namespace (schema) OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%namespaceoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_namespace</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$namespaceoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">nspname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># opclass OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%opcoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_opclass</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># There is no unique name, so we need to combine access method<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># and opclass name.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$key</span> = <span class="Statement">sprintf</span> <span class="Constant">&quot;%s/%s&quot;</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">opcmethod</span><span class="Identifier">}</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">opcname</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$opcoids{$key}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># operator OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%operoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_operator</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># There is no unique name, so we need to invent one that contains<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># the relevant type names.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$key</span> = <span class="Statement">sprintf</span> <span class="Constant">&quot;%s(%s,%s)&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">oprname</span><span class="Identifier">}</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">oprleft</span><span class="Identifier">}</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">oprright</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$operoids{$key}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># opfamily OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%opfoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_opfamily</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># There is no unique name, so we need to combine access method<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># and opfamily name.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$key</span> = <span class="Statement">sprintf</span> <span class="Constant">&quot;%s/%s&quot;</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">opfmethod</span><span class="Identifier">}</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">opfname</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$opfoids{$key}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># procedure OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%procoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_proc</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Generate an entry under just the proname (corresponds to regproc lookup)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$prokey</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">proname</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$procoids{$prokey}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$procoids{$prokey}</span> = <span class="Constant">'MULTIPLE'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$procoids{$prokey}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Also generate an entry using proname(proargtypes).&nbsp; This is not quite<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># identical to regprocedure lookup because we don't worry much about<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># special SQL names for types etc; we just use the names in the source<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># proargtypes field.&nbsp; These *should* be unique, but do a multiplicity<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># check anyway.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$prokey</span> .= <span class="Constant">'('</span> . <span class="Statement">join</span>(<span class="Constant">','</span>, <span class="Statement">split</span>(<span class="Statement">/</span><span class="Special">\s+</span><span class="Statement">/</span>, <span class="Identifier">$row-&gt;{</span><span class="Constant">proargtypes</span><span class="Identifier">}</span>)) . <span class="Constant">')'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$procoids{$prokey}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$procoids{$prokey}</span> = <span class="Constant">'MULTIPLE'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$procoids{$prokey}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># tablespace OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%tablespaceoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_tablespace</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$tablespaceoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">spcname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># text search configuration OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%tsconfigoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_ts_config</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$tsconfigoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">cfgname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># text search dictionary OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%tsdictoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_ts_dict</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$tsdictoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">dictname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># text search parser OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%tsparseroids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_ts_parser</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$tsparseroids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">prsname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># text search template OID lookup<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%tstemplateoids</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_ts_template</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$tstemplateoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">tmplname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># type lookups<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%typeoids</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">%types</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{</span><span class="Constant">pg_type</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># for OID macro substitutions<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$typeoids{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">typname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># for pg_attribute copies of pg_type values<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$types{</span><span class="perlVarMember"> </span><span class="Identifier">$row-&gt;{</span><span class="Constant">typname</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span> = <span class="Identifier">$row</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Encoding identifier lookup.&nbsp; This uses the same replacement machinery<br/></li>
<li></span><span class="Comment"># as for OIDs, but we have to dig the values out of pg_wchar.h.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%encids</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$encfile</span> = <span class="Identifier">$include_path</span> . <span class="Constant">'mb/pg_wchar.h'</span>;<br/></li>
<li><span class="Statement">open</span>(<span class="Statement">my</span> <span class="Identifier">$ef</span>, <span class="Constant">'&lt;'</span>, <span class="Identifier">$encfile</span>) || <span class="Statement">die</span> <span class="Constant">&quot;</span><span class="Identifier">$encfile</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># We're parsing an enum, so start with 0 and increment<br/></li>
<li></span><span class="Comment"># every time we find an enum member.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">$encid</span> = <span class="Constant">0</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$collect_encodings</span> = <span class="Constant">0</span>;<br/></li>
<li><span class="Statement">while</span> (&lt;<span class="Identifier">$ef</span>&gt;)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">/</span><span class="Constant">typedef</span><span class="Special">\s+</span><span class="Constant">enum</span><span class="Special">\s+</span><span class="Constant">pg_enc</span><span class="Statement">/</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$collect_encodings</span> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">last</span> <span class="Statement">if</span> <span class="Statement">/</span><span class="Constant">_PG_LAST_ENCODING_</span><span class="Statement">/</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$collect_encodings</span> <span class="Statement">and</span> <span class="Statement">/</span><span class="Constant">^</span><span class="Special">\s+(</span><span class="Constant">PG_</span><span class="Special">\w+)</span><span class="Statement">/</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$encids{$1}</span> = <span class="Identifier">$encid</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$encid</span>++;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Statement">close</span> <span class="Identifier">$ef</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Map lookup name to the corresponding hash table.<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%lookup_kind</span> = (<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_am</span> =&gt; \<span class="Identifier">%amoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_authid</span> =&gt; \<span class="Identifier">%authidoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_class</span> =&gt; \<span class="Identifier">%classoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_collation</span> =&gt; \<span class="Identifier">%collationoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_language</span> =&gt; \<span class="Identifier">%langoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_namespace</span> =&gt; \<span class="Identifier">%namespaceoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_opclass</span> =&gt; \<span class="Identifier">%opcoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_operator</span> =&gt; \<span class="Identifier">%operoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_opfamily</span> =&gt; \<span class="Identifier">%opfoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_proc</span> =&gt; \<span class="Identifier">%procoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_tablespace</span> =&gt; \<span class="Identifier">%tablespaceoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_ts_config</span> =&gt; \<span class="Identifier">%tsconfigoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_ts_dict</span> =&gt; \<span class="Identifier">%tsdictoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_ts_parser</span> =&gt; \<span class="Identifier">%tsparseroids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_ts_template</span> =&gt; \<span class="Identifier">%tstemplateoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">pg_type</span> =&gt; \<span class="Identifier">%typeoids</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">encoding</span> =&gt; \<span class="Identifier">%encids</span>);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment"># Open temp files<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">$tmpext</span> = <span class="Constant">&quot;.tmp</span><span class="Identifier">$$</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$bkifile</span> = <span class="Identifier">$output_path</span> . <span class="Constant">'postgres.bki'</span>;<br/></li>
<li><span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$bki</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$bkifile</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$bkifile$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$schemafile</span> = <span class="Identifier">$output_path</span> . <span class="Constant">'schemapg.h'</span>;<br/></li>
<li><span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$schemapg</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$schemafile</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$schemafile$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$fk_info_file</span> = <span class="Identifier">$output_path</span> . <span class="Constant">'system_fk_info.h'</span>;<br/></li>
<li><span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$fk_info</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$fk_info_file</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$fk_info_file$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$constraints_file</span> = <span class="Identifier">$output_path</span> . <span class="Constant">'system_constraints.sql'</span>;<br/></li>
<li><span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$constraints</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$constraints_file</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$constraints_file$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$syscache_ids_file</span> = <span class="Identifier">$output_path</span> . <span class="Constant">'syscache_ids.h'</span>;<br/></li>
<li><span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$syscache_ids_fh</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$syscache_ids_file</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$syscache_ids_file$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$syscache_info_file</span> = <span class="Identifier">$output_path</span> . <span class="Constant">'syscache_info.h'</span>;<br/></li>
<li><span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$syscache_info_fh</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$syscache_info_file</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$syscache_info_file$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Generate postgres.bki and pg_*_d.h headers.<br/></li>
<li></span><br/></li>
<li><span class="Comment"># version marker for .bki file<br/></li>
<li></span><span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;# PostgreSQL </span><span class="Identifier">$major_version</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># vars to hold data needed for schemapg.h<br/></li>
<li></span><span class="Statement">my</span> <span class="Identifier">%schemapg_entries</span>;<br/></li>
<li><span class="Statement">my</span> <span class="Identifier">@tables_needing_macros</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># produce output, one catalog at a time<br/></li>
<li></span><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$catname</span> (<span class="Identifier">@catnames</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$catalog</span> = <span class="Identifier">$catalogs{$catname}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Create one definition header with macro definitions for each catalog.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$def_file</span> = <span class="Identifier">$output_path</span> . <span class="Identifier">$catname</span> . <span class="Constant">'_d.h'</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">open</span> <span class="Statement">my</span> <span class="Identifier">$def</span>, <span class="Constant">'&gt;'</span>, <span class="Identifier">$def_file</span> . <span class="Identifier">$tmpext<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">or</span> <span class="Statement">die</span> <span class="Constant">&quot;can't open </span><span class="Identifier">$def_file$tmpext</span><span class="Constant">: </span><span class="Identifier">$!</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L1150" title="catalog/genbki.pl:1150">print_boilerplate</a>(<span class="Identifier">$def</span>, <span class="Constant">&quot;</span><span class="Identifier">${catname}</span><span class="Constant">_d.h&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;Macro definitions for </span><span class="Identifier">$catname</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&lt;&lt;EOM</span><span class="perlHereDocStart">, </span><span class="Statement">uc</span><span class="perlHereDocStart"> </span><span class="Identifier">$catname</span><span class="perlHereDocStart">, </span><span class="Statement">uc</span><span class="perlHereDocStart"> </span><span class="Identifier">$catname</span><span class="perlHereDocStart">;<br/></li>
<li></span><span class="Constant">#ifndef %s_D_H<br/></li>
<li></span><span class="Constant">#define %s_D_H<br/></li>
<li></span><br/></li>
<li><span class="Constant">EOM<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Emit OID macros for catalog's OID and rowtype OID, if wanted<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid_macro</span><span class="Identifier">}</span>, <span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid_macro</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$catalog-&gt;{</span><span class="Constant">rowtype_oid_macro</span><span class="Identifier">}</span>, <span class="Identifier">$catalog-&gt;{</span><span class="Constant">rowtype_oid</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$catalog-&gt;{</span><span class="Constant">rowtype_oid_macro</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Likewise for macros for toast, index, and other OIDs<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$toast</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">toasting</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_oid_macro</span><span class="Identifier">}</span>, <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_oid</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_oid_macro</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_index_oid_macro</span><span class="Identifier">}</span>, <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_index_oid</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$toast-&gt;{</span><span class="Constant">toast_index_oid_macro</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$index</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">indexing</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$index-&gt;{</span><span class="Constant">index_oid_macro</span><span class="Identifier">}</span>, <span class="Identifier">$index-&gt;{</span><span class="Constant">index_oid</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$index-&gt;{</span><span class="Constant">index_oid_macro</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$other</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">other_oids</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$other-&gt;{</span><span class="Constant">other_name</span><span class="Identifier">}</span>, <span class="Identifier">$other-&gt;{</span><span class="Constant">other_oid</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$other-&gt;{</span><span class="Constant">other_name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$def</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># .bki CREATE command for this catalog<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;create </span><span class="Identifier">$catname</span><span class="Constant"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; . <span class="Identifier">$catalog-&gt;{</span><span class="Constant">shared_relation</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; . <span class="Identifier">$catalog-&gt;{</span><span class="Constant">bootstrap</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; . <span class="Identifier">$catalog-&gt;{</span><span class="Constant">rowtype_oid_clause</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$first</span> = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant"> (</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$schema</span> = <span class="Identifier">$catalog-&gt;{</span><span class="Constant">columns</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%attnames</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attnum</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$column</span> (<span class="Identifier">@$schema</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$attnum</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attname</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$atttype</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">type</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Build hash of column names for use later<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$attnames{$attname}</span> = <span class="Constant">1</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Emit column definitions<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<span class="Identifier">$first</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot; ,</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$first</span> = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot; </span><span class="Identifier">$attname</span><span class="Constant"> = </span><span class="Identifier">$atttype</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$column-&gt;{</span><span class="Constant">forcenotnull</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot; FORCE NOT NULL&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Statement">defined</span> <span class="Identifier">$column-&gt;{</span><span class="Constant">forcenull</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot; FORCE NULL&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Emit Anum_* constants<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define Anum_%s_%s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>, <span class="Identifier">$attnum</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant"> )</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Emit Natts_* constant<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$def</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">#define Natts_</span><span class="Identifier">$catname</span><span class="Constant"> </span><span class="Identifier">$attnum</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Emit client code copied from source header<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$line</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">client_code</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$def</span> <span class="Identifier">$line</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Open it, unless it's a bootstrap catalog (create bootstrap does this<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># automatically)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<span class="Identifier">$catalog-&gt;{</span><span class="Constant">bootstrap</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;open </span><span class="Identifier">$catname</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># For pg_attribute.h, we generate data entries ourselves.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$catname</span> <span class="Statement">eq</span> <span class="Constant">'pg_attribute'</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L852" title="catalog/genbki.pl:852">gen_pg_attribute</a>(<span class="Identifier">$schema</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Ordinary catalog with a data file<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$row</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog_data{$catname}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%bki_values</span> = <span class="Identifier">%$row</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Complain about unrecognized keys; they are presumably misspelled<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$key</span> (<span class="Statement">keys</span> <span class="Identifier">%bki_values</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$key</span> <span class="Statement">eq</span> <span class="Constant">&quot;oid_symbol&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <span class="Identifier">$key</span> <span class="Statement">eq</span> <span class="Constant">&quot;array_type_oid&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <span class="Identifier">$key</span> <span class="Statement">eq</span> <span class="Constant">&quot;descr&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <span class="Identifier">$key</span> <span class="Statement">eq</span> <span class="Constant">&quot;autogenerated&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; || <span class="Identifier">$key</span> <span class="Statement">eq</span> <span class="Constant">&quot;line_number&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">die</span> <span class="Statement">sprintf</span> <span class="Constant">&quot;unrecognized field name </span><span class="Special">\&quot;</span><span class="Constant">%s</span><span class="Special">\&quot;</span><span class="Constant"> in %s.dat line %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$key</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$bki_values{</span><span class="Constant">line_number</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<span class="Statement">exists</span>(<span class="Identifier">$attnames{$key}</span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Perform required substitutions on fields<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$column</span> (<span class="Identifier">@$schema</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attname</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$atttype</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">type</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Assign oid if oid column exists and no explicit assignment in row<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$attname</span> <span class="Statement">eq</span> <span class="Constant">&quot;oid&quot;</span> <span class="Statement">and</span> <span class="Statement">not</span> <span class="Statement">defined</span> <span class="Identifier">$bki_values{$attname}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{$attname}</span> = <a href="#L1132" title="catalog/genbki.pl:1132">assign_next_oid</a>(<span class="Identifier">$catname</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Replace OID synonyms with OIDs per the appropriate lookup rule.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">#<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># If the column type is oidvector or _oid, we have to replace<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># each element of the array as per the lookup rule.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$column-&gt;{</span><span class="Constant">lookup</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$lookup</span> = <span class="Identifier">$lookup_kind{</span><span class="perlVarMember"> </span><span class="Identifier">$column-&gt;{</span><span class="Constant">lookup</span><span class="Identifier">}</span><span class="perlVarMember"> </span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$lookup_opt</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">lookup_opt</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@lookupnames</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@lookupoids</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">die</span> <span class="Constant">&quot;unrecognized BKI_LOOKUP type &quot;</span> . <span class="Identifier">$column-&gt;{</span><span class="Constant">lookup</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> !<span class="Statement">defined</span>(<span class="Identifier">$lookup</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$atttype</span> <span class="Statement">eq</span> <span class="Constant">'oidvector'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@lookupnames</span> = <span class="Statement">split</span> <span class="Statement">/</span><span class="Special">\s+</span><span class="Statement">/</span>, <span class="Identifier">$bki_values{$attname}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@lookupoids</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1071" title="catalog/genbki.pl:1071">lookup_oids</a>(<span class="Identifier">$lookup</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>, <span class="Identifier">$lookup_opt</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<span class="Identifier">%bki_values</span>, <span class="Identifier">@lookupnames</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{$attname}</span> = <span class="Statement">join</span>(<span class="Constant">' '</span>, <span class="Identifier">@lookupoids</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$atttype</span> <span class="Statement">eq</span> <span class="Constant">'_oid'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$bki_values{$attname}</span> <span class="Statement">ne</span> <span class="Constant">'_null_'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{$attname}</span> =~ <span class="Statement">s/</span><span class="Special">[{}]</span><span class="Statement">//g</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@lookupnames</span> = <span class="Statement">split</span> <span class="Statement">/</span><span class="Constant">,</span><span class="Statement">/</span>, <span class="Identifier">$bki_values{$attname}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@lookupoids</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1071" title="catalog/genbki.pl:1071">lookup_oids</a>(<span class="Identifier">$lookup</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$lookup_opt</span>, \<span class="Identifier">%bki_values</span>, <span class="Identifier">@lookupnames</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{$attname}</span> = <span class="Statement">sprintf</span> <span class="Constant">&quot;{%s}&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">join</span>(<span class="Constant">','</span>, <span class="Identifier">@lookupoids</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$lookupnames[</span><span class="Constant">0</span><span class="Identifier">]</span> = <span class="Identifier">$bki_values{$attname}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">@lookupoids</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1071" title="catalog/genbki.pl:1071">lookup_oids</a>(<span class="Identifier">$lookup</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>, <span class="Identifier">$lookup_opt</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<span class="Identifier">%bki_values</span>, <span class="Identifier">@lookupnames</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{$attname}</span> = <span class="Identifier">$lookupoids[</span><span class="Constant">0</span><span class="Identifier">]</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Special hack to generate OID symbols for pg_type entries<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$catname</span> <span class="Statement">eq</span> <span class="Constant">'pg_type'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">die</span> <span class="Statement">sprintf<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;custom OID symbols are not allowed for pg_type entries: '%s'&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{</span><span class="Constant">oid_symbol</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Statement">defined</span> <span class="Identifier">$bki_values{</span><span class="Constant">oid_symbol</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$symbol</span> = <a href="#L1110" title="catalog/genbki.pl:1110">form_pg_type_symbol</a>(<span class="Identifier">$bki_values{</span><span class="Constant">typname</span><span class="Identifier">}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{</span><span class="Constant">oid_symbol</span><span class="Identifier">}</span> = <span class="Identifier">$symbol<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Statement">defined</span> <span class="Identifier">$symbol</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Write to postgres.bki<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L988" title="catalog/genbki.pl:988">print_bki_insert</a>(\<span class="Identifier">%bki_values</span>, <span class="Identifier">$schema</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Emit OID symbol<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$bki_values{</span><span class="Constant">oid_symbol</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># OID symbols for builtin functions are handled automatically<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># by utils/Gen_fmgrtab.pl<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">die</span> <span class="Statement">sprintf<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;custom OID symbols are not allowed for pg_proc entries: '%s'&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{</span><span class="Constant">oid_symbol</span><span class="Identifier">}<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$catname</span> <span class="Statement">eq</span> <span class="Constant">'pg_proc'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;#define %s %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_values{</span><span class="Constant">oid_symbol</span><span class="Identifier">}</span>, <span class="Identifier">$bki_values{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;close </span><span class="Identifier">$catname</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$def</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">#endif</span><span class="Special">\t\t\t\t\t\t\t</span><span class="Constant">/* %s_D_H */</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Statement">uc</span> <span class="Identifier">$catname</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Close and rename definition header<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">close</span> <span class="Identifier">$def</span>;<br/></li>
<li>&nbsp; &nbsp; Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$def_file</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Any information needed for the BKI that is not contained in a pg_*.h header<br/></li>
<li></span><span class="Comment"># (i.e., not contained in a header with a CATALOG() statement) comes here<br/></li>
<li></span><br/></li>
<li><span class="Comment"># Write out declare toast/index statements<br/></li>
<li></span><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$declaration</span> (<span class="Identifier">@toast_decls</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Identifier">$declaration</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$declaration</span> (<span class="Identifier">@index_decls</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Identifier">$declaration</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># last command in the BKI file: build the indexes declared above<br/></li>
<li></span><span class="Statement">print</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;build indices</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Now generate system_constraints.sql<br/></li>
<li></span><br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$c</span> (<span class="Identifier">@system_constraints</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># leave blank lines to localize any bootstrap <a href="../parser/check_keywords.pl.html#L17" title="parser/check_keywords.pl:17">error</a> messages better<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$constraints</span> <span class="Identifier">$c</span>, <span class="Constant">&quot;</span><span class="Special">\n\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Now generate schemapg.h<br/></li>
<li></span><br/></li>
<li><a href="#L1150" title="catalog/genbki.pl:1150">print_boilerplate</a>(<span class="Identifier">$schemapg</span>, <span class="Constant">&quot;schemapg.h&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">&quot;Schema_pg_xxx macros for use by relcache.c&quot;</span>);<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$schemapg</span> <span class="Constant">&lt;&lt;EOM</span><span class="perlHereDocStart">;<br/></li>
<li></span><span class="Constant">#ifndef SCHEMAPG_H<br/></li>
<li></span><span class="Constant">#define SCHEMAPG_H<br/></li>
<li></span><span class="Constant">EOM<br/></li>
<li></span><br/></li>
<li><span class="Comment"># Emit schemapg declarations<br/></li>
<li></span><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$table_name</span> (<span class="Identifier">@tables_needing_macros</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$schemapg</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">#define Schema_</span><span class="Identifier">$table_name</span><span class="Constant"> </span><span class="Special">\\\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$schemapg</span> <span class="Statement">join</span> <span class="Constant">&quot;, </span><span class="Special">\\\n</span><span class="Constant">&quot;</span>, <span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$schemapg_entries{$table_name}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$schemapg</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Closing boilerplate for schemapg.h<br/></li>
<li></span><span class="Statement">print</span> <span class="Identifier">$schemapg</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">#endif</span><span class="Special">\t\t\t\t\t\t\t</span><span class="Constant">/* SCHEMAPG_H */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Now generate system_fk_info.h<br/></li>
<li></span><br/></li>
<li><a href="#L1150" title="catalog/genbki.pl:1150">print_boilerplate</a>(<span class="Identifier">$fk_info</span>, <span class="Constant">&quot;system_fk_info.h&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">&quot;Data about the foreign-key relationships in the system catalogs&quot;</span>);<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$fk_info</span> <span class="Constant">&lt;&lt;EOM</span><span class="perlHereDocStart">;<br/></li>
<li></span><span class="Constant">#ifndef SYSTEM_FK_INFO_H<br/></li>
<li></span><span class="Constant">#define SYSTEM_FK_INFO_H<br/></li>
<li></span><br/></li>
<li><span class="Constant">typedef struct SysFKRelationship<br/></li>
<li></span><span class="Constant">{<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fk_table;&nbsp; &nbsp; &nbsp; &nbsp; /* referencing catalog */<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; Oid&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pk_table;&nbsp; &nbsp; &nbsp; &nbsp; /* referenced catalog */<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; const char *fk_columns;&nbsp; &nbsp; &nbsp; &nbsp; /* referencing column name(s) */<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; const char *pk_columns;&nbsp; &nbsp; &nbsp; &nbsp; /* referenced column name(s) */<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; bool&nbsp; &nbsp; &nbsp; &nbsp; is_array;&nbsp; &nbsp; &nbsp; &nbsp; /* if true, last fk_column is an array */<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; bool&nbsp; &nbsp; &nbsp; &nbsp; is_opt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* if true, fk_column can be zero */<br/></li>
<li></span><span class="Constant">} SysFKRelationship;<br/></li>
<li></span><br/></li>
<li><span class="Constant">static const SysFKRelationship sys_fk_relationships[] = {<br/></li>
<li></span><span class="Constant">EOM<br/></li>
<li></span><br/></li>
<li><span class="Comment"># Emit system_fk_info data<br/></li>
<li></span><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$catname</span> (<span class="Identifier">@catnames</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$catalog</span> = <span class="Identifier">$catalogs{$catname}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$fkinfo</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$catalog-&gt;{</span><span class="Constant">foreign_keys</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$pktabname</span> = <span class="Identifier">$fkinfo-&gt;{</span><span class="Constant">pk_table</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># We use BKI_LOOKUP for encodings, but there's no real catalog there<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> <span class="Identifier">$pktabname</span> <span class="Statement">eq</span> <span class="Constant">'encoding'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$fk_info<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">{ /* %s */ %s, /* %s */ %s, </span><span class="Special">\&quot;</span><span class="Constant">{%s}</span><span class="Special">\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">{%s}</span><span class="Special">\&quot;</span><span class="Constant">, %s, %s},</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$catname</span>, <span class="Identifier">$catalog-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$pktabname</span>, <span class="Identifier">$catalogs{$pktabname}-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$fkinfo-&gt;{</span><span class="Constant">fk_cols</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$fkinfo-&gt;{</span><span class="Constant">pk_cols</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Identifier">$fkinfo-&gt;{</span><span class="Constant">is_array</span><span class="Identifier">}</span> ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Identifier">$fkinfo-&gt;{</span><span class="Constant">is_opt</span><span class="Identifier">}</span>&nbsp;&nbsp; ? <span class="Constant">&quot;true&quot;</span> : <span class="Constant">&quot;false&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Closing boilerplate for system_fk_info.h<br/></li>
<li></span><span class="Statement">print</span> <span class="Identifier">$fk_info</span> <span class="Constant">&quot;};</span><span class="Special">\n\n</span><span class="Constant">#endif</span><span class="Special">\t\t\t\t\t\t\t</span><span class="Constant">/* SYSTEM_FK_INFO_H */</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Now generate syscache info<br/></li>
<li></span><br/></li>
<li><a href="#L1150" title="catalog/genbki.pl:1150">print_boilerplate</a>(<span class="Identifier">$syscache_ids_fh</span>, <span class="Constant">&quot;syscache_ids.h&quot;</span>, <span class="Constant">&quot;SysCache identifiers&quot;</span>);<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_ids_fh</span> <span class="Constant">&quot;enum SysCacheIdentifier<br/></li>
<li></span><span class="Constant">{<br/></li>
<li></span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><a href="#L1150" title="catalog/genbki.pl:1150">print_boilerplate</a>(<span class="Identifier">$syscache_info_fh</span>, <span class="Constant">&quot;syscache_info.h&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; <span class="Constant">&quot;SysCache definitions&quot;</span>);<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$catname</span> (<span class="Statement">sort</span> <span class="Statement">keys</span> <span class="Identifier">%syscache_catalogs</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">qq{#include &quot;catalog/</span><span class="Identifier">${catname}</span><span class="Constant">_d.h&quot;</span><span class="Special">\n</span><span class="Constant">}</span>;<br/></li>
<li>}<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;static const struct cachedesc cacheinfo[] = {</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">my</span> <span class="Identifier">$last_syscache</span>;<br/></li>
<li><span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$syscache</span> (<span class="Statement">sort</span> <span class="Statement">keys</span> <span class="Identifier">%syscaches</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_ids_fh</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Identifier">$syscache</span><span class="Constant">,</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$last_syscache</span> = <span class="Identifier">$syscache</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">[</span><span class="Identifier">$syscache</span><span class="Constant">] = {</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\t\t</span><span class="Constant">&quot;</span>, <span class="Identifier">$syscaches{$syscache}{</span><span class="Constant">table_oid_macro</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;,</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\t\t</span><span class="Constant">&quot;</span>, <span class="Identifier">$syscaches{$syscache}{</span><span class="Constant">index_oid_macro</span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;,</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\t\t</span><span class="Constant">KEY(&quot;</span>, <span class="Identifier">$syscaches{$syscache}{</span><span class="Constant">key</span><span class="Identifier">}</span>, <span class="Constant">&quot;),</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\t\t</span><span class="Constant">&quot;</span>, <span class="Identifier">$syscaches{$syscache}{</span><span class="Constant">nbuckets</span><span class="Identifier">}</span>, <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;</span><span class="Special">\t</span><span class="Constant">},</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_ids_fh</span> <span class="Constant">&quot;};</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_ids_fh</span> <span class="Constant">&quot;#define SysCacheSize (</span><span class="Identifier">$last_syscache</span><span class="Constant"> + 1)</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Statement">print</span> <span class="Identifier">$syscache_info_fh</span> <span class="Constant">&quot;};</span><span class="Special">\n</span><span class="Constant">&quot;</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># We're done emitting data<br/></li>
<li></span><span class="Statement">close</span> <span class="Identifier">$bki</span>;<br/></li>
<li><span class="Statement">close</span> <span class="Identifier">$schemapg</span>;<br/></li>
<li><span class="Statement">close</span> <span class="Identifier">$fk_info</span>;<br/></li>
<li><span class="Statement">close</span> <span class="Identifier">$constraints</span>;<br/></li>
<li><span class="Statement">close</span> <span class="Identifier">$syscache_ids_fh</span>;<br/></li>
<li><span class="Statement">close</span> <span class="Identifier">$syscache_info_fh</span>;<br/></li>
<li><br/></li>
<li><span class="Comment"># Finally, rename the completed files into place.<br/></li>
<li></span>Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$bkifile</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li>Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$schemafile</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li>Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$fk_info_file</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li>Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$constraints_file</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li>Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$syscache_ids_file</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li>Catalog::<a href="Catalog.pm.html#L511" title="catalog/Catalog.pm:511">RenameTempFile</a>(<span class="Identifier">$syscache_info_file</span>, <span class="Identifier">$tmpext</span>);<br/></li>
<li><br/></li>
<li><span class="Statement">exit</span>(<span class="Identifier">$num_errors</span> != <span class="Constant">0</span> ? <span class="Constant">1</span> : <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li><span class="Comment">#################### Subroutines ########################<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment"># For each catalog marked as needing a schema macro, generate the<br/></li>
<li></span><span class="Comment"># per-user-attribute data to be incorporated into schemapg.h.&nbsp; Also, for<br/></li>
<li></span><span class="Comment"># bootstrap catalogs, emit pg_attribute entries into the .bki file<br/></li>
<li></span><span class="Comment"># for both user and system attributes.<br/></li>
<li><a id="L852">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">gen_pg_attribute</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$schema</span> = <span class="Statement">shift</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@attnames</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$column</span> (<span class="Identifier">@$schema</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@attnames</span>, <span class="Identifier">$column-&gt;{</span><span class="Constant">name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$table_name</span> (<span class="Identifier">@catnames</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$table</span> = <span class="Identifier">$catalogs{$table_name}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Currently, all bootstrap catalogs also need schemapg.h<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># entries, so skip if it isn't to be in schemapg.h.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">next</span> <span class="Statement">if</span> !<span class="Identifier">$table-&gt;{</span><span class="Constant">schema_macro</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$schemapg_entries{$table_name}</span> = [];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@tables_needing_macros</span>, <span class="Identifier">$table_name</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Generate entries for user attributes.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attnum</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$priorfixedwidth</span> = <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$attr</span> (<span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$table-&gt;{</span><span class="Constant">columns</span><span class="Identifier">}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$attnum</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%row</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row{</span><span class="Constant">attnum</span><span class="Identifier">}</span> = <span class="Identifier">$attnum</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row{</span><span class="Constant">attrelid</span><span class="Identifier">}</span> = <span class="Identifier">$table-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L933" title="catalog/genbki.pl:933">morph_row_for_pgattr</a>(\<span class="Identifier">%row</span>, <span class="Identifier">$schema</span>, <span class="Identifier">$attr</span>, <span class="Identifier">$priorfixedwidth</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Update $priorfixedwidth --- must match <a href="#L933" title="catalog/genbki.pl:933">morph_row_for_pgattr</a><br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$priorfixedwidth</span> &amp;=<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<span class="Identifier">$row{</span><span class="Constant">attnotnull</span><span class="Identifier">}</span> <span class="Statement">eq</span> <span class="Constant">'t'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;&amp; (<span class="Identifier">$row{</span><span class="Constant">attlen</span><span class="Identifier">}</span> <span class="Statement">eq</span> <span class="Constant">'NAMEDATALEN'</span> || <span class="Identifier">$row{</span><span class="Constant">attlen</span><span class="Identifier">}</span> &gt; <span class="Constant">0</span>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># If it's bootstrapped, put an entry in postgres.bki.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L988" title="catalog/genbki.pl:988">print_bki_insert</a>(\<span class="Identifier">%row</span>, <span class="Identifier">$schema</span>) <span class="Statement">if</span> <span class="Identifier">$table-&gt;{</span><span class="Constant">bootstrap</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Store schemapg entries for later.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L1028" title="catalog/genbki.pl:1028">morph_row_for_schemapg</a>(\<span class="Identifier">%row</span>, <span class="Identifier">$schema</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@{</span><span class="perlVarBlock"> </span><span class="Identifier">$schemapg_entries{$table_name}</span><span class="perlVarBlock"> </span><span class="Identifier">}</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">sprintf</span> <span class="Constant">&quot;{ %s }&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">join</span>(<span class="Constant">', '</span>, <span class="Statement">grep</span> <span class="Statement">{</span> <span class="Statement">defined</span> <span class="Identifier">$_</span> <span class="Statement">}</span> <span class="Identifier">@row{@attnames}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Generate entries for system attributes.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># We only need postgres.bki entries, not schemapg.h entries.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$table-&gt;{</span><span class="Constant">bootstrap</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$attnum</span> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@SYS_ATTRS</span> = (<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">name</span> =&gt; <span class="Constant">'ctid'</span>, <span class="Constant">type</span> =&gt; <span class="Constant">'tid'</span> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">name</span> =&gt; <span class="Constant">'xmin'</span>, <span class="Constant">type</span> =&gt; <span class="Constant">'xid'</span> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">name</span> =&gt; <span class="Constant">'cmin'</span>, <span class="Constant">type</span> =&gt; <span class="Constant">'cid'</span> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">name</span> =&gt; <span class="Constant">'xmax'</span>, <span class="Constant">type</span> =&gt; <span class="Constant">'xid'</span> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">name</span> =&gt; <span class="Constant">'cmax'</span>, <span class="Constant">type</span> =&gt; <span class="Constant">'cid'</span> },<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; { <span class="Constant">name</span> =&gt; <span class="Constant">'tableoid'</span>, <span class="Constant">type</span> =&gt; <span class="Constant">'oid'</span> });<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$attr</span> (<span class="Identifier">@SYS_ATTRS</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$attnum</span>--;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">%row</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row{</span><span class="Constant">attnum</span><span class="Identifier">}</span> = <span class="Identifier">$attnum</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row{</span><span class="Constant">attrelid</span><span class="Identifier">}</span> = <span class="Identifier">$table-&gt;{</span><span class="Constant">relation_oid</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L933" title="catalog/genbki.pl:933">morph_row_for_pgattr</a>(\<span class="Identifier">%row</span>, <span class="Identifier">$schema</span>, <span class="Identifier">$attr</span>, <span class="Constant">1</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L988" title="catalog/genbki.pl:988">print_bki_insert</a>(\<span class="Identifier">%row</span>, <span class="Identifier">$schema</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Given $pgattr_schema (the pg_attribute schema for a catalog sufficient for<br/></li>
<li></span><span class="Comment"># <a href="Catalog.pm.html#L394" title="catalog/Catalog.pm:394">AddDefaultValues</a>), $attr (the description of a catalog row), and<br/></li>
<li></span><span class="Comment"># $priorfixedwidth (all prior columns are fixed-width and not null),<br/></li>
<li></span><span class="Comment"># modify the $row hashref for <a href="#L988" title="catalog/genbki.pl:988">print_bki_insert</a>.&nbsp; This includes setting data<br/></li>
<li></span><span class="Comment"># from the corresponding pg_type element and filling in any default values.<br/></li>
<li></span><span class="Comment"># Any value not handled here must be supplied by caller.<br/></li>
<li><a id="L933">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">morph_row_for_pgattr</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$row</span>, <span class="Identifier">$pgattr_schema</span>, <span class="Identifier">$attr</span>, <span class="Identifier">$priorfixedwidth</span>) = <span class="Identifier">@_</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attname</span> = <span class="Identifier">$attr-&gt;{</span><span class="Constant">name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$atttype</span> = <span class="Identifier">$attr-&gt;{</span><span class="Constant">type</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attname</span><span class="Identifier">}</span> = <span class="Identifier">$attname</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Copy the type data from pg_type, and add some type-dependent items<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$type</span> = <span class="Identifier">$types{$atttype}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">atttypid</span><span class="Identifier">}</span> = <span class="Identifier">$type-&gt;{</span><span class="Constant">oid</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attlen</span><span class="Identifier">}</span> = <span class="Identifier">$type-&gt;{</span><span class="Constant">typlen</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attbyval</span><span class="Identifier">}</span> = <span class="Identifier">$type-&gt;{</span><span class="Constant">typbyval</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attalign</span><span class="Identifier">}</span> = <span class="Identifier">$type-&gt;{</span><span class="Constant">typalign</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attstorage</span><span class="Identifier">}</span> = <span class="Identifier">$type-&gt;{</span><span class="Constant">typstorage</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># set attndims if it's an array type<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attndims</span><span class="Identifier">}</span> = <span class="Identifier">$type-&gt;{</span><span class="Constant">typcategory</span><span class="Identifier">}</span> <span class="Statement">eq</span> <span class="Constant">'A'</span> ? <span class="Constant">'1'</span> : <span class="Constant">'0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># collation-aware catalog columns must use C collation<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attcollation</span><span class="Identifier">}</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; <span class="Identifier">$type-&gt;{</span><span class="Constant">typcollation</span><span class="Identifier">}</span> <span class="Statement">ne</span> <span class="Constant">'0'</span> ? <span class="Identifier">$C_COLLATION_OID</span> : <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span> <span class="Identifier">$attr-&gt;{</span><span class="Constant">forcenotnull</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attnotnull</span><span class="Identifier">}</span> = <span class="Constant">'t'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Statement">defined</span> <span class="Identifier">$attr-&gt;{</span><span class="Constant">forcenull</span><span class="Identifier">}</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attnotnull</span><span class="Identifier">}</span> = <span class="Constant">'f'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$priorfixedwidth</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># attnotnull will automatically be set if the type is<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># fixed-width and prior columns are likewise fixed-width<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># and NOT NULL --- compare DefineAttr in bootstrap.c.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># At this point the width of type name is still symbolic,<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># so we need a special test.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attnotnull</span><span class="Identifier">}</span> =<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attlen</span><span class="Identifier">}</span> <span class="Statement">eq</span> <span class="Constant">'NAMEDATALEN'</span> ? <span class="Constant">'t'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : <span class="Identifier">$row-&gt;{</span><span class="Constant">attlen</span><span class="Identifier">}</span> &gt; <span class="Constant">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ? <span class="Constant">'t'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">'f'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{</span><span class="Constant">attnotnull</span><span class="Identifier">}</span> = <span class="Constant">'f'</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Catalog::<a href="Catalog.pm.html#L394" title="catalog/Catalog.pm:394">AddDefaultValues</a>(<span class="Identifier">$row</span>, <span class="Identifier">$pgattr_schema</span>, <span class="Constant">'pg_attribute'</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Write an entry to postgres.bki.<br/></li>
<li><a id="L988">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_bki_insert</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$row</span> = <span class="Statement">shift</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$schema</span> = <span class="Statement">shift</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@bki_values</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$column</span> (<span class="Identifier">@$schema</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attname</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$atttype</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">type</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$bki_value</span> = <span class="Identifier">$row-&gt;{$attname}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Fold backslash-zero to empty string if it's the entire string,<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># since that represents a NUL char in C code.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_value</span> = <span class="Constant">''</span> <span class="Statement">if</span> <span class="Identifier">$bki_value</span> <span class="Statement">eq</span> <span class="Constant">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Handle single quotes by doubling them, because that's what the<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># bootstrap scanner requires.&nbsp; We do not process backslashes<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># specially; this allows escape-string-style backslash escapes<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># to be used in catalog data.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_value</span> =~ <span class="Statement">s/</span><span class="Constant">'</span><span class="Statement">/</span><span class="Constant">''</span><span class="Statement">/g</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Quote value if needed.&nbsp; We need not quote values that satisfy<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># the &quot;id&quot; pattern in bootscanner.l, currently &quot;[-A-Za-z0-9_]+&quot;.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$bki_value</span> = <span class="Statement">sprintf</span>(<span class="Constant">&quot;'%s'&quot;</span>, <span class="Identifier">$bki_value</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Statement">length</span>(<span class="Identifier">$bki_value</span>) == <span class="Constant">0<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">or</span> <span class="Identifier">$bki_value</span> =~ <span class="Statement">/</span><span class="Special">[^-A-Za-z0-9_]</span><span class="Statement">/</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@bki_values</span>, <span class="Identifier">$bki_value</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$bki</span> <span class="Constant">&quot;insert ( %s )</span><span class="Special">\n</span><span class="Constant">&quot;</span>, <span class="Statement">join</span>(<span class="Constant">' '</span>, <span class="Identifier">@bki_values</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Given a row reference, modify it so that it becomes a valid entry for<br/></li>
<li></span><span class="Comment"># a catalog schema declaration in schemapg.h.<br/></li>
<li></span><span class="Comment">#<br/></li>
<li></span><span class="Comment"># The field values of a Schema_pg_xxx declaration are similar, but not<br/></li>
<li></span><span class="Comment"># quite identical, to the corresponding values in postgres.bki.<br/></li>
<li><a id="L1028">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">morph_row_for_schemapg</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$row</span> = <span class="Statement">shift</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$pgattr_schema</span> = <span class="Statement">shift</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$column</span> (<span class="Identifier">@$pgattr_schema</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$attname</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">name</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$atttype</span> = <span class="Identifier">$column-&gt;{</span><span class="Constant">type</span><span class="Identifier">}</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Some data types have special formatting rules.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$atttype</span> <span class="Statement">eq</span> <span class="Constant">'name'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># add {&quot; ... &quot;} quoting<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{$attname}</span> = <span class="Statement">sprintf</span>(<span class="Constant">qq'{&quot;%s&quot;}'</span>, <span class="Identifier">$row-&gt;{$attname}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$atttype</span> <span class="Statement">eq</span> <span class="Constant">'char'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Add single quotes<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{$attname}</span> = <span class="Statement">sprintf</span>(<span class="Constant">&quot;'%s'&quot;</span>, <span class="Identifier">$row-&gt;{$attname}</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Expand booleans from 'f'/'t' to 'false'/'true'.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Some values might be other macros (eg FLOAT8PASSBYVAL),<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># don't change.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">elsif</span> (<span class="Identifier">$atttype</span> <span class="Statement">eq</span> <span class="Constant">'bool'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{$attname}</span> = <span class="Constant">'true'</span> <span class="Statement">if</span> <span class="Identifier">$row-&gt;{$attname}</span> <span class="Statement">eq</span> <span class="Constant">'t'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$row-&gt;{$attname}</span> = <span class="Constant">'false'</span> <span class="Statement">if</span> <span class="Identifier">$row-&gt;{$attname}</span> <span class="Statement">eq</span> <span class="Constant">'f'</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># We don't emit initializers for the variable length fields at all.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment"># Only the fixed-size portions of the descriptors are ever used.<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">delete</span> <span class="Identifier">$row-&gt;{$attname}</span> <span class="Statement">if</span> <span class="Identifier">$column-&gt;{</span><span class="Constant">is_varlen</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Perform OID lookups on an array of OID names.<br/></li>
<li></span><span class="Comment"># If we don't have a unique value to substitute, warn and<br/></li>
<li></span><span class="Comment"># leave the entry unchanged.<br/></li>
<li></span><span class="Comment"># (We don't exit right away so that we can detect multiple problems<br/></li>
<li></span><span class="Comment"># within this genbki.pl run.)<br/></li>
<li><a id="L1071">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">lookup_oids</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$lookup</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>, <span class="Identifier">$lookup_opt</span>, <span class="Identifier">$bki_values</span>, <span class="Identifier">@lookupnames</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; = <span class="Identifier">@_</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">@lookupoids</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">foreach</span> <span class="Statement">my</span> <span class="Identifier">$lookupname</span> (<span class="Identifier">@lookupnames</span>)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$lookupoid</span> = <span class="Identifier">$lookup-&gt;{$lookupname}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Statement">defined</span>(<span class="Identifier">$lookupoid</span>) <span class="Statement">and</span> <span class="Identifier">$lookupoid</span> <span class="Statement">ne</span> <span class="Constant">'MULTIPLE'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@lookupoids</span>, <span class="Identifier">$lookupoid</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">push</span> <span class="Identifier">@lookupoids</span>, <span class="Identifier">$lookupname</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<span class="Identifier">$lookupname</span> <span class="Statement">eq</span> <span class="Constant">'-'</span> <span class="Statement">or</span> <span class="Identifier">$lookupname</span> <span class="Statement">eq</span> <span class="Constant">'0'</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<span class="Identifier">$lookup_opt</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">warn</span> <span class="Statement">sprintf<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;invalid zero OID reference in %s.dat field %s line %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>, <span class="Identifier">$bki_values-&gt;{</span><span class="Constant">line_number</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$num_errors</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">warn</span> <span class="Statement">sprintf<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Constant">&quot;unresolved OID reference </span><span class="Special">\&quot;</span><span class="Constant">%s</span><span class="Special">\&quot;</span><span class="Constant"> in %s.dat field %s line %s</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$lookupname</span>, <span class="Identifier">$catname</span>, <span class="Identifier">$attname</span>, <span class="Identifier">$bki_values-&gt;{</span><span class="Constant">line_number</span><span class="Identifier">}</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Identifier">$num_errors</span>++;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Identifier">@lookupoids</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Determine canonical pg_type OID #define symbol from the type name.<br/></li>
<li><a id="L1110">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">form_pg_type_symbol</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$typename</span> = <span class="Statement">shift</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Skip for rowtypes of bootstrap catalogs, since they have their<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># own naming convention defined elsewhere.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement">if</span> <span class="Identifier">$typename</span> <span class="Statement">eq</span> <span class="Constant">'pg_type'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">or</span> <span class="Identifier">$typename</span> <span class="Statement">eq</span> <span class="Constant">'pg_proc'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">or</span> <span class="Identifier">$typename</span> <span class="Statement">eq</span> <span class="Constant">'pg_attribute'<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">or</span> <span class="Identifier">$typename</span> <span class="Statement">eq</span> <span class="Constant">'pg_class'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Transform like so:<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">#&nbsp; foo_bar&nbsp; -&gt;&nbsp; FOO_BAROID<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment"># _foo_bar&nbsp; -&gt;&nbsp; FOO_BARARRAYOID<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$typename</span> =~ <span class="Statement">/</span><span class="Special">(</span><span class="Constant">_</span><span class="Special">)?(.+)</span><span class="Statement">/</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$arraystr</span> = <span class="Identifier">$1</span> ? <span class="Constant">'ARRAY'</span> : <span class="Constant">''</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$name</span> = <span class="Statement">uc</span> <span class="Identifier">$2</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Identifier">$name</span> . <span class="Identifier">$arraystr</span> . <span class="Constant">'OID'</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment"># Assign an unused OID within the specified catalog.<br/></li>
<li><a id="L1132">&#x200c;</a></span><span class="Statement">sub </span><span class="Identifier"><span class="linkable">assign_next_oid</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$catname</span> = <span class="Statement">shift</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Initialize, if no previous request for this catalog.<br/></li>
<li></span>&nbsp; &nbsp; <span class="Identifier">$GenbkiNextOids{$catname}</span> = <span class="Identifier">$FirstGenbkiObjectId<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> !<span class="Statement">defined</span>(<span class="Identifier">$GenbkiNextOids{$catname}</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> <span class="Identifier">$result</span> = <span class="Identifier">$GenbkiNextOids{$catname}</span>++;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment"># Check that we didn't overrun available OIDs<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">die<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Constant">&quot;genbki OID counter for </span><span class="Identifier">$catname</span><span class="Constant"> reached </span><span class="Identifier">$result</span><span class="Constant">, overrunning FirstUnpinnedObjectId</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; <span class="Statement">if</span> <span class="Identifier">$result</span> &gt;= <span class="Identifier">$FirstUnpinnedObjectId</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Identifier">$result</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><a id="L1150">&#x200c;</a><span class="Statement">sub </span><span class="Identifier"><span class="linkable">print_boilerplate</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">my</span> (<span class="Identifier">$fh</span>, <span class="Identifier">$fname</span>, <span class="Identifier">$descr</span>) = <span class="Identifier">@_</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">printf</span> <span class="Identifier">$fh</span> <span class="Constant">&lt;&lt;EOM</span><span class="perlHereDocStart">, </span><span class="Identifier">$fname</span><span class="perlHereDocStart">, </span><span class="Identifier">$descr</span><span class="perlHereDocStart">;<br/></li>
<li></span><span class="Constant">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Constant"> *<br/></li>
<li></span><span class="Constant"> * %s<br/></li>
<li></span><span class="Constant"> *&nbsp; &nbsp; %s<br/></li>
<li></span><span class="Constant"> *<br/></li>
<li></span><span class="Constant"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Constant"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Constant"> *<br/></li>
<li></span><span class="Constant"> * NOTES<br/></li>
<li></span><span class="Constant"> *&nbsp; ******************************<br/></li>
<li></span><span class="Constant"> *&nbsp; *** DO NOT EDIT THIS FILE! ***<br/></li>
<li></span><span class="Constant"> *&nbsp; ******************************<br/></li>
<li></span><span class="Constant"> *<br/></li>
<li></span><span class="Constant"> *&nbsp; It has been GENERATED by src/backend/catalog/genbki.pl<br/></li>
<li></span><span class="Constant"> *<br/></li>
<li></span><span class="Constant"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Constant"> */<br/></li>
<li></span><span class="Constant">EOM<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><a id="L1174">&#x200c;</a><span class="Statement">sub </span><span class="Identifier"><span class="linkable">usage</span><br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">die</span> <span class="Constant">&lt;&lt;EOM</span><span class="perlHereDocStart">;<br/></li>
<li></span><span class="Constant">Usage: perl -I [directory of Catalog.pm] genbki.pl [--output/-o &lt;path&gt;] [--include-path/-i &lt;path&gt;] header...<br/></li>
<li></span><br/></li>
<li><span class="Constant">Options:<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; --output&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Output directory (default '.')<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; --set-version&nbsp; &nbsp; PostgreSQL version number for initdb cross-check<br/></li>
<li></span><span class="Constant">&nbsp; &nbsp; --include-path&nbsp;&nbsp; Include path in source tree<br/></li>
<li></span><br/></li>
<li><span class="Constant">genbki.pl generates postgres.bki and symbol definition<br/></li>
<li></span><span class="Constant">headers from specially formatted header files and .dat<br/></li>
<li></span><span class="Constant">files.&nbsp; postgres.bki is used to initialize the<br/></li>
<li></span><span class="Constant">postgres template database.<br/></li>
<li></span><br/></li>
<li><span class="Constant">Report bugs to &lt;pgsql-bugs</span><span class="Special">\@</span><span class="Constant">lists.postgresql.org&gt;.<br/></li>
<li></span><span class="Constant">EOM<br/></li>
<li></span>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
