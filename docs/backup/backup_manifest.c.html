<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>backup/backup_manifest.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>backup/backup_manifest.c - pgsql17devel-backend</h1>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L101">AddFileToBackupManifest</a></li>
<li><a href="#L212">AddWALInfoToBackupManifest</a></li>
<li><a href="#L383">AppendStringToManifest</a></li>
<li><a href="#L91">FreeBackupManifest</a></li>
<li><a href="#L56">InitializeBackupManifest</a></li>
<li><a href="#L33">IsManifestEnabled</a></li>
<li><a href="#L316">SendBackupManifest</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L41">AppendToManifest</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * backup_manifest.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; code for generating and sending a backup manifest<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 2010-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/backup/backup_manifest.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/timeline.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/xlog.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;backup/backup_manifest.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;backup/basebackup_sink.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;mb/pg_wchar.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/builtins.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/json.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(backup_manifest_info *manifest, <span class="Type">const</span> <span class="Type">char</span> *s);<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Does the user want a backup manifest?<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * It's simplest to always have a manifest_info object, so that we don't need<br/></li>
<li></span><span class="Comment"> * checks for NULL pointers in too many places. However, if the user doesn't<br/></li>
<li></span><span class="Comment"> * want a manifest, we set manifest-&gt;buffile to NULL.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">inline</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L33">&#x200c;</a></span><span class="linkable">IsManifestEnabled</span>(backup_manifest_info *manifest)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (manifest-&gt;buffile != <span class="Constant">NULL</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Convenience macro for appending data to the backup manifest.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L41">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">AppendToManifest</span>(manifest, ...) \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; { \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Type">char</span><span class="PreProc"> *_manifest_s = psprintf(</span><span class="Constant">__VA_ARGS__</span><span class="PreProc">);&nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, _manifest_s);&nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(_manifest_s);&nbsp; &nbsp; \<br/></li>
<li></span><span class="PreProc">&nbsp; &nbsp; }<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initialize state so that we can construct a backup manifest.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * NB: Although the checksum type for the data files is configurable, the<br/></li>
<li></span><span class="Comment"> * checksum for the manifest itself always uses SHA-256. See comments in<br/></li>
<li></span><span class="Comment"> * <a href="#L316" title="backup/backup_manifest.c:316">SendBackupManifest</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L56">&#x200c;</a></span><span class="linkable">InitializeBackupManifest</span>(backup_manifest_info *manifest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; backup_manifest_option want_manifest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pg_checksum_type manifest_checksum_type)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; memset(manifest, <span class="Constant">0</span>, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(backup_manifest_info));<br/></li>
<li>&nbsp; &nbsp; manifest-&gt;checksum_type = manifest_checksum_type;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (want_manifest == MANIFEST_OPTION_NO)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; manifest-&gt;buffile = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; manifest-&gt;buffile = <a href="../storage/file/buffile.c.html#L193" title="storage/file/buffile.c:193">BufFileCreateTemp</a>(<span class="Constant">false</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; manifest-&gt;manifest_ctx = pg_cryptohash_create(PG_SHA256);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_cryptohash_init(manifest-&gt;manifest_ctx) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;failed to <a href="../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> checksum of backup manifest: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pg_cryptohash_error(manifest-&gt;manifest_ctx));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; manifest-&gt;manifest_size = UINT64CONST(<span class="Constant">0</span>);<br/></li>
<li>&nbsp; &nbsp; manifest-&gt;force_encode = (want_manifest == MANIFEST_OPTION_FORCE_ENCODE);<br/></li>
<li>&nbsp; &nbsp; manifest-&gt;first_file = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; manifest-&gt;still_checksumming = <span class="Constant">true</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (want_manifest != MANIFEST_OPTION_NO)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L41" title="backup/backup_manifest.c:41">AppendToManifest</a>(manifest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">PostgreSQL-Backup-Manifest-Version</span><span class="Special">\&quot;</span><span class="Constant">: 2,</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">System-Identifier</span><span class="Special">\&quot;</span><span class="Constant">: &quot;</span> UINT64_FORMAT <span class="Constant">&quot;,</span><span class="Special">\n</span><span class="Constant">&quot;<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">Files</span><span class="Special">\&quot;</span><span class="Constant">: [&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../access/transam/xlog.c.html#L4535" title="access/transam/xlog.c:4535">GetSystemIdentifier</a>());<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Free resources assigned to a backup manifest constructed.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L91">&#x200c;</a></span><span class="linkable">FreeBackupManifest</span>(backup_manifest_info *manifest)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; pg_cryptohash_free(manifest-&gt;manifest_ctx);<br/></li>
<li>&nbsp; &nbsp; manifest-&gt;manifest_ctx = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Add an entry to the backup manifest for a file.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L101">&#x200c;</a></span><span class="linkable">AddFileToBackupManifest</span>(backup_manifest_info *manifest, Oid spcoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *pathname, <span class="Type">size_t</span> size, pg_time_t mtime,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pg_checksum_context *checksum_ctx)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; pathbuf[MAXPGPATH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pathlen;<br/></li>
<li>&nbsp; &nbsp; StringInfoData buf;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L33" title="backup/backup_manifest.c:33">IsManifestEnabled</a>(manifest))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * If this file is part of a tablespace, the pathname passed to this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * function will be relative to the tar file that contains it. We want the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pathname relative to the data directory (ignoring the intermediate<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * symlink traversal).<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (OidIsValid(spcoid))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; snprintf(pathbuf, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(pathbuf), <span class="Constant">&quot;pg_tblspc/</span><span class="Special">%u</span><span class="Constant">/</span><span class="Special">%s</span><span class="Constant">&quot;</span>, spcoid,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pathname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; pathname = pathbuf;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Each file's entry needs to be separated from <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> entry that follows by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * a comma, but there's no comma <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the first one or after the last<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * one. To make that work, adding a file to the manifest starts by<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * terminating the most recently added line, with a comma if appropriate,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * but does not terminate the line inserted for this file.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; initStringInfo(&amp;buf);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (manifest-&gt;first_file)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoChar(&amp;buf, <span class="Special">'\n'</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; manifest-&gt;first_file = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot;,</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Write the relative pathname to this file out to the manifest. The<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * manifest is always stored in UTF-8, so we have to encode paths that are<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * not valid in that encoding.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; pathlen = strlen(pathname);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!manifest-&gt;force_encode &amp;&amp;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mb/mbutils.c.html#L1566" title="utils/mb/mbutils.c:1566">pg_verify_mbstr</a>(PG_UTF8, pathname, pathlen, <span class="Constant">true</span>))<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">Path</span><span class="Special">\&quot;</span><span class="Constant">: &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/adt/json.c.html#L1549" title="utils/adt/json.c:1549">escape_json</a>(&amp;buf, pathname);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot;, &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot;{ </span><span class="Special">\&quot;</span><span class="Constant">Encoded-Path</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; enlargeStringInfo(&amp;buf, <span class="Constant">2</span> * pathlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf.len += <a href="../utils/adt/encode.c.html#L162" title="utils/adt/encode.c:162">hex_encode</a>(pathname, pathlen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;buf.data[buf.len]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">, &quot;</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; appendStringInfo(&amp;buf, <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">Size</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">%zu</span><span class="Constant">, &quot;</span>, size);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Convert last modification time to a string and append it to the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * manifest. Since it's not clear what time zone to use and since time<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * zone definitions can change, possibly causing confusion, use GMT<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * always.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">Last-Modified</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; enlargeStringInfo(&amp;buf, <span class="Constant">128</span>);<br/></li>
<li>&nbsp; &nbsp; buf.len += pg_strftime(&amp;buf.data[buf.len], <span class="Constant">128</span>, <span class="Constant">&quot;%Y-%m-</span><span class="Special">%d</span><span class="Constant"> %H:%M:</span><span class="Special">%S</span><span class="Constant"> %Z&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pg_gmtime(&amp;mtime));<br/></li>
<li>&nbsp; &nbsp; appendStringInfoChar(&amp;buf, <span class="Constant">'&quot;'</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Add checksum information. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (checksum_ctx-&gt;type != CHECKSUM_TYPE_NONE)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; checksumbuf[PG_CHECKSUM_MAX_LENGTH];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; checksumlen;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; checksumlen = pg_checksum_final(checksum_ctx, checksumbuf);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (checksumlen &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not finalize checksum of file </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pathname);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfo(&amp;buf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;, </span><span class="Special">\&quot;</span><span class="Constant">Checksum-Algorithm</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;%s\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">Checksum</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pg_checksum_type_name(checksum_ctx-&gt;type));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; enlargeStringInfo(&amp;buf, <span class="Constant">2</span> * checksumlen);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; buf.len += <a href="../utils/adt/encode.c.html#L162" title="utils/adt/encode.c:162">hex_encode</a>((<span class="Type">char</span> *) checksumbuf, checksumlen,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;buf.data[buf.len]);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; appendStringInfoChar(&amp;buf, <span class="Constant">'&quot;'</span>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Close out the object. */<br/></li>
<li></span>&nbsp; &nbsp; appendStringInfoString(&amp;buf, <span class="Constant">&quot; }&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* OK, add it to the manifest. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, buf.data);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Avoid leaking memory. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(buf.data);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Add information about the WAL that will need to be replayed when restoring<br/></li>
<li></span><span class="Comment"> * this backup to the manifest.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L212">&#x200c;</a></span><span class="linkable">AddWALInfoToBackupManifest</span>(backup_manifest_info *manifest, XLogRecPtr startptr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TimeLineID starttli, XLogRecPtr endptr,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; TimeLineID endtli)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; List&nbsp; &nbsp; &nbsp;&nbsp; *timelines;<br/></li>
<li>&nbsp; &nbsp; ListCell&nbsp;&nbsp; *lc;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; first_wal_range = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found_start_timeline = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L33" title="backup/backup_manifest.c:33">IsManifestEnabled</a>(manifest))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Terminate the list of files. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">],</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Read the timeline history for the ending timeline. */<br/></li>
<li></span>&nbsp; &nbsp; timelines = <a href="../access/transam/timeline.c.html#L76" title="access/transam/timeline.c:76">readTimeLineHistory</a>(endtli);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Start a list of LSN ranges. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">WAL-<a href="../access/brin/brin_minmax_multi.c.html#L170" title="access/brin/brin_minmax_multi.c:170">Ranges</a></span><span class="Special">\&quot;</span><span class="Constant">: [</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; foreach(lc, timelines)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; TimeLineHistoryEntry *entry = lfirst(lc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; XLogRecPtr&nbsp; &nbsp; tl_beginptr;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * We only care about timelines that were active during the backup.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Skip <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> that ended <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> the backup started. (Note that if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * entry-&gt;end is InvalidXLogRecPtr, it means that the timeline has not<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * yet ended.)<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!XLogRecPtrIsInvalid(entry-&gt;end) &amp;&amp; entry-&gt;end &lt; startptr)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Because the timeline history file lists newer timelines <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * older ones, the first timeline we encounter that is new enough to<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * matter ought to match the ending timeline of the backup.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (first_wal_range &amp;&amp; endtli != entry-&gt;tli)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;expected end timeline </span><span class="Special">%u</span><span class="Constant"> but found timeline </span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; starttli, entry-&gt;tli));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If this timeline entry matches with the timeline on which the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * backup started, WAL needs to be checked from the start LSN of the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * backup.&nbsp; If this entry refers to a newer timeline, WAL needs to be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * checked since the beginning of this timeline, so use the LSN where<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * the timeline began.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (starttli == entry-&gt;tli)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tl_beginptr = startptr;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tl_beginptr = entry-&gt;begin;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * If we reach a TLI that has no valid beginning LSN, there can't<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * be <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> more timelines in the history after this point, so we'd<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * better have arrived at the expected starting TLI. If not,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * something's gone horribly wrong.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (XLogRecPtrIsInvalid(entry-&gt;begin))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;expected start timeline </span><span class="Special">%u</span><span class="Constant"> but found timeline </span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; starttli, entry-&gt;tli));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L41" title="backup/backup_manifest.c:41">AppendToManifest</a>(manifest,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Constant">&quot;</span><span class="Special">%s</span><span class="Constant">{ </span><span class="Special">\&quot;</span><span class="Constant">Timeline</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">%u</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">Start-LSN</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;%X</span><span class="Constant">/</span><span class="Special">%X\&quot;</span><span class="Constant">, </span><span class="Special">\&quot;</span><span class="Constant">End-LSN</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;%X</span><span class="Constant">/</span><span class="Special">%X\&quot;</span><span class="Constant"> }&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; first_wal_range ? <span class="Constant">&quot;&quot;</span> : <span class="Constant">&quot;,</span><span class="Special">\n</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; entry-&gt;tli,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; LSN_FORMAT_ARGS(tl_beginptr),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; LSN_FORMAT_ARGS(endptr));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (starttli == entry-&gt;tli)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; found_start_timeline = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; endptr = entry-&gt;begin;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; first_wal_range = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * The last entry in the timeline history for the ending timeline should<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * be the ending timeline itself. Verify that this is what we observed.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!found_start_timeline)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;start timeline </span><span class="Special">%u</span><span class="Constant"> not found in history of timeline </span><span class="Special">%u</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; starttli, endtli));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Terminate the list of WAL ranges. */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, <span class="Constant">&quot;</span><span class="Special">\n</span><span class="Constant">],</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Finalize the backup manifest, and <a href="../port/win32/socket.c.html#L38" title="port/win32/socket.c:38">send</a> it to the client.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L316">&#x200c;</a></span><span class="linkable">SendBackupManifest</span>(backup_manifest_info *manifest, bbsink *sink)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; uint8&nbsp; &nbsp; &nbsp; &nbsp; checksumbuf[PG_SHA256_DIGEST_LENGTH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; checksumstringbuf[PG_SHA256_DIGEST_STRING_LENGTH];<br/></li>
<li>&nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; manifest_bytes_done = <span class="Constant">0</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L33" title="backup/backup_manifest.c:33">IsManifestEnabled</a>(manifest))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Append manifest checksum, so that the problems with the manifest itself<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * can be detected.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; *<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We always use SHA-256 for this, regardless of what algorithm is chosen<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * for checksumming the files.&nbsp; If we ever want to make the checksum<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * algorithm used for the manifest file variable, the client will need a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * way to figure out which algorithm to use as close to the beginning of<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * the manifest file as possible, to avoid having to read the whole thing<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * twice.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; manifest-&gt;still_checksumming = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (pg_cryptohash_final(manifest-&gt;manifest_ctx, checksumbuf,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(checksumbuf)) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;failed to finalize checksum of backup manifest: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pg_cryptohash_error(manifest-&gt;manifest_ctx));<br/></li>
<li>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">Manifest-Checksum</span><span class="Special">\&quot;</span><span class="Constant">: </span><span class="Special">\&quot;</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/adt/encode.c.html#L162" title="utils/adt/encode.c:162">hex_encode</a>((<span class="Type">char</span> *) checksumbuf, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span> checksumbuf, checksumstringbuf);<br/></li>
<li>&nbsp; &nbsp; checksumstringbuf[PG_SHA256_DIGEST_STRING_LENGTH - <span class="Constant">1</span>] = <span class="Special">'\0'</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, checksumstringbuf);<br/></li>
<li>&nbsp; &nbsp; <a href="#L383" title="backup/backup_manifest.c:383">AppendStringToManifest</a>(manifest, <span class="Constant">&quot;</span><span class="Special">\&quot;</span><span class="Constant">}</span><span class="Special">\n</span><span class="Constant">&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We've written all the data to the manifest file.&nbsp; Rewind the file so<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * that we can read it all back.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="../storage/file/buffile.c.html#L740" title="storage/file/buffile.c:740">BufFileSeek</a>(manifest-&gt;buffile, <span class="Constant">0</span>, <span class="Constant">0</span>, <span class="Constant">SEEK_SET</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L882" title="utils/error/elog.c:882">errcode_for_file_access</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not rewind temporary file&quot;</span>)));<br/></li>
<li><br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Send the backup manifest.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; bbsink_begin_manifest(sink);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">while</span> (manifest_bytes_done &lt; manifest-&gt;manifest_size)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">size_t</span>&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_read;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bytes_to_read = <a href="../jit/llvm/llvmjit_inline.cpp.html#L46" title="jit/llvm/llvmjit_inline.cpp:46">Min</a>(sink-&gt;bbs_buffer_length,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; manifest-&gt;manifest_size - manifest_bytes_done);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../storage/file/buffile.c.html#L654" title="storage/file/buffile.c:654">BufFileReadExact</a>(manifest-&gt;buffile, sink-&gt;bbs_buffer, bytes_to_read);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; bbsink_manifest_contents(sink, bytes_to_read);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; manifest_bytes_done += bytes_to_read;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; bbsink_end_manifest(sink);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release resources */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../storage/file/buffile.c.html#L412" title="storage/file/buffile.c:412">BufFileClose</a>(manifest-&gt;buffile);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Append a cstring to the manifest.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L383">&#x200c;</a></span><span class="linkable">AppendStringToManifest</span>(backup_manifest_info *manifest, <span class="Type">const</span> <span class="Type">char</span> *s)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; len = strlen(s);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(manifest != <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (manifest-&gt;still_checksumming)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (pg_cryptohash_update(manifest-&gt;manifest_ctx, (uint8 *) s, len) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;failed to update checksum of backup manifest: </span><span class="Special">%s</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pg_cryptohash_error(manifest-&gt;manifest_ctx));<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <a href="../storage/file/buffile.c.html#L676" title="storage/file/buffile.c:676">BufFileWrite</a>(manifest-&gt;buffile, s, len);<br/></li>
<li>&nbsp; &nbsp; manifest-&gt;manifest_size += len;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
