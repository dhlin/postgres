<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>port/win32_sema.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>port/win32_sema.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L22">maxSems</a></li>
<li><a href="#L20">mySemSet</a></li>
<li><a href="#L21">numSems</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L47">PGReserveSemaphores</a></li>
<li><a href="#L79">PGSemaphoreCreate</a></li>
<li><a href="#L132">PGSemaphoreLock</a></li>
<li><a href="#L116">PGSemaphoreReset</a></li>
<li><a href="#L31">PGSemaphoreShmemSize</a></li>
<li><a href="#L210">PGSemaphoreTryLock</a></li>
<li><a href="#L196">PGSemaphoreUnlock</a></li>
<li><a href="#L64">ReleaseSemaphores</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * win32_sema.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; Microsoft Windows Win32 Semaphores Emulation<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/port/win32_sema.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/ipc.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/pg_sema.h&quot;<br/></li>
<li></span><br/></li>
<li><a id="L20">&#x200c;</a><span class="Type">static</span> HANDLE *<span class="linkable">mySemSet</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* IDs of sema sets acquired so far */<br/></li>
<li><a id="L21">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">numSems</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* number of sema sets acquired so far */<br/></li>
<li><a id="L22">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">maxSems</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* allocated size of mySemaSet array */<br/></li>
<li></span><br/></li>
<li><span class="Type">static</span> <span class="Type">void</span> <a href="posix_sema.c.html#L240" title="port/posix_sema.c:240">ReleaseSemaphores</a>(<span class="Type">int</span> code, Datum arg);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Report amount of shared memory needed for semaphores<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L31">&#x200c;</a><span class="linkable">PGSemaphoreShmemSize</span>(<span class="Type">int</span> maxSemas)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* No shared memory needed on Windows */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="posix_sema.c.html#L196" title="port/posix_sema.c:196">PGReserveSemaphores</a> --- <a href="../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> semaphore support<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In the Win32 implementation, we acquire semaphores on-demand; the<br/></li>
<li></span><span class="Comment"> * maxSemas parameter is just used to size the array that keeps track of<br/></li>
<li></span><span class="Comment"> * acquired semas for subsequent releasing.&nbsp; We use anonymous semaphores<br/></li>
<li></span><span class="Comment"> * so the semaphores are automatically freed when the last referencing<br/></li>
<li></span><span class="Comment"> * process exits.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L47">&#x200c;</a></span><span class="linkable">PGReserveSemaphores</span>(<span class="Type">int</span> maxSemas)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L20" title="port/win32_sema.c:20">mySemSet</a> = (HANDLE *) malloc(maxSemas * <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(HANDLE));<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L20" title="port/win32_sema.c:20">mySemSet</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(PANIC, <span class="Constant">&quot;out of memory&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <a href="posix_sema.c.html#L66" title="port/posix_sema.c:66">numSems</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <a href="posix_sema.c.html#L67" title="port/posix_sema.c:67">maxSems</a> = maxSemas;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../storage/ipc/ipc.c.html#L365" title="storage/ipc/ipc.c:365">on_shmem_exit</a>(<a href="posix_sema.c.html#L240" title="port/posix_sema.c:240">ReleaseSemaphores</a>, <span class="Constant">0</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Release semaphores at shutdown or shmem reinitialization<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * (called as an <a href="../storage/ipc/ipc.c.html#L365" title="storage/ipc/ipc.c:365">on_shmem_exit</a> callback, hence funny argument list)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L64">&#x200c;</a></span><span class="linkable">ReleaseSemaphores</span>(<span class="Type">int</span> code, Datum arg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; <a href="posix_sema.c.html#L66" title="port/posix_sema.c:66">numSems</a>; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CloseHandle(<a href="#L20" title="port/win32_sema.c:20">mySemSet</a>[i]);<br/></li>
<li>&nbsp; &nbsp; free(<a href="#L20" title="port/win32_sema.c:20">mySemSet</a>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="posix_sema.c.html#L262" title="port/posix_sema.c:262">PGSemaphoreCreate</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Allocate a PGSemaphore structure with initial count 1<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>PGSemaphore<br/></li>
<li><a id="L79">&#x200c;</a><span class="linkable">PGSemaphoreCreate</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; cur_handle;<br/></li>
<li>&nbsp; &nbsp; SECURITY_ATTRIBUTES sec_attrs;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Can't do this in a backend, because static state is postmaster's */<br/></li>
<li></span>&nbsp; &nbsp; Assert(!<a href="../utils/init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="posix_sema.c.html#L66" title="port/posix_sema.c:66">numSems</a> &gt;= <a href="posix_sema.c.html#L67" title="port/posix_sema.c:67">maxSems</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(PANIC, <span class="Constant">&quot;too many semaphores created&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ZeroMemory(&amp;sec_attrs, <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(sec_attrs));<br/></li>
<li>&nbsp; &nbsp; sec_attrs.nLength = <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(sec_attrs);<br/></li>
<li>&nbsp; &nbsp; sec_attrs.lpSecurityDescriptor = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; sec_attrs.bInheritHandle = TRUE;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* We don't need a named semaphore */<br/></li>
<li></span>&nbsp; &nbsp; cur_handle = CreateSemaphore(&amp;sec_attrs, <span class="Constant">1</span>, <span class="Constant">32767</span>, <span class="Constant">NULL</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (cur_handle)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Successfully done */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L20" title="port/win32_sema.c:20">mySemSet</a>[<a href="posix_sema.c.html#L66" title="port/posix_sema.c:66">numSems</a>++] = cur_handle;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; ereport(PANIC,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not create semaphore: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (PGSemaphore) cur_handle;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="posix_sema.c.html#L295" title="port/posix_sema.c:295">PGSemaphoreReset</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Reset a previously-initialized PGSemaphore to have count 0<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L116">&#x200c;</a></span><span class="linkable">PGSemaphoreReset</span>(PGSemaphore sema)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * There's no direct API for this in Win32, so we have to ratchet the<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * semaphore down to 0 with repeated trylock's.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (<a href="posix_sema.c.html#L365" title="port/posix_sema.c:365">PGSemaphoreTryLock</a>(sema))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Comment">/* loop */</span> ;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="posix_sema.c.html#L320" title="port/posix_sema.c:320">PGSemaphoreLock</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Lock a semaphore (decrement count), blocking if count would be &lt; 0.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L132">&#x200c;</a></span><span class="linkable">PGSemaphoreLock</span>(PGSemaphore sema)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; HANDLE&nbsp; &nbsp; &nbsp; &nbsp; wh[<span class="Constant">2</span>];<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; done = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note: <a href="win32/signal.c.html#L27" title="port/win32/signal.c:27">pgwin32_signal_event</a> should be first to ensure that it will be<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * reported when multiple events are set.&nbsp; We want to guarantee that<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * pending signals are serviced.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; wh[<span class="Constant">0</span>] = <a href="win32/signal.c.html#L27" title="port/win32/signal.c:27">pgwin32_signal_event</a>;<br/></li>
<li>&nbsp; &nbsp; wh[<span class="Constant">1</span>] = sema;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * As in other implementations of <a href="posix_sema.c.html#L320" title="port/posix_sema.c:320">PGSemaphoreLock</a>, we need to check for<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * cancel/<a href="../tcop/postgres.c.html#L2972" title="tcop/postgres.c:2972">die</a> interrupts each time through the loop.&nbsp; But here, there is<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * no hidden magic about whether the syscall will internally service a<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * signal --- we do that ourselves.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">while</span> (!done)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; CHECK_FOR_INTERRUPTS();<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = WaitForMultipleObjectsEx(<span class="Constant">2</span>, wh, FALSE, INFINITE, TRUE);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">switch</span> (rc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WAIT_OBJECT_0:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Signal event is set - we have a signal to deliver */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="win32/signal.c.html#L120" title="port/win32/signal.c:120">pgwin32_dispatch_queued_signals</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WAIT_OBJECT_0 + <span class="Constant">1</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* We got it! */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WAIT_IO_COMPLETION:<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * The system interrupted the wait to execute an I/O<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * completion routine or asynchronous procedure call in this<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * thread.&nbsp; PostgreSQL does not provoke either of these, but<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * atypical loaded DLLs or even other processes might do so.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Now, resume <a href="../storage/ipc/latch.c.html#L162" title="storage/ipc/latch.c:162">waiting</a>.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">case</span> WAIT_FAILED:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(FATAL,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not lock semaphore: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">default</span>:<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(FATAL, <span class="Constant">&quot;unexpected return code from WaitForMultipleObjectsEx(): </span><span class="Special">%lu</span><span class="Constant">&quot;</span>, rc);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="posix_sema.c.html#L340" title="port/posix_sema.c:340">PGSemaphoreUnlock</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Unlock a semaphore (increment count)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L196">&#x200c;</a></span><span class="linkable">PGSemaphoreUnlock</span>(PGSemaphore sema)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!ReleaseSemaphore(sema, <span class="Constant">1</span>, <span class="Constant">NULL</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; ereport(FATAL,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not unlock semaphore: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="posix_sema.c.html#L365" title="port/posix_sema.c:365">PGSemaphoreTryLock</a><br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Lock a semaphore only if able to do so without blocking<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L210">&#x200c;</a></span><span class="linkable">PGSemaphoreTryLock</span>(PGSemaphore sema)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; DWORD&nbsp; &nbsp; &nbsp; &nbsp; ret;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; ret = WaitForSingleObject(sema, <span class="Constant">0</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (ret == WAIT_OBJECT_0)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* We got it! */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (ret == WAIT_TIMEOUT)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Can't get it */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; errno = <span class="Constant">EAGAIN</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Otherwise we are in trouble */<br/></li>
<li></span>&nbsp; &nbsp; ereport(FATAL,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<a href="../utils/error/elog.c.html#L1072" title="utils/error/elog.c:1072">errmsg</a>(<span class="Constant">&quot;could not try-lock semaphore: error code </span><span class="Special">%lu</span><span class="Constant">&quot;</span>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetLastError())));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* keep compiler quiet */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
