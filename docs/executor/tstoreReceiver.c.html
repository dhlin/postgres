<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>executor/tstoreReceiver.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

  <h1>executor/tstoreReceiver.c - pgsql17devel-backend</h1>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L44">TStoreState</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L238">CreateTuplestoreDestReceiver</a></li>
<li><a href="#L266">SetTuplestoreDestReceiverParams</a></li>
<li><a href="#L229">tstoreDestroyReceiver</a></li>
<li><a href="#L136">tstoreReceiveSlot_detoast</a></li>
<li><a href="#L122">tstoreReceiveSlot_notoast</a></li>
<li><a href="#L192">tstoreReceiveSlot_tupmap</a></li>
<li><a href="#L206">tstoreShutdownReceiver</a></li>
<li><a href="#L56">tstoreStartupReceiver</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * tstoreReceiver.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; An implementation of DestReceiver that stores the result tuples in<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; a Tuplestore.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Optionally, we can force detoasting (but not decompression) of out-of-line<br/></li>
<li></span><span class="Comment"> * toasted <a href="../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>.&nbsp; This is to support cursors WITH HOLD, which must retain<br/></li>
<li></span><span class="Comment"> * data even if the underlying table is dropped.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Also optionally, we can apply a tuple conversion map <a href="../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> storing.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/executor/tstoreReceiver.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;access/detoast.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;access/tupconvert.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;executor/tstoreReceiver.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Type">typedef</span> <span class="Type">struct<br/></li>
<li></span>{<br/></li>
<li>&nbsp; &nbsp; DestReceiver pub;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* parameters: */<br/></li>
<li></span>&nbsp; &nbsp; <a href="../utils/sort/tuplestore.c.html#L103" title="utils/sort/tuplestore.c:103">Tuplestorestate</a> *tstore;&nbsp; &nbsp; <span class="Comment">/* where to put the data */<br/></li>
<li></span>&nbsp; &nbsp; MemoryContext cxt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* context containing tstore */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; detoast;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* were we told to detoast? */<br/></li>
<li></span>&nbsp; &nbsp; TupleDesc&nbsp; &nbsp; target_tupdesc; <span class="Comment">/* target tupdesc, or NULL if <a href="../optimizer/util/predtest.c.html#L1670" title="optimizer/util/predtest.c:1670">none</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *map_failure_msg;&nbsp; &nbsp; <span class="Comment">/* tupdesc mapping failure message */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* workspace: */<br/></li>
<li></span>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *outvalues;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> array for result tuple */<br/></li>
<li></span>&nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp;&nbsp; *tofree;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* temp <a href="../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> to be <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>'d */<br/></li>
<li></span>&nbsp; &nbsp; TupleConversionMap *tupmap; <span class="Comment">/* conversion map, if needed */<br/></li>
<li></span>&nbsp; &nbsp; TupleTableSlot *mapslot;&nbsp; &nbsp; <span class="Comment">/* slot for mapped tuples */<br/></li>
<li><a id="L44">&#x200c;</a></span>} <span class="linkable">TStoreState</span>;<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L122" title="executor/tstoreReceiver.c:122">tstoreReceiveSlot_notoast</a>(TupleTableSlot *slot, DestReceiver *self);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L136" title="executor/tstoreReceiver.c:136">tstoreReceiveSlot_detoast</a>(TupleTableSlot *slot, DestReceiver *self);<br/></li>
<li><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> <a href="#L192" title="executor/tstoreReceiver.c:192">tstoreReceiveSlot_tupmap</a>(TupleTableSlot *slot, DestReceiver *self);<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Prepare to receive tuples from executor.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L56">&#x200c;</a></span><span class="linkable">tstoreStartupReceiver</span>(DestReceiver *self, <span class="Type">int</span> operation, TupleDesc typeinfo)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *myState = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) self;<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; needtoast = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; natts = typeinfo-&gt;natts;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check if <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> columns require detoast work */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (myState-&gt;detoast)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; natts; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Form_pg_attribute attr = TupleDescAttr(typeinfo, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (attr-&gt;attisdropped)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">continue</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (attr-&gt;attlen == -<span class="Constant">1</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; needtoast = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">break</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Check if tuple conversion is needed */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (myState-&gt;target_tupdesc)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;tupmap = <a href="../access/common/tupconvert.c.html#L59" title="access/common/tupconvert.c:59">convert_tuples_by_position</a>(typeinfo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; myState-&gt;target_tupdesc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; myState-&gt;map_failure_msg);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;tupmap = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Set up appropriate callback */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (needtoast)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Assert(!myState-&gt;tupmap);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;pub.receiveSlot = <a href="#L136" title="executor/tstoreReceiver.c:136">tstoreReceiveSlot_detoast</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* Create workspace */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;outvalues = (Datum *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(myState-&gt;cxt, natts * <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Datum));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;tofree = (Datum *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1180" title="utils/mmgr/mcxt.c:1180">MemoryContextAlloc</a>(myState-&gt;cxt, natts * <span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(Datum));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;mapslot = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (myState-&gt;tupmap)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;pub.receiveSlot = <a href="#L192" title="executor/tstoreReceiver.c:192">tstoreReceiveSlot_tupmap</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;outvalues = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;tofree = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;mapslot = <a href="execTuples.c.html#L1325" title="executor/execTuples.c:1325">MakeSingleTupleTableSlot</a>(myState-&gt;target_tupdesc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;<a href="execTuples.c.html#L84" title="executor/execTuples.c:84">TTSOpsVirtual</a>);<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;pub.receiveSlot = <a href="#L122" title="executor/tstoreReceiver.c:122">tstoreReceiveSlot_notoast</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;outvalues = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;tofree = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;mapslot = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Receive a tuple from the executor and store it in the tuplestore.<br/></li>
<li></span><span class="Comment"> * This is for the easy case where we don't have to detoast nor map anything.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L122">&#x200c;</a></span><span class="linkable">tstoreReceiveSlot_notoast</span>(TupleTableSlot *slot, DestReceiver *self)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *myState = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) self;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../utils/sort/tuplestore.c.html#L708" title="utils/sort/tuplestore.c:708">tuplestore_puttupleslot</a>(myState-&gt;tstore, slot);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Receive a tuple from the executor and store it in the tuplestore.<br/></li>
<li></span><span class="Comment"> * This is for the case where we have to detoast <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> toasted <a href="../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a>.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L136">&#x200c;</a></span><span class="linkable">tstoreReceiveSlot_detoast</span>(TupleTableSlot *slot, DestReceiver *self)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *myState = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) self;<br/></li>
<li>&nbsp; &nbsp; TupleDesc&nbsp; &nbsp; typeinfo = slot-&gt;tts_tupleDescriptor;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; natts = typeinfo-&gt;natts;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nfree;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;<br/></li>
<li>&nbsp; &nbsp; MemoryContext oldcxt;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Make sure the tuple is fully deconstructed */<br/></li>
<li></span>&nbsp; &nbsp; slot_getallattrs(slot);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Fetch back <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> out-of-line datums.&nbsp; We build the new datums array in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * myState-&gt;outvalues[] (but we can re-use the slot's isnull array). Also,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * remember the fetched <a href="../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> to free afterwards.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; nfree = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; natts; i++)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Datum&nbsp; &nbsp; &nbsp; &nbsp; val = slot-&gt;tts_values[i];<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; Form_pg_attribute attr = TupleDescAttr(typeinfo, i);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!attr-&gt;attisdropped &amp;&amp; attr-&gt;attlen == -<span class="Constant">1</span> &amp;&amp; !slot-&gt;tts_isnull[i])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (VARATT_IS_EXTERNAL(DatumGetPointer(val)))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; val = PointerGetDatum(<a href="../access/common/detoast.c.html#L45" title="access/common/detoast.c:45">detoast_external_attr</a>((<span class="Type">struct</span> varlena *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DatumGetPointer(val)));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;tofree[nfree++] = val;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; myState-&gt;outvalues[i] = val;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Push the modified tuple into the tuplestore.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; oldcxt = MemoryContextSwitchTo(myState-&gt;cxt);<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/sort/tuplestore.c.html#L750" title="utils/sort/tuplestore.c:750">tuplestore_putvalues</a>(myState-&gt;tstore, typeinfo,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; myState-&gt;outvalues, slot-&gt;tts_isnull);<br/></li>
<li>&nbsp; &nbsp; MemoryContextSwitchTo(oldcxt);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* And release <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> temporary detoasted <a href="../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (i = <span class="Constant">0</span>; i &lt; nfree; i++)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(DatumGetPointer(myState-&gt;tofree[i]));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Receive a tuple from the executor and store it in the tuplestore.<br/></li>
<li></span><span class="Comment"> * This is for the case where we must apply a tuple conversion map.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L192">&#x200c;</a></span><span class="linkable">tstoreReceiveSlot_tupmap</span>(TupleTableSlot *slot, DestReceiver *self)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *myState = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) self;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="../access/common/tupconvert.c.html#L192" title="access/common/tupconvert.c:192">execute_attr_map_slot</a>(myState-&gt;tupmap-&gt;attrMap, slot, myState-&gt;mapslot);<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/sort/tuplestore.c.html#L708" title="utils/sort/tuplestore.c:708">tuplestore_puttupleslot</a>(myState-&gt;tstore, myState-&gt;mapslot);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Clean up at end of an executor run<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L206">&#x200c;</a></span><span class="linkable">tstoreShutdownReceiver</span>(DestReceiver *self)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *myState = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) self;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Release workspace if <a href="../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (myState-&gt;outvalues)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(myState-&gt;outvalues);<br/></li>
<li>&nbsp; &nbsp; myState-&gt;outvalues = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (myState-&gt;tofree)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(myState-&gt;tofree);<br/></li>
<li>&nbsp; &nbsp; myState-&gt;tofree = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (myState-&gt;tupmap)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="../access/common/tupconvert.c.html#L299" title="access/common/tupconvert.c:299">free_conversion_map</a>(myState-&gt;tupmap);<br/></li>
<li>&nbsp; &nbsp; myState-&gt;tupmap = <span class="Constant">NULL</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (myState-&gt;mapslot)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="execTuples.c.html#L1341" title="executor/execTuples.c:1341">ExecDropSingleTupleTableSlot</a>(myState-&gt;mapslot);<br/></li>
<li>&nbsp; &nbsp; myState-&gt;mapslot = <span class="Constant">NULL</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Destroy receiver when done with it<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L229">&#x200c;</a></span><span class="linkable">tstoreDestroyReceiver</span>(DestReceiver *self)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(self);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Initially create a DestReceiver object.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>DestReceiver *<br/></li>
<li><a id="L238">&#x200c;</a><span class="linkable">CreateTuplestoreDestReceiver</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *self = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) <a href="../utils/mmgr/mcxt.c.html#L1346" title="utils/mmgr/mcxt.c:1346">palloc0</a>(<span class="Statement"><a href="../storage/page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a>));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; self-&gt;pub.receiveSlot = <a href="#L122" title="executor/tstoreReceiver.c:122">tstoreReceiveSlot_notoast</a>;&nbsp; &nbsp; <span class="Comment">/* might change */<br/></li>
<li></span>&nbsp; &nbsp; self-&gt;pub.rStartup = <a href="#L56" title="executor/tstoreReceiver.c:56">tstoreStartupReceiver</a>;<br/></li>
<li>&nbsp; &nbsp; self-&gt;pub.rShutdown = <a href="#L206" title="executor/tstoreReceiver.c:206">tstoreShutdownReceiver</a>;<br/></li>
<li>&nbsp; &nbsp; self-&gt;pub.rDestroy = <a href="#L229" title="executor/tstoreReceiver.c:229">tstoreDestroyReceiver</a>;<br/></li>
<li>&nbsp; &nbsp; self-&gt;pub.mydest = DestTuplestore;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* private fields will be set by <a href="#L266" title="executor/tstoreReceiver.c:266">SetTuplestoreDestReceiverParams</a> */<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> (DestReceiver *) self;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Set parameters for a TuplestoreDestReceiver<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * tStore: where to store the tuples<br/></li>
<li></span><span class="Comment"> * tContext: memory context containing tStore<br/></li>
<li></span><span class="Comment"> * detoast: forcibly detoast contained data?<br/></li>
<li></span><span class="Comment"> * target_tupdesc: if not NULL, forcibly convert tuples to this rowtype<br/></li>
<li></span><span class="Comment"> * map_failure_msg: error message to use if mapping to target_tupdesc fails<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We don't currently support both detoast and target_tupdesc at the same<br/></li>
<li></span><span class="Comment"> * time, just because no existing caller needs that combination.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L266">&#x200c;</a></span><span class="linkable">SetTuplestoreDestReceiverParams</span>(DestReceiver *self,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../utils/sort/tuplestore.c.html#L103" title="utils/sort/tuplestore.c:103">Tuplestorestate</a> *tStore,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContext tContext,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type"><a href="../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> detoast,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TupleDesc target_tupdesc,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">const</span> <span class="Type">char</span> *map_failure_msg)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *myState = (<a href="#L44" title="executor/tstoreReceiver.c:44">TStoreState</a> *) self;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(!(detoast &amp;&amp; target_tupdesc));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(myState-&gt;pub.mydest == DestTuplestore);<br/></li>
<li>&nbsp; &nbsp; myState-&gt;tstore = tStore;<br/></li>
<li>&nbsp; &nbsp; myState-&gt;cxt = tContext;<br/></li>
<li>&nbsp; &nbsp; myState-&gt;detoast = detoast;<br/></li>
<li>&nbsp; &nbsp; myState-&gt;target_tupdesc = target_tupdesc;<br/></li>
<li>&nbsp; &nbsp; myState-&gt;map_failure_msg = map_failure_msg;<br/></li>
<li>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../index.html">Top Level</a></span>
 </p>

 </body>
</html>
