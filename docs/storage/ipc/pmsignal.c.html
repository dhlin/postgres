<!-- generated by the src2html.pl tool from code2ebook:
  https://github.com/agentzh/code2ebook
-->

<html>
 <head>
  <title>storage/ipc/pmsignal.c - pgsql17devel-backend</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <style>
body {
    text-align: left;
    text-align-last: left;
}

.nav-bar {
    font-size: 120%;
    margin-top: 5px;
    margin-bottom: 5px;
}

.nav-link {
    padding-left: 5em;
    padding-right: 5em;
}

ul.toc {
    line-height: 200%;
    font-size: 150%;
}

code {
    font-family: consolas, monospace;
    line-height: 130%;
}

span.Constant {
    color: DarkGreen;
}

span.Special {
    color: #c06000;
}

span.Comment {
    color: DarkRed;
    font-style: italic;
}

span.Identifier {
    color: DarkCyan;
}

span.PreProc {
    color: DarkMagenta;
}

span.Statement, span.Type, span.Keyword, span.Repeat, span.Conditional,
    span.Operator, span.Exception
{
    color: DarkBlue;
}

span.Todo {
    color: DarkRed;
    background-color: Gold;
    font-style: italic;
}

span.Underlined {
    text-decoration: underline;
}

span.linkable {
    font-weight: bold;
}

code ol {
    counter-reset: item;
    list-style-type: none;
    margin-left: 0;
    padding-left: 0;
    list-style-position: inside;
}

code li {
    display: block;
}

code li:before {
    content: counter(item) "  ";
    counter-increment: item;
    color: #999;
    padding-right: 0.5em;
    padding-left: 0.4em;
    list-style-position: inside;
    text-align: right
}

  </style>
 </head>
 <body>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

  <h1>storage/ipc/pmsignal.c - pgsql17devel-backend</h1>
 <h2>Global variables defined</h2>
 <ul class="toc">
<li><a href="#L92">PMChildInUse</a></li>
<li><a href="#L83">PMSignalState</a></li>
<li><a href="#L91">next_child_inuse</a></li>
<li><a href="#L90">num_child_inuse</a></li>
<li><a href="#L98">postmaster_possibly_dead</a></li>
</ul>
 <h2>Data types defined</h2>
 <ul class="toc">
<li><a href="#L71">PMSignalData</a></li>
</ul>
 <h2>Functions defined</h2>
 <ul class="toc">
<li><a href="#L247">AssignPostmasterChildSlot</a></li>
<li><a href="#L198">CheckPostmasterSignal</a></li>
<li><a href="#L229">GetQuitSignalReason</a></li>
<li><a href="#L307">IsPostmasterChildWalSender</a></li>
<li><a href="#L323">MarkPostmasterChildActive</a></li>
<li><a href="#L356">MarkPostmasterChildInactive</a></li>
<li><a href="#L339">MarkPostmasterChildWalSender</a></li>
<li><a href="#L144">PMSignalShmemInit</a></li>
<li><a href="#L129">PMSignalShmemSize</a></li>
<li><a href="#L437">PostmasterDeathSignalInit</a></li>
<li><a href="#L376">PostmasterIsAliveInternal</a></li>
<li><a href="#L284">ReleasePostmasterChildSlot</a></li>
<li><a href="#L181">SendPostmasterSignal</a></li>
<li><a href="#L218">SetQuitSignalReason</a></li>
<li><a href="#L101">postmaster_death_handler</a></li>
</ul>
 <h2>Macros defined</h2>
 <ul class="toc">
<li><a href="#L67">PM_CHILD_ACTIVE</a></li>
<li><a href="#L66">PM_CHILD_ASSIGNED</a></li>
<li><a href="#L65">PM_CHILD_UNUSED</a></li>
<li><a href="#L68">PM_CHILD_WALSENDER</a></li>
<li><a href="#L115">POSTMASTER_DEATH_SIGNAL</a></li>
<li><a href="#L117">POSTMASTER_DEATH_SIGNAL</a></li>
</ul>
 <h2>Source code</h2>

  <code><ol><li><span class="Comment">/*-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * pmsignal.c<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; routines for signaling between the postmaster and its child processes<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1996-2024, PostgreSQL Global Development Group<br/></li>
<li></span><span class="Comment"> * Portions Copyright (c) 1994, Regents of the University of California<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * IDENTIFICATION<br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; src/backend/storage/ipc/pmsignal.c<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> *-------------------------------------------------------------------------<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postgres.h&quot;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&lt;signal.h&gt;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;unistd.h&gt;<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef HAVE_SYS_PRCTL_H<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&lt;sys/prctl.h&gt;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#include </span><span class="Constant">&quot;miscadmin.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;postmaster/postmaster.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;replication/walsender.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/pmsignal.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;storage/shmem.h&quot;<br/></li>
<li></span><span class="PreProc">#include </span><span class="Constant">&quot;utils/memutils.h&quot;<br/></li>
<li></span><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The postmaster is signaled by its children by sending SIGUSR1.&nbsp; The<br/></li>
<li></span><span class="Comment"> * specific reason is communicated via flags in shared memory.&nbsp; We keep<br/></li>
<li></span><span class="Comment"> * a boolean flag for each possible &quot;reason&quot;, so that different reasons<br/></li>
<li></span><span class="Comment"> * can be signaled by different backends at the same time.&nbsp; (However,<br/></li>
<li></span><span class="Comment"> * if the same reason is signaled more than once simultaneously, the<br/></li>
<li></span><span class="Comment"> * postmaster will observe it only once.)<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * The flags are actually declared as &quot;volatile sig_atomic_t&quot; for maximum<br/></li>
<li></span><span class="Comment"> * portability.&nbsp; This should ensure that loads and stores of the flag<br/></li>
<li></span><span class="Comment"> * <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> are atomic, allowing us to dispense with <a href="../../utils/adt/pseudotypes.c.html#L365" title="utils/adt/pseudotypes.c:365">any</a> explicit locking.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * In addition to the per-reason flags, we store a set of per-child-process<br/></li>
<li></span><span class="Comment"> * flags that are currently used only for detecting whether a backend has<br/></li>
<li></span><span class="Comment"> * exited without performing proper shutdown.&nbsp; The per-child-process flags<br/></li>
<li></span><span class="Comment"> * have three possible states: UNUSED, ASSIGNED, ACTIVE.&nbsp; An UNUSED slot is<br/></li>
<li></span><span class="Comment"> * available for assignment.&nbsp; An ASSIGNED slot is associated with a postmaster<br/></li>
<li></span><span class="Comment"> * child process, but either the process has not touched shared memory yet,<br/></li>
<li></span><span class="Comment"> * or it has successfully cleaned up after itself.&nbsp; A ACTIVE slot means the<br/></li>
<li></span><span class="Comment"> * process is actively using shared memory.&nbsp; The slots are assigned to<br/></li>
<li></span><span class="Comment"> * child processes at random, and postmaster.c is responsible for tracking<br/></li>
<li></span><span class="Comment"> * which one goes with which PID.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Actually there is a fourth state, WALSENDER.&nbsp; This is just like ACTIVE,<br/></li>
<li></span><span class="Comment"> * but carries the extra information that the child is a WAL sender.<br/></li>
<li></span><span class="Comment"> * WAL senders too start in ACTIVE state, but switch to WALSENDER once they<br/></li>
<li></span><span class="Comment"> * start streaming the WAL (and they never go back to ACTIVE after that).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * We also have a shared-memory field that is used for communication in<br/></li>
<li></span><span class="Comment"> * the opposite direction, from postmaster to children: it tells why the<br/></li>
<li></span><span class="Comment"> * postmaster has broadcasted SIGQUIT signals, if indeed it has done so.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><br/></li>
<li><a id="L65">&#x200c;</a><span class="PreProc">#define <span class="linkable">PM_CHILD_UNUSED</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">0</span><span class="PreProc">&nbsp; &nbsp; </span><span class="Comment">/* these <a href="../../bootstrap/bootstrap.c.html#L152" title="bootstrap/bootstrap.c:152">values</a> must fit in sig_atomic_t */<br/></li>
<li><a id="L66">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PM_CHILD_ASSIGNED</span>&nbsp; &nbsp; </span><span class="Constant">1<br/></li>
<li><a id="L67">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PM_CHILD_ACTIVE</span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="Constant">2<br/></li>
<li><a id="L68">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">PM_CHILD_WALSENDER</span>&nbsp; &nbsp; </span><span class="Constant">3<br/></li>
<li></span><br/></li>
<li><span class="Comment">/* &quot;typedef struct <a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> <a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a>&quot; appears in pmsignal.h */<br/></li>
<li><a id="L71">&#x200c;</a></span><span class="Type">struct</span> <span class="linkable">PMSignalData</span><br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* per-reason flags for signaling the postmaster */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">sig_atomic_t</span> PMSignalFlags[NUM_PMSIGNALS];<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* global flags for signals from postmaster to children */<br/></li>
<li></span>&nbsp; &nbsp; QuitSignalReason sigquit_reason;&nbsp; &nbsp; <span class="Comment">/* why SIGQUIT was sent */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/* per-child-process flags */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_child_flags;&nbsp; &nbsp; <span class="Comment">/* # of entries in PMChildFlags[] */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">sig_atomic_t</span> PMChildFlags[FLEXIBLE_ARRAY_MEMBER];<br/></li>
<li>};<br/></li>
<li><br/></li>
<li><span class="Comment">/* <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a> pointer is valid in both postmaster and child processes */<br/></li>
<li><a id="L83">&#x200c;</a></span>NON_EXEC_STATIC <span class="Type">volatile</span> <a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> *<span class="linkable">PMSignalState</span> = <span class="Constant">NULL</span>;<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * These static variables are valid only in the postmaster.&nbsp; We keep a<br/></li>
<li></span><span class="Comment"> * duplicative private array so that we can trust its state even if some<br/></li>
<li></span><span class="Comment"> * failing child has clobbered the <a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> struct in shared memory.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li><a id="L90">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">num_child_inuse</span>;&nbsp; &nbsp; <span class="Comment">/* # of entries in <a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>[] */<br/></li>
<li><a id="L91">&#x200c;</a></span><span class="Type">static</span> <span class="Type">int</span>&nbsp; &nbsp; <span class="linkable">next_child_inuse</span>;&nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/regc_lex.c.html#L200" title="regex/regc_lex.c:200">next</a> slot to try to assign */<br/></li>
<li><a id="L92">&#x200c;</a></span><span class="Type">static</span> <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *<span class="linkable">PMChildInUse</span>;&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* true if i'th flag slot is assigned */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * Signal handler to be notified if postmaster dies.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#ifdef USE_POSTMASTER_DEATH_SIGNAL<br/></li>
<li><a id="L98">&#x200c;</a></span><span class="Type">volatile</span> <span class="Type">sig_atomic_t</span> <span class="linkable">postmaster_possibly_dead</span> = <span class="Constant">false</span>;<br/></li>
<li><br/></li>
<li><span class="Type">static</span> <span class="Type">void<br/></li>
<li><a id="L101">&#x200c;</a></span><span class="linkable">postmaster_death_handler</span>(SIGNAL_ARGS)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L98" title="storage/ipc/pmsignal.c:98">postmaster_possibly_dead</a> = <span class="Constant">true</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * The available signals depend on the OS.&nbsp; SIGUSR1 and SIGUSR2 are already<br/></li>
<li></span><span class="Comment"> * used for other things, so choose another one.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Currently, we assume that we can always <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> a signal to use.&nbsp; That<br/></li>
<li></span><span class="Comment"> * seems like a reasonable assumption for all platforms that are modern<br/></li>
<li></span><span class="Comment"> * enough to have a parent-death signaling mechanism.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="PreProc">#if defined(</span><span class="Constant">SIGINFO</span><span class="PreProc">)<br/></li>
<li><a id="L115">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">POSTMASTER_DEATH_SIGNAL</span> </span><span class="Constant">SIGINFO<br/></li>
<li></span><span class="PreProc">#elif defined(SIGPWR)<br/></li>
<li><a id="L117">&#x200c;</a></span><span class="PreProc">#define <span class="linkable">POSTMASTER_DEATH_SIGNAL</span> SIGPWR<br/></li>
<li></span><span class="PreProc">#else<br/></li>
<li></span><span class="PreProc">#error </span><span class="Constant">&quot;cannot <a href="../../regex/regexec.c.html#L419" title="regex/regexec.c:419">find</a> a signal to use for postmaster death&quot;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* USE_POSTMASTER_DEATH_SIGNAL */<br/></li>
<li></span><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L129" title="storage/ipc/pmsignal.c:129">PMSignalShmemSize</a><br/></li>
<li></span><span class="Comment"> *&nbsp; &nbsp; &nbsp; &nbsp; Compute space needed for pmsignal.c's shared memory<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>Size<br/></li>
<li><a id="L129">&#x200c;</a><span class="linkable">PMSignalShmemSize</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Size&nbsp; &nbsp; &nbsp; &nbsp; size;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; size = offsetof(<a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a>, PMChildFlags);<br/></li>
<li>&nbsp; &nbsp; size = <a href="shmem.c.html#L493" title="storage/ipc/shmem.c:493">add_size</a>(size, <a href="shmem.c.html#L510" title="storage/ipc/shmem.c:510">mul_size</a>(<a href="../../postmaster/postmaster.c.html#L4145" title="postmaster/postmaster.c:4145">MaxLivePostmasterChildren</a>(),<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span class="Statement"><a href="../page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type">sig_atomic_t</span>)));<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> size;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L144" title="storage/ipc/pmsignal.c:144">PMSignalShmemInit</a> - <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> during shared-memory creation<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L144">&#x200c;</a></span><span class="linkable">PMSignalShmemInit</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; found;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a> = (<a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="shmem.c.html#L387" title="storage/ipc/shmem.c:387">ShmemInitStruct</a>(<span class="Constant">&quot;<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>&quot;</span>, <a href="#L129" title="storage/ipc/pmsignal.c:129">PMSignalShmemSize</a>(), &amp;found);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (!found)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* <a href="../../regex/rege_dfa.c.html#L731" title="regex/rege_dfa.c:731">initialize</a> all flags to zeroes */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; MemSet(unvolatize(<a href="#L71" title="storage/ipc/pmsignal.c:71">PMSignalData</a> *, <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>), <span class="Constant">0</span>, <a href="#L129" title="storage/ipc/pmsignal.c:129">PMSignalShmemSize</a>());<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a> = <a href="../../postmaster/postmaster.c.html#L4145" title="postmaster/postmaster.c:4145">MaxLivePostmasterChildren</a>();<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;num_child_flags = <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Also allocate postmaster's private <a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>[] array.&nbsp; We<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * might've already done that in a previous shared-memory creation<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * cycle, in which case free the old array to avoid a leak.&nbsp; (Do it<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * like this to support the possibility that <a href="../../postmaster/postmaster.c.html#L4145" title="postmaster/postmaster.c:4145">MaxLivePostmasterChildren</a><br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * changed.)&nbsp; In a standalone backend, we do not need this.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="../../utils/mmgr/mcxt.c.html#L151" title="utils/mmgr/mcxt.c:151">PostmasterContext</a> != <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../utils/mmgr/mcxt.c.html#L1520" title="utils/mmgr/mcxt.c:1520">pfree</a>(<a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a> = (<span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span> *)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="../../utils/mmgr/mcxt.c.html#L1214" title="utils/mmgr/mcxt.c:1214">MemoryContextAllocZero</a>(<a href="../../utils/mmgr/mcxt.c.html#L151" title="utils/mmgr/mcxt.c:151">PostmasterContext</a>,<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a> * <span class="Statement"><a href="../page/itemptr.c.html#L23" title="storage/page/itemptr.c:23">sizeof</a></span>(<span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>));<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="storage/ipc/pmsignal.c:91">next_child_inuse</a> = <span class="Constant">0</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L181" title="storage/ipc/pmsignal.c:181">SendPostmasterSignal</a> - signal the postmaster from a child process<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L181">&#x200c;</a></span><span class="linkable">SendPostmasterSignal</span>(PMSignalReason reason)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* If called in a standalone backend, do nothing */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../utils/init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Atomically set the proper flag */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMSignalFlags[reason] = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Send signal to postmaster */<br/></li>
<li></span>&nbsp; &nbsp; kill(<a href="../../utils/init/globals.c.html#L103" title="utils/init/globals.c:103">PostmasterPid</a>, <span class="Constant">SIGUSR1</span>);<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L198" title="storage/ipc/pmsignal.c:198">CheckPostmasterSignal</a> - check to see if a particular reason has been<br/></li>
<li></span><span class="Comment"> * signaled, and clear the signal flag.&nbsp; Should be called by postmaster<br/></li>
<li></span><span class="Comment"> * after receiving SIGUSR1.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L198">&#x200c;</a></span><span class="linkable">CheckPostmasterSignal</span>(PMSignalReason reason)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Careful here --- don't clear flag if we haven't seen it set */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMSignalFlags[reason])<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMSignalFlags[reason] = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L218" title="storage/ipc/pmsignal.c:218">SetQuitSignalReason</a> - broadcast the reason for a system shutdown.<br/></li>
<li></span><span class="Comment"> * Should be called by postmaster <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> sending SIGQUIT to children.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Note: in a crash-and-restart scenario, the &quot;reason&quot; field gets cleared<br/></li>
<li></span><span class="Comment"> * as a part of rebuilding shared memory; the postmaster need not do it<br/></li>
<li></span><span class="Comment"> * explicitly.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L218">&#x200c;</a></span><span class="linkable">SetQuitSignalReason</span>(QuitSignalReason reason)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;sigquit_reason = reason;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L229" title="storage/ipc/pmsignal.c:229">GetQuitSignalReason</a> - obtain the reason for a system shutdown.<br/></li>
<li></span><span class="Comment"> * Called by child processes when they receive SIGQUIT.<br/></li>
<li></span><span class="Comment"> * If the postmaster hasn't actually sent SIGQUIT, will return PMQUIT_NOT_SENT.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span>QuitSignalReason<br/></li>
<li><a id="L229">&#x200c;</a><span class="linkable">GetQuitSignalReason</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* This is called in signal handlers, so be extra paranoid. */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (!<a href="../../utils/init/globals.c.html#L117" title="utils/init/globals.c:117">IsUnderPostmaster</a> || <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a> == <span class="Constant">NULL</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> PMQUIT_NOT_SENT;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;sigquit_reason;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L247" title="storage/ipc/pmsignal.c:247">AssignPostmasterChildSlot</a> - <a href="../../port/win32/socket.c.html#L36" title="port/win32/socket.c:36">select</a> an unused slot for a new postmaster<br/></li>
<li></span><span class="Comment"> * child process, and set its state to ASSIGNED.&nbsp; Returns a slot number<br/></li>
<li></span><span class="Comment"> * (one to N).<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Only the postmaster is allowed to execute this routine, so we need no<br/></li>
<li></span><span class="Comment"> * special locking.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">int<br/></li>
<li><a id="L247">&#x200c;</a></span><span class="linkable">AssignPostmasterChildSlot</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot = <a href="#L91" title="storage/ipc/pmsignal.c:91">next_child_inuse</a>;<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Scan for a free slot.&nbsp; Notice that we trust nothing about the contents<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * of <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>, but use only postmaster-local data for this decision.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * We track the last slot assigned so as not to waste time repeatedly<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * rescanning low-numbered slots.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">for</span> (n = <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a>; n &gt; <span class="Constant">0</span>; n--)<br/></li>
<li>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (--slot &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot = <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a> - <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (!<a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>[slot])<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>[slot] = <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] = <a href="#L66" title="storage/ipc/pmsignal.c:66">PM_CHILD_ASSIGNED</a>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L91" title="storage/ipc/pmsignal.c:91">next_child_inuse</a> = slot;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> slot + <span class="Constant">1</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Out of slots ... should never happen, else postmaster.c messed up */<br/></li>
<li></span>&nbsp; &nbsp; elog(FATAL, <span class="Constant">&quot;no free slots in PMChildFlags array&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">0</span>;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* keep compiler quiet */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L284" title="storage/ipc/pmsignal.c:284">ReleasePostmasterChildSlot</a> - release a slot after death of a postmaster<br/></li>
<li></span><span class="Comment"> * child process.&nbsp; This must be called in the postmaster process.<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * Returns true if the slot had been in ASSIGNED state (the expected case),<br/></li>
<li></span><span class="Comment"> * false otherwise (implying that the child failed to clean itself up).<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L284">&#x200c;</a></span><span class="linkable">ReleasePostmasterChildSlot</span>(<span class="Type">int</span> slot)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a></span>&nbsp; &nbsp; &nbsp; &nbsp; result;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(slot &gt; <span class="Constant">0</span> &amp;&amp; slot &lt;= <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a>);<br/></li>
<li>&nbsp; &nbsp; slot--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Note: the slot state might already be unused, because the logic in<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * postmaster.c is such that this might get called twice when a child<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * crashes.&nbsp; So we don't try to Assert anything about the state.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; result = (<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] == <a href="#L66" title="storage/ipc/pmsignal.c:66">PM_CHILD_ASSIGNED</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] = <a href="#L65" title="storage/ipc/pmsignal.c:65">PM_CHILD_UNUSED</a>;<br/></li>
<li>&nbsp; &nbsp; <a href="#L92" title="storage/ipc/pmsignal.c:92">PMChildInUse</a>[slot] = <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">return</span> result;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L307" title="storage/ipc/pmsignal.c:307">IsPostmasterChildWalSender</a> - check if given slot is in use by a<br/></li>
<li></span><span class="Comment"> * walsender process.&nbsp; This is called only by the postmaster.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L307">&#x200c;</a></span><span class="linkable">IsPostmasterChildWalSender</span>(<span class="Type">int</span> slot)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; Assert(slot &gt; <span class="Constant">0</span> &amp;&amp; slot &lt;= <a href="#L90" title="storage/ipc/pmsignal.c:90">num_child_inuse</a>);<br/></li>
<li>&nbsp; &nbsp; slot--;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Statement">if</span> (<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] == <a href="#L68" title="storage/ipc/pmsignal.c:68">PM_CHILD_WALSENDER</a>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L323" title="storage/ipc/pmsignal.c:323">MarkPostmasterChildActive</a> - mark a postmaster child as about to begin<br/></li>
<li></span><span class="Comment"> * actively using shared memory.&nbsp; This is called in the child process.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L323">&#x200c;</a></span><span class="linkable">MarkPostmasterChildActive</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot = <a href="../../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(slot &gt; <span class="Constant">0</span> &amp;&amp; slot &lt;= <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;num_child_flags);<br/></li>
<li>&nbsp; &nbsp; slot--;<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] == <a href="#L66" title="storage/ipc/pmsignal.c:66">PM_CHILD_ASSIGNED</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] = <a href="#L67" title="storage/ipc/pmsignal.c:67">PM_CHILD_ACTIVE</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L339" title="storage/ipc/pmsignal.c:339">MarkPostmasterChildWalSender</a> - mark a postmaster child as a WAL sender<br/></li>
<li></span><span class="Comment"> * process.&nbsp; This is called in the child process, sometime after marking the<br/></li>
<li></span><span class="Comment"> * child as active.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L339">&#x200c;</a></span><span class="linkable">MarkPostmasterChildWalSender</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot = <a href="../../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(<a href="../../replication/walsender.c.html#L115" title="replication/walsender.c:115">am_walsender</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(slot &gt; <span class="Constant">0</span> &amp;&amp; slot &lt;= <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;num_child_flags);<br/></li>
<li>&nbsp; &nbsp; slot--;<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] == <a href="#L67" title="storage/ipc/pmsignal.c:67">PM_CHILD_ACTIVE</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] = <a href="#L68" title="storage/ipc/pmsignal.c:68">PM_CHILD_WALSENDER</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L356" title="storage/ipc/pmsignal.c:356">MarkPostmasterChildInactive</a> - mark a postmaster child as done using<br/></li>
<li></span><span class="Comment"> * shared memory.&nbsp; This is called in the child process.<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L356">&#x200c;</a></span><span class="linkable">MarkPostmasterChildInactive</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot = <a href="../../utils/init/globals.c.html#L51" title="utils/init/globals.c:51">MyPMChildSlot</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; Assert(slot &gt; <span class="Constant">0</span> &amp;&amp; slot &lt;= <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;num_child_flags);<br/></li>
<li>&nbsp; &nbsp; slot--;<br/></li>
<li>&nbsp; &nbsp; Assert(<a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] == <a href="#L67" title="storage/ipc/pmsignal.c:67">PM_CHILD_ACTIVE</a> ||<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] == <a href="#L68" title="storage/ipc/pmsignal.c:68">PM_CHILD_WALSENDER</a>);<br/></li>
<li>&nbsp; &nbsp; <a href="#L83" title="storage/ipc/pmsignal.c:83">PMSignalState</a>-&gt;PMChildFlags[slot] = <a href="#L66" title="storage/ipc/pmsignal.c:66">PM_CHILD_ASSIGNED</a>;<br/></li>
<li>}<br/></li>
<li><br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L376" title="storage/ipc/pmsignal.c:376">PostmasterIsAliveInternal</a> - check whether postmaster process is still alive<br/></li>
<li></span><span class="Comment"> *<br/></li>
<li></span><span class="Comment"> * This is the slow path of PostmasterIsAlive(), where the caller has already<br/></li>
<li></span><span class="Comment"> * checked '<a href="#L98" title="storage/ipc/pmsignal.c:98">postmaster_possibly_dead</a>'.&nbsp; (On platforms that don't support<br/></li>
<li></span><span class="Comment"> * a signal for parent death, PostmasterIsAlive() is just an alias for this.)<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type"><a href="../../utils/fmgr/dfmgr.c.html#L28" title="utils/fmgr/dfmgr.c:28">bool</a><br/></li>
<li><a id="L376">&#x200c;</a></span><span class="linkable">PostmasterIsAliveInternal</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_POSTMASTER_DEATH_SIGNAL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Reset the flag <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> checking, so that we don't <a href="../../regex/rege_dfa.c.html#L777" title="regex/rege_dfa.c:777">miss</a> a signal if<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * postmaster dies right after the check.&nbsp; If postmaster was indeed dead,<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * we'll re-arm it <a href="../../regex/regc_locale.c.html#L488" title="regex/regc_locale.c:488">before</a> returning to caller.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L98" title="storage/ipc/pmsignal.c:98">postmaster_possibly_dead</a> = <span class="Constant">false</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifndef WIN32<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">char</span>&nbsp; &nbsp; &nbsp; &nbsp; c;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Type">ssize_t</span>&nbsp; &nbsp; &nbsp; &nbsp; rc;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; rc = read(<a href="../../postmaster/postmaster.c.html#L479" title="postmaster/postmaster.c:479">postmaster_alive_fds</a>[POSTMASTER_FD_WATCH], &amp;c, <span class="Constant">1</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * In the usual case, the postmaster is still alive, and there is no<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * data in the pipe.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc &lt; <span class="Constant">0</span> &amp;&amp; (errno == <span class="Constant">EAGAIN</span> || errno == <span class="Constant">EWOULDBLOCK</span>))<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; {<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * Postmaster is dead, or something went wrong with the read()<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; * call.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; */<br/></li>
<li></span><br/></li>
<li><span class="PreProc">#ifdef USE_POSTMASTER_DEATH_SIGNAL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="#L98" title="storage/ipc/pmsignal.c:98">postmaster_possibly_dead</a> = <span class="Constant">true</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">if</span> (rc &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(FATAL, <span class="Constant">&quot;read on postmaster death monitoring pipe failed: %m&quot;</span>);<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">else</span> <span class="Statement">if</span> (rc &gt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; elog(FATAL, <span class="Constant">&quot;unexpected data in postmaster death monitoring pipe&quot;</span>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; }<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><br/></li>
<li><span class="PreProc">#else</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* WIN32 */<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (WaitForSingleObject(<a href="../../postmaster/postmaster.c.html#L482" title="postmaster/postmaster.c:482">PostmasterHandle</a>, <span class="Constant">0</span>) == WAIT_TIMEOUT)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">true</span>;<br/></li>
<li>&nbsp; &nbsp; <span class="Statement">else<br/></li>
<li></span>&nbsp; &nbsp; {<br/></li>
<li><span class="PreProc">#ifdef USE_POSTMASTER_DEATH_SIGNAL<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <a href="#L98" title="storage/ipc/pmsignal.c:98">postmaster_possibly_dead</a> = <span class="Constant">true</span>;<br/></li>
<li><span class="PreProc">#endif<br/></li>
<li></span>&nbsp; &nbsp; &nbsp; &nbsp; <span class="Statement">return</span> <span class="Constant">false</span>;<br/></li>
<li>&nbsp; &nbsp; }<br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* WIN32 */<br/></li>
<li></span>}<br/></li>
<li><br/></li>
<li><span class="Comment">/*<br/></li>
<li></span><span class="Comment"> * <a href="#L437" title="storage/ipc/pmsignal.c:437">PostmasterDeathSignalInit</a> - request signal on postmaster death if possible<br/></li>
<li></span><span class="Comment"> */<br/></li>
<li></span><span class="Type">void<br/></li>
<li><a id="L437">&#x200c;</a></span><span class="linkable">PostmasterDeathSignalInit</span>(<span class="Type">void</span>)<br/></li>
<li>{<br/></li>
<li><span class="PreProc">#ifdef USE_POSTMASTER_DEATH_SIGNAL<br/></li>
<li></span>&nbsp; &nbsp; <span class="Type">int</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signum = <a href="#L115" title="storage/ipc/pmsignal.c:115">POSTMASTER_DEATH_SIGNAL</a>;<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Register our signal handler. */<br/></li>
<li></span>&nbsp; &nbsp; pqsignal(signum, <a href="#L101" title="storage/ipc/pmsignal.c:101">postmaster_death_handler</a>);<br/></li>
<li><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/* Request a signal on parent exit. */<br/></li>
<li></span><span class="PreProc">#if defined(PR_SET_PDEATHSIG)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (prctl(PR_SET_PDEATHSIG, signum) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not request parent death signal: %m&quot;</span>);<br/></li>
<li><span class="PreProc">#elif defined(PROC_PDEATHSIG_CTL)<br/></li>
<li></span>&nbsp; &nbsp; <span class="Statement">if</span> (procctl(P_PID, <span class="Constant">0</span>, PROC_PDEATHSIG_CTL, &amp;signum) &lt; <span class="Constant">0</span>)<br/></li>
<li>&nbsp; &nbsp; &nbsp; &nbsp; elog(ERROR, <span class="Constant">&quot;could not request parent death signal: %m&quot;</span>);<br/></li>
<li><span class="PreProc">#else<br/></li>
<li></span><span class="PreProc">#error </span><span class="Constant">&quot;USE_POSTMASTER_DEATH_SIGNAL set, but there is no mechanism to request the signal&quot;<br/></li>
<li></span><span class="PreProc">#endif<br/></li>
<li></span><br/></li>
<li>&nbsp; &nbsp; <span class="Comment">/*<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * Just in case the parent was gone already and we missed it, we'd better<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; * check the slow way on the first call.<br/></li>
<li></span><span class="Comment">&nbsp; &nbsp;&nbsp; */<br/></li>
<li></span>&nbsp; &nbsp; <a href="#L98" title="storage/ipc/pmsignal.c:98">postmaster_possibly_dead</a> = <span class="Constant">true</span>;<br/></li>
<li><span class="PreProc">#endif</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="Comment">/* USE_POSTMASTER_DEATH_SIGNAL */<br/></li>
<li></span>}<br/></li>
</ol></code>
 <p class="nav-bar">
  <span class="nav-link"><a href="./index.html">One Level Up</a></span>
  <span class="nav-link"><a href="../../index.html">Top Level</a></span>
 </p>

 </body>
</html>
